\resizebox{7cm}{!}{
\begin{tikzpicture}[scale=1.0, node distance=2cm]
    % GPU
    \node (mapping) [hybridKernel] {Particle mapping};
    \node (setU) [syncKernel, below of=mapping, draw=none] {\textcolor{matplotlibOrange!50}{Set particle velocities at cell centers}};
    \fill[minimum width=3cm, matplotlibGreen!50] (setU.south west) -- (setU.south east) -- (setU.north east);
    \node (setU2) [hybridKernel, below of=mapping, fill=none]{Set particle velocities at cell centers};
    \node (psmInner) [kernel, below of=setU] {PSM inner};
    \node (bh) [syncSweep, below of=psmInner] {LBM boundary handling};
    \node (psmOuter) [kernel, below of=bh] {PSM outer};
    \node (redF) [hybridKernel, below of=psmOuter, draw=none] {\textcolor{matplotlibGreen!50}{Reduce hydrodynamic forces}};
    \fill[minimum width=3cm, matplotlibOrange!50] (redF.south west) -- (redF.south east) -- (redF.north east);
    \node (redF2) [syncKernel, below of=psmOuter, fill=none]{Reduce hydrodynamic forces};

    % CPU
    \node (preForceInt) [syncKernel, right of=mapping, xshift=4cm] {Pre-force integration};
    \node (linkedCells) [kernel, below of=preForceInt] {Insert particles into linked cells};
    \node (lubCorr) [kernel, below of=linkedCells] {Lubrication correction};
    \node (dem) [syncKernel, below of=lubCorr] {DEM kernel};
    \node (externalF) [syncKernel, below of=dem] {Apply external forces};
    \node (postForceInt) [kernel, below of=externalF] {Post-force integration};

    \node (decision) [decision, below of=postForceInt, yshift=-1.5cm, text width=2cm] {N cycles done?};

    % Arrows
    \draw [-latex] (mapping) -- (setU);
    \draw [-latex] (setU) -- (psmInner);
    \draw [-latex] (psmInner) -- (bh);
    \draw [-latex] (bh) -- (psmOuter);
    \draw [-latex] (psmOuter) -- (redF);
    \draw [-latex] (redF) - ++(3,0) -- ++(3,10) -- (preForceInt);

    \draw [-latex] (preForceInt) -- (linkedCells);
    \draw [-latex] (linkedCells) -- (lubCorr);
    \draw [-latex] (lubCorr) -- (dem);
    \draw [-latex] (dem) -- (externalF);
    \draw [-latex] (externalF) -- (postForceInt);
    \draw [-latex] (postForceInt) -- (decision);
    \draw [-latex] (decision)node[anchor=south, xshift=2cm] {no} - ++(3,0) -- ++(3,13.5) -- (preForceInt);
    \draw [-latex] (decision)node[anchor=south, xshift=-2cm] {yes} - ++(-9,0) -- ++(-9,13.5) -- (mapping);

    \node (nextStep) [rotate=90] at (-3.5,-6.5) {Start next time step};
    \node (nextCycle) [rotate=-90] at (9.5,-6.5) {Repeat particle simulation};

    % Frames
    \draw[red,very thick,dotted] ($(mapping.north west)+(-0.3,0.6)$)  rectangle ($(redF.south east)+(0.3,-0.6)$);
    \draw[red,very thick,dotted] ($(preForceInt.north west)+(-0.3,0.6)$)  rectangle ($(postForceInt.south east)+(0.3,-0.6)$);
    \node[] at (0,2) {GPU};
    \node[] at (6,2) {CPU};

    % Legend
    \draw[gray, very thin, fill=matplotlibGreen!50] (-2.5,-12.05) rectangle ++(0.5,0.5);
    \node[right] at (-2,-11.8) {\gls{cpu}-\gls{gpu} communication\strut};
    \draw[gray, very thin, fill=matplotlibBlue!50] (-2.5,-12.7) rectangle ++(0.5,0.5);
    \node[right] at (-2,-12.45) {\gls{gpu}-\gls{gpu} communication\strut};
    \draw[gray, very thin, fill=matplotlibOrange!50] (-2.5,-13.35) rectangle ++(0.5,0.5);
    \node[right] at (-2,-13.15) {\gls{cpu}-\gls{cpu} communication\strut};
\end{tikzpicture}
}
