\resizebox{13cm}{!}{
\begin{tikzpicture}[scale=1.0, node distance=4cm]
    % GPU
    \node (mapping) [hybridKernel] {Particle mapping};
    \node (setU) [syncKernel, right of=mapping, draw=none] {\textcolor{matplotlibOrange!50}{Set particle velocities at cell centers}};
    \fill[minimum width=3cm, matplotlibGreen!50] (setU.south west) -- (setU.south east) -- (setU.north east);
    \node (setU2) [hybridKernel, right of=mapping, fill=none]{Set particle velocities at cell centers};
    \node (psmInner) [kernel, right of=setU] {PSM inner};
    \node (bh) [syncSweep, right of=psmInner] {LBM boundary handling};
    \node (psmOuter) [kernel, right of=bh] {PSM outer};
    \node (redF) [hybridKernel, right of=psmOuter, draw=none] {\textcolor{matplotlibGreen!50}{Reduce hydrodynamic forces}};
    \fill[minimum width=3cm, matplotlibOrange!50] (redF.south west) -- (redF.south east) -- (redF.north east);
    \node (redF2) [syncKernel, right of=psmOuter, fill=none]{Reduce hydrodynamic forces};

    % CPU
    \node (preForceInt) [syncKernel, below of=mapping] {Pre-force integration};
    \node (linkedCells) [kernel, right of=preForceInt] {Insert particles into linked cells};
    \node (lubCorr) [kernel, right of=linkedCells] {Lubrication correction};
    \node (dem) [syncKernel, right of=lubCorr] {DEM kernel};
    \node (externalF) [syncKernel, right of=dem] {Apply external forces};
    \node (postForceInt) [kernel, right of=externalF] {Post-force integration};

    \node (decision) [decision, right of=postForceInt, text width=2cm] {N cycles done?};

    % Arrows
    \draw [-latex] (mapping) -- (setU);
    \draw [-latex] (setU) -- (psmInner);
    \draw [-latex] (psmInner) -- (bh);
    \draw [-latex] (bh) -- (psmOuter);
    \draw [-latex] (psmOuter) -- (redF);
    \draw [-latex] (redF) - ++(0,-2) -- ++(-20,-2) -- (preForceInt);

    \draw [-latex] (preForceInt) -- (linkedCells);
    \draw [-latex] (linkedCells) -- (lubCorr);
    \draw [-latex] (lubCorr) -- (dem);
    \draw [-latex] (dem) -- (externalF);
    \draw [-latex] (externalF) -- (postForceInt);
    \draw [-latex] (postForceInt) -- (decision);
    \draw [-latex] (decision)node[anchor=south, yshift=-2.5cm, xshift=0.5cm] {no} - ++(0,-2) -- ++(-24,-2) -- (preForceInt);
    \draw [-latex] (decision)node[anchor=north, yshift=2.5cm, xshift=0.5cm] {yes} - ++(0,6) -- ++(-24,6) -- (mapping);

    \node (nextStep) [] at (10,3) {Start next time step};
    \node (nextCycle) [] at (10,-7) {Start next particle sub-cycle};

    % Frames
    \draw[red,very thick,dotted] ($(mapping.north west)+(-0.3,0.6)$)  rectangle ($(redF.south east)+(0.3,-0.6)$);
    \draw[red,very thick,dotted] ($(preForceInt.north west)+(-0.3,0.6)$)  rectangle ($(postForceInt.south east)+(0.3,-0.6)$);
    \node[] at (-3,0) {GPU};
    \node[] at (-3,-4) {CPU};

    % Legend
    \draw[gray, very thin, fill=matplotlibGreen!50] (-2.5,-8.05) rectangle ++(0.5,0.5);
    \node[right] at (-2,-7.8) {\gls{cpu}-\gls{gpu} communication\strut};
    \draw[gray, very thin, fill=matplotlibBlue!50] (-2.5,-8.7) rectangle ++(0.5,0.5);
    \node[right] at (-2,-8.45) {\gls{gpu}-\gls{gpu} communication\strut};
    \draw[gray, very thin, fill=matplotlibOrange!50] (-2.5,-9.35) rectangle ++(0.5,0.5);
    \node[right] at (-2,-9.15) {\gls{cpu}-\gls{cpu} communication\strut};
\end{tikzpicture}
}
