% \subsection{\Cref{lem:affine_control} affine transformation of control limit proof} \label{apd:affine_control_proof}
%     \begin{proof}
%     Based on \cref{eq:z_dyn}, we have
%     \begin{align}
%         \dot z = f_z(z) + g_z(z) v =  f_z(\Phi(x)) + g_z(\Phi(x)) v \label{eq: affine_a}
%     \end{align}
%     And in the meantime, we have
%     \begin{align}
%         \dot z =& \pd[\Phi(x)]{t} = \nabla \Phi(x) \dot x =  \nabla \Phi(x) f(x) + \nabla \Phi(x) g(x) u \label{eq: affine_b}
%     \end{align}
%     Therefore, connect \cref{eq: affine_a} and \cref{eq: affine_b} we have
%     \begin{subequations}
%     \begin{align}
%         v =&  g_z(\Phi(x))^{-1}[\nabla \Phi(x) f(x) - f_z(\Phi(x))] \nonumber\\
%            & + g_z(\Phi(x))^{-1} \nabla \Phi(x) g(x) u\\
%         =  & C(x) u + d(x)
%     \end{align} 
%     \end{subequations}
%     \end{proof}{}

\subsection{\Cref{lem:M} computing $M$ proof}\label{apd:M_proof}
\begin{proof}
The radius of the maximum $L_p$-norm inner ball can be found by
\begin{align}
    \max_{r} r \quad \st \hat a_i(x) v \leq \hat b_i(x), \forall \|v\|_p \leq r.
\end{align}
Based on HÃ¶lder's inequality, for $p,q$ that satisfy  $\frac{1}{p}+\frac{1}{q}=1$, we have
\begin{align}
    |\hat a_i(x) v| \leq \|\hat a_i(x)\|_q \|v\|_p
\end{align}
Therefore
\begin{align}
    \max_{\|v\|_p\leq r} \hat a_i(x) v = \max_{\|v\|_p\leq r} |\hat a_i(x) v| \leq \max_{M} \|\hat a_i(x)\|_q M
\end{align}
\end{proof}

\subsection{\Cref{lem:bounded_dot_M} Bounded $\dot M$ proof}\label{apd:bounded_dot_M}
\begin{proof}
    Based on \cref{lem:M}, $M$ is the maximum of finite Lipschitz continuous functions . Therefore, $M$ is also Lipschitz continuous. That means $(M(x+\delta)-M(x))/\|\delta\|$ is bounded by the Lipschitz constant $L$. Then 
    \begin{align}
        \dot M &= \lim_{dt \to 0} (M(x+\dot x dt)-M(x))/dt\\
        &= \left[ \lim_{dt \to 0} (M(x+\dot x dt)-M(x))/(\|\dot x\| dt)\right]\|\dot x\|\\
        &\leq \left[ \lim_{\delta \to 0} (M(x+\delta)-M(x))/\|\delta\|\right]\|\dot x \|\\
        &\leq L \|\dot x\|
    \end{align}
     is also bounded when $\dot x$ is bounded. Note that $M$ does not have to be differentiable.
\end{proof}

\subsection{\Cref{lem:sampling} sampling guarantee proof}\label{apd:sampling_proof}
\begin{proof}
    The probability of $N$ samples all being smaller than the $p$-quantile value is $p^N$. Therefore,  the probability of $\hat M_{max}$ being larger than $p$ quantile threshold is $1-p^N$. The same holds for $\hat M_{min}$ and $\hat{\dot M}_{*}$. Therefore, we can say that more than $100\cdot p\%$ states has a larger $M$ than $\hat M_{min}$, a smaller $M$ than $\hat M_{max}$ and a smaller $\dot M$ than $\hat{\dot M}_{*}$ with the probability $[1-p^N]^3$. These states all have feasible safe control with a safety index designed with $\hat M_{min}$, $\hat M_{max}$ and $\hat{\dot M}_{*}$.
\end{proof}

\subsection{Parameter Estimation in safety Index}                             
We just need to guarantee that $\dot{\phi} \le 0$, $\forall \phi=0$. This means for all $(d, \dot{d}, M)$, s.t. $\phi =d_{min}^{2}-d^2-k\frac{\dot{d}}{M}=0$, there exists $\ddot{d}\in \left[ -M,M \right]$ to satisfy the following inequality:  
\begin{align}
    \dot{\phi} &= -2d\dot{d}-k\frac{\ddot{d}}{M}+k\frac{\dot{d}}{M^2}\dot{M} \\
    &\le -2d\dot{d}-k\frac{\ddot{d}}{M}+\mid \dot{d}\mid \frac{k}{M^2}\dot{M}_{\max}\le 0
\end{align}
We let $\ddot{d}=M$, then $k\ge -2d\dot{d}+\mid \dot{d}\mid \frac{k}{M^2}\dot{M}_{\max}$.
% \begin{align}
%     k\ge -2d\dot{d}+\mid \dot{d}\mid \frac{k}{M^2}\dot{M}_{\max}
% \end{align}
Since $\phi=0$, we have $k=M\frac{d_{min}^{2}-d^2}{\dot{d}}$ and 
\begin{align}
    k &\ge -2d\dot{d}+\frac{\mid \dot{d}\mid}{\dot{d}}\left( d_{min}^{2}-d^2 \right) \cdot \frac{\dot{M}_{\max}}{M} \\
    &\ge 2\mid d\dot{d}\mid _{\max}+\mid d_{min}^{2}-d^2\mid _{\max}\cdot \frac{\dot{M}_{\max}}{M_{\min}}
\end{align}
which implies $k \ge 133.31$.
