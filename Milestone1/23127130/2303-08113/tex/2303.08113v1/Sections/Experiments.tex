\section{Experimental Results}
This section describes in details the range of experiments conducted to evaluate our proposed framework.


\subsection{Experimental Setup}
\noindent\textbf{Datasets Description.} We evaluate our framework on  inspiration-to-expiration lung CT registration using two publicly available dataset: DIRLab COPD~\cite{castillo2013reference} and DIRLab 4DCT~\cite{castillo2009framework}.
%
The two datasets are composed of lung CT images characterising the inspiration-to-expiration motion of the lung from 10 patients. They also
provide 300 anatomical landmarks (ground truth for the evaluation) for images.
%
%More details please refer to the provided website link\footnote{The dataset is released at the website \url{https://med.emory.edu/departments/radiation-oncology/research-laboratories/deformable-image-registration/index.html}}.
%

\smallskip
\noindent\textbf{Evaluation Protocol.}
We follow the standard protocol for evaluating our framework using the target registration error (TRE) as the performance metric.
%
The TRE is defined as the distance between a set of manually identified corresponding points, typically referred to as landmarks, in the registered image and the corresponding points in the target image. 
In this paper, the 300 corresponding landmarks provided in the dataset are used to calculate the TRE.
%
The lowest the TRE the better the registration output.

\smallskip\noindent\textbf{Implementation Details.} 
%
Our method was implemented using PyTorch, and used an NVIDIA A100 GPU.
During the training stage, each image pair is trained for 6000 epochs for the COPD dataset, and 3000 epochs for the 4DCT dataset. At each epoch, we randomly sample 15000 points, from the masked image, with only lung information in COPD dataset (10000 points for the 4DCT dataset). We optimise the network using the Adam optimiser with a fixed learning rate of  1Ã—10$^{-5}$. 
The total time required to register two 3D volumes is 1.7 mins for COPD dataset and 1.1 mins for the 4DCT dataset. 
The registration is finished in one-shot without any prior affine registration.



\begin{table}[!t]\small
\renewcommand\arraystretch{0.8}
\centering
\caption{\textbf{Performance Comparison.} Numerical comparison of our proposed framework vs. other existing image registration techniques. The numerical values reflect the TRE metric $(mm)$ for both the DIRLab COPD and the 4DCT datasets. The best results are highlighted in green colour.}%\vspace{-16pt}
\begin{center}
%\resizebox{0.8\textwidth}{!}{
\begin{tabular}{p{0.45in} p{0.55in}p{0.55in}
                          p{0.55in}p{0.55in}
                          p{0.645in}p{0.55in}
                          p{0.5in}}
\toprule
\rowcolor[HTML]{EFEFEF}
\ COPD &{\ \ \ $Init.$}&{\ FE~\cite{liu2019flownet3d}}&{\ PDD~\cite{heinrich2019closing}}&{\ \  VM~\cite{balakrishnan2019voxelmorph} }
  &{LapIRN~\cite{mok2020large}} &{ \ \ INR~\cite{wolterink2022implicit}}&{\ \ \ Ours}  \\
\midrule
{\ \ \ \ 01} &{\ \ \ 26.33}  &{\ \ \ 4.89} &{\ \ \ 2.57} &{\ \ \ 9.95} &{\ \ \ \ 6.85} &{\ \ \ 2.53} &{\ \ \ \cellcolor[HTML]{D7FFD7}\textbf{1.66}} \\

{\ \ \ \ 02} &{\ \ \ 21.79}  &{\ \ \ 7.30} &{\ \ \ 4.01} &{\ \ \ 9.96} &{\ \ \ \ 6.90} &{\ \ \ 5.78} &{\ \ \ \cellcolor[HTML]{D7FFD7}\textbf{3.70}}\\

{\ \ \ \ 03} &{\ \ \ 12.64}  &{\ \ \ 2.89} &{\ \ \ 1.46} &{\ \ \ 4.41} &{\ \ \ \ 1.51} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{1.28}} &{\cellcolor[HTML]{D7FFD7}\ \ \ \textbf{1.28}}\\

{\ \ \ \ 04} &{\ \ \ 29.58}  &{\ \ \ 5.46} &{\ \ \ 2.19} &{\ \ \ 7.08} &{\ \ \ \ 6.38} &{\ \ \ 2.34} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{1.62}}\\

{\ \ \ \ 05} &{\ \ \ 30.08}  &{\ \ \ 5.19} &{\ \ \ 2.22} &{\ \ \ 9.19} &{\ \ \ \ 6.81} &{\ \ \ 3.09} &{\ \ \ \cellcolor[HTML]{D7FFD7}\textbf{1.47}}\\

{\ \ \ \ 06} &{\ \ \ 28.46}  &{\ \ \ 5.53} &{\ \ \ 1.89} &{\ \ \ 8.12} &{\ \ \ \ 4.19} &{\ \ \ 2.66} &{\ \ \ \cellcolor[HTML]{D7FFD7}\textbf{1.86}}\\

{\ \ \ \ 07} &{\ \ \ 21.60}  &{\ \ \ 4.40} &{\ \ \ 1.62} &{\ \ \ 7.10} &{\ \ \ \ 2.73} &{\ \ \ 1.27} &{\ \ \ \cellcolor[HTML]{D7FFD7}\textbf{1.20}}\\

{\ \ \ \ 08} &{\ \ \ 26.46}  &{\ \ \ 3.94} &{\ \ \ 1.72} &{\ \ \ 7.92} &{\ \ \ \ 4.32} &{\ \ \ 2.75} &{\ \ \ \cellcolor[HTML]{D7FFD7}\textbf{1.65}}\\

{\ \ \ \ 09} &{\ \ \ 14.86}  &{\ \ \ 3.57} &{\ \ \ 1.51} &{\ \ \ 6.93} &{\ \ \ \ 3.60} &{\ \ \ 1.40} &{\ \ \ \cellcolor[HTML]{D7FFD7}\textbf{1.30}}\\

{\ \ \ \ 10} &{\ \ \ 21.81}  &{\ \ \ 4.44} &{\ \ \ 2.43} &{\ \ \ 9.16} &{\ \ \ \ 6.59} &{\ \ \ 3.25} &{\ \ \ \cellcolor[HTML]{D7FFD7}\textbf{1.69}}\\

\midrule
{\ \ \ $Avg.$}&{\ \ \ 23.36}&{\ \ \ 4.76}&{\ \ \ 2.16} &{\ \ \ 7.98} &{\ \ \ \ 4.99} &{\ \ \ 2.64} &{\ \ \ \cellcolor[HTML]{D7FFD7}\textbf{1.74}} \\
%{\ \ \ \ $p-value$}&{\ \ \ $<$1e-6 } &{\ \ \ $<$1e-6} &{\ \ 0.0004} &{\ \ \ $<$1e-6} &{\ \ \ \  $<$1e-6} &{\ 0.0007} &{\ \ \ \ \ -}  \\

\bottomrule
\end{tabular}
%}
\end{center}
\label{TableCOPD}
\vspace{-16pt}
%\end{table}
%\vspace{-3cm}
%
%\begin{table}[!t]\small
%\smallskip
\renewcommand\arraystretch{0.8}
\centering
%\caption{TRE results $(mm)$ on DIRLab 4DCT dataset.}\vspace{-16pt}
\begin{center}
\begin{tabular}{p{0.45in} p{0.55in}p{0.55in}
                          p{0.55in}p{0.55in}
                          p{0.645in}p{0.55in}
                          p{0.5in}}
\toprule
\rowcolor[HTML]{EFEFEF}
\ 4DCT &{\ \ \ $Init.$}&{\ \ FE~\cite{liu2019flownet3d}}&{\ PDD~\cite{heinrich2019closing}}&{\ \   VM~\cite{balakrishnan2019voxelmorph} }
  &{LapIRN~\cite{mok2020large}} &{ \ \ INR~\cite{wolterink2022implicit}}&{\ \ Ours} \\
\midrule
{\ \ \ \ 01} &{\ \ \ 3.89}  &{\ \ \ 2.20} &{\ \ \ 0.90} &{\ \ \ 1.46} &{\ \ \ \ 1.00} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{0.76}} &{\ \ \ 0.78} \\

{\ \ \ \ 02} &{\ \ \ 4.34}  &{\ \ \ 3.89} &{\ \ \ 0.91} &{\ \ \ 1.51} &{\ \ \ \ 1.28} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{0.76}} &{\ \ \ 0.77}  \\

{\ \ \ \ 03} &{\ \ \ 6.94}  &{\ \ \ 2.71} &{\ \ \ 1.06} &{\ \ \ 2.31} &{\ \ \ \ 2.18} &\cellcolor[HTML]{D7FFD7}\ \ \ \textbf{0.94} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{0.94}}  \\

{\ \ \ \ 04} &{\ \ \ 9.83}  &{\ \ \ 2.95} &{\ \ \ 1.66} &{\ \ \ 2.72} &{\ \ \ \ 3.05} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{1.32}} &{\ \ \ 1.36}  \\

{\ \ \ \ 05} &{\ \ \ 7.48}  &{\ \ \ 3.03} &{\ \ \ 1.68} &{\ \ \ 2.69} &{\ \ \ \ 2.36} &{\ \ \ 1.23} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{1.20}}  \\

{\ \ \ \ 06} &{\ \ \ 10.89} &{\ \ \ 3.36} &{\ \ \ 1.86} &{\ \ \ 3.07} &{\ \ \ \ 1.78} &{\ \ \ 1.09} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{1.06}}  \\

{\ \ \ \ 07} &{\ \ \ 11.03} &{\ \ \ 3.10} &{\ \ \ 1.94} &{\ \ \ 3.01} &{\ \ \ \ 2.24} &{\ \ \ 1.12} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{0.97}}  \\

{\ \ \ \ 08} &{\ \ \ 14.99} &{\ \ \ 2.94} &{\ \ \ 1.79} &{\ \ \ 6.22} &{\ \ \ \ 2.24} &{\ \ \ 1.21} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{1.12}}  \\

{\ \ \ \ 09} &{\ \ \ 7.92}  &{\ \ \ 2.86} &{\ \ \ 1.94} &{\ \ \ 2.94} &{\ \ \ \ 2.26} &{\ \ \ 1.22} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{1.08}}  \\

{\ \ \ \ 10} &{\ \ \ 7.30}  &{\ \ \ 2.99} &{\ \ \ 2.03} &{\ \ \ 3.00} &{\ \ \ \ 1.90} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{1.01}} &{\ \ \ 1.04}  \\
\midrule
{\ \ \ $Avg.$}&{\ \ \ 8.46} &{\ \ \ 3.00} &{\ \ \ 1.57} &{\ \ \ 2.89} &{\ \ \ \ 2.03} &{\ \ \ 1.07} &\cellcolor[HTML]{D7FFD7}{\ \ \ \textbf{1.03}}  \\
%{\ \ \ \ $p-value$}&{\ \ \ $<$1e-6 } &{\ \ \ $<$1e-6} &{\ \ 0.0002} &{\ \ \ $<$1e-6} &{\ \ \ \ 4.6e-6} &{\ \ \textcolor{red}{0.056}} &{\ \ \ \ \ -}  \\

\bottomrule
\end{tabular}
\end{center}
\label{Table4DCT}
\vspace{-16pt}
\end{table}
%


\subsection{Experimental Results}
For evaluating our proposed method, we compare it against five competitive methods for lung CT registration, which is a challenging task due to the superposition of respiratory and cardiac motion. 

\vspace{6pt}\noindent\textbf{Performance Improvement.} 
In Table \ref{TableCOPD}, we report a set of quantitative comparisons in terms of $TRE (mm)$  on the DIRLab COPD dataset and the 4DCT dataset between our method and other state-of-the-art methods: 1) FE~\cite{liu2019flownet3d}, 2) PDD~\cite{heinrich2019closing}, 3) VM~\cite{balakrishnan2019voxelmorph}, 4) LapIRN~\cite{mok2020large}, and 5) INR~\cite{wolterink2022implicit}. The COPD dataset has extremely large deformation with an average initial displacement of 23.36 $mm$. The initial $TRE$ of all patients are listed in the second column of the table, denoted as $Init.$.
%
In a closer look at the results, we observe that our method achieved the lowest $TRE$ in all COPD data pairs, with an average value of 1.74 $mm$. We outperform the second-best method INR by 0.42 $mm$. While other methods have much higher average $TRE$ values ranging from 2.16 $mm$ to 7.98 $mm$. Similarly, the lower part of Table \ref{Table4DCT} reports results on 4DCT dataset, our method also achieved the lowest average $TRE$ compared to other methods, and the lowest $TRE$ on 6 image pairs. %\textcolor{blue}{I suggest we move table 2 to supp file.}
%
We also ran a non-parametric test for multiple comparisons using the Friedman test along with Kendall's coefficient of concordance with 95\% confidence intervals as a measure of the effect size for the Friedman test. The statistical analyses for both datasets are reported in Fig.~\ref{FigTest}. We can conclude that there is a statistically significant difference in performance $\chi^2_{Friedman} (5)= 45.11 \& 46.95$ with $p=1.38e\text{-}08$ \& $5.82e\text{-}09$. The effect size is $W_{Kendall} = 0.90 \& 0.94$ with 95\% CI. We then performed  pair-wise comparisons using the non-parametric Wilcoxon test yielding to our technique being statistically significantly different in performance across all compared techniques.
%

\input{fig/fig3}
%


\noindent\textbf{Qualitative Evaluation.}
We computed the Jacobian determinant and plotted the results using a color map, where red indicates a positive determinant and blue indicates a negative determinant. Fig.~\ref{FigJdet} displays selected patients with: No regularisation, Hyperelastic~\cite{wolterink2022implicit,burger2013hyperelastic}, and our conformal invariant regulariser. We observe that without regularisation, one obtains
%As shown, the No Regularisation method resulted in
a large number of negative values for the Jacobian determinant. This indicates no plausible transformations and destruction on the topology.  
The Hyperelastic regulariser also reports substantial negative values for the Jacobian determinant (blue areas) along with large expansions. In contrast, our regulariser, reported all positive values yielding to clinical meaningful transformations.

\input{fig/figJdet}
%


