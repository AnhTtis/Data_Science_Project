%
\section{Proposed Framework}
This section describes our novel image registration framework. It contains two key parts: %i) the statement of the registration problem  and
i) the introduction and motivation of our new conformal-invariant hyperelastic-based regulariser to impose a physically relevant nature on the deformation, and ii) the details of our learning framework based on coordinate Multi-Layer Perceptron (MLP).%\Angie{tbu}

\textbf{{Problem Statement.}}
\input{fig/fig1}
In this work, we consider the problem of how to improve 3D image registration.  Let $\Omega$ be a convex bounded open subset of $\mathbb{R}^3$ (the image spatial domain) of class $\mathcal{C}^1$ thus satisfying the cone property meaning that there exists a finite cone $C$ such that each point $x\in \Omega$ is the vertex of a finite cone $C_x$ contained in $\Omega$ and congruent to $C$, and theoretically required to ensure Ball's results \cite{ball}. Let $\mathbf{I}_S:\Omega \to \mathbb{R}$ be the source image to be deformed, and $\mathbf{I_T}:\Omega \to \mathbb{R}$ be the target image to be fixed. The mapping $\mathbf{\Phi}: \bar{\Omega}\to\mathbb{R}^3$ denotes the sought non-rigid and non-parametric deformation aligning the deformed source image $\mathbf{I}_S(\mathbf{\Phi})$ with the target one $\mathbf{I}_T$, while $\nabla \mathbf{\Phi}: \bar{\Omega}\to M_3(\mathbb{R})$ is the Jacobian deformation with $M_3(\mathbb{R})$ the set of $3\times3$ matrices.


Since image registration is highly ill-posed, in an unsupervised deep learning framework in which we place ourselves, the design of the cost function is crucial. Following arguments from the variational setting, the sought deformation is obtained by minimising a loss function comprising two key terms. Firstly,
a similarity term that measures how close the deformed source image is to the target image in a sense depending on the application. Secondly, a regularisation term encoding the prescribed nature of the allowed deformations: 
\begin{equation}
    \hat{\mathbf{\Phi}} = \argmin_{\mathbf{\Phi} \in \mathcal{W}}\mathcal{L}(\mathbf{\Phi})=\mathcal{L}_{sim}(\mathbf{I}_S(\mathbf{\Phi}),\mathbf{I}_T)+\lambda\mathcal{L}_{reg}(\mathbf{\Phi}), 
    %p_x, p_y, p_z, \mathbf{\Phi}_{p_x},\mathbf{\Phi}_{p_y},\mathbf{\Phi}_{p_z}
\end{equation}
$\lambda$ being a trade-off parameter between both terms. 

\subsection{A Novel Conformal-Invariant Regularisation}
Inspired by the theory of mechanics, the shapes to be matched are viewed as physical bodies subjected to forces and undergoing deformations. In this context, a deformation \cite{ciarlet1994three} is a smooth mapping that is orientation preserving and injective except possibly on the boundary $\partial \Omega$ if self-contact is allowed which mathematically translates into $\mathrm{det}\nabla \mathbf{\Phi}>0$ almost everywhere. %From the variational perspective, it is well-understood that in order to obtain meaningful solutions, one needs to enforce the problem to be well-posed. The key for such is the regulariser. 
From the variational perspective, it is well-understood that in order to obtain meaningful solutions, one needs to enforce the problem to be well-posed. The key for such is the regulariser. Majority of learning-based image registration models leverage the empirical properties of a given architecture to approximate the well-posedness of the registration. Whilst they report great performance, they do not provide any guaranteed property yielding to topologically preserving transformations. %to be difficult to obtain.} 
Motivated by this drawback in the learning-based literature, we introduce a novel regulariser that guarantees homeomorphic transformations-- this is translated to have a model that enforces topology preservation yielding to clinically meaningful output. With the previous motivation in mind, our new model falls within the hyperelasticity setting allowing large and non-linear deformations (\cite[ch. 4]{ciarlet1994three}) while keeping an elastic behavior and computational performance. Our motivation to select this principle is that organs and several biological phenomena are characterised by hyperelasticity. We note that highly deformable materials such as rubber, filled elastomer, or biological tissues, are often modelled within this hyperelasticity setting. Unlike linear elasticity assuming small strains and the validity of Hooke's law (linear relation between stress and strains), the hyperelasticity theory predicates the existence of a stored energy density function differentiable with respect to the deformation in each direction and whose derivative gives the state of stress within the material in the same direction. The total deformation stored energy is given by the integral of this density over the whole body and by minimising this quantity \textit{we find a solution to the equilibrium problem} \cite{ledret2004}. 

In our model, the objects are considered as isotropic (the material deforms in the same way in every direction), homogeneous (meaning that the behavior is the same everywhere inside the material), and hyperelastic materials allowing large compressions and expansions while keeping a mechanical elastic behavior. This interpretation drives the construction of our new regularisation term therefore based on the stored energy of such materials prescribing then a physically-meaningful nature for the generated deformations. Our new regulariser reads:
\begin{equation}
\mathcal{L}_{reg}(\mathbf{\Phi}) = \int_\Omega W(\nabla \mathbf{\Phi}(x),\mathrm{Cof}\nabla \mathbf{\Phi}(x),\mathrm{det}\nabla \mathbf{\Phi}(x))\,dx, \; \: \text{with}
\end{equation}
$W(\nabla \mathbf{\Phi},\mathrm{Cof}\nabla \mathbf{\Phi},\mathrm{det}\nabla \mathbf{\Phi}) = \left\{ \begin{array}{l} \frac{a_1\|\nabla \mathbf{\Phi}\|_F^9}{(\mathrm{det}\nabla \mathbf{\Phi})^3}+\frac{a_2\|\mathrm{Cof}\nabla \mathbf{\Phi}\|_F^6}{(\mathrm{det}\nabla \mathrm{\Phi})^4} + a_3(\mathrm{det}\nabla \mathbf{\Phi}-1)^2 + \text{...}\\ \text{...} \frac{a_4}{(\mathrm{det}\nabla \mathbf{\Phi})^\alpha} - 3^{\frac{9}{2}}a_1 - 3^3a_2-a_4 \text{ if } \mathrm{det}\nabla \mathbf{\Phi} >0 \\ +\infty  \text{ otherwise}\end{array} \right.$, \\

$\|A\|_F = \sqrt{\mathrm{Tr}(A^TA)} $ being the Frobenius norm, and $\alpha>1$, $a_1>0$, $a_2>0$, $a_3>0$ and $a_4>0$ being hyper-parameters. {The first two terms are distorsion mappings and measure the deviation from conformality of the deformation and are conformally invariant meaning that any conformal change of variables does not alter their values \cite{adamowicz2007}}. Our regulariser is then seen as the unification of the hyperelasticity with the conformal and Beltrami-based approaches \cite{lam2014}. They also control the changes in length and area as well as the smoothness of the deformations. The third and fourth terms are added to control changes in volume that is promoting volume-preserving deformations by penalising deviations from one of the Jacobian determinant while preventing singularities by penalising small values of it. The last constants are added to impose $W(I_3,I_3,1)=0$ as required by the hyperelasticity setting. The stored energy density function $W$ is thus polyconvex and rotation-invariant by definition, and the deformations are searched in the following suitable functional space $\mathcal{W} = \{\varphi \in \mathrm{Id}+W^{1,9}_0(\Omega,\mathbb{R}^3)\, |  \, \frac{\|\nabla \varphi\|_F^9}{(\mathrm{det}\nabla \varphi)^3}\in L^1(\Omega), \frac{\|\mathrm{Cof}\nabla \varphi\|_F^6}{(\mathrm{det}\nabla \varphi)^4}\in L^1(\Omega),\mathrm{det}\nabla \varphi \in L^2(\Omega),\frac{1}{\mathrm{det}\nabla \varphi}\in L^\alpha(\Omega), \nabla \det \varphi >0 \text{ a.e. in} \Omega \}$, that is the deformation is assumed to be equal to the identity on the boundary $\partial \Omega$.
\begin{remark}
This assumption is lifted in  practice since the computation of the deformation is done only in the lung mask inside the image spatial domain $\Omega$ as explained in the following section.
\end{remark}
Since $9>4$ and 
\begin{eqnarray*}
\int_\Omega \|(\nabla \mathbf{\Phi})^{-1}(x)\|^4\mathrm{det}\nabla \mathbf{\Phi}(x)\,dx &=& \int_\Omega \|\frac{1}{\mathrm{det}\nabla \mathbf{\Phi}(x)}\mathrm{Cof}\nabla \mathbf{\Phi}(x)^T \|^4 \mathrm{det}\nabla \mathbf{\Phi}(x)\,dx,\\
&=&\int_\Omega \frac{1}{(\mathrm{det}\nabla \mathbf{\Phi}(x))^3}\|\mathrm{Cof}\nabla \mathbf{\Phi}(x)\|^4\,dx,\\
&=&\int_\Omega \frac{\|\mathrm{Cof}\nabla \mathbf{\Phi}(x)\|^4}{(\mathrm{det}\nabla \mathbf{\Phi})^{\frac{8}{3}}}\frac{1}{(\mathrm{det}\nabla \mathbf{\Phi}(x))^{\frac{1}{3}}}\,dx,\\
&\leq& \Bigg(\int_\Omega\frac{\|\mathrm{Cof}\nabla \mathbf{\Phi}(x)\|^6}{(\mathrm{det}\nabla \mathbf{\Phi}(x))^4}\,dx\Bigg)^{\frac{2}{3}}(\int_\Omega\frac{1}{\mathrm{det}\nabla \mathbf{\Phi}(x)}\,dx)^{\frac{1}{3}} \\
&&\text{ by Holder's inequality with $p=\frac{3}{2}$ and $q=3$},
\end{eqnarray*}
then Ball's results apply \cite{ball} and the deformations are homeomorphisms with the inverse deformation $\mathbf{\Phi}^{-1}\in W^{1,4}(\Omega,\mathbb{R}^3)$.
\\
The similarity term is taken as the classical normalised crossed-correlation between the deformed source image and the target one:
\begin{eqnarray*}
    \mathcal{L}_{sim}(\mathbf{I}_S(\mathbf{\Phi}),\mathbf{I}_T)& =& -NCC(\mathbf{I}_S(\mathbf{\Phi}),\mathbf{I}_T)\\
    & =& -\sum_{p\in \Omega}\frac{(\sum_{p_i\in w}(\mathbf{I}_S(\mathbf{\Phi}(p_i))-\bar{\mathbf{I}}_S(\mathbf{\Phi}(p)))(\mathbf{I}_T(p_i)-\bar{\mathbf{I}}_T(p)))^2}{\sum_{p_i\in w}(\mathbf{I}_S(\mathbf{\Phi}(p_i))-\bar{\mathbf{I}}_S(\mathbf{\Phi}(p)))^2\sum_{p_i\in w}(\mathbf{I}_T(p_i)-\bar{\mathbf{I}}_T(p))^2},
\end{eqnarray*}
with $w$ being a local window of size $n^3$ around the current pixel $p$, and $\bar{\mathbf{I}}_S(\mathbf{\Phi})(p)$ and $\bar{\mathbf{I}}_T(p)$ are the mean intensity of that local window.

%
\subsection{Learning Transformations via Coordinate MLP} 
We implement pair-wise registration with our proposed regulariser using coordinate MLP to continuously represent the transformation. The input of the MLP is the spatial coordinate $(x, y, z)$ in the lung area, rather than image intensities.
For lung CT registration, due to sophisticated structures in the lungs, we expect that the coordinate MLP can represent high-frequency information, which means local small deformations. To achieve this, we choose to use periodic sinusoidal function enabling the fitting of high-frequency content following the  SIREN \cite{sitzmann2020implicit} strategy.
Take a 3D position $p\in \mathbb{R}^3$ in $\mathbf{I}_T$ as input, set $p'\in \mathbb{R}^3 $ as corresponding position in the coordinate space of $\mathbf{I}_S$.
The deformation between $p$ and $p'$ is parameterised as following:
\begin{equation}
    \mathbf{\Phi}(p)=sin(\omega(W_ip+b_i)),
\end{equation}
%
where $\omega$ is the hyperparameter that regulates
the spectral bias of the network, we set it as 32 for all our experiments.
In our setting, we use a 4-layer MLP for the COPD dataset and a 3-layer MLP for 4DCT dataset with 256 hidden units.


