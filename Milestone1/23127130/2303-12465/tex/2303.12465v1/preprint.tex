\documentclass[preprint,amsmath,amssymb,superscriptaddress,aps, final,dvipsnames,Table]{revtex4-1}
\usepackage{rotating}
% \usepackage{adjustbox}
\usepackage[dvipsnames]{xcolor}
\usepackage[title]{appendix}
\usepackage{ragged2e}
\usepackage{float}
\usepackage{tikz}
% \usepackage{multirow}
\usepackage{chemformula}[2014/04/08]
\setchemformula{kroeger-vink=true}
\usepackage{microtype}
\usepackage[labelfont=bf,justification=raggedright]{caption}
% \usepackage{caption}
% \captionsetup{format=plain, justification=justified}

%\usepackage{subfig}
% \usepackage{subcaption}
%\usepackage{wrapfig}
%\usepackage[hang,small,bf]{caption}
%%%%%%%%%%%%%%%\usepackage{mwe}
\usepackage{tabularx}
    \newcolumntype{L}{>{\raggedright\arraybackslash}X}
    \newcolumntype{C}{>{\centering\arraybackslash}X}
    \newcolumntype{R}{>{\raggedleft\arraybackslash}X}
    \usepackage{siunitx}
%\usepackage[demo]{graphicx}% Does not include figure
%\usepackage[final]{graphicx}% Include figure files
%\usepackage[format=hang,font=small,justification=raggedright]{caption}
%\usepackage[format=plain,font=small,justification=justified]{subcaption} 
\usepackage{dcolumn}% Align Table columns on decimal point
\usepackage{bm}% bold math
\usepackage[]{color}
\graphicspath{ {.//} }
\definecolor{ultramarine}{RGB}{0,32,96}
\usepackage{subcaption}
\usepackage{amsmath}
\DeclareMathAlphabet{\mathcal}{OMS}{cmsy}{m}{n}
\SetMathAlphabet{\mathcal}{bold}{OMS}{cmsy}{b}{n}

\newcommand\cj[1]{{\color{blue}#1}}
\newcommand\aiidadefects{AiiDA-defects }
\newcommand\aiida{AiiDA }


\begin{document}
%%%%%%%%%%%%%%%%\tracingall
% \savebox\VOOO{\ch{V_{S}^{..}}}

%\preprint{APS/123-QED}

\title{AiiDA-Defects: An automated and fully reproducible workflow for the complete characterization of defect chemistry in functional materials
}
% Force line breaks with \\
%\thanks{A footnote to the article title}%

%\affiliation{
%Theory and Simulations of Materials %(THEOS), EPFL, Lausanne, Switzerland %\\
%}
%\affiliation{IBM RSM Zurich Research %Laboratory, Zurich, Switzerland}
\author{Sokseiha Muy}
\thanks{These two authors contributed equally to this work.}
\affiliation{
Theory and Simulations of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (MARVEL), École Polytechnique Fédérale de Lausanne, CH-1015 Lausanne, Switzerland}%

\author{Conrad Johnston}
\thanks{These two authors contributed equally to this work.}
% \email[Now at Pacific Northwest National Laboratory: ]{\mbox{conrad.johnston@pnnl.gov}}
\affiliation{
Theory and Simulations of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (MARVEL), École Polytechnique Fédérale de Lausanne, CH-1015 Lausanne, Switzerland}

\author{Nicola Marzari}
\email{nicola.marzari@epfl.ch}
\affiliation{
Theory and Simulations of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (MARVEL), École Polytechnique Fédérale de Lausanne, CH-1015 Lausanne, Switzerland} %\\
%\homepage{http://www.Second.institution.edu/~Charlie.Author}

%\affiliation{
% Third institution, the second for Charlie Author
%}%
%\author{Delta Author}
%\affiliation{%

%



\date{\today}% It is always \today, today,
             %  but any date may be explicitly specified
\vspace{10cm}
\clearpage
\newpage
\begin{abstract}

Important functional materials that enable many technological applications in our everyday lives owe their unique properties to defects that are carefully engineered and incorporated into these materials during processing. However, optimizing and characterizing those defects is very challenging in practice, making computational modelling an indispensable complementary tool. We have developed a package to accelerate defect calculations called \aiidadefects, which utilises the \aiida framework, a robust open- source high-throughput infrastructure that provides workflow automation while simultaneously preserving and storing the full data provenance in a relational database, thus making it queryable and traversable, and enabling high-performance data analytics. 
This paper describes the design and implementation details of \aiidadefects, the models and algorithms used, and demonstrates its use in an application to fully characterize the defect chemistry in a well known solid-state Li-ion conductors LiZnPS$_4$. We anticipate that \aiidadefects  will be useful as a tool for fully automated and reproducible defect calculations, allowing detailed defect chemistry to be obtained in an automated and high-throughput way, and paving the way toward the generation of defects databases for accelerated material design and discoveries. 
\end{abstract}

\pacs{Valid PACS appear here}% PACS, the Physics and Astronomy
                             % Classification Scheme.
%\keywords{Suggested keywords}%Use showkeys class option if keyword
                              %display desired
\maketitle

\section{\label{Intro}Introduction}
Point defects in semiconductors and insulators have enormous influences on the mechanical, transport, electronic, and optical properties of materials \cite{SEEBAUER200657}. 
Many materials which have found important technological applications largely owe their functionalities to the defects that were carefully selected and introduced into the pure materials during their synthesis. There is a vast literature on the defect engineering to achieve specific functionalities in various functional materials such as light emitting diode \cite{defect_GaN_LED}, photovoltaic materials \cite{perovskite_solarcell_review, photovoltaic_2019_review}, thermoelectric materials \cite{thermoelectric_review} and solid-state Li-ion conductors \cite{muy_chem_review, ohno_materials_2020} and the NV centers in diamond for quantum sensing \cite{NV_center_2013, Quantum_sensing} just to name a few. 

Within the realm of computational materials science and computational chemistry, there are a growing number of packages and libraries offering some degree of workflow automation, such as ASE\cite{ase}, AFLOW\cite{aflow}, Fireworks\cite{fireworks}, QMflows\cite{qmflows}, and these can be considered to be a specialised subset of a larger family of automation and parallel computing frameworks of interest to a general scientific computing audience\cite{signac,gc3pie,parsl}.
There are also a number of packages addressing different aspects of defect chemistry, especially the computation of defect formation energy corrections, and sometimes for the case of charged defects. This family includes packages such as PyCDT\cite{PyCDT}, pylada-defects\cite{pylada-defects}, CoFEEE\cite{CoFFEE}, and PyDEF\cite{PyDEF}.
Typically the members of this family employ post-, and sometimes pre-,  processing scripts to address specific aspects of defect chemistry calculations and are often designed with a particular quantum code in mind, and will interact with the chosen code in a manual or automatic way. The quantity of high quality of efforts in this direction demonstrates the demand to have these tasks automated and abstracted away from computational scientists' workload. 

\aiida\cite{aiida, aiida-workflow-engine} is computational infrastructure designed for  high-throughput computation and automation. Like some of the other workflow frameworks, it is an open-source project written in Python, but crucially, the automation tasks are abstracted using a scalable workflow engine which runs and monitors workflow steps  concurrently, both locally and on high performance computing resources, while simultaneously capturing all of the results and the calculation provenance in a private database to ensure full reproducibility of results. 
Another key strength of \aiida is its plugin system. This allows for almost any software or system to be interfaced with the core \aiida functionality, with each plugin serving as an interface to the API provided by the \aiida framework.
Thanks to an enthusiastic community of plugin developers, a considerable number of scientific codes, databases and workflows are already supported\cite{aiida-plugin-reg}. 

\aiidadefects has been developed as a plugin for \aiida with the goal of making the the analysis of the defect chemistry as seamless and painless as possible, and to accelerate the discovery and design of new functional materials. 
While other open-source software packages to compute the defect formation energy are available, such as those mentioned previously, our package can differentiated from those earlier works by providing the automatic characterization of the complete defect chemistry of a material in a thermodynamically consistent framework rather than just a single defect calculation, as well as providing full reproducibility of the results by leveraging the \aiida infrastructure.

To illustrate the capabilities of \aiidadefects, we will study defects in a Li-ion conductors, LiZnPS$_4$ which has been proposed as a solid electrolyte in the next generation all-solid Li-ion batteries \cite{richards_design_2016, suzuki_synthesis_2018}.
Defects in materials used for solid-state electrolytes are particularly interesting as in their pure stoichiometric form, these materials typically exhibit very low ionic conductivity. In order to reach appreciable and useful ionic conductivity, many Li-conductors require careful  defect optimization strategies to introduce vacancies or interstitial Li into the lattice. 
Traditionally, this was achieved via aliovalent doping where non-mobile ions were replaced with another ion of a different charge and it is assumed that charge compensation was driven by changing the concentration of Li to maintain the overall charge neutrality. However, for a given charge of the aliovalent dopant, there is no strategy to decide which ion to be chosen from the periodic table. Moreover, it is not guaranteed that changing Li concentration is always the main charge compensating mechanism as there are potentially other defects such as anti-site, vacancies on the non-Li site, etc. that can also lead to a charge neutral system \cite{squires_native_2020}. In order to optimize the type of defects and their concentration, one needs to have access to the formation energy of various types of defects under a given experimental condition, such as temperature, pressure, chemical potential of different species, etc. The required calculations are often resource demanding and tedious because of the large number of pre- and post-processing steps involved, and the large number of such calculations that are required to fully characterise the defect chemistry of the material, highlighting the need for an automated workflow that can seamlessly and robustly handles these types of complex calculations. 

\section{\label{sec:section2} Background and methods}
A common need in the design of materials is a knowledge of the expected defect concentration. 
In order to estimate defect concentrations, one needs to calculate the formation energy of a given defect type.
The formalism of the defect formation energy (in dilute limit) is well established \cite{zhang_chemical_1991, FreysoldtRMP}. 
Conventionally, it can be calculated using the following expression \cite{FreysoldtRMP}:

\begin{equation} \label{eq:FormationEnergy}
E^f[X^q ] = E_{tot}[X^q]-E_{tot}[bulk]-\sum_in_i\mu_i + qE_F +E_{corr}
\end{equation}

Where $E^f[X^q ]$ is the formation energy of defect X in the charge state q, $E_{tot}[X^q ]$ is the energy of the supercell with the defect which is typically the energy obtained from density functional theory (DFT) calculations, $E_{tot}[bulk]$ is the energy of the pristine supercell without the defect, $n_i$ are the number of atoms of type $i$ added ($n_i>0$) or removed ($n_i<0$) from the supercell to create the defects, $\mu_i$ is the chemical potential of atomic species $i$, $E_F$ is the Fermi level relative to the maximum of the valence band and $E_{corr}$ is the post-processing correction term added to remove the spurious long-range electrostatic interactions between the charged defect and its periodic images as well as with the uniform background charge \cite{freysoldt_PRL_2009,freysoldt_2011,dabo_electrostatics_2008}. 
In the \aiidadefects package, each of these terms is computed automatically in a workflow, called a ``workchain`` in the terminology of \aiida, which is controlled by the \aiida workflow management engine\cite{aiida-workflow-engine, aiida}.
The standard steps of running a DFT calculation are handled seamlessly and automatically, - from the preparation of an input file to the retrieval of results from a supercomputing centre - with the provenance being captured in a fully queryable database continuously. 

In the following sections, we will describe in more detail the computational and practical considerations when computing defect formation energies, and detail the implementation of each workchain inside the package, and illustrate its use with determination of defect chemistry in the Li-ion conductors  LiZnPS\textsubscript{4}.

\subsection{\label{subsec:section2.1}Periodic image correction}
In equation \ref{eq:FormationEnergy}, we stated how the defect formation energy for a given defect could be calculated. 
The most important assumption underling this equation is that the defect is in the  `infinitely dilute limit', such that the interaction between defects can be neglected and the defect can be considered as isolated. However, most of the DFT codes used the periodic boundary condition which leads to spurious interaction between the defect and its periodic images.
To simulate an isolated defect, one can use a supercell that is large enough such that any interaction between the defect and its periodic images is negligible. However, a problem that remains is that generally DFT suffers from very unfavourable scaling, often cited to be $\mathcal{O}(n^3)$,  making this this approach impractical for realistic systems.

To overcome this, it was recognised that the interaction between defects images could be thought of as arising from two contributions - that from the electronic wavefunctions overlapping, and that from electrostatic interactions.
In the case where the electronic density of the defect state is well localised, it can be assumed that the interaction is solely from electrostatics and so model systems can be constructed with which to estimate the size of this interaction to provide a correction \emph{a posteriori}.

The energy of such a model is given by:
\begin{equation} \label{eq:ElectrostaticEnergy}
    E = -\frac{1}{2} \int_{cell} d^3\boldsymbol{r} \rho(\boldsymbol{r}) \nabla^2\nu(\boldsymbol{r})
\end{equation}
where the electrostatic potential  $\nu(\boldsymbol{r})$ for a model system with a model charge distribution $\rho(\boldsymbol{r})$ is obtained by solving the Poisson equation \cite{dabo_electrostatics_2008, Dabo2011}:
\begin{equation} \label{eq:ElectrostaticPotential}
    \nabla^2\nu(\boldsymbol{r}) = - \frac{4 \pi}{\epsilon} \rho(\boldsymbol{r})
\end{equation}
where $\epsilon$ is the permittivity of the host material.

For the case of periodic boundary conditions, the potential be evaluated in reciprocal space using:
\begin{equation} \label{eq:PoissonSolution-Reciprocal-Isotropic}
    \nu(\boldsymbol{G}) =  4 \pi \sum_{\boldsymbol{G} \neq 0} 
    \frac{\rho(\boldsymbol{G})}{\epsilon|\boldsymbol{G}^2|}
\end{equation}


To compute the correction for a given supercell size, the difference in energy is computed between that of model system of identical size to the DFT supercell, and an infinitely extended supercell, either extrapolated from multiple models of differing size under periodic boundary conditions, or a model with open boundary conditions. 
The remaining choice is which charge distribution to use for the model.
A number of schemes have been proposed, but these can be classified into three groups \cite{Walsh2021, Dabo2008}:
point countercharge corrections, such as the Makov-Payne scheme, use a point charge in place of the defect \cite{Makov1995},Gaussian countercharge corrections use a Gaussian type function as the model charge \cite{Dabo2008, freysoldt_PRL_2009, freysoldt_2011}, and density countercharge corrections, using the charge density difference derived from the DFT \cite{Dabo2008}.
It is also possible to apply this correction in a DFT self-consistent cycle, rather than \emph{a posteriori} by including it in the procedure to optimise the DFT wavefunction directly in DFT code, the and there have been some recent schemes based on this idea \cite{Walsh2021, Suo2020, ChagasdaSilva2021}.
In the \aiidadefects package, we choose to use an \emph{a posteriori} correction as this allows us to remain agnostic to the choice of any particular quantum code.
A recent package\cite{aiida-common-workflows} demonstrated utilising \aiida in this way, using the example of the computation of equation of state to show how a common code-agnostic workflow could be coupled to a menagerie of codes through a set of simple  interfaces.
Here we also embrace this idea, and recognise that the application of a charge correction scheme \emph{a posteriori} can be made to support any code through simple interfaces, with many solid-sate codes already having support in \aiida for the required single-point energy calculations\cite{aiida-plugin-reg}. 

We implement and make available two schemes for use in the package. 
The default scheme is to a fit a multivariate Gaussian to the defect charge density, defined as the difference between the DFT charge density of the material with a defect in a charge state $q$ and that of the pristine bulk:
    \begin{equation}\label{eq:charge_density_difference}
        \rho_{defect}(\boldsymbol{r}) = \rho_{defect}^q(\boldsymbol{r}) -  \rho_{bulk}(\boldsymbol{r})
    \end{equation}
The probability density function for a multivariate Gaussian in 3-dimensions is given by:
\begin{equation}\label{eq:multivariate_gaussian}
    f(x) = \frac{1}{\sqrt{(2\pi)^3\det \Sigma}}\exp\left(-\frac{1}{2}(x-\mu)^T\Sigma^{-1}(x-\mu)\right)
\end{equation}
where $\Sigma$ is the symmetric positive definite covariance matrix, and $\mu$ is the mean. The fitting minimises the difference between the charge density difference via the adjusting the 6 parameters of the covariance matrix, and the 3-coordinate position of the mean, representing the centre of the charge density difference distribution.
The fitting automates the choice of the Gaussian width which is a crucial consideration to enable materials and defects to be be studied in a high throughput mode.
Using a multivariate Gaussian allows for anisotropy of the model charge distribution and a better fit to the DFT charge difference. 
In the case that a defect charge distribution is complex, perhaps with degenerate peaks, the charge fitting may not converge well and so the user has the option to  specify the parameters of the covariance matrix directly.
This also allows for an isotropic Gaussian to be specified, similar to the `standard' Gaussian countercharge type corrections.

In equation \ref{eq:PoissonSolution-Reciprocal-Isotropic}, the charge density is screened by the a relative permittivity $\epsilon$. 
The user may specify this value or it will be automatically calculated using Denisty Functional Perturbation Theory.
In practice, the full tensorial value is used an so equation \ref{eq:PoissonSolution-Reciprocal-Isotropic} can be re-written:
\begin{equation} \label{eq:PoissonSolution-Reciprocal-Anisotropic}
    \nu(\boldsymbol{G}) =  4 \pi \sum_{\boldsymbol{G} \neq 0} 
    \frac{\rho(\boldsymbol{G})}{\boldsymbol{G} \cdot \boldsymbol{\epsilon} \cdot \boldsymbol{G}}
\end{equation}
where $\boldsymbol{\epsilon}$ is now a $3\times3$ matrix describing the relative permittivity in three dimensions.
The user may specify a full matrix or a single value.

With these ingredients, the energy of a given size of model system can be computed and compared to an energy extrapolated to infinity from a series of increasingly large model systems. In the case of the model charge being represented by an isotropic  Gaussian, this extrapolation can be avoided since the analytical solution of the Poisson's equation of a gaussian charge density with open boundary condition is known and can be used directly to obtain the isolated model energy:
\begin{equation} \label{eq:PoissonSolution-OpenBC}
    E = \frac{q^2}{2\epsilon\sigma\sqrt{\pi}}
\end{equation}
This shortcut is applied automatically if an isotropic Gaussian is supplied by the user or found by fitting.  

\subsection{\label{subsec:section2.2}Potential Alignment}
In Section \ref{subsec:section2.1}, we showed how the interaction between periodically repeated images of the charged defect could be corrected. 
However, there is another issues arising from the use of a jellium background charge when simulating a system with an overall net charge. The uniformly spread background charge  compensates for the system charge when in order to ensure overall charge neutrality while under periodic boundary conditions, but also introduces a further spurious interaction with the defect charge, and amounts to a shift in the potential. 

\begin{figure}
\centering
\includegraphics[width=1.\linewidth]{images/Potential_alignment.png}
    \caption{In \aiidadefects, the alignment of the defect potential ($V_{q/b}$) to the model potential ($V_{model}^{q}$) is done directly on the 3D-grid and not on the planar-averaged potentials. The values of the potential in the plane containing the defect site (at the center of the cell) are shown.} 
    \label{fig:potential_alignment}
\end{figure}

For an isolated defect, the electrostatic potential must reach the bulk value at very long range. Even including screening, the $q/r$ potential is very slow to converge in computational supercells of tractable size, and so the bulk value remains unknown. 
In the Gaussian countercharge correction scheme by Freysoldt, Neugebauer and van de Walle\cite{freysoldt_PRL_2009, freysoldt_2011} an alignment term is introduced:
\begin{equation}\label{eq:e_corr}
    E_{corr} = E_{lat} -q\Delta V_{q-b/m}
\end{equation}
where $E_{lat}$ is the correction for the spurious electrostatic interaction between images described in Section \ref{subsec:section2.1} and $\Delta V_{q-b/m}$ is a term required to align the electrostatic potentials.\cite{FreysoldtRMP,freysoldt_PRL_2009, freysoldt_2011}
It was shown that in practice, by taking the difference between the potential from DFT and that from the electrostatic model, the potential due to short range effects could be derived. For a large enough supercell, this difference plateaus at some distance from the defect center, indicating that the model reproduces the correct long range behaviour. The offset of this plateau from the value of the average potential of 0 that is implied while under neutralising boundary conditions, gives the required alignment with respect to a neutral bulk system.

In past works, this alignment was done `by eye` in one-dimension. 
The typical procedure is to compute a planar average over two cell vectors so that a three dimensional potential can be reduced to a single dimension. The two potentials to be aligned are then plotted and their offset calculated at some cell position which is considered to sufficiently far away from the defect's range of interaction, that the difference is not changing. This can be prone to error and subjectivity and lose accuracy to the averaging. To allow for this to be done automatically as part of an automated workflow, we approach this procedure slightly differently. 

Rather than computing a planar average, we retain all of the data for the cell.
The potential difference is computed for the two potentials:
\begin{equation}
    V_{diff} = V_{q/b} - V^q_{model}
\end{equation}
where $V^q_{model}$ is the electrostatic potential generated from the model charge, and where 
\begin{equation}
    V_{q/b} = V_{defect}^q-V_{bulk}
\end{equation}
is computed from DFT potentials. 

In the manual procedure, the alignment is read where $V_{diff}$ plateaus far from the defect site. 
To avoid visual inspection, we want to compute the alignment at as large a distance as possible from the defect. To do this, grid points closer than half the distance from the defect to its closest periodic image, as per the minimum image convention, are considered to be too close to the defect center and are discard.
With the remaining points, the following objective function is minimised:
\begin{equation} \label{potential_alignment_mae}
    error = \int_\Omega | V_{diff}(\boldsymbol{r}) - \Delta V |
\end{equation}
evaluated over the whole cell volume $\Omega$, where ${|\boldsymbol{r}-\boldsymbol{r'}|>L}$.
This is fast and automatic, and avoids any ambiguities that may occur from averaging and fluctuations in the data (Figure  \ref{fig:potential_alignment}).

\subsection{\label{subsec:section2.3}Chemical Potential of Ions}
The chemical potential is associated with the energy cost for exchanging an atom between the materials and the surrounding thermodynamic reservoir. Their values reflect the synthesis conditions under which the materials synthesized. Therefore, the value of the chemical potential $\mu_i$ of atom $i$ in a given compound, is constrained not only by the stability of that compound but also that of all the competing phases in the phase diagram. 

To illustrate this idea, following Buckeridge et al. \cite{BUCKERIDGECHEMICALPOTENTIAL}, we consider a compound  $A_{m_1}B_{n_1}C_{p_1}$ in an A-B-C ternary system. We have the following conditions:
\begin{equation} \label{eq:elemental_mu}
\mu_A \leq 0; \quad \mu_B \leq 0 \quad \textrm{and} \quad \mu_C \leq 0
\end{equation}
% \begin{equation}
\begin{align}
    m_1\mu_A+ n_1\mu_B+ p_1\mu_C &=\mu_{A_{m_1}B_{n_1}C_{p_1}} \nonumber \\
        &\simeq \Delta H_f(A_{m_1}B_{n_1}C_{p_1}) \label{eq:muAmBn}
\end{align}
% \end{equation}
The conditions \eqref{eq:elemental_mu} ensure that A, B and C form the compound $A_{m_1}B_{n_1}C_{p_1}$ instead of precipitating to pure element A, B and C.
Equation \eqref{eq:muAmBn} is simply the definition of the Gibbs formation energy of the compound and where we have neglected the entropic contribution and approximate $\mu_{A_{m_1}B_{n_1}C_{p_1}}$ by its formation enthalpy $\Delta H_f$. For solids, further approximation can be made by neglecting the 'PV' term, which is typically small for condensed phases, and replace formation enthalpy by the formation energy which can be computed, for example, from DFT. 
In practice, care must be taken to ensure that these formation energies are computed with the same level of theory and accuracy as those of  $E_{tot}[X^q]$ and $E_{tot}[bulk]$ in eq. \eqref{eq:FormationEnergy}, i.e, using the same exchange-correlation functionals, plane-wave cutoffs, k-point density, etc. 

For other compounds in the A-B-C system, for example  
$A_{m_2}B_{n_2}C_{p_2}$, we will also have:
\begin{equation} 
% \begin{align*}
    \label{eq:muApBq}
    m_2\mu_A+ n_2\mu_B+ p_2\mu_C  \leq \Delta H_f(A_{m_2}B_{n_2}C_{p_2})
% \end{align*}
\end{equation}

This inequality ensures that the formation of compound under consideration i.e. $A_{m_1}B_{n_1}C_{p_1}$ is favored over the formation of competing phase $A_{m_2}B_{n_2}C_{p_2}$. 
If other compounds exist in the A-B-C systems, we can generate other inequalities similar to \eqref{eq:muApBq} for each of those compounds. 
Together with eq. \eqref{eq:elemental_mu} and \eqref{eq:muApBq}, these equations and inequalities form a system of linear of constraints in $\mu_A$, $\mu_B$ and $\mu_C$ which can be solve to determine the stability region of region of $A_{m_1}B_{n_1}C_{p_1}$ from which the chemical potentials of A, B and C can be chosen for the calculation of defect formation energy in eq. \eqref{eq:FormationEnergy}. This example with ternary system can be generalized straightforwardly to any binary or multi-element compounds. 
As a concrete example, we will determine the stability region of Li\textsubscript{3}PO\textsubscript{4} from which the chemical potential of Li $\mu_{Li}$ which is needed in eq. \eqref{eq:FormationEnergy} can be used for the calculation of formation energy of Li-related defects such as lithium vacancies or interstitials. Applying eqs. \eqref{eq:elemental_mu} and \eqref{eq:muApBq} to Li\textsubscript{3}PO\textsubscript{4}, we obtain:

\begin{equation} \label{eq:mu_Li_P_O}
\mu_{Li} \leq 0; \quad \mu_P \leq 0 \quad \textrm{and} \quad \mu_O \leq 0
\end{equation}
\begin{equation} \label{eq:mu_Li3PO4}
    3\mu_{Li}+ \mu_P+ 4\mu_O = -22.164 \; eV/fu
\end{equation}
where $-22.164$ eV is the formation energy per formula unit (fu) (not to be confused with defect formation energy) of Li$_3$PO$_4$. Notice that thank to the eq. \eqref{eq:mu_Li3PO4}, only two of the three chemical potentials are independent. We can therefore choose one the elements for ex. Phosphorus as the "dependent" element whose chemical potential is fixed once the chemical potential of the "independent" elements are chosen.
In addition to Li\textsubscript{3}PO\textsubscript{4}, other stable phases in Li-P-O system consist of {LiPO$_3$, Li$_4$P$_2$O$_7$, P$_2$O$_5$, Li$_2$O, LiO$_8$, Li$_2$O$_2$, LiP, Li$_3$P, LiP$_7$ and Li$_3$P$_7$}. For each of these competing phases, we can write down a constraint similar to eq. \eqref{eq:muApBq} which will give respectively:
\begin{align} \label{eq:mu_other_phases}
    \mu_{Li}+ \mu_P+ 3\mu_O &\leq -13.614 \; eV/fu \\
    4\mu_{Li}+2\mu_P + 7\mu_O &\leq -35.901 \; eV/fu \\
    \dots \\
    3\mu_{Li}+ 7\mu_P \qquad  &\leq -3.605 \; eV/fu
\end{align}

\begin{figure}
\centering
\includegraphics[width=1.\linewidth]{images/stability_region_Li3PO4.png}
    \caption{Computed stability region of Li$_3$PO$_4$ shown in gray as well as the centroid of the stability region (shown as the central black dot) which used by default in the calculation of the defect formation energies.} 
    \label{fig:stability_region}
\end{figure}

By solving these constraints, the stability region of Li$_3$PO$_4$ can be determined and shown as the gray area in Figure \ref{fig:stability_region}. Any chemical potentials in this region can be used to compute the defect formation energy in eq. \eqref{eq:FormationEnergy} and by default, the chemical potentials corresponding to the centroid of the stability region (the gray dot) is chosen.
Notice that, so far, all the chemical potentials are \emph{relative} chemical potentials in the sense their values are referred to the reference state of each element for which the chemical potentials are set to zero. However, the chemical potentials as appear in eq. \eqref{eq:FormationEnergy} are \emph{absolute} chemical potentials which can be obtained from the relative chemical potentials by adding the energy of the corresponding element in its reference state. 
One complication that should be mentioned is the case where the compound under consideration is predicted to be unstable i.e. its formation energy is above convex hull. In this instance, the formation energy of that compounds is simply shifted downward until it reaches the convex hull and a warning message is issued.

\subsection{\label{subsec:section2.4}Self-consistent Fermi level}

\begin{figure}
% \centering
\includegraphics[width=1.\linewidth]{images/Picture1.pdf}
% \vspace{1cm}
    \caption{An algorithm to compute the Fermi level via a self-consistency cycle. Starting with an estimate of the Fermi level, the defect formation energy can be computed and, using this, a defect concentration can be estimated. By enforcing a charge neutrality condition, the concentration of electrons and holes can be computed, and from this the Fermi energy can be updated. The cycle is closed and new defect formation energies computed. This continues until the change in $E_F$ is sufficiently small and self-consistency is achieved.} 
    \label{fig:FermiLevel}
\end{figure}

At thermodynamic equilibrium, in the presence of multiple defects with possibly multiple charge states, the Fermi level $E_F$ can be determined self-consistently by imposing the charge neutrality condition \cite{BUCKERIDGEFERMI}. The algorithm to compute this self-consistent Fermi level is shown schematically in Figure \ref{fig:FermiLevel}. More precisely, if we denote $n_o$ the concentration of free electrons, $p_o$ the concentration of free holes and $C_{X^q}$ the concentration of defect $X$ in the charge state $q$, the charge neutrality condition requires that:
\begin{equation} \label{eq:ChargeNeutrality}
n_o - \sum_X\sum_q qC_{X^q} = p_o
\end{equation}
where:
\begin{equation} \label{eq:c_electron}
n_o=\int_{E_F}^{\infty}f_e(E)\rho(E)dE
\end{equation}
\begin{equation} \label{eq:c_hole}
p_o=\int_{-\infty}^{E_F}f_h(E)\rho(E)dE
\end{equation}
\begin{equation} \label{eq:c_defect}
C_{X^q}=N_{site}\exp{\left(-\frac{E^f[X^q]}{kT}\right)}
\end{equation}
and where $f_e$ is the Fermi-Dirac distribution, $f_e(E)=[1+\exp((E-E_F)/kT)]^{-1}$, $f_h=1-f_e$ and $\rho(E)$ the density of states per unit volume of the pristine host. Each term $n_o$, $p_o$ and $C_{X^q}$ depends on $E_F$ and therefore the condition \eqref{eq:ChargeNeutrality} constitutes a non-linear equation in $E_F$ which can be solved numerically to determine the value of Fermi level that corresponds to a neutral system. Notice that, by using the density of states $\rho(E)$ of the perfect bulk, we implicitly used the so-called rigid band approximation which essentially states that the presence of the defects doesn't affect the electronic bandstructure of the host but simply shifts its Fermi level.

Having this algorithm implemented also allows for the possibility to fix the defect concentrations at certain values and compute the corresponding Fermi level. This feature is useful in a situation where we would like to simulate the ‘quenching’ of the system from high temperature, in which the defect concentrations are not the equilibrium concentrations at room temperature, but are rather those that are quenched from high temperature. In this scenario, one first computes the self-consistent Fermi level, and the concentration of defects and free electrons and holes self-consistently at a higher temperature and then fix the concentration of defects but allow the Fermi level and the free electron/hole concentrations to adjusted at lower temperature. This is useful for example to assess the influence of cooling rate in high-temperature synthesis on the electronic conductivity of the materials at lower temperatures \cite{gorai_electronic_defect_2021, canepa_Mg_conductor_2017}.
Another situation in which this type of self-consistent calculation of the Fermi level can be used is to study the response of the system in terms of the change in the concentration of its native defects as a result of an \emph{effective} aliovalent doping where only the charge and the concentration of the dopants are relevant. In this approximation, the defect \ch{Li_{Mg}^x} or \ch{S_{Cl}^x} will produce exactly the same effects as a generic defect with a -1 charge at the same concentration.

\section{Package Implementation and Structure}
As previously introduced in Section \ref{Intro}, a key feature of the \aiida framework is the concept of workchains, representing a specific workflow, as a unit of computational work.
Like a computational script, they accept inputs, follow internal logic, and return outputs. However, unlike standard Python scripting, the inputs and outputs are captured and stored in the \aiida database, as are the relations between these data nodes. The procedure followed may involve additional calculations or quantum computations, and these operations can be thought of as the most basic units of computational work. Like the workchain, these also have defined inputs and outputs which are stored. More importantly, the relationships between these units and the workchain and each other are captured as part of the computational provenance. A step in a workchain may also invoke another workchain (a child workchain) and so workchains may be specialised to a specific modular task and then nested to create complex logic. The \aiida workflow engine is able to run the workchains, managing each task, concurrently where appropriate, and storing intermediate results so that even if the machine running \aiida is rebooted, the project can be resumed from the last successful step. 

To best leverage this sophisticated functionality, \aiidadefects has been implemented with this modularity in mind. 
Each of the main steps in computing a defect formation energy is computed  by its own workchain.
Where there is a choice of specific method for a given task, we have  implemented a parent workchain for the task which is 
generic, and a child workchain which implements a specific method. 
This design choice allows for any new method to be 'plugged in' by adding a workchain self-contained in a single file, and changing a
minimal amount of code in the parent workchain in order to make it available as an option. 
% The overall strucutre of the package is shown in Figure \ref{fig:schematic}.
The workflow at the heart of the package is the \emph{FormationEnergy} workchain.
This workchain computes the formation energy of a given defect from the components discussed in Section \ref{Intro}.
This relies on the \emph{Correction} workchain to be able to correct the spurious electrostatic interactions. 
This workchain is itself generic as a specific choice of correction scheme must be used. The default scheme is to use the Guassian CounterCharge method with the potential alignment functionality described in Section \ref{subsec:section2.1} and \ref{subsec:section2.2}, and so these too are implemented as child workchains. 
The chemical potential of the defect is required to compute the Formation energy, so this implemented as a separate workchain from the \emph{FormationEnergy} workchain, and its result is passed to the \emph{FormationEnergy} workchain.
The final component is the Fermi level. However, as discussed previously, this must be self-consistent across all defects of interest to be meaningful. 
To compute a self-consistent-Fermi level, we must have knowledge of all of the defects we want to study and be able to compute their formation energies, and so it follows that the \emph{FormationEnergy} workchain must be called repeatedly by the \emph{FermiLevel} workchain. 
To manage all of these interdependent workchains, we introduce a master workchain called the \emph{DefectChemistry} workchain. 
While in principle a user may interact with any workchain directly, it is intended that this top-most workchain be the main interface.
With this workchain, the full gamut of defect chemistry calculations will be carried out by \aiida-defects automatically.
The resulting provenance graph from such a run is shown in Figure \ref{fig:provenance} and serves to show just how much automation is achieved. Each node in the provenance graph represents a data or a function performing intermediate steps in the workflow while the edges between nodes indicate whether a data is an input to a function node or is produced as an output of that function. The nodes corresponding to different child workchains are grouped and highlighted in the corresponding boxes. The provenance graph can capture and explicitly display the inter-relations between data that required or produced at any steps of the workflow.
Moreover, consider the reproducibility - without automatic provenance capture, it would be near impossible to describe specifically what steps and calculations are behind the final data for all but the most simplistic cases. 
This shows the potential of \aiidadefects as versatile and powerful tool for the study of single defects, and how it can be used to study defects in a high-throughput manner.
In other publications in this domain, high-throughput generally refers to high-throughput of materials to achieve some computational screening for a desired property. 
Here we think of it as high-throughput with respect to specific defects and charge states, allowing us to rapidly and completely characterise a material's defect chemistry. 

\section{\label{UseCases}Use cases}
\subsection{Simple Defects}
To validate our implementation of the correction workchain, we have computed the defect formation energies of 4 different defects including $V_{Li}^{-1}$, $V_{Cl}^{+1}$ in the antiperovskite Li$_3$ClO, $V_{Mg}^{-2}$ in MgO and $V_{Al}^{-3}$ in AlP as a function of the supercell size as shown in Figure \ref{fig:Ef_defect}. As expected, the uncorrected formation energies show strong variation with the supercell size. However, upon correction, the formation energies become essentially independent of the supercell size and are all within 5\% of the their values in the dilute limit.  

\begin{figure}
% \centering
\includegraphics[width=1.\linewidth]{images/convergence_Ef.png}
% \vspace{1cm}
    \caption{Formation energies of (a) $V_{Li}^{-1}$ (b) $V_{Cl}^{+1}$ in the antiperovskite Li$_3$ClO (c) $V_{Mg}^{-2}$ in MgO and (d) $V_{Al}^{-3}$ in AlP as a function of the size of the supercell.
    \cj{CJ: I think this figure is a little cramped - it's an important result.} } 
    \label{fig:Ef_defect}
\end{figure}

\subsection{Applications}
To demonstrate the capabilities of AiiDA-Defect in a (semi)high-throughput environment, we choose to study the defect chemistry the Li-ion conductors LiZnPS\textsubscript{4} which has been computationally predicted to exhibit extremely high Li conductivity at room-temperature if the material can be synthesized with Li-excess \cite{suzuki_synthesis_2018, richards_design_2016}. From the defect point of view, one way to obtain a Li-rich composition is to have partial substitution of Zn sublattice by lithium (\ch{Li_{Zn}}) and the creation of lithium interstitial \ch{i_{Li}} to maintain charge neutrality. At thermodynamics equilibrium, whether these defects are operative or not will depend on their formation energy relative to that of other possible defects.
\aiidadefects simplifies immensely the undertaking of this kind of study.
These calculations can be conveniently carried out and the results can be easily retrieved and analyzed using the functionalities implemented in the package. 
% The highest level workflow, the \emph{Defect Chemistry} workchain, is depicted in Figure \ref{fig:provenance}.

\begin{figure*}
\centering
\includegraphics[width=1.\linewidth]{images/Provenance_graph_2.png}
% \vspace{1cm}
    \caption{A provenance graph of the \emph{Defect Chemistry} workchain as implemented in the \aiidadefects package. The groups of nodes belonging to different sub-workchains which compute each term in the definition of defect formation energy are shown in boxes with the corresponding name of the workchain.} 
    \label{fig:provenance}
\end{figure*}

\begin{table}[h]
\centering
\begin{tabular}{| l | c | l | c |}
\hline
\multicolumn{2}{|c|}{Native defects} & \multicolumn{2}{c|}{Extrinsic defects} \\
\hline
Defect types & Charge states & Defect types & Charge states \\
\hline
\ch{V_{Li}} & 0, -1 & \ch{Mg_{Li}} & 0, +1 \\
\ch{V_{Zn}} & 0, -2 & \ch{Mg_{Zn}} & 0 \\
\ch{V_{P}} & 0, -5 & \ch{Ca_{Li}} & 0, +1 \\
\ch{V_{S}} & 0, +2 & \ch{Ca_{Zn}} & 0 \\
\ch{Li_{i}} & 0, +1 & \ch{B_{Li}} & 0, +2\\
\ch{Zn_{i}} & 0, +2 & \ch{B_{Zn}} & 0, +1\\
\ch{Li_{Zn}} & 0, -1 & \ch{B_{P}} & 0, -2\\
\ch{Zn_{Li}} & 0, +1 & \ch{Al_{Li}} & 0, +2 \\
            &       & \ch{Al_{Zn}} & 0, +1 \\
            &       & \ch{Al_{P}} & 0, -2 \\  
            &       & \ch{Si_{P}} & 0, -1 \\ 
            &       & \ch{Sn_{P}} & 0, -1 \\  
\hline            
\end{tabular}
\caption{All native and extrinsic defects in their various charge states which were included in the calculation of defect chemistry of LiZnPS$_4$.}
\label{tab:defect_table}
\end{table}

In general, in order to obtain a complete picture of defect chemistry of a material at thermodynamic equilibrium, several defects in various charge states have to be considered. For this materials, all the intrinsic (native) and extrinsic defects which are included in this study are listed in Table \ref{tab:defect_table} along with their charge states. First, we need to determine the stability region of LiZnPS$_4$ from which the chemical potential of each constitutive element can be chosen for the calculation of defect formation energy. Because LiZnPS$_4$ is a quaternary compound, its stability region is a polyhedron and a section of the polyhedron at a fixed $\Delta \mu_{Li}$ is shown in Figure. 5a. Unlike in Figure \ref{fig:stability_region}, we also directly show the concentration of the defect that we want to optimize, namely \ch{i_{Li}} in the stability region, therefore allowing a quick assessment of chemical potentials and thus, the synthesis conditions under which the concentration of the desired defects can be maximized. The concentration of various defects at room-temperature in the intrinsic regime (at chemical potentials corresponding to the centroid of the stability region, see section \ref{subsec:section2.3}) is shown in Figure 5b. One can immediately see that the dominant native defect in LiZnPS$_4$ are lithium-zinc antisite defects which are charge-compensated by the creation of interstitials lithium, leading to a lithium-excess composition as one would desire. However, this excess excess is very small under this condition and may not lead to any observable effects in ionic conductivity. The variation of the defect concentrations as a function of temperature can be also be obtained as shown in Figure 5c. Finally, we can also assess the dopability of this materials by examining the concentration of various aliovalent dopants as shown in Figure 5d. The most favorable extrinsic defect is \ch{Mg_{Zn}} which is an isovalent defect and will not lead to appreciable change in the concentration of Lithium. \ch{Mg_{Li}} and \ch{Ca_{Li}} are thermodynamically favorable but will lead to Li antisite defects and reduce Li concentration. The most promising dopants are predicted to be \ch{Si_{P}} and \ch{Sn_{P}} which can lead to an increase of \ch{Li_{i}} via charge compensation but their concentration at equilibrium at room-temperature is predicted to be low which implies that one might need to 'quench' the defects from high temperature so that they can exist at appreciable concentration at room-temperature to produce any observable effects on Li-ion conductivity.
This demonstrates the robustness and user-friendliness of \aiidadefects to perform defect calculations in a high-throughput environment, and its utility to both academic and industrial users alike.


% \begin{figure*}
% \centering
% \includegraphics[width=1.\linewidth]{images/Workflow_schematic.png}
% % \vspace{1cm}
%     \caption{Schematic of the \emph{Defect Chemistry} workflow to compute defect formation energies to self-consistently determine the defect chemistry of a given material as implemented in the \aiidadefects package. The color code in the schematic corresponds to each term in the formula of defect formation energy. \cj{NOTE: Conrad will update this figure, or make a separate one to show the interaction of all the workchains and their boundaries in the final version of the code}.} 
%     \label{fig:schematic}
% \end{figure*}

% \begin{figure*}
%     \centering
%     \begin{subfigure}[b]{0.43\textwidth}
%         \centering
%         \includegraphics[width=\textwidth]{c_i_Li_300K.png}
%         % \caption[Network2]%
%         % {{\small Network 1}}    
%         \label{fig:c_i_Li}
%     \end{subfigure}
%     % \hfill
%     \begin{subfigure}[b]{0.55\textwidth}  
%         \centering 
%         \includegraphics[width=\textwidth]{Intrinsic_defect.png}
%         % \caption[]%
%         % {{\small Network 2}}    
%         \label{fig:c_intrinsic}
%     \end{subfigure}
%     \vskip\baselineskip
%     \begin{subfigure}[b]{0.90\textwidth}   
%         \centering 
%         \includegraphics[width=\textwidth]{defect_formation_energy.png}
%         % \caption[]%
%         % {{\small Network 3}}    
%         \label{fig:Ef_LiZnPS4}
%     \end{subfigure}
%     % \hfill
%     \begin{subfigure}[b]{0.75\textwidth}   
%         \centering 
%         \includegraphics[width=\textwidth]{Extrinsic_defect.png}
%         % \caption[]%
%         % {{\small Network 4}}    
%         \label{fig:c_dopant}
%     \end{subfigure}
%     % \caption[ The average and standard deviation of critical parameters ]
%     % {\small The average and standard deviation of critical parameters} 
%     \label{fig:defects_in_LZPS}
% \end{figure*}

\begin{figure*}
    \centering
    \includegraphics[width=1.\linewidth]{images/Defects_in_LiZnPS4_2.png}
    \caption{a) A section of stability region of LiZnPS$_4$ with the concentration of \ch{i_{Li}} directly plotted on top.
    b) Concentration of various native defects at 300K. c) Arrhenius plots of concentrations of native defects. d) Concentration of various extrinsic defects at 300K.}
    \label{fig:Examples}
\end{figure*}

\section{\label{Conclusions}Conclusions}
The accurate calculation of defect formation energies for charged systems can be challenging. We introduced the theory behind these calculations and highlighted the spurious interactions and sources of errors for these calculations when conducted within the limitations of density functional theory under periodic boundary conditions. A number of corrections and techniques have been proposed to address these technicalities, especially in the form of \emph{a posteriori} processing steps. As well an array of corrections, there is an even larger menagerie of different codes and packages applying these techniques to different parts of the problem. 
These packages are indeed valuable, but have limitations and tend to be applicable to a specific subset of use-cases or quantum codes, and may require some or even substantial manual computation and intervention.
We summarised \aiida - a computational framework providing a rich set of tools for automating computational workflows, distributing jobs to high performance computing resources, and for parsing and storing the results, and the associated provenance graph, in a high-performance queryable database. 
Here we presented and described \aiidadefects, a plugin to this framework which seeks to fully automate defect chemistry characterization and to enable this kind of research to be done in a high-throughput modality. In particular, our efforts have focused on identifying and solving the challenges to realizing these calculations as an automated workflow. In particular, the choice of charge model, the calculation of relative permittivity, the alignment of potentials, the calculation of chemical potential, the calculation and selection of an appropriate self-consistent Fermi level across a set of defects, and others. The interaction of all of these components is taken care of automatically within a set of nested workflows. This modularity also allows for easy extension to new approximations and corrections as they are developed. 
The required DFT calculations are prepared and run automatically as needed, and like the rest of the package, the interfaces to the DFT codes are also modular, allowing for codes beyond QuantumESPRESSO \cite{giannozzi_quantum_2009, giannozzi_advanced_2017} to be conveniently substituted via existing \aiida plugins.
We showed that the correction procedures can be applied automatically to correct the formation energy of charged defects for the cases of the typical test systems. We also showed potential of this package for a more elaborate application to the Li-ion conductors LiZnPS\textsubscript{4}, showing how a complete characterization of the defect chemistry could be obtained for a range of possible defects. 

\aiidadefects is powerful tool for the computational community that enables defect calculations to be performed in a robust, automated way, that is convenient and suitable for high-throughput computational studies. We hope it will be an impactful tool for new materials discovery, and a most welcome edition to the suite of community-produced packages in the \aiida ecosystem. 


\begin{acknowledgments}
\cj{CJ NOTE: Nicola - could you check that all funding is acknowledged correctly, please? I'm not sure if MaX was contributing.}
This work is supported by the MARVEL National Centre of Competence in Research (NCCR) funded by the Swiss National Science Foundation (grant agreement ID 51NF40-182892) and by the European Union’s Horizon 2020 research and innovation program under Grant Agreement No. 824143 (European MaX Centre of Excellence “Materials design at the Exascale”) and Grant Agreement No. 814487 (INTERSECT project). 
We thank Chiara Ricca and Ulrich Aschauer for discussions and prototype implementation ideas.
We thank Arsalan Akhtar Lorenzo Bastonero, Luca Bursi, Francesco Libbi, and Daniele Tomerini for useful discussions, feedback and testing. 
\end{acknowledgments}

% \clearpage
\bibliography{biblio}

\end{document}
