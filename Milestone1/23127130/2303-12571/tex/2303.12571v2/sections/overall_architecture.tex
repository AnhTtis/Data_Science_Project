\section{Overall architecture of the electronics}
\label{sec:overall}

The overall architecture of the NSW electronics is shown in Figure\,\ref{fig:LL_NSW_ElxOvr}.
There are five data and signal paths:
%?\vspace{-8pt}
\begin{itemize}[topsep=0pt, itemsep=0pt, parsep=0pt]  %?\itemsep-5pt
   \item Synchronization, trigger, test pulse and reset signals and the LHC bunch-crossing clock
%  \item Synchronization, trigger, test pulse and reset signals and the accelerator bunch-crossing clock\,\cite{TTC, Gallno:1999ws}
   \item Digitized readout data from the detector including monitoring and calibration data
   \item Configuration parameters and commands to the Front-ends and status indicators from the Front-ends
   \item Busy signal path
   \item Digitized data from the detector for the trigger path
\end{itemize}
%?\vspace{-9pt}
These five paths are elaborated below.

\subsection{The GBTx ASIC and FELIX}
%\label{sec:GBTxFELIX}
The use of the radiation-hard GBTx ASIC\,\cite{Moreira:2009pem, Wyllie:2012cua} to provide fibre connections between the collision cavern and the radiation-protected room, drastically impacts the architecture of the NSW electronics.
The first three paths are time-multiplexed together on fibres to and from a GBTx ASIC which interfaces to separate electrical ``E-links'' on twin-ax cables (also known as MiniSAS cables)\,\cite{8F36,twin-ax} to electronics boards on the detector.
These slow links carry Front-end readout, calibration and detector monitoring data from the Front-end, and configuration and control data to the Front-end.
They are aggregated to the 4.8\,Gb/s fibres by the GBTx ASICs on the Level-1 Data Driver Cards\,(L1DDC).
See Sections\,\ref{sec:GBTx} and\,\ref{sec:L1DDC}.
In the \MM trigger path, the GBTx is used as a point-to-point 4.8\,Gb/s link between the \gls{ADDC} and the Trigger Processor.
The data transported are not considered as E-links.
See Sections\,\ref{sec:GBTx} and\,\ref{sec:addc}.

\begin{figure}[ht]
\centering
\includegraphics[width=0.96\textwidth]{figures/LL_NSW_ElxOvr_v16}
\caption{Overview of the NSW electronics.
         There are electronics boards on the detector, on the rim of the wheel and in the radiation-protected room (USA15).
         The objects shown connected to the network, except FELIX, may be computers or processes.
         The \gls{Sector Logic}, \gls{FELIX} and \gls{swROD} are part of the ATLAS Trigger \& DAQ project.
         The quantities of each board and ASIC is given in Table\,\ref{tab:boardsASICs}.}
\label{fig:LL_NSW_ElxOvr}
\end{figure}


The fibres from the L1DDCs that carry the E-links connect to FELIX,
the Front End Link eXchange (FELIX)\,\cite{Panduro-Vasquez:2022oR, Levinson:2799865, Paramonov:2021jpz, PanduroVazquez:2020mnk, felixHW, Trovato:2019pui, FelixUserGuide}.
%developed by the ATLAS Trigger and DAQ project,
The use of FELIX also strongly impacts the architecture of the NSW Electronics.
FELIX routes E-links to and from endpoints on a standard Ethernet network.
It replaces the previous ATLAS front-end readout architecture.
FELIX is part of all but the trigger data paths.
FELIX separates data transport from data processing:
data are transported by FELIX, a detector-neutral custom hardware plus software device;
data are processed or sent by detector-specific software; for example, readout data is processed by the swROD\,\cite{9448326}.
FELIX is described in more detail in Section\,\ref{sec:felix}.
%FELIX interfaces 4.8\,Gb/s optical links from the L1DDC's that aggregate several slow serial copper ``E-links'' to an industry standard Ethernet network.
%These slow links carry Front-end readout, calibration and detector monitoring data from the Front-end, and configuration and control data to the Front-end.
%Acting similarly to a network switch, FELIX routes these slow links individually between Front-end electronics and the relevant software processes on the network.
%It also distributes the TTC (Timing, Trigger and Control) signals\,\cite{TTC, Gallno:1999ws}, including the LHC Bunch Crossing clock, to all the NSW electronics via dedicated E-links.
%%FELIX provides a common platform for some ATLAS Phase\,1 subsystems and will do so for all ATLAS Phase\,2 subsystems.
%See Section\,\ref{sec:felix}.

%FELIX consists of a custom PCIe FPGA card hosted in a commercial Linux server with a high-performance Ethernet interface card.
%The New Small Wheel uses the version of the FELIX FPGA card with 24~4.8\,Gb/s links in each direction in so-called GBT mode.
%Each From-detector optical link carries between 9 and 21 slow, copper twin-ax serial links; To-detector links carry between 7~and 18 serial links.

%? \red{Add here total count of fibres and FELIX FPGAs, servers.}\\
%? \red{Do we want a block diagram of FELIX?  FW and ?}

%\noindent
Following Figure\,\ref{fig:LL_NSW_ElxOvr}, the components and data flow for each of the five paths are summarized here, with details for all the components in Sections\,\ref{sec:asics}\,and\,\ref{sec:boards}.

\subsection{Synchronization, trigger, reset, test pulse signals and LHC clock path}
This path begins with the \gls{ALTI}\,\cite{ALTItwiki} Timing, Trigger \& Control (TTC) module,
which sends a serial stream containing the LHC Bunch Crossing (BC) clock and control signals via optical fan-outs and dedicated fibres to each FELIX FPGA.
The control signals can be sent synchronously to the BC clock with a defined offset in BC's from the beginning of the LHC orbit.
FELIX decodes the control signals, recovers and jitter-cleans the BC clock.
The control signals, Level-1 Trigger Accept (\gls{L1A}), Level-0 Trigger Accept (\gls{L0A}), Event Counter Reset (ECR), Bunch Crossing Counter Reset (BCR), Test-Pulse (TP), Soft-Reset (SR), Orbit Count Reset (OCR) and the BC clock
are sent to the Readout Controller (ROC), see Section\,\ref{sec:ROC}, on the Front-end boards, to the Rim boards and to the \MM trigger boards via the GBTx ASIC on the L1DDC boards.
The BC clock is recovered by the GBTx ASIC and is sent to all ASICs in the system.
The Trigger Processors receive the same signals via firmware\,\cite{GBT-FPGA, GBT_FPGA2} that emulates the GBTx.
The higher speed reference clocks of all serial links are multiples of the recovered BC clock.
The Readout Controller on each Front-end board forwards the needed control signals and bunch crossing clock, with configurable delays, to the various ASICs on the board.
This path has a fixed latency, reproducible across power cycles, from the Central Trigger Processor (\gls{CTP}) to ALTI to the Front-end ASICs.

\subsection{Digitized detector data path}
The digitized detector data path begins with the 64-channel \gls{VMM} Front-end ASIC, see \ref{sec:VMM}, which senses the detector readout electrodes.
Both Micromegas and sTGC strips as well as sTGC pad and wire signals are processed by digitizing their peak voltage after amplification and shaping.
The time of the peak or threshold crossing (configurable) relative to the BC clock edge is also digitized.
The digitized data is tagged by the VMM with the value, the ``BCID'', of a BC counter which remains attached to the data as it moves through the system.
The charge and time information are buffered in the VMM until the L0A (Level-0 Accept) trigger signal is received and sent to the ROC.
The data are  held in the buffer until they become older than the BC window of interest. The ROC buffers the data until the L1A (Level-1 Accept) trigger signal is received.\footnote{The L1A originates from the ATLAS Central Trigger. On receipt of L1A, FELIX sends out L0A; it then sends L1A after a configurable delay. This allows time for the transfer from VMM to ROC.}
The Read Out Controller aggregates up to eight VMMs and sends the data for those BCs selected by the L1A trigger to a GBTx ASIC on the L1DDC card via one or more copper twin-ax serial readout ``E-links''.
The GBTx aggregates several up to 320\,Mb/s readout E-links onto a 4.8\,Gb/s optical link.
FELIX then receives data from several optical links and routes the data from the readout E-links to the ``software Read Out Driver'' (swROD) which subscribes to and processes many readout E-links.
The swROD finally sends the Front-end data in an ATLAS standard format to the High Level Trigger (HLT).
The swROD provides a sampled data stream for monitoring user-defined parameters and data flow directly or by other separate monitoring processes.

In addition to the L1A event flow, calibration triggers can move Front-end data along the path,
either to a swROD for offline calibration or to a separate swROD that does not connect to the HLT, but instead acts as a dedicated calibration processor.
Additionally, the Trigger Processors send monitoring data for non-triggered bunch crossings to an instance of the swROD (without connection to HLT) that monitors the Trigger Processors.

\subsection{Configuration, command and status path}
The configurable operating parameters for all NSW electronics components are controlled via the SCA ASIC\,\cite{GBT-SCA} on every board,
or its emulator in FPGA firmware, SCAx\,\cite{SCAxIEEE} (as shown in Figure\,\ref{fig:LL_NSW_ElxOvr}).
An SCA server based on the \glslink{OPC UA}{OPC\,UA}\,\cite{OPC-UA} architecture is the software interface to the SCA and SCAx.
The communication is realized via FELIX and GBTx E-links.
Configuration and status reporting processes access the various SCA and SCAx configuration and status registers through several OPC\,UA clients.
Commands such as resets, are also sent on this path.
The same path is shared with the Detector Control System's (\gls{DCS}) OPC\,UA client for monitoring board and ASIC conditions, such as voltages and temperatures, that are sampled by the SCA.

\subsection{Busy path} Should a FELIX FPGA or server be near to overflowing its buffer space, it can assert a BUSY signal on a dedicated electrical line.
The ``OR'' of all such lines requests the Central Trigger to stop generating the Level-1 Accept triggers, thus preventing the Front-ends from (eventually) sending more data, thereby allowing FELIX to clear its buffers.
Busy can be asserted when FELIX suspends transmission of events in response to the swROD sending an XOFF via Ethernet.
The NSW Read Out Controller can send BUSY requests to FELIX, but this feature is not foreseen to be active during normal detector operation.
The Pad Triggers and Trigger Processors will assert BUSY should their buffers become full.

\subsection{Trigger data path}
\label{sec:trigpath}
The trigger paths contain hits from the VMM ``Time-over-Threshold' (ToT)' outputs for the sTGC pads, the VMM ``direct'' 6-bit charge data outputs for sTGC strips, and the VMM ``Address in Real Time' (ART)' output for the \MM.
The digitized data is tagged by the trigger data serializers (the ART and TDS ASICs) with the value, the ``BCID'', of a BC counter which remains attached to the data as it moves through the system.
All the trigger primitives are sent to the Trigger Processors, one per sector per detector type.
The sTGC and \MM Trigger Processors separately find track segments from hits in their respective detectors.
For sTGC, hits are the centroids of charges induced on strips.
For \MM, hits are the channel number of the first hit in the bunch crossing per Front-end VMM ASIC.
Hits are used to find track segments pointing to the Interaction Point.
On every bunch crossing, the sTGC Trigger Processor merges the sTGC and \MM segments and sends them to the Sector Logic.
The Trigger Processor is described in Section\,\ref{sec:trigproc}.

%The elements of the Trigger Path are configured via the same configuration path that configures the readout path.


\input{sections/sTGC_trig}
%\FloatBarrier


\input{sections/MMtrig}

