\begin{algorithm}
\caption{CIM-based CIL ($i$-th phase, $i\!\geq\!1$)} 
\label{algorithm: optimization flow}
\SetAlgoLined
\SetKwInput{KwData}{Input}
\SetKwInput{KwResult}{Output}
\KwData{New data $\mathcal{D}_i$; old compressed exemplars $\tilde{{\mathcal E}}_{0:i-1}$ ($\tilde{{\mathcal E}}_{0}=\varnothing$); last-phase CIL model $(\theta_{i-1},\omega_{i-1})$ and CIM model $\phi_{i-1}$ ($\theta_0$, $\omega_0$ are random parameters, $\phi_0$ is set to ReLU).}
\KwResult{New compressed exemplars $\tilde{{\mathcal E}}_i$; updated CIL model $(\theta_{i},\omega_{i})$ and CIM model $\phi_i$.}
Initialize $(\theta_{i},\omega_{i})$ with $(\theta_{i-1},\omega_{i-1})$\;
Initialize $\phi_i$ with $\phi_{i-1}$\;
\For{\textrm{epochs}}{
    Train $(\theta_{i},\omega_{i})$ using $\tilde{{\mathcal E}}_{0:i-1}\cup\mathcal{D}_i$ by Eq.~\ref{eq_cil_training}\;
    Compress $\mathcal{D}_i$ into $\tilde{\mathcal{D}}^{\phi}_i$ using $\phi_i$\; %by Eq.~\ref{eq_temporal_compression}\;
    Temporarily update $\theta_{i}$ to $\theta_{i}^+$ using $\tilde{{\mathcal E}}_{0:i-1}\cup\tilde{\mathcal{D}}^{\phi}_i$ by Eq.~\ref{eq_inner_level_update}\;
    Learn $\phi_i$ using $\mathcal{D}_i$ by Eq.~\ref{eq_outer_update_new}\;
}
Compress $\mathcal{D}_i$ into $\tilde{\mathcal{D}}_i$ using the learned $\phi_i$ by Eq.~\ref{eq_compressed_image}\;
Select exemplars $\tilde{\mathcal{E}}_i$ from $\tilde{\mathcal{D}}_i$ by, e.g., herding~\cite{rebuffi2017icarl}.
\end{algorithm}