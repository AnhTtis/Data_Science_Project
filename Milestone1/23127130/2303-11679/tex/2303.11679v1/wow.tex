% rubber: module pdftex
% rubber: module bibtex
% rubber: path /home/thirs/framagit/howe2
% rubber: path /home/thirs/framagit/latex-tools
% rubber: path /home/thirs/framagit/tex-common

% rubber: path /usr/share/texlive/texmf-dist/bibtex/bst/urlbst/

\documentclass[a4paper,UKenglish,cleveref, autoref, thm-restate]{lipics-v2021}
% This is a template for producing LIPIcs articles. 
% See lipics-v2021-authors-guidelines.pdf for further information.
% for A4 paper format use option "a4paper", for US-letter use option "letterpaper"
% for british hyphenation rules use option "UKenglish", for american hyphenation rules use option "USenglish"
% for section-numbered lemmas etc., use "numberwithinsect"
% for enabling cleveref support, use "cleveref"
% for enabling autoref support, use "autoref"
% for anonymousing the authors (e.g. for double-blind review), add "anonymous"
% for enabling thm-restate support, use "thm-restate"
% for enabling a two-column layout for the author/affilation part (only applicable for > 6 authors), use "authorcolumns"
% for producing a PDF according the PDF/A standard, add "pdfa"

\pdfoutput=1 %uncomment to ensure pdflatex processing (mandatatory e.g. to submit to arXiv)
\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository
\nolinenumbers

% \graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\input{preamble-tmp.tex}
% \nolinenumbers
\newcommand{\citet}[2][]{\ifx&#1&\cite{#2}\else\cite[#1]{#2}\fi}
\newcommand{\augmented}{enhanced\xspace}
\newcommand{\Augmented}{Enhanced\xspace}
\newcommand{\augmentedness}{enhancedness\xspace}
\newcommand{\Augmentedness}{Enhancedness\xspace}
\newcommand{\anaugmented}{an enhanced\xspace}

\newtheorem{notation}{Notation}

\crefname{enumi}{}{}
\Crefname{enumi}{}{}
\creflabelformat{enumi}{#2(#1)#3}

\crefformat{section}{\S#2#1#3} % see manual of cleveref, section 8.2.1
\crefformat{subsection}{\S#2#1#3}
\crefformat{subsubsection}{\S#2#1#3}
\crefformat{equation}{#2(#1)#3} % see manual of cleveref, section 8.2.1
\crefformat{appendix}{\S#2#1#3}

% \crefname{section}{Â§}{Â§}
% \Crefname{section}{Section}{Sections}

\bibliographystyle{plainurl}% the mandatory bibstyle

\title{A more general categorical framework for congruence of
  applicative bisimilarity} %TODO Please add

% \titlerunning{A more general categorical framework for congruence of
%   applicative bisimilarity} %TODO optional, please use if title is longer than one line

\author{Tom Hirschowitz}{Univ. Savoie Mont Blanc, CNRS, LAMA, \\
  73000, ChambÃ©ry, France}{}{https://orcid.org/0000-0002-7220-4067}{}
% TODO mandatory, please use full name; only 1 author per \author macro; first two parameters are mandatory, other parameters can be empty. Please provide at least the name of the affiliation and the country. The full address is optional. Use additional curly braces to indicate the correct name splitting when the last name consists of multiple name parts.

\author{Ambroise Lafont}{University of Cambridge, United Kingdom}{}{https://orcid.org/0000-0002-9299-641X}{}

\authorrunning{T. Hirschowitz and A. Lafont} %TODO mandatory. First: Use abbreviated first/middle names. Second (only in severe cases): Use first author plus 'et al.'

\Copyright{Tom Hirschowitz and Ambroise Lafont} %TODO mandatory, please use full first names. LIPIcs license is "CC-BY";  http://creativecommons.org/licenses/by/3.0/

% \ccsdesc[100]{\textcolor{red}{Replace ccsdesc macro with valid one}} %TODO mandatory: Please choose ACM 2012 classifications from https://dl.acm.org/ccs/ccs_flat.cfm 

% \keywords{Dummy keyword} %TODO mandatory; please add comma-separated list of keywords
\keywords{applicative bisimilarity, higher-order languages, congruence, category theory}

% \category{} %optional, e.g. invited paper

% \relatedversion{} %optional, e.g. full version hosted on arXiv, HAL, or other respository/website
% % \relatedversiondetails[linktext={opt. text shown instead of the URL}, cite=DBLP:books/mk/GrayR93]{Classification (e.g. Full Version, Extended Version, Previous Version}{URL to related version} %linktext and cite are optional

% \supplement{}%optional, e.g. related research data, source code, ... hosted on a repository like zenodo, figshare, GitHub, ...
% \supplementdetails[linktext={opt. text shown instead of the URL}, cite=DBLP:books/mk/GrayR93, subcategory={Description, Subcategory}, swhid={Software Heritage Identifier}]{General Classification (e.g. Software, Dataset, Model, ...)}{URL to related version} %linktext, cite, and subcategory are optional

% \funding{(Optional) general funding statement \dots}%optional, to capture a funding statement, which applies to all authors. Please enter author specific funding statements as fifth argument of the \author macro.

% \acknowledgements{I want to thank \dots}%optional

% \nolinenumbers %uncomment to disable line numbering



% Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access}
\EventNoEds{2}
\EventLongTitle{FSCD 2023}
\EventShortTitle{FSCD 2023}
\EventAcronym{FSCD}
\EventYear{2023}
\EventDate{July 2023}
\EventLocation{Rome, Italy}
\EventLogo{}
\SeriesVolume{42}
\ArticleNo{23}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\begin{document}

\maketitle

% TODO mandatory: add short abstract of the document
\begin{abstract}
  We prove a general congruence result for bisimilarity in
  higher-order languages, which generalises previous
  work~\cite{BHL,HL} to languages specified by a labelled transition
  system in which programs may occur as labels, and which may rely on
  operations on terms other than capture-avoiding substitution. This
  is typically the case for PCF, $Î»$-calculus with delimited
  continuations, and early-style bisimilarity in higher-order
  process calculi.
\end{abstract}

\section{Introduction}\label{s:intro}
General congruence results for bisimilarity based on category theory
date back at least to Turi and Plotkin's seminal
paper~\cite{plotkin:turi:bialgebraic}, which covers labelled
transition systems in a categorical version of the Positive GSOS
format~\cite{GSOS}.  The result was then extended to languages with
variable binding and renaming like the
$Ï€$-calculus~\cite{DBLP:conf/lics/FioreT01,DBLP:conf/lics/Staton08}.
More recently, Borthelle et al.~\cite{BHL,HL} managed to deal with a
 wider class of languages, whose operational semantics may rely
not only on renaming, but also on capture-avoiding substitution.

However, their result fails to cover significant languages to which
Howe's method has been adapted, such as (variants of)
PCF~\cite{DBLP:journals/tcs/Gordon99}, $Î»$-calculus with delimited
continuations~\cite{DBLP:conf/lfp/DanvyF90,DBLP:conf/fossacs/BiernackiL12},
or (early-style) higher-order process
calculi~\cite{DBLP:books/daglib/0004377,DBLP:conf/concur/LengletS15}.
The reason Borthelle et al.'s framework does not cover such
applications is that they are specified by  labelled transition
systems
\begin{itemize}
\item in which programs may occur as labels, or
\item which rely on operations on terms other than capture-avoiding
  substitution.
\end{itemize}

In this paper, we extend Borthelle et al.'s result to such languages,
which requires a non-trivial extension of the proof method,
essentially abstracting over ideas from
Bernstein~\cite{DBLP:conf/lics/Bernstein98}.

We introduce \alert{algebraic transition systems}, which model
transition systems whose vertices (=states) bear some algebraic
structure, and which may have arbitrary vertices as labels.  For such
transition systems, we define \alert{\enhanced bisimilarity} as an
abstract counterpart to applicative bisimilarity

We introduce \alert{operational signatures}, which allow us to
generate algebraic transition systems of interest, including all
above-mentioned languages. Following initial-algebra
semantics~\cite{goguen1974initial}, an operational signature specifies
algebraic structure and transition rules, and, in applications, the
initial object in the category of models of an operational signature
is the desired syntactic transition system.

Finally, we prove (Theorem~\ref{thm:main}) that, under suitable
conditions, \enhanced bisimilarity in the algebraic transition system
generated by an operational signature is a congruence for the
considered algebraic structure.  We also exhibit
(Theorem~\ref{thm:cellular}) sufficient conditions that are easier to
check in practice.  This covers all above-mentioned applications,
except higher-order process calculi, whose operational signatures fail
to satisfy the required conditions.


\subsection*{Related work}
Beyond Borthelle et al.~\cite{HL}, which was discussed above, the most
closely related work is Goncharov et al.'s~\cite{10.1145/3571215}
bialgebraic framework for higher-order operational semantics. They
upgrade Turi and Plotkin's~\cite{plotkin:turi:bialgebraic} original
presentation of operational semantics as a natural transformation into
a dinatural transformation, which allows them to cover transitions
with programs as labels.  Their main applications are strong variants
of applicative bisimilarity for pure $Î»$-calculus (call-by-name and
call-by-value). In its current state, their framework cannot handle
non-deterministic computation, hence in particular weak variants of
bisimilarity.


\subsection*{Plan}
We start in~\cref{ssoverview} with an overview of the development.
In~\cref{serguei}, we then present our running example, which will be
used as the basis of our abstraction process.  We then introduce our
abstract notions of transition systems (\cref{ltss}), and algebraic
transition systems (\cref{atss}), together with bisimilarity and its
\enhanced variant.  Finally, we introduce operational signatures and
state our main results in~\cref{s:howecontexts}, and conclude
in~\cref{sconclu}.

\subsection*{Prerequisites and notations}
We assume some basic knowledge of category theory~\cite{MacLane:cwm},
notably including factorisation systems and monad distributive
laws~\cite{BeckDistlaws}.  Additionally, we rely in places on locally
presentable categories~\cite{Adamek}, but this may be taken as
technical, and ignored on a first reading.  We often conflate natural
numbers $n$ with sets $\{1,â€¦,n\}$.  We denote by $\mathbb{n}$ the
corresponding ordinal viewed as a category, so that, e.g., $ğ’^ğŸš$ is
the usual category of morphisms in $ğ’$.  We let $ğ‚ğ€ğ“$ denote the
category of locally small categories. Moreover, we denote by $\psh$
the category of (contravariant) presheaves over a given category $â„‚$,
and by $ğ²âˆ¶ â„‚ â†’ \psh$ the Yoneda embedding.  Furthermore, we recall
that endofunctor algebras differ from monad algebras.  (A monad
algebra structure must be suitably compatible with unit and
multiplication.)  We write $F\alg$ for endofunctor algebras, and
$T\Alg$ for monad algebras (capital `A'!).  Finally, for any
endofunctor $F$ on a sufficiently nice category, e.g., a presheaf
category, we write $F^*$ for the free monad on $F$, which is
furthermore \alert{algebraically free} in the sense that
$F\alg â‰… F^*\Alg$.


\section{Overview}\label{ssoverview}
The development roughly follows~\cite{HL}. We summarise it here,
emphasising the differences.  Our running example throughout is a pure
$Î»$-calculus with delimited
continuations~\cite{DBLP:conf/fossacs/BiernackiL12}.


\subsection{Transition systems}
Let us first sketch our notion of transition system, starting from
graphs.  Consider the diagonal functor $Î”âˆ¶ ğ’ğğ­ â†’ ğ’ğğ­$, defined by
$Î”(X) = XÂ²$.  A graph consists of two sets $E$ and $V$, equipped with
two maps $E â†’ V$, or equivalently a map $E â†’ Î”(V)$.

Hirschowitz and Lafont~\cite{HL} propose a ``typed'' generalisation:
they postulate a category $ğ•ğ•‹$ of \alert{vertex types}, a category
$ğ”¼ğ•‹$ of \alert{edge types}, and two functors $ğ¬,ğ­âˆ¶ ğ”¼ğ•‹ â†’ ğ•ğ•‹$
associating to each edge type the types of its source and target.  A
transition system in their sense consists of a \alert{vertex object}
$V$ in $\psh[ğ•ğ•‹]$, a \alert{edge object} $E âˆˆ \psh[ğ”¼ğ•‹]$, and a
morphism $E â†’ Î”(V)$, where $Î”âˆ¶ \psh[ğ•ğ•‹] â†’ \psh[ğ”¼ğ•‹]$ maps any $V$ to
$Î”(V)(Î±) = V(ğ¬(Î±)) Ã— V(ğ­(Î±))$, for all $Î± âˆˆ ğ”¼ğ•‹$.
Taking $ğ•ğ•‹ = ğ”¼ğ•‹ = 1$, one recovers plain graphs.

In this paper, in order to account for labels, we generalise this by
adding a functor $ğ¥$ associating to each edge type $Î± âˆˆ ğ”¼ğ•‹$ a sequence
$ğ¥(Î±) = (ğ¥^Î±â‚,â€¦,ğ¥^Î±_{n_Î±})$ of vertex types.  A tuple $(ğ•ğ•‹,ğ”¼ğ•‹,ğ¬,ğ­,ğ¥)$
is called a \alert{Howe context}.  Let us fix one for the rest of this
section.

We modify $Î”$ accordingly, defining it by
$$Î”(V)(Î±) \qquad = \qquad V(ğ¬(Î±)) \quad Ã— \quad \left ( âˆ_{i=1}^{n_Î±} V(ğ¥^Î±áµ¢) \right ) \quad Ã— \quad V(ğ­(Î±)).$$
A transition system again consists of objects $V âˆˆ \psh[ğ•ğ•‹]$ and
$E âˆˆ \psh[ğ”¼ğ•‹]$, together with a morphism $E â†’ Î”(V)$, which means that,
to each edge, we associate a source, a target, and a sequence of
labels of suitable types.  For such transition systems, we define a
generalisation of bisimulation, straightforwardly.

\subsection{Algebraic transition systems and \enhanced bisimilarity}\label{ssalts}
Let us now briefly explain the notion of algebraic structure that we
adopt. Following Fiore et
al.~\cite{fiore:presheaf,DBLP:conf/lics/Fiore08}, Borthelle et
al.~\cite{BHL,HL} use $Î£$-monoids, which are designed to model syntax
with substitution.  In this paper, relying on Hirschowitz and
Lafont~\cite{admissible}, we adopt a different notion of algebraic
structure designed to cover syntax with more general additional operations.
\begin{definition}\label{def:enhanced:syntax}
  An \alert{\enhanced syntax} (on $\psh[ğ•ğ•‹]$) consists of
\begin{itemize}
\item finitary functors $Î£âˆ¶ \psh[ğ•ğ•‹] â†’ \psh[ğ•ğ•‹]$ and
  $Î“âˆ¶ \psh[ğ•ğ•‹]Â² â†’ \psh[ğ•ğ•‹]$ such that $Î“$ is
  \alert{left-cocontinuous}, i.e., cocontinuous in its first argument,
  equipped with
\item  a distributive
  law $Î´âˆ¶ T âˆ˜ S â†’ S âˆ˜ T$, where $S = Î£^*$ denotes the monad freely
  generated by $Î£$ and $T = Î“_S^*$ the one generated by $X â†¦ Î“(X,S(X))$.
\end{itemize}
\end{definition}
Here, $Î£$ models basic syntax, and $Î“$ models additional operations
like substitution. The fact that $Î“$ is a bifunctor is for
distinguishing a ``main'' occurrence in its arity, which is used below
in the definition of \enhanced bisimilarity.  The distributive law
models commutation of additional operations with basic ones, at the
main occurrence (typically $(M\ N)[Ïƒ] = M[Ïƒ]\ N[Ïƒ]$).

Following initial-algebra semantics~\cite{goguen1974initial}, the main
object of interest here is the initial $Î£$-algebra $S(âˆ…)$, and the
main point is that it automatically possesses $T$-algebra structure,
given by the composite $T (S (âˆ…)) \xto{Î´_âˆ…} S (T (âˆ…)) â‰… S (âˆ…)$ (the
initial object is a $T$-algebra by cocontinuity, hence $T(âˆ…) â‰…
âˆ…$). This algebra structure in fact makes $S(âˆ…)$ into an initial
algebra for the composite monad $ST$.

Fixing some \enhanced syntax $Ïƒ = (Î£,Î“,Î´)$, for us, an algebraic
transition system is thus a transition system $E â†’ Î”(V)$, equipped
with $ST$-algebra structure on $V$.  We call such transition systems
\alert{$Ïƒ$-algebraic}.

Finally, for any $Ïƒ$-algebraic transition system $G = (E,V,âˆ‚)$, we
define \alert{\enhanced bisimilarity}, denoted by $âˆ¼^Ïƒ_G$, as the
greatest bisimulation $R$ which is \alert{\enhanced}, in the sense
that $Î“(R,V) âŠ† R$ -- this is where we use the fact that $Î“$ is a
bifunctor. In concrete instances, as noticed by Borthelle et
al.~\cite{BHL,HL}, \enhanced bisimilarity agrees with applicative
bisimilarity.

The goal is then to prove that, in algebraic transition systems $G$ of
interest, \enhanced bisimilarity $âˆ¼^Ïƒ_G$ is a \alert{congruence},
i.e., $Î£(âˆ¼^Ïƒ_G) âŠ† {âˆ¼^Ïƒ_G}$.

\subsection{Operational signatures}
For this, we restrict attention to algebraic transition systems
generated by a suitable notion of \alert{operational signature}, which
we now describe.  Operational signatures comprise two components, one
for generating \anenhanced syntax, the other for specifying transition
rules.

\begin{definition}\label{def:syntacticsig}
  A \alert{syntactic signature} is an endofunctor $Î£$
  equipped with a sequence
  \begin{equation}
    \hfil Tâ‚€ = \id \xto{(Î“â‚,dâ‚)} Tâ‚ \quad â€¦ \quad T_{n-1} \xto{(Î“â‚™,dâ‚™)} Tâ‚™\label{eq:syntacticsig}
  \end{equation}
  of \alert{incremental structural laws}~\cite{admissible}.  An
  incremental structural law $T â†’ T'$ consists of a finitary,
  left-cocontinuous bifunctor $Î“âˆ¶ \psh[ğ•ğ•‹]Â² â†’ \psh[ğ•ğ•‹]$, together with
  a natural transformation
  $d_{X,Y}âˆ¶ Î“ (Î£ (X),Y) â†’ S (T (Î“ (X,S (T (Y))) + X + Y))$, such that
  $T' = T âŠ• Î“_S^*$, where $âŠ•$ denotes monad coproduct.
\end{definition}
In examples, a natural transformation $d_{X,Y}$ amounts to a
definition by structural recursion, where the first argument of $Î“$
models the decreasing occurrence of the argument, and the second
argument models other occurrences.  Given any syntactic
signature~\cref{eq:syntacticsig}, the given incremental structural
laws induce distributive laws $Î´áµ¢âˆ¶ Táµ¢ âˆ˜ S â†’ S âˆ˜ Táµ¢$, hence in
particular $Î´â‚™âˆ¶ Tâ‚™ âˆ˜ S â†’ S âˆ˜ Tâ‚™$, and furthermore we have
$Tâ‚™ = (âˆ‘áµ¢ Î“áµ¢)_S^*$. Thus, letting $ğ$ denote the given syntactic
signature, the triple $Ïƒ(ğ) = (Î£,âˆ‘áµ¢ Î“áµ¢,Î´â‚™)$ forms \anenhanced syntax.
As a bonus, one can show that algebras for the composite monad $S Tâ‚™$
are equivalently objects equipped with suitably coherent algebra
structure for $Î£$ and each functor $X â†¦ Î“áµ¢(X,X)$.

The next step is to specify the dynamics of algebraic transition
systems of interest. This is done by introducing \alert{dynamic
  signatures}. Roughly, a dynamic signature over \anenhanced syntax
$Ïƒ$ is an endofunctor on $Ïƒ$-algebraic transition systems, which is
required to preserve the vertex object and satisfy a suitable
``structuralness'' condition inspired by structural operational
semantics~\cite{PlotkinSOS}. Intuitively, a dynamic signature $Î£â‚$ is
a family of transition rules, and structuralness demands that, in each
transition rule, the source of the conclusion has depth at most one.

Pursuing the analogy, $Ïƒ$-algebraic transition systems satisfying the
rules are a special kind of $Î£â‚$-algebras which we call
\alert{vertical}. Verticality means that the algebra structure is
trivial on vertices: this enforces that satisfying the rules is only
about edges, not vertices. 

Finally, an \alert{operational signature} consists of a syntactic
signature $ğ$, and a dynamic signature $Î£â‚$ on $Ïƒ(ğ)$.  The real
object of interest is here the initial vertical $Î£â‚$-algebra, say
$ğ™ = (E_ğ™,V_ğ™,âˆ‚_ğ™)$, which in applications is the desired syntactic
transition system.

\subsection{Congruence of \enhanced bisimilarity}
Our goal is then to prove that, under suitable hypotheses, \enhanced
bisimilarity $âˆ¼^{Ïƒ(ğ)}_ğ™$ in the initial vertical $Î£â‚$-algebra is a
congruence.  For this, abstracting over
Bernstein's~\cite{DBLP:conf/lics/Bernstein98} proof, we start by
defining \alert{flexible bisimulation}, a variant of Sangiorgi's
BA-bisimulation~\cite{DBLP:conf/fsen/SangiorgiKS07}.  Flexible
bisimulation is like plain bisimulation: given related elements $e$
and $e'$, any transition from $e$ should be matched by some transition
from $e'$. The difference is that, instead of having the same label,
the matching transition should exist for any related label.  Defining
\alert{functional flexible bisimulations} to be morphisms of algebraic
transition systems whose graph is a flexible bisimulation, our main
result (Theorem~\ref{thm:main}) states that if the dynamic
signature $Î£â‚$ preserves functional flexible bisimulations, then
$âˆ¼^{Ïƒ(ğ)}_ğ™$ is a congruence.

Finally, preservation of functional flexible bisimulations is quite an
abstract condition, so we set out to design a more concrete criterion
for making the result easier to apply.  In fact, if the considered
dynamic signature $Î£â‚$ is
\alert{familial}~\cite{Diers1978Spectres,DBLP:journals/mscs/CarboniJ95,WeberPhD,garner:hal-01246365},
then preservation of functional flexible bisimulations becomes quite
tractable, as we now explain.  Following Joyal et
al.~\cite{DBLP:conf/lics/JoyalNW93}, we first characterise functional
flexible bisimulations as the right class of a weak factorisation
system~\cite{Hovey,riehl} -- we call the left class
\alert{cofibrations}.  Furthermore, when the dynamic signature is
familial, a transition rule with conclusion of type any $Î±$, is
intutively an element of $Î£â‚(1)(Î±)$, and we extract for each rule two
algebraic transition systems $A$ and $B$, and a morphism $Ï•âˆ¶ A â†’ B$,
such that, intuitively, $A$ describes the metavariables occurring in
the source and label of the conclusion, $B$ describes all
metavariables in the rule, including transition premises, and $Ï•$
embeds the former into the latter. We call $Ï•$ the \alert{border
  arity} of the rule.  The main point is then that a familial $Î£â‚$
preserves functional flexible bisimulations iff all border arities are
cofibrations (\cref{thm:cellular}).  How is this any more concrete?
Well, cofibrations are well-known to be closed under composition and
cobase change, so in order to check preservation of functional
flexible bisimulations, it suffices to reconstruct the border arity of
each rule from generating cofibrations, by composition and cobase
change.  This reconstruction process is close in spirit to usual
acyclicity
criteria~\cite{DBLP:journals/iandc/Howe96,DBLP:conf/lics/Bernstein98}.
\begin{example}\label{ex:graphborderarity}
  Taking algebraic transition systems to be just plain graphs, for a
  rule like $\inferrule{a â†’ b \\ b â†’ c}{a â†’ c}$, $A$ would be the
  one-vertex graph, $B$ would consist of two composable edges
  $x â†’ y â†’ z$, and $Ï•$ would pick $x$.  To check that it is a
  cofibration, we reconstruct it as the bottom composite in
\qquad    \Diag|baseline=(m-1-2.base)|{%
      \pbk{m-2-2}{m-2-3}{m-1-3} %
    }{%
      \& {[0]} \& {[1]} \\
      {\llap{$A = {}$} [0]} \& {[1]} \& B.
    }{%
      (m-1-2) edge[labela={s}] (m-1-3) %
      edge[labell={}] (m-2-2) %
      (m-2-2) edge[labela={}] (m-2-3) %
      (m-1-3) edge[labelr={}] (m-2-3) %
      (m-2-1) edge[labela={s}] (m-2-2) %
    }
\end{example}
As an application, we recover congruence of applicative bisimilarity in
the considered $Î»$-calculus with delimited
continuations~\cite{DBLP:conf/fossacs/BiernackiL12}.



\section{A concrete example}\label{serguei}
As a concrete example result that we want to abstract over, let us
recall the case of $Î»$-calculus with delimited continuations.  We
present it in a non-standard way in order for it to fit the abstract
framework.  Indeed, the framework is based on \alert{structural}
operational semantics~\cite{PlotkinSOS}, in the sense that, in each
transition rule, the source of the conclusion has depth at most
one. Following~\cite{BHL,HL}, we also present the definition of the
open extension of applicative bisimilarity to make it compatible with
the abstract developments to come.

The syntax, presented in the usual, informal way, is as below left,
\begin{align}
  \mbox{Values} âˆ‹ v & ::=  x  ï½œ  Î»x.e                         &          â–«[e] & = e  \label{eq:wbox} \\
  \mbox{Programs} âˆ‹ e & ::=  v  ï½œ  eâ‚\ eâ‚‚  ï½œ  ğ’®x.e  ï½œ  âŸ¨eâŸ©  &     (v\ E)[e] & =  v\ E[e] \label{eq:appv} \\
  \mbox{Evaluation contexts} âˆ‹ E & ::=  â–«  ï½œ E\ e  ï½œ  v\ E          &      (E\ e')[e] & =  E[e]\ e'. \label{eq:appe}
\end{align}
where $x$ binds in $e$, in both $Î»x.e$ and $ğ’®x.e$.
Capture-avoiding substitution and context application are defined as
usual. E.g., context application is defined as above right.  The
dynamics are governed by the rules in~\cref{fig:trans:shiftreset}.
\begin{figure}[htp]
\begin{mathpar}
  \inferrule{eâ‚ \xto{v} eâ‚‚}{eâ‚\ v \xto{Ï„} eâ‚‚}~(Î²') \and %
  \inferrule{ }{Î»x.e \xto{v} e[xâ†¦v]} \and
  \inferrule{eâ‚ \xto{Ï„} e'â‚}{eâ‚\ eâ‚‚ \xto{Ï„} e'â‚\ eâ‚‚}
  \and
  \inferrule{eâ‚‚ \xto{Ï„} e'â‚‚}{v\ eâ‚‚ \xto{Ï„} v\ e'â‚‚} \and %
  \inferrule{ }{âŸ¨vâŸ© \xto{Ï„} v} \and
  \inferrule{e \xto{Ï„} e'}{âŸ¨eâŸ© \xto{Ï„} âŸ¨e'âŸ©} \and
  \inferrule{e \xto{â–«} e'}{âŸ¨eâŸ© \xto{Ï„} e'} \and
  \inferrule{eâ‚ \xto{E[â–«\ eâ‚‚]} eâ‚ƒ}{eâ‚\ eâ‚‚ \xto{E} eâ‚ƒ} \and
  \inferrule[(SA)]{eâ‚ \xto{E[v\ â–«]} eâ‚‚}{v\ eâ‚ \xto{E} eâ‚‚} \and
  \inferrule{ }{ğ’®k.e \xto{E} âŸ¨e [ k â†¦ Î»x.âŸ¨E[x]âŸ© ]âŸ©} \and
  \inferrule{ }{e \xto{Ï„} e} \and
  \inferrule{eâ‚ \xto{Ï„} eâ‚‚ \xto{Î±} eâ‚ƒ}{eâ‚ \xto{Î±} eâ‚ƒ} \and
  \inferrule{eâ‚ \xto{Î±} eâ‚‚ \xto{Ï„} eâ‚ƒ}{eâ‚ \xto{Î±} eâ‚ƒ} \and %
  \mbox{Deriving $Î²$:}\quad \inferrule{
    \inferrule*{
    }{Î»x.e \xto{v} e[xâ†¦v]         }
  }{(Î»x.e)\ v \xto{Ï„} e[xâ†¦v]}~(Î²')   
\end{mathpar}     
\caption{Transition rules}
\label{fig:trans:shiftreset}
\end{figure}
There are three kinds of transitions, of types $e \xto{Ï„} e'$,
$e \xto{v} e'$, $e \xto{E} e'$, where all expressions are closed.  The
first four rules deal with functions. The first two rules suffice to
make (Î²) derivable, as shown in~\cref{fig:trans:shiftreset}. The next
two rules are the usual context rules.  The last three rules, where
$Î±$ ranges over all labels, enforce that we work with weak
bisimulation: we close transitions under composition with silent
transitions.  The remaining rules describe the dynamics of $ğ’®x.e$ and
$âŸ¨eâŸ©$, which are respectively called \alert{shift} and \alert{reset}.
The first two of them enforce that silent computation occurs normally
inside any reset, and if it succeeds, i.e., if it results in a value,
then the reset disappears.  The next rules describe how shift captures
the ambient context up to the enclosing reset, say $E$, and
substitutes its reification $Î»k.âŸ¨E[k]âŸ©$ as a value for the bound
variable, placing a new reset around the result.

Bisimulation is then as expected:
\begin{definition}
  A binary relation $R$ between closed programs is a
  \alert{simulation} iff for all $e \mathrel{R} e'$ and transitions
  $e \xto{Î±} eâ‚$, there exists a transition $e' \xto{Î±} e'â‚$ such
  that $eâ‚ \mathrel{R} e'â‚$.  A \alert{bisimulation} is a
  simulation whose converse relation also is a simulation.
\end{definition}
\begin{definition}[{\cite{BHL,HL}}]
  A relation $R$ on potentially open expressions is \alert{\enhanced}
  iff it is closed under substitution, context composition, and
  context application, i.e., $a \mathrel{R} a'$ entails
  $a[Ïƒ] \mathrel{R} a'[Ïƒ]$ for all substitutions $Ïƒ$,
  $E \mathrel{R} E'$ entails $E[e] \mathrel{R} E'[e]$ and
  $E[E''] \mathrel{R} E'[E'']$, for all $e$ and $E''$.

  An \alert{\enhanced bisimulation} is \anenhanced relation $R$ whose
  restriction to closed programs is a bisimulation.
\end{definition}
\begin{proposition}\label{prop:enhancedbisim}
  There is a largest \enhanced bisimulation, called
  \alert{applicative bisimilarity}.
\end{proposition}

The result that we want to abstract over is:
\begin{theorem}[generalised variant of {\cite[Theorem 1]{DBLP:conf/fossacs/BiernackiL12}}]\label{thm:serguei}
  Applicative bisimilarity is a \alert{congruence}, in the sense that
  it is preserved by all constructions of the language.
\end{theorem}
\begin{remark}
  It is not entirely trivial that this agrees with Biernacki and
  Lenglet's presentation.  In fact, their transition system only
  differs in that they replace rule $(Î²')$ with the standard rule
  $(Î²)$.  We have already seen that $(Î²)$ is derivable from $(Î²')$,
  and conversely $(Î²')$ is admissible in their transition system.
  Indeed, suppose given any transition $eâ‚ \xto{v} eâ‚‚$.  By an easy
  induction, there exist transitions
  $eâ‚ \xto{Ï„} Î»x.eâ‚ƒ \xto{v} eâ‚ƒ[xâ†¦v] \xto{Ï„} eâ‚‚$.  Hence, grouping
  saturation rules, we derive $(Î²)$ as follows.
  \begin{mathpar}
    \inferrule*{%
      \inferrule*{
      eâ‚ \xto{Ï„} Î»x.eâ‚ƒ
      }{
      eâ‚\ v \xto{Ï„} (Î»x.eâ‚ƒ)\ v         
        } \\
      (Î»x.eâ‚ƒ)\ v \xto{Ï„} eâ‚ƒ[xâ†¦v] \\
      eâ‚ƒ[xâ†¦v] \xto{Ï„} eâ‚‚
    }{%
      eâ‚\ v \xto{Ï„} eâ‚‚
      }
    \end{mathpar}
\end{remark}
Our problem is that this result is not an instance of Borthelle et
al.'s~\cite[Theorem~6.15]{HL}, because
the dynamics rely on two features that are not handled:
\begin{alphaenumerate}
\item \label{item:contapp} operations on terms, context application
  and composition, which differ from substitution, 
\item \label{item:contlab} and contexts and values occurring as
  labels.
\end{alphaenumerate}
For~\cref{item:contapp}, context application and composition might be
encodable in Borthelle et al.'s setting, perhaps by resorting to the
skew monoidal variant~\cite{BHL}. But this is quite artificial, and
requires extra work that should not be necessary.
For~\cref{item:contlab}, it appears to be a hard obstruction.




\section{Transition systems in the abstract}\label{ltss}
In this section, we start to abstract over the development
of~\cref{serguei}, by introducing a notion of labelled transition
system, together with its associated notion of bisimilarity.

\subsection{Howe contexts}
Let us start by formally introducing Howe contexts, as sketched
in~\cref{ssoverview}.
\begin{definition}\label{def:howcont}
  A \alert{Howe context} consists of
  \begin{itemize}
  \item a small category $ğ•ğ•‹$ of \alert{state types},
  \item a small category $ğ”¼ğ•‹$ of \alert{transition types},
  \item \alert{source} and \alert{target} functors
      $\source,\butâˆ¶ ğ”¼ğ•‹ â†’ ğ•ğ•‹$, and
    \item a \alert{label} functor $\labelsâˆ¶ ğ”¼ğ•‹ â†’ \psh[ğ•ğ•‹]$, such that
      each $\labels(c)$ is a finite coproduct of representables.
\end{itemize}
\end{definition}

  \begin{example}
    For plain graphs, we would take:
    \begin{itemize}
    \item $ğ•ğ•‹$ to be the terminal category, because there is just one
      kind of vertex,
    \item $ğ”¼ğ•‹$ to also be the terminal category, because there is just one
      kind of edge, 
    \item the source and target functors both are the unique functor
      $1 â†’ 1$, and
    \item the label functor to map the unique object to the empty
      coproduct, i.e., $âˆ…$.
    \end{itemize}
  \end{example}

  \begin{example}\label{ex:src}
    For modelling the transition system of~\cref{serguei}, we need a
    presheaf on $ğ•ğ•‹$ to be equivalent to a triple of functors
    $V_ğ©,V_ğ¯,V_ğœâˆ¶ ğ”½ â†’ ğ’ğğ­$, where $ğ”½$ denotes a skeleton of the
    category of finite sets, e.g., finite ordinals and all maps
    between them, equipped with a natural transformation
    $Î¹âˆ¶ V_ğ¯ â†’ V_ğ©$, or otherwise said to a functor $ğ”½ â†’ ğ’ğğ­^{1 + ğŸš}$.
    We think of $V_ğ©(n)$, $V_ğ¯(n)$, and $V_ğœ(n)$ as sets of programs,
    values, and contexts with $n$ free variables, respectively.  For
    making this into a presheaf category, let us first observe that
    such tuples $(V_ğ©,V_ğ¯,V_ğœ,Î¹)$ are precisely the objects of the
    oplax limit of the functor
    $Î”_{ğ² inâ‚}âˆ¶ \psh[\op{ğ”½}+\op{ğ”½}] â†’ \psh[\op{ğ”½}]$ mapping any
    copairing $[V_ğ©,V_ğœ]$ to $V_ğ©$.  But, as we now recall, oplax
    limits of this form are equivalent to presheaf categories.
    \begin{definition}\label{def:collage}
      For any small categories $ğ•$ and $ğ•$, and functor
      $Fâˆ¶ ğ• â†’ \psh[ğ•]$, the \alert{collage} of $F$, denoted by
      $ğ•[ğ•]_F$, or merely $ğ•[ğ•]$ when $F$ is clear from context, has
      as objects the disjoint union of those of $ğ•$ and $ğ•$, and
      morphisms defined by cases as follows.
      \begin{center}
        $\begin{array}{rcl}
           ğ•[ğ•](x, x')  & = &  ğ•(x, x') \\
           ğ•[ğ•](y, y')  & = &  ğ•(y, y')
         \end{array}$ \hfil
         $\begin{array}{rcl}
            ğ•[ğ•](y, x)  & = &  F(x)(y) \\
            ğ•[ğ•](x, y)  & = &  âˆ…
          \end{array}$
        \end{center}
        Composition is defined as in $ğ•$ and $ğ•$ in both left-hand cases, and
        otherwise by action of $F$.
      \end{definition}
\begin{proposition}[{\cite[Lemma~4.9]{DBLP:journals/mscs/CarboniJ95}}]
  \label{prop:coll}
  For any small categories $ğ•$ and $ğ•$, and functor $Fâˆ¶ ğ• â†’ \psh[ğ•]$,
  letting $Î”_F(Y)(x) = \psh[ğ•](F(x),Y)$ denote the induced
  \alert{nerve} functor $\psh[ğ•] â†’ \psh[ğ•]$, the oplax limit
  $\psh[ğ•]/Î”_F$ is equivalent to the category $\psh[ğ•[ğ•]]$ of
  presheaves on the collage of $F$.
\end{proposition}
Now, the above functor $Î”_{ğ² inâ‚}$ is indeed the nerve of
$\op{ğ”½} \xto{inâ‚} \op{ğ”½}+\op{ğ”½} \xto{ğ²} \psh[\op{ğ”½}+\op{ğ”½}]$
since we have
$Î”_{ğ² inâ‚}[V_ğ©,V_ğœ](n) = V_ğ©(n) = [V_ğ©,V_ğœ](inâ‚(n)) = 
\psh[\op{ğ”½}+\op{ğ”½}](ğ² (inâ‚ (n)),[V_ğ©,V_ğœ])$. We obtain:
\begin{corollary}
  Letting $ğ•ğ•‹ = {(\op{ğ”½}+\op{ğ”½})[\op{ğ”½}]_{ğ² inâ‚}}$, we have
  $[ğ”½,ğ’ğğ­^{1 + ğŸš}] â‰ƒ \psh[ğ•ğ•‹]$.
\end{corollary}

\begin{notation}
  We denote objects $inâ‚ n$, $inâ‚‚ n$, and $inâ‚ƒ n$ of $ğ•ğ•‹$ by $n_ğ¯$,
  $n_ğ©$, $n_ğœ$, respectively, for values, programs, and contexts. For
  any $V âˆˆ \psh[ğ•ğ•‹]$, we denote the corresponding functors $ğ”½ â†’ ğ’ğğ­$
  by $V_ğ¯$, $V_ğ©$, and $V_ğœ$, so that, e.g., $V(n_ğ¯) = V_ğ¯(n)$.
  \end{notation}

  Let us now define $ğ”¼ğ•‹ = 3 = \{ [Ï„], [ğ¯], [ğœ] \} $, where $[Î±]$
  indicates a label of type $Î±$. Accordingly, writing $câˆ¶ a \xto{L} b$
  for $\source(c) = a$, $\labels(c) = L$, and $\but(c) = b$, and
  respectively interpreting $Ï„$, $ğ¯$, and $ğœ$ as $âˆ…$, $ğ²_ğ¯$, and
  $ğ²_ğœ$, we put: $[Î±]âˆ¶ 0_ğ© \xto{Î±} 0_ğ©$, for all $Î± âˆˆ \{Ï„,ğ¯,ğœ\}$.
  \end{example}

\subsection{Generalised transition systems}  
Let us now introduce transition systems.  Let us fix a Howe context
$â„ = (ğ•ğ•‹,ğ”¼ğ•‹,\source,\but,\labels)$ for the whole subsection, and start
by relating both categories $\psh[ğ•ğ•‹]$ and $\psh[ğ”¼ğ•‹]$.
\begin{definition}
We define four functors
$% Î”_\source, Î”_{\but}, Î”_\labels, Î”_â„âˆ¶ 
\psh[ğ•ğ•‹] â†’ \psh[ğ”¼ğ•‹]$
as follows,  for all  $V âˆˆ \psh[ğ•ğ•‹]$ and $Î± âˆˆ ğ”¼ğ•‹$.
\begin{center}
$\begin{array}[t]{rcll}
  Î”_\source(V)(Î±) & = & V(\source(Î±)) \\
  Î”_\but(V)(Î±) & = & V(\but(Î±))
\end{array}$ \hfil
$\begin{array}[t]{rcll}
  Î”_\labels(V)(Î±) & = & \psh[ğ•ğ•‹](\labels(Î±),V) \\
  Î”_â„(V) & = & Î”_\source(V) Ã— Î”_\labels(V) Ã— Î”_\but(V)\rlap{,}
\end{array}$
\end{center}
\end{definition}
\begin{notation}\label{not:Delta}
  We often abbreviate $Î”_â„$ to $Î”$ when $â„$ is clear from context.  We
  also use juxtaposition of indices to denote product of the
  corresponding functors, e.g., $Î”_{ğ¬,ğ¥} â‰” Î”_ğ¬ Ã— Î”_ğ¥$.
\end{notation}

\begin{definition}
  An \alert{$â„$-transition system} $G$ consists of a \alert{vertex}
  presheaf $V_G âˆˆ \psh[ğ•ğ•‹]$, an \alert{edge} presheaf
  $E_G âˆˆ \psh[ğ”¼ğ•‹]$, and a \alert{border} natural transformation
  $âˆ‚_Gâˆ¶ E_G â†’ Î”(V_G)$.
\end{definition}


\begin{remark}
  Letting $\labels(Î±) = âˆ‘_{i âˆˆ n_Î±} ğ²_{ğ¥^Î±áµ¢}$, we have
  $Î”_\labels(V)(Î±) = [âˆ‘_{i âˆˆ n_Î±} ğ²_{ğ¥^Î±áµ¢},V] â‰… âˆ_{i âˆˆ n_Î±} V(ğ¥^Î±áµ¢)$
  for any $Î± âˆˆ ğ”¼ğ•‹$ and $V âˆˆ \psh[ğ•ğ•‹]$.  The border natural
  transformation thus has type
  \begin{center}
    $E(Î±) â†’ V(\source(Î±)) Ã— (âˆ_{i âˆˆ n_Î±} V(ğ¥^Î±áµ¢)) Ã— V(\but(Î±)).$
  \end{center}
\end{remark}
\begin{example}
  Let us unfold the definition for the Howe context of
  \cref{ex:src}: a transition system
  consists of presheaves $V âˆˆ \psh[ğ•ğ•‹]$ and $E âˆˆ \psh[ğ”¼ğ•‹]$,
  equipped with maps
  \begin{mathpar}
    E[Ï„] â†’ V_ğ©(0)Â² \and
    E[ğ¯] â†’ V_ğ©(0) Ã— V_ğ¯(0) Ã— V_ğ©(0) \and
    E[ğœ] â†’ V_ğ©(0) Ã— V_ğœ(0) Ã— V_ğ©(0).
\end{mathpar}
\end{example}


We now equip $â„$-transition systems with morphisms:
\begin{proposition}
  \label{prop:h-trans-comma}
  $â„$-transition systems
  are precisely the objects of the oplax limit category $\psh[ğ”¼ğ•‹]/Î”$ of
  the functor $\psh[ğ•ğ•‹] \xto{Î”} \psh[ğ”¼ğ•‹]$ in $ğ‚ğ€ğ“$, or equivalently the
  comma category $\id_{\psh[ğ”¼ğ•‹]} â†“ Î”$.
\end{proposition}
\begin{proof}
  An object of the oplax limit is by definition a triple $(E,V,{âˆ‚âˆ¶ E â†’ Î”(V)})$.
\end{proof}

% \begin{notation}
%   We generally denote a Howe context by just $(ğ•ğ•‹,ğ”¼ğ•‹)$, leaving the
%   remaining data implicit. Furthermore, 
% \end{notation}
\begin{definition}\label{def:HTrans}
 Let $â„\Trans = \psh[ğ”¼ğ•‹]/Î”_â„$.
\end{definition}



\subsection{Bisimulation and bisimilarity}\label{ss:bisimex}
We now want to define bisimulation and bisimilarity, for any fixed
Howe context $â„ = (ğ•ğ•‹,ğ”¼ğ•‹,ğ¬,ğ­,ğ¥)$.  Let us start with the notion of
simulation.
\begin{notation}
A \alert{span} is a pair of morphisms with the same source.
In a category with binary products, we often write spans
$X â† R â†’ Y$ as their pairings $R â†’ XÃ—Y$.
The \alert{converse} of a span $âŸ¨f,gâŸ©âˆ¶ R â†’ XÃ—Y$ is the composite
$âŸ¨g,fâŸ©âˆ¶ R â†’ XÃ—Y$.

In a presheaf category $\psh$, for any span $jâˆ¶ R â†’ XÃ—Y$, object
$c âˆˆ â„‚$, and element $r âˆˆ R(c)$, we write $râˆ¶ x \mathrel{R} y$ when
$j_c(r) = (x,y)$.  We call $r$ a \alert{witness} that $x$ and $y$ are
related by $R$.

Finally, in any $â„$-transition system $G$, for any transition type $Î±$
with $\labels(Î±) â‰… âˆ‘_{i âˆˆ n_Î±} ğ²_{ğ¥^Î±áµ¢}$, we write
$eâˆ¶ x \xto{Î±(lâ‚,â€¦,l_{n_Î±})} y$ to mean that
$e âˆˆ E_G(Î±)$ and
$âˆ‚_G(e) = (x,(lâ‚,â€¦,l_{n_Î±}),y)$.
\end{notation}
\begin{definition}\label{def:simulation}
  For any $â„$-transition system $G = (V,E,{âˆ‚âˆ¶ E â†’ Î”V})$, a given span
  $jâˆ¶ R â†’ VÂ²$ is a \alert{simulation} when, for any transition
  $eâˆ¶ x \xto{Î±(lâ‚,â€¦,l_{n_Î±})} x'$ and witness $râˆ¶ x \mathrel{R} y$,
  there exists a transition $fâˆ¶ y \xto{Î±(lâ‚,â€¦,l_{n_Î±})} y'$ and a witness
  $r'âˆ¶ x' \mathrel{R} y'$, as in
\begin{equation}
\hfil  \diag{%
    x \& R(ğ¬(Î±)) \& y \\
    x' \& R(ğ­(Î±)) \&  y'. %
  }{%
    (m-1-1) 
    edge[labell={eâˆ¶ Î±(lâ‚,â€¦,l_{n_Î±})}] (m-2-1) %
    (m-1-3) edge[labelr={fâˆ¶ Î±(lâ‚,â€¦,l_{n_Î±})}] (m-2-3) %
  }\label{eq:compattuple}
\end{equation}
  A span is a \alert{bisimulation} when it is a simulation and so is its
  converse.
  A \alert{bisimulation relation} is a bisimulation which is also a relation,
  i.e., a mono $R â†ª VÂ²$.
\end{definition}

\begin{proposition}\label{prop:bisimilarity}
  The full subcategory $ğğ¢ğ¬ğ¢ğ¦(G)$ of $\psh[ğ•ğ•‹]/VÂ²$ spanning
  bisimulations admits a terminal object, which we call
  \alert{bisimilarity} and denote by $âˆ¼_G$.
\end{proposition}
\begin{proof}
  Bisimulation relations are stable under unions, so that
  a terminal object is given by the union of them all.
\end{proof}

\section{Algebraic transition systems}\label{atss}
In this section, we explain \enhanced syntax, algebraic transition
systems, and \enhanced bisimulation in a bit more detail than
in~\cref{ssalts}.  The notion of \enhanced syntax has already been
introduced (\cref{def:enhanced:syntax}), and we fix a Howe context
$â„ = (ğ•ğ•‹,ğ”¼ğ•‹,ğ¬,ğ­,\labels)$ and \anenhanced syntax
$Ïƒ=(Î£,Î“,{Î´âˆ¶ TS â†’ ST})$, where, we recall, $S=Î£^*$ and $T=Î“_S^*$.
\subsection{\Enhanced syntax}
\begin{definition}
  We call $ST$-algebras \alert{$Ïƒ$-algebras} for short, and let
  $Ïƒ\Alg = ST\Alg$.
\end{definition}

\begin{proposition}
  The initial $Î£$-algebra $Sâˆ…$ is automatically a $T$-algebra, with
  structure map $TSâˆ… \xto{Î´_âˆ…} STâˆ… \xto{â‰…} Sâˆ…$.
\end{proposition}
\begin{proof}
  By cocontinuity, $âˆ…$ is a $Î“_S$-algebra: we have $Î“(âˆ…,S(âˆ…)) â‰… âˆ…$. It
  is thus an initial $Î“_S$-algebra, hence an initial $T$-algebra
  since $Î“_S\alg â‰… T\Alg$.
\end{proof}

\begin{example}\label{ex:srcalg}
  Following up on \cref{ex:src}, the syntax and additional operations
  of \cref{serguei} may be presented by an incremental structural law
  on $\psh[ğ•ğ•‹]$, as follows.  First, basic operations are specified by
  the endofunctor $Î£â‚€$ defined as follows (recalling original notation
  on the right).

\noindent$\begin{array}{r@{\ =\ }lr@{\ ::=\ }l}
Î£â‚€(X)_ğ¯(n) &   n  +  X_ğ©(n + 1) & v &  x  ï½œ  Î»x.e    \\
     Î£â‚€(X)_ğ©(n) &   Î£â‚€(X)_ğ¯(n) + X_ğ¯(n)  +  X_ğ©(n)Â²  +  X_ğ©(n + 1)  +  X_ğ©(n) &  e &  v  ï½œ  eâ‚\ eâ‚‚  ï½œ  ğ’®x.e  ï½œ  âŸ¨eâŸ©  \\
     Î£â‚€(X)_ğœ(n) &   1  +  X_ğ¯(n) Ã— X_ğœ(n)  +  X_ğœ(n) Ã— X_ğ©(n)
                & E &  â–«  ï½œ E\ e  ï½œ  v\ E 
   \end{array}$
%   \hspace*{-1em}\begin{align}
% Î£â‚€(X)_ğ¯(n) & =  n  +  X_ğ©(n + 1) & v & ::=  x  ï½œ  Î»x.e    \\
%      Î£â‚€(X)_ğ©(n) & =  Î£â‚€(X)_ğ¯(n) + X_ğ¯(n)  +  X_ğ©(n)Â²  +  X_ğ©(n + 1)  +  X_ğ©(n) &  e & ::=  v  ï½œ  eâ‚\ eâ‚‚  ï½œ  ğ’®x.e  ï½œ  âŸ¨eâŸ©  \\
%      Î£â‚€(X)_ğœ(n) & =  1  +  X_ğ¯(n) Ã— X_ğœ(n)  +  X_ğœ(n) Ã— X_ğ©(n)
%                 & E & ::=  â–«  ï½œ E\ e  ï½œ  v\ E 
%    \end{align}

   \noindent
   We then want to define the arity of additional operations, namely
   substitution, context application, and context composition.  Since
   these three additional operations are independent, we may specify
   them at once by the bifunctor $Î“âˆ¶ \psh[ğ•ğ•‹]Â² â†’ \psh[ğ•ğ•‹]$ defined as
   follows.

   \noindent$\begin{array}{rclrcl}
   Î“(X,Y)_ğ¯(n) & = &   \textstyle âˆ‘_{m âˆˆ â„•} X_ğ¯(m) Ã— Y_ğ¯(n)áµ &
                                          v & {+}\Coloneqq & v[Ïƒ]    \\
   Î“(X,Y)_ğ©(n) & = &   \textstyle âˆ‘_{m âˆˆ â„•} X_ğ©(m) Ã— Y_ğ¯(n)áµ  +  X_ğœ(n) Ã— Y_ğ©(n) &
                                                              e & {+}\Coloneqq & e[Ïƒ] ï½œ E[e]    \\   
   Î“(X,Y)_ğœ(n) & = &   X_ğœ(n) Ã— Y_ğœ(n) &
    E & {+}\Coloneqq & E[E']
 \end{array}$

 \noindent That the actual definition of additional operations induces
 a distributive law of $Î“_S^*$ over $Î£^*$ is harder to see, and will
 follow from the theory of syntactic signatures below
 (\cref{ex:srcii}).
\end{example}

\subsection{Algebraic transition systems}
Let us now introduce algebraic transition systems.
\begin{definition}
  A \alert{$Ïƒ$-transition system} is an $â„$-transition systems
  equipped with $Ïƒ$-algebra structure on its vertex object.  A
  $Ïƒ$-transition system morphism is a morphism of $â„$-transition
  systems whose vertex component is a $Ïƒ$-algebra morphism.  Let
  $Ïƒ\Trans$ denote the category of $Ïƒ$-transition systems and
  morphisms between them.
\end{definition}
\begin{proposition}\label{prop:L}
  The forgetful functor $ğ’°$ has a left adjoint, say
  $â„’âˆ¶ â„\Trans â†’ Ïƒ\Trans$.
\end{proposition}
\begin{proof}
  The left adjoint maps any $âˆ‚âˆ¶ E â†’ Î”(V)$ to
  $E \xto{âˆ‚} Î”(V) \xto{Î”(Î·^{ST}_V)} Î”(S (T (V)))$.
\end{proof}

We conclude this section by defining the notion of congruence.
\begin{definition}
  For any $Ïƒ$-transition system $G = (V,E,âˆ‚)$, a \alert{congruence} is
  a span $R â†’ VÂ²$ for which there exists a morphism $Î£(R) â†’ R$ making
  the first diagram of~\cref{fig:congenhance} commute.
  \begin{figure}[htp]
    \centering
    \diag{%
      Î£(R) \& \& R \\
      Î£(VÂ²) \& Î£(V)Â² \& VÂ² %
    }{%
      (m-1-1) edge[dashed,labela={}] (m-1-3) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[loinb={âŸ¨Î£ (Ï€â‚),Î£ (Ï€â‚‚)âŸ©}] (m-2-2) %
      (m-2-2) edge[labelb={}] (m-2-3) %
      (m-1-3) edge[labelr={}] (m-2-3) %
    }
    \hfil
        \diag{%
      Î“(R,V) \& \&  R \\
      Î“(VÂ²,V) \& Î“(V,V)Â² \& VÂ² }{%
      (m-1-1) edge[dashed,labela={}] (m-1-3) %
      edge[labell={},shorten >=2pt] (m-2-1) %
      (m-2-1) edge[loinb={âŸ¨Î“ (Ï€â‚,V),Î“ (Ï€â‚‚,V)âŸ©}] (m-2-2) %
      (m-2-2) edge[labelb={}] (m-2-3) %
      (m-1-3) edge[labelr={}] (m-2-3) %
    }
    \caption{Congruence and enhancement}
    \label{fig:congenhance}
  \end{figure}
\end{definition}
% \begin{remark}
%   When $R$ is a relation, the lifting is unique if it exists.
% \end{remark}


\subsection{\Enhanced bisimilarity}
\label{s:enhancedbisim}

\begin{definition}
  \label{def:enhanced-span}
  For any $Ïƒ$-algebra $V$, a span $pâˆ¶ R â†’ VÂ²$ is \alert{\enhanced}
  when there exists a morphism $Î“(R,V) â†’ R$ making the second diagram
  of~\cref{fig:congenhance} commute.
\end{definition}

\begin{definition}
  For any $Ïƒ$-transition system $G$, let $ğğ¢ğ¬ğ¢ğ¦^Ïƒ(G)$ denote the full
  subcategory of $ğğ¢ğ¬ğ¢ğ¦(G)$ on \enhanced spans.  We call such spans
  \alert{\enhanced bisimulations}.
\end{definition}


\begin{proposition}
  For any $Ïƒ$-transition system $G$, $ğğ¢ğ¬ğ¢ğ¦^Ïƒ(G)$ admits a terminal
  object, which we call \alert{\enhanced} bisimilarity and denote by
  $âˆ¼^Ïƒ_G$.
\end{proposition}
\begin{proof}
  Similar to \cref{prop:bisimilarity}, using left-cocontinuity of $Î“$.
\end{proof}

\begin{example}\label{ex:srcenhancedbisim}
  In the setting of~\cref{ex:srcalg}, \enhanced bisimilarity is
  applicative bisimilarity.
\end{example}

\section{Signatures for operational semantics}\label{s:howecontexts}

\subsection{Syntactic signatures for \enhanced syntax}
Syntactic signatures have already been introduced
in~\cref{def:syntacticsig}.

\begin{example}\label{ex:srcii}
  Following up on \cref{ex:srcalg}, the syntax and additional
  operations of \cref{serguei} may be presented as an incremental
  structural law $d_{X,Y}âˆ¶ Î“_Y(Î£(X)) â†’ S (Î“_{S(Y)}(X) + X + Y)$
  (taking $Tâ‚ = \id$) on $\psh[ğ•ğ•‹]$, as follows.  For context
  application, \crefrange{eq:wbox}{eq:appe} may be interpreted as the
  component $Î£(X)_ğœ(n) Ã— Y_ğ©(n) â†’ S (Î“_{S(Y)}(X) + X + Y)_ğ©(n)$,
  namely we take them to mean
 $$\begin{array}{rcl}
   (inâ‚(â‹†),y) & â†¦ & in'â‚ƒ(y) \\
   (inâ‚‚(v,E),y) & â†¦ & Î¹(in'â‚‚(v))\ in'â‚(E,y) \\
   (inâ‚ƒ(E,e),y) & â†¦ & in'â‚(E,y)\ in'â‚‚(e)\rlap{,}
   \end{array}$$
   where $in'áµ¢ = Î·^S âˆ˜ ináµ¢$.
   For context composition,
   we define the component
   at $ğœ$ (for any $n$), by  
   the exact same formulas, only with $y âˆˆ Y_ğœ(n)$.
   Substitution is defined similarly~\cite{fiore:presheaf,BHL,HL}.
\end{example}

\begin{proposition}\label{prop:sigmad}
  For any syntactic signature $ğ = (Î£,(Î“áµ¢,dáµ¢)_{i âˆˆ n})$ as
  in~\cref{eq:syntacticsig}, the given incremental structural laws
  induce distributive laws $Î´áµ¢âˆ¶ Táµ¢ âˆ˜ S â†’ S âˆ˜ Táµ¢$, hence in particular
  $Î´â‚™âˆ¶ Tâ‚™ âˆ˜ S â†’ S âˆ˜ Tâ‚™$, and furthermore we have $Tâ‚™ = (âˆ‘áµ¢
  Î“áµ¢)_S^*$. Thus, the triple $Ïƒ(ğ) = (Î£,âˆ‘áµ¢ Î“áµ¢,Î´â‚™)$ forms \anenhanced
  syntax.
\end{proposition}
\begin{proof}
  By \cite[Theorem~4.2]{admissible}, each incremental structural law
  $dáµ¢$ induces a distributive law of $(T_{i-1} âŠ• Î“_S^*)$ over $S$,
  i.e., of $Táµ¢$ over $S$ by definition, using $(F+G)^* â‰… F^* âŠ• G^*$.
\end{proof}


Let us conclude this subsection by giving an explicit description of
the algebras of the composite monad $STâ‚™$ generated by a
syntactic signature.
\begin{definition}\label{def:enhanced}
  Consider any syntactic signature $ğ = (Î£,(Î“áµ¢,dáµ¢)_{i âˆˆ n})$.  For
  $i âˆˆ n$, an \alert{\enhanced algebra} is an object equipped with
  algebra structures $aâˆ¶ Î£X â†’ X$, $bâ‚âˆ¶ Î“â‚(X,X) â†’ X$, â€¦,
  $bâ‚™âˆ¶ Î“â‚™(X,X) â†’ X$ such that for all $i âˆˆ n$ the following diagram
  commutes,
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMCwwLCJcXEdhbW1hX3tpfShcXFNpZ21hIFgsWCkiXSxbMSwwLCJTVF97aX0oXFxHYW1tYV97aX0oWCxTVF97aX1YKStYK1gpIl0sWzMsMCwiU1RfaShcXEdhbW1hX2koWCxYKStYKSJdLFs0LDAsIlNUX2lYIl0sWzQsMSwiWCJdLFswLDEsIlxcR2FtbWFfaShYLFgpIl0sWzAsMSwiKGRfe2l9KV97WCxYfSJdLFsxLDIsIlNUX2koXFxHYW1tYV9pKFgsIFxcYmFye2F9IFxcY2lyYyBTXFxiYXJ7YX1faSkrW1gsWF0pIl0sWzIsMywiU1RfaVtiX2ksWF0iXSxbMCw1LCJcXEdhbW1hX2koYSxYKSIsMl0sWzUsNCwiYl9pIiwyXSxbMyw0LCJcXGJhcnthfSBcXGNpcmMgU1xcYmFye2F9X2kiXV0=
\begin{tikzcd}[ampersand replacement=\&]
	{\Gamma_{i}(\Sigma X,X)} \& {ST_{i}(\Gamma_{i}(X,ST_{i}X)+X+X)} \&\& {ST_i(\Gamma_i(X,X)+X)} \& {ST_iX} \\
	{\Gamma_i(X,X)} \&\&\&\& X
	\arrow["{(d_{i})_{X,X}}", from=1-1, to=1-2]
	\arrow[loina={ST_i(\Gamma_i(X, \bar{a} \circ S\bar{a}_i)+[X,X])}, from=1-2, to=1-4]
	\arrow["{ST_i[b_i,X]}", from=1-4, to=1-5]
	\arrow["{\Gamma_i(a,X)}"', from=1-1, to=2-1]
	\arrow["{b_i}"', from=2-1, to=2-5]
	\arrow["{\bar{a} \circ S\bar{a}_i}", from=1-5, to=2-5]
\end{tikzcd}    
  \end{center}
  where $\bar{a}áµ¢âˆ¶ Táµ¢ X â†’ X$ and $\bar{a}âˆ¶SX â†’ X$ denote the algebra
  structures induced by $(bâ±¼)_{j < i}$, and $a$.  Let $ğ\Alg$ denote
  the full subcategory of $(Î£+âˆ‘_{i âˆˆ n} Î“áµ¢)\alg$ spanned by \enhanced
  algebras.
\end{definition}

\begin{proposition}
  Let $ğ = (Î£,(Î“áµ¢,dáµ¢)_{i âˆˆ n})$ denote any syntactic signature.  The
  forgetful functor $Ïƒ(ğ)\Alg â†’ (Î£+âˆ‘_{i âˆˆ n} Î“áµ¢)\alg$ lifts to
  $ğ\Alg$, and the lifting is an isomorphism.  In short, we have
  $Ïƒ(ğ)\Alg â‰… ğ\Alg$ over $\psh$.
\end{proposition}
\begin{proof}
  By induction on $n$ and~\cite[Theorem~4.13]{admissible}.
  % We proceed by induction on $n$. The base case is trivial, and
  % for the induction step, we consider
  % $Ïƒ = (Î£,(Î“áµ¢,dáµ¢)_{i âˆˆ n})$ and an additional incremental structural law
  % $$d_{n+1}âˆ¶ Î“_{n+1}(Î£X,Y) â†’ ST (Î“_{n+1}(X,STY) + X + Y).$$
  % The induction hypothesis is: $Ïƒ\Alg â‰… ST\Alg$.  Let
  % $Ïƒ' = (Î£, (Î“áµ¢,dáµ¢)_{i âˆˆ n+1})$ and $T' = T âŠ• ((Î“_{n+1})_S)^*$.  We
  % want to show that \enhanced algebras for $Ïƒ'$ are equivalent to
  % $ST'$-algebras.  By~\cite[Theorem~4.13]{admissible}, $ST'$-algebras
  % are equivalent to $ST$-algebras $X$ equipped with $Î“_{n+1}$-algebra
  % structure making the desired diagram commute, hence we conclude by
  % induction hypothesis.
\end{proof}

\subsection{Dynamic signatures}
Let us now introduce signatures for the dynamical part of an
operational semantics.  We want a dynamic signature to be something
like an endofunctor on $Ïƒ\Trans$, with built-in structuralness.  For
this, we introduce a variant of $â„$-transition systems called diplopic
$â„$-transition systems, which feature an object of distinguished
vertices, among which all sources of transitions must lie.  This will
enable structuralness, by allowing sources of conclusions of
transition rules to have a distinguished head constructor.  We fix
\anenhanced syntax $Ïƒ = (Î£,Î“,{Î´âˆ¶TS â†’ ST})$ for this subsection.
\begin{definition}
  A \alert{diplopic $â„$-transition system} $G$ consists of a
  \alert{vertex} object $V_G âˆˆ \psh[ğ•ğ•‹]$, a \alert{distinguished
    vertex} object $D_G âˆˆ \psh[ğ•ğ•‹]$, an \alert{edge} object
  $E_G âˆˆ \psh[ğ”¼ğ•‹]$, together with morphisms $Î³_Gâˆ¶ D_G â†’ V_G$ and
  $âˆ‚_Gâˆ¶ E_G â†’ Î”_\source(D_G) Ã— Î”_{\labels,\but}(V_G)$.

  A \alert{diplopic $Ïƒ$-transition system} is a diplopic
  $â„$-transition system $G$ equipped with $Ïƒ$-algebra structure on
  $V_G$.

  As before, we organise both notions into categories
  $â„\Trans_ğŸš = \psh[ğ”¼ğ•‹]/Î”_ğŸš$ and
  $Ïƒ\Trans_ğŸš = â„\Trans_ğŸš Ã—_{\psh[ğ•]}\, Ïƒ\Alg$, where $Î”_ğŸš$
  denotes the composite
  $\psh[ğ•ğ•‹]^ğŸš \xto{âŸ¨Ï€â‚,Ï€â‚‚,Ï€â‚‚âŸ©} \psh[ğ•ğ•‹]Â³ \xto{Î”_\source Ã— Î”_\labels Ã—
    Î”_\but} \psh[ğ”¼ğ•‹]$.
\end{definition}


\begin{definition}\label{def:dynsig}
  A \alert{dynamic signature} over $Ïƒ$ is a functor
  $Î£â‚âˆ¶ Ïƒ\Trans â†’ Ïƒ\Trans_ğŸš$ such that, for all $G âˆˆ Ïƒ\Trans$,
  $V_{Î£â‚(G)} = V_G$, $D_{Î£â‚(G)} = V_G + Î£(V_G)$, and
  $Î³_Gâˆ¶ V_G + Î£(V_G) â†’ V_G$ is the canonical morphism (and similarly
  on morphisms).
\end{definition}
\begin{example}\label{ex:srciii}
  Letting $ğ$ denote the syntactic signature of \cref{ex:srcii}. The
  transition rules of \cref{serguei} define a dynamic signature
  $Î£â‚âˆ¶ Ïƒ(ğ)\Trans â†’ Ïƒ(ğ)\Trans_ğŸš$. Its behaviour on the underlying
  $Ïƒ(ğ)$-algebra is fixed, so we merely need to define it on
  transitions.  For any $G = (D,V,E,âˆ‚) âˆˆ Ïƒ(ğ)\Trans$ and $Î± âˆˆ ğ”¼ğ•‹$, we
  define $Î£â‚(G)(Î±)$ to be a coproduct over all rules $Ï$ producing a
  transition of type $Î±$, of a set describing the premises of $Ï$.
  One non-trivial rule is \textsc{(SA)}, whose set of premises is
  $E[ğœ] Ã—_{V(0_ğœ)} (V(0_ğœ)Ã—V(0_ğ¯))$.  Concretely, it is the set of
  tuples $(r,(E,v))$, where $r$ is a transition $eâ‚ \xto{E'} eâ‚‚$, and
  the pullback condition imposes $E' = E[v\ â–«]$.  (We take the
  pullback of
  $E[ğœ] \xto{Ï€â‚‚âˆ‚} {V(0_ğœ)} \xot{E[v\ â–«]\ â†¤\ E,v} V(0_ğœ)Ã—V(0_ğ¯)$.)  We
  define the source of $(r,(E,v))$ to be
  $inâ‚‚(inâ‚‚ (Î¹(v),eâ‚)) âˆˆ V_ğ©(0)+Î£â‚€(V)_ğ©(0)$, (i.e., recalling $Î£â‚€$
  from~\cref{ex:srcalg}, the formal application $Î¹(v)\ eâ‚$,) its label
  to be $E$, and its target to be $eâ‚‚$.
\end{example}

Returning to the abstract setting, let us now define the category of
models of a dynamic signature $Î£â‚$.
For this, we need to build an endofunctor out of $Î£â‚$,
hence a link between $Ïƒ\Trans$ and $Ïƒ\Trans_ğŸš$.
\begin{definition}
  Let $Î¹\Transâˆ¶ Ïƒ\Trans â†’ Ïƒ\Trans_ğŸš$ map any $E â†’ Î”(V)$ to itself
  (with underlying arrow $V â†’ V$).
\end{definition}

\begin{proposition}\label{prop:iota:rho:reflection}
  The functor $Î¹\Transâˆ¶ Ïƒ\Trans â†’ Ïƒ\Trans_ğŸš$ is a (full) reflective
  embedding.  The left adjoint, say $Ï\Transâˆ¶ Ïƒ\Trans_ğŸš â†’ Ïƒ\Trans$
  maps any $E â†’ Î”_ğ¬(D)Ã—Î”_{ğ¥,ğ­}(V)$ to the composite
  $E â†’ Î”_ğ¬(D)Ã—Î”_{ğ¥,ğ­}(V) â†’ Î”(V)$.
\end{proposition}

\begin{definition}
  For any $Î£â‚$, let $\check{Î£}â‚$ be the composite
  $Ïƒ\Trans \xto{Î£â‚} Ïƒ\Trans_ğŸš \xto{Ï\Trans} Ïƒ\Trans$.
\end{definition}
Models of $Î£â‚$ will almost be $\check{Î£}â‚$-algebras.  The problem is
that a $\check{Î£}â‚$-algebra structure includes in particular algebra
structure for the action of $\check{Î£}â‚$ on the underlying
$Ïƒ$-algebra, i.e., algebra structure $V â†’ V$ for the identity
endofunctor on $Ïƒ$-algebras.  This structure is not relevant for our
purposes, so we require it to be the canonical candidate, i.e., the
identity on $V$.
\begin{definition}
  A $\check{Î£}â‚$-algebra structure $\check{Î£}â‚(G) â†’ G$ is
  \alert{vertical} when its image under the forgetful functor
  $Ïƒ\Trans â†’ Ïƒ\Alg$ is the identity.  A $\check{Î£}â‚$-algebra is called
  \alert{vertical} accordingly. Let $\check{Î£}â‚\alg áµ¥$ denote the full
  subcategory of $\check{Î£}â‚\alg$ spanning all vertical algebras.
\end{definition}

\begin{theorem}\label{thm:Z}
  The forgetful functor $\check{Î£}â‚\alg áµ¥ â†’ Ïƒ\Trans$ is monadic, and
  the initial $\check{Î£}â‚$-algebra, say $ğ™_{Î£â‚}$, or $ğ™$ for short
  when $Î£â‚$ is clear from context, may be chosen to be vertical, hence
  in particular to also be initial in $\check{Î£}â‚\alg áµ¥$.  (In this
  case, $V_ğ™$ is an initial $Ïƒ$-algebra.)
\end{theorem}
\begin{proof}
  Same as \cite[Theorem 5.18 and Proposition 5.19]{HL}.
\end{proof}

\begin{example}\label{ex:srciv}
  For $Î£â‚$ as in \cref{ex:srciii}, $ğ™$ is the syntactic transition
  system of~\cref{serguei}.
\end{example}

Let us now collect the static and dynamic part of signatures and their
models.
\begin{definition}
  An \alert{operational signature} consists of a syntactic signature
  $ğ$, together with a dynamic signature $Î£â‚âˆ¶ Ïƒ(ğ)\Trans â†’ Ïƒ(ğ)\Trans_ğŸš$
  over the generated \enhanced syntax $Ïƒ(ğ)$ (\cref{prop:sigmad}).
  The category of $(ğ,Î£â‚)$-algebras is $\check{Î£}â‚\alg áµ¥$.
\end{definition}
By definition, we have:
\begin{proposition}
  The initial vertical $\check{Î£}â‚$-algebra is an initial
  $(ğ,Î£â‚)$-algebra.
\end{proposition}




\subsection{Congruence of \enhanced bisimilarity}\label{s:substclosedbisim}
In this subsection, we state our main congruence result.  For this, we
need to make an important hypothesis involving so-called functional
flexible bisimulations. These are like a functional version of
bisimulations, where labels are required to be related instead of
identical, much as in Sangiorgi's
BA-bisimulation~\cite{DBLP:conf/fsen/SangiorgiKS07}, which we need to
define both for algebraic transition systems and their diplopic
variant.  The hypothesis will then require that the considered dynamic
signature $Î£â‚$ preserve functional flexible bisimulations.  We again
fix a Howe context $â„ = (ğ•ğ•‹,ğ”¼ğ•‹,ğ¬,ğ­,\labels)$ and \anenhanced syntax
$Ïƒ$ over it.
\begin{definition}
  A morphism $fâˆ¶ R â†’ X$ in $â„\Trans_ğŸš$ is a \alert{functional flexible
    bisimulation} iff for any $Î± âˆˆ ğ”¼ğ•‹$, $r âˆˆ D_R(\source(Î±))$,
  $(râ‚,â€¦,r_{n_Î±}) âˆˆ Î”_\labels(V_R)(Î±)$, and transition
  $e'âˆ¶ f_D(r) \xto{Î±(f_V(râ‚),â€¦,f_V(r_{n_Î±}))} x'$ there exists
  $eâˆ¶ r \xto{Î±(râ‚,â€¦,r_{n_Î±})} r'$ such that $f_E(e) = e'$.
%  (hence in particular $f_V(r') = x'$).% , as in
% \begin{equation}
% \hfil  \diag{%
%     r \& \& f_D(r) \\
%     r' \& \&  x'. %
%   }{%
%     (m-1-1) edge[mapsto,shorten >=2em,shorten <=2em] (m-1-3) %
%     edge[dashed,labell={eâˆ¶ Î±(râ‚,â€¦,r_{n_Î±})}] (m-2-1) %
%     (m-1-3) edge[labelr={e'âˆ¶ Î±(f_V(râ‚),â€¦,f_V(r_{n_Î±}))}] (m-2-3) %
%     (m-2-1) edge[dashed,mapsto,shorten >=2em,shorten <=2em] (m-2-3) %
%   }\label{eq:compattuple''}
% \end{equation}
% A span $R â†’ XÃ—Y$ is a \alert{flexible simulation} if its left-hand leg
% $R â†’ X$ is a flexible functional bisimulation, and a \alert{flexible
%   bisimulation} when both of its legs are.

  A morphism in $Ïƒ\Trans_ğŸš$ is a functional flexible bisimulation iff
  the underlying morphism in $â„\Trans_ğŸš$
  is. % , and similarly for flexible bisimulations
% and flexible bisimulation relations.
% For any $R âˆˆ \psh[ğ•ğ•‹]^ğŸš$, $Z âˆˆ â„\Trans_ğŸš$, and morphism
% $fâˆ¶ R â†’ Z_{D,V}$, let ${Râ†¾f} âˆˆ â„\Trans_ğŸš$ be such that
% ${Râ†¾f}_{D,V} = R$, and $(Râ†¾f)â‚ = Î”(R) Ã—_{Î”(Z_{D,V})} Zâ‚$.  A span
% $jâˆ¶ R â†’ X_{D,V}Â²$ is a \alert{flexible bisimulation} when the induced
% morphism ${Râ†¾j} â†’ XÂ²$ is.
A morphism in $Ïƒ\Trans$ is a functional flexible bisimulation
iff its embedding into $Ïƒ\Trans_ğŸš$ (by $Î¹\Trans$) is.  In any of these
categories $ğ’$, let $ğ…ğ…ğğ¢ğ¬ğ¢ğ¦(ğ’)$ denote the class of all functional
flexible bisimulations.
\end{definition}

\begin{definition}
  A dynamic signature $Î£â‚âˆ¶ Ïƒ\Trans â†’ Ïƒ\Trans_ğŸš$ \alert{preserves
    functional flexible bisimulations} iff for all morphisms $f$ in
  $Ïƒ\Trans$, if $f$ is a functional flexible bisimulations, then so is
  $Î£â‚(f)$.  
\end{definition}

Let us introduce a last hypothesis before stating the main result:
\begin{definition}
  A functor is \alert{algebraic} iff it is finitary and preserves wide
  pullbacks and reflexive coequalisers.  A syntactic signature
  $(Î£,Î“,Î´)$ is algebraic if the endofunctor $Î£$ is.
\end{definition}
\begin{remark}
  Algebraicity is straightforward to verify in all our applications.
\end{remark}
% \begin{remark}
%   In a presheaf category like $\psh[ğ•ğ•‹]$, if $Î£$ preserves pullbacks,
%   algebraicity is equivalent to being finitary and preserving all epis
%   (see the proof of \cite[Theorem 18.1]{algebraictheories}).
% \end{remark}
\begin{theorem}\label{thm:main}
  For any operational signature $(ğ,Î£â‚)$, if $ğ$ is algebraic and $Î£â‚$
  preserves functional flexible bisimulations, then \enhanced
  bisimilarity on the initial vertical $\check{Î£}â‚$-algebra is a
  congruence.
\end{theorem}
\begin{proof}
  See Appendix~\ref{app:proof-main-thm}.
\end{proof}
\subsection{Preservation of functional flexible bisimulations}
In this section, we exhibit a sufficient condition for a dynamic
signature to preserve functional flexible bisimulations, slightly
generalising~\cite[Â§7]{HL}.  Fixing a Howe context
$â„ = (ğ•ğ•‹,ğ”¼ğ•‹,\source,\but,\labels)$ and \anenhanced syntax
$Ïƒ=(Î£â‚€,Î“,{Î´âˆ¶ TS â†’ ST})$ on $\psh[ğ•ğ•‹]$, we first characterise $â„\Trans$
and $â„\Trans_ğŸš$ as presheaf categories, which allows us to
characterise functional flexible bisimulations as the right class of a
weak factorisation system~\cite{Hovey,riehl} -- we call the left class
\alert{cofibrations}. We then recall familial functors, and define the
notion of rule of a dynamic signature $Î£â‚$, and the \alert{border
  arity} of any rule. We finally show that a familial $Î£â‚$ preserves
functional flexible bisimulations iff the border arities of all rules
are cofibrations.

Let us characterise transitions systems as presheaves,
recalling~\cref{def:collage}:
\begin{proposition}
  We have $â„\Trans â‰ƒ \psh[{ğ•ğ•‹[ğ”¼ğ•‹]}]_{ğ²_ğ¬+ğ¥+ğ²_ğ­}$, where $ğ²_ğ¬+ğ¥+ğ²_ğ­âˆ¶ ğ”¼ğ•‹ â†’ \psh[ğ•ğ•‹]$.
\end{proposition}
\begin{proof}
  The functor $Î”_â„$ is the nerve of $ğ²_ğ¬+ğ¥+ğ²_ğ­$, so we conclude
  by~\cite[Lemma~4.9]{DBLP:journals/mscs/CarboniJ95}.
\end{proof}

Doing the same for $â„\Trans_ğŸš$ leads to considering the functor
$ğ”¼ğ•‹ â†’ \psh[ğ•ğ•‹]^ğŸš$ mapping any $Î±$ to the arrow
$ğ²_{ğ¬(Î±)} â†’ ğ²_{ğ¬(Î±)} + ğ¥(Î±) + ğ²_{ğ­(Î±)}$. But for
\cite[Lemma~4.9]{DBLP:journals/mscs/CarboniJ95} to apply, we need the
codomain of this functor to be a presheaf category. This is in fact
the case up to equivalence:
\begin{lemma}\label{lem:vtvt}
  We have
  $\psh[ğ•ğ•‹]^ğŸš â‰ƒ \psh[{ğ•ğ•‹[ğ•ğ•‹]}_ğ²]$, where
  $ğ²âˆ¶ ğ•ğ•‹ â†’ \psh[ğ•ğ•‹]$.
\end{lemma}
\begin{notation}
  For each state type $b âˆˆ ğ•ğ•‹$, the category $ğ•ğ•‹[ğ•ğ•‹]$ has an object
  $b_V$ corresponding to the vertex object, an object $b_D$ for the
  distinguished vertex object, and a morphism $b_V â†’
  b_D$. % We denote by $b_{D,V}âˆ¶ b_V â†’ b_D$
  % the morphism corresponding to $Î³âˆ¶ D â†’ V$.
\end{notation}
Gluing along the obtained functor
$Î±â†¦ ğ²_{ğ¬(Î±)_D} + âˆ‘_{i âˆˆ n_Î±} ğ²_{(ğ¥^Î±áµ¢)_V} + ğ²_{ğ­(Î±)_V}$, we obtain:
\begin{proposition}
  We have $â„\Trans_ğŸš â‰ƒ\psh[{ğ•ğ•‹[ğ•ğ•‹][ğ”¼ğ•‹]}]$.
\end{proposition}
Let us now characterise functional flexible bisimulations by a lifting
property.
\begin{definition}
  In a category $ğ’$, given a class $ğ•$ of morphisms, let
  $\wbotright{ğ•}$ consist of morphisms $fâˆ¶ X â†’ Y$ such that
  for any $jâˆ¶ A â†’ B$ in $ğ•$, any $(u,v)âˆ¶ j â†’ f$ in $ğ’^ğŸš$ admits a
  \alert{lifting}, i.e., a morphism $kâˆ¶ B â†’ X$ such that $kâˆ˜j=u$ and
  $fâˆ˜k=v$.  Let $\wbotleft{ğ•}$ consist of all $f$ such that
  any $(u,v)âˆ¶ f â†’ j$ in $ğ’^ğŸš$ admits a lifting.  A
  \alert{$ğ•$-cofibration} is an element of $\wbotrightleft{ğ•}$.
\end{definition}
\begin{proposition}\label{prop:cx}
    For any $ğ•$,$ğ•$-cofibrations are closed under cobase change and
     composition.
  \end{proposition}

For any $Î± âˆˆ ğ”¼ğ•‹$, the element
$(inâ‚ (\id_{ğ¬(Î±)})) âˆˆ (ğ²_ğ¬+ğ¥+ğ²_ğ­)(Î±)(ğ¬(Î±))$, corresponds to a morphism
$s_Î±âˆ¶ ğ¬(Î±) â†’ Î±$ in $ğ•ğ•‹[ğ”¼ğ•‹]$, and similarly we get morphisms
$l^Î±áµ¢âˆ¶ ğ¥^Î±áµ¢ â†’ Î±$ for all $i âˆˆ n_Î±$.
\begin{definition}
  Let $ğ•_Ïƒ$ denote the set of all maps $â„’'(j_Î±)$ in $Ïƒ\Trans$, where
  $â„’'âˆ¶ \psh[{ğ•ğ•‹[ğ”¼ğ•‹]}] â†’ Ïƒ\Trans$ is left adjoint to the forgetful
  functor, and $j_Î±âˆ¶ ğ²_{ğ¬(Î±)} + âˆ‘_{i âˆˆ n_Î±} ğ²_{ğ¥^Î±áµ¢} â†’ ğ²_Î±$ denotes
  the cotupling $[ğ²_{s_Î±}, [ğ²_{l^Î±áµ¢}]_{i âˆˆ n_Î±}]$, for all $Î±$.

  Let $ğ•_{ğŸš,Ïƒ}$ denote the set of all maps $â„’'_ğŸš(j_{ğŸš,Î±})$ in
  $Ïƒ\Trans_ğŸš$, where $â„’'_ğŸšâˆ¶ \psh[{ğ•ğ•‹[ğ•ğ•‹][ğ”¼ğ•‹]}] â†’ Ïƒ\Trans_ğŸš$ is left
  adjoint to the forgetful functor, say $ğ’°'_ğŸš$, and
  $j_{ğŸš,Î±}âˆ¶ ğ²_{ğ¬(Î±)_D} + âˆ‘_{i âˆˆ n_Î±} ğ²_{(ğ¥^Î±áµ¢)_V} â†’ ğ²_Î±$ denotes the
  analogous cotupling $[ğ²_{s_{ğŸš,Î±}}, [ğ²_{l^{ğŸš,Î±}áµ¢}]_{i âˆˆ n_Î±}]$, for
  all $Î±$.
\end{definition}
\begin{proposition}
  \label{prop:ffbisim-fib}
  We have $ğ…ğ…ğğ¢ğ¬ğ¢ğ¦(Ïƒ\Trans) = \wbotright{ğ•_Ïƒ}$ and
  $ğ…ğ…ğğ¢ğ¬ğ¢ğ¦(Ïƒ\Trans_ğŸš) = \wbotright{ğ•_{ğŸš,Ïƒ}}$.
\end{proposition}
Let us now introduce border arities.  A functor $Fâˆ¶ ğ’ â†’ \psh[ğ”»]$ to
some presheaf category is \alert{familial} iff there exists a functor
$Eâˆ¶ \el(F(1)) â†’ ğ’$ from the \alert{category of
  elements}~\cite[Â§I.5]{MM} of $F(1)$, called the \alert{exponent} of
$F$, such that, we have a natural isomorphism
$$F(C)(d) â‰… âˆ‘_{o âˆˆ F(1)(d)} ğ’(E(d,o),C).$$  Intuitively, elements
$o âˆˆ F(1)(d)$ are operations of output arity $d$, and $E(d,o)$ gives
their input arity.  Morphisms $uâˆ¶ d â†’ d'$ of $ğ”»$ act on $F(C)$ by
precomposition: for any $o' âˆˆ F(1)(d')$, we have a morphism
$(d,o) \xto{uâ†¾o'} (d',o')$ in $\el(F (1))$, where $o = F(1)(u)(o')$ --
which we write $o = o'Â·u$; and the map $F (C) (u)âˆ¶ F(C)(d') â†’ F(C)(d)$
sends any $(o',Ï•âˆ¶ E(d',o') â†’ C)$ to
$(o, E(d,o) \xto{uâ†¾o'} E(d',o') \xto{Ï•} C)$.  This is the basis for
defining border arities.
\begin{definition}\label{def:border}
  Consider a dynamic signature $Î£â‚$ such that the composite
  $Ïƒ\Trans \xto{Î£â‚} Ïƒ\Trans_ğŸš \xto{ğ’°'_ğŸš} \psh[{ğ•ğ•‹[ğ•ğ•‹][ğ”¼ğ•‹]}]$ is
  familial with exponent $E$.  Let us fix $Î± âˆˆ ğ”¼ğ•‹$ and
  $r âˆˆ ğ’°'_ğŸšÎ£â‚(1)(Î±)$.  For any $kâˆ¶ Aâ‚– â†’ Î±$ among
  $I_Î± â‰” \{ s_{ğŸš,Î±},l^{ğŸš,Î±}â‚,â€¦,l^{ğŸš,Î±}_{n_Î±}\}$, we have
  $E(k â†¾ r)âˆ¶ E(Aâ‚–,rÂ·k) â†’ E(Î±,r)$.  The \alert{border arity} $ğ›áµ£$ of
  $r$ is the cotupling
  $[E(kâ†¾r)]_{k âˆˆ I_Î±}âˆ¶ âˆ‘_{k âˆˆ I_Î±} E(A,rÂ·k) â†’ E(Î±,r)$.
\end{definition}

\begin{theorem}\label{thm:cellular}
  For any dynamic signature $Î£â‚âˆ¶ Ïƒ\Trans â†’ Ïƒ\Trans_ğŸš$ such that
  $ğ’°'_ğŸšÎ£â‚$ is familial, $Î£â‚$ preserves functional flexible
  bisimulations iff all border arities are $ğ•_Ïƒ$-cofibrations.
\end{theorem}
\begin{proof}[Proof sketch for ``if'', see~\cref{app:proof-cellular}]
  Consider any $(u,v)âˆ¶ â„’'_ğŸš(j_{ğŸš,Î±}) â†’ Î£â‚(f)$, with $fâˆ¶ A â†’ B$ in
  $ğ…ğ…ğğ¢ğ¬ğ¢ğ¦(Ïƒ\Trans)$. By adjunction, we get
  $(\tilde{u},\tilde{v})âˆ¶ j_{ğŸš,Î±} â†’ ğ’°'_ğŸš(Î£â‚(f))$.  Letting $r$ be the
  composite
  $ğ²_Î± \xto{\tilde{v}} ğ’°'_ğŸš(Î£â‚(B)) \xto{ğ’°'_ğŸš(Î£â‚(!))} ğ’°'_ğŸš(Î£â‚(1))$, we
  use familiality to factor $(\tilde{u},\tilde{v})$ as the solid part
  below.  The result follows from finding $k$ as shown, by
  $ğ›áµ£ âˆˆ \wbotrightleft{ğ•_Ïƒ}$ and $f âˆˆ \wbotright{ğ•_Ïƒ}$.
  \begin{center}
    \hfil
    \diag|baseline=(m-2-1.base)|(.5,1.5){%
      ğ²_{ğ¬(Î±)_D} + âˆ‘_{i âˆˆ n_Î±}  ğ²_{(ğ¥^Î±áµ¢)_V} \& ğ’°'_ğŸš(Î£â‚(âˆ‘_{k âˆˆ I_Î±} E(Aâ‚–,rÂ·k))) \& ğ’°'_ğŸš(Î£â‚(A)) \\
      ğ²_Î± \& ğ’°'_ğŸš(Î£â‚(E(Î±,r))) \& ğ’°'_ğŸš(Î£â‚(B)) %
    }{%
      (m-1-1) edge[loinbat={[ğ’°'_ğŸš(Î£â‚(inâ‚–)) âˆ˜ (rÂ·k,\id)]_{k âˆˆ I_Î±}}{.25}] (m-1-2) %
      edge[labell={j_{ğŸš,Î±}}] (m-2-1) %
      (m-2-1) edge[labelb={(r,\id)}] (m-2-2) %
      (m-2-2) edge[dashed,labelalat={ğ’°'_ğŸš(Î£â‚(k))}{.3}] (m-1-3) %      
      (m-1-2) edge[labell={ğ’°'_ğŸš(Î£â‚(ğ›áµ£))}] (m-2-2) %
      (m-1-2) edge[labela={ğ’°'_ğŸš(Î£â‚(Ïˆ))}] (m-1-3) %
      (m-2-2) edge[labelb={ğ’°'_ğŸš(Î£â‚(Ï•))}] (m-2-3) %
      (m-1-3) edge[labelr={ğ’°'_ğŸš(Î£â‚(f))}] (m-2-3) %
    } \qedhere
  \end{center}
\end{proof}


\begin{example}
  Let us now sketch a proof of \cref{thm:serguei}.  By
  \cref{thm:main,thm:cellular,prop:cx}, it suffices to reconstruct the
  border arity of each rule.  We only treat rule \textsc{(SA)} for
  lack of space: its border arity is the bottom morphism in
\begin{center}
  \Diag{%
    \pbk{m-2-1}{m-2-2}{m-1-2} %
  }{%
    â„’(0_ğ© + 0_ğœ) \& â„’[ğœ] \\
    â„’(0_ğ¯ + 0_ğ© + 0_ğœ) \& A \rlap{,}
  }{%
    (m-1-1) edge[labela={â„’[s_{[ğœ]},l_{[ğœ]}]}] (m-1-2) %
    edge[labell={(eâ‚,E[v\ â–«])}] (m-2-1) %
    (m-2-1) edge[labelb={}] (m-2-2) %
    (m-1-2) edge[labelr={}] (m-2-2) %
  }
\end{center}
with hopefully clear notation.
\end{example}
\begin{example}
  This also works for PCF as in~\cite{DBLP:journals/tcs/Gordon99},
  which we omit for lack of space.
\end{example}

\section{Conclusion and perspectives}\label{sconclu}
We have introduced a categorical framework for applicative
bisimilarity in the presence of operations on terms other than
substitution, and of terms as labels. We have furthermore provided a
notion of signature for generating instances of this framework, and
proved that under suitable hypotheses, notably preservation of
functional flexible bisimulations, applicative bisimilarity in the
generated instance is a congruence. We have finally exhibited a more
concrete sufficient condition in terms of border arities being
cofibrations, which has allowed us to recover congruence of
applicative bisimilarity for $Î»$-calculus with delimited control
operators and PCF.

For future work, we would be interested in further generalising the
framework to cover a kind of adaptation of Howe's method that still
eludes our abstraction efforts, namely (early-style) higher-order
process calculi~\cite{DBLP:conf/concur/LengletS15}.

\bibliography{bib}
%\end{document}

\newpage

\appendix


% Ïƒ
\section{Proof of Theorem~\ref{thm:main}}
\label{app:proof-main-thm}

We assume given a Howe context $â„ = (ğ•ğ•‹,ğ”¼ğ•‹,\source,\but,\labels)$.
To ease readability, we introduce some notations.
\begin{notation}\label{not:diplopic}
  % Given a diplopic $â„$-transition system $G$, we denote
  % $E_G$, $V_G$ and $D_G$ by $Gâ‚$,$Gâ‚€$ and $Gâ‚›$.
    For any $G = (D,V,E,Î³,âˆ‚) âˆˆ â„\Trans_ğŸš$, we let $G_{D,V}$ denote the
    underlying triple $(D,V,{Î³âˆ¶ D â†’ V}) âˆˆ \psh[ğ•ğ•‹]^ğŸš$,  $Gâ‚€$ denote $V$, $Gâ‚$
    denote $E$, and $Gâ‚›$ denote $D$.  Furthermore,
    following \cref{not:Delta}, we denote, e.g., by $Î”_{ğŸš,ğ¬,ğ¥}$ the
    functor mapping any $Î³âˆ¶ D â†’ V$ to $Î”_ğ¬(D) Ã— Î”_ğ¥(V)$. Finally, we
    sometimes treat the projection $G â†¦ G_{D,V}$ as an implicit
    coercion. E.g., we write $Î”_{ğŸš,ğ¬,ğ¥}(G)$ for $Î”_ğ¬(D) Ã— Î”_ğ¥(V)$.
  \end{notation}

\subsection{Basic properties of flexible bisimulation}
In this section, we establish basic properties of flexible
bisimulations.
% (We will heavily use Notation~\ref{not:diplopic}.)
  \begin{proposition}\label{prop:Dl:ra}
    The functor $Î”_\labels$ is a right adjoint, hence in particular it
    preserves all limits.
  \end{proposition}
  \begin{proof}
  The functor $Î”_\labels$ is the nerve functor of
  $\labels$.  It is right adjoint to the left Kan extension
  of $\labels$ along the Yoneda embedding, as in the following diagram.
  \begin{center}
    % file:///home/thirs/github/quiver/src/index.html?q=WzAsMyxbMCwwLCLihIIiXSxbNCwwLCJcXGhhdHvihIJ9Il0sWzIsMiwiXFxoYXR78J2UuX0iXSxbMCwyLCLwnZClIiwyXSxbMCwxLCLwnZCyIl0sWzEsMiwiXFxiYXJ78J2Qi30iLDIseyJjdXJ2ZSI6Mn1dLFsyLDEsIs6UX/CdkKUiLDIseyJjdXJ2ZSI6Mn1dLFs1LDYsIiIsMix7ImxldmVsIjoxLCJzdHlsZSI6eyJuYW1lIjoiYWRqdW5jdGlvbiJ9fV1d
    \begin{tikzcd}[ampersand replacement=\&]
      {ğ”¼ğ•‹} \&\&\&\& {\hat{ğ”¼ğ•‹}} \\
      \\
      \&\& {\hat{ğ•ğ•‹}}
      \arrow["{ğ¥}"', from=1-1, to=3-3]
      \arrow["{ğ²}", from=1-1, to=1-5]
      \arrow[""{name=0, anchor=center, inner sep=0}, "{\bar{ğ¥}}"', curve={height=12pt}, from=1-5, to=3-3]
      \arrow[""{name=1, anchor=center, inner sep=0}, "{Î”_ğ¥}"', curve={height=12pt}, from=3-3, to=1-5]
      \arrow["\dashv"{anchor=center, rotate=-45}, draw=none, from=0, to=1]
    \end{tikzcd}
  \end{center}
  \end{proof}
  Regarding preservation of colimits, the fact that any $\labels(c)$
  is a finite coproduct of representables entails:
  \begin{proposition}\label{prop:Deltal:finitary}
    The functor $Î”_\labels$ is algebraic, and preserves epimorphisms.
  \end{proposition}
  \begin{proof}
    Just for making the proof slicker, we rely on the well-known
    facts~\cite{algebraictheories} that in presheaf categories
    preserving filtered colimits and reflexive coequalisers is
    equivalent to preserving \emph{sifted} colimits. Furthermore, just
    as the covariant hom of any finitely presentable object preserves
    filtered colimits, in a presheaf category the covariant hom of any
    finite coproduct of representable objects preserves sifted
    colimits, hence epimorphisms. The latter fact deals with the second statement.

    For the first, for any sifted colimit $\colimáµ¢ Xáµ¢$ and $c âˆˆ \psh$:
    \begin{center}
      \hfill $\begin{array}[b]{rcll}
                Î”_\labels(\colimáµ¢ Xáµ¢)(c) & = & \psh[ğ•ğ•‹](\labels(c),\colimáµ¢ Xáµ¢) \\
                                         & = & \colimáµ¢
                                               \psh[ğ•ğ•‹](\labels(c),Xáµ¢)
                                         & \mbox{($\labels(c)$ a finite coproduct of representables)} \\
                                         & = & \colimáµ¢ Î”_\labels(Xáµ¢)(c).
       \end{array}$ \qedhere
     \end{center}
   \end{proof}

   \begin{proposition}\label{prop:algra}
     All functors $Î”, Î”_ğ¥, Î”_ğ¬, Î”_ğ­, Î”_{ğ¬,ğ¥},â€¦$ are algebraic right
     adjoints (and preserve epimorphisms).
   \end{proposition}
   \begin{proof}
     Let us first deal with algebraicity. Because algebraic functors
     are closed under pointwise products, it suffices to deal with
     each of $Î”_ğ¥$, $Î”_ğ¬$, and $Î”_ğ­$ in isolation: $Î”_ğ¬$ and $Î”_ğ­$
     are, as restriction functors; $Î”_ğ¥$ is by
     Proposition~\ref{prop:Deltal:finitary}. Finally, in presheaf
     categories, being algebraic entails preservation of epimorphisms.

     For right adjointness, as right adjoints are closed under
     pointwise products (under (co)completeness conditions satisfied
     here), it suffices to show that each of $Î”_ğ¥$, $Î”_ğ¬$, and $Î”_ğ­$
     is a right adjoint.  Again, $Î”_ğ¬$ and $Î”_ğ­$ are, as restriction
     functors; and $Î”_ğ¥$ is by Proposition~\ref{prop:Dl:ra}.
   \end{proof}



   \begin{proposition}\label{prop:algra2}
     All functors $Î”_ğŸš, Î”_{ğŸš,ğ¥}, Î”_{ğŸš,ğ¬}, Î”_{ğŸš,ğ­}, Î”_{ğŸš,ğ¬,ğ¥},â€¦$ are
     algebraic right adjoints and preserve epimorphisms.
   \end{proposition}
   \begin{proof}
     Algebraic functors between presheaf categories automatically
     preserve epimorphisms, so it suffices to prove that all these
     functors are algebraic right adjoints.
     
     Algebraic right adjoints being closed under pointwise finite
     products, it further suffices to prove that each of $Î”_{ğŸš,ğ¥}$,
     $Î”_{ğŸš,ğ¬}$, and $Î”_{ğŸš,ğ­}$ is an algebraic right adjoint.  Now each
     of these functors $Î”_{ğŸš,x}$ is the corresponding functor $Î”â‚“$,
     precomposed with one of the projections $\psh[ğ•ğ•‹]^ğŸš â†’
     \psh[ğ•ğ•‹]$. But each $Î”â‚“$ is an algebraic right adjoint by
     Proposition~\ref{prop:algra}, and projections, being restriction
     functors, are left and right adjoints, hence algebraic right
     adjoints, hence the result.
   \end{proof}

\begin{lemma}
  \label{lem:wpbk}
  In any presheaf category, for any commuting diagram of the form
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMCwwLCJBIl0sWzEsMCwiQSciXSxbMiwwLCJCIl0sWzEsMSwiQyJdLFsyLDEsIkQiXSxbMCwxLCJDJyJdLFswLDFdLFsxLDJdLFsxLDNdLFsyLDRdLFszLDRdLFswLDVdLFs1LDMsIiIsMCx7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dXQ==
\begin{tikzcd}[ampersand replacement=\&]
	A \& {A'} \& B \\
	{C'} \& C \& D
	\arrow[from=1-1, to=1-2]
	\arrow[from=1-2, to=1-3]
	\arrow[from=1-2, to=2-2]
	\arrow[from=1-3, to=2-3]
	\arrow[from=2-2, to=2-3]
	\arrow[from=1-1, to=2-1]
	\arrow[two heads, from=2-1, to=2-2]
\end{tikzcd}    
  \end{center}
  if the exterior rectangle is a pointwise weak pullback and the
  marked morphism is epi, then so is the right-hand square.
\end{lemma}
\begin{proof}
  Straightforward, using the fact that any morphism $ğ²_c â†’ C$ from
  some representable presheaf lifts to $C'$ because epis are pointwise
  in presheaf categories.
\end{proof}

\begin{proposition}\label{prop:flexible-pw-pbk}
  A morphism $Râ†’X$ of diplopic $â„$-transition systems is a functional flexible bisimulation
  iff the following square is a pointwise weak pullback.
  \begin{center}
    % file:///home/thirs/github/quiver/src/index.html?q=WzAsNCxbMCwwLCJS4oKBIl0sWzEsMCwiWF8xIl0sWzAsMSwizpRf8J2QrChSXzApIMOXIM6UX/CdkKUoUl8wKSJdLFsxLDEsIs6UX/CdkKwoWF8wKSDDlyDOlF/wnZClKFhfMCkiXSxbMCwxXSxbMiwzXSxbMCwyXSxbMSwzXV0=
    \begin{tikzcd}[ampersand replacement=\&]
      {Râ‚} \& {X_1} \\
      {Î”_ğ¬(Râ‚›) Ã— Î”_{ğ¥}(R_0)} \& {Î”_ğ¬(Xâ‚›) Ã— Î”_{ğ¥}(X_0)}
      \arrow[from=1-1, to=1-2]
      \arrow[from=2-1, to=2-2]
      \arrow[from=1-1, to=2-1]
      \arrow[from=1-2, to=2-2]
    \end{tikzcd}
  \end{center}
  \end{proposition}

\begin{lemma}\label{lem:bisim:epi}
  For any morphisms $R \xto{f} S \xto{g} X$ in $â„\Trans_ğŸš$
  such that $f_{D,V}âˆ¶ R_{D,V} â†’ S_{D,V}$ is an epi,
  if $gf$ is a functional flexible bisimulation, then so is $g$.
\end{lemma}
\begin{proof}
  We have a diagram
    \begin{center}
    \diag{%
      Râ‚ \& Sâ‚ \& Xâ‚ \\
      Î”_{ğŸš,ğ¬,ğ¥} R_{D,V} \& Î”_{ğŸš,ğ¬,ğ¥} S_{D,V} \& Î”_{ğŸš,ğ¬,ğ¥} X_{D,V}\rlap{,} %
    }{%
      (m-1-1) edge[labela={}] (m-1-2) %
      (m-1-1) edge[labela={}] (m-2-1) %
      (m-2-1) edge[labelb={}] (m-2-2) %
      (m-1-2) edge[labela={}] (m-1-3) %
      edge[labell={}] (m-2-2) %
      (m-2-2) edge[labelb={}] (m-2-3) %
      (m-1-3) edge[labelr={}] (m-2-3) %
    }
  \end{center}
  and want to prove that the right-hand square is a pointwise weak pullback,
  knowing that the outer rectangle is one: this follows readily
  by Lemma~\ref{lem:wpbk} and Proposition~\ref{prop:algra2}.
\end{proof}

\begin{corollary}\label{cor:bisim:epi}
  For any $X âˆˆ â„\Trans_ğŸš$ and span morphism $fâˆ¶ R â†’ S$ in $â„\Trans_ğŸš/XÂ²$
  such that $f_{D,V}$ is an epi, if $R$ is a (bi)simulation, then so
  is $S$.
\end{corollary}
% \begin{proposition}
%   \label{prop:diplopic-comma}
%    Diplopic transition systems are precisely the objects of the oplax
%    limit $â„\Trans_{ğŸš}$ of $Î”_ğŸš$, or equivalently the comma category
%    $\id_{\psh[ğ”¼ğ•‹]} â†“ Î”_ğŸš$.
%  \end{proposition}

\begin{proposition}\label{prop:fib}
  The projection functors $â„\Trans â†’ \psh[ğ•ğ•‹]$ and $ â„\Trans_ğŸš â†’ \psh[ğ•ğ•‹]^ğŸš$ are Grothendieck
  fibrations.
\end{proposition}
\begin{proof}
  This follows readily from the next lemma.
  % , using
  % Propositions~\ref{prop:h-trans-comma} and~\ref{prop:diplopic-comma}.
\end{proof}
\begin{lemma}\label{lem:fib}
  For any functor $Fâˆ¶ ğ€ â†’ ğ$ to some category $ğ$ with pullbacks, the
  projection functor $pâˆ¶ ğ/F â†’ ğ€$, mapping any object $b â†’ Fa$ to $a$, is
  a Grothendieck fibration.
\end{lemma}
\begin{proof}
  Given any object $xâˆ¶ b â†’ Fa$ and morphism $fâˆ¶ a' â†’ a$, a cartesian
  lifting is given by the following pullback,
  \begin{center}
    \Diag{%
      \stdpbk
    }{%
      \restr{b}{a'} \& b \\
      Fa' \& Fa %
    }{%
      (m-1-1) edge[labela={\mrestr{x}{f}}] (m-1-2) %
      edge[labell={\restr{x}{f}}] (m-2-1) %
      (m-2-1) edge[labelb={Ff}] (m-2-2) %
      (m-1-2) edge[labelr={x}] (m-2-2) %
    }%
  \end{center}
  cartesianness being ensured by universal property of pullback.
\end{proof}
\begin{definition}\label{def:flexible}
  A span $R â†’ XÃ—Y$ of diplopic $â„$-transition systems (resp. diplopic
  $Ïƒ$-transition systems for any enhanced syntax $Ïƒ$) is a \alert{flexible simulation} if its left-hand leg
  $R â†’ X$ is a functional flexible bisimulation, and a \alert{flexible
    bisimulation} when both of its legs are.

  % A morphism of diplopic $Î´$-transition systems is a \alert{flexible
  %   functional bisimulation} iff the underlying morphism of diplopic
  % $â„$-transition systems is, and similarly for flexible bisimulations
  % and flexible bisimulation relations.

  By convention, for any $R âˆˆ \psh[ğ•ğ•‹]^ğŸš$ and $X âˆˆ â„\Trans_ğŸš$, a span
  $R â†’ X_{D,V}Â²$ is a \alert{flexible bisimulation} when the cartesian
  lifting $R^â‡‘ â†’ XÂ²$ (in the sense of Proposition~\ref{prop:fib}) of
  $X$ along $R â†’ X_{D,V}Â²$ is.
\end{definition}

\begin{proposition}\label{prop:simliftmax}
  If a span $R â†’ XÂ²$ is a flexible (bi)simulation, then
  so is the cartesian lifting $R_{D,V}^â‡‘ â†’ XÂ²$.
\end{proposition}
\begin{proof}
  By Corollary~\ref{cor:bisim:epi} applied to the span morphism
  $R â†’ R_{D,V}^â‡‘$.
\end{proof}


   
\begin{lemma}\label{lem:laxlim:sepimono}
  Consider any pullback-preserving functor $Fâˆ¶ ğ€ â†’ ğ$ between
  categories with pullbacks and (strong epi-mono)
  factorisations. Then:
  \begin{romanenumerate}
  \item \label{item:laxlim:monos} A morphism $(f,g)$ in $ğ/F$ is monic
    iff both $f$ and $g$ are.
  \item \label{item:laxlim:sepi} A morphism $(f,g)$ in $ğ/F$ is a
    strong epi iff both $f$ and $g$ are.
  \item \label{item:laxlim:sepimono} The forgetful functor
    $ğ/F â†’ ğÃ—ğ€$ creates, hence preserves, (strong epi-mono)
    factorisations.
\end{romanenumerate}
\end{lemma}
\begin{proof}
  First of all, the forgetful functor creates all colimits, and all
  limits that $F$ preserves, hence in particular pullbacks.
  Furthermore, in any category $ğ‚$, a morphism $fâˆ¶ X â†’ Y$ is monic iff
  its \alert{self square}
  \begin{center}
    \diag{%
      X \& X \\
      X \& Y %
    }{%
      (m-1-1) edge[identity,labela={}] (m-1-2) %
      edge[identity,labell={}] (m-2-1) %
      (m-2-1) edge[labelb={f}] (m-2-2) %
      (m-1-2) edge[labelr={f}] (m-2-2) %
    }
  \end{center}
  is a pullback.  Thus, a morphism $(f,g)$ in $ğ/F$ is mono iff its
  self square is a pullback, iff the self squares of $f$ and $g$ are
  both pullbacks, iff $f$ and $g$ are both monic. This
  settles~\cref{item:laxlim:monos}.

  We next deal with the `if' part of~\cref{item:laxlim:sepi}, consider
  any diagram like the solid part in
  \begin{center}
    % https://q.uiver.app/?q=WzAsOCxbMCwwLCJiIl0sWzAsMiwiRmEiXSxbMSwxLCJiJyJdLFsxLDMsIkZhJyJdLFsyLDAsImQiXSxbMiwyLCJGYyJdLFszLDEsImQnIl0sWzMsMywiRmMnIl0sWzAsMSwieCIsMl0sWzAsMiwiZSIsMix7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFsyLDMsIngnIiwyLHsibGFiZWxfcG9zaXRpb24iOjcwfV0sWzEsMywiRnIiLDIseyJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJlcGkifX19XSxbMCw0LCJmIiwwLHsibGFiZWxfcG9zaXRpb24iOjIwfV0sWzQsNSwieSIsMix7ImxhYmVsX3Bvc2l0aW9uIjoyMH1dLFsxLDUsIkZnIiwwLHsibGFiZWxfcG9zaXRpb24iOjIwfV0sWzQsNiwibSIsMCx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Imhvb2siLCJzaWRlIjoidG9wIn19fV0sWzYsNywieSciXSxbMiw2LCJoIiwyLHsibGFiZWxfcG9zaXRpb24iOjIwfV0sWzMsNywiRmoiLDIseyJsYWJlbF9wb3NpdGlvbiI6MjB9XSxbNSw3LCJGcyIsMCx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Imhvb2siLCJzaWRlIjoidG9wIn19fV0sWzIsNCwiayIsMCx7InN0eWxlIjp7ImJvZHkiOnsibmFtZSI6ImRhc2hlZCJ9fX1dLFszLDUsIkZsIiwwLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV1d
\begin{tikzcd}[ampersand replacement=\&]
	b \&\& d \\
	\& {b'} \&\& {d'} \\
	Fa \&\& Fc \\
	\& {Fa'} \&\& {Fc'\rlap{,}}
	\arrow["x"', from=1-1, to=3-1]
	\arrow["e"', two heads, from=1-1, to=2-2]
	\arrow["Fr"', two heads, from=3-1, to=4-2]
	\arrow["f"{pos=0.2}, from=1-1, to=1-3]
	\arrow["y"'{pos=0.2}, from=1-3, to=3-3]
	\arrow["Fg"{pos=0.2}, from=3-1, to=3-3]
	\arrow["m", hook, from=1-3, to=2-4]
	\arrow["{y'}", from=2-4, to=4-4]
	\arrow["Fj"'{pos=0.2}, from=4-2, to=4-4]
	\arrow["Fs", hook, from=3-3, to=4-4]
	\arrow["k", dashed, from=2-2, to=1-3]
	\arrow["Fl", dashed, from=4-2, to=3-3]
	\arrow["{x'}"'{pos=0.7}, crossing over, from=2-2, to=4-2]
	\arrow["h"'{pos=0.2}, crossing over, from=2-2, to=2-4]
\end{tikzcd}
  \end{center}
  where $e$ and $r$ are strong epis and $m$ and $s$ are monos.  By
  orthogonality, we find unique liftings $k$ and $l$ making all four
  triangles commute (without $F$ on the bottom face). It remains to
  show that the vertical, diagonal square commutes: this follows by
  orthogonality using the fact that $Fs$ is monic (because $F$
  preserves pullbacks, hence monos).
  
  For~\cref{item:laxlim:sepimono}, consider any objects
  $xâˆ¶ b â†’ Fa$ and $x'âˆ¶ b' â†’ Fa'$, and let $fâˆ¶ b â†’ b'$ and $gâˆ¶ a â†’ a'$
  make the following diagram commute.
  \begin{center}
    \diag{%
      b \& b' \\
      Fa \& Fa' %
    }{%
      (m-1-1) edge[labela={f}] (m-1-2) %
      edge[labell={x}] (m-2-1) %
      (m-2-1) edge[labelb={Fg}] (m-2-2) %
      (m-1-2) edge[labelr={x'}] (m-2-2) %
    }
  \end{center}
  Let now $b \xonto{e} b'' \xinto{m} b'$ and
  $a \xonto{r} a'' \xinto{s} a'$ be (strong epi-mono) factorisations
  of $f$ and $g$, respectively. Because $F$ preserves monos, $Fs$ is a
  mono, hence by orthogonality we find a unique lifting making both
  squares commute in
  \begin{center}
    \diag{%
      b  \& b''  \& b'  \\
      Fa \& Fa'' \& Fa'\rlap{.} %
    }{%
      (m-1-1) edge[onto,labela={e}] (m-1-2) %
      edge[labell={x}] (m-2-1) %
      (m-2-1) edge[onto,labelb={Fr}] (m-2-2) %
      (m-1-2) edge[dashed,labelr={x''}] (m-2-2) %
      %
      (m-1-2) edge[into,labela={m}] (m-1-3) %
      (m-2-2) edge[into,labelb={Fs}] (m-2-3) %
      (m-1-3) edge[labelr={x'}] (m-2-3) %
    }
  \end{center}
  Furthermore, by~\cref{item:laxlim:monos} and~\cref{item:laxlim:sepi},
  this lifting is in fact a (strong epi-mono) factorisation of
  $(f,g)$, as desired. Preservation follows from (strong epi-mono)
  factorisations being unique up to unique isomorphism and existing in
  $ğÃ—ğ€$ by hypothesis.

  Finally, for the `only if' part of~\cref{item:laxlim:sepi}: a
  morphism is a strong epi iff the monic part of its (strong epi-mono)
  factorisation is an isomorphism. So given a strong epi $(e,r)$ in
  $ğ/F$, we compute its (strong epi-mono) factorisations $mâˆ˜e'$ and
  $sâˆ˜r'$ of $e$ and $r$, respectively.  By~\cref{item:laxlim:sepimono},
  they lift uniquely to a (strong epi-mono) factorisation
  $(m,s)âˆ˜(e',r')$ of $(e,r)$ in $ğ/F$.  But $(e',r')$ is a strong epi
  by~\cref{item:laxlim:sepi}, and so is $(e,r)$ by hypothesis, and
  $(m,s)$ is a mono between them, hence an isomorphism by
  Lemma~\ref{lem:sepi:mor:iso}. Thus, $m$ and $s$ are both
  isomorphisms, and hence $e$ and $r$ are both strong epis, as
  desired.
\end{proof}


\begin{lemma}\label{lem:diplopic:colims}
The forgetful functor
  $$â„\Trans_ğŸš â†’ \psh[ğ”¼ğ•‹] Ã— \psh[ğ•ğ•‹]Â²$$
  creates all colimits and limits, as well as (strong epi)-mono factorisations.
\end{lemma}
\begin{proof}
  This is clear for colimits. For limits, the projection
  $â„\Trans_ğŸš â†’ \psh[ğ”¼ğ•‹] Ã— \psh[ğ•ğ•‹]^ğŸš$ creates all limits that the functor
  $Î”_ğŸš$ preserves (because $â„\Trans_ğŸš$ is its lax limit), i.e., all of
  them by Proposition~\ref{prop:algra2}.  For (strong epi)-mono
  factorisations, this follows by Lemma~\ref{lem:laxlim:sepimono}.
\end{proof}

\begin{lemma}\label{lem:diplopic:span:colims}
  For any diplopic $â„$-transition system $X$, the forgetful functor
  $$â„\Trans_ğŸš/XÂ² â†’ â„\Trans_ğŸš â†’ \psh[ğ”¼ğ•‹] Ã— \psh[ğ•ğ•‹]Â²$$
  creates all colimits and connected limits.
\end{lemma}
\begin{proof}
  The projection $(â„\Trans_ğŸš)/XÂ² â†’ â„\Trans_ğŸš$ creates colimits and
  connected limits, as any projection from a slice category does.
  The result thus follows by Lemma~\ref{lem:diplopic:colims}.
\end{proof}


\begin{lemma}\label{lem:filtered:flex:filtered}
  Flexible bisimulations are closed under filtered colimits in
  $â„\Trans_ğŸš^ğŸš$, i.e., in the arrow category of $â„\Trans_ğŸš$.
\end{lemma}
\begin{proof}
  Let $(r_âˆâˆ¶ R_âˆ â†’ X_âˆ) = \colimâ±¼ (râ±¼âˆ¶ Râ±¼ â†’ Xâ±¼)$ denote the colimit of
  any filtered digaram of functional flexible bisimulations.  By
  Lemma~\ref{lem:diplopic:span:colims} and the fact that colimits are
  pointwise in the arrow category, we have
  \begin{mathpar}
    (R_âˆ)â‚€ â‰… \colimâ±¼ (R (j) â‚€) \and (R_âˆ)â‚› â‰… \colimâ±¼ (R (j) â‚›) \and
    (R_âˆ)â‚ â‰… \colimâ±¼ (R (j) â‚)
  \end{mathpar}
  and
  \begin{mathpar}
    (X_âˆ)â‚€ â‰… \colimâ±¼ (X (j) â‚€) \and (X_âˆ)â‚› â‰… \colimâ±¼ (X (j) â‚›) \and
    (X_âˆ)â‚ â‰… \colimâ±¼ (X (j) â‚)\rlap{.}
  \end{mathpar}
  Furthermore,
all morphisms
\begin{mathpar}
Î³_{R_âˆ}âˆ¶ (R_âˆ)â‚› â†’ (R_âˆ)â‚€ \and
  âˆ‚_{R_âˆ}âˆ¶ (R_âˆ)â‚ â†’ Î”_ğŸš (R_âˆ) \\
Î³_{X_âˆ}âˆ¶ (X_âˆ)â‚› â†’ (X_âˆ)â‚€ \and
  âˆ‚_{X_âˆ}âˆ¶ (X_âˆ)â‚ â†’ Î”_ğŸš (X_âˆ) \\
  (r_âˆ)â‚âˆ¶ (R_âˆ)â‚ â†’ (X_âˆ)â‚ \and (r_âˆ)â‚›âˆ¶ (R_âˆ)â‚› â†’ (X_âˆ)â‚› \and (r_âˆ)â‚€âˆ¶ (R_âˆ)â‚€ â†’ (X_âˆ)â‚€
\end{mathpar}
are induced by universal property.

Now consider any $p$ and $q$ making
the following diagram commute.
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNCxbMCwwLCLwnZCyX2MiXSxbMCwyLCLOlF978J2QpSzwnZCtfShSX+KIninigoAiXSxbMiwyLCLOlF978J2QpSzwnZCtfVjigoAiXSxbMiwwLCJY4oKBIl0sWzMsMiwiWF/iiIIgIl0sWzEsMiwizpRfe/CdkKUs8J2QrX3PgOKCgSIsMl0sWzAsMywicSJdLFswLDEsInAiLDJdXQ==
\begin{tikzcd}[ampersand replacement=\&]
	{ğ²_c} \&\& {(X_âˆ)â‚} \\
	\\
	{Î”_{ğŸš,ğ¬,ğ¥}(R_âˆ)} \&\& {Î”_{ğŸš,ğ¬,ğ¥}(X_âˆ)}
	\arrow["{âˆ‚_{X_âˆ} }", from=1-3, to=3-3]
	\arrow["{Î”_{ğŸš,ğ¬,ğ¥}r_âˆ}"', from=3-1, to=3-3]
	\arrow["q", from=1-1, to=1-3]
	\arrow["p"', from=1-1, to=3-1]
\end{tikzcd}    
\end{center}
The functor $Î”_{ğŸš,ğ¬,ğ¥}$ is finitary, and the object $ğ²_c$ finitely
presentable, so $p$ factors through some $Î”_{ğŸš,ğ¬,ğ¥}(Râ‚–)$, say as $pâ‚–$,
and  $q$ factors through some $(Xâ‚—)â‚$, say as $qâ‚—$.
Furthermore, by filteredness, we find $h$ and morphisms $k \xto{f} h \xot{g} l$, so that we may
define $pâ‚•$ and $qâ‚•$ as in the following diagram.
\begin{center}
  % file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMCwyLCLwnZCyX2MiXSxbMiw0LCLOlF97XFxtYXRoYmJ7Mn0s8J2QpSzwnZCtfShSX2gpIl0sWzQsMiwizpRfe1xcbWF0aGJiezJ9LPCdkKUs8J2QrX0oWF9oKSJdLFsyLDAsIihYX2gp4oKBIl0sWzEsMywizpRfe1xcbWF0aGJiezJ9LPCdkKws8J2QpX0oUuKClikiXSxbMSwxLCIoWF9sKV8xIl0sWzMsMiwi4oiCXntYX2h9Il0sWzEsMiwizpRfe1xcbWF0aGJiezJ9LPCdkKws8J2QpX0oKHJfaClfezAsc30pIiwyXSxbMCwzLCJx4oKVIiwwLHsiY3VydmUiOi01fV0sWzQsMSwizpRfe1xcbWF0aGJiezJ9LPCdkKws8J2QpX0oUl9mKSIsMCx7ImxhYmVsX3Bvc2l0aW9uIjo4MH1dLFswLDQsInBfayJdLFswLDEsInDigpUiLDIseyJjdXJ2ZSI6NX1dLFs1LDMsIihYX2cpXzEiLDJdLFswLDUsInFfbCIsMl1d
\begin{tikzcd}[ampersand replacement=\&]
	\&\& {(X_h)â‚} \\
	\& {(X_l)_1} \\
	{ğ²_c} \&\&\&\& {Î”_{\mathbb{2},ğ¥,ğ­}(X_h)} \\
	\& {Î”_{\mathbb{2},ğ¬,ğ¥}(Râ‚–)} \\
	\&\& {Î”_{\mathbb{2},ğ¥,ğ­}(R_h)}
	\arrow["{âˆ‚_{X_h}}", from=1-3, to=3-5]
	\arrow["{Î”_{\mathbb{2},ğ¬,ğ¥}((r_h)_{D,V})}"', from=5-3, to=3-5]
	\arrow["{qâ‚•}", curve={height=-30pt}, from=3-1, to=1-3]
	\arrow["{Î”_{\mathbb{2},ğ¬,ğ¥}(R_f)}"{pos=0.8}, from=4-2, to=5-3]
	\arrow["{p_k}", from=3-1, to=4-2]
	\arrow["{pâ‚•}"', curve={height=30pt}, from=3-1, to=5-3]
	\arrow["{(X_g)_1}"', from=2-2, to=1-3]
	\arrow["{q_l}"', from=3-1, to=2-2]
\end{tikzcd}
\end{center}
Because the following diagram commutes,
\begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsOCxbMCwyLCLwnZCyX2MiXSxbMiwzLCLOlF97XFxtYXRoYmJ7Mn0s8J2QpSzwnZCtfShSX2gpIl0sWzMsMiwizpRfe1xcbWF0aGJiezJ9LPCdkKUs8J2QrX0oWF9oKSJdLFsyLDEsIihYX2gp4oKBIl0sWzUsMiwizpRfe1xcbWF0aGJiezJ9LPCdkKUs8J2QrX0oWF/iiJ4pIl0sWzMsMCwiKFhf4oieKeKCgSJdLFszLDQsIs6UX3tcXG1hdGhiYnsyfSzwnZClLPCdkK19KFJf4oieKSJdLFsyLDIsIj8iXSxbMywyLCLiiIJee1hfaH0iLDAseyJsYWJlbF9wb3NpdGlvbiI6ODAsImN1cnZlIjotMX1dLFsxLDIsIs6UX3tcXG1hdGhiYnsyfSzwnZCsLPCdkKV9KChyX2gpX3swLHN9KSIsMix7ImxhYmVsX3Bvc2l0aW9uIjoxMDAsImN1cnZlIjoxfV0sWzAsMywiceKClSIsMix7ImN1cnZlIjotMX1dLFswLDEsInDigpUiLDAseyJjdXJ2ZSI6MX1dLFsyLDRdLFswLDUsInEiLDAseyJjdXJ2ZSI6LTN9XSxbNSw0LCLiiIJee1hf4oiefSIsMCx7ImN1cnZlIjotM31dLFswLDYsInAiLDIseyJjdXJ2ZSI6M31dLFs2LDQsIs6UX3tcXG1hdGhiYnsyfSzwnZCsLPCdkKV9KHJf4oieKSIsMix7ImN1cnZlIjozfV0sWzMsNV0sWzEsNl1d
\begin{tikzcd}[ampersand replacement=\&]
	\&\&\& {(X_âˆ)â‚} \\
	\&\& {(X_h)â‚} \\
	{ğ²_c} \&\& {?} \& {Î”_{\mathbb{2},ğ¥,ğ­}(X_h)} \&\& {Î”_{\mathbb{2},ğ¥,ğ­}(X_âˆ)} \\
	\&\& {Î”_{\mathbb{2},ğ¥,ğ­}(R_h)} \\
	\&\&\& {Î”_{\mathbb{2},ğ¥,ğ­}(R_âˆ)}
	\arrow["{âˆ‚_{X_h}}"{pos=0.8}, curve={height=-6pt}, from=2-3, to=3-4]
	\arrow["{Î”_{\mathbb{2},ğ¬,ğ¥}((r_h)_{D,V})}"'{pos=1}, curve={height=6pt}, from=4-3, to=3-4]
	\arrow["{qâ‚•}"', curve={height=-6pt}, from=3-1, to=2-3]
	\arrow["{pâ‚•}", curve={height=6pt}, from=3-1, to=4-3]
	\arrow[from=3-4, to=3-6]
	\arrow["q", curve={height=-18pt}, from=3-1, to=1-4]
	\arrow["{âˆ‚_{X_âˆ}}", curve={height=-18pt}, from=1-4, to=3-6]
	\arrow["p"', curve={height=18pt}, from=3-1, to=5-4]
	\arrow["{Î”_{\mathbb{2},ğ¬,ğ¥}(r_âˆ)}"', curve={height=18pt}, from=5-4, to=3-6]
	\arrow[from=2-3, to=1-4]
	\arrow[from=4-3, to=5-4]
\end{tikzcd}
\end{center}
by filteredness, we find some $j$ and morphism $uâˆ¶ h â†’ j$ such that
$Î”_{ğŸš,ğ¬,ğ¥}Xáµ¤$ coequalises the question marked parallel pair above.
We then define $pâ±¼$ and $qâ±¼$ by composition to obtain a commuting diagram
as the following
\begin{center}
  % file:///home/thirs/github/quiver/src/index.html?q=WzAsOCxbMCwyLCLwnZCyX2MiXSxbMiwzLCLOlF97XFxtYXRoYmJ7Mn0s8J2QpSzwnZCtfShSX2gpIl0sWzMsMiwizpRfe1xcbWF0aGJiezJ9LPCdkKUs8J2QrX0oWF9oKSJdLFsyLDEsIihYX2gp4oKBIl0sWzUsMiwizpRfe1xcbWF0aGJiezJ9LPCdkKUs8J2QrX0oWF9qKSJdLFszLDAsIihYX2op4oKBIl0sWzMsNCwizpRfe1xcbWF0aGJiezJ9LPCdkKUs8J2QrX0oUl9qKSJdLFsyLDIsIj8iXSxbMywyLCLiiIJee1hfaH0iLDAseyJsYWJlbF9wb3NpdGlvbiI6ODAsImN1cnZlIjotMX1dLFsxLDIsIs6UX3tcXG1hdGhiYnsyfSzwnZCsLPCdkKV9KChyX2gpX3swLHN9KSIsMix7ImxhYmVsX3Bvc2l0aW9uIjoxMDAsImN1cnZlIjoxfV0sWzAsMywiceKClSIsMix7ImN1cnZlIjotMX1dLFswLDEsInDigpUiLDAseyJjdXJ2ZSI6MX1dLFsyLDQsIs6UX3tcXG1hdGhiYnsyfSzwnZClLPCdkK19KFhfdSkiXSxbMCw1LCJxX2oiLDAseyJjdXJ2ZSI6LTN9XSxbNSw0LCLiiIJee1hfan0iLDAseyJjdXJ2ZSI6LTN9XSxbMCw2LCJwX2oiLDIseyJjdXJ2ZSI6M31dLFs2LDQsIs6UX3tcXG1hdGhiYnsyfSzwnZCsLPCdkKV9KHJfaikiLDIseyJjdXJ2ZSI6M31dLFszLDUsIihYX3UpXzEiLDJdLFsxLDYsIs6UX3tcXG1hdGhiYnsyfSzwnZClLPCdkK19KFJfdSkiLDAseyJsYWJlbF9wb3NpdGlvbiI6OTB9XV0=
\begin{tikzcd}[ampersand replacement=\&]
	\&\&\& {(X_j)â‚} \\
	\&\& {(X_h)â‚} \\
	{ğ²_c} \&\& {?} \& {Î”_{\mathbb{2},ğ¥,ğ­}(X_h)} \&\& {Î”_{\mathbb{2},ğ¥,ğ­}(X_j)} \\
	\&\& {Î”_{\mathbb{2},ğ¥,ğ­}(R_h)} \\
	\&\&\& {Î”_{\mathbb{2},ğ¥,ğ­}(R_j)}
	\arrow["{âˆ‚_{X_h}}"{pos=0.8}, curve={height=-6pt}, from=2-3, to=3-4]
	\arrow["{Î”_{\mathbb{2},ğ¬,ğ¥}((r_h)_{D,V})}"'{pos=1}, curve={height=6pt}, from=4-3, to=3-4]
	\arrow["{qâ‚•}"', curve={height=-6pt}, from=3-1, to=2-3]
	\arrow["{pâ‚•}", curve={height=6pt}, from=3-1, to=4-3]
	\arrow["{Î”_{\mathbb{2},ğ¥,ğ­}(X_u)}", from=3-4, to=3-6]
	\arrow["{q_j}", curve={height=-18pt}, from=3-1, to=1-4]
	\arrow["{âˆ‚_{X_j}}", curve={height=-18pt}, from=1-4, to=3-6]
	\arrow["{p_j}"', curve={height=18pt}, from=3-1, to=5-4]
	\arrow["{Î”_{\mathbb{2},ğ¬,ğ¥}(r_j)}"', curve={height=18pt}, from=5-4, to=3-6]
	\arrow["{(X_u)_1}"', from=2-3, to=1-4]
	\arrow["{Î”_{\mathbb{2},ğ¥,ğ­}(R_u)}"{pos=0.9}, from=4-3, to=5-4]
\end{tikzcd}
\end{center}
(where again the question marked parallel pair may not commute but the exterior does).

We thus obtain a situation like
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsOSxbMCwwLCLwnZCyX2MiXSxbMSwzLCIoUl/iiJ4p4oKBIl0sWzEsNSwizpRfe1xcbWF0aGJiezJ9LPCdkKUs8J2QrX0oUl/iiJ4pIl0sWzQsNSwizpRfe1xcbWF0aGJiezJ9LPCdkKUs8J2QrX0oWF/iiJ4pLiJdLFs0LDMsIihYX+KIninigoEiXSxbMCw0LCLOlF97XFxtYXRoYmJ7Mn0s8J2QrCzwnZClfShS4rG8KSJdLFswLDIsIihSX2op4oKBIl0sWzMsMiwiKFhfailfMSJdLFszLDQsIs6UX3tcXG1hdGhiYnsyfSzwnZCsLPCdkKV9KFjisbwpIl0sWzEsMiwi4oiCXntSX+KInn0iLDAseyJsYWJlbF9wb3NpdGlvbiI6MjB9XSxbNCwzLCLiiIJee1hf4oiefSJdLFsyLDMsIs6UX3tcXG1hdGhiYnsyfSzwnZCsLPCdkKV9KChyX+KInilfezAsc30pIiwyXSxbMSw0LCIocl/iiJ4p4oKBIiwwLHsibGFiZWxfcG9zaXRpb24iOjIwfV0sWzAsNCwicSIsMCx7ImN1cnZlIjotNH1dLFs1LDJdLFswLDUsInBfaiIsMix7ImN1cnZlIjo0fV0sWzYsNSwi4oiCXntS4rG8fSJdLFs2LDFdLFswLDYsIm0iLDAseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJkYXNoZWQifX19XSxbMCwyLCJwIiwwLHsibGFiZWxfcG9zaXRpb24iOjIwLCJjdXJ2ZSI6LTF9XSxbNSw4LCLOlF97XFxtYXRoYmJ7Mn0s8J2QrCzwnZClfSgocuKxvClfezAsc30pIiwyLHsibGFiZWxfcG9zaXRpb24iOjgwfV0sWzgsM10sWzcsOCwi4oiCXntY4rG8fSIsMix7ImxhYmVsX3Bvc2l0aW9uIjoyMH1dLFs2LDcsIihy4rG8KeKCgSJdLFs3LDRdLFswLDcsInFfaiIsMl1d
\begin{tikzcd}[ampersand replacement=\&]
	{ğ²_c} \\
	\\
	{(R_j)â‚} \&\&\& {(X_j)_1} \\
	\& {(R_âˆ)â‚} \&\&\& {(X_âˆ)â‚} \\
	{Î”_{\mathbb{2},ğ¬,ğ¥}(Râ±¼)} \&\&\& {Î”_{\mathbb{2},ğ¬,ğ¥}(Xâ±¼)} \\
	\& {Î”_{\mathbb{2},ğ¥,ğ­}(R_âˆ)} \&\&\& {Î”_{\mathbb{2},ğ¥,ğ­}(X_âˆ).}
	\arrow["{âˆ‚_{R_âˆ}}"{pos=0.2}, from=4-2, to=6-2]
	\arrow["{âˆ‚_{X_âˆ}}", from=4-5, to=6-5]
	\arrow["{Î”_{\mathbb{2},ğ¬,ğ¥}((r_âˆ)_{D,V})}"', from=6-2, to=6-5]
	\arrow["{(r_âˆ)â‚}"{pos=0.2}, from=4-2, to=4-5]
	\arrow["q", curve={height=-24pt}, from=1-1, to=4-5]
	\arrow[from=5-1, to=6-2]
	\arrow["{p_j}"', curve={height=24pt}, from=1-1, to=5-1]
	\arrow["{âˆ‚_{Râ±¼}}", from=3-1, to=5-1]
	\arrow[from=3-1, to=4-2]
	\arrow["m", dashed, from=1-1, to=3-1]
	\arrow["{Î”_{\mathbb{2},ğ¬,ğ¥}((râ±¼)_{D,V})}"'{pos=0.8}, from=5-1, to=5-4]
	\arrow[from=5-4, to=6-5]
	\arrow["{âˆ‚_{Xâ±¼}}"'{pos=0.2}, from=3-4, to=5-4]
	\arrow["{(râ±¼)â‚}", from=3-1, to=3-4]
	\arrow[from=3-4, to=4-5]
	\arrow["{q_j}"', from=1-1, to=3-4]
	\arrow["p"{pos=0.2}, fore, curve={height=-6pt}, from=1-1, to=6-2]
      \end{tikzcd}
    \end{center}
  But $râ±¼âˆ¶ Râ±¼ â†’ Xâ±¼$ is a functional flexible bisimulation, so we find a mediating arrow
  $m$ as shown.  The composite
  $$ğ²_c \xto{m} (Râ±¼)â‚ â†’ (R_âˆ)â‚$$
  finally provides the desired mediating arrow.
\end{proof}

\begin{corollary}\label{cor:filtered:flex:filtered}
  For any diplopic $â„$-transition system $X$, flexible bisimulations $R â†’ XÂ²$
  over $X$ are closed under filtered colimits in $â„\Trans_ğŸš/XÂ²$.
\end{corollary}

\begin{lemma}\label{lem:filtered:flex:compo}
  For any diplopic $â„$-transition system $X$, flexible bisimulations $R â†’ XÂ²$
  over $X$ are closed under span composition.
\end{lemma}
\begin{proof}
  We need to show that the square
  \begin{center}
    % % file:///home/thirs/github/quiver/src/index.html?q=WzAsNCxbMCwwLCIoUjtTKeKCgSJdLFswLDEsIs6UX3vwnZ+aLPCdkKws8J2QpX0oUjtTKSJdLFsyLDEsIs6UX3vwnZ+aLPCdkKws8J2QpX1YIl0sWzIsMCwiWOKCgSJdLFswLDFdLFszLDJdLFswLDMsIs+A4oKBIl0sWzEsMiwizpRfe/Cdn5os8J2QrCzwnZClfc+A4oKBIiwyXV0=
\begin{tikzcd}[ampersand replacement=\&]
	{(R;S)â‚} \&\& {Xâ‚} \\
	{Î”_{ğŸš,ğ¬,ğ¥}(R;S)} \&\& {Î”_{ğŸš,ğ¬,ğ¥}X}
	\arrow[from=1-1, to=2-1]
	\arrow[from=1-3, to=2-3]
	\arrow["{Ï€â‚}", from=1-1, to=1-3]
	\arrow["{Î”_{ğŸš,ğ¬,ğ¥}Ï€â‚}"', from=2-1, to=2-3]
\end{tikzcd}
  \end{center}
  is a pointwise weak pullback.
  By construction, this square factors as
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMCwwLCIoUjtTKeKCgSJdLFswLDEsIs6UX3vwnZ+aLPCdkKws8J2QpX0oUjtTKSJdLFsyLDEsIs6UX3vwnZ+aLPCdkKws8J2QpX1YIl0sWzIsMCwiWOKCgSJdLFsxLDAsIlLigoEiXSxbMSwxLCLOlF978J2fmizwnZCsLPCdkKV9UiJdLFswLDFdLFszLDJdLFsxLDUsIs6UX3vwnZ+aLPCdkKws8J2QpX3PgOKCgSIsMl0sWzAsNCwiz4DigoEiXSxbNCwzLCLPgOKCgSJdLFs1LDIsIs6UX3vwnZ+aLPCdkKws8J2QpX3PgOKCgSIsMl0sWzQsNV1d
\begin{tikzcd}[ampersand replacement=\&]
	{(R;S)â‚} \& {Râ‚} \& {Xâ‚} \\
	{Î”_{ğŸš,ğ¬,ğ¥}(R;S)} \& {Î”_{ğŸš,ğ¬,ğ¥}R} \& {Î”_{ğŸš,ğ¬,ğ¥}X}
	\arrow[from=1-1, to=2-1]
	\arrow[from=1-3, to=2-3]
	\arrow["{Î”_{ğŸš,ğ¬,ğ¥}Ï€â‚}"', from=2-1, to=2-2]
	\arrow["{Ï€â‚}", from=1-1, to=1-2]
	\arrow["{Ï€â‚}", from=1-2, to=1-3]
	\arrow["{Î”_{ğŸš,ğ¬,ğ¥}Ï€â‚}"', from=2-2, to=2-3]
	\arrow[from=1-2, to=2-2]
\end{tikzcd}
  \end{center}
  where the right-hand square is a pointwise weak pullback by
  hypothesis.  Now the left-hand square is the left-hand face in the
  following diagram,
\begin{center}
  \Diag{%
    \pbk[2.5em]{m-2-2}{m-1-1}{m-1-3} %
    \pbk[2.5em]{m-4-2}{m-3-1}{m-3-3} %
    \pullbackk{m-3-3}{m-1-3}{m-2-4}{draw,dashed} %
  }{%
	{(R;S)â‚} \&\& {Sâ‚} \\
	\& {Râ‚} \&\& {Xâ‚} \\
	{Î”_{ğŸš,ğ¬,ğ¥}(R;S)} \&\& {Î”_{ğŸš,ğ¬,ğ¥}S} \\
	\& {Î”_{ğŸš,ğ¬,ğ¥}R} \&\& {Î”_{ğŸš,ğ¬,ğ¥}X}
  }{%
    (m-1-1) edge[labela={}] (m-1-3) %
    edge[labell={}] (m-3-1) %
    (m-3-1) edge[labelb={}] (m-3-3) %
    (m-1-3) edge[labelr={}] (m-3-3) %
    %
    (m-2-2) edge[fore,labelaat={Ï€â‚‚}{.2}] (m-2-4) %
    edge[fore,labell={}] (m-4-2) %
    (m-4-2) edge[labelb={Î”_{ğŸš,ğ¬,ğ¥}Ï€â‚‚}] (m-4-4) %
    (m-2-4) edge[labelr={}] (m-4-4) %
    %
    (m-1-1) edge[labela={}] (m-2-2) %
    (m-3-1) edge[labela={}] (m-4-2) %
    (m-1-3) edge[labelar={Ï€â‚}] (m-2-4) %
    (m-3-3) edge[labelar={Î”_{ğŸš,ğ¬,ğ¥}Ï€â‚}] (m-4-4) %
  }%
  \end{center}
  whose top and bottom faces are pullbacks by
  Lemma~\ref{lem:diplopic:span:colims} and the fact that
  $Î”_{ğŸš,ğ¬,ğ¥}âˆ¶ \psh[ğ•ğ•‹]^ğŸš â†’ \psh[ğ”¼ğ•‹]$, being a right adjoint, is continuous.
  Since the right-hand face is a weak pullback by hypothesis,
  so is the left face by \citet[Lemma~9.26, (i),
  then (ii)]{HL}.  We finally conclude by \citet[Lemma~9.26,
  (i)]{HL}.
\end{proof}





\begin{lemma}\label{lem:spancomp:flex}
  For any diplopic $â„$-transition system $X$, flexible bisimulations $R â†’ X_{D,V}Â²$
  over $X$ are closed under span composition.
\end{lemma}
\begin{proof}
  Given any two flexible bisimulations, say $R$ and $S$, we observe
  that there is a projection $Ï€âˆ¶ R^â‡‘;S^â‡‘ â†’ (R;S)^â‡‘$ making the
  following diagram commute.
  \begin{center}
    % file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMSwxLCIoUjtTKV7ihpEiXSxbMCwwLCJSXuKGkTtTXuKGkSJdLFsxLDIsIs6UKFI7UykiXSxbMiwyLCLOlFjigoDCsiJdLFsyLDEsIljigoHCsiJdLFswLDIsIs6UKFIpO86UKFMpIl0sWzEsMCwiz4AiLDJdLFswLDJdLFsyLDNdLFs0LDMsIlhf4oiCIl0sWzAsNF0sWzAsMywiIiwwLHsic3R5bGUiOnsibmFtZSI6ImNvcm5lciJ9fV0sWzEsNV0sWzUsMiwi4omFICIsMl0sWzEsNCwiIiwyLHsiY3VydmUiOi0yfV1d
    \begin{tikzcd}[ampersand replacement=\&]
      {R^â‡‘;S^â‡‘} \\
      \& {(R;S)^â‡‘} \& {Xâ‚Â²} \\
      {Î”_ğŸš(R);Î”_ğŸš(S)} \& {Î”_ğŸš(R;S)} \& {Î”_ğŸšXÂ²}
      \arrow["{Ï€}"', from=1-1, to=2-2]
      \arrow[from=2-2, to=3-2]
      \arrow[from=3-2, to=3-3]
      \arrow["{X_âˆ‚}", from=2-3, to=3-3]
      \arrow[from=2-2, to=2-3]
      \arrow["\lrcorner"{anchor=center, pos=0.125}, draw=none, from=2-2, to=3-3]
      \arrow[from=1-1, to=3-1]
      \arrow["{â‰… }"', from=3-1, to=3-2]
      \arrow[curve={height=-12pt}, from=1-1, to=2-3]
    \end{tikzcd}    
  \end{center}
  To see this, we observe that by interchange of limits
  $R^â‡‘;S^â‡‘$ is the limit of
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsOCxbMCwwLCJY4oKBIl0sWzAsMiwizpRY4oKAIl0sWzIsMSwizpRSIl0sWzQsMiwizpRY4oKAIl0sWzYsMSwizpRTIl0sWzgsMiwizpRY4oKAIl0sWzQsMCwiWOKCgSJdLFs4LDAsIljigoEiXSxbMCwxLCJYX+KIgiIsMl0sWzIsMSwizpTPgOKCgSJdLFsyLDMsIs6Uz4DigoIiLDJdLFs0LDMsIs6Uz4DigoEiXSxbNCw1LCLOlM+A4oKCIiwyXSxbNiwzLCJYX+KIgiIsMl0sWzcsNSwiWF/iiIIiXV0=
\begin{tikzcd}[ampersand replacement=\&]
	{Xâ‚} \&\&\&\& {Xâ‚} \&\&\&\& {Xâ‚} \\
	\&\& {Î”_ğŸšR} \&\&\&\& {Î”_ğŸšS} \\
	{Î”_ğŸšX} \&\&\&\& {Î”_ğŸšX} \&\&\&\& {Î”_ğŸšX}
	\arrow["{X_âˆ‚}"', from=1-1, to=3-1]
	\arrow["{Î”_ğŸšÏ€â‚}", from=2-3, to=3-1]
	\arrow["{Î”_ğŸšÏ€â‚‚}"', from=2-3, to=3-5]
	\arrow["{Î”_ğŸšÏ€â‚}", from=2-7, to=3-5]
	\arrow["{Î”_ğŸšÏ€â‚‚}"', from=2-7, to=3-9]
	\arrow["{X_âˆ‚}"', from=1-5, to=3-5]
	\arrow["{X_âˆ‚}", from=1-9, to=3-9]
\end{tikzcd}    
  \end{center}
  while $(R;S)^â‡‘$ is the limit of
  the following subdiagram.
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNyxbMCwwLCJY4oKBIl0sWzAsMiwizpRY4oKAIl0sWzIsMSwizpRSIl0sWzQsMiwizpRY4oKAIl0sWzYsMSwizpRTIl0sWzgsMiwizpRY4oKAIl0sWzgsMCwiWOKCgSJdLFswLDEsIlhf4oiCIiwyXSxbMiwxLCLOlM+A4oKBIl0sWzIsMywizpTPgOKCgiIsMl0sWzQsMywizpTPgOKCgSJdLFs0LDUsIs6Uz4DigoIiLDJdLFs2LDUsIlhf4oiCIl1d
\begin{tikzcd}[ampersand replacement=\&]
	{Xâ‚} \&\&\&\&\&\&\&\& {Xâ‚} \\
	\&\& {Î”_ğŸšR} \&\&\&\& {Î”_ğŸšS} \\
	{Î”_ğŸšX} \&\&\&\& {Î”_ğŸšX} \&\&\&\& {Î”_ğŸšX}
	\arrow["{X_âˆ‚}"', from=1-1, to=3-1]
	\arrow["{Î”_ğŸšÏ€â‚}", from=2-3, to=3-1]
	\arrow["{Î”_ğŸšÏ€â‚‚}"', from=2-3, to=3-5]
	\arrow["{Î”_ğŸšÏ€â‚}", from=2-7, to=3-5]
	\arrow["{Î”_ğŸšÏ€â‚‚}"', from=2-7, to=3-9]
	\arrow["{X_âˆ‚}", from=1-9, to=3-9]
\end{tikzcd}    
  \end{center}
  Finally, by Lemma~\ref{lem:filtered:flex:compo}, we know that $R^â‡‘;S^â‡‘$ is
  a flexible bisimulation, hence so is $R;S$ by Lemma~\ref{lem:wpbk}.
\end{proof}

\begin{lemma}\label{lem:sepi:mor:iso}
  For any strong epis $eâˆ¶ X â†’ Y$ and $e'âˆ¶ X â†’ Z$, any
  mono $fâˆ¶ Y â†’ Z$ such that $fâˆ˜e = e'$ is an isomorphism.
\end{lemma}
\begin{proof}
  We find a section of $f$ by lifting as in
  \begin{center}
    \diag{%
      X \& Y \\
      Z \& Z\rlap{.} %
    }{%
      (m-1-1) edge[labela={e}] (m-1-2) %
      edge[labell={e'}] (m-2-1) %
      (m-2-1) edge[identity,labelb={}] (m-2-2) %
      (m-1-2) edge[labelr={f}] (m-2-2) %
      (m-2-1) edge[dashed,labelal={l}] (m-1-2) %
    }
  \end{center}
  But $l$ is in fact an inverse by uniqueness of lifting in

  \hfill
    % https://q.uiver.app/?q=WzAsNSxbMCwwLCJYIl0sWzAsMiwiWSJdLFsyLDAsIlkiXSxbMSwxLCJaIl0sWzIsMiwiWiJdLFswLDEsImUiLDJdLFswLDIsImUiXSxbMCwzLCJlJyIsMl0sWzEsNCwiZiIsMl0sWzIsNCwiZiJdLFsxLDMsImYiXSxbMywyLCJsIl0sWzMsNCwiIiwwLHsibGV2ZWwiOjIsInN0eWxlIjp7ImhlYWQiOnsibmFtZSI6Im5vbmUifX19XV0=
\begin{tikzcd}[ampersand replacement=\&,baseline=(\tikzcdmatrixname-3-1.base)]
	X \&\& Y \\
	\& Z \\
	Y \&\& Z\rlap{.}
	\arrow["e"', from=1-1, to=3-1]
	\arrow["e", from=1-1, to=1-3]
	\arrow["{e'}"', from=1-1, to=2-2]
	\arrow["f"', from=3-1, to=3-3]
	\arrow["f", from=1-3, to=3-3]
	\arrow["f", from=3-1, to=2-2]
	\arrow["l", from=2-2, to=1-3]
	\arrow[Rightarrow, no head, from=2-2, to=3-3]
\end{tikzcd}
\end{proof}



\begin{lemma}\label{lem:images:flex}
  For any diplopic $â„$-transition system $X$, flexible bisimulations $R â†’ XÂ²$
  over $X$ are closed under images.
\end{lemma}

\begin{proof}
  Both $\psh[ğ”¼ğ•‹]$ and $\psh[ğ•ğ•‹]^ğŸš$ are (isomorphic to) presheaf categories,
  hence images are computed as (strong epi-mono) factorisations.
  Furthermore, $Î”_ğŸš$ preserves pullbacks by
  Proposition~\ref{prop:algra2}, hence by
  Lemma~\ref{lem:laxlim:sepimono} the forgetful functor
  $â„\Trans_ğŸš â†’ \psh[ğ”¼ğ•‹] Ã— \psh[ğ•ğ•‹]^ğŸš$ creates (strong epi-mono)
  factorisations, hence images.

  
  Now, consider any flexible bisimulation $pâˆ¶ R â†’ XÂ²$.  As we just
  saw, we obtain a (strong epi-mono) factorisation of $p$ by factoring
  $pâ‚$ and $p_{D,V}$.  We then need to show that the square
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNCxbMCwwLCJcXGltKFJfMSkiXSxbMCwxLCLOlF978J2QrCzwnZClfShcXGltKFLigoApKSJdLFsxLDEsIs6UX3vwnZCsLPCdkKV9WOKCgCJdLFsxLDAsIljigoEiXSxbMSwyLCLOlF978J2QrCzwnZClfc+A4oKBIiwyXSxbMywyLCJYX+KIgiJdLFswLDFdLFswLDNdXQ==
\begin{tikzcd}[ampersand replacement=\&]
	{\im(R_1)} \& {Xâ‚} \\
	{Î”_{ğŸš,ğ¬,ğ¥}(\im(R_{D,V}))} \& {Î”_{ğŸš,ğ¬,ğ¥}X}
	\arrow["{Î”_{ğŸš,ğ¬,ğ¥}Ï€â‚}"', from=2-1, to=2-2]
	\arrow["{X_âˆ‚}", from=1-2, to=2-2]
	\arrow[from=1-1, to=2-1]
	\arrow[from=1-1, to=1-2]
      \end{tikzcd}
    \end{center}
    is a pointwise weak pullback.
    But by Proposition~\ref{prop:algra2}, $Î”_{ğŸš,ğ¥,ğ¬}$ preserves epimorphisms. Thus, since the exterior of
    \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMSwwLCJcXGltKFJfMSkiXSxbMSwxLCLOlF978J2QrCzwnZClfShcXGltKFLigoApKSJdLFsyLDEsIs6UX3vwnZCsLPCdkKV9WOKCgCJdLFsyLDAsIljigoEiXSxbMCwwLCJS4oKBIl0sWzAsMSwizpRfe/CdkKws8J2QpX0oUuKCgCkiXSxbMSwyLCLOlF978J2QrCzwnZClfc+A4oKBIiwyXSxbMywyLCJYX+KIgiJdLFswLDFdLFswLDNdLFs1LDEsIiIsMCx7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFs0LDVdLFs0LDBdXQ==
\begin{tikzcd}[ampersand replacement=\&]
	{Râ‚} \& {\im(R_1)} \& {Xâ‚} \\
	{Î”_{ğŸš,ğ¬,ğ¥}(R_{D,V})} \& {Î”_{ğŸš,ğ¬,ğ¥}(\im(R_{D,V}))} \& {Î”_{ğŸš,ğ¬,ğ¥}X}
	\arrow["{Î”_{ğŸš,ğ¬,ğ¥}Ï€â‚}"', from=2-2, to=2-3]
	\arrow["{X_âˆ‚}", from=1-3, to=2-3]
	\arrow[from=1-2, to=2-2]
	\arrow[from=1-2, to=1-3]
	\arrow[two heads, from=2-1, to=2-2]
	\arrow[from=1-1, to=2-1]
	\arrow[from=1-1, to=1-2]
\end{tikzcd}
\end{center}
is a pointwise weak pullback by hypothesis, we conclude by Lemma~\ref{lem:wpbk}.
\end{proof}

\subsection{Composition of flexible and rigid simulations}

Our goal in this subsection is to prove the following.
\begin{lemma}\label{lem:flex:rigid:compo}
  For any $â„$-transition system $X$, diplopic flexible simulation
  $R â†’ XÂ²$, and simulation $Sâ‚€ â†’ Xâ‚€Â²$, equipped with a span
  morphism $Ïâˆ¶ Râ‚€;Sâ‚€ â†’ Râ‚€$, the relation $\im(R; Î¸Sâ‚€)$ is a
  flexible simulation, hence so is $\im(R_{D,V};Sâ‚€)^â‡‘$.
\end{lemma}

In order to prove this smoothly, we introduce the following notion of
triplopic transition system.
\begin{definition}
  Let $â„\Trans_3$ denote the lax limit of
  $\psh[ğ•ğ•‹]Â³ \xto{Î”_ğ¬Ã—Î”_ğ¥Ã—Î”_ğ­} \psh[ğ”¼ğ•‹]$.
  Objects of $â„\Trans_3$ are called \alert{triplopic transition systems}.
\end{definition}
\begin{notation}
  We denote by $Î”â‚ƒ$, $Î”_{3,ğ¬}$, $Î”_{3,ğ¬,ğ¥}$,â€¦ the functors analogous
  to $Î”_ğŸš$, $Î”_{ğŸš,ğ¬}$, $Î”_{ğŸš,ğ¬,ğ¥}$,â€¦,
  and often treat the projection $â„\Transâ‚ƒ â†’ \psh[ğ•ğ•‹]Â³$ as an implicit coercion,
  thus writing, e.g., $Î”_{3,ğ¬,ğ¥}X$ for any $X âˆˆ â„\Transâ‚ƒ$, meaning
  $Î”_ğ¬(Xâ‚›) Ã— Î”_ğ¥(Xâ‚—)$.
\end{notation}
A triplopic transition system $X$ thus consists of presheaves
$Xâ‚›,Xâ‚—,Xâ‚œ âˆˆ \psh[ğ•ğ•‹]$ and $Xâ‚ âˆˆ \psh[ğ”¼ğ•‹]$, together with a morphism
$Xâ‚ â†’ Î”_ğ¬(Xâ‚›)Ã—Î”_ğ¥(Xâ‚—)Ã—Î”_ğ­(Xâ‚œ)$.
\begin{remark}
  We use a boldface $ğŸš$ in $â„\Trans_ğŸš$ and a normal $3$ in $â„\Transâ‚ƒ$,
  to reflect the fact that any diplopic transition system
  $X âˆˆ â„\Trans_ğŸš$ comes with a morphism $Xâ‚› â†’ Xâ‚€$, while there is no
  such requirement for triplopic transition systems.
\end{remark}

Let us readily notice the following useful facts.
\begin{proposition}\label{prop:algra3}
     All functors $Î”_3, Î”_{3,ğ¥}, Î”_{3,ğ¬}, Î”_{3,ğ­}, Î”_{3,ğ¬,ğ¥},â€¦$ are
     algebraic right adjoints and preserve epimorphisms.
   \end{proposition}
   \begin{proof}
     Algebraic functors between presheaf categories automatically
     preserve epimorphisms, so it suffices to prove that all these
     functors are algebraic right adjoints.
     
     Algebraic right adjoints being closed under pointwise finite
     products, it further suffices to prove that each of $Î”_{3,ğ¥}$,
     $Î”_{3,ğ¬}$, and $Î”_{3,ğ­}$ is an algebraic right adjoint.  Now each
     of these functors $Î”_{3,x}$ is the corresponding functor $Î”â‚“$,
     precomposed with one of the projections $\psh[ğ•ğ•‹]^3 â†’
     \psh[ğ•ğ•‹]$. But each $Î”â‚“$ is an algebraic right adjoint by
     Proposition~\ref{prop:algra}, and projections, being restriction
     functors, are left and right adjoints, hence algebraic right
     adjoints, hence the result.
   \end{proof}


\begin{lemma}\label{lem:triplopic:colims}
The forgetful functor
  $$â„\Trans_3 â†’ \psh[ğ”¼ğ•‹] Ã— \psh[ğ•ğ•‹]Â²$$
  creates all colimits and limits, as well as (strong epi)-mono
  factorisations.
\end{lemma}
\begin{proof}
  Just as Lemma~\ref{lem:diplopic:colims}.
\end{proof}


The idea of triplopic transition systems is to unify flexible and
rigid bisimulation into a single framework, while allowing maximal
flexibility in the choice of input and output states, and labels.  Let
us now define (bi)simulation in triplopic transition systems.  We will
then describe embeddings of transition systems and diplopic transition
systems into triplopic transition systems, proving in each case that
the embedding preserves and reflects bisimulation.

\begin{definition}
  A morphism $fâˆ¶ R â†’ X$ of triplopic transition systems is a \alert{functional bisimulation}
  iff the square
  \begin{center}
    \diag{%
      Râ‚ \& Xâ‚ \\
      Î”_{3,ğ¬,ğ¥}R \& Î”_{3,ğ¬,ğ¥}X
    }{%
      (m-1-1) edge[labela={}] (m-1-2) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[labelb={}] (m-2-2) %
      (m-1-2) edge[labelr={}] (m-2-2) %
    }
  \end{center}
  is a pointwise weak pullback.  Spans and relations in $â„\Trans_3$
  are called simulations and bisimulations analogously to the case of
  $â„\Trans_ğŸš$.
\end{definition}


\begin{proposition}
  Mapping any diplopic transition system
  $$(Xâ‚,Î³âˆ¶Xâ‚›â†’Xâ‚€,âˆ‚âˆ¶Xâ‚ â†’ Î”_ğ¬(Xâ‚›) Ã— Î”_{ğ¥,ğ­}(Xâ‚€))$$ to
  $$(Xâ‚,Xâ‚›,Xâ‚€,Xâ‚€,âˆ‚âˆ¶Xâ‚ â†’ Î”_ğ¬(Xâ‚›) Ã— Î”_{ğ¥,ğ­}(Xâ‚€))$$
  yields an embedding $Î¹âˆ¶ â„\Trans_ğŸš â†’ â„\Transâ‚ƒ$.
\end{proposition}
\begin{proof}
  Straightforward.
\end{proof}
\begin{notation}
  By composition with $â„\Trans â†ª â„\Trans_ğŸš$, we obtain a further
  embedding $â„\Trans â†ª â„\Transâ‚ƒ$. Treating the former as an implicit
  coercion, we thus often also merely denote the composite by $Î¹$.
\end{notation}


\begin{proposition}\label{prop:triplopic:sim:reflection}
  A morphism (resp.\ a span) of diplopic transition systems is a
  functional bisimulation (resp.\ a simulation or bisimulation) iff
  its embedding into triplopic transition systems is.
\end{proposition}
\begin{proof}
  Straightforward.
\end{proof}

Beyond the embedding $â„\Trans â†ª â„\Transâ‚ƒ$ that we saw above,
there is the following embedding of spans:
\begin{proposition}
  For any $X âˆˆ â„\Trans$, mapping any span $Râ‚€ â†’ Xâ‚€Â²$ in $\psh[ğ•ğ•‹]$ to
  the triplopic transition system $Î¸(Râ‚€)$ given by $(Râ‚€,Xâ‚€,Râ‚€)$ and
  $Î¸(Râ‚€)â‚ = Râ‚€^â†‘$, i.e., given %as in Definition~\ref{def:simulation}
  by the pullback
  \begin{center}
    \Diag{%
      \stdpbk %
    }{%
      Râ‚€^â†‘ \& Xâ‚Â² \\
      Î”_ğ¬(Râ‚€)Ã—Î”_ğ¥(Xâ‚€) Ã— Î”_ğ­(Râ‚€) \& Î”Xâ‚€Â²\rlap{,}
    }{%
      (m-1-1) edge[labela={}] (m-1-2) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[labelb={}] (m-2-2) %
      (m-1-2) edge[labelr={}] (m-2-2) %
    }
  \end{center}
  extends to an embedding $Î¸âˆ¶ \psh[ğ•ğ•‹]/Xâ‚€Â² â†’ â„\Trans_3/XÂ²$, which we
  call the \alert{thin} embedding.
\end{proposition}
\begin{remark}
  Thinness here refers to labels, which are forced to agree on both
  sides of any transition in $Î¸(Râ‚€)$.
\end{remark}

The thin embedding enables the following characterisation of
bisimulation in $â„$-transition systems in terms of bisimulation in
triplopic $â„$-transition systems:
\begin{proposition}
  For any $X âˆˆ â„\Trans$, a span $Râ‚€ â†’ Xâ‚€Â²$ is a simulation (resp.\
  bisimulation) iff $Î¸(Râ‚€) â†’ XÂ²$ is one.
\end{proposition}
\begin{proof}
  Both statements mean that the square
  \begin{center}
    \diag{%
      Râ‚€^â†‘ \& Xâ‚ \\
      Î”_ğ¬(Râ‚€)Ã—Î”_ğ¥(Xâ‚€) \& Î”_{ğ¬,ğ¥}Xâ‚€
    }{%
      (m-1-1) edge[labela={Ï€â‚}] (m-1-2) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[labelb={Ï€â‚}] (m-2-2) %
      (m-1-2) edge[labelr={}] (m-2-2) %
    }
  \end{center}
  is a pointwise weak pullback.
\end{proof}

Finally, we have the easy
\begin{proposition}
  (Bi)simulations are closed under span composition in $â„\Transâ‚ƒ$.
\end{proposition}
\begin{proof}
  By symmetry it suffices to show that simulations are closed under
  span composition.  Let us thus consider any simulations $R$ and $S$
  over some $X âˆˆ â„\Transâ‚ƒ$.
  We must show that the square
  \begin{center}
    \diag{%
      (R;S)â‚ \& Xâ‚ \\
      Î”_{3,ğ¬,ğ¥} (R;S) \& Î”_{3,ğ¬,ğ¥} X
    }{%
      (m-1-1) edge[labela={Ï€â‚}] (m-1-2) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[labelb={Î”_{3,ğ¬,ğ¥}Ï€â‚}] (m-2-2) %
      (m-1-2) edge[labelr={}] (m-2-2) %
    }
  \end{center}
  is a pointwise weak pullback.
  This square factors as
  \begin{center}
    \diag{%
      (R;S)â‚ \& Râ‚ \& Xâ‚ \\
      Î”_{3,ğ¬,ğ¥} (R;S) \& Î”_{3,ğ¬,ğ¥} (R) \& Î”_{3,ğ¬,ğ¥} X\rlap{,}
    }{%
      (m-1-1) edge[labela={Ï€â‚}] (m-1-2) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[labelb={Î”_{3,ğ¬,ğ¥}Ï€â‚}] (m-2-2) %
      (m-1-2) edge[labelr={}] (m-2-2) %
      (m-1-2) edge[labela={Ï€â‚}] (m-1-3) %
      (m-2-2) edge[labelb={Î”_{3,ğ¬,ğ¥}Ï€â‚}] (m-2-3) %
      (m-1-3) edge[labelr={}] (m-2-3) %
    }
  \end{center}
  where the right-hand square is a pointwise weak pullback by hypothesis, and
  the left-hand square is the left-hand face in
  \begin{center}
  \Diag{%
    \pullbackk[2.5em][2.5em](6pt){m-2-2}{m-1-1}{m-1-3}{draw,-} %
    \pullbackk[3.5em][3.5em](12pt){m-4-2}{m-3-1}{m-3-3}{draw,-} %
    \pullbackk{m-3-3}{m-1-3}{m-2-4}{draw,dashed} %
  }{%
	{(R;S)â‚} \&\& {Sâ‚} \\
	\& {Râ‚} \&\& {Xâ‚} \\
	{Î”_{ğŸ›,ğ¬,ğ¥}(R;S)} \&\& {Î”_{ğŸ›,ğ¬,ğ¥}S} \\
	\& {Î”_{ğŸ›,ğ¬,ğ¥}R} \&\& {Î”_{ğŸ›,ğ¬,ğ¥}X}
  }{%
    (m-1-1) edge[labela={}] (m-1-3) %
    edge[labell={}] (m-3-1) %
    (m-3-1) edge[labelb={}] (m-3-3) %
    (m-1-3) edge[labelr={}] (m-3-3) %
    %
    (m-2-2) edge[fore,labelaat={Ï€â‚‚}{.2}] (m-2-4) %
    edge[fore,labell={}] (m-4-2) %
    (m-4-2) edge[labelb={Î”_{ğŸ›,ğ¬,ğ¥}Ï€â‚‚}] (m-4-4) %
    (m-2-4) edge[labelr={}] (m-4-4) %
    %
    (m-1-1) edge[labela={}] (m-2-2) %
    (m-3-1) edge[labela={}] (m-4-2) %
    (m-1-3) edge[labelar={Ï€â‚}] (m-2-4) %
    (m-3-3) edge[labelar={Î”_{ğŸ›,ğ¬,ğ¥}Ï€â‚}] (m-4-4) %
  }%
  \end{center}
  whose top and bottom faces are pullbacks by
  Lemma~\ref{lem:diplopic:span:colims} and the fact that $Î”_{3,ğ¬,ğ¥}$,
  being a right adjoint, is continuous.  Since the right-hand face is
  a pointwise weak pullback by hypothesis, so is the left-hand face by
  \citet[Lemma~9.26, (i), then (ii)]{HL}.  The whole rectangle thus is
  a pointwise weak pullback by \citet[Lemma~9.26, (i)]{HL}, as desired.
\end{proof}

\begin{proposition}\label{prop:triplopic:images}
  Triplopic (bi)simulations are closed under images.
\end{proposition}
\begin{proof}
  By symmetry it suffices to treat the case of simulations.
  Let $R â†’ XÂ²$ be any triplopic simulation.
  Then by Proposition~\ref{lem:triplopic:colims} we need to prove that
  the right-hand square below is a pointwise weak pullback,
  \begin{center}
    \diag{%
      Râ‚ \& \im(Râ‚) \& Xâ‚Â² \\
      Î”_{3,ğ¬,ğ¥}R \& Î”_{3,ğ¬,ğ¥}\im(R) \& Î”_{3,ğ¬,ğ¥}XÂ² %
    }{%
      (m-1-1) edge[onto,labela={}] (m-1-2) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[onto,labelb={}] (m-2-2) %
      (m-1-2) edge[labelr={}] (m-2-2) %
      (m-1-2) edge[into,labela={}] (m-1-3) %
      (m-2-2) edge[into,labelb={}] (m-2-3) %
      (m-1-3) edge[labelr={}] (m-2-3) %
    }
  \end{center}
  which is the case by Lemma~\ref{lem:wpbk} and the fact that
  $Î”_{3,ğ¬,ğ¥}$ preserves epis by algebraicity
  (Lemma~\ref{prop:algra3}).
\end{proof}

\begin{lemma}\label{lem:triplopic:retraction}
  Given a retraction $R â†  S$ over any $XÂ²$ in $â„\Transâ‚ƒ$,
  if $S$ is a simulation, then so is $\im(R)$.
\end{lemma}
\begin{proof}
  The given retraction and its section yield morphisms
  \begin{center}
  $\im(R) â†’ \im(S)$ \qquad \qquad and \qquad \qquad $\im(S) â†’ \im(R)$,
\end{center}
hence $\im(R) â‰… \im(S)$, so
  we conclude by Lemma~\ref{prop:triplopic:images}.
\end{proof}

\begin{proof}[Proof of Lemma~\ref{lem:flex:rigid:compo}]
  The morphism
   $\tilde{Ï}âˆ¶ R;Î¹S â†’ R;Î¸S$ defined by the triple
  \begin{mathpar}
    \idâˆ¶ Râ‚€;Sâ‚€ â†’ Râ‚€;Sâ‚€ \and
    Ïâˆ¶ Râ‚€;Sâ‚€ â†’ Râ‚€ \and
    \idâˆ¶ Râ‚€;Sâ‚€ â†’ Râ‚€;Sâ‚€
  \end{mathpar}
  admits a section, namely the morphism $R;Î¸S â†’ R;Î¹S$ defined by
  \begin{mathpar}
    \idâˆ¶ Râ‚€;Sâ‚€ â†’ Râ‚€;Sâ‚€ \and
    Râ‚€ â‰… Râ‚€;Xâ‚€ â†’ Râ‚€;Sâ‚€ \and
    \idâˆ¶ Râ‚€;Sâ‚€ â†’ Râ‚€;Sâ‚€
  \end{mathpar}
  (induced by reflexivity of $Sâ‚€$). Thus, $\im(R;Î¹S)$ is
  a triplopic simulation by Lemma~\ref{lem:triplopic:retraction},
  hence a diplopic one by
  Proposition~\ref{prop:triplopic:sim:reflection}.  Finally,
  $\im(R_{D,V};Sâ‚€)^â‡‘$ is a flexible simulation by
  Proposition~\ref{prop:simliftmax}.
\end{proof}


\subsection{Fundamental property of flexible bisimulation}
In this section, we reduce the theorem to a certain result involving
flexible bisimulations, using the following fundamental property of
flexible bisimulation:
\begin{proposition}\label{prop:flexbisim:bisim}
  For any $X âˆˆ â„\Trans$ and reflexive, flexible bisimulation $R â†’ XÂ²$, $Râ‚€ â†’ Xâ‚€Â²$ is a
  bisimulation.
\end{proposition}
% \begin{remark}
%   In this statement, $Î¹\Transâˆ¶ Ïƒ\Trans â†’ Ïƒ\Trans_ğŸš$ is used as an implicit
%   coercion. More explicitly, we mean that
%   $Î¹\Trans(R) â†’ (Î¹\Trans(X))Â²$ is a reflexive, flexible bisimulation.
% \end{remark}

We need the following lemma.

\begin{lemma}\label{lem:damier:wpbk}
  Consider any commuting diagram of the following form
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsMTAsWzAsMCwiQSJdLFsxLDAsIkIiXSxbMiwwLCJDIl0sWzAsMSwiWCJdLFsxLDEsIlkiXSxbMywyLCJXIl0sWzAsMiwiVSJdLFsxLDIsIlYiXSxbMywwLCJEIl0sWzIsMSwiWiJdLFswLDEsImYiXSxbMSwyLCJnIl0sWzMsNCwiaCJdLFsxLDQsInkiXSxbMCwzLCJ4IiwyXSxbMyw2LCJ1IiwyXSxbNiw3LCJsIiwyXSxbNCw3LCJ2Il0sWzcsNSwibSIsMl0sWzMsNywiIiwxLHsic3R5bGUiOnsibmFtZSI6ImNvcm5lciJ9fV0sWzIsOCwiaCJdLFs4LDUsInciXSxbMiw5LCJ6Il0sWzQsOSwiayJdXQ==
\begin{tikzcd}[ampersand replacement=\&]
	A \& B \& C \& D \\
	X \& Y \& Z \\
	T \& U \& V \& W
	\arrow["f", from=1-1, to=1-3, curve={height=-18pt}]
	% \arrow["f", from=1-1, to=1-2]
	\arrow["g", from=1-2, to=1-3]
	\arrow["j", from=2-1, to=2-2]
	\arrow["y", from=1-2, to=2-2]
	\arrow["x"', from=1-1, to=2-1]
	\arrow["t"', from=2-1, to=3-1]
	\arrow["l"', from=3-1, to=3-2]
	\arrow["u", from=2-2, to=3-2]
	\arrow["m"', from=3-2, to=3-3]
        \arrow["n"', from=3-3, to=3-4]
	\arrow["h", from=1-3, to=1-4]
	\arrow["w", from=1-4, to=3-4]
	\arrow["z", from=1-3, to=2-3]
	\arrow["k", from=2-2, to=2-3]
        \arrow["v", from=2-3, to=3-3]
      \end{tikzcd}
    \end{center}
    (i.e., all three squares and the rectangle commute, plus $zf=kjx$),
    such that
    all three squares below are weak pullbacks.
    \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNCxbMCwwLCJYIl0sWzEsMCwiWSJdLFswLDEsIlUiXSxbMSwxLCJWIl0sWzAsMSwiaCJdLFswLDIsInUiLDJdLFsyLDMsImwiLDJdLFsxLDMsInYiXV0=
\begin{tikzcd}[ampersand replacement=\&]
	X \& Y \\
	T \& U
	\arrow["j", from=1-1, to=1-2]
	\arrow["t"', from=1-1, to=2-1]
	\arrow["l"', from=2-1, to=2-2]
	\arrow["u", from=1-2, to=2-2]
\end{tikzcd} \hfil      % file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMCwwLCJBIl0sWzEsMCwiQiJdLFsyLDAsIkMiXSxbMCwxLCJYIl0sWzEsMSwiWSJdLFsyLDEsIloiXSxbMCwxLCJmIl0sWzEsMiwiZyJdLFszLDQsImgiLDJdLFswLDMsIngiLDJdLFsyLDUsInoiXSxbNCw1LCJrIiwyXV0=
\begin{tikzcd}[ampersand replacement=\&]
	A \&  \& C \\
	X \& Y \& Z
	\arrow["f", from=1-1, to=1-3]
	\arrow["j"', from=2-1, to=2-2]
	\arrow["x"', from=1-1, to=2-1]
	\arrow["z", from=1-3, to=2-3]
	\arrow["k"', from=2-2, to=2-3]
      \end{tikzcd}
      \hfil
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMCwwLCJCIl0sWzEsMCwiQyJdLFswLDEsIlkiXSxbMiwyLCJXIl0sWzAsMiwiViJdLFsyLDAsIkQiXSxbMCwxLCJnIl0sWzAsMiwieSIsMl0sWzIsNCwidiIsMl0sWzQsMywibSIsMl0sWzEsNSwiaCJdLFs1LDMsInciXV0=
\begin{tikzcd}[ampersand replacement=\&]
	B \& C \& D \\
	Y \\
	U \& V \& W
	\arrow["g", from=1-1, to=1-2]
	\arrow["y"', from=1-1, to=2-1]
	\arrow["u"', from=2-1, to=3-1]
	\arrow["m"', from=3-1, to=3-2]
        \arrow["n"', from=3-2, to=3-3]
	\arrow["h", from=1-2, to=1-3]
	\arrow["w", from=1-3, to=3-3]
\end{tikzcd}      
    \end{center}
    Then, the exterior is again a weak pullback.
\end{lemma}
\begin{proof}
  First, we find $iâˆ¶ A â†’ B$ such that $gi = f$ and $uyi = ltx$, by
  weak universal property of $B$.

  Now, consider any cone $(p,q)$ as shown below.
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsMTEsWzIsMSwiQSJdLFszLDEsIkIiXSxbNCwxLCJDIl0sWzIsMiwiWCJdLFszLDIsIlkiXSxbNSwzLCJXIl0sWzIsMywiVSJdLFszLDMsIlYiXSxbNSwxLCJEIl0sWzQsMiwiWiJdLFswLDAsIkUiXSxbMCwxLCJmIiwyXSxbMSwyLCJnIiwyXSxbMyw0LCJoIl0sWzEsNCwieSJdLFswLDMsIngiLDJdLFszLDYsInUiLDJdLFs2LDcsImwiLDJdLFs0LDcsInYiXSxbMiw4LCJoIiwyXSxbOCw1LCJ3Il0sWzIsOV0sWzQsOSwiayJdLFsxMCw4LCJwIiwwLHsiY3VydmUiOi0zfV0sWzEwLDYsInEiLDIseyJjdXJ2ZSI6M31dLFsxMCwxLCJyIiwwLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV0sWzEwLDMsInMiLDIseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJkYXNoZWQifX19XSxbMTAsMiwiZ3IiLDEseyJsYWJlbF9wb3NpdGlvbiI6NjAsImN1cnZlIjotMiwic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV0sWzcsNSwibSIsMl0sWzEwLDAsImQiLDEseyJsYWJlbF9wb3NpdGlvbiI6NzAsInN0eWxlIjp7ImJvZHkiOnsibmFtZSI6ImRhc2hlZCJ9fX1dXQ==
\begin{tikzcd}[ampersand replacement=\&]
	E \\
	\&\& A \& B \& C \& D \\
	\&\& X \& Y \& Z \\
	\&\& T \& U \& V \& W
	\arrow["i"', from=2-3, to=2-4]
	\arrow["g"', from=2-4, to=2-5]
	\arrow["h", from=3-3, to=3-4]
	\arrow["y", from=2-4, to=3-4]
	\arrow["x"', from=2-3, to=3-3]
	\arrow["t"', from=3-3, to=4-3]
	\arrow["l"', from=4-3, to=4-4]
	\arrow["u", from=3-4, to=4-4]
        \arrow["v", from=3-5, to=4-5]
	\arrow["h"', from=2-5, to=2-6]
	\arrow["w", from=2-6, to=4-6]
	\arrow["z", from=2-5, to=3-5]
	\arrow["k", from=3-4, to=3-5]
	\arrow["p", curve={height=-18pt}, from=1-1, to=2-6]
	\arrow["q"', curve={height=18pt}, from=1-1, to=4-3]
	\arrow["r", dashed, from=1-1, to=2-4]
	\arrow["s"', dashed, from=1-1, to=3-3]
	\arrow["gr"{description, pos=0.6}, curve={height=-12pt}, dashed, from=1-1, to=2-5]
	\arrow["m"', from=4-4, to=4-5]
        \arrow["n"', from=4-5, to=4-6]
	\arrow["d"{description, pos=0.7}, dashed, from=1-1, to=2-3]
\end{tikzcd}
  \end{center}
  By weak universal property of $B$, we find $râˆ¶ E â†’ B$ such that
  $hgr = p$ and $vyr = lq$.  By weak universal property of $X$, we
  then find a morphism $sâˆ¶ E â†’ X$ such that $us = q$ and $hs = yr$.
  Finally, by weak universal property of $A$, we find the desired
  morphism $dâˆ¶ E â†’ A$ such that $xd = s$ and $gid = gr$.  Please note
  that nothing here guarantees that $id = r$, nor that $yi=hx$, but
  this does invalidate the result.
\end{proof}


\begin{proof}[Proof of Proposition~\ref{prop:flexbisim:bisim}]
  By symmetry, it suffices to check that the first projection
  $Ï€â‚âˆ¶ Râ‚€ â†’ Xâ‚€$ is a simulation.  For any $c âˆˆ ğ”¼ğ•‹$, we form the following diagram,
  \begin{center}
\ajustedroit{
% file:///home/thirs/github/quiver/src/index.html?q=WzAsMTEsWzAsMCwiUl8wXlxcdXBhcnJvdyhjKSJdLFsyLDAsIihYXzEgXFx0aW1lcyBYXzEpKGMpIl0sWzIsMSwiKM6UX/CdkKwoWF8wKcKyIMOXIM6UX/CdkKUoWF8wKcKyIMOXIM6UX/CdkK0oWF8wKcKyKShjKSJdLFswLDEsIijOlF/wnZCsKFJfMCkgw5cgzpRf8J2QpShYXzApIMOXIM6UX/CdkK0oUl8wKSkoYykiXSxbMCwyLCIozpRf8J2QrChSXzApIMOXIM6UX/CdkKUoWF8wKSkoYykiXSxbMiwyLCIozpRf8J2QrChYXzApwrIgw5cgzpRf8J2QpShYXzApwrIpKGMpIl0sWzMsMCwiWF8xKGMpIl0sWzMsMiwiKM6UX/CdkKwoWF8wKSDDlyDOlF/wnZClKFhfMCkpKGMpIl0sWzEsMSwiKM6UX/CdkKwoUl8wKSDDlyDOlF/wnZClKFJfMCkgw5cgzpRf8J2QrShSXzApKShjKSJdLFsxLDAsIlJfMShjKSJdLFsxLDIsIijOlF/wnZCsKFJfMCkgw5cgzpRf8J2QpShSXzApKShjKSJdLFsxLDJdLFswLDNdLFszLDRdLFsyLDVdLFsxLDYsIlxccGlfMSJdLFs2LDddLFs1LDcsIiBcXHBpXzEgXFx0aW1lcyBcXHBpXzEiLDJdLFszLDhdLFs4LDJdLFs5LDhdLFs5LDFdLFs4LDEwXSxbNCwxMF0sWzEwLDVdLFswLDEsIiIsMCx7ImN1cnZlIjotM31dLFswLDksIiIsMSx7InN0eWxlIjp7ImJvZHkiOnsibmFtZSI6ImRhc2hlZCJ9fX1dXQ==
\begin{tikzcd}[ampersand replacement=\&]
	{R_0^\uparrow(c)} \& {R_1(c)} \& {(X_1 \times X_1)(c)} \& {X_1(c)} \\
	{(Î”_ğ¬(R_0) Ã— Î”_ğ¥(X_0) Ã— Î”_ğ­(R_0))(c)} \& {(Î”_ğ¬(R_0) Ã— Î”_ğ¥(R_0) Ã— Î”_ğ­(R_0))(c)} \& {(Î”_ğ¬(X_0)Â² Ã— Î”_ğ¥(X_0)Â² Ã— Î”_ğ­(X_0)Â²)(c)} \\
	{(Î”_ğ¬(R_0) Ã— Î”_ğ¥(X_0))(c)} \& {(Î”_ğ¬(R_0) Ã— Î”_ğ¥(R_0))(c)} \& {(Î”_ğ¬(X_0)Â² Ã— Î”_ğ¥(X_0)Â²)(c)} \& {(Î”_ğ¬(X_0) Ã— Î”_ğ¥(X_0))(c)}
	\arrow[from=1-3, to=2-3]
	\arrow[from=1-1, to=2-1]
	\arrow[from=2-1, to=3-1]
	\arrow[from=2-3, to=3-3]
	\arrow["{\pi_1}", from=1-3, to=1-4]
	\arrow[from=1-4, to=3-4]
	\arrow["{ \pi_1 \times \pi_1}"', from=3-3, to=3-4]
	\arrow[from=2-1, to=2-2]
	\arrow[from=2-2, to=2-3]
	\arrow[from=1-2, to=2-2]
	\arrow[from=1-2, to=1-3]
	\arrow[from=2-2, to=3-2]
	\arrow[from=3-1, to=3-2]
	\arrow[from=3-2, to=3-3]
	\arrow[curve={height=-18pt}, from=1-1, to=1-3]
	%\arrow[dashed, from=1-1, to=1-2]
      \end{tikzcd}
    }
  \end{center}
and conclude by
  Lemma~\ref{lem:damier:wpbk}. To check that it applies, we observe
  that
  \begin{itemize}
  \item the first requirement holds easily (the bottom left square is
    easily seen to be a pullback);
  \item the second requirement holds by construction of $Râ‚€^â‡‘$; and
  \item the last requirement holds by hypothesis that $R$ is a
    flexible bisimulation. \qedhere
  \end{itemize}
\end{proof}

Let us now use the fundamental property
(Proposition~\ref{prop:flexbisim:bisim}) of flexible bisimulation to
reduce congruence of bisimilarity to the search for a suitable
flexible \augmented bisimulation.
\begin{corollary}\label{cor:reduce1}
  Consider any syntactic signature $ğ = (Î£,(Î“áµ¢,dáµ¢)_{i âˆˆ n})$.
  Let $Ïƒ$ denote the generated enhanced syntax $Ïƒ(ğ)$.
  Let $X$ be any $Ïƒ$-transition system, and suppose that there exists a
  reflexive, \augmented, flexible bisimulation relation
  $R â†’ XÂ²$ such that ${âˆ¼_X^Ïƒ} âŠ† Râ‚€$ and $Râ‚€$ is a
  congruence. Then \augmented bisimilarity ${âˆ¼_X^Ïƒ}$ is a congruence.
\end{corollary}
\begin{proof}
  Consider any reflexive, \augmented, flexible bisimulation relation
  $R â†’ XÂ²$ such that $Râ‚€$ contains \augmented
  bisimilarity and is a congruence. By
  Proposition~\ref{prop:flexbisim:bisim}, $Râ‚€$ is \anaugmented
  bisimulation, so by terminality of $âˆ¼_X^Ïƒ$, we have $Râ‚€ âŠ† {âˆ¼_X^Ïƒ}$,
  hence morphisms
  $$Î£â‚€(âˆ¼_X^Ïƒ) â†’ Î£â‚€(Râ‚€) â†’ Râ‚€ â†’ {âˆ¼_X^Ïƒ}$$
  over $Xâ‚€Â²$.
\end{proof}

\subsection{Howe closure: basic properties}
In this section, we introduce our candidate reflexive,
\augmented, flexible bisimulation relation $R â†’ ğ™Â²$ such that ${âˆ¼_ğ™} âŠ† Râ‚€$ and
$Râ‚€$ is a congruence.
As is standard, we
\begin{itemize}
\item construct it directly as a congruence, 
\item prove that it is reflexive and \augmented (relatively easily),
  and, finally,
\item struggle to prove that it (or rather its transitive closure) is
  a flexible bisimulation.
\end{itemize}
\begin{definition}
  Let the \alert{Howe functor} $\Fwowâˆ¶ \psh[ğ•ğ•‹]/Xâ‚€Â² â†’ \psh[ğ•ğ•‹]/Xâ‚€Â²$ map any $Râ‚€ â†’ Xâ‚€Â²$
  to the coproduct span $Î£â‚€(Râ‚€) + (Râ‚€;{âˆ¼_X})$, where the second term more concretely
  denotes the following composite span.
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMCwyLCJYXzAiXSxbMSwxLCJSXzAiXSxbMiwyLCJYXzAiXSxbMywxLCJ7XFxzaW1fWH0iXSxbNCwyLCJYXzAiXSxbMiwwLCJSXzA7e1xcc2ltX1h9Il0sWzMsMiwiXFxwaV8xIiwyXSxbMyw0LCJcXHBpXzIiXSxbNSwxXSxbNSwzXSxbMSwyLCJcXHBpXzIiXSxbMSwwLCJcXHBpXzEiLDJdLFs1LDIsIiIsMix7InN0eWxlIjp7Im5hbWUiOiJjb3JuZXIifX1dXQ==
\begin{tikzcd}[ampersand replacement=\&]
	\&\& {R_0;{\sim_X}} \\
	\& {R_0} \&\& {{\sim_X}} \\
	{X_0} \&\& {X_0} \&\& {X_0}
	\arrow["{\pi_1}"', from=2-4, to=3-3]
	\arrow["{\pi_2}", from=2-4, to=3-5]
	\arrow[from=1-3, to=2-2]
	\arrow[from=1-3, to=2-4]
	\arrow["{\pi_2}", from=2-2, to=3-3]
	\arrow["{\pi_1}"', from=2-2, to=3-1]
	\arrow["\lrcorner"{anchor=center, pos=0.125, rotate=-45}, draw=none, from=1-3, to=3-3]
%        \pbk{\tikzcdmatrixname-2-2}{\tikzcdmatrixname-1-3}{\tikzcdmatrixname-2-4}
      \end{tikzcd}
    \end{center}
  
    Let the \alert{proof-relevant Howe closure} $Râ‚€^âŠ™$ be the free
    $\Fwow$-algebra on $Râ‚€$, and the \alert{(proof-irrelevant, or relational)
      Howe closure} $Râ‚€^â€¢$ denote the image of $Râ‚€^âŠ™ â†’ Xâ‚€Â²$.
\end{definition}
The Howe functor is a finitary endofunctor on a presheaf category,
so we have~\cite{Reiterman}:
\begin{proposition}\label{prop:wow:initialchain}
  The free $\Fwow$-algebra on any $Râ‚€$ exists and is computed by the
  standard initial chain, and the forgetful functor
  $\Fwow\alg â†’ \psh[ğ•ğ•‹]/Xâ‚€Â²$ is finitary monadic.
\end{proposition}

\begin{proposition}\label{prop:relwow:alt}
  Let $ğ’°âˆ¶ ğ’ğ®ğ›(Xâ‚€Â²) â†ª \psh[ğ•ğ•‹]/Xâ‚€Â²$ denote the canonical embedding, and
  let $Î£ = \Fwow$ just for this proposition.  The composite
  endofunctor $\im âˆ˜ Î£^* âˆ˜ ğ’°$ on $ğ’ğ®ğ›(Xâ‚€Â²)$ is a monad, which is in
  fact the free monad on $\im âˆ˜ Î£ âˆ˜ ğ’°$.  Consequently, the relational
  Howe closure $(ğ’°R)^â€¢$ on a relation $R âˆˆ ğ’ğ®ğ›(Xâ‚€Â²)$ is the free
  $(\im âˆ˜ Î£ âˆ˜ ğ’°)$-algebra over $R$.
\end{proposition}
\begin{proof}
  Using algebraicity of $Î£â‚€$, it is straightforward to show that $Î£$
  preserves epimorphisms. For any $R âˆˆ \psh[ğ•ğ•‹]/Xâ‚€Â²$, letting
  $T = ğ’° âˆ˜ \im$ denote the monad induced by the adjunction $\im âŠ£ ğ’°$,
  we thus have by unique lifting a morphism $Î´_Râˆ¶ Î£TR â†’ TÎ£R$ as in the
  following diagram,
  \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNSxbMCwwLCJcXFNpZ21hIFIiXSxbMCwxLCLOoyBcXGltIPCdkrAgUiJdLFsxLDEsIs6jIChY4oKAwrIpIl0sWzIsMSwiWOKCgMKyIl0sWzIsMCwi8J2SsCBcXGltIM6jIFIgIl0sWzAsMSwizqMgZSIsMix7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFsxLDIsIs6jIG0iLDJdLFsyLDNdLFswLDQsIiIsMix7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFs0LDMsIiIsMSx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Im1vbm8ifX19XSxbMSw0LCLOtF9SIiwwLHsibGFiZWxfcG9zaXRpb24iOjMwLCJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJkYXNoZWQifX19XV0=
\begin{tikzcd}[ampersand replacement=\&]
	{\Sigma R} \&\& {ğ’° \im Î£ R } \\
	{Î£  ğ’° \im R} \& {Î£ (Xâ‚€Â²)} \& {Xâ‚€Â²}
	\arrow["{Î£ e}"', two heads, from=1-1, to=2-1]
	\arrow["{Î£ m}"', from=2-1, to=2-2]
	\arrow[from=2-2, to=2-3]
	\arrow[two heads, from=1-1, to=1-3]
	\arrow[tail, from=1-3, to=2-3]
	\arrow["{Î´_R}"{pos=0.3}, dashed, from=2-1, to=1-3]
\end{tikzcd}
  \end{center}
  where $R  â†’ Xâ‚€Â²$ factors as $e âˆ˜ m$ and the last horizontal morphism is 
  $$\Fwow(Xâ‚€Â²) = Î£â‚€(Xâ‚€Â²) + (Xâ‚€Â²);âˆ¼_X \xto{[âŸ¨a âˆ˜ Î£â‚€(Ï€â‚),a âˆ˜ Î£â‚€(Ï€â‚‚)âŸ©, âŸ¨Ï€â‚âˆ˜Ï€â‚, Ï€â‚‚âˆ˜Ï€â‚‚âŸ©]} Xâ‚€Â².$$
  The result thus follows from the next lemma.
\end{proof}

\begin{lemma}
  \label{lem:initalgtransport}
  Consider a full, reflective embedding $Uâˆ¶ ğ’Ÿ â†ª ğ’$ from some poset $ğ’Ÿ$
  into a locally finitely presentable category $ğ’$, say with left
  adjoint $Lâˆ¶ ğ’ â†’ ğ’Ÿ$, together with a finitary endofunctor $Î£$ on $ğ’$.
  Furthermore, assume given a functor distributive law, i.e., a
  natural transformation $Î´âˆ¶ Î£ T â†’ T Î£$, where $T â‰” UL$ denotes the
  induced monad.
  Then, $LÎ£^*U$ is the free monad on $LÎ£U$, hence in particular
  the free $LÎ£U$-algebra on any $D âˆˆ ğ’Ÿ$ is $LÎ£^*UD$.
\end{lemma}

\begin{lemma}\label{lem:subterm}
  In the setting of Lemma~\ref{lem:initalgtransport}, all objects of
  the form $UD âˆˆ ğ’$ are \alert{subterminal}, in the sense that any two
  parallel morphisms to $UD$ are equal.
\end{lemma}
\begin{proof}
  Consider any $f,gâˆ¶ Câ†’ UD$. By adjunction, these correspond
  bijectively to morphisms $\tilde{f},\tilde{g}âˆ¶ LC â†’ D$, which,
  because $ğ’Ÿ$ is a poset, are equal.
\end{proof}

\begin{proof}[Proof of Lemma~\ref{lem:initalgtransport}]
  By~\citet{Reiterman}, $Î£$ admits a free monad $Î£^*$.

  Furthermore, by Lemma~\ref{lem:subterm}, the given functor
  distributive law $Î´$ is in fact a \alert{functor-monad distributive
    law}, in the sense that it commutes with the unit and
  multiplication of $T$.
  
  Now, by a reasoning analogous to \citet{BeckDistlaws}, functor-monad
  distributive laws $Î´âˆ¶ Î£T â†’ TÎ£$ correspond bijectively to liftings of
  the monad $T$ to $Î£\alg$, i.e., monads $TáµŸ$ on $Î£\alg$ making the
  following square commute,
  \begin{center}
    \diag{%
      Î£\alg \& Î£\alg \\
      ğ’ \& ğ’ %
    }{%
      (m-1-1) edge[labela={TáµŸ}] (m-1-2) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[labelb={T}] (m-2-2) %
      (m-1-2) edge[labelr={}] (m-2-2) %
    }
  \end{center}
  whose multiplication and unit are mapped by the forgetful functor to
  those of $T$.  The given functor-monad distributive law $Î´$ thus
  corresponds to such a lifting.  But $Î£\alg â‰… Î£^*\Alg$ over $ğ’$,
  hence we get a lifting of $T$ to $Î£^*\Alg$, which by \citet{BeckDistlaws}
  again amounts to a monad distributive law, say
  $\bar{Î´}âˆ¶ Î£^*T â†’ T Î£^*$.

  From this, using the fact that the counit is an isomorphism (which follows
  from full faithfulness of $U$), we equip the composite $L Î£^* U$ with
  monad structure:
  \begin{itemize}
  \item the unit is the composite
    $R \xto{(Îµáµ€)^{-1}} LUR \xto{LÎ·^{Î£^*}} LÎ£^*UR$, 
  \item the multiplication is
    $$LÎ£^*U LÎ£^*U R = L Î£^* T Î£^* U R \xto{L \bar{Î´}} L T Î£^*Î£^* U R
    \xto{Îµ U Î¼^{Î£^*} U R} L Î£^* U R\rlap{,}$$
  \item and the monad laws hold automatically since $ğ’Ÿ$ is a poset.
  \end{itemize}

  Moreover, given any $R âˆˆ ğ’Ÿ$, the following are equivalent
  \begin{itemize}
  \item $Î£^*$-algebra structure (in the monad sense) on $UR$,
  \item $Î£^*$-algebra structure (in the functor sense) on $UR$,
  \item $Î£$-algebra structure on $UR$,
  \item $LÎ£^*U$-algebra structure (in the monad sense) on $R$,
  \item $LÎ£^*U$-algebra structure (in the functor sense) on $R$,    
  \item $LÎ£U$-algebra structure on $R$.
  \end{itemize}
  Indeed,
  \begin{itemize}
  \item $Î£$-algebra structure $Î£UR â†’ UR$ corresponds by adjunction to
    $LÎ£U$-algebra structure $LÎ£UR â†’ R$;
  \item $Î£$-algebra structure $Î£UR â†’ UR$ corresponds by universal property of $Î£^*$
    to $Î£^*$-algebra structure $Î£^*UR â†’ UR$ in the monad sense;
  \item by subterminality,  $Î£^*$-algebra structures $Î£^*UR â†’ UR$
    in the monad and functor sense are equivalent;
  \item by adjunction again, $Î£^*$-algebra structure $Î£^*UR â†’ UR$ in the functor sense
    is equivalent to $LÎ£^*U$-structure  $LÎ£^*UR â†’ R$ in the functor sense; 
  \item and finally, because $ğ’Ÿ$ is a poset, $LÎ£^*U$-structures
    $LÎ£^*UR â†’ R$ in the functor and monad sense are equivalent.
  \end{itemize}

  We thus in particular get $(L Î£^* U)\Alg â‰… (LÎ£U)\alg$ over $ğ’Ÿ$,
  hence the result.
\end{proof}

\begin{definition}
  Let $S^{{+};{âˆ¼_X}}$ denote the monad induced by $\Fwow$ on
  $\psh[ğ•ğ•‹]/Xâ‚€Â²$.
\end{definition}

\begin{lemma}\label{lem:wow:basicprops}
  Let $Râ‚€'$ be the proof-relevant (resp.\ proof-irrelevant) Howe closure $Râ‚€^âŠ™$ (resp.\ $Râ‚€^â€¢$)
  of (resp.\ a relation) $Râ‚€$. It satisfies the following properties.
  \begin{romanenumerate}
  \item \label{item:alg} $Râ‚€'$ is a $Î£â‚€$-algebra; 
  \item \label{item:act} there exists an action $Râ‚€';{âˆ¼_X} â†’ Râ‚€'$
    over $Xâ‚€Â²$.
  % \end{romanenumerate}

  Furthermore, if $Xâ‚€ = Î£â‚€^*(âˆ…)$ is the initial $Î£â‚€$-algebra, we have:
  % \begin{romanenumerate}[resume]
  \item $Râ‚€'$ is reflexive, 
  \item \label{item:wow:contains:bisim} there exists a morphism
    ${âˆ¼}_X â†’ Râ‚€'$ over $Xâ‚€Â²$.
  \end{romanenumerate}
\end{lemma}
\begin{proof} We prove the properties for the proof-relevant Howe closure -- they follow
  easily for the proof-irrelevant one.
  \begin{description}
  \item[\cref{item:alg}] By definition $Râ‚€^âŠ™$ is an $\Fwow$-algebra,
    hence in particular a $Î£â‚€$-algebra, or more correctly an algebra
    for the obvious lifting of $Î£â‚€$ to $\psh[ğ•ğ•‹]/Xâ‚€Â²$.
  \item[\cref{item:act}] As an $\Fwow$-algebra, $Râ‚€^âŠ™$ is an algebra for
    the second term functor, i.e., a morphism of the desired form
    $Râ‚€^âŠ™;{âˆ¼_X} â†’ Râ‚€^âŠ™$.
  \end{description}
  Let us now assume that $Xâ‚€$ is the initial $Î£â‚€$-algebra.  Then, by
  initiality of $Xâ‚€$ and~\cref{item:alg}, there is a unique
  $Î£â‚€$-algebra morphism $Xâ‚€ â†’ Râ‚€^âŠ™$, which witnesses reflexivity.

  We then use reflexivity and~\cref{item:act} to construct the
  following composite
  $${âˆ¼}_X â‰… {Xâ‚€ ; {âˆ¼_X}} â†’ {Râ‚€^âŠ™;{âˆ¼_X}} â†’ Râ‚€^âŠ™\rlap{,}$$
  which proves the second point.
\end{proof}



A further crucial property is:
\begin{proposition}\label{prop:Wow:augmented}
  If $Xâ‚€$ is an $ST$-algebra, then the proof-relevant Howe closure
  $Râ‚€^âŠ™$ on any $Râ‚€$ is an $ST$-algebra, and $Râ‚€^âŠ™ â†’ Xâ‚€Â²$ is a
  morphism of $ST$-algebras.  Furthermore, the relational Howe closure
  $Râ‚€^â€¢$ is \augmented.
\end{proposition}
In order to prove this, we need a few intermediate steps.


   \begin{definition} For any bifunctor $F$ on
    a category $ğ‚$ and $FÎ”$-algebra $X$, let $\bar{F}$ denote the
    lifting of $F$ to $ğ‚/XÂ²$, which maps any $U â†’ XÂ²$ and $V â†’ XÂ²$ to the composite
    $$F (U,V) â†’ F(XÂ²,XÂ²) â†’ F(X,X)Â² â†’ XÂ².$$
  \end{definition}

  \begin{lemma}\label{lem:wdistrib}
    For any bifunctor $Î“$ on a category $ğ‚$ with pullbacks, object
    $X âˆˆ ğ‚$, and spans $uáµ¢âˆ¶ Uáµ¢ â†’ XÂ²$, for $i âˆˆ 3$, there is a
    morphism $$Î“ ((Uâ‚;Uâ‚‚),Uâ‚ƒ) â†’ Î“ (Uâ‚,Uâ‚ƒ) ; Î“ (Uâ‚‚,X)$$
    of spans over $X$.
  \end{lemma}
  \begin{proof}
    We construct the desired morphism by universal property of
    pullback, as in the following diagram.
    \begin{center}
\begin{tikzcd}[ampersand replacement=\&]
	{\Gamma_{}((Uâ‚;{Uâ‚‚}),Uâ‚ƒ)} \&\& {\Gamma_{}({Uâ‚‚},Uâ‚ƒ)} \\
	\& {\Gamma_{}(Uâ‚,Uâ‚ƒ);\Gamma_{}({Uâ‚‚},X)} \&\& {\Gamma_{}({Uâ‚‚},X)} \\
	{\Gamma_{}(Uâ‚,Uâ‚ƒ)} \&\& {\Gamma_{}(X,Uâ‚ƒ)} \\
	\& {\Gamma_{}(Uâ‚,Uâ‚ƒ)} \&\& {\Gamma_{}(X,X)}
	\arrow[from=1-1, to=3-1]
	\arrow[from=1-1, to=1-3]
	\arrow["{\Gamma_{}(\pi_1,Uâ‚ƒ)}"'{pos=0.2}, from=1-3, to=3-3]
	\arrow["{\Gamma_{}(\pi_2,Uâ‚ƒ)}"'{pos=0.3}, from=3-1, to=3-3]
	\arrow[""{name=0, anchor=center, inner sep=0, pos=.15}, "{\pi_1}"{pos=0.8}, fore, from=2-2, to=4-2]
	\arrow[""{name=1, anchor=center, inner sep=0, pos=-.2}, "{\pi_2}"'{pos=0.2}, fore, from=2-2, to=2-4]
	\arrow["{\Gamma_{}(\pi_1,X)}", fore, from=2-4, to=4-4]
	\arrow["{\Gamma_{}(\pi_2,\pi_2)}"', from=4-2, to=4-4]
	\arrow[Rightarrow, no head, from=3-1, to=4-2]
	\arrow["{\Gamma_{}(X,\pi_2)}"'{pos=0}, from=3-3, to=4-4]
	\arrow["{\Gamma_{}({Uâ‚‚},\pi_2)}"{pos=0.9}, from=1-3, to=2-4]
	\arrow[dashed, from=1-1, to=2-2]
	\arrow[shorten <=6pt, shorten >=6pt, no head, from=0, to=1,
        to path={-| (\tikztotarget)}]        
\end{tikzcd}
    \end{center}    
  \end{proof}



  \begin{lemma}
    Assume that $Xâ‚€$ is a $Ïƒ$-algebra with structure given by
    \begin{mathpar}
      ğšâˆ¶ Î£â‚€Xâ‚€ â†’ Xâ‚€ \and â€¦ \and ğ›áµ¢âˆ¶ Î“áµ¢(Xâ‚€,Xâ‚€) â†’ Xâ‚€ \and â€¦ \rlap{ ,}
    \end{mathpar}
    and let the derived monad algebra structures be as follows.
    \begin{mathpar}
      \bar{ğš}âˆ¶ SXâ‚€ â†’ Xâ‚€ \and â€¦ \and \bar{ğ›}_{<i}âˆ¶ Táµ¢Xâ‚€ â†’ Xâ‚€ \and â€¦\rlap{.}
    \end{mathpar}

    Then, for all $i âˆˆ n$, the incremental structural law
     $$dáµ¢âˆ¶ Î“áµ¢(Î£â‚€A,B) â†’ STáµ¢ (Î“áµ¢(A,STáµ¢B)+ A + B)$$
     lifts to an incremental structural law
     $$\bar{dáµ¢}âˆ¶ \bar{Î“áµ¢}(Î£â‚€^{{+};{âˆ¼_X}}A,B) â†’ S^{{+};{âˆ¼_X}}\bar{Táµ¢}
     (\bar{Î“áµ¢}(A,S^{{+};{âˆ¼_X}}\bar{Táµ¢}B) + A + B)\rlap{.}$$ 
   \end{lemma}
   %% proof dLifts.json
   \begin{proof}
     By Lemma~\ref{lem:wdistrib}, using left-cocontinuity of $Î“áµ¢$, and
     the fact that $âˆ¼_X$ is \augmented.
   \end{proof}

   \begin{proof}[Proof of Proposition~\ref{prop:Wow:augmented}]
     By Proposition~\ref{prop:sigmad}, there exists a distributive law
     $$\bar{T}_{n+1}S^{{+};{âˆ¼_X}} â†’ S^{{+};{âˆ¼_X}}\bar{T}_{n+1}$$ and
     $\bar{T}_{n+1}$ is constant-free, hence the natural
     transformation $S^{{+};{âˆ¼_X}} â†’ S^{{+};{âˆ¼_X}} \bar{T}_{n+1}$ is
     an isomorphism at $âˆ…$.  The proof-relevant Howe closure
     $Râ‚€^âŠ™ = S^{{+};{âˆ¼_X}}âˆ…$ thus acquires a canonical
     $S^{{+};{âˆ¼_X}}\bar{T}_{n+1}$-algebra structure. The terminal
     object also is one, of course, and the unique morphism to it is a
     $S^{{+};{âˆ¼_X}}\bar{T}_{n+1}$-algebra morphism, which completes
     the proof of the first point.
     
     The proof-relevant Howe closure is in particular \augmented via
     $$Î“áµ¢(Râ‚€^âŠ™,X) â†’Î“áµ¢(Râ‚€^âŠ™,Râ‚€^âŠ™) â†’ Râ‚€^âŠ™\rlap{,}$$
     which entails \augmentedness for the relational Howe closure by
     the fact that each $Î“áµ¢$, being left-cocontinuous, preserves
     epimorphisms in its first argument, and that all epimorphisms are
     strong in presheaf categories.  Indeed, we find the desired
     morphism by lifting as in the following diagram.
     \begin{center}
       % file:///home/thirs/github/quiver/src/index.html?q=WzAsOSxbMCwwLCJcXEdhbW1hKFJfMF5cXG9kb3QsWF8wKSJdLFswLDEsIlxcR2FtbWEoUl8wXlxcYnVsbGV0LFhfMCkiXSxbMCwyLCJcXEdhbW1hKFhfMF4yLFhfMCkiXSxbMiwyLCJcXEdhbW1hKFhfMCxYXzApXjIiXSxbMywyLCJYXzBeMiJdLFszLDAsIlJfMF5cXG9kb3QiXSxbMywxLCJSXzBeXFxidWxsZXQiXSxbMSwwLCJcXEdhbW1hKFJfMF5cXG9kb3QsUl8wXlxcb2RvdCkiXSxbMSwyLCJcXEdhbW1hKFhfMF4yLFhfMF4yKSJdLFswLDEsIiIsMCx7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFsxLDJdLFszLDRdLFs1LDYsIiIsMCx7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFs2LDQsIiIsMCx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Imhvb2siLCJzaWRlIjoidG9wIn19fV0sWzAsN10sWzcsNV0sWzcsOF0sWzgsM10sWzIsOF0sWzEsNiwiIiwwLHsic3R5bGUiOnsidGFpbCI6eyJuYW1lIjoiaG9vayIsInNpZGUiOiJ0b3AifSwiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV1d
       \begin{tikzcd}[ampersand replacement=\&]
         {\Gamma(R_0^\odot,X_0)} \& {\Gamma(R_0^\odot,R_0^\odot)} \&\& {R_0^\odot} \\
         {\Gamma(R_0^\bullet,X_0)} \&\&\& {R_0^\bullet} \\
         {\Gamma(X_0^2,X_0)} \& {\Gamma(X_0^2,X_0^2)} \& {\Gamma(X_0,X_0)^2} \& {X_0^2}
         \arrow[two heads, from=1-1, to=2-1]
         \arrow[from=2-1, to=3-1]
         \arrow[from=3-3, to=3-4]
         \arrow[two heads, from=1-4, to=2-4]
         \arrow[hook, from=2-4, to=3-4]
         \arrow[from=1-1, to=1-2]
         \arrow[from=1-2, to=1-4]
         \arrow[from=1-2, to=3-2]
         \arrow[from=3-2, to=3-3]
         \arrow[from=3-1, to=3-2]
         \arrow[dashed, hook, from=2-1, to=2-4]
       \end{tikzcd}
     \end{center}
   \end{proof}

   A final basic property is about symmetry of the relational transitive closure of the relational Howe closure
   on the syntactic transition system (Proposition~\ref{prop:trans:is:sym} below). \tom{work with relations from earlier on?}
   \begin{definition}[{\cite[Definition~9.5]{HL}}]\label{def:relational:transitive:closure}
     The \alert{relational transitive closure} $Râ‚€^{\bar{+}}$ of a
     span $Râ‚€ â†’ Xâ‚€Â²$ is the union $â‹ƒ_{n >0} \im(Râ‚€^{;n})$, where $(-)^{;n}$
     denotes iterated self-composition of spans.
   \end{definition}

   \begin{proposition}\label{prop:trans:action}
     For any span $Râ‚€ â†’ Xâ‚€Â²$, the relational transitive closure
     $Râ‚€^{\bar{+}}$ is equipped with an action
     $Râ‚€;Râ‚€^{\bar{+}} â†’ Râ‚€^{\bar{+}}$ over $Xâ‚€Â²$.
   \end{proposition}
   The proof relies on the following lemma.
   \begin{lemma}\label{lem:seqcomp:cocont}
     In any complete, cocomplete, regular, and locally cartesian closed
     category, hence in particular in any presheaf category,
     \begin{romanenumerate}
     \item \label{item:spancomp:cocont} span composition preserves all
       colimits, on both sides, and
     \item \label{item:seqcomp:cocont} sequential composition of
       relations preserves all unions, on both sides.
     \end{romanenumerate}
   \end{lemma}
   \begin{proof}
     The pullback functor (along the relevant projection), being a left
     adjoint, is cocontinuous, which directly entails the first point.
     For the second point, in a regular category, the pullback functor
     preserves regular epis and monos, hence image factorisations.
   \end{proof}
   \begin{proof}[Proof of Proposition~\ref{prop:trans:action}]
     We have $$Râ‚€ ; â‹ƒ_{n>0} \im(Râ‚€^{;n}) â†  \im(Râ‚€) ; â‹ƒ_{n>0} \im(Râ‚€^{;n}) â‰… â‹ƒ_{n>1} \im(Râ‚€^{;n}) â†ª â‹ƒ_{n>0} \im(Râ‚€^{;n})\rlap{,}$$
     where the isomorphism holds by Lemma~\ref{lem:seqcomp:cocont}\cref{item:seqcomp:cocont}.
   \end{proof}


   \begin{proposition}\label{prop:trans:is:sym}
     Let again $Xâ‚€ = Î£â‚€^*(âˆ…)$. Then the relational transitive closure
     $âˆ…^{â€¢\bar{+}}$ of the proof-irrelevant Howe closure of $âˆ…$ is
     symmetric.
   \end{proposition}

   \begin{lemma}[{\cite[Lemma~9.10]{HL}}]
     For any span $Râ‚€ â†’ ğ™â‚€Â²$, if there exists a span morphism
     $Râ‚€ â†’ Râ‚€^{\bar{+}â€ }$, then $Râ‚€^{\bar{+}}$ is symmetric.
   \end{lemma}


   
   \begin{lemma}
     If a span $R$ is symmetric, in the sense that there is a morphism
     $R^â€  â†’ R$ over $Xâ‚€Â²$, then so is its induced relation.
   \end{lemma}
   \begin{proof}
     We proceed as in the following diagram.
     \begin{center}
       \hfill
       %  file:///home/thirs/github/quiver/src/index.html?q=WzAsNixbMCwwLCJSIl0sWzQsMywiWF4yIl0sWzYsMCwiUiJdLFs2LDEsImltIFIiXSxbMiwxLCJYwrIiXSxbMCwxLCJpbSBSIl0sWzAsMiwicyJdLFsyLDEsIuKfqCDPgOKCgSwgz4DigoIg4p+pIiwyLHsibGFiZWxfcG9zaXRpb24iOjcwfV0sWzIsMywiZSIsMCx7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFszLDEsIm0iLDAseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dLFs0LDEsIuKfqM+A4oKCLM+A4oKB4p+pIiwwLHsibGFiZWxfcG9zaXRpb24iOjYwfV0sWzAsNCwi4p+oIM+A4oKBLCDPgOKCgiDin6kgIiwwLHsibGFiZWxfcG9zaXRpb24iOjcwfV0sWzAsNSwiZSIsMCx7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFs1LDQsIm0iLDAseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dLFs1LDEsIuKfqM+A4oKCLM+A4oKB4p+pIOKImCBtIiwyLHsic3R5bGUiOnsidGFpbCI6eyJuYW1lIjoiaG9vayIsInNpZGUiOiJ0b3AifX19XSxbNSwzLCIiLDAseyJjdXJ2ZSI6Miwic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV1d
\begin{tikzcd}[ampersand replacement=\&,baseline=(\tikzcdmatrixname-4-5.base)]
	R \&\&\&\&\&\& R \\
	{im R} \&\& {XÂ²} \&\&\&\& {im R} \\
	\\
	\&\&\&\& {X^2}
	\arrow["s", from=1-1, to=1-7]
	\arrow["{âŸ¨ Ï€â‚, Ï€â‚‚ âŸ©}"'{pos=0.7}, from=1-7, to=4-5]
	\arrow["e", two heads, from=1-7, to=2-7]
	\arrow["m", hook, from=2-7, to=4-5]
	\arrow["{âŸ¨Ï€â‚‚,Ï€â‚âŸ©}"{pos=0.6}, from=2-3, to=4-5]
	\arrow["{âŸ¨ Ï€â‚, Ï€â‚‚ âŸ© }"{pos=0.7}, from=1-1, to=2-3]
	\arrow["e", two heads, from=1-1, to=2-1]
	\arrow["m", hook, from=2-1, to=2-3]
	\arrow["{âŸ¨Ï€â‚‚,Ï€â‚âŸ© âˆ˜ m}"', hook, from=2-1, to=4-5]
	\arrow[curve={height=12pt}, dashed, from=2-1, to=2-7]
\end{tikzcd}
\qedhere
     \end{center}
   \end{proof}

   \begin{proof}[Proof of Proposition~\ref{prop:trans:is:sym}]
     By the lemma, it suffices to construct a morphism
     $âˆ…^â€¢ â†’ âˆ…^{â€¢\bar{+}â€ }$.  Thus, by
     Proposition~\ref{prop:relwow:alt}, it suffices to endow
     $âˆ…^{â€¢\bar{+}â€ }$ with algebra structure for the endofunctor
     $S â†¦ \im(\Fwow(S))$ on $ğ’ğ®ğ›(Xâ‚€Â²)$.
     For this, because $\Fwow$ is algebraic, it suffices to endow 
     $âˆ…^{â€¢\bar{+}â€ }$ with $\Fwow$-algebra structure.
%     \tom{Pourquoi algebraic? C'est pas juste par relÃ¨vement?}

     We first equip it with $({-};{âˆ¼_X})$-algebra structure.  We need
     to find a morphism $âˆ…^{â€¢\bar{+}â€ };{âˆ¼_X} â†’ âˆ…^{â€¢\bar{+}â€ }$ over
     $Xâ‚€Â²$, or equivalently by applying the involution $(-)^â€ $, a
     morphism ${âˆ¼_X}^â€ ;âˆ…^{â€¢\bar{+}} â†’ âˆ…^{â€¢\bar{+}}$. We pick the
     composite
  $${âˆ¼_X}^â€ ;âˆ…^{â€¢\bar{+}} â†’ {âˆ¼_X};âˆ…^{â€¢\bar{+}} â†’ âˆ…^{â€¢};âˆ…^{â€¢\bar{+}}  â†’ âˆ…^{â€¢\bar{+}}\rlap{,}$$
  where
  \begin{itemize}
  \item the first morphism is symmetry of $âˆ¼_X$, 
  \item the second morphism is that of Lemma~\ref{lem:wow:basicprops}, 
  \item the last morphism is the action from Proposition~\ref{prop:trans:action}.
  \end{itemize}

  This leaves us with the task of equipping $âˆ…^{â€¢\bar{+}â€ }$ with
  algebra structure for the lifting of $Î£â‚€$ to $ğ’ğ®ğ›(Xâ‚€Â²)$, for which
  it suffices, by algebraicity of $Î£â‚€$, to equip it with algebra
  structure for the lifting of $Î£â‚€$ to $\psh[ğ•ğ•‹]/Xâ‚€Â²$, say
  $\bar{Î£}â‚€$. By \citet[Corollary~9.8]{HL}, we have
  $âˆ…^{â€¢\bar{+}â€ } â‰… âˆ…^{â€¢â€ \bar{+}}$, and by \citet[Lemma~9.9]{HL},
  $âˆ…^{â€¢â€ \bar{+}}$ is the colimit of the chain
  \[
    Xâ‚€ â†’ \im (âˆ…^{â€¢â€ }) â‰… \im (âˆ…^{â€¢â€ };Xâ‚€) â†’ \im (âˆ…^{â€¢â€ };âˆ…^{â€¢â€ }) â‰… \im (âˆ…^{â€¢â€ };âˆ…^{â€¢â€ };Xâ‚€) â†’ \im (âˆ…^{â€¢â€ };âˆ…^{â€¢â€ };âˆ…^{â€¢â€ }) â†’ {â€¦}
  \]
  in $\psh[ğ•ğ•‹]/Xâ‚€Â²$.  But $\bar{Î£}â‚€$ is algebraic, hence the forgetful
  functor $\bar{Î£}â‚€\alg â†’ \psh[ğ•ğ•‹]/Xâ‚€Â²$ creates filtered colimits,
  hence in particular colimits of chains.  It thus suffices to lift
  the above chain to $\bar{Î£}â‚€\alg$.  Furthermore, because all objects
  of the chain are relations, they are subterminal, hence all
  morphisms will automatically lift to $\bar{Î£}â‚€\alg$ if the objects
  do.  Finally, the forgetful functor $\bar{Î£}â‚€\alg â†’ \psh[ğ•ğ•‹]/Xâ‚€Â²$
  creates limits, and $âˆ…^{â€¢}$ possesses $Î£â‚€$-algebra structure by
  Lemma~\ref{lem:wow:basicprops}, hence so does $âˆ…^{â€¢â€ }$.  \end{proof}

   To conclude this section, we use the basic facts we just proved to
   reduce the main result to the fact that $âˆ…^â€¢$ is a flexible
   simulation.

   \begin{proposition}\label{prop:reduce2}
     Consider any syntactic signature $ğ = (Î£,(Î“áµ¢,dáµ¢)_{i âˆˆ n})$, and
     suppose that $âˆ…^â€¢_ğ™$ is a flexible simulation.  Then \augmented
     bisimilarity on $ğ™$ is a congruence.
   \end{proposition}
   \begin{remark}
     Let us recall that by Definition~\ref{def:flexible}, $Râ‚€ â†’ Xâ‚€Â²$
     in $\psh[ğ•ğ•‹]$ is a flexible simulation when its cartesian lifting
     $Râ‚€^{â‡‘} â†’ XÂ²$ is.
   \end{remark}
   We will rely on the following lemmas.
\begin{lemma}\label{lem:colimitcreation:cancellation}
  Consider any commutative diagram of functors between locally small categories
  \begin{center}
    \diag{%
      ğ€ \& \& ğ \\
      \& ğ‚ %
    }{%

      (m-1-1) edge[labela={U}] (m-1-3) %
      edge[labelbl={V}] (m-2-2) %
      (m-1-3) edge[labelbr={W}] (m-2-2) %
    }
  \end{center}
  % in $ğ‚ğ€ğ“$.
  If $V$ and $W$ create colimits of a certain shape $D$,
  and $W$ preserves them (typically if $ğ‚$ has them), then $U$ creates
  them.
\end{lemma}
\begin{proof}
  Consider any functor $Jâˆ¶ D â†’ ğ€$ and colimiting cocone $Kâˆ¶ D^âŠ¤ â†’ ğ$
  for $Uâˆ˜J$.  Because $W$ preserves colimits of shape $D$, $Wâˆ˜K$ is
  colimiting for $Wâˆ˜Uâˆ˜J$, hence because $V$ creates colimits, we find
  a unique lifting $J^â†‘$ such that $J^â†‘âˆ˜I = J$ and $V âˆ˜ J^â†‘ = L â‰” Wâˆ˜K$, as in the following diagram.
  \begin{center}
    % https://q.uiver.app/?q=WzAsNixbMiwwLCLwnZCAIl0sWzQsMCwi8J2QgSJdLFsyLDIsIvCdkIIiXSxbMCwwLCJEIl0sWzAsMiwiRF7iiqQiXSxbNCwyLCLwnZCCIl0sWzAsMSwiVSJdLFszLDQsIkkiLDIseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dLFszLDAsIkoiXSxbNCwxLCJLIiwyLHsibGFiZWxfcG9zaXRpb24iOjMwLCJjdXJ2ZSI6MX1dLFs0LDIsIkwiLDJdLFs0LDAsIkpe4oaRIiwwLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV0sWzAsMiwiViIsMCx7ImxhYmVsX3Bvc2l0aW9uIjozMH1dLFsxLDUsIlciXSxbMiw1LCIiLDIseyJsZXZlbCI6Miwic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dXQ==
    \begin{tikzcd}[ampersand replacement=\&]
      D \&\& {ğ€} \&\& {ğ} \\
      \\
      {D^âŠ¤} \&\& {ğ‚} \&\& {ğ‚}
      \arrow["U", from=1-3, to=1-5]
      \arrow["I"', hook, from=1-1, to=3-1]
      \arrow["J", from=1-1, to=1-3]
      \arrow["K"'{pos=0.3}, curve={height=6pt}, from=3-1, to=1-5]
      \arrow["L"', from=3-1, to=3-3]
      \arrow["{J^â†‘}", dashed, from=3-1, to=1-3]
      \arrow["V"{pos=0.3}, from=1-3, to=3-3]
      \arrow["W", from=1-5, to=3-5]
      \arrow[Rightarrow, no head, from=3-3, to=3-5]
    \end{tikzcd}
  \end{center}
  But now $U âˆ˜ J^â†‘$ and $K$ both are candidate liftings for the outer
  rectangle, so by uniqueness in the creation of colimits by $W$ they
  are equal, and thus $J^â†‘$ is a lifting for the original square
  $(J,K)$.

  Furthermore, any lifting for $(J,K)$ induces one for $(J,L)$, hence
  should be equal to $J^â†‘$, which proves uniqueness.

  Finally, $J^â†‘$ is colimiting because $V$ creates colimits of shape
  $D$.
\end{proof}

\begin{definition}
  Given a bifunctor $Î“âˆ¶ ğ‚Â² â†’ ğ‚$ and an object $X$, a
  \alert{$(Î“,X)$-premodule} is an object $M$ equipped with an
  \alert{action}, i.e., a morphism $râˆ¶ Î“(M,X) â†’ M$.  A morphism of
  $(Î“,X)$-premodules is a morphism commuting with action.  We let $(Î“,X)\Mod$
  denote the category of $(Î“,X)$-premodules.
\end{definition}
\begin{terminology}
  When $Î“$ is clear from context, we often omit it and talk about
  $X$-premodules and $X\Mod$.
  % E.g., when a syntactic signature
  % $Ïƒ=(Î£,(Î“áµ¢,dáµ¢)_{i âˆˆ n})$ is in context, we mean $Î“ = âˆ‘áµ¢ Î“áµ¢$.
\end{terminology}
\begin{remark}
 An enhanced span $Râ†’XÂ²$ as in Definition~\ref{def:enhanced-span} is a span in the category of $X$-premodules.
\end{remark}
\begin{lemma}\label{lem:Xmod}
  If $Î“$ is left-cocontinuous and $ğ‚$ is locally finitely presentable
  and regular, then the category $X\Mod$ is regular and the forgetful
  functor $X\Mod â†’ ğ‚$ creates all limits and colimits, as well as
  image factorisations.
\end{lemma}
\begin{proof}
  Creation of limits and colimits follows easily from the fact that
  $X\Mod$ is the category of algebras for the cocontinuous endofunctor
  $Î“({-},X)$.

  In particular, $X\Mod$ is complete and cocomplete, hence regularity
  reduces to showing that regular epis are stable under pullback.
  
  Let us first appeal to~\cite[Â§1.6.5]{HL} for definitions and
  preliminary results about images. Notably, in a locally finitely
  presentable category, (strong epi)-mono factorisations yield image
  factorisations, and union may be computed by cotupling followed by
  (strong epi)-mono factorisation.

  Let us then consider any pullback square
  \begin{center}
    \Diag{%
      \stdpbk %
    }{%
      A \& B \\
      C \& D
    }{%
      (m-1-1) edge[labela={u}] (m-1-2) %
      edge[labell={v}] (m-2-1) %
      (m-2-1) edge[labelb={g}] (m-2-2) %
      (m-1-2) edge[labelr={f}] (m-2-2) %
    }
  \end{center}
  in $X\Mod$, with $f$ a regular epi, and show that $v$ must also be a
  regular epi.  By creation, hence preservation, of limits and
  colimits, the given pullback square is also a pullback in $ğ‚$ and
  $f$ is a regular epi there too. So by regularity of $ğ‚$, $v$ is a
  regular epi in $ğ‚$. Equivalently, it is a coequaliser of its kernel
  pair. But by creation of limits the kernel pair uniquely lifts to a
  kernel pair in $X\Mod$, and by creation of colimits $v$ is a
  coequaliser there too. This shows that $X\Mod$ is regular.

  % Furthermore, if a morphism $eâˆ¶ X â†’ Z$ in $M\Mod$ is a regular epi in
  % $\psh[â„‚â‚€]$, then $e$ is the coequaliser of its kernel pair in $\psh[â„‚â‚€]$, but we
  % just saw how this property lifts to $M\Mod$. Thus, $e$ is also the
  % coequaliser of its kernel pair in $M\Mod$, hence a regular epi.
  

  Finally, let us prove that the forgetful functor creates image
  factorisations.  Given $A,C âˆˆ X\Mod$, let us consider any image
  factorisation $A \xarrow[onto]{e} B \xarrow[into]{m} C$ in $ğ‚$ of a
  morphism $fâˆ¶ A â†’ C$ in $X\Mod$, i.e., $e$ is a regular epi and $m$
  is a mono in $ğ‚$.  In this situation, $e$ is the coequaliser of its
  kernel pair in $ğ‚$, but, as we just saw, this kernel pair lifts to a
  kernel pair in $X\Mod$, whose coequaliser is created by the
  forgetful functor, hence $e$ is a coequaliser, hence a regular epi
  in $X\Mod$. Finally, $f$ also coequalises the kernel pair, hence the
  existence of a unique mediating morphism $B â†’ C$ in $X\Mod$, which
  must be $m$ by faithfulness of the forgetful functor $X\Mod â†’
  ğ‚$. Thus, $m$ is also a morphism in $X\Mod$. Finally, its monicity
  follows again by faithfulness of the forgetful functor.
\end{proof}
\begin{lemma}\label{lem:augmented:images}
  If $ğ‚$ is regular, then \augmented spans are stable under
  images, that is if $pâˆ¶ R â†’ XÂ²$ is \augmented, then so is
  $\im(p)âˆ¶ \im(R) â†ª XÂ²$.
\end{lemma}
\begin{proof}
  By Lemma~\ref{lem:Xmod} (creation of image factorisations).
\end{proof}


\begin{lemma}\label{lem:augmented:coprod}
  The forgetful functor $X\Mod/XÂ² â†’ ğ‚/XÂ²$ creates colimits. Hence, in
  particular (by cocompleteness of $ğ‚/XÂ²$), \augmented spans are
  closed under all colimits in $ğ‚/XÂ²$.
\end{lemma}
\begin{proof}
  Consider the following commutative diagram in $ğ‚ğ€ğ“$.
  \begin{center}
    % file:///home/thirs/github/quiver/src/index.html?q=WzAsNCxbMCwwLCJYXFxNb2QvWMKyIl0sWzIsMCwi8J2Qgi9YwrIiXSxbMCwxLCJYXFxNb2QiXSxbMiwxLCLwnZCCIl0sWzAsMV0sWzAsMl0sWzIsM10sWzEsM11d
    \begin{tikzcd}[ampersand replacement=\&]
      {X\Mod/XÂ²} \&\& {ğ‚/XÂ²} \\
      X\Mod \&\& {ğ‚}
      \arrow[from=1-1, to=1-3]
      \arrow[from=1-1, to=2-1]
      \arrow[from=2-1, to=2-3]
      \arrow[from=1-3, to=2-3]
    \end{tikzcd}    
  \end{center}
  Colimits are created by both (vertical) projection functors, and
  also by the bottom functor by Lemma~\ref{lem:Xmod}.
  Furthermore, $ğ‚$ being cocomplete, the projection functor $ğ‚/XÂ² â†’ ğ‚$
  preserves all colimits, hence by
  Lemma~\ref{lem:colimitcreation:cancellation} the top functor
  creates them.
\end{proof}

   \begin{lemma}\label{lem:rafss}
     For any syntactic signature $ğ = (Î£,(Î“áµ¢,dáµ¢)_{i âˆˆ n})$ and
     $X âˆˆ Ïƒ(ğ)\Trans$, if $Râ‚€ â†ª Xâ‚€Â²$ in $\psh[ğ•ğ•‹]$ is a reflexive,
     \augmented flexible simulation relation, then so is
     $Râ‚€^{\bar{+}}$.
   \end{lemma}
   \begin{proof}
     Reflexivity is clear. For \augmentedness, we have seen in
     Lemmas~\ref{lem:augmented:images} and~\ref{lem:augmented:coprod}
     that \augmented spans are closed under images and coproducts.
     Furthermore, closedness under span composition follows directly
     by Lemma~\ref{lem:wdistrib}.  Finally, in order to show that
     $Râ‚€^{\bar{+}}$ is a flexible simulation, we adopt the
     characterisation of \citet[Lemma~9.9]{HL}, by which
     $Râ‚€^{\bar{+}}$ is the colimit of the chain
     \[
       Xâ‚€ â†’ \im (Râ‚€) â‰… \im (Râ‚€;Xâ‚€) â†’ \im (Râ‚€;Râ‚€) â‰… \im (Râ‚€;Râ‚€;Xâ‚€) â†’ \im (Râ‚€;Râ‚€;Râ‚€) â†’ {â€¦}
     \]
     in $\psh[ğ•ğ•‹]/Xâ‚€Â²$.  By Corollary~\ref{cor:filtered:flex:filtered}, it suffices
     to show that each $\im (Râ‚€^{{;}n})$ is a flexible simulation.  By
     Lemma~\ref{lem:images:flex}, it further suffices to show that
     each $Râ‚€^{{;}n}$ is a flexible simulation.  By induction and
     Lemma~\ref{lem:spancomp:flex}, it finally suffices to show that
     $Râ‚€$ is a flexible simulation, which it is by hypothesis.
   \end{proof}
   
   \begin{proof}[Proof of Proposition~\ref{prop:reduce2}]
     By hypothesis $âˆ…^â€¢$ is a flexible simulation. It is also
     \augmented by Proposition~\ref{prop:Wow:augmented}. Let now
     $Râ‚€ â‰” âˆ…^{â€¢\bar{+}}$, which is again a flexible \augmented
     simulation by Lemma~\ref{lem:rafss}.
     % 
     By Proposition~\ref{prop:trans:is:sym}, $Râ‚€$ is moreover
     symmetric. But any symmetric simulation is in fact a
     bisimulation, so $Râ‚€$ is a flexible \augmented bisimulation.
     Furthermore, $Râ‚€$ contains $âˆ¼_ğ™$ by
     Lemma~\ref{lem:wow:basicprops}\cref{item:wow:contains:bisim}, and
     is a congruence by Lemma~\ref{lem:wow:basicprops}\cref{item:alg}.
     We thus conclude by Corollary~\ref{cor:reduce1}.
   \end{proof}
   
\subsection{The key lemma}
We at last introduce the key lemma, which will directly lead us to a
proof of Theorem~\ref{thm:main}.

\begin{lemma}\label{lem:key}
  For any syntactic signature $ğ = (Î£,(Î“áµ¢,dáµ¢)_{i âˆˆ n})$, if $Î£â‚$
  preserves functional flexible bisimulations, then the cartesian
  lifting $âˆ…^{â€¢â‡‘}_ğ™$ of $âˆ…^â€¢_ğ™$ is a flexible simulation.
\end{lemma}

Before proving the lemma, let us prove the main theorem,
as promised:
\begin{proof}[Proof of Theorem~\ref{thm:main}]  By
  Proposition~\ref{prop:reduce2}, it suffices to prove that $âˆ…^â€¢_ğ™$ is a
  flexible simulation, which is the case by Lemma~\ref{lem:key}.
\end{proof}

The rest of this section is a proof of Lemma~\ref{lem:key}.

\begin{notation}
  We abbreviate $âˆ…^âŠ™_ğ™$ to $âˆ…^âŠ™$ and $âˆ¼^{Ïƒ(ğ)}_ğ™$ to $âˆ¼$.
\end{notation}


In order to prove that $âˆ…^â€¢_ğ™$ is a simulation, it suffices
to prove that $âˆ…^âŠ™_ğ™$ is, by Lemma~\ref{lem:wpbk}.

Briefly, we will construct an $Ï‰$-chain of flexible simulations of the
form
$$\check{Î£}â‚â¿(ğ™â‚€) â† Râ¿ â†’ ğ™\rlap{,}$$
whose projection to $\psh[ğ•ğ•‹]$ is the constant chain on
\begin{equation}
ğ™â‚€ â† âˆ…^âŠ™ â†’ ğ™â‚€\rlap{.}\label{eq:Wowspan}
\end{equation}
By construction, the colimit of this chain will be a flexible
simulation
$$ğ™ â† R^âˆ â†’ ğ™$$
with projection
$$ğ™â‚€ â† âˆ…^âŠ™ â†’ ğ™â‚€\rlap{,}$$
which entails by Lemma~\ref{lem:bisim:epi} that $âˆ…^âŠ™$ is a flexible
simulation as desired.

For this, let us construct a category whose objects are spans of a similar form.
\begin{definition}
  Let $ğ’ğ©ğšğ§/âˆ…^âŠ™$ denote the limit of the diagram
  $$\psh[ğ”¼ğ•‹]/Î”ğ™â‚€ \xot{\psh[ğ”¼ğ•‹]/Î”Ï€â‚} \psh[ğ”¼ğ•‹]/Î”âˆ…^âŠ™ \xto{\psh[ğ”¼ğ•‹]/Î”Ï€â‚‚} \psh[ğ”¼ğ•‹]/Î”ğ™â‚€ \xot{ğ™} 1$$
  weighted by
    $$ğŸš \xot{0} 1 \xto{0} ğŸš \xot{1} 1$$
\end{definition}
\begin{remark}
  A weighted cone from some category $A$ is thus a diagram of the form
  \begin{center}
    % file:///home/thirs/github/quiver/src/index.html?q=WzAsNSxbMiwwLCJBIl0sWzAsMiwiXFxwc2gvzpTwnZCZ4oKAIl0sWzIsMiwiXFxwc2gvzpTiiIVe4oCiIl0sWzQsMiwiXFxwc2gvzpTwnZCZ4oKAIl0sWzQsMCwiMSJdLFsyLDEsIlxccHNoL86Uz4DigoEiXSxbMiwzLCJcXHBzaC/OlM+A4oKCIiwyXSxbNCwzLCLwnZCZIl0sWzAsMSwiWSIsMl0sWzAsMiwiWCIsMCx7ImxhYmVsX3Bvc2l0aW9uIjo4MH1dLFswLDQsIiEiXSxbOSw4LCIiLDAseyJzaG9ydGVuIjp7InNvdXJjZSI6MjAsInRhcmdldCI6MjB9fV0sWzksNywiIiwyLHsic2hvcnRlbiI6eyJzb3VyY2UiOjIwLCJ0YXJnZXQiOjIwfX1dXQ==
\begin{tikzcd}[ampersand replacement=\&]
	\&\& A \&\& 1 \\
	\\
	{\psh[ğ”¼ğ•‹]/Î”ğ™â‚€} \&\& {\psh[ğ”¼ğ•‹]/Î”âˆ…^âŠ™} \&\& {\psh[ğ”¼ğ•‹]/Î”ğ™â‚€}
	\arrow["{\psh[ğ”¼ğ•‹]/Î”Ï€â‚}", from=3-3, to=3-1]
	\arrow["{\psh[ğ”¼ğ•‹]/Î”Ï€â‚‚}"', from=3-3, to=3-5]
	\arrow[""{name=0, anchor=center, inner sep=0}, "{ğ™}", from=1-5, to=3-5]
	\arrow[""{name=1, anchor=center, inner sep=0}, "Y"', from=1-3, to=3-1]
	\arrow[""{name=2, anchor=center, inner sep=0}, "X"{pos=0.8}, from=1-3, to=3-3]
	\arrow["{!}", from=1-3, to=1-5]
	\arrow[shorten <=8pt, shorten >=8pt, Rightarrow, from=2, to=1]
	\arrow[shorten <=16pt, shorten >=16pt, Rightarrow, from=2, to=0]
\end{tikzcd}
  \end{center}
  
  
  Hence, objects of the weighted limit are spans of the form $Y â† X â†’ ğ™$
  over~\eqref{eq:Wowspan}, and a morphism from such a span to some
  span $Y' â† X' â†’ ğ™$ is a pair $(gâˆ¶ Yâ‚ â†’ Y'â‚, fâˆ¶ Xâ‚ â†’ X'â‚)$ of
  morphisms in $\psh[ğ”¼ğ•‹]$ making the following diagram commute.
  \begin{center}
% https://q.uiver.app/?q=WzAsOCxbMiwwLCJYXzEiXSxbMCwwLCJZ4oKBIl0sWzMsMSwiWCfigoEiXSxbMSwxLCJZJ+KCgSJdLFswLDIsIs6U8J2QmeKCgCJdLFsyLDIsIs6U4oiFXuKAoiJdLFs0LDAsIvCdkJnigoEiXSxbNCwyLCLOlPCdkJnigoAiXSxbMCwxXSxbMiwzXSxbMCwyLCJmIl0sWzEsMywiZyJdLFsxLDRdLFszLDRdLFswLDVdLFsyLDVdLFs1LDRdLFswLDZdLFsyLDZdLFs2LDddLFs1LDddXQ==
\begin{tikzcd}[ampersand replacement=\&]
	{Yâ‚} \&\& {X_1} \&\& {ğ™â‚} \\
	\& {Y'â‚} \&\& {X'â‚} \\
	{Î”ğ™â‚€} \&\& {Î”âˆ…^âŠ™} \&\& {Î”ğ™â‚€}
	\arrow[from=1-3, to=1-1]
	\arrow["f", from=1-3, to=2-4]
	\arrow["g", from=1-1, to=2-2]
	\arrow[from=1-1, to=3-1]
	\arrow[from=2-2, to=3-1]
	\arrow[from=1-3, to=3-3]
	\arrow[from=2-4, to=3-3]
	\arrow[from=3-3, to=3-1]
	\arrow[from=1-3, to=1-5]
	\arrow[from=2-4, to=1-5]
	\arrow[from=1-5, to=3-5]
	\arrow[from=3-3, to=3-5]
	\arrow[from=2-4, to=2-2, fore]
\end{tikzcd}    
  \end{center}
\end{remark}

\begin{proposition}
  The forgetful functor to $\psh[ğ”¼ğ•‹]Â²$ mapping any span
  $Y â† X â†’ ğ™$ to $(Yâ‚,Xâ‚)$ creates colimits and connected limits.
\end{proposition}
\begin{proof}
  Straightforward.
\end{proof}

\begin{proposition}
  The category $ğ’ğ©ğšğ§/âˆ…^âŠ™$ has as initial object the span
  $ğ™â‚€ â† âˆ…^âŠ™ â†’ ğ™$.
\end{proposition}

Since $ğ™â‚€ = \check{Î£}â‚â¿(ğ™â‚€)$, this span has the desired form, and its
left-hand leg is trivially a functional flexible bisimulation, so we
may take it as our $Râ°$.


\begin{definition}
  Let $F$ denote the endofunctor on $ğ’ğ©ğšğ§/âˆ…^âŠ™$ that maps any object
  \begin{center}
    \diag{%
      Yâ‚ \& Xâ‚ \& ğ™â‚ \\
      Î”ğ™â‚€ \& Î”âˆ…^âŠ™ \& ğ™â‚€ %
    }{%
      (m-1-1) edge[<-,labela={}] (m-1-2) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[<-,labelb={}] (m-2-2) %
      (m-1-2) edge[labela={}] (m-1-3) %
      edge[labell={}] (m-2-2) %
      (m-2-2) edge[labelb={}] (m-2-3) %
      (m-1-3) edge[labelr={}] (m-2-3) %
    }
  \end{center}
to
  \begin{center}
    \diag{%
      Î£â‚(Y)â‚ \& Î£â‚(X)â‚;(âˆ¼^*)^â†‘ \& ğ™â‚ \\
      Î”_{ğŸš,ğ¬,ğ¥,ğ­}(Î£â‚€^?(ğ™â‚€),ğ™â‚€) \& Î”_ğ¬(Î£â‚€^?(âˆ…^âŠ™);âˆ¼^*) Ã— Î”_ğ¥(âˆ…^âŠ™;ğ™â‚€) Ã— Î”_ğ­(âˆ…^âŠ™;âˆ¼^*) \& Î”_{ğŸš,ğ¬,ğ¥,ğ­}(Î£â‚€^?(ğ™â‚€),ğ™â‚€) \\
      Î”ğ™â‚€ \& Î”âˆ…^âŠ™ \& ğ™â‚€. %
    }{%
      (m-1-1) edge[<-,labela={}] (m-1-2) %
      edge[labell={}] (m-2-1) %
      (m-2-1) edge[<-,labelb={}] (m-2-2) %
      (m-1-2) edge[labela={}] (m-1-3) %
      edge[labell={}] (m-2-2) %
      (m-2-2) edge[labelb={}] (m-2-3) %
      (m-1-3) edge[labelr={}] (m-2-3) %
      %
      (m-2-1)
      edge[labell={}] (m-3-1) %
      (m-3-1) edge[<-,labelb={}] (m-3-2) %
      (m-2-2)
      edge[labell={}] (m-3-2) %
      (m-3-2) edge[labelb={}] (m-3-3) %
      (m-2-3) edge[labelr={}] (m-3-3) %

    }
  \end{center}
\end{definition}



\begin{definition}
Let $Râ¿$ be the initial $F$-chain.
\end{definition}

\begin{lemma}
  The endofunctor $F$ preserves flexible simulations.
\end{lemma}
\begin{proof}
  Given any span $Y â† X â†’ ğ™$ over~\eqref{eq:Wowspan}, the left leg of
  its image under $F$ is functional flexible simulation iff the following pasting is a pointwise weak pullback.
  \begin{center}
    % file:///home/thirs/github/quiver/src/index.html?q=WzAsOCxbMiwzLCLOlF978J2QrCzwnZClffCdkJnigoAiXSxbMCwzLCLOlF978J2QrCzwnZClfeKIhV7igKIiXSxbMiwwLCLOo+KCgShZKV8xIl0sWzAsMiwizpRfe1xcbWF0aGJiezJ9LPCdkKws8J2QpX0oKM6j4oKAXj8o4oiFXuKAoik74oi8XiopLOKIhV7igKIpIl0sWzIsMiwizpRfe1xcbWF0aGJiezJ9LPCdkKws8J2QpX0ozqPigoBePyjwnZCZ4oKAKSzwnZCZ4oKAKSJdLFsxLDIsIs6UX3tcXG1hdGhiYnsyfSzwnZCsLPCdkKV9KM6j4oKAXj8o4oiFXuKAoiks4oiFXuKAoikiXSxbMSwwLCLOo+KCgShYKeKCgSJdLFswLDAsIijOo+KCgShYKTso4oi8XiopXuKHkSnigoEiXSxbMSwwXSxbMywxXSxbNCwwXSxbMiw0XSxbMyw1XSxbNSw0XSxbNiw1XSxbNiwyXSxbNywzXSxbNyw2XV0=
\begin{tikzcd}[ampersand replacement=\&]
	{Î£â‚(X)â‚;(âˆ¼^*)^â†‘} \& {Î£â‚(X)â‚} \& {Î£â‚(Y)_1} \\
	\\
	{Î”_ğ¬(Î£â‚€^?(âˆ…^âŠ™);âˆ¼^*) Ã— Î”_ğ¥(âˆ…^âŠ™;ğ™â‚€)} \& {Î”_{\mathbb{2},ğ¬,ğ¥}(Î£â‚€^?(âˆ…^âŠ™),âˆ…^âŠ™)} \& {Î”_{\mathbb{2},ğ¬,ğ¥}(Î£â‚€^?(ğ™â‚€),ğ™â‚€)} \\
	{Î”_{ğ¬,ğ¥}âˆ…^âŠ™} \&\& {Î”_{ğ¬,ğ¥}ğ™â‚€}
	\arrow[from=4-1, to=4-3]
	\arrow[from=3-1, to=4-1]
	\arrow[from=3-3, to=4-3]
	\arrow[from=1-3, to=3-3]
	\arrow[from=3-1, to=3-2]
	\arrow[from=3-2, to=3-3]
	\arrow[from=1-2, to=3-2]
	\arrow[from=1-2, to=1-3]
	\arrow[from=1-1, to=3-1]
	\arrow[from=1-1, to=1-2]
\end{tikzcd}
  \end{center}
  

  For this, by \citet[Lemma~9.26,(i)]{HL}, it suffices to prove that
  all three inner polygons are pointwise weak pullbacks.  The top
  right square is a pointwise weak pullback because $Î£â‚$ preserves
  functional flexible bisimulations.  The top left square also is a
  pointwise weak pullback, as the left face of the following cube.
    \begin{center}
      % file:///home/thirs/github/quiver/src/index.html?q=WzAsOSxbMCwyLCLOlF/wnZCsKM6j4oKAXj8o4oiFXuKAoik74oi8XiopIMOXIM6UX/CdkKUo4oiFXuKAojvwnZCZ4oKAKSJdLFsxLDMsIs6UX3tcXG1hdGhiYnsyfSzwnZCsLPCdkKV9KM6j4oKAXj8o4oiFXuKAoiks4oiFXuKAoikiXSxbMSwxLCLOo+KCgShS4oG/KeKCgSJdLFswLDAsIijOo+KCgShS4oG/KTso4oi8XiopXuKHkSnigoEiXSxbMywxLCLwnZCZ4oKBIl0sWzMsMywizpRfe/CdkKws8J2QpX0o8J2QmeKCgCkiXSxbMiwwLCIo4oi8XiopXuKHkeKCgSJdLFsyLDIsIs6UX/CdkKwo4oi8Xiopw5fOlF/wnZClKPCdkJnigoApIl0sWzAsMSwizpRfe1xcbWF0aGJiezJ9LPCdkKws8J2QpX0oKM6j4oKAXj8o4oiFXuKAoik74oi8XiopLOKIhV7igKIpIl0sWzAsMV0sWzIsMV0sWzMsMl0sWzIsNF0sWzEsNV0sWzQsNV0sWzYsNF0sWzYsN10sWzcsNV0sWzMsNl0sWzAsN10sWzMsNCwiIiwxLHsic3R5bGUiOnsibmFtZSI6ImNvcm5lciJ9fV0sWzAsNSwiIiwxLHsic3R5bGUiOnsibmFtZSI6ImNvcm5lciJ9fV0sWzMsOF0sWzgsMCwiIiwxLHsibGV2ZWwiOjIsInN0eWxlIjp7ImhlYWQiOnsibmFtZSI6Im5vbmUifX19XV0=
\begin{tikzcd}[ampersand replacement=\&]
	{Î£â‚(X)â‚;(âˆ¼^*)^â†‘} \&\& {(âˆ¼^*)^â†‘} \\
        \& {Î£â‚(X)â‚} \&\& {ğ™â‚} \\
	{Î”_ğ¬(Î£â‚€^?(âˆ…^âŠ™);âˆ¼^*) Ã— Î”_ğ¥(âˆ…^âŠ™;ğ™â‚€)} \&\& {Î”_ğ¬(âˆ¼^*)Ã—Î”_ğ¥(ğ™â‚€)} \\
	\& {Î”_{\mathbb{2},ğ¬,ğ¥}(Î£â‚€^?(âˆ…^âŠ™),âˆ…^âŠ™)} \&\& {Î”_{ğ¬,ğ¥}(ğ™â‚€)}
	\arrow[from=3-1, to=4-2]
	\arrow[from=2-2, to=4-2]
	\arrow[from=1-1, to=2-2]
	\arrow[from=2-2, to=2-4]
	\arrow[from=4-2, to=4-4]
	\arrow[from=2-4, to=4-4]
	\arrow[from=1-3, to=2-4]
	\arrow[from=1-3, to=3-3]
	\arrow[from=3-3, to=4-4]
	\arrow[from=1-1, to=1-3]
	\arrow[from=3-1, to=3-3]
	\arrow[from=1-1, to=3-1]
\end{tikzcd}
    \end{center}
    Indeed, the top and bottom faces are pullbacks by construction,
    and the right face is a pointwise weak pullback because $âˆ¼^*$ is a
    bisimulation. The left face being a pointwise weak pullback thus
    follows by \citet[Lemma~9.26,(i)]{HL}.

    Finally, for the bottom rectangle, its domain is 
    $$
    \begin{array}{rcl}
      Î”_ğ¬(Î£â‚€^?(âˆ…^âŠ™);âˆ¼^*) Ã— Î”_ğ¥(âˆ…^âŠ™;ğ™â‚€)             & â‰… & Î”_ğ¬(Î£â‚€^?(âˆ…^âŠ™);âˆ¼^*) Ã— Î”_ğ¥(âˆ…^âŠ™) \\
                                     & â‰… & Î”_ğ¬(Î£â‚€(âˆ…^âŠ™);âˆ¼^* + âˆ…^âŠ™;âˆ¼^*) Ã— Î”_ğ¥(âˆ…^âŠ™) \\
                                     & â‰… & (Î”_ğ¬(Î£â‚€(âˆ…^âŠ™);âˆ¼^*) + Î”_ğ¬(âˆ…^âŠ™;âˆ¼^*)) Ã— Î”_ğ¥(âˆ…^âŠ™) \\
                                     & â‰… & Î”_ğ¬(Î£â‚€(âˆ…^âŠ™);âˆ¼^*) Ã— Î”_ğ¥(âˆ…^âŠ™) + Î”_ğ¬(âˆ…^âŠ™;âˆ¼^*)Ã— Î”_ğ¥(âˆ…^âŠ™) \\
                                     & â‰… & Î”_{ğŸš,ğ¬,ğ¥}((Î£â‚€(âˆ…^âŠ™);âˆ¼^*),âˆ…^âŠ™) +     Î”_{ğŸš,ğ¬,ğ¥}((âˆ…^âŠ™;âˆ¼^*),âˆ…^âŠ™).
    \end{array}$$
    Similarly, we have
    $Î”_{ğŸš,ğ¬,ğ¥}(Î£â‚€^?ğ™â‚€,ğ™â‚€) â‰… Î”_{ğŸš,ğ¬,ğ¥}(Î£â‚€ğ™â‚€,ğ™â‚€) + Î”_{ğŸš,ğ¬,ğ¥}(Î£â‚€^?ğ™â‚€,ğ™â‚€)$.
    The rectangle is thus obtained by applying $Î”_{ğŸš,ğ¬,ğ¥}$ to the (vertical) copairing of
    the following two squares.
    \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNCxbMCwwLCLOo+KCgCjiiIVe4oCiKTviiLxeKiJdLFsxLDAsIs6j4oKA8J2QmeKCgCJdLFsxLDEsIvCdkJnigoAiXSxbMCwxLCLiiIVe4oCiIl0sWzAsMywi4omFIiwyXSxbMCwxXSxbMSwyLCLiiYUiXSxbMywyXV0=
\begin{tikzcd}[ampersand replacement=\&]
	{Î£â‚€(âˆ…^âŠ™);âˆ¼^*} \& {Î£â‚€ğ™â‚€} \\
	{âˆ…^âŠ™} \& {ğ™â‚€}
	\arrow["{â‰…}"', from=1-1, to=2-1]
	\arrow[from=1-1, to=1-2]
	\arrow["{â‰…}", from=1-2, to=2-2]
	\arrow[from=2-1, to=2-2]
      \end{tikzcd}
      \quad
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNCxbMCwwLCLiiIVe4oCiO+KIvF4qIl0sWzAsMSwi4oiFXuKAoiJdLFsxLDEsIvCdkJnigoAiXSxbMSwwLCLwnZCZ4oKAIl0sWzAsM10sWzAsMV0sWzEsMl0sWzMsMiwiIiwyLHsibGV2ZWwiOjIsInN0eWxlIjp7ImhlYWQiOnsibmFtZSI6Im5vbmUifX19XV0=
\begin{tikzcd}[ampersand replacement=\&]
	{âˆ…^âŠ™;âˆ¼^*} \& {ğ™â‚€} \\
	{âˆ…^âŠ™} \& {ğ™â‚€}
	\arrow[from=1-1, to=1-2]
	\arrow[from=1-1, to=2-1]
	\arrow[from=2-1, to=2-2]
	\arrow[Rightarrow, no head, from=1-2, to=2-2]
      \end{tikzcd}
    \end{center}
    Because pointwise weak pullbacks are closed under (vertical)
    copairing and preserved by $Î”_{ğŸš,ğ¬,ğ¥}$, it thus suffices to show
    that both squares are pointwise weak pullbacks.  The left square
    is one as an isomorphism in the arrow category.  The right square
    is one because it admits a cone morphism from the actual pullback,
    using reflexivity of $âˆ¼^*$ as in
    \begin{center}
% file:///home/thirs/github/quiver/src/index.html?q=WzAsNSxbMCwwLCLiiIVe4oCiIl0sWzEsMSwi4oiFXuKAojviiLxeKiJdLFsxLDIsIuKIhV7igKIiXSxbMiwyLCLwnZCZ4oKAIl0sWzIsMSwi8J2QmeKCgCJdLFswLDIsIiIsMix7ImxldmVsIjoyLCJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzAsNF0sWzAsMV0sWzEsNF0sWzEsMl0sWzIsM10sWzQsMywiIiwyLHsibGV2ZWwiOjIsInN0eWxlIjp7ImhlYWQiOnsibmFtZSI6Im5vbmUifX19XV0=
\begin{tikzcd}[ampersand replacement=\&]
	{âˆ…^âŠ™} \\
	\& {âˆ…^âŠ™;âˆ¼^*} \& {ğ™â‚€} \\
	\& {âˆ…^âŠ™} \& {ğ™â‚€\rlap{.}}
	\arrow[Rightarrow, no head, from=1-1, to=3-2]
	\arrow[from=1-1, to=2-3]
	\arrow[from=1-1, to=2-2]
	\arrow[from=2-2, to=2-3]
	\arrow[from=2-2, to=3-2]
	\arrow[from=3-2, to=3-3]
	\arrow[Rightarrow, no head, from=2-3, to=3-3]
\end{tikzcd}            
    \end{center}
\end{proof}

% \begin{mathpar}
%   \inferrule{ }{Î¹(v) \xto{Î¹} v} \and \inferrule{v \xto{Î±} e}{Î¹(v)
%     \xto{Î±} e} \and \inferrule{eâ‚‚ \xto{Î¹} v \\ eâ‚ \xto{v} eâ‚ƒ}{eâ‚\ eâ‚‚
%     \xto{Ï„} eâ‚ƒ} \and
%   \inferrule{ }{Î»(e) \xto{v} e[v]} \\
%   \inferrule{eâ‚ \xto{Ï„} e'â‚}{eâ‚\ eâ‚‚ \xto{Ï„} e'â‚\ eâ‚‚} \and
%   \inferrule{eâ‚ \xto{Î¹} v \\ eâ‚‚ \xto{Ï„} e'â‚‚}{eâ‚\ eâ‚‚ \xto{Ï„} Î¹(v)\ e'â‚‚}
%   \and \inferrule{e \xto{Ï„} e'}{âŸ¨eâŸ© \xto{Ï„} âŸ¨e'âŸ©} \and
%   \inferrule{e \xto{Î¹} v}{âŸ¨eâŸ© \xto{Ï„} v} \\
%   \inferrule{ }{ğ’®k.e \xto{E} âŸ¨e [ k â†¦ Î»x.âŸ¨E[x]âŸ© ]âŸ©} \and \inferrule{e
%     \xto{â–«} e'}{âŸ¨eâŸ© \xto{Ï„} e'} \and \inferrule{eâ‚ \xto{E[â–«\ eâ‚‚]}
%     eâ‚ƒ}{eâ‚\ eâ‚‚ \xto{E} eâ‚ƒ} \and \inferrule{eâ‚ \xto{Î¹} v \\ eâ‚‚
%     \xto{E[v\ â–«]} eâ‚ƒ}{eâ‚\ eâ‚‚ \xto{E} eâ‚ƒ} \and \inferrule{ }{e \xto{Ï„}
%     e} \and \inferrule{eâ‚ \xto{Ï„} eâ‚‚ \xto{Î±} eâ‚ƒ}{eâ‚ \xto{Î±} eâ‚ƒ} \and
%   \inferrule{eâ‚ \xto{Î±} eâ‚‚ \xto{Ï„} eâ‚ƒ}{eâ‚ \xto{Î±} eâ‚ƒ}
% \end{mathpar}
\section{Proof of Theorem~\ref{thm:cellular}}
\label{app:proof-cellular}

We assume some basic knowledge of familial functors.  In particular,
there is a well-known alternative characterisation in terms of
\alert{generic-free} factorisation, across which border arities are
characterised as follows.
\begin{proposition}
  In the setting of~\cref{def:border}, for any $Î± âˆˆ ğ”¼ğ•‹$ and
  $r âˆˆ ğ’°'_ğŸšÎ£â‚(1)(Î±)$, the border arity $ğ›áµ£$ is isomorphic to the
  morphism $Ï•$ obtained by first factoring $r$ as
  $ğ²_Î± \xto{Î¾áµ£} ğ’°'_ğŸšÎ£â‚(B) \xto{ğ’°'_ğŸšÎ£â‚(!)} ğ’°'_ğŸšÎ£â‚(1)$ with $Î¾áµ£$
  generic, and then $Î¾áµ£ âˆ˜ j_{ğŸš,Î±}$ as $F(Ï•)âˆ˜Ï‡áµ£$ with $Ï‡áµ£$ generic.
  \begin{center}
    \diag{%
      ğ²_{ğ¬(Î±)_D} + âˆ‘_{i âˆˆ n_Î±} ğ²_{(ğ¥^Î±áµ¢)_V} \& ğ²_Î± \\
      ğ’°'_ğŸš(Î£â‚(A)) \& ğ’°'_ğŸš(Î£â‚(B)) %
    }{%
      (m-1-1) edge[labela={j_{ğŸš,Î±}}] (m-1-2) %
      edge[labell={Ï‡áµ£}] (m-2-1) %
      (m-2-1) edge[labelb={ğ’°'_ğŸš(Î£â‚(Ï•))}] (m-2-2) %
      (m-1-2) edge[labelr={Î¾áµ£}] (m-2-2) %
    }
  \end{center}
\end{proposition}


\begin{lemma}\label{lem:characfib}
  For any categories with generating cofibrations $(ğ’œ,ğ•)$ and $(â„¬,ğ•‚)$,
  % such that $ğ’œ$ has a terminal object
 a familial functor $Fâˆ¶ ğ’œ â†’ â„¬$
  preserves fibrations iff it is \alert{cellular}, in the sense that
  for all commuting squares
  \begin{equation}
    \hfil \diag{%
      C \& D \\
      F(X) \& F(Y)%
    }{%
      (m-1-1) edge[labela={k}] (m-1-2) %
      edge[labell={Î¾}] (m-2-1) %
      (m-2-1) edge[labelb={F(Î´)}] (m-2-2) %
      (m-1-2) edge[labelr={Ï‡}] (m-2-2) %
    }
    \label{eq:gensquare}
  \end{equation}
  with $k âˆˆ ğ•‚$ and $Î¾$ and $Ï‡$ generic,
  $Î´$ is a cofibration (i.e., $Î´ âˆˆ \wbotrightleft{ğ•}$).
\end{lemma}
\begin{proof}
  This is a straightforward generalisation of~\citet[Lemma~7.28]{HL},
  whose proof applies \emph{mutatis mutandis}.
\end{proof}

\begin{proof}[Proof of Theorem~\ref{thm:cellular}]
  We assume given a dynamic signature $Î£â‚âˆ¶ Ïƒ\Trans â†’ Ïƒ\Trans_ğŸš$ such that
  $ğ’°_ğŸšÎ£â‚$ is familial. 
  By that that 
  By Proposition~\ref{prop:ffbisim-fib},
  $Î£â‚$ preserves functional flexible bisimulations if and only if $ğ’°_ğŸšÎ£â‚$ maps 
  $ğ•_Ïƒ$-fibrations to $ğ•_{ğŸš,Ïƒ}$-fibrations, or equivalently, by
  Lemma~\ref{lem:characfib},
  if it is cellular.

  Clearly, $ğ’°_ğŸšÎ£â‚$ is cellular, then the border
  arities of all rules are $ğ•_Ïƒ$-cofibrations, by a straightforward
  instantiation
  of Diagram~\ref{eq:gensquare}.
  Conversely, assume that all rules are $ğ•_Ïƒ$-cofibrations and consider a
  commuting square as in Diagram~\ref{eq:gensquare}, taking $F=ğ’°_ğŸšÎ£â‚$, specialised to the
  involved sets of cofibrations:
  \begin{center}
  \diag{%
    ğ²_{ğ¬(Î±)_D} + âˆ‘_{i âˆˆ n_Î±} ğ²_{(ğ¥^Î±áµ¢)_V} \& ğ²_Î± \\
    F(A) \& F(B)\rlap{.} %
  }{%
    (m-1-1) edge[labela={j_{ğŸš,Î±}}] (m-1-2) %
    edge[labell={Ï‡áµ£}] (m-2-1) %
    (m-2-1) edge[labelb={F(Ï•)}] (m-2-2) %
    (m-1-2) edge[labelr={Î¾áµ£}] (m-2-2) %
  }
\end{center}
The result follows by considering the rule $ğ²_Î± \xto{Î¾áµ£}F(B) \xto{F(!)} F(1)$
and exploiting uniqueness (up to isomorphism) of generic
factorisations~\cite[Remark 7.19]{HL}.
\end{proof}
\end{document}


%%% Local Variables: 
%%% coding: utf-8
%%% mode: LaTeX
%%% TeX-engine: pdflatex
%%% TeX-command-default: "RubberInto"
%%% ispell-dictionary: "british"
%%% default-input-method: "Patoline"
%%% eval: (activate-input-method "Patoline")
%%% abbrev-file-name: "./abbrev.el"
%%% eval: (load-file "./abbrev.el")
%%% eval: (abbrev-mode 1)
%%% End:


