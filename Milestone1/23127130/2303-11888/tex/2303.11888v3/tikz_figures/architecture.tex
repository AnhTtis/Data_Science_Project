\tikzstyle{module} = [rectangle, rounded corners, text centered, draw=black, fill=network-blue!70]
\tikzstyle{arrow} = [thick,->,>=stealth]
\tikzstyle{emb} = [rectangle, minimum width=0.5cm, align=center, draw=black, fill=emb-c!60, font=\scriptsize\linespread{0.9}\selectfont]
\tikzstyle{loss} = [rectangle, minimum width=0.5cm, align=center, draw=black, fill=white, font=\scriptsize\linespread{0.9}\selectfont]
\tikzstyle{dash-box} = [rectangle, dashed, thick, draw=black]

\begin{figure*}
    \centering
    \begin{adjustbox}{width=0.95\textwidth}
    \begin{tikzpicture}[node distance=2cm]
        \node[inner sep=0pt] (front) at (0,0)
        {\includegraphics[width=2.5cm]{figures/front.png}};
        \node[inner sep=0pt, below of=front, yshift=-3cm, xshift=-0.25cm] (lidar2)
        {\includegraphics[width=2cm]{figures/lidar2.png}};
        \node[inner sep=0pt, below of=front, yshift=-3.5cm, xshift=0.25cm] (lidar1)
        {\includegraphics[width=2cm]{figures/lidar1.png}};
        
        \node (legend1) [emb, below of=lidar1, xshift=-1.25cm, yshift=-0.25cm, minimum width=0.5cm, minimum height=0.5cm, fill=light-yellow, label={[label distance=0cm]0: Shared Features}]  {};
        \node (legend2) [emb, right of=legend1, xshift=1cm, minimum width=0.5cm, minimum height=0.5cm, fill=light-green, label={[label distance=0cm]0: Unique Features}]  {};
        \node (legend3) [emb, right of=legend2, xshift=1.1cm, minimum width=0.5cm, minimum height=0.5cm, fill=light-red, label={[label distance=0cm]0: Measurements}]  {};
        
        \node (resnet34) [module,  right of=front, text width=2cm, align=center, xshift=1cm, minimum height=1.5cm] {Resnet34};
        \node (resnet18) [module,  right of=lidar1, text width=2cm, align=center, xshift=0.75cm, yshift=0.25cm, minimum height=1.5cm] {Resnet18};
        \node (rgb-emb) [emb, right of=resnet34, xshift=0.25, minimum height=1.5cm] { 5\\1\\2};
        \node (lidar-emb) [emb, right of=resnet18, xshift=0.25, minimum height=1.5cm] {5\\1\\2};
        \node (mlp1) [module,  right of=rgb-emb, text width=1cm, align=center, xshift=0.25cm, yshift=1cm, minimum height=1.5cm] {MLP};
        \node (mlp2) [module,  right of=rgb-emb, text width=1cm, align=center, xshift=0.25cm, yshift=-1cm, minimum height=1.5cm] {MLP};
        \node (align-loss) [loss, below of=mlp2, yshift=0.375cm, minimum height=0.75cm, minimum width=1.25cm] {Align.\\Loss};
        \node (mlp3) [module,  right of=lidar-emb, text width=1cm, align=center, xshift=0.25cm, yshift=1cm, minimum height=1.5cm] {MLP};
        \node (mlp4) [module,  right of=lidar-emb, text width=1cm, align=center, xshift=0.25cm, yshift=-1cm, minimum height=1.5cm] {MLP};
        \node (rgb-emb-u) [emb, right of=mlp1, xshift=-0.25cm, minimum height=1.5cm, fill=light-green] {1\\2\\8};
        \node (rgb-emb-s) [emb, right of=mlp2, xshift=-0.25cm, minimum height=1.5cm, fill=light-yellow] {1\\2\\8};
        \node (lidar-emb-s) [emb, right of=mlp3, xshift=-0.25cm, minimum height=1.5cm, fill=light-yellow] {1\\2\\8};
        \node (lidar-emb-u) [emb, right of=mlp4, xshift=-0.25cm, minimum height=1.5cm, fill=light-green] {1\\2\\8};
        \node (measurements) [emb, below of=lidar-emb-u, yshift=0.5cm, minimum height=0.5cm, fill=light-red] {4};
        \node (dash-box1) [dash-box, right of=mlp2, xshift=-0.25cm, yshift=-2.125cm, minimum width=1cm, minimum height=10.25cm, draw=emb-c!60]{};
        
        \node (decoder1) [module,  right of=rgb-emb-u, text width=1.25cm, align=center, xshift=1cm, minimum height=1.5cm] {Decoder};
        \node (decoder2) [module,  right of=rgb-emb-s, text width=1.25cm, align=center, xshift=1cm, yshift=-0.5cm, minimum height=1.5cm] {Decoder};
        \node (decoder3) [module,  right of=lidar-emb-s, text width=1.25cm, align=center, xshift=1cm, yshift=0.5cm, minimum height=1.5cm] {Decoder};
        \node (mlp5) [module,  right of=lidar-emb-u, text width=1cm, align=center, xshift=-0.25cm, minimum height=1.5cm] {MLP};
        \node (emb-c) [emb, right of=mlp5, xshift=-0.5cm, minimum height=1.5cm] {6\\4};

        \node (gru-decoder) [module,  right of=emb-c, text width=1.25cm, align=center, xshift=-0.375cm, minimum height=1.5cm] {GRU\\Decoder};
        \node (goal-location) [emb, below of=gru-decoder, minimum height=0.75cm, yshift=0.5cm] {Goal\\Location};
        

        \node (dash-box2) [dash-box, right of=decoder1, xshift=1.5cm, yshift=0cm, minimum width=2.5cm, minimum height=1.5cm]{};
        \node[inner sep=0pt, left of=dash-box2, yshift=0cm, xshift=1.375cm] (stopsign){\includegraphics[width=1cm]{figures/stop-sign.png}};
        \node[inner sep=0pt, right of=stopsign, yshift=0cm, xshift=-0.75cm] (stopsign){\includegraphics[width=1cm]{figures/traffic-light.png}};
        
        \node[inner sep=0pt, right of=decoder2, xshift=1.5cm] (front-seg){\includegraphics[width=2.5cm]{figures/front_seg.png}};
        \node[inner sep=0pt, right of=decoder3, xshift=1.75cm] (topdown-seg){\includegraphics[width=2cm]{figures/topdown_seg.png}};
        \node (waypoints) [emb, right of=gru-decoder, minimum height=0.75cm, minimum width=1.5cm] {Waypoints};
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%% arrows %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        \draw [arrow] (front.east) -- (front.east-|resnet34.west);
        \draw [arrow] (lidar1.east|-resnet18.west) -- (resnet18.west);
        \draw [arrow] (lidar1.east|-resnet18.west) -- (resnet18.west);
        \draw [arrow] (resnet34.east) -- (resnet34.east -| rgb-emb.west);
        \draw [arrow] (resnet18.east) -- (resnet18.east -| lidar-emb.west);
        \draw [arrow] (rgb-emb.east) -- +(+0.625, 0) |- (mlp1.west);
        \draw [arrow] (rgb-emb.east) -- +(+0.625, 0) |- (mlp2.west);
        \draw [arrow] (lidar-emb.east) -- +(+0.625, 0) |- (mlp3.west);
        \draw [arrow] (lidar-emb.east) -- +(+0.625, 0) |- (mlp4.west);
        \draw [arrow] (mlp1.east) -- (mlp1.east-|rgb-emb-u.west);
        \draw [arrow] (mlp2.east) -- (mlp2.east-|rgb-emb-s.west);
        \draw [arrow] (mlp3.east) -- (mlp3.east-|lidar-emb-s.west);
        \draw [arrow] (mlp4.east) -- (mlp4.east-|lidar-emb-u.west);
        \draw [arrow] (rgb-emb-u.east) -- (rgb-emb-u.east-|decoder1.west);
        \draw [arrow] (rgb-emb-s.east) -- +(+0.25, 0) -- ($ (decoder3.west)+(-0.25, 0) $) -- (decoder3.west);
        \draw [arrow] (lidar-emb-s.east) -- +(+0.25, 0) -- ($ (decoder2.west)+(-0.25, 0) $) -- (decoder2.west);
        \draw [arrow, dashed, draw=emb-c!60] (dash-box1.east |- mlp5.west) -- (mlp5.west);
        \draw [arrow] (mlp5.east) -- (emb-c.west);
        \draw [arrow] (emb-c.east) -- (gru-decoder.west);
        \draw [arrow] (gru-decoder.east) -- (waypoints.west);
        \draw [arrow] (goal-location.north) -- (gru-decoder.south);
        \draw [arrow] (decoder1.east) -- (dash-box2.west);
        \draw [arrow] (decoder2.east) -- (front-seg.west);
        \draw [arrow] (decoder3.east) -- (topdown-seg.west);

        \draw [arrow] (rgb-emb-s.south) |- (align-loss.east);
        \draw [arrow] (lidar-emb-s.north) |- (align-loss.east);
    \end{tikzpicture}
    \end{adjustbox}
    \caption{\textbf{Architecture.} The top-down LiDAR pseudo image and front camera image go through two residual networks to extract 512 dimension feature vectors. We use four different MLPs to extract the shared features and the unique features. The unique features of RGB input are used to generate stop signs and traffic light indicators. The shared features of LiDAR are used to reconstruct the segmentation of RGB input while the shared features of RGB are used to reconstruct the segmentation of top-down LiDAR input. An alignment loss is used to align the shared features from LiDAR and camera inputs into the same space. These shared features and unique features are concatenated along with the measurements (velocity, throttle, steer, brake from the last frame) and then go through one MLP to reduce the size. Finally, they will be fed into one GRU decoder to predict short-term waypoints.}
    \label{fig:Architecture}
\end{figure*}