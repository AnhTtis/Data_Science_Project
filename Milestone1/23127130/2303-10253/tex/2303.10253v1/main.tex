\documentclass[letterpaper, 10 pt, conference]{ieeeconf} 
\IEEEoverridecommandlockouts                   
\overrideIEEEmargins
% See the \addtolength command later in the file to balance the column lengths
% on the last page of the document

% The following packages can be found on http:\\www.ctan.org
\usepackage{graphics} % for pdf, bitmapped graphics files
%\usepackage{epsfig} % for postscript graphics files
%\usepackage{mathptmx} % assumes new font selection scheme installed
\usepackage{times} % assumes new font selection scheme installed
\let\proof\relax \let\endproof\relax\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{mathtools}
\usepackage{lipsum}
\usepackage{booktabs}

\usepackage{tikz}
\usetikzlibrary{quotes}
\usetikzlibrary{bayesnet}
\usetikzlibrary{shapes,arrows}
\definecolor{mcomment}{RGB}{0,153,76}
\newcommand{\mcomment}[1]{{\color{mcomment}[Mark comment: #1]}}

\title{\LARGE \bf
Pricing for Multi-modal Pickup and Delivery Problems with Heterogeneous Users}


\author{Mark Beliaev, Negar Mehr, Ramtin Pedarsani
	\thanks{M. Beliaev is with Graduate School of Electrical \& Computer Engineering, University of California Santa Barbara, Santa Barbara, CA, USA.}
	\thanks{N. Z. Mehr is with the Faculty of Aerospace Engineering, University of Illinois at Urbana-Champaign, Champaign, IL, USA.}
    \thanks{R. Pedarsani is with the Faculty of Electrical \& Computer Engineering, University of California Santa Barbara, Santa Barbara, CA, USA.}}

\input{macros.tex}
\begin{document}
\maketitle
\thispagestyle{empty}
\pagestyle{empty}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract}
In this paper we study the pickup and delivery problem with multiple transportation modalities, and address the challenge of efficiently allocating transportation resources while price matching users with their desired delivery modes. Precisely, we consider that orders are demanded by a heterogeneous population of users with varying trade-offs between price and latency. To capture how prices affect the behavior of heterogeneous selfish users choosing between multiple delivery modes, we construct a congestion game taking place over a star network with independent sub-networks composed of parallel links connecting users with their preferred delivery method. Using the unique geometry of this network we prove that one can define prices explicitly to induce any desired network flow, i.e, given a desired allocation strategy we have a closed-form solution for the delivery prices. In connection with prior works that consider non-atomic congestion games, our result shows that one can simplify the Linear Program formulations used to solve for edge prices by first finding the path prices combinatorially. We conclude by performing a case study on a meal delivery problem with multiple courier modalities using data from real world instances.     
\end{abstract}
 
\section{Introduction}\label{sec: Introduction}

    As the world continues to integrate with digital technology, we become more reliant on e-commerce services such as food delivery and ride-hailing. The global food delivery market has seen exponential growth, with the most mature markets becoming four to seven times larger from 2018 to 2021~\cite{ahuja2021ordering}. In 2022, Uber reported a $19\%$ year-over-year increase in online bookings, marking a daily average of $23$ million trips on their platform~\cite{business_wire_2023}. Despite this growth, many pickup and delivery services operate under low profit margins due to high driver wages~\cite{CDC_pravin}. To fulfill market demands and mitigate these costs, recent efforts have been made to introduce autonomous transportation methods for food delivery and ride hailing, such as drones or air taxis~\cite{MOSHREFJAVADI2021114854} and robot couriers~\cite{robot_starship} or taxis~\cite{robotaxi}. In light of these developments, we address the challenge of efficiently allocating transportation resources between customers while price matching them with their desired delivery modes.\par

    This paper examines the pickup and delivery problem with multiple transportation modalities, and demonstrates how one can achieve a desired allocation strategy for a set of orders by appropriately setting prices for each modality. Specifically, we consider orders demanded by a heterogeneous population of users with varying trade-offs between price and latency. This problem is analogous to a congestion game taking place over a star network, as depicted in Figure~\ref{fig:fron_fig}, where the source--sink pairs represent independent sub-networks composed of parallel links connecting users with their preferred delivery method. This unique network structure enables us to show that we can explicitly define prices to induce any desired network flow, i.e, given a desired allocation strategy we have a closed-form solution for the delivery prices.\par
    
    \begin{figure}[!t]
        \centering
        \includegraphics[width=3.3in]{figures/temp_front.png}
        \caption{We represent the pickup and delivery problem as a congestion game played over a star network. Each sub-network is an independent source--sink pair denoted by $\order\in\Orders$, which can be viewed as a population of users at some location demanding a particular order at a certain rate. Each source--sink pair is connected by a set of parallel edges $\mode\in\Modes$, which can be viewed as the set of delivery modes the users choose from. Note that we are not concerned with how the couriers are routed to the pickup or delivery location, and instead focus on how we allocate the different delivery modes for each order. Specifically, our goal is to induce an optimal allocation of transportation modalities by appropriately setting prices for each order-modality pair.}
        \label{fig:fron_fig}
    \end{figure}
    
    The main contributions of this work are:
    \begin{itemize}
    \item We construct a congestion game that captures how prices affect the behaviour of heterogeneous selfish users choosing between multiple delivery modes.
    \item Building on results from prior works, we prove that in this setting the set of prices can be explicitly defined for a desired network flow.
    \item We demonstrate our model with a case study on a meal delivery problem with multiple courier modalities, using real world instances provided by Grubhub~\cite{reyes2018meal}.  
    \end{itemize}

    \noindent \textbf{Related Work.} 
    The application of emerging transportation modalities such as unmanned aerial vehicles or drones has drawn a lot of attention. Many works looks at how drones can be utilized in logistic operations such as delivery systems~\cite{beliaev2022}, urban air taxi~\cite{airtaxi}, on-demand meal delivery~\cite{LIU20191}, as well as many other applications~\cite{MOSHREFJAVADI2021114854}. Other works look at safety verification for dynamical systems utilizing drones to account for factors such as collision avoidance~\cite{coogan_2022} and schedule feasibility~\cite{coogan_2021}. The pickup and delivery vehicle routing problem with drones has also been considered by some, where mixed integer linear programming models are used to find routing solutions for optimizing various objectives~\cite{pdp_routing_1,pdp_routing_2}. Unlike these works, our research lies in the broader field of congestion games, specifically building on previous works that consider pricing in non-atomic congestion games.\par 
    
    Congestion games aim to allocate traffic over transportation networks represented by graphs, where each road corresponds to an edge with a latency function representing the travel time experienced by users on that edge~\cite{dafermos1969traffic}. In these settings, one aims to find the optimal network flow that minimizes a social cost, such as the aggregate latency experienced by all users. However, if we assume that users are self--interested and choose their routes selfishly by minimizing their individual latency, the resulting flow follows a network equilibrium~\cite{wardrop1952, sheffi1984}. One area of research is focused on categorizing the trade-off in social cost between the optimal network flow and the equilibrium network flow~\cite{roughgarden2005, lazar_tac, Lazar_Coogan}. Many works specifically look at how tolling can be used to price network edges such that the equilibrium network flow corresponds to the desired optimal flow~\cite{dafermos1973, roughgarden2003b, marden2017}. In our work, we make the distinction that users are heterogeneous in their trade-off between price and time.\par
    
    While in the homogeneous case it has been long known that marginal cost pricing can guarantee that the equilibrium flow equals the optimal flow~\cite{beckmann1956studies}, this strategy does not hold for heterogeneous populations. More recent research has demonstrated that for directed graphs with one source--sink pair, optimal tolls exist and can be found by solving a polynomial size set of linear inequalities, given that the number of users in the heterogeneous population is finite~\cite{roughgarden2003a}. In this seminal paper, it was assumed that the model was nonatomic, meaning that each user corresponded to an infinitesimal unit of flow, and inelastic, meaning that the demand could not change as a function of the road parameters. Following this work, others have improved the result by considering multicommodity networks~\cite{Karakostas2004EdgePO,Fleischer2004}, allowing user demand to be elastic~\cite{Karakostas2006EdgePO}, and addressing the atomic setting~\cite{Fotakis2010OnTE}. In this paper, we keep the assumption of a nonatomic model with inelastic demands, but consider a graph structure which is unique to the pickup and delivery problem considered. By exploiting this graph structure, we can define prices explicitly to induce any desired network flow without limiting it to an optimal flow. Whereas prior works directly use Linear Program (LP) formulations to find edge prices in general directed graphs, our main result implies that one can first find path prices combinatorially to simplify the LP formulation.\par 
     
    The rest of the paper is organized as follows. In the subsequent Section~\ref{sec: Problem Setup}, we formally introduce the problem setting and show how it is analogous to a congestion game. Following this, in Section~\ref{sec: Theoretical Framework} we describe our main theoretical result in the general framework of the aforementioned congestion game. We go on to apply these results in Section~\ref{sec: Case Study}, modeling the meal delivery problem with multiple courier modalities by using the public Grubhub dataset~\cite{reyes2018meal}. Lastly, we conclude our work in Section~\ref{sec: Conclusion}, listing potential avenues for improvement and further research.\par

   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %     In this section, within the setup of Section~\ref{sec: Problem Setup}, we consider a congestion game representing the pick up and delivery problem and show that we can explicitly define prices to induce any desired network flow, i.e, given a desired allocation strategy we have a closed form solution for the delivery prices. We do this by first establishing the necessary theoretical framework, after which we state our main result.\par

     %However, we know in hindsight that these latency functions may be used to find an allocation strategy that minimizes a desired objective, such as the total network latency $\sum_{\order\in\Orders}\sum_{\mode\in\Modes}\lij(x)\xij$. In these settings, other restrictions to latency may be required if one wants to find the optimal network flow $x$ efficiently, but for our theoretical results, we make no assumptions on the desired network flow $x$, and hence do not need these restrictions.
     
    % Note that while we allow $\lij$ to depend on the entire network flow $x$, we may still desire it to be nondecreasing with respect to its particular edge flow $\xij$. This restriction is weaker than the typical formulation used for networks with a single source--sink pair, where latency $\lij$ is assumed to be a nondrecreasing function depending only on flow $\xij$. 
    
    % We will explain why we can make this simplification in the subsequent section, where we formally define network equilibrium. For now, we note that this relaxation is particularly useful in the setting of pickup and delivery. For example, one may want to define the delivery time required by modality $\mode$ to complete a particular order $\order$ as a function of the total load $\sum_{\order\in\Orders}\xij$ on modality $\mode$ across all orders. We provide such an example in our case study described in , modeling the latency using concepts from queuing theory.      
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Problem Formulation}\label{sec: Problem Setup}
    We model our pickup and delivery problem using a static system, where during a given time interval\footnote{Without loss of generality, we can define the time interval during which the orders $\Orders$ are demanded as one hour, using the same unit of time for all variables and constants throughout our formulation.}, there is a set of orders $\Orders$ demanded by a population of users. We consider that each order originates from a unique neighborhood composed of a heterogeneous population represented by the interval $[0,1]$, where each point $\user\in[0,1]$ is a non-cooperative and infinitesimal unit referred to as a user. We sort these users by money sensitivity, viewing $\pop_\order:[0,1]\rightarrow(0,\infty)$ as an unbounded, non-decreasing function representing the trade-off between price and time for users in the population corresponding to order $\order$. Thus, when placing an order $\order\in\Orders$, each user chooses one of the $\numModes$ delivery modes $\mode\in\Modes:\{1,\ldots,\numModes\}$ based on delivery time $\lij$, dollar price $\tij$, and their money/time valuation $\pop_\order(\user)$. Finally, we assume users placing order $\order\in\Orders$ have inelastic demands, i.e., they will not switch their demand to a different order and will always choose one of the $\numModes$ delivery modes. Our goal is then to find the set of delivery prices which would induce some desired allocation of users between the delivery modes $\mode\in\Modes$ for each order $\order\in\Orders$.\par
    %\textcolor{red}{unit rate of flow -- [Why unit rate of flow without loss of generality? I am a bit confused about this sentence.]}
    This problem is analogous to a congestion game played over a star network as portrayed in Figure~\ref{fig:fron_fig}, where each order $\order\in\Orders$ corresponds to a source--sink pair connected by a set of parallel edges $\Modes$ representing the different delivery options. Each source--sink pair $\order\in\Orders$ has an associated demand of traffic flow at the sink which represents the population of users $\user\in[0,1]$ requesting deliveries. Although we model this flow demand with the unit interval to simplify notation, we can allow for an arbitrary demand $r_\order$ at each source--sink pair $\order$. The edge corresponding to modality $\mode\in\Modes$ for source--sink pair $\order\in\Orders$ has a congestion dependent latency $\lij$, which represents the time needed to complete the order, and a price issued to control congestion $\tij$, which represents the dollar price payed by the user. Note that when we drop index $\mode$ from the notation of terms like $\lij$ by writing $\lat_\order$, we refer to the set of latencies $\setlat$ over all the edges $\Modes$ for a given source--sink pair $\order$.\par 
    
    With this approach, we can view network flow as an allocation of users over the delivery modes. To represent such allocation strategies, we define $0\leq \xij\leq1$ as the flow of users on edge $\mode\in\Modes$ corresponding to source--sink pair $\order\in\Orders$, where $\sum_{\mode\in\Modes}\xij=1$ must be satisfied. More precisely, for each source--sink pair $\order$ we view this flow as a Lebesgue-measurable function $\flow:[0,1]\rightarrow\Modes$ which corresponds to a flow over the edges $\setflow$. We use notations $x=\{\xij\}_{\order\in\Orders,\mode\in\Modes}$ and $\tax=\{\tij\}_{\order\in\Orders,\mode\in\Modes}$ to denote the entire set of edge flows and edge prices respectively. As we will later show in Section~\ref{sec: Case Study} when performing our case study, we can use $x$ as a decision variable to find an optimal allocation strategy for a given objective, and explicitly define prices $\tax$ that induce this desired strategy. For now, we continue to detail how latency and user equilibrium are considered in our framework.\par

    \noindent\textbf{Congestion.}
    We first describe the congestion element of our framework, namely the latency function defined for each edge. Specifically, we assume that each edge $\mode\in\Modes$ corresponding to source--sink pair $\order\in\Orders$ has a nonnegative and continuous latency $\lij$ as a function of the entire network flow $x$. Each latency function $\lij$ describes the time it takes for an order $\order$ delivered by modality $\mode$ to arrive at the customer's location from the moment it was placed. We note that in order to claim our main theoretical result, we do not need any further restrictions on the latency functions $\lij$. We leave further discussion regarding latency to Section~\ref{sec: Case Study}, where we provide a case study for the meal delivery problem and model latency using concepts from queuing theory. Until then, we stick with the aforementioned assumptions and simply use notation $\lij(x)$ when defining edge latency.\par

    % We are now ready to discuss how users choose between the different delivery modes. For a given order $\order\in\Orders$, we assume user $\user\in[0,1]$ has a certain money/time valuation ratio $\pop_\order(\user)$. Thus, when confronted with a set of prices $\tax_\order$ and latencies $\lat_\order$ for the varying edge options $\mode\in\Modes$, user $\user$ will choose the shortest edge relative to lengths $\lij(x)+\pop_\order(a)\tij$. Recall that the users are sorted in order of price sensitivity, making $\pop_\order:[0,1]\rightarrow(0,\infty)$ an unbounded, non-decreasing function.\par 
    
    %In practice, we do not need to know which user is placing a given order as we will use the distribution function $\pop_\order$ to determine how the entire population that places order $\order$ reacts in expectation.\par 

    %, assuming the strategies of users in other source--sink pairs have been fixed\footnote{This assumption is only made so that we can define individual equilibria for each source--sink pair, and is removed when we define the equilibrium for the entire network flow}. \mcomment{Actually not sure if I need to state this assumption as it is in the definition of Nash flows, but it may be needed for clarity. It does not diminish our result.}
    \noindent\textbf{User Equilibrium.}
    We are now ready to discuss how users choose between the different delivery modes. When confronted with a set of prices $\tax_\order$ and latencies $\lat_\order$ for the varying edge options $\mode\in\Modes$, user $\user\in[0,1]$ will choose the shortest edge relative to lengths $\lij(x)+\pop_\order(a)\tij$. Essentially, every source--sink pair $\order\in\Orders$ corresponds to its own nonatomic game in which users $\user\in[0,1]$ choose between the $\mode\in\Modes$ pure strategies available. The noncooperative behaviour of users results in a Nash equilibrium, which is a stable point where no user has an incentive to unilaterally alter their chosen strategy. Specifically, we let $\cija(x,\tax_\order)=\lij(x)+\pop_\order(\user)\tij$ represent the evaluation user $\user\in[0,1]$ assigns to edge $\mode$ for source--sink pair $\order$.
    \begin{definition}
        For a given source--sink pair $\order\in\Orders$, we call the flow $\flow:[0,1]\rightarrow\Modes$ an equilibrium or Nash flow for instance $(\pop_\order,\lat_\order,\tax_\order)$ if for any user $\user\in[0,1]$ and edge $\mode\in\Modes$:
        \begin{equation}\label{eq:Nash_condition}
            \cixa(x,\tax_\order)\leq \cija(x,\tax_\order).
        \end{equation}
    \end{definition}
    The existence of such Nash flows is a well known and a general result~\cite{schmeidler_equilibrium}. 
    \begin{prop}\label{prop: ex_nash}
    For a given source--sink pair $\order\in\Orders$, any instance $(\pop_\order,\lat_\order,\tax_\order)$ admits a Nash flow $\flow:[0,1]\rightarrow\Modes$ satisfying Eq.~\eqref{eq:Nash_condition}. 
    \end{prop}
    \par
    Note that the above results not make any claims about the existence of a network flow $x$ for which all source sink pairs exhibit Nash equilibria. We use the term \textit{stable allocation strategy} to encompass this notion, formally defining it below. 
    \begin{definition}
        For a given star network defined by the source--sink pairs $\order\in\Orders$ and edges $\mode\in\Modes$, we call the network flow $x:\{\flow\}_{\order\in\Orders}$ a stable allocation strategy for instance $(\pop,\lat,\tax)$ if for all source--sink pairs $\order\in\Orders$, the corresponding flow $\flow:[0,1]\rightarrow\Modes$ is an equilibrium flow satisfying Eq.~\eqref{eq:Nash_condition}.  
    \end{definition}
    As we show in the subsequent section, any network flow $x$ is a stable allocation strategy for some set of prices $\tax$.\par
 
    
\section{Main Results}\label{sec: Theoretical Framework}
    Before stating our main result, we need to elaborate on one more property of equilibrium flows that applies to individual source--sink pairs. Intuitively, we expect Nash flows to exhibit a structure where users $\user\in[0,1]$ close to $0$, who value time more than money, will choose an option with small latency but large price. Similarly, users further away from $0$ will choose an option with a relatively larger latency but a smaller price. Finally, users close to $1$ will choose an option with very large latency in order to pay a very small price. We encapsulate this notion below. 
    \begin{definition}
        For a given source--sink pair $\order\in\Orders$, a flow $\flow$ at Nash equilibrium is \textit{canonical} if:
        \begin{itemize}
            \item For any edge $\mode\in\Modes$, the users assigned to $\mode$ form a possibly empty or degenerate subinterval of $[0,1]$.
            \item If $\user_1<\user_2$, then $\lat_{\order,\flow(\user_1)}(x)\leq\lat_{\order,\flow(\user_2)}(x)$.
            \item If $\user_1<\user_2$, then $\tax_{\order,\flow(\user_1)}\geq\tax_{\order,\flow(\user_2)}$.
        \end{itemize}
    \end{definition}
    In other words, a canonical Nash flow $\flow$ splits $[0,1]$ into at most $\numModes$ potentially degenerate sub intervals, inducing an ordering over the edges to which $\flow$ assigns users that is nondecreasing in latency and nonincreasing in prices. Using results from prior work which proposed this definition~\cite{roughgarden2003a}, we can state the following existence property.
    \begin{prop}\label{prop: ex_canon}
    For a given source--sink pair $\order\in\Orders$, every instance $(\pop_\order,\lat_\order,\tax_\order)$ admits a canonical Nash flow. 
    \end{prop}

    With these properties, we can say that for a given source--sink pair $\order\in\Orders$ and instance $(\pop_\order,\lat_\order,\tax_\order)$, there exists a canonical Nash flow $\nashflow:[0,1]\rightarrow\Modes$. This canonical  Nash flow represents the flow $\setnflow$, where users in interval $[\user_{\mode-1},\user_\mode]\in[0,1]$ are routed on edge $\mode$ for some corresponding set $\user_0\leq\user_1\leq\ldots\leq\user_{\numModes}$, with $\user_0=0$ and $\user_{\numModes}=1$. In the pickup and delivery setting, we can assume that the delivery provider already has a set of flows $\setflow$ representing the desired allocation strategy for order $\order$, and wants to find a corresponding set of prices $\settax$ such that the induced equilibrium flow $\setnflow$ is equal to the desired flow. Building on top of the aforementioned results, we find a closed-form solution to this problem.
     \begin{thm}
		\label{thm:pricing condition}
        For a given source--sink pair $\order\in\Orders$, any desired flow $\setflow$ is an equilibrium flow for instance $(\pop_\order,\lat_\order,\tax_\order)$, where the set $\Modes:\setmodes$ orders the edges by non-decreasing latency, $\pop_\order:[0,1]\rightarrow(0,\infty)$ is a non-decreasing distribution function, $\lat_\order$ is the set of corresponding edge latencies, and $\tax_\order$ is the set of prices defined by:
        \begin{equation}\label{eq:main_result}
            \tij=\tax_{\order,\numModes}+\sum_{k=\mode}^{\numModes-1}\frac{\lat_{\order,k+1}-\lat_{\order,k}}{\pop_\order(\user_{k})},
        \end{equation}
        for all $\mode\in\Modes$, where $\tax_{\order,\numModes}$ is any predefined price for the cheapest option. 
	\end{thm}
    \begin{proof}
    The proof strategy is as follows: using a subset of the inequalities defined for Nash equilibrium in Eq.~\eqref{eq:Nash_condition}, we first show that for some desired Nash flow $\setflow$ there is only one set of valid prices $\tax_\order$ that satisfies this subset of inequalities. We complete the proof by showing that the corresponding set of prices $\tax_\order$ does indeed satisfy all of the inequalities defined in Eq.~\eqref{eq:Nash_condition}. We provide a full proof of this result in Appendix~\ref{sec: app_proof}.
    \end{proof}
    It follows directly that given any network flow $x:\{\flow\}_{\order\in\Orders}$ representing a desired allocation strategy over all orders, one can independently set prices $\tax:\{\tax_\order\}_{\order\in\Orders}$ for each source--sink pair to make $x$ a stable allocation strategy.
    \begin{cor}\label{corr: ex_network_flow}
    For a given star network defined by source--sink pairs $\order\in\Orders$ and edges $\mode\in\Modes$, any network flow $x:\{\flow\}_{\order\in\Orders}$ is a stable allocation strategy for instance $(\pop,\lat,\tax)$ when the set of prices $\tax$ is defined according to Eq.~\eqref{eq:main_result}.
    \end{cor}
    We highlight an interesting point about our main result.
    \begin{remark}
    Although Equation~\ref{eq:main_result} defines prices for parallel edges, this is equivalent to finding prices for paths in more general graphs composed of one source--sink pair. While prior works derive Linear Program (LP) formulations to directly find edge prices which induce the equilibrium flow, Theorem~\ref{thm:pricing condition} implies that one can first find path prices combinatorially to simplify the LP formulation. Since users choosing between delivery modes can be represented by parallel edges, we forego defining paths in our formulation to be concise. 
    \end{remark}

\section{Case Study: Meal Delivery Problem}\label{sec: Case Study}
    To show the usability of our model, we apply our theoretical framework to the meal delivery problem with multiple courier types. Our goal is to find the optimal allocation strategy with respect to some objective, where we will use Theorem~\ref{thm:pricing condition} to set the prices which induce this desired strategy. Our objective will be to find the optimal values of $x$ which minimize the expected latency over all orders:
    \begin{equation}\label{eq: expected ctd}
        \tlat(x)=\frac{1}{|\Orders|}\sum_{\order\in\Orders}\sum_{\mode\in\Modes}\lij(x)\xij.
    \end{equation}
    Before we set up and solve this optimization problem, we first specify how delivery time is measured, and how cost is accounted for.\par

    \subsection{Formulation}
    \noindent\textbf{Latency Model.}
    We begin by characterizing each order $\order\in\Orders$ by a $2$--tuple $\langle\rest_\order,\loc_\order\rangle$, consisting of a pick-up and drop-off location respectively. We would like our system to model the time it takes for an order to arrive at the customer's location from the moment it was placed. We refer to this as the delivery time $\lij$ for order $\order\in\Orders$ and modality $\mode\in\Modes$, computing it as:
    \begin{equation}\label{eq:click-to-door}
    \lij(x)=\slij+\tlij+\plij(x).
    \end{equation}
    Essentially, the above Eq.~\eqref{eq:click-to-door} splits the delivery time $\lij$ into three components: service time $\slij$, travel time $\tlij$, and pickup time $\plij$ for modality $\mode$ of order $\order$.\par 
    
    We view the service time $\slij$ as a constant representing the time spent at the pickup and drop-off locations when completing order $\order$ using delivery mode $\mode$. Some examples of this include parking for vehicle couriers, landing for aerial couriers, loading, and unloading. Similarly, we define the travel time $\tlij$ as the time it takes to physically travel between pickup $\rest_\order$ and drop-off $\loc_\order$ locations using delivery mode $\mode$. The travel time $\tlij$ between locations can be pre-computed separately for each modality $\mode$ and order $\order$ using some known functions. Lastly, we view the pick-up time $\plij$ as the time it takes for a courier of delivery mode $\mode$ to arrive at pick-up location $\rest_\order$. Unlike the other two components, the time required for pickup $\plij$ should depend on our decision variable $x$ by varying based on the availability, as well as the expected travel time between the pickup location and nearest available courier.\par 

    To account for the availability of couriers, we use the concept of server utilization from queuing theory. Specifically, we use the $M/M/c$ queue as an approximate model for the availability of couriers since we can obtain closed form formulas for the average order arrival and order completion rates. For a given modality $\mode$, we set $c$ to the total number of couriers $\couriercap_\mode$, approximate the rate at which users are placing orders as $\sum_{\order\in\Orders}\xij$, and define the rate at which an order is completed by these types of couriers as $\drate_\mode$. Note that we can define the order completion rate $\drate_\mode$ as a constant provided by historical data, or estimate it using the parameters of our problem instance as we will later show. Drawing these analogies allows us to define the utilization $\rho_\mode$ of our queuing system for couriers of modality $\mode$ as:
    \begin{equation}\label{eq:system utilization}
        \rho_\mode = \frac{\sum_{\order\in\Orders}\xij}{\couriercap_\mode\drate_\mode}.
    \end{equation}
    \par
    In our regime of interest, the rate of order arrivals is magnitudes larger than the rate of order completions, and hence the number of available couriers $c$ needs to be large. Using the $M/M/c$ latency function, one can easily show that in this regime of interest the time spent waiting for an available server is negligible unless we are close to the capacity limit~\cite{queueing_theory}. For example, given a system with $c=50$ servers and a demand of $100$ requests per hour, when the server utilization is high at $\rho=0.99$, the average time spent in the system is $84$ minutes, with $55$ minutes in the queue. Once we lower the utilization to $\rho=0.9$, the average time spent in the system is $29$ minutes, with only $2$ minutes spent in the queue. This means that the expected waiting time for a courier to be available is relatively small compared to the delivery time, given that the utilization parameter $\rho_\mode$ is below a reasonable threshold. Thus to make sure that customers are not experiencing long wait times for couriers to respond, we can upper-bound the utilization parameter $\rho_\mode$ for all courier types, and ignore the affect of availability.\par
    
    To model the time a courier must spend traveling to the pick-up location $\rest_\order$, we take a probabilistic approach by calculating the expected travel time of the nearest available courier. Specifically, we assume that for modality $\mode$, some portion $\bij\in(0,1]$ of available couriers are distributed around the pick-up location $\rest_\order$ such that their travel times are uniform in $[0,\minutes_\mode]$. Note that we can choose $\minutes_\mode$ as some constant unit of time from which $\bij$ is estimated based on the pick-up location and delivery mode. Since we know that the expected number of available couriers will be $(1-\rho_\mode)\couriercap_\mode$, we can define the pick-up time as the expected travel time of the nearest courier:
    \begin{equation}\label{eq:pick-up time}
        \plij(x)=\frac{\minutes_\mode}{1+\bij\couriercap_\mode(1-\rho_\mode)},
    \end{equation}
    where we used the fact that the expected minimum value of $n$ independent uniform random variables in $[0,1]$ is $\frac{1}{n+1}$.\par 

    \noindent\textbf{Cost Model.}
    Before setting up our optimization problem, we need to model the cost of operating this delivery system. We define the dollar cost of completing order $\order\in\Orders$ by a courier of modality $\mode$ as the delivery cost $\opcij$. This way, we can define the total cost of running our delivery system given the allocation strategy $x$:
    \begin{equation}\label{eq:total cost}
        \bopcost(x) = \sum_{\order\in\Orders}\sum_{\mode=1}^{\numModes}\opcij\xij,
    \end{equation}
    where $\bopcost(x)$ is units of dollars per hour because $\xij$ is a rate of orders per hour. Since we expect the delivery cost $\opcij$ to depend on the distance traveled by courier $\mode$ to complete order $\order$, modeling $\opcij$ as a constant is a practical choice. Alternatively, one can define a cost model using wages for different courier types, making $\opcij$ dependent on the delivery time and hence a function of the allocation strategy. We leave this extension for future work, as the defined model is still useful for many applications.\par
    
    \noindent\textbf{Optimization Problem.}
    %\stepcounter{equation}\tag{\theequation}\label{eq:final_optimization}\\
    %            \textrm{or }&\qquad \sum_{\order\in\Orders}\sum_{\mode=1}^{\numModes}\tij\xij\geq\bopcost(x) + \Bar{\bopcost},\\
    We are now ready to set up the overall optimization problem. 
      \begin{align}		
			\min_{x}&\qquad \tlat(x)=\frac{1}{|\Orders|}\sum_{\order\in\Orders}\sum_{\mode\in\Modes}\lij(x)\xij\label{eq:final_optimization}\\
			\textrm{subject to }&\qquad \bopcost(x) = \sum_{\order\in\Orders}\sum_{\mode\in\Modes}\tij\xij,\label{eq:con_cost}\\
            &\qquad  \rho_\mode(x)\leq\Bar{\rho} \qquad \forall \mode\in\Modes,\label{eq:con_server}\\
            &\qquad \sum_{\mode\in\Modes}\xij=1,\qquad \forall\order\in\Orders,\label{eq:con_flow}\\
			\textrm{and }&\qquad 0\leq\xij\leq1,\qquad \forall\order\in\Orders,\mode\in\Modes\label{eq:con_bounds}.
		\end{align}
    For this case study, we want to find the allocation strategy $x$ which minimizes expected delivery time $\tlat$, as shown in Eq.~\eqref{eq:final_optimization}. To make this problem more practically-interesting, we constrain the operational cost in Eq.~\eqref{eq:con_cost} to equal the total compensation received from all deliveries. Note that because Theorem~\eqref{thm:pricing condition} allows us to arbitrarily set price for the cheapest delivery option, this is equivalent to finding the minimum price $\Bar{\tax}$ that satisfies the constraint. We also constrain courier utilization in Eq.~\eqref{eq:con_server} by choosing an appropriate upper bound $\Bar{\rho}$ for all delivery modes $\mode\in\Modes$. We use the constraint in Eq.~\eqref{eq:con_flow} to satisfy demands for each order $\order\in\Orders$. Finally, we bound our decision variable between the domain of $[0,1]$ in Eq.~\eqref{eq:con_bounds} so that there are no negative values in the solution.\par

        %To make the problem interesting, we set out to find the minimum delivery prices $\tij$ required such that the total compensation $\sum_{\order\in\Orders}\sum_{\mode=1}^{\numModes}\tij\xij$ was greater than the operational cost $\bopcost(x)$ corresponding to the optimal allocation strategy of $x$. Note that because prices $\tij$ can be computed after the optimization, this is equivalent to setting the minimum price $\Bar{\tax}$ listed in the constraint defined by Eq.~\eqref{eq:con_tax}. We set the cost per order $\opcij$ to $\$10$ for car deliviers, and $\$5$ for drone and robot deliveries.    
        

    The optimization problem defined above is non-linear and non-convex, and we use a public implementation of the interior-point filter line-search algorithm~\cite{wachter2006implementation} to solve it. As aforementioned, many choices can be made for the formulation of the latency functions $\lij$, cost constraint $\bopcost$, and the optimization objective $\tlat$. To efficiently use the interior point method, it is desired for the objective function and constraints to be twice differentiable so that the Hessian can be defined. We note that apart from this consideration, we also kept the prices $\tax$ independent of the objective function because of the permutations required to compute them. Though neither of these restrictions are necessary, they allow us to efficiently implement the optimization problem and demonstrate our main result.\par 

    We can now discuss how we setup our case study, in which we model a meal delivery problem with three transportation modalities: cars, drones, and robots. To define the problem parameters for our optimization formulation, we used real world instances from Grubhub~\cite{reyes2018meal}, which list information about the orders placed and car couriers available throughout a given time interval. Although there is no consideration of other modalities, we use the provided information as a basis and define our remaining parameters to be consistent. We list how these parameters are defined below, and provide our full implementation in our code available online~\cite{my_implementation}.\par
    
    For service time $\slij$, we directly used the given pickup and dropoff times for car couriers, and scaled them  by $0.2$ for drones and robots. Similarly for travel time $\tlij$, we used the real distances between restaurants and order locations, converting them to time by using constant speeds for all modalities. For cars we set the speed to $19.2$ km/h according to the dataset, and scaled the speed of drones and robots to be $38.4$ km/h and $5.76$ km/h respectively. For pickup time $\plij$, we computed all the parameters required in Eq.~\eqref{eq:pick-up time}. The number of couriers $\couriercap$ was directly chosen for each instance so that the problem was feasible under the utilization capacity of $\Bar{\rho}=0.9$. We then generated the locations of all three courier modalities, and computed the portion of available couriers $\bij$ that were at most $\minutes=10$ minutes away from the restaurant corresponding to order $\order$. For car couriers, we directly sampled from the provided locations, while for drone couriers, we sampled uniformly from a grid spanning the restaurant locations. To capture robot couriers delivering from restaurants closer to downtown, we sampled their locations uniformly from a grid centered in the middle of the restaurant locations, with length and width equal to their coordinate's respective standard deviations. Using these parameters, we estimated the mean rate $\drate_\mode$ of order completions as the inverse of expected delivery time $\mathbb{E}_{i}[\lij]^{-1}$ for each modality $\mode$, assuming load was equally distributed across the orders. We use the same cost per order $\opcij$ of $\$10$ for car deliveries, and set it to $\$5$ for drone and robot deliveries. For user trade-off between price and time $\pop(a)$, we use a linear function with the lowest evaluation $\pop(1)$ set to $10$ dollars per hour, and the highest $\pop(0)$ set to $100$ dollars per hour. We go on to discuss the results of our case study for an instance with $505$ unique orders, each demanded with a rate of $0.42$ deliveries per hour.\par

    \subsection{Results}
    We first consider the case when there are only $100$ car couriers available, with no other transportation modality. We show the result in Table~\ref{tab:result_1}, listing the portion of orders delivered as a percentage, the the operational cost in dollars per hour, the latency or delivery time $\lat_j$ in minutes, the delivery price in dollars, and the distance between customer and restaurant in kilometers. We note that the statistics corresponding to drones and robots are set to $0$ as they are not applicable in this case. Since car couriers have an operational cost of $\$10$ per order, we need an average delivery price of $\$10$ to satisfy it. Note that although in this setting the minimum delivery price can be set arbitrarily for all orders since users have no choice to make, when we introduce other delivery modalities this is no longer the case as the prices must follow Eq.~\eqref{eq:main_result} to satisfy Nash conditions.\par 

    \begin{table}[!t]
        \centering
        \begin{tabular}{lcccc}
            \toprule
            & Cars & Drones & Robots & Total\\
            \cmidrule(r){1-1}\cmidrule(r){2-4}\cmidrule(r){5-5}
            %Capacity $\couriercap_j$ & $100$ & $0$ & $0$ & $100$\\
            Orders $(\%)$ & $100$ & $0$ & $0$ & $100$\\
            Cost $(\$$ per hour) & $2121.00$ & $0$ & $0$ & $2121.00$\\
            %Utilization $\rho_j$ $(\%)$ & $88$ & $0$ & $0$ & $88$\\
            Latency $\lat_j$ (min) & $21.50$ & $0$ & $0$ & $21.50$\\
            Price $\tax_j$ $(\$)$ & $10.00$ & $0$ & $0$ & $10.00$\\
            Distance (km) & $2.36$ & $0$ & $0$ & $2.36$\\
            \bottomrule 
        \end{tabular}
        \caption{Results for a meal delivery system with $100$ car couriers. Minimum order price is $\$10.00$.}
        \label{tab:result_1}
    \end{table}

    \begin{table}[!t]
        \centering
        \begin{tabular}{lcccc}
            \toprule
            & Cars & Drones & Robots & Total\\
            \cmidrule(r){1-1}\cmidrule(r){2-4}\cmidrule(r){5-5}
            %Capacity $\couriercap_j$ & $100$ & $0$ & $0$ & $100$\\
            Orders $(\%)$ & $50$ & $24$ & $26$ & $100$\\
            Cost $(\$$ per hour) & $1061.90$ & $255.85$ & $276.10$ & $1593.85$\\
            %Utilization $\rho_j$ $(\%)$ & $90$ & $90$ & $89$ & $90$\\
            Latency $\lat_j$ (min) & $21.33$ & $5.66$ & $27.18$ & $19.12$\\
            Price $\tax_j$ $(\$)$ & $6.64$ & $11.29$ & $5.63$ & $7.52$\\
            Distance (km) & $2.45$ & $2.53$ & $2.03$ & $2.36$\\
            \bottomrule 
        \end{tabular}
        \caption{Results for a meal delivery system with $50$ car, $10$ drone, and $35$ robot couriers available. Minimum order price is $\$5.42$}
        \label{tab:result_2}
    \end{table}

    \begin{table}[!t]
        \centering
        \begin{tabular}{lcccc}
            \toprule
            & Cars & Drones & Robots & Total\\
            \cmidrule(r){1-1}\cmidrule(r){2-4}\cmidrule(r){5-5}
            %Capacity $\couriercap_j$ & $100$ & $0$ & $0$ & $100$\\
            Orders $(\%)$ & $20$ & $57$ & $23$ & $100$\\
            Cost $(\$$ per hour) & $431.90$ & $599.45$ & $244.95$ & $1276.30$\\
            %Utilization $\rho_j$ $(\%)$ & $90$ & $0$ & $0$ & $88$\\
            Latency $\lat_j$ (min) & $15.55$ & $6.29$ & $15.19$ & $10.23$\\
            Price $\tax_j$ $(\$)$ & $5.34$ & $6.97$ & $4.29$ & $6.02$\\
            Distance (km) & $2.15$ & $2.96$ & $1.08$ & $2.36$\\
            \bottomrule 
        \end{tabular}
        \caption{Results for a meal delivery system with $20$ car, $20$ drone, and $35$ robot couriers available. Minimum delivery price is $\$3.95$}
        \label{tab:result_3}
    \end{table}
    
    In the next case, we consider that there are $50$ car, $10$ drone, and $35$ robot couriers available. Other than improving the average delivery time, we expect the inclusion of drones and robots to lower the minimum delivery price required due to two factors: (1) drones and robots are cheaper to operate making the total operational cost smaller, and (2) the faster speed of drones allows us to charge users who favor shorter delivery times more than users who favor cheaper delivery prices. We show the result corresponding to the most efficient allocation strategy in Table~\ref{tab:result_2}, where we can see that the delivery time has decreased, and note that the minimum order price of $\$5.42$ is almost half of the previous $\$10$. The total operational cost of $1593.85$ dollars per hour is lower than before, while the average price for drone deliveries at $\$11.29$ is high compared to the other delivery modes. \par 
    
    In the final case we replace a larger portion of car couriers with drones, and consider that there are $20$ car, $20$ drone, and $35$ robot couriers available. We again show the results corresponding to the most efficient allocation in Table~\ref{tab:result_3}, where we note that the minimum delivery price has dropped further to $\$3.95$. As expected, the total operational cost and average delivery time have also decreased. We can also tell more clearly from the distances reported that drones are used to complete orders for customers furthest away from their chosen restaurant, while robots are used for customers closest to their chosen restaurant. This is due to the travel speeds of the different transportation modalities, as drones can travel efficiently between distant destinations, while robots are restricted to operate in a smaller range as they have a pedestrian pace. Lastly, we point out that the delivery price for drones no longer needs to be as high compared to other modes. Since drones can now support more orders overall, the premium charged for faster delivery can be lowered.\par 
    
    Overall, our case study shows that by setting prices according to users' trade-offs between money and time, one can implement a desired allocation strategy over multiple delivery modalities while improving their profit margins.\par 

    \section{Conclusion}\label{sec: Conclusion}
    We model the pickup and delivery problem with multiple transportation modalities as a congestion game played over a star network, and show that we can explicitly define prices to induce any desired network flow. With this framework, we construct a case study of the meal delivery problem and use real historical data to define our parameters. We show that by utilizing autonomous transportation methods which are more efficient, one can set prices according to users' trade-offs between money and time to induce a desired allocation strategy while improving their profit margins. We go over some of the implications of our work, pointing out limitations and directions for improvement.\par

    We first note that in the setting of non-atomic congestion games taking place on graphs composed of one source--sink pair, prior works have asked if a feasible solution can be found to compute optimal prices for edges combinatorially, without relying on LP formulations~\cite{roughgarden2003a}. Our main theoretical result states that in these settings, one can define optimal prices for paths combinatorially, implying that the LP formulation used to find prices for edges can be simplified. This points to the possibility that other network structures inherit properties which allow one to find prices efficiently, and we leave this direction for future works.\par

    Further, we point out that our case study is only one example where such a model is useful. Due to the general construction of the congestion game defined, our analysis is practical for any application that utilizes a platform to price match customers with different transportation methods. Some examples include ride-hailing, airport taxis which provide transportation via UAVs, and delivery for services other than food. Since our formulation poses little restriction on the latency function defined, one can construct a model that is suitable for the desired application.\par 
    
    Of course our framework gives no guarantees on finding the optimal allocation strategy, and instead provides a method by which prices can be set to induce a desired strategy. One important restriction made in our formulation is the omission of prices from the main objective function. Due to the ordering permutations required to solve for the delivery prices, one can not directly compute the derivatives of the objective and constraints if they depended on these delivery prices. In this case, one can compute the derivative information empirically, derive heuristics which treat the permutations directly, or utilize other optimization techniques.\par 

    Lastly, we want to comment on the ethical implications of our case study. On the positive side, our results show that by utilizing more autonomous transportation methods one can improve profit margins. However, this is because our model considers car couriers operated by humans as less cost efficient. While one may have financial incentives to substitute part of their current workforce with autonomous machines, other decisions can be made that improve wages and work conditions for employees. Such a discussion is beyond the scope of our work, and is a topic that should be carefully addressed by policy makers before corporations are allowed to make decision that greedily improve their profits.\par

    % Although Equation~\ref{eq:main_result} defines prices for parallel edges, this is equivalent to finding prices for paths in more general graphs composed of one source--sink pair. While prior works derive Linear Program (LP) formulations to directly find edge prices which induce the equilibrium flow, Theorem~\ref{thm:pricing condition} implies that one can first find path prices combinatorially to simplify the LP formulation. Since users choosing between delivery modes can be represented by parallel edges, we forego defining paths in our formulation to be concise. 

    % This paper examines the pickup and delivery problem with multiple transportation modalities, and demonstrates how one can achieve a desired allocation strategy for a set of orders by appropriately setting prices for each modality. Specifically, we consider orders demanded by a heterogeneous population of users with varying trade-offs between price and latency. This problem is analogous to a congestion game taking place over a star network, as depicted in Figure~\ref{fig:fron_fig}, where the source--sink pairs represent independent sub-networks composed of parallel links connecting users with their preferred delivery method. This unique network structure enables us to show that we can explicitly define prices to induce any desired network flow, i.e, given a desired allocation strategy we have a closed-form solution for the delivery prices.

    

        %\mcomment{Discussion talking points so far: simplicity of model, but provides intuitive explanation for finding prices over paths, mention how such a result was desired by prior work, and maybe can be extended further to simplify them LP. Discuss the choice of case study is one option, choices such as taxi, more complex cost models, latency models etc. The idea of parallel edges is nice for these platforms that match users to rides. Mention one downside is the sorting required. State that in the case where the optimization does not depend on the prices itself, this is not an issue, but if it was the case, the optimization involved would require a different approach due to the permutations. Also mention ethics, and how logistic operators should make decisions (green environment, workers cooperative, so on)}

    % Increase the profit margin
    % by utilizing autonomous transportation methods for pickup and delivery which are more efficient in time and/or price

 % 	\begin{table}[!t]
	% 	\centering
 %  		\caption{Performance of ABS~\cite{49schott2018adversarially}, the clean classifier $f$, adversarial training $f^{(0)}$, and our truncated classifiers $f^{(50)}$ and $f^{(100)}$ against both the \texttt{sparse-rs} and \texttt{Pointwise} attacks. Note that while \texttt{sparse-rs} measures robust accuracy, \texttt{Pointwise} measures the median adversarial attack magnitude $\rho$. For both datasets we utilize $100$ samples when evaluating against attacks.}
	% 	\begin{tabular}{ccccc}
	% 		\toprule
	% 		\multicolumn{3}{c}{Setup} &
	% 		\multicolumn{2}{c}{Attack Model} \\
	% 		\cmidrule(r){1-3}\cmidrule(r){4-5}
	% 		Model & Data  & Acc. &\texttt{sparse-rs}~\cite{croce2020sparse} & \texttt{Pointwise}~\cite{49schott2018adversarially}\\
 %            &  & $(\%)$ & $(\%)$ & ($\#$ of pixels)\\
	% 		\midrule
	% 		ABS  & MNIST & $99.0$ & $37.0$ & $\mathbf{19}$\\
 %            $f$  & MNIST & $98.1$ & $0.0$ & $5$\\
 %            $f^{(0)}$ & MNIST & $98.4$ & $12.0$ & $13$\\
 %            $f^{(50)}$ & MNIST & $97.8$ & $\mathbf{54.0}$ & $13$\\
 %            \midrule
 %            $f$  & CIFAR & $85.6$ & $0.0$ & $3$\\
 %            $f^{(0,100)}$  & CIFAR & $87.2$ & $7.0$ & $11$\\
 %            $f^{(100)}$ & CIFAR & $82.1$ & $\mathbf{47.0}$ & $\mathbf{34}$\\
	% 		\bottomrule
	% 	\end{tabular}

 %        \label{tab:main_result}
	% \end{table}


    
\bibliographystyle{IEEEtran}
\bibliography{IEEEabrv,refs.bib}

\appendices
\section{Proof of Theorem 1}\label{sec: app_proof}
    Note that for sake of notation, we will drop the subscript referring to orders $\order\in\Orders$, as it should be clear that the proof applies to an individual source--sink pair. In addition, we assume that indexes $\mode\in\Modes:\{1,\ldots,\numModes\}$ correspond to the set of edges sorted by non-decreasing latency.\par
    \begin{figure}[!h]
    	\centering
    	\begin{tikzpicture}[scale=7]
    		\draw[-, thick] (0,0) -- (1,0);
    		\foreach \x/\xtext in {0/0,0.3/$\user_{\mode-1}$,0.5/$\user_{\mode}$,0.7/$\user_{\mode+1}$,1/$1$}
    		\draw[thick] (\x,0.5pt) -- (\x,-0.5pt) node[below] {\xtext};
    		\draw (0.15,-1pt) node {$\ldots$};
    		\draw (0.85,-1pt) node {$\ldots$};
    		\draw[[-), ultra thick, blue] (0.3,0) -- (0.5,0);
    		\draw[[-), ultra thick, red] (0.5,0) -- (0.7,0);
    		%\draw (-0.36,7pt) node {$\user\in[\user_0,\user_\modes], \user_0=0, \user_\modes=1$};
    		%\draw (-0.4,5pt) node {$\forall \user\in [\user_{\mode-1},\user_\mode): x_\order(\user)=i $};
    		\draw (0.4,3pt) node {$\tax_\mode$};
    		\draw (0.4,1.5pt) node {$\lat_\mode$};
    		\draw (0.6,3pt) node {$\tax_{\mode+1}$};
    		\draw (0.6,1.5pt) node {$\lat_{\mode+1}$};
    		\draw (0.5,3pt) node {$\geq$};
    		\draw (0.5,1.5pt) node {$\leq$};
    		%\draw (0.4,-1.5pt) node {$x_i$};
    		%\draw (0.6,-1.5pt) node {$x_{\mode+1}$};
    	\end{tikzpicture}
    	\caption{A sketch depicting how a canonical Nash flow splits the population $\user\in[\user_0,\user_{\numModes}]$ into subintervals $[\user_{\mode-1},\user_\mode): x(\user)=\mode$, where $\user_0=0$, $\user_{\numModes}=1$, and $\mode\in\Modes$.}
    	\label{fig:proof intervals}
    \end{figure}
    
    We define two adjacent intervals that are formed by our flow $x$: users $\user\in[\user_{\mode-1},\user_\mode]$ on the left experience delivery time $\lat_\mode$ and price $\tax_\mode$, while users $\user\in[\user_{\mode},\user_{\mode+1}]$ on the right experience delivery time $\lat_{\mode+1}$ and price $\tax_{\mode+1}$. The two intervals are portrayed in Fig.~\ref{fig:proof intervals}, where we note that this definition holds for $\mode\in\{1,\ldots,\numModes-1\}$. Using the inequalities defined in Eq.~\eqref{eq:Nash_condition}, we know that for $x$ to be a Nash flow for instance $(\pop,\lat,\tax)$, no user $\user$ from the left interval $\user\in[\user_{\mode-1},\user_\mode]$ should want to switch to the delivery option corresponding to the right interval:
    
    \begin{equation}\label{eq:left_to_right}
    	\lat_\mode+\pop(\user)\tax_\mode \leq \lat_{\mode+1}+\pop(\user)\tax_{\mode+1} \quad\forall\user\in[\user_{\mode-1},\user_\mode],
    \end{equation}
    where we leave out denoting the flow $x$ in latency $\lat_\mode(x)$. It follows:
    
    \begin{align}
    	%\lat_\mode+\pop(\user)\tax_\mode &\leq \lat_{\mode+1}+\pop(\user)\tax_{\mode+1} \quad\forall\user\in[\user_{\mode-1},\user_\mode],\\
    	\tax_\mode -\tax_{\mode+1} &\leq \frac{\lat_{\mode+1}-\lat_{\mode}}{\pop(\user)} \quad\forall\user\in[\user_{\mode-1},\user_\mode],\\
    	\tax_\mode -\tax_{\mode+1} &\leq \min_{\user\in[\user_{\mode-1},\user_\mode]}\Big({\frac{\lat_{\mode+1}-\lat_{\mode}}{\pop(\user)}}\Big).
    \end{align}
    
    The preceding inequality can be simplified further by using the non-decreasing property of function $\pop$ defining the population's price sensitivity: for any $\user_1,\user_2\in[0,1]$ such that $\user_1\leq\user_2$, given user $\user\in[\user_1,\user_2]$, $\max{\pop(\user)}=\pop(\user_2)$ and $\min{\pop(\user)}=\pop(\user_1)$. This comparison results in the following condition which must be true for $x$ to be a Nash flow:   
    \begin{equation}\label{eq:left_ineq}
     	\tax_\mode -\tax_{\mode+1} \leq {\frac{\lat_{\mode+1}-\lat_{\mode}}{\pop(\user_\mode)}}.
    \end{equation}
    
    We can repeat this process by enforcing that no user $\user$ from the right interval $\user\in[\user_{\mode},\user_{\mode+1}]$ should want to switch to the edge on the left:
    
    \begin{align}
     	\lat_{\mode+1}+\pop(\user)\tax_{\mode+1} &\leq \lat_{\mode}+\pop(\user)\tax_{\mode} \quad\forall\user\in[\user_{\mode},\user_{\mode+1}],\\
     	%\tax_\mode -\tax_{\mode+1} &\geq \frac{\lat_{\mode+1}-\lat_{\mode}}{\pop(\user)} \quad\forall\user\in[\user_{\mode},\user_{\mode+1}],\\
    	\tax_\mode -\tax_{\mode+1} &\geq \max_{\user\in[\user_{\mode},\user_{\mode+1}]}\Big({\frac{\lat_{\mode+1}-\lat_{\mode}}{\pop(\user)}}\Big),
    \end{align}
     	which results in the following:
    
    \begin{equation}\label{eq:right_ineq}
     	\tax_\mode -\tax_{\mode+1} \geq {\frac{\lat_{\mode+1}-\lat_{\mode}}{\pop(\user_\mode)}}.
    \end{equation}
    
    From \eqref{eq:left_ineq} and \eqref{eq:right_ineq} we can see that the two inequalities force the set of prices $\settax$ to follow:
    \begin{equation}\label{eq:proof_eq}
     	\tax_\mode -\tax_{\mode+1} = {\frac{\lat_{\mode+1}-\lat_{\mode}}{\pop(\user_\mode)}} \quad\forall \mode\in\{1,\ldots,\numModes-1\},
    \end{equation}
    where if $\tax_{\numModes}$ is given, the rest of the prices can be found recursively as defined in Eq~\eqref{eq:main_result}.\par
    
    To complete the proof, we must show that for this set of prices $\tax$, the desired $x$ is indeed an equilibrium flow. Formally, $x$ is an equilibrium flow for instance $(\pop,\lat,\tax)$ if for all edges $\mode\in\setmodes$ no user $\user$ in interval $\user\in[\user_{\mode-1},\user_\mode]$ should want to switch to any other edge $\mode'\in\setmodes$:
    \begin{equation}\label{eq:proof_all_ineq}
      	\lat_\mode+\pop(\user)\tax_\mode \leq \lat_{\mode'}+\pop(\user)\tax_{\mode'}.
    \end{equation}
    %, \quad\forall\user\in[\user_{\mode-1},\user_\mode],\forall \mode\in\{1,\ldots,\modes\},\forall j\in\{1,\ldots,\modes\}.
    Clearly these inequalities hold when $\mode=\mode'$, and hence we show that they hold when $\mode>\mode'$ and $\mode<\mode'$. Starting with the former, when $\mode>\mode'$ we are considering that no user choosing edge $\mode$ will switch to any edge $\mode'$ on the left, where by definition $\tax_\mode\leq\tax_{\mode'}$ and $\lat_\mode\geq\lat_{\mode'}$. Rearranging Eq.~\ref{eq:proof_all_ineq}, we have the following for all edges $\mode>\mode'$:
    \begin{align*}
     	&\lat_\mode+\pop(\user)\tax_\mode \leq \lat_{\mode'}+\pop(\user)\tax_{\mode'} \quad\forall\user\in[\user_{\mode-1},\user_\mode],\\
     	&\tax_{\mode'} -\tax_\mode \geq \max_{\user\in[\user_{\mode-1},\user_{\mode}]}\Big(\frac{\lat_\mode-\lat_{\mode'}}{\pop(\user)}\Big),\\
     	%&\tax_{\numModes}+\sum_{k=\mode'}^{\numModes-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)} - \tax_{\numModes}-\sum_{k=\mode}^{\numModes-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)}\geq \frac{\lat_\mode-\lat_{\mode'}}{\pop(\user_{\mode-1})},\\
        &\sum_{k=\mode'}^{\numModes-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)}-\sum_{k=\mode}^{\numModes-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)}\geq \frac{\lat_\mode-\lat_{\mode'}}{\pop(\user_{\mode-1})},\\
     	&\sum_{k=\mode'}^{\mode-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)}\geq \sum_{k=\mode'}^{\mode-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_{\mode-1})}.
    \end{align*}
    Since $\pop(\user_{\mode-1})\geq\pop(\user_k)$ when $\mode'\leq k \leq \mode-1$, every summation term on the left hand side is strictly greater than or equal to every summation term on the right hand side, validating the inequalities in Eq.~\ref{eq:proof_all_ineq} for $\mode>\mode'$. We can do the same for $\mode<\mode'$, where now $\tax_\mode\geq\tax_{\mode'}$ and $\lat_\mode\leq\lat_{\mode'}$:
    \begin{align*}
     	&\lat_\mode+\pop(\user)\tax_\mode \leq \lat_{\mode'}+\pop(\user)\tax_{\mode'} \quad\forall\user\in[\user_{\mode-1},\user_\mode],\\
     	&\tax_\mode -\tax_{\mode'} \leq \min_{\user\in[\user_{\mode-1},\user_{\mode}]}\Big(\frac{\lat_{\mode'}-\lat_\mode}{\pop(\user)}\Big),\\
     	%&\tax_{\numModes}+\sum_{k=\mode}^{\numModes-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)} - \tax_{\numModes}-\sum_{k=\mode'}^{\numModes-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)}\leq \frac{\lat_\mode-\lat_{\mode'}}{\pop(\user_{\mode})} \quad\forall \mode<\mode',\\
        &\sum_{k=\mode}^{\numModes-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)}-\sum_{k=\mode'}^{\numModes-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)}\leq \frac{\lat_\mode-\lat_{\mode'}}{\pop(\user_{\mode})},\\
    	&\sum_{k=\mode}^{\mode'-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_k)}\leq \sum_{k=\mode}^{\mode'-1}\frac{\lat_{k+1}-\lat_{k}}{\pop(\user_{\mode})}.
    \end{align*}
    This time, since $\pop(\user_{\mode})\leq\pop(\user_k)$ when $\mode\leq k \leq \mode'-1$, every summation term on the left hand side is strictly less than or equal to every summation term on the right hand side. This completes the proof.

% \section{Implementation Details}\label{sec: app_implementation}
% We use a public implementation of the interior-point filter line-search algorithm~\cite{wachter2006implementation}, and integrate it with the dataset of Grubhub instances~\cite{reyes2018meal} using Python. We briefly outline our procedure below, and provide our code online~\cite{my_implementation}.

% \mcomment{Appendix should list the program used, as well as very brief derivations of hessian and lagrangian.}
        
% \begin{table}[!h]
% 	\centering
%     \caption{CNN architecture used for MNIST experiments.}
% 	\begin{tabular}{cc}
% 		\toprule
% 		\multicolumn{1}{c}{Layer} &
% 		\multicolumn{1}{c}{Output Shape}\\
% 		\cmidrule(r){1-1}\cmidrule(r){2-2}
% 		Input & $[1,28,28]$\\
%         BatchNorm2d & $[1,28,28]$\\
% 		Conv2d + BatchNorm2d + ReLU & $[32,28,28]$\\
% 		Conv2d + BatchNorm2d + ReLU & $[32,28,28]$\\
%         MaxPool2d & $[32,14,14]$\\
% 		Conv2d + BatchNorm2d + ReLU & $[64,14,14]$\\
%         Conv2d + BatchNorm2d + ReLU & $[64,14,14]$\\
%         MaxPool2d & $[64,7,7]$\\
%         AvgPool2d & $[64,7,7]$\\
%         Flatten + Linear & $[10]$\\
%   		\bottomrule
% 	\end{tabular}
% 	\label{tab:MNIST_arch} 
% \end{table}
\end{document}
