\section{Application to Proportional Sampling}
\label{sec:prop-sampling}

\begin{figure*}
    \centering
    \input{figures/phase-oracle.tex}
    \caption{Implementation of a phase oracle for $\sqrt{\Tilde{c}(x)}$ using one call to $\bigO'_c, (\bigO'_c)^\dag$. The total phase applied to the quantum state will be $e^{i \pi \sqrt{\Tilde{c}(x)} / 2}$ where $|\sqrt{\Tilde{c}(x)} - \sqrt{c(x)}| \le 2^{-m}$. The two ancilla registers can then be discarded.}
    \label{fig:phase-oracle}
\end{figure*}

\noindent We consider the following problem.
\begin{problem}
    \label{def:prop-sampling}
    Consider a set $X$ of elements. We are given a function $c(x) : X \mapsto [0, 1)$ as an oracle, i.e.,
    \begin{align*}
        \bigO_c \ket{x} \ket{0}^{\otimes m} = \ket{x} \ket{c(x)} \ ,
    \end{align*}
    where $\ket{c(x)}$ contains the $m$ bits of $c(x)$ after the decimal point. Sample a value $x \in X$ such that $P(x) \propto c(x)$ up to some error $\epsilon > 0$. In other words:
    \begin{align*}
        \left| P(x) - \frac{c(x)}{\sum_{x \in X} c(x)} \right| \le \epsilon \ .
    \end{align*}
\end{problem}
For ease of exposition, we assume that the elements of $X$ are encoded as integers, i.e., $X = \{ 0, \ldots, N - 1 \}$, where $N \le 2^n \le 2N$. Moreover, we assume to know the \emph{average oracle value} $\bar{c} := \frac{1}{N} \sum_{x \in X} c(x)$.

In pratical applications, one usually wants to bound the so-called \emph{total variation distance} between the target and implemented probability distributions (see Section 4.1 of~\cite{levinMarkovChainsMixing2017} for a nice introduction to this metric). In order to bound this distance by $\epsilon$ it is sufficient to solve Problem~\ref{def:prop-sampling} within $\epsilon/N$ error. Quantum speed-up for this stronger version of the problem can be achieved using the improvements proposed in Section~\ref{sec:inductive-smoothening}.

\subsection{Constructing a phase oracle}
Since we want $c(x)$ as a probability, the idea is to extract the phases using the transformation $\bar{\phi}(z)$ designed in Section~\ref{sec:phase-extraction-problem} on the unitary
\begin{align*}
    U \ket{x} = e^{i \pi \sqrt{c(x)} / 2} \ket{x} \ .
\end{align*}
The factor $\pi/2$ will be clear later. Of course we cannot reproduce an arbitrary square root with an infinite number of digits as our eigenphases, but here we show a simple construction for the following unitary
\begin{align*}
    U' \ket{x} = e^{i \pi \sqrt{\Tilde{c}(x)} / 2} \ket{x} \ ,
\end{align*}
where $\sqrt{\Tilde{c}(x)}$ is the $m'$-bit truncation of $\sqrt{c(x)}$. Using the bit oracle $\bigO_c$ given in Problem~\ref{def:prop-sampling}, we can construct a bit oracle $\bigO'_c$ behaving as
\begin{align*}
    \bigO'_c \ket{x} \ket{0}^{\otimes m'} = \ket{x} \ket{\sqrt{\Tilde{c}(x)}} \ ,
\end{align*}
by decorating one call to the original oracle with a square root algorithm of $m'$-bit precision.

Now, using a standard construction (depicted in Figure~\ref{fig:phase-oracle}), we can implement $U'$ using $\bigO'_c$ and $(\bigO'_c)^\dag$. Only two copies of the original oracles $\bigO_c, \bigO^\dag_c$ are needed to construct $U'$.

\subsection{Bounding the approximation error}
By transforming $U'$ using $\bar{\phi}_\delta(z)$ we obtain an Hermitian block-encoded matrix $H_c$ acting as
\begin{align}
    H_c \ket{x} & = \bar\phi_\delta(e^{i \pi \sqrt{\Tilde{c}(x)} / 2}) \ket{x}\nonumber \\
    & = \phi_\delta \left(\frac{\pi}{2} \sqrt{\Tilde{c}(x)} \right) \ket{x} = \frac{1}{2} \sqrt{\Tilde{c}(x)} \ket{x} \label{eq:prop-sampling-ideal-transform}
\end{align}
provided that $|\frac{\pi}{2} \sqrt{\Tilde{c}(x)}| \le \pi - \delta$. It should now be evident why we added the $\pi/2$ factor, as we can fix $\delta$ as high as $\pi/2 = \Theta(1)$. If we applied this ideal transformation to the uniform superposition, we would obtain
\begin{align*}
    H_c \ket{+}^{\otimes n} = \frac{1}{2 \sqrt{N}} \sum_{x \in X} \sqrt{\Tilde{c}(x)} \ket{x}
\end{align*}
We have two sources of error on the final sampling probabilities: the first one, $|c(x) - \Tilde{c}(x)|$, is given by the $m'$-bit truncation and can be bounded easily
\begin{align*}
    |c(x) - \Tilde{c}(x)| & = |\sqrt{c(x)} + \sqrt{\Tilde{c}(x)}| \cdot |\sqrt{c(x)} - \sqrt{\Tilde{c}(x)}| \\
    & \le 2 \cdot \frac{1}{2^{m'}} = \frac{1}{2^{m'-1}} \stackrel{!}{\le} \frac{\epsilon'}{2} \ ,
\end{align*}
where the last inequality holds for $m' = \bigO(\log \epsilon')$. The second noise comes from the approximation of $\phi_\delta$ by $S_{\delta, d}$: if the approximation is up to $\epsilon'/16$ then
\begin{align*}
    \left| S^2_{\delta, d}\left(\frac{\pi}{2} \sqrt{c} \right) - \frac{1}{4} c \right| & = \left| S^2_{\delta, d}\left(\frac{\pi}{2} \sqrt{c} \right) - \phi^2_\delta\left(\frac{\pi}{2} \sqrt{c} \right) \right| \\
    & \le ||S_{\delta, d} + \phi_\delta||_{\R} \cdot ||S_{\delta, d} - \phi_\delta||_{\R} \\
    & \le 2 \cdot \frac{\epsilon'}{16} = \frac{\epsilon'}{8}
\end{align*}
for any $c \in [0, 1)$ (the $1/4$ factor comes from the $1/2$ factor in Eq.~(\ref{eq:prop-sampling-ideal-transform})). This is guaranteed by Theorem~\ref{thm:phase-extraction-jackson-rate} if we take
\begin{align*}
    d = \Tilde{\bigO}\left( \frac{1}{\delta} \sqrt{\frac{8}{\epsilon'}} \right) = \Tilde{\bigO}\left( \sqrt{\frac{1}{\epsilon'}} \right)
\end{align*}
as $\delta$ was already fixed to be constant. Therefore, the distance between the ideal oracle $c(x)$ and our implementation $s(x) := 4 S^2_{\delta, d}(\frac{\pi}{2} \sqrt{\Tilde{c}(x)})$ is
\begin{align*}
    \left|s(x) - c(x)\right| & \le \left|s(x) - \Tilde{c}(x)\right| + |\Tilde{c}(x) - c(x)| \\
    & \le 4 \frac{\epsilon'}{8} + \frac{\epsilon'}{2} \le \epsilon' \ .
\end{align*}
This is needed to bound the error induced in the sampling probabilities, but it is not sufficient, as this error bound will now be amplified by the amplitude amplification scheme.

\subsection{Amplifying the state}
The state $H_c \ket{+}^{\otimes n}$ is sub-normalized, because $H_c$ is not a unitary transformation, but only a block-encoded Hermitian matrix. By looking again at Figure~\ref{fig:block-encoding-sum-circuit}, we can see that we have two control qubits, $A$ and $B$. We measure both these qubits in the computational basis and, if we measure $\ket{00}$, then we picked the correct block. The probability of this happening is:
\begin{align*}
    || H_c \ket{+}^{\otimes n} ||^2 & = \frac{1}{N} \sum_{x \in X} S^2_{\delta, d} \left(\frac{\pi}{2} \sqrt{\Tilde{c}(x)} \right) \\
    & \ge \frac{1}{4 N} \sum_{x \in X} (c(x) - \epsilon') =: \frac{1}{4}(\bar{c} - \epsilon')\ ,
\end{align*}
and we take $\epsilon' = \frac{\bar{c} \epsilon}{2} \le \frac{\bar{c}}{2}$. Since an upper bound $\frac{1}{4}(\bar{c} + \epsilon')$ can be derived in a similar fashion, the initial amplitude is $\Theta(\sqrt{\bar{c}})$ and we can employ an \emph{amplitude amplification} procedure (see Appendix~\ref{apx:amplitude-amplification}) to normalize the state with $\bigO\left(\frac{1}{\sqrt{\bar{c}}}\right)$ repetitions. Using $c^*, s^*$ as shorthands for $\sum_x c(x), \sum_x s(x)$, we get
\begin{align*}
    \left| \frac{c(x)}{c^*} - \frac{s(x)}{s^*}\right| & = \frac{1}{s^* c^*} \left|c(x) s^* - s(x) c^* \right| \\
    & = \frac{s(x)}{s^* c^*} \left| s^* - c^* \right| + \frac{1}{c^*} |c(x) - s(x)| \\
    & \le \frac{1}{c^*} \left| s^* - c^* \right| + \frac{1}{c^*} |c(x) - s(x)| \\
    & \le \frac{N \epsilon'}{c^*} + \frac{\epsilon'}{c^*} = \frac{\epsilon'}{\bar{c}} + \frac{\epsilon'}{N \bar{c}} \\
    & \le \frac{2 \epsilon'}{\bar{c}}  \stackrel{!}{\le} \epsilon \ ,
\end{align*}
and one can see that our choice of $\epsilon'$ always satisfies the last inequality. To sum up, we obtained the following algorithm:
\begin{algorithm}[Proportional Sampling by QSP]
\label{alg:prop-sampling-qsp}
Let $\bar{c} = \frac{1}{N} \sum_{x \in X} c(x)$ be the average oracle value, and fix $\delta = \frac{\pi}{2}$.
\begin{enumerate}
        \item Use Quantum Eigenvalue Transform on the eigenvalues of $U'$ using $\bar{S}_{\delta, d}(z)$, obtaining a block-encoding of $\bar{S}_{\delta, d}(U')$. This requires $d$ calls to $U'$ or, equivalently, $2d$ calls to $\bigO_c$.

        \item Compute the state $\bar{S}_{\delta, d}(U') \ket{+}^{\otimes n}$.

        \item Use OAA to amplify the above state. This requires $\bigO(\frac{1}{\sqrt{\bar{c}}})$ copies of $\bar{S}_{\delta, d}(U')$.
    \end{enumerate}
    The number of total calls to $\bigO_c$ will be
    \begin{align*}
        \bigO \left( \frac{1}{\sqrt{\bar{c}}} \cdot d \right) = \Tilde{\bigO} \left( \frac{1}{\bar{c}} \sqrt{\frac{1}{\epsilon}} \right)
    \end{align*}
    to achieve error up to $\epsilon$ with high probability.
\end{algorithm}
We remark that Algorithm~\ref{alg:prop-sampling-qsp} is a so-called \emph{Las Vegas} algorithm: whenever it fails (i.e., we pick the wrong block of the encoding), we immediately know, because we measure $\neq 00$ on the control qubits. Therefore, if this check fails, we repeat the whole algorithm, and the number of repetitions is constant in expectation, as the probability of success is lower bounded by a constant after the amplification scheme.

\subsection{Separation proof}
In this subsection, we show that Algorithm~\ref{alg:prop-sampling-qsp} gives actual speed-up over any classical algorithm. Consider the following instance: we assume $N$ to be even and divide $\{ 0, \ldots, N - 1 \}$ into two equally sized sets $A, B$, where
\begin{align*}
    c(x) =
    \begin{cases}
        \frac{1}{4} & x \in A \\
        \frac{1}{8} & x \in B
    \end{cases}
\end{align*}
One can see that, in this case, $\bar{c} = 3/16$ and if we want to sample up to error $\epsilon = 1/100 N$, Algorithm~\ref{alg:prop-sampling-qsp} samples correctly with $\Tilde{\bigO}(\sqrt{N})$ queries to the oracle.

\begin{theorem}
    No classical algorithm can solve Problem~\ref{def:prop-sampling} with less than $N - 1$ queries to the oracle.
\end{theorem}
\begin{proof}
    Let $P_c(\cdot) = \frac{c(x)}{\sum_y c(y)}$ be the probability distribution to approximate for instance $c$. Assume a classical algorithm $\mathcal{A}$ doing at most $N - 2$ queries to the oracle, and let $x_1, x_2$ be two of the values not queried by $\mathcal{A}$. If we take any instance $c'$ by only modifying $c(x_1), c(x_2)$ (in such a way that $\bar{c}' = \bar{c}$), then $\mathcal{A}$ will return the same probability distribution also for these two values, call it $P_{\mathcal{A}}(\cdot)$. Let us consider two separate cases: if one of $x_1, x_2 \in A$ (w.l.o.g. $x_1$), then $P_c(x_1) = 4/3N$, and the intervals of admitted values for correctness are at most $2/100 N$ long. Therefore, if we choose $c'(x_1) = 0$ (and $c'(x_2)$ so that $\bar{c}' = \bar{c}$), then $P_{c'}(x_1) = 0$, and $P_\mathcal{A}(x_1)$ cannot be $\epsilon$-close to both these probabilities.

    If $x_1, x_2 \in B$ setting $c'(x_1) = 0, c'(x_2) = \frac{1}{4}$ gives $P_{c'}(x_1) = 0 < P_{c}(x_1) - \frac{2}{100 N}$, therefore even in this case, $P_{\mathcal{A}}(x_1)$ cannot well-approximate both $c, c'$. We conclude that $\mathcal{A}$ is not correct.
\end{proof}