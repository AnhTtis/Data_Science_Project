

\section{Numerical examples}
\label{sect: numerical experiments}




In this section we will assess the efficiency of the Bubbles approach with the Dirac-Frenkel-MacLachlan approach against a spectral method in the two-dimensional case.



\subsection{Spectral scheme}

We start by discussing the spectral method we shall use to compare with the results of Algorithm \ref{algo: DFMP -- solve approximately cNLS}. We refer to \cite{fornbergPracticalGuidePseudospectral1996} for a general introduction to spectral methods for the Schr{\"o}dinger equation, and to \cite{antoineComputationalMethodsDynamics2013} for grid-based schemes applied to the Gross-Pitaevskii equation. 

We now present a method which can be understood as the application of \cite{bernierExactSplittingMethods2021} to a simpler equation, namely the Harmonic Oscillator. We use a splitting method to simulate the linear part \eqref{eqn: cNLS with psi -- linear part}, and thanks to \cite{bernierExactSplittingMethods2020,alphonsePolarDecompositionSemigroups2021} we have:
\begin{align}
    e^{-it (-\Delta + |x|^2)} 
    &= e^{- \frac{1}{2} \tanh(it) |x|^2} e^{\frac{1}{2} \sinh(2it)\Delta_x} e^{- \frac{1}{2} \tanh(it) |x|^2} \nonumber\\
    &= e^{- \frac{i}{2} \tan(t) |x|^2} e^{\frac{i}{2} \sin(2t)\Delta_x} e^{- \frac{i}{2} \tan(t) |x|^2}
    \label{eqn: num -- exact time splitting of HO}
.\end{align}
%
We can cite \cite{jinMathematicalComputationalMethods2011} which also presents a spectral method based on the Fourier transform with time splitting, however our method is different in that \eqref{eqn: num -- exact time splitting of HO} is exact and hence we do not have any time-splitting error.


The first and third exponentials on the RHS are straightforward to compute on a grid. For the second one, we use a Fourier transform: \( e^{\frac{i}{2} \sin(2t)\Delta_x} \) is the propagator of the following equation:
\begin{equation*}
    \partial_{t} \psi = i\cos(2t) \Delta_x \psi
.\end{equation*}
%
By using a Fourier transform, we get
\begin{equation*}
    \partial_{t} \mathcal{F}(\psi)(\xi)
    = i\cos(2t) \mathcal{F} \left( \Delta_x \psi\right)(\xi)
    = -i\cos(2t) |\xi|^2 \mathcal{F} \left( \psi \right)(\xi)
.\end{equation*}
%
Hence,
\begin{equation*}
    \mathcal{F}(\psi(t, \cdot))(\xi) = e^{-\frac{i}{2} \sin(2t) |\xi|^2} \mathcal{F}(\psi(0, \cdot))(\xi)
.\end{equation*}
%
The RHS exponential is straightforward to compute in the Fourier space. 
Hence, an exact-time spectral approximation of the solution to \eqref{eqn: cNLS with psi -- linear part} is given by Algorithm \ref{algo: num -- spectral solver linear part}.
From this, it is easy to obtain an algorithm which simulates \eqref{eqn: cNLS with psi} with interactions.
It consists in using a Strang splitting method on \eqref{eqn: cNLS with psi}, by splitting the linear part \eqref{eqn: cNLS with psi -- linear part} and the nonlinear part \eqref{eqn: cNLS with psi -- nonlinear part}. 
The linear part is approximated via Algorithm \ref{algo: num -- spectral solver linear part}, and the computation of interactions is explicit thanks to the fact that \( |u(t, x)|^2 \) does not depend on time (see e.g. \cite[Sect.~2.2]{faouGeometricNumericalIntegration2012}).
This fully describes Algorithm \ref{algo: num -- spectral solver}.

\begin{algorithm}
    \caption{Spectral solver for \eqref{eqn: cNLS with psi -- linear part}, with an exact time resolution for each splitting step.}
    \label{algo: num -- spectral solver linear part}
    \begin{algorithmic}
        \State Discretize the initial data \( \eta \) on a \( \text{Grid} \subset \mathbb{R}^d \).
        \For{ Each timestep of size \( \Delta t \) } 
            \For{ \( x \in \textsc{Grid} \) }
                \Comment{\(x \in \mathbb{R}^d\).}
                \State Multiply \( \eta(x) \) by \( e^{- \frac{i}{2} \tan(\Delta t) |x|^2} \).
            \EndFor
            %
            \State Apply a FFT to \( \eta \).
            \Comment{FFT: Fast Fourier Transform.}
            %
            \For{ \( \xi \in \textsc{Fourier Grid} \) }
                \Comment{\( \xi \in \mathbb{R}^d\).}
                \State Multiply \( \mathcal{F}(\eta)(\xi) \) by \( e^{-\frac{i}{2} \sin(2\Delta t) |\xi|^2} \).
            \EndFor
            %
            \State Apply an inverse FFT to \( \mathcal{F}(\eta) \).
            %
            \For{ \( x \in \textsc{Grid} \) }
                \State Multiply \( \eta(x) \) by \( e^{- \frac{i}{2} \tan(\Delta t) |x|^2} \).
            \EndFor
        \EndFor
    \end{algorithmic}
\end{algorithm}



\begin{algorithm}
    \caption{Spectral solver for \eqref{eqn: cNLS with psi}, with a Strang Splitting method.}
    \label{algo: num -- spectral solver}
    \begin{algorithmic}
        \State Discretize the initial data \( \eta \) on a \( \text{Grid} \subset \mathbb{R}^d \).
        \For{ Each timestep of size \( \Delta t \) } 
            \State Use Algorithm \ref{algo: num -- spectral solver linear part} with a stepsize \( \Delta t/2 \).
            \For{ \( x \in \textsc{Grid} \) } 
                \Comment{Add interactions.}
                \State Multiply \( \eta(x) \) by \( e^{-i\,\Delta t\, |\eta(x)|^2} \).
            \EndFor
            \State Use Algorithm \ref{algo: num -- spectral solver linear part} with a stepsize \( \Delta t/2 \).
        \EndFor
    \end{algorithmic}
\end{algorithm}




Of course, in pratical applications one is not able to define a grid over \( \mathbb{R}^d \). 
Hence, Algorithms \ref{algo: num -- spectral solver linear part} and \ref{algo: num -- spectral solver} have to be modified by defining \textsc{Grid} as a discretization of a finite-volume subset of \( \mathbb{R}^d \), typically a product of intervals in each dimension.
For all of our numerical examples, this will \( [-15, 15]\times[-15, 15] \), discretized using \( N_x\times N_y \) points.
In order to have an easily computable FFT, one has to use a spatial uniform grid, which then defines the \textsc{Fourier Grid}.
Special care has to be paid when choosing the number of points: if we have Fourier frequencies larger than the \emph{Nyquist frequency}, then we will observe a phenomenon known as \emph{aliasing}. 
This may not be problematic for the Harmonic Oscillator \eqref{eqn: cNLS with psi -- linear part} depending on the initial condition, but will eventually become an issue when simulating \eqref{eqn: cNLS with psi} because it involves interactions and hence an infinite number of frequencies.
Moreover, by using a FFT-based algorithm we implicitely impose periodic boundary conditions.





\subsection{Discretization into a sum of Bubbles}

We need to decompose any arbitrary function into a finite sum of \( N \) bubbles.
A solution to this question has been proposed in \cite{qianFastGaussianWavepacket2010}, but it involves integrals over the whole phase space, which is something we want to avoid.

We could also use a nonlinear least squares approach, but our experimental results showed that it tends to yield spread out gaussians, which may present huge overlaps between them. The overlaps cause issues with the DFMP, for instance a blow-up of the conservative quantities. This has been observed during our experiments but the results are not reported in this paper.
The issue of discretizing an arbitrary function into a sum of bubble without too much overlaps is not the main concern of this paper, hence we will use a visual trial-and-error discretization. Another possible way of discretizing the initial data is outlined in \cite{adamowiczLaserinducedDynamicAlignment2022}.




\subsection{Observables}

In order to compare the bubbles scheme against the spectral method, we compare them in absence of interactions, i.e. on the Harmonic Oscillator \eqref{eqn: cNLS with psi -- linear part}, as well as in the presence of nonlinear interactions, i.e. on \eqref{eqn: cNLS with psi}.
We showed in Lemma \ref{lemma: conserved quantities in HO} the conservation of some quantities for \eqref{eqn: cNLS with psi -- linear part} and \eqref{eqn: cNLS with psi}, we will focus on mass, energy and momentum.
When computing the observables for the spectral solution, we noted that the approximation of the gradient using finite differences with periodic boundary conditions yielded very rough results while the gradient approximation using the Fast Fourier Transform gave more accurate results. We use the latter approximation in the Figures of Section \ref{subsect: num results}.
In the case of bubbles, we compute every integral by hand thanks to the assumption \( v(s,y) = e^{-\frac{|y|^2}{2}} \), some details are given in Appendix \ref{appendix: Miscellaneous computations}. When reporting the results in the following \( \log \)-plots, all values with an amplitude smaller than \( 10^{-16} \) were set to be equal to \( 10^{-16} \).


For all of the results shown, the spectral scheme is supplied with the exact initial condition and not a projection on the grid of the bubbles discretization.





\subsection{Results}
\label{subsect: num results}


We consider examples adapted from \cite{baoNumericalSolutionGross2003}.


\subsubsection{Test case 1: Zero phase initial data}

The initial condition reads 
\begin{equation}
    \psi(t=0, x) = \pi e^{-\frac{|x-\mu_1|^2}{2} } + 2e^{-\frac{|x-\mu_2|^2}{2} }, \quad x\in \mathbb{R}^2,\quad \mu_1 = (0, 2), \ \mu_2 = (1, 0)
.\end{equation}
%




\begin{figure}
    \begin{subfigure}{\textwidth}
        \centering
        \inputtikz{1}{bubblesVSspectral_conservative_quantities_dt-0.001_coeffs-1.0-0.0_testcase1_Nx128_Ny129}
        \caption{\centering Approximate solution to the Harmonic Oscillator \eqref{eqn: cNLS with psi -- linear part}.}
    \end{subfigure}
    \begin{subfigure}{\textwidth}
        \centering
        \inputtikz{1}{bubblesVSspectral_conservative_quantities_dt-0.001_coeffs-1.0-1.0_testcase1_Nx128_Ny129}
        \caption{\centering Approximate solution to the Schrödinger equation \eqref{eqn: cNLS with psi} using DFMP Algorithm.}
    \end{subfigure}
    \caption{\centering Test case 1. Relative evolution of mass, energy and momentum with bubbles and spectral methods. \( \Delta t = 10^{-3} \). Time-integrator for the nonlinear part of the splitting: Runge-Kutta of order 4. Spectral scheme with \( N_x = 128, N_y = 129 \).}
    \label{fig: num -- test case 1}
\end{figure}




% \begin{figure}
%     \centering
%     \inputtikz{0.4}{courbe_cv_Nmin=16_Nmax=2048_testcase=1_HO=false_T=1.0_dt=0.005}
%     \caption{\centering Test case 1. Evolution of the \( L^2 \) norm of the difference between spectral and bubble schemes against the number of points in each direction \( N_x = N_y \), at time \( T = 1 \) with \( dt=5\cdot 10^{-3} \), relative w.r.t. the exact \( L^2 \) norm of the discretized initial data.}
%     \label{fig: num -- test case 1 - evolution of relative l2 norm}
% \end{figure}




The results are displayed in Figure \ref{fig: num -- test case 1}.
The solution approximated with the DFMP approach globally outperforms the spectral method on both the Harmonic Oscillator and the cubic NonLinear Schrödinger equations.
On the Harmonic Oscillator, the solution obtained with the Bubbles scheme is about one order of magnitude better than the spectral scheme. When we compare them on \eqref{eqn: cNLS with psi}, i.e. when adding interactions, the \( \mathbb{L}^2 \) norm is better conserved for the spectral scheme, but the other conservative quantities are better conserved on a long time for the Bubbles scheme.

The ``jumps'' in the DFMP approach may be explained by an ill-conditioned Gram matrix, which would then yield a very rough approximation of the modulation parameters.






\subsubsection{Test case 2: Weak interactions}

The initial condition reads 
\begin{equation}
    \psi(t=0, x) = e^{-|x - \mu_3|^2} e^{i \cosh |x - \mu_3|}, \quad x\in \mathbb{R}^2, \quad \mu_3 = (1, 1)
.\end{equation}
%

The approximation of this function as a sum of bubbles is pretty straightforward: we know that for \( x \) small, \( \cosh x \approx 1 + \frac{x^2}{2}  \), hence 
\begin{equation*}
    \psi(t=0, x) \approx e^{-|x - \mu_3|^2} e^{i + i\frac{|x - \mu_3|^2}{2} }, \quad x\in \mathbb{R}^2
.\end{equation*}
%



\begin{figure}
    \begin{subfigure}{\textwidth}
        \centering
        \inputtikz{1}{bubblesVSspectral_conservative_quantities_dt-0.001_coeffs-1.0-0.0_testcase2_Nx128_Ny129}
        \caption{\centering Approximate solution to the Harmonic Oscillator \eqref{eqn: cNLS with psi -- linear part}.}
    \end{subfigure}
    \begin{subfigure}{\textwidth}
        \centering
        \inputtikz{1}{bubblesVSspectral_conservative_quantities_dt-0.001_coeffs-1.0-1.0_testcase2_Nx128_Ny129}
        \caption{\centering Approximate solution to the Schrödinger equation \eqref{eqn: cNLS with psi} using DFMP Algorithm.}
    \end{subfigure}
    \caption{\centering Test case 2. Relative evolution of mass, energy and momentum with bubbles and spectral methods. \( \Delta t = 10^{-3} \). Time-integrator for the nonlinear part of the splitting: Runge-Kutta of order 4. Spectral scheme with \( N_x = 128, N_y = 129 \).}
    \label{fig: num -- test case 2}
\end{figure}





% \begin{figure}
%     \centering
%     \inputtikz{0.4}{courbe_cv_Nmin=16_Nmax=2048_testcase=2_HO=false_T=1.0_dt=0.005}
%     \caption{\centering Test case 2. Evolution of the \( L^2 \) norm of the difference between spectral and bubble schemes against the number of points in each direction \( N_x = N_y \), at time \( T = 1 \) with \( dt=5\cdot 10^{-3} \), relative w.r.t. the exact \( L^2 \) norm of the discretized initial data.}
%     \label{fig: num -- test case 2 - evolution of relative l2 norm}
% \end{figure}


The results are displayed in Figure \ref{fig: num -- test case 2}.
This example shows the performance of the DFMP approach in its most efficient setting: it only has one bubble. This explains the very good conservation results obtained: the Bubbles scheme outperforms the spectral scheme on both \eqref{eqn: cNLS with psi -- linear part} and \eqref{eqn: cNLS with psi}, except for the energy on \eqref{eqn: cNLS with psi}. However, even in this case, the error of the DFMP method remains generally less than one order of magnitude larger than the error from the spectral method.








\subsubsection{Test case 3: Strong interactions}

The initial condition reads 
\begin{equation}
    \psi(t=0, x) = 
    \begin{cases}
        \sqrt{M^2 - |x|^2} e^{i\cosh \sqrt{x_1^2 + x_2^2}}, & |x|^2 < M^2 \\
        0 & \text{otherwise}
    \end{cases}, \quad M = 4.
\end{equation}
%

We apply the same approximation for the complex exponential as previously explained, and use a ``visual trial-and-error'' discretization of the square root. It yields a number of \( N=9 \) bubbles. 
We emphasize the fact that this discretization may be far from being the best one achievable, however the process of discretizing an arbitrary function into a sum of bubbles is not the main concern of this paper. The discretization of the initial square root is given in Figure \ref{fig: num -- approximation of sqrt with bubbles}.


\begin{figure}
    \centering
    \inputtikz{0.7}{approx_sqroot_with_bubbles}
    \caption{\centering Approximation of \( x\mapsto \sqrt{M^2 - |x|^2} \) as a sum of bubbles}
    \label{fig: num -- approximation of sqrt with bubbles}
\end{figure}



\begin{figure}
    \begin{subfigure}{\textwidth}
        \centering
        \inputtikz{1}{bubblesVSspectral_conservative_quantities_dt-0.001_coeffs-1.0-0.0_testcase3_Nx128_Ny129}
        \caption{\centering Approximate solution to the Harmonic Oscillator \eqref{eqn: cNLS with psi -- linear part}.}
    \end{subfigure}
    \begin{subfigure}{\textwidth}
        \centering
        \inputtikz{1}{bubblesVSspectral_conservative_quantities_dt-0.001_coeffs-1.0-1.0_testcase3_Nx128_Ny129}
        \caption{\centering Approximate solution to the Schrödinger equation \eqref{eqn: cNLS with psi} using DFMP Algorithm.}
    \end{subfigure}
    \caption{\centering Test case 3. Relative evolution of mass, energy and momentum with bubbles and spectral methods. \( \Delta t = 10^{-3} \). Time-integrator for the nonlinear part of the splitting: Runge-Kutta of order 4. Spectral scheme with \( N_x = 128, N_y = 129 \).}
    \label{fig: num -- test case 3}
\end{figure}



% \begin{figure}
%     \centering
%     \inputtikz{0.4}{courbe_cv_Nmin=16_Nmax=2048_testcase=3_HO=false_T=1.0_dt=0.005}
%     \caption{\centering Test case 3. Evolution of the \( L^2 \) norm of the difference between spectral and bubble schemes against the number of points in each direction \( N_x = N_y \), at time \( T = 1 \) with \( dt=5\cdot 10^{-3} \), relative w.r.t. the exact \( L^2 \) norm of the discretized initial data.}
%     \label{fig: num -- test case 3 - evolution of relative l2 norm}
% \end{figure}


The results are displayed in Figure \ref{fig: num -- test case 3}.
This example is by far the most interesting of the three test cases presented in this paper, because it shows that with the discretization given in Figure \ref{fig: num -- approximation of sqrt with bubbles} the conservation properties are pretty good for the Bubbles scheme, even when there are a lot of interactions between bubbles. 
The spectral scheme is globally outperformed by the Bubbles scheme, except for the \( \mathbb{L}^2 \) norm in the presence of interactions, which is better conserved by the spectral scheme. Even in this case, the conservation of this quantity with the DFMP is relatively correct.

The ``jumps'' in the relative evolution of conservative quantities may be explained by an ill-conditioned Gram matrix in DFMP. It also has to be noted that if the discretization presents too much overlap between the gaussian functions, then the DFMP approach fails and the conservative quantities blow up: this has been observed with other discretizations of the same initial data, and is not reported here.
