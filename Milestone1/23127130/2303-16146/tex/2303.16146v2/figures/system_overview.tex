\begin{figure}
\begin{tikzpicture}[
  node distance=2cm,
  font=\small,
  CodeBlock/.style = {
  align=center,
  rectangle,
  draw=border-blue,
  thick,
  },
  ComponentBlock/.style={
  rectangle,
  draw=blue,
  thick,
  fill=blue!20,
  text width=5em,
  align=center,
  rounded corners,
  minimum height=2em
  }
]



\node (codeSource) [CodeBlock] {%
\centering

\begin{minipage}{7.2cm}
{\fontfamily{qbk}\selectfont
Jupyter Cell Source
}
\centering
\begin{minted}[bgcolor=light-gray]{python}
print(...)
foo().sort_values().head(n=5)
\end{minted}
\end{minipage}%
};




\draw node[CodeBlock, below=0.7cm of codeSource] (PattMatcher) {%
\centering
\begin{minipage}{7.2cm}
\centering
{\fontfamily{qbk}\selectfont
Pattern Matcher
}

\begin{minted}[bgcolor=light-gray, escapeinside=||]{python}
print(...)
|\colorbox{highlight-green}{foo().sort\_values().head(n=5)}|
\end{minted}
\end{minipage}%
};



\draw node[CodeBlock, below=0.5cm of PattMatcher] (OnlRewr) {%
\centering
\begin{minipage}{7.2cm}
\centering
{\fontfamily{qbk}\selectfont
Rewrite the Code
}

\begin{minted}[bgcolor=light-gray, escapeinside=||]{python}
print(...)

def sort_head(tmp):
  if type(tmp) == pd.Series:
    return tmp.nsmallest()
  else:
    tmp.sort_values().head(n=5)

sort_head(foo())

\end{minted}
\end{minipage}%
};


\draw node[CodeBlock, below=0.7cm of OnlRewr] (RunCell) {%
\centering
\begin{minipage}{7.2cm}
\centering
{\fontfamily{qbk}\selectfont
Execute the Rewritten Code
}

\begin{minted}[bgcolor=light-gray, escapeinside=||]{python}
ipython.run_cell(new_source)
\end{minted}
\end{minipage}%
};


\draw [-stealth] (codeSource) -- (PattMatcher);
\draw [-stealth] (PattMatcher) -- (OnlRewr);
\draw [-stealth] (OnlRewr) -- (RunCell);


\end{tikzpicture}
\caption{\system{} overview. \system{} identifies patterns in the source code,
which it rewrites using its rewriter. The optimized version is used only if
certain dynamic checks pass, to ensure correctness.}
\label{fig:system_overview}
\end{figure}