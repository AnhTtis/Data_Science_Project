\begin{figure}
\begin{tikzpicture}[
  node distance=2cm,
  font=\small,
  CodeBlock/.style = {
  align=center,
  rectangle,
  draw=border-blue,
  thick,
  },
  ComponentBlock/.style={
  rectangle,
  draw=blue,
  thick,
  fill=blue!20,
  text width=5em,
  align=center,
  rounded corners,
  minimum height=2em
  }
]



\node (codeSource) [CodeBlock] {%
\centering

\begin{minipage}{7.2cm}
{\fontfamily{qbk}\selectfont
Jupyter Cell Source
}
\centering
\begin{minted}[bgcolor=light-gray]{python}
print(...)
a, b = df['C'].str.split('(', 1, expand=True)
\end{minted}
\end{minipage}%
};




\draw node[CodeBlock, below=0.7cm of codeSource] (PattMatcher) {%
\centering
\begin{minipage}{7.2cm}
\centering
{\fontfamily{qbk}\selectfont
Pattern Matcher
}

\begin{minted}[bgcolor=light-gray, escapeinside=||]{python}
print(...)
|\colorbox{highlight-green}{a, b = df[\textquotesingle{}C\textquotesingle{}].str.split(\textquotesingle{}(\textquotesingle{}, 1, expand=True)}|
\end{minted}
\end{minipage}%
};



\draw node[CodeBlock, below=0.5cm of PattMatcher] (OnlRewr) {%
\centering
\begin{minipage}{7.2cm}
\centering
{\fontfamily{qbk}\selectfont
Rewrite the Code
}

\begin{minted}[bgcolor=light-gray, escapeinside=||]{python}
print(...)
ser = df['C']
if isinstance(ser, pd.Series):  # precondition
  # Rewritten
  a, b, ls = [], [], ser.tolist()
  for it in ls:
    spl = it.split('(', 1)
    a.append(spl[0])
    b.append(spl[1] if len(spl) > 1 else None)
  a = pd.Series(a, ser.index)
  b = pd.Series(b, ser.index)
else:
  # Original
  a, b = ser.str.split('(', n=1, expand=True)
\end{minted}
\end{minipage}%
};


\draw node[CodeBlock, below=0.7cm of OnlRewr] (RunCell) {%
\centering
\begin{minipage}{7.2cm}
\centering
{\fontfamily{qbk}\selectfont
Execute the Rewritten Code
}

\begin{minted}[bgcolor=light-gray, escapeinside=||]{python}
ipython.run_cell(new_source)
\end{minted}
\end{minipage}%
};


\draw [-stealth] (codeSource) -- (PattMatcher);
\draw [-stealth] (PattMatcher) -- (OnlRewr);
\draw [-stealth] (OnlRewr) -- (RunCell);

\draw[thick,-stealth]
    ($(2,-11.0)+(0:1.7)$) arc
    [start angle=-50,
    end angle=50,
    radius=2.3];


\end{tikzpicture}
\caption{\system{} overview. \system{} identifies patterns in the source code,
which it rewrites using its rewriter. The rewriting is not always valid.
\system{} preserves the original semantics by inserting checks in the code
(shown here), or by slicing the execution and performing checks in between.}
\label{fig:system_overview}
\end{figure}