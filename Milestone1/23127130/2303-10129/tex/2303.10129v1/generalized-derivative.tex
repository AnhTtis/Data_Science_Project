%\section{Non-Abelian generalized derivative}
\section{Non-Abelian covariant derivative}
\secl{generalized-der}
\ism{A key reference for this section is Ref.~\cite{mead-rmp92}, where
  the non-Abelian covariant derivative is discussed in
  Sec.~III.D. Note also that in his discussion of the non-Abelian
  formulation in Sec.~III, a central role is played by the operators
  $\hat{g}_\mu$ defined in Eq.~(3.15), whose matrix elements are
  nothing but the off-diagonal block of our $D^a$ matrix: see his
  Eq.~(4.22). Note also that Eq.~(3.18) gives an expression for
  $\partial_\mu \hat{g}_\nu$; we should try to relate it to our
  expression for $D^{a;b}_\AB$. See also below Eq.~(8) in
  arXiv:2110.13415, where they related it to the covariant derivative
  of the Bloch states (TO DO: work it out).}

\input{generalized-derivative-table}

%In this section, we will introduce covarant derivatives. In order to
%distinguish different derivatives more clearly, we use $\partial_a$ or
%subscript `$,a$' denotes simple derivatives, $\tilde{\partial_a}$,
%subscripts `$;a$' and `$:a$' denotes covarant derivatives.

%{\color{magenta} \sout{
%We will assume, that the \textit{repeated primed}
%indices are summed (with the values running over the corresponding subspace), while the non-primed 
%indices are not summed, unless written explicitly (for the Trace quantities). 
%Thus we shorten the equation by omiting the $\sum$ symbols.}
%}

%Before going ahead and differentiating \eq{Omega-tr-a} with respect to
%$\kk$, we need to introduce some more definitions and relations.
Consider two isolated groups of bands $A$ and $B$, and a matrix $X_{nl}$
% Eventually we will choose
% $A=\text{in}$ and $B=\text{out}$, but for now let us keep the
% discussion as general as possible.
The only assumption is that
$X_{nl}$ changes covariantly under gauge transformations $U_A$ and
$U_B$ that act separately on the $A$ and $B$ band groups,
%
\beq
\ket{n}\overset{U^A}{\longrightarrow}
\sum_m^A\,\ket{m}U^A_{mn}\,,\qquad
\ket{l}\overset{U^B}{\longrightarrow}
\sum_{p}^B\,\ket{p}U^B_{pl}\,.
\eql{gauge-transf}
\eeq
%
That is, we assume that
%
\beq
X_{nl}\overset{U^A}{\longrightarrow} 
\sum_m^A\,\left(U^A\right)^\dagger_{nm}X_{ml}\,,\qquad
X_{nl}\overset{U^B}{\longrightarrow} 
\sum_p^B\,X_{mp}U^B_{pl}\,.
\eeq
%
The problem is that the simple derivative $X^{,d}_{nl}$ is not
covariant in the above sense. This can be fixed by defining a
“covariant derivative” as in  \eq{gender} (see \tref{property-cov-der})
%
%\beq
%\begin{aligned}
%  %X^{:b}_{nl}&\equiv\partial_b X_{nl}+\sum_{n'}^A\,D^b_{nn'}X_{n'l}-
%  %\sum_{l'}^B\,X_{nl'}D^b_{l'l}
%    X^{:d}_{nl}&\equiv \partial_d  X_{nl}+\sum_{n'}^A\,D^d_{nn'}X_{n'l}-
%  \sum_{l'}^B\,X_{nl'}D^d_{l'l}
%\end{aligned}
%\eql{gender}
%\eeq
%
 % where the second definition is obtained from the first by
  % exchanging $n,n'\leftrightarrow l,l'$ and $A\leftrightarrow B$.
Note that if $X$ is Hermitian or anti-Hermitian, then $X^{:d}$ has the
same property. It can also be checked that
if $X$ is covariant then $X^{:d}$ is also covariant.

If group $A$ contains a single band $n$ and group $B$ a single band
$l$, we recover the Abelian definition of the covarant derivative
given in Eq~(9) of Ref.~\cite{aversa-prb95},
%
\beq
%X^{;b}_{nl}=\partial_b X_{nl}-i\left(A^b_{nn}-A^b_{ll}\right)X_{nl}\,,
X^{;d}_{nl}= \partial_d X_{nl} -i\left(A^d_{nn}-A^d_{ll}\right)X_{nl}\,,
\eql{gender-abelian}
\eeq
%
where we have written $D^a$ as $-iA^a$ for comparison purposes. To
avoid confusion, we denote the non-Abelian covarant derivative by
$X^{:d}$ and the Abelian one by $X^{;d}$.

Now let $\hat{X}$ be some operator. Then
\bea
X_{nl}^{:d}&\equiv & \me{n}{\hat{X}}{l}^{:d} \nonumber\\ &=&\me{n}{\partial_d\hat{X}}{l} + \me{\partial_d n}{\hat{X}}{l}+ \me{n}{\hat{X}}{\partial_d l} \nonumber\\
& &+\sum_{n''}^{A}D^d_{nn''}X_{n''l} - \sum_{l''}^{B} X_{nl''}D^d_{l''l} ,
\eea
and inserting the a completeness relation \eqref{eq:completeness} we get \eq{gender-Xnl}
Hereinafter  we will use a shortened notation \eqref{eq:operator-coma-derivative}
%\beq
%X^{,d}_{nl}\equiv \me{n}{\partial_d\hat{X}}{l} \eql{operator-coma-derivative}
%\eeq
%
If $n,l\in{\rm all}$ then only the first term survives, and our 
definition of the generalized derivative reduces to Eq.~(34) of Ref.~\cite{ventura-prb17}.
\eq{gender-Xnl} shows off-diagonal ``AB'' blocks of the matrix.
The diagonal block (``AA'') can be derived in a similar way to get \eq{gender-Xnn}
%
%\beq
%X_{nm}^{:d}=X^{,d}_{nm}-\sum_{l'}\out D^d_{nl'}X_{l'm}+\sum_{l'}\out X_{nl'}D^d_{l'm}\eql{gender-Xnn}\,,
%\eeq
%
and the ``BA'' and ``BB'' parts may be obtained by interchanging A and B in equations above.
One special case is the Hamiltonian operator $\hat \Ham$, which is represented by a diagonal matrix. Using $\Ham_{nl}=0$ and
$\Ham^{,d}_{nl}=D^d_{nl}(\varepsilon_l-\varepsilon_n)$ we
find the simple results given by \eq{H-gender}. 
% An obvious
% consequence of the equations above is
%
%\begin{subequations}
%\bea
%\Ham_{nm}^{:d}&=&\Ham_{nm}^{,d}\,,
%\eql{H-gender-in}\\
%\Ham_{nl}^{:d}&=& 0 
%\eea
%\end{subequations}
\tents{Thus we see, that although Hamiltonian is a diagonal matrix, its covariant derivative is only block-diagonal.}

It is important to show some useful properties of the covariant derivative, summarized in \tref{property-cov-der}.
\stm{do we really need a table, if we highlight the rules by subsection titles?}

\textbf{Trace rule.} First of all, in applications we will be interested in taking derivatives of a trace of matrix over subspace A. 
Using \eq{gender}, that can be written as 
\begin{multline}
\partial_d \sum_n X_{nn} = \sum_n \partial_d X_{nn} = \\
\sum_n  X^{:d}_{nn} + \sum_{nn'}^A\,D^d_{nn'}X_{n'n}-
  \sum_{nn'}^A\,X_{nn'}D^d_{n'n}
\end{multline}
and noting that the last to term are the same, upto the sign and interchange of indices $n\leftrightarrow n'$, we arrive at \eq{der-trace}

\textbf{Product rule.} 
Consider two covariant matrices $X_{rs}$ and $Y_{st}$ 
matrices with $r\in C_1$, $s\in C_2$ and $t\in C_3$ (where each subspace $C_i$ 
may independently  be equal to A or B). 
Taking the covariant derivative of their product explicitly we get
%
\begin{multline}
\left(\sum_s^{C_2} X_{rs}Y_{st}\right)^{:d}=\sum_s^{C_2}
\Bigl(  \left(\partial_d X_{rs}\right) Y_{st} +  X_{rs} \partial_d \left(Y_{st}\right)\\
+\sum_{r'}^{C_1} D^d_{rr'}X_{r's} Y_{st}-\sum_{t'}^{C_3} X_{rs} Y_{st'}D_{t't}^d  \Bigr)
\end{multline}
Now, adding and subtracting $\sum_{ss'}^{C_2} X_{rs} D_{ss'}^d  Y_{s't}$ we arrive at \eq{gender-prod-rule}, 
which is similar to the product rule for the simple derivatives. 


\textbf{Chain rule.} 
In some cases equations may contain a scalar-valued smooth function of the electron energies $f(\epsilon_i)$. 
Taking the covariant derivatives of such functions is less intuitive than the product and trace rule. 
To do it correctly, we represent $f$ as a gauge-covariant matrix, 
\begin{equation}
\wt f_{ij} =  \delta_{ij}  f(\epsilon_i)
\end{equation}
This matrix is diagonal, however, its covariant derivative does not have to be diagonal (as we saw for the Hamiltonian in \eq{H-gender}.
Employing a Taylor expansion and a product rule we arrive at \eq{gender-chain-rule}, as shown in  
in Appendix \aref{chain-proof}.










%%% Local Variables:
%%% mode: latex
%%% TeX-master: "pap"
%%% End:
