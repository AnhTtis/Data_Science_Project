\section{Experiment Design for Combinatorial Causal Inference}
\label{sec:experimental_design}
%
In this section, we show how \method~can be used to design experiments that allow for combinatorial inference (i.e., learning all $N \times 2^p$ causal parameters). 

\vspace{2mm}
\noindent \textbf{Key Assumptions Behind Finite Sample Consistency of \method.} \method~requires the existence of a donor set $\mathcal{I}$ such that we are able to perform accurate horizontal regression for all donor units, and then transfer these estimated outcomes to non-donor units via PCR. 
%
The enabling conditions for accurate horizontal regression  are (i) horizontal span inclusion (Assumption \ref{ass:donor_set_identification} (a)), and (ii) incoherence of the Fourier characteristics (Assumption \ref{ass:incoherence}).   
%
Similarly, the critical assumptions required for consistency of PCR are (i) linear span inclusion (Assumption  \ref{ass:donor_set_identification} (b)), and (ii) subspace inclusion (Assumption \ref{ass:rowspace_inclusion}). 
%
In terms of experiment design, these key assumptions suggest that the donor set and treatment assignments must be carefully chosen.
%
To that end, we introduce the following experimental design mechanism. 
%
%For concreteness, we assume that horizontal regression is done via the Lasso, however our experimental design scheme easily applies to the CART estimator. 
%

\vspace{2mm}
\noindent \textbf{Experimental Design Mechanism.} Fix a probability threshold $\gamma \in (0,1)$ and estimation error threshold $\delta \in (0,1)$. Our design mechanism (see Figure \ref{fig:experiment_design_observation_pattern} for a a visual description) then proceeds as follows.

\vspace{1mm}
\noindent
 \emph{Step 1: Donor set selection.} Choose the donor set $\mathcal{I} \subset [N]$ by sampling a subset of units independently and uniformly at random with size satisfying $\Omega\left(r\log(rs/\gamma) \right)$. 

\vspace{1mm}
\noindent 
\emph{Step 2: Donor set treatment assignment.} Sample $\Pi_{\mathcal{I}} \subset \Pi$ combinations independently and uniformly at random with size satisfying $|\Pi_{\mathcal{I}}| = \Omega\left(\frac{r^4s^2\log(|\mathcal{I}|2^p/\gamma)}{\delta^2}\right)$. Assign all donor units $u \in \mathcal{I}$ this set of combinations. 
%

\vspace{1mm}
\noindent
\emph{Step 3: Non-donor unit treatment assignment.} Randomly sample $\Pi_N \subset \Pi$ combinations independently and uniformly at random  of size $|\Pi_N| = 
\Omega\left(r\log(|\mathcal{I}|/\gamma) \vee r^4/\delta^4 \vee |\mathcal{I}|\right)$. Assign all non-donor units $n \in [N] \setminus \mathcal{I}$ combinations $\Pi_N$. 
%

\vspace{1mm}
\noindent
\emph{Potential outcome estimation.} Given the observation pattern described above, estimate outcomes for each unit-combination pair via \method~as described in Section \ref{sec:estimator_descripton}. 
\vspace{0.5mm}
%

\noindent We show that our design mechanism satisfies the key assumptions presented above with high probability. 
%
In fact, we show our proposed mechanism ensures these key conditions hold under very limited assumptions.
%
In particular, we only require that: (i) our potential outcome model is satisfied (Assumption \ref{ass:observation_model}), (ii) there is selection on Fourier coefficients (Assumption \ref{ass:selection_on_fourier}), (iii) $\E[Y_n^{(\pi)}]$ is bounded (Assumption \ref{ass:boundedness_potential_outcome}). 
%
Additionally, we only need a weakened version of balanced spectrum condition (Assumption \ref{ass:balanced_spectrum}):
%
\begin{assumption} [Restricted Balanced Spectrum] 
\label{ass:restricted_balanced_spectrum}
%
Let $s_{1} \ldots s_{r}$ denote the non-zero singular values of $\E[\bY_N^{(\Pi)}]$. 
%
Assume that its singular values are well-balanced, i.e., for universal constants  $c,c' > 0$, we have that $s_{r}/s_{1} \geq c$, and $\lVert E[\bY^{(\Pi)}_{N} ~ | ~ \mathcal{A} ]\rVert^2_F \geq c'N2^p$
%
\end{assumption}
%
\noindent As compared to the original balanced spectrum condition, Assumption \ref{ass:restricted_balanced_spectrum} only requires that the singular values are balanced for the entire potential outcome matrix as opposed to a collection of submatrices. 
%
Additionally, the condition $\lVert E[\bY^{(\Pi)}_{N} ~ | ~ \mathcal{A} ]\rVert^2_F \geq c'N2^p$ is mild and is equivalent to requiring that $\min_{n \in [N]} \lVert \balpha_n \rVert_2 \geq c'$. 
%
Given the discussion on the assumptions required, we now present our results.  
%
\begin{theorem} 
\label{thm:experiment_design_assumptions_hold}
Let Assumptions \ref{ass:observation_model}, \ref{ass:selection_on_fourier}, \ref{ass:boundedness_potential_outcome}, and \ref{ass:restricted_balanced_spectrum} hold. Then, the proposed experimental design mechanism satisfies the following conditions simultaneously with probability at least $1 - \gamma$: 
%
(i) horizontal and linear span inclusion (Assumption \ref{ass:donor_set_identification}), 
%
(ii) incoherence of donor unit Fourier characteristics (Assumption \ref{ass:incoherence}), and subspace inclusion (Assumption \ref{ass:rowspace_inclusion}).
%
\end{theorem}
%
\begin{corollary} 
\label{cor:experimental_design_error_rate}
Let the set-up of Theorem \ref{thm:experiment_design_assumptions_hold} hold. Then, for every unit-combination pair $(n,\pi)$, we have $|\E[Y_n^{(\pi)}] - \hat{\E}[Y^{(\pi)}_n]| = \Tilde{O}_p (\delta)$.  
\end{corollary}
%
\noindent  Theorem \ref{thm:experiment_design_assumptions_hold}  implies that the key enabling conditions for \method~are satisfied for every unit-combination pair $(n,\pi)$. 
%
That is, the required assumptions on the observation pattern for meaningful estimation of the entire potential outcome matrix $\E[\bY_N^{(\Pi)}]$ are met.
%
As a result, Corollary \ref{cor:experimental_design_error_rate} shows that we can achieve $O(\delta)$ error for all $N \times 2^p$ causal parameters.  
%
In contrast, our results in the observational setting do not guarantee we can accurately estimate {\em all} $N \times 2^p$ parameters; instead, they show we can learn $\E[Y_n^{(\pi)}]$ for any specific unit-combination pair $(n,\pi)$ that satisfy the required assumptions on the observation pattern. 
%
Additionally, given the discussion in Section \ref{subsec:sample_complexity_synth_combo}, one can verify that the number of experiments required by our design mechanism scales as $\tilde{O}\left(\text{poly}(r/\delta)\times \left(N + s^2p \right) \right)$. 

\begin{figure}[htbp]
    \centering
    \includegraphics [width = 0.9\textwidth]{figures/experiment_design_figure_paper.pdf}
    \caption{Observation pattern induced by experiment design mechanism. }
    \label{fig:experiment_design_observation_pattern}
\end{figure}

%Step 1 and 2 shows the selection of the donor set and treatment assignments respectively. Step 3 shows the treatments assigned to non-donor units. 