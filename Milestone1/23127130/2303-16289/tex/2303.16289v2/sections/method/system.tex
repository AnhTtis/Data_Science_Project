This section starts with an introduction to the case followed by an overview of the heating system and electrics before delving into the control retro-fit. The relevant signals are listed in Table~\ref{table_relevant_signals}.
\subsection{Case study}
\label{sec_test_house}
The case is a \SI{230}{\meter\squared}, two-story \singleFam\ house from 2018; see \figref{fig_blueprint}. According to the Danish building regulation, it is classified as a low energy class building (BR2020), which, among other requirements, implies a maximum annual heat demand of \SI{20}{\kilo\watt\hour\per\meter\squared} \cite{br18}. It is located on Sj√¶lland (Zealand) in Denmark, with a south view over the sea. A south facing photovoltaic system is placed on the roof with a measured peak output of \SI{4}{\kilo\watt} in end of December and \SI{5.5}{\kilo\watt} in June. Space heating and domestic hot water is provided by a \textit{Bosch Compress 6000AW} (air-to-water) heat pump with a nominal capacity of \SI{7}{\kilo\watt}. Domestic hot water takes priority over space heating. Based on measured data the nominal electric consumption ranges from \SI{200}{\watt} to \SI{2500}{\watt}. Floor heating, embedded in concrete, is installed throughout the house. The floor heating system is controlled by a Wavin controller and consists of 15 circuits delivering heat to 11 heating zones. Each zone has one thermostat assigned, meaning that if more circuits are supplying the same zone all valves in the particular zone opens when heat is requested. The circuits are ON/OFF controlled based on deviations from the temperature reference provided for each zone. The heat pump is controlled by an ambient temperature compensated heat curve. The household has a variable electricity price contract, which is based on the \nordpool\ market spot-price.
\newcommand{\tablePercOne}{0.24}
\begin{table}[H]
\centering
\caption{Relevant signals}
\begin{tabular}{p{0.14\linewidth} p{0.1\columnwidth} 
p{0.57\columnwidth}}
\toprule[1.5pt]
Variable  & Unit & Description \\ %[0.5ex] 
\midrule[1.5pt]
 $\dotQhp$ & $[\si{\watt}]$ & Heat flow output from \hp \\
 $\Qhp$ & $[\kwh]$ & Heat output from \hp \\ 
 $\Php$ & $[\si{\watt}]$ & Electric power input to \hp \\
 $\Ehp$ & $[\kwh]$ & Electric energy input to \hp \\
 $\Ppv$ & $[\si{\watt}]$ & Electric power output from photovoltaic \\
 $\Pg$ & $[\si{\watt}]$ & Electric power from grid \\
 $\Papp$ & $[\si{\watt}]$ & Household electric power consumption \\
 $\TR$ & $[\si{\degreeCelsius}]$ & Return temperature to \hp \\
  $\TRi{i}$ & $[\si{\degreeCelsius}]$ & Return Temperature from \fh\ circuit $i$ \\
    $\Tri{j}$ & $[\si{\degreeCelsius}]$ & Air temperature in room $j$ \\
    $\Trefi{j}$ & $[\si{\degreeCelsius}]$ & Reference temp. in room $j$ \\
    $\Tfi{j}$ & $[\si{\degreeCelsius}]$ & Estimated floor temperature in room $j$ \\
    $\val_{i}$ & $[\si{\degreeCelsius}]$ & ON/OFF Valve setting for circuit $i$ \\
    $\flow$ & $[\si{\kilogram\per\second}]$ & Total flow into the \fh\ system \\
    $\Volta$ & $[\si{\volt}]$ & Output voltage from ambient temperature sensor \\
\bottomrule[1.5pt]
\end{tabular}
\label{table_relevant_signals}
\end{table}
\begin{figure}[h]
	\centering
	\includegraphics[width=.75\columnwidth]{figs/blueprint_2.pdf}
	\label{fig_blueprint}
	\caption{Blueprint of the floor plan with area distribution. Blue numbers indicate the number of \fh\ circuits in each zone. Red circles show the presence of a room thermostat.}
\end{figure}
\subsection{Heating system}
\figref{fig_system_diagram} shows the heating system with associated signals. %Note that flow to the floor heating $\flow$ system together with forward $\TF$ and return $\TR$ temperatures are measured meaning 
Note that heat flow to the floor heating system, \dotQhp, and electric power consumption of the heat pump, \Php, are measured.
\begin{figure}[H]
	\centering
	\includegraphics[width=1\columnwidth]{figs/diagram_fh_colors_narrow_hp_4.pdf}
	\caption{The diagram of the heating system in the house. The colors represent the kind of signal: red for measured variables, green for control inputs and black for estimated variables. Pipes on warm side are red and cold side blue.}
        \label{fig_system_diagram}
\end{figure}
The \hp\ feeds the floor heating system with water, which in turn deliver the heat to the heating zones.
\subsection{Electricity}
The household electric grid is shown in Figure \ref{fig_elec_diagram}. The main units are photovoltaic panels and the heat pump which have separate electricity meters. The other household appliances are aggregated into an unknown disturbance.% while the heat pump power consumption can be indirectly controlled by controlling the heat production.% The grid balances the energy balance
\begin{figure}[H]
	\centering
	\includegraphics[width=0.92\columnwidth]{figs/diagram_electrics_w_energy_balance_big.pdf}
	\caption{The internal electricity grid of the house expressed in power. Red variables are measured quantities.}
 	\label{fig_elec_diagram}
\end{figure}
\input{sections/method/hardware.tex}
\subsection{Object oriented description of commercial domestic heat pump}
\label{sec_hp_object}
%This section presents eight common (not a given) properties of commercial \atow\ heat pumps with modulating compressor.
In this section common properties for commercial \atow\ \hp's are listed together with references to how they are modelled in the literature.
\begin{enumerate}
\item \textbf{ON/OFF indicator}: the \hp\ turns off when heat demand is absent. In this work the indicator variable $\deltahp \in \{0,1\}$ is one when the \hp\ is ON and zero if OFF \cite{lee_mixed-integer_2019, mayer_management_2015}.
\item \textbf{Minimum load:} the minimum load and operation range of a variable speed \hp\ is often considered and modelled as a set $\Php \in \{0\}\cup [\Phpmin, \Phpmax]$ \cite{kuboth_economic_2019,lee_mixed-integer_2019, maier_assessing_2022}.
%The variable speed compressor operates poorly at speeds below a certain level. Hence, it is common to restrict the compressor from working in a certain range between 0 (Off mode) and a defined lower limit. This effect is here described as a lower electrical power limit \Phpmin. The compressor input power is upper limited as well to \Phpmax. The operational range can be summed up as $\Php \in \{0\}\cup [\Phpmin, \Phpmax]$, with \Php\ being the electricity input. This property is modelled in \cite{kuboth_economic_2019,lee_mixed-integer_2019, maier_assessing_2022}.
\item \textbf{Coefficient of performance:} the coefficient of performance (\cop) is the ratio between the produced heat and consumed input energy (here electricity). It is often modelled as a static function, $\fhp: \mathbb{R} \to \mathbb{R}$.
\item \textbf{Down-time:} to avoid start-up cycling some \hp s feature a (sometimes adaptive) down-time period measured in hours. To incorporate this a model for minimum up- and down-time can be included \cite{mayer_management_2015, lohr_mpc_2021}.
%Heat pumps that do not receive information on the actual heat demand need to start up to assess the situation. If the heat demand is absent the heat pump will shut down again as soon as this is established. To avoid too many unnecessary start-ups, an adaptable down-time period, spanning several hours, is often built in. The authors of \cite{kuboth_economic_2019} compare a centralized \MPC\ with two distributed \MPC\ algorithms applied to a single-family house with battery (BAT), \pv\ and \hp.
\item \textbf{Limit on rate off change:} the internal controllers of a domestic \hp\ sometimes prevent it from changing state too rapidly.
\item \textbf{Domestic hot water production:} the \hp\ switches between providing space heat and domestic hot water. Domestic hot water is often prioritized.
\item \textbf{Discrete compressor speed steps:} the compressor speed is often operated at certain steps rather than continuous action. Some speeds are excluded as resonance with the casing can cause noise.
\item \textbf{Low pass filter on ambient temperature signal:} it is common practice that commercial \hp s apply a low pass filter to the ambient temperature signal before it is provided to the internal controllers.
\item \textbf{Defrosting:} an \atow\ \hp\ needs to defrost the evaporator regularly in order to function properly. This event is treated as a random process which takes priority.
\end{enumerate}
It is desirable that any \MPC\ operating an \hp\ can handle the listed properties.