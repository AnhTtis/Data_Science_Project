\section{Introduction}
A fast and determined transition to a carbon neutral economy is more urgent than ever.
%The race is on for carbon neutrality (decarbonization if needed) before the effects of accumulated green-house gases in the atmosphere triggers all kinds of self-amplifying non-linear heating effects such as methane released into the atmosphere from melting permafrost, diminishing reflective surfaces in the polar regions and forest fires. The consensus is, losing this race means dire consequences covering droughts, floods, cities swollen by the sea and above all conflicts and wars over ever scarcer resources. 
The summary for policy makers associated with the $6^{th}$ annual report from \ipcc\ reads: \textit{"All global modelled pathways that limit warming to $1.5^{\circ}C (>50\%)$ with no or limited overshoot, and those that limit warming to $2^\circ C (>67\%)$ involve rapid and deep and in most cases immediate [Green house gas]}  \textit{emission reductions in all sectors"} \cite{ipcc6_wg3}. This means that not only long term solutions, but also existing solutions need to be implemented, immediately. Space heating is major energy consumer with potential for large reductions both short and long term. %Buildings come in varies sizes, from large office buildings to significantly smaller detached \singleFam\ houses.
The focus here is on \singleFam\ houses, since they pose a particular grand challenge for the overall savings potential in the space heating sector. \SingleFam\ houses are small but many in numbers, meaning that they make up a large share of the sector. Estimates indicate that about 55\% of Danish heated area belongs to \singleFam\ houses \cite{danish_energy_agency_data_nodate}. Further complicating the issue is that a majority of the \singleFam\ houses are owned by the residents themselves \citenum{statistics_denmark_boligbestanden_2021}. This is not bad in itself---self-ownership has many socioeconomic benefits---but it does mean that any solution introduced to a \singleFam\ house has to be highly cost-beneficial in order to get the individual owners to invest in energy upgrades. A popular investment, seen across the \eu, is to acquire a heat pump (\hp). In the period 2005 to 2020, sales increased from about 0.5 mill. to 1.62 mill units sold with air-sourced being the most popular type \cite{heat_pump_market}. The rise in heat pumps is only one factor in an increasingly electrified economy, which starts to put strain on the electric grid with peak loads threatening stability and capacity. % Especially peak demand periods provide a challenge to the network providers.
% A low-cost way to improve the system is to retrofit with actuators and sensors and use them to operate the system more efficiently. Further,  %Improvements can either be a physical upgrade of the system or to change the way the existing system is controlled. In this work the focus is on the controller.
%In other cases the incentive comes from a change in the environment, which is 
In Denmark the response is a new network tariff model for electricity, \textit{tarifmodel 3.0}, which was introduced on the $1^{\text{st}}$ of January, 2023 \cite{tarifmodel3}. This model allows the DSO(grid)-operators to differentiate the end-user tariffs substantially over the course of the day in order to nudge the end-user into changing their consumption away from peak load periods and increase demand at night. This situation also impacts households heated by an electric heat pump who, although having some tax-benefits, still have to pay the full grid-tariffs. In other words, the owners need to change their heating habits or face the cost of heating in expensive periods. Many danish households are already on a time-varying price which is based on the \nordpool\ hourly spot-market and time-of-use distribution prices. Adding the two price schemes together means that the difference between high and low prices within a day can be several times larger than the lower price, as seen in \figref{fig_price}. This can create some very costly situations, but also opportunities for cost savings. 
\begin{figure}[h]
	\centering
	\includegraphics[width=0.925\columnwidth]{figs/prices.pdf}
	\label{fig_price}
	\caption{\figUpper The Nord Pool market spot price plotted together with the Danish tariff Model 3.0. The price model is used for the economical evaluation of the experiment. \figLower The normalized ($x_i/\max(x)$) daily price development of the price model.}
\end{figure}
\vspace{-1mm}
One such opportunity is to utilize a price-aware controller to load shift by boosting heat production (charge) in low cost periods and decrease (discharge) in high cost periods either with help of an energy storage \cite{kelly_performance_2014, bechtel_influence_2020} or directly using the thermal mass of the building itself \cite{amato_dual-zone_2023, sanchez_ramos_potential_2019, hu_price-responsive_2019}. A variable-speed heat pump can be used to boost heat by increasing the compressor speed, but this comes with a significant loss of efficiency (\textit{coefficient of performance}, \cop). Further, the \cop\ of an \atow\ \hp\ is highly dependent on ambient temperature, which means that not only price but also weather factors need to be considered as well.

A method suitable for automating heat \loadshifting\ is \mpc\ (\MPC) \cite{amato_dual-zone_2023}. During the last 30 years, \MPC\ has been studied extensively in the context of building control due to its structural ability to integrate building dynamics, heating system and environmental aspects into an \ocp\ (\OCP) formulation capable of handling both constraints and discrete states. A range of different versions of \MPC\ have been suggested: Deterministic \MPC, Stochastic \MPC, Robust \MPC, Learning \MPC, Offset-free \MPC, Implicit \MPC\ and Explicit \MPC\ \cite{drgona_all_2020}. While the studies are numerous, the method has so far failed to make a broad impact on the space heating sector. The reported reasons are installation costs of sensor and actuators, model development costs \cite{sturzenegger_model_2016} and user-acceptance.

Although the number of long term (beyond 30 days) building scale demonstrations are few compared to simulation studies, a selection of noteworthy examples do exist. In \cite{sturzenegger_model_2016} %a Thermal Activated Building System and a central Air Handling Unit plus automated window blinds was used to control 
a 6000 \si{\meter\squared}, occupied office building in Switzerland both in periods during winter and summer which combined into about 30 weeks of testing. While reporting that the control itself was a success, the author questions whether the method is mature enough to be implemented in similar buildings. In \cite{de_coninck_practical_2016} two heat pumps and a gas boiler were controlled in a 960 \si{\meter\squared} occupied office building in Brussels during the winter of 2014-2015 reporting cost savings of 30\% while improving comfort. In Halifax, Canada, a 10000 \si{\meter\squared} university building was controlled using \MPC\ for four months with reported savings of 29\% electricity and 63\% heat \cite{hilliard_experimental_2017}. In the category \singleFam\ houses, \cite{pedersen_central_2013} controlled four houses for 5 months and reported an average cost reduction of 9\% when compared to 7 benchmark houses and in \cite{muller_large-scale_2019} \hp s in 300 homes were ON/OFF throttled to reduce peak loads.  The low number of residential experiments is likely due to the low potential for savings, which disqualifies large implementation costs. The requirement for simple solutions have spurred a branch of low-complexity\footnote{Low-complexity is meant as relative to solutions where the heat consumption of each heating zone is known.} \MPC\ e.g. with only one central heat meter as in \cite{amato_dual-zone_2023}. Recent studies \cite{amato_dual-zone_2023, vogler-finck_inverse_2019} have demonstrated the basic feasibility of such schemes, but both studies point out that longer evaluation periods are needed to reliably verify their practical usefulness. Furthermore, occupancy in \singleFam\ houses is a fundamentally different condition from office buildings due to the invasive nature of sensor feedback on the occupants´ behavior, which must also be addressed.


%As it is meaningful to study the efficiencies and properties of advanced \MPC\ algorithms it is occasionally worthwhile to ask what a simpler version can do in the field.
%Our contribution is long term study \todo{length} of an \MPC\ controller operating on a real occupied \singleFam\ house.
Our contribution in this paper is a \textit{\numTestDays\ day long} study demonstrating a price responsive, low-complexity, hierarchical Mixed-Integer \MPC\ control scheme on an \textit{occupied} \singleFam\ house featuring an \atow\ heat pump and floor heating (\fh). The controller is designed to minimize costs by shifting heating loads according to the electricity price signal together with other predictable and/or measurable factors. The controller is developed as a comparably low-complexity solution which only makes use of an internet connected control unit, a central heat meter, electricity meters, and room thermostats. Further, the weather forecast is provided by a weather service and the model is a single zone model which is based on a weighted average room temperature for the entire house. The controller is deliberately designed not to make use of explicit occupancy information, in order to protect the occupants´ right to privacy. The main findings from the experiment are: the near zero emission house demonstrated a high level of flexibility with respect to time-of-heating. Further, it is possible to boost the floors with heat during intensive sun radiation periods (when there is plenty of own-produced PV electricity) without further deteriorating the comfort. Controlling the upper layer using an area weighted average building temperature has shown to be unproblematic with respect to comfort in the test house. 
%The study revealed/confirmed several aspects which have been assumed in other studies but not demonstrated yet. First, the near zero emission house demonstrated a high level of flexibility with respect to time-of-heating. Further, against common practice, the controller consistently heated the floors of the house during periods with high sun irradiation, thereby utilizing self-produced solar power. without further deteriorating the comfort.

%First the controller showed a 1.5\% expenses reduction when compared to the standard weather compensated heat pump control. Although, the reduction is not remarkable, the experiment shed light on reason to why it is lower than otherwise reported in other studies. First, as proposed in \cite{amato_dual-zone_2023, vogler-finck_inverse_2019}, controlling the upper layer with respect to a area weighted average building temperature has shown to be unproblematic with respect to comfort in the test house. The near zero emission house demonstrated a high level of flexibility with respect to time-of-heating. The controller consistently heated the floors of the house during periods with high sun irradiation, thereby using self-produced solar power, without further deteriorating the comfort.
%The controller is dependent on a low set of controllers 
%Including a heat pump into \MPC\ means modelling the relationship between input (electricity) and output (Heat). The efficiency of the \atow\ \hp\ is highly dependent on ambient temperature, compressor speed, return temperature \cite{rastegarpour_experimental_2019}. Regardless of whether the model is static or dynamic, accounting for all these factors makes the \OCP\ non-linear and in many cases intractable. The question is then: \textit{what is the optimal trade off between model accuracy (good economic decisions) and computational complexity (intractability)?} In \cite{verhelst_study_2012} the authors conclude that simplified linear versions of the \cop, compared to non-linear versions, lead to inefficient control unless heat power peaks are penalised in the cost function. In \cite{satyavada_integrated_2016} the models the efficiency using a second-order polynomial which include all combinations of the inputs: compressor frequency, return and ambient temperature. %The return temperature is difficult to obtain since it depends on the dynamics of either the radiators, floor heating or heat storage. Many papers leave out the return temperature to avoid the complication but 

%To include discrete states the \MPC\ framework can be formulated using a Mixed-Integer \OCP. This is a common approach for the heat pump model and broader heating system. Adding integers creates a combinatorial problem which is difficult to solve fast. Building models tend to add many discrete states making the solving time too long to solve directly, therefore different strategies to mitigate this are applied. The authors of \cite{lohr_machine_2020} bypasses the combinatorial problem by pre-training a neural network/support vector machine to approximate the binary components for thereafter solving the quadratic programming problem with the binary values fixed according to the approximation obtained from the machine learning method.

%As mentioned, the literature on simulation studies of \MPC applied to buildings is extensive. The review in

%More rare are real experiments testing the reported value of the algorithms in actual buildings.

% The lack of real implementations are being accredited to lack of quality data, mo
% \begin{itemize}
%     \item data
%     \item modelling
%     \item communications infrastructure
%     \item costs
% \end{itemize}
% %integrate varies energy assets (photovoltaic panels, \hp, energy storage, floor heating, radiators, etc.) and environmental conditions (energy prices, weather, occupant behavior, etc.) into a constrained central control scheme. Many energy assets feature discrete states which have to be delved with. A common way to handle the discrete states is by employing Mixed-Integer optimization problems.
% \begin{itemize}
%     \item STOP
% \end{itemize}



%One answer to this is an integrating heating controller, which can shift the heating to periods with low electricity prices by utilizing the inherent heat flexibility of the building. In the literature numerous such solutions have been suggested for \spaceHeating\ control for \singleFam\ houses. 
%A subgroup of these are \mpc\ based on Mixed-Integer optimization problems, which is the focus of this paper.

 %Although Mixed-Integer problems become combinatorial nightmares, when many integer valued variables are used, human designed systems often feature all kinds of discrete behaviors which, in many cases, can be modelled quite accurately. In this light, it is therefor, of course, desirable to incorporate this knowledge into the control strategy, and if the number of integer variables are kept reasonably low and chosen with care, and the relaxed version (integer variables replaced by continuous spanning the same range) of the optimization problem is kept convex and quadratic, existing solvers can solve a large range of problems within the time constraints posed by building control.
%In \cite{lee_mixed-integer_2019} several strategies involving a \hp\ and a thermal energy storage (TES) compares \MIMPC\ to convex formulations of the coefficient of performance (\cop) of the \hp. The authors of \cite{lohr_machine_2020} bypasses the combinatorial problem by pre-training a neural network/support vector machine to approximate the binary components for thereafter solving the quadratic programming problem with the binary values fixed according to the approximation obtained from the machine learning method.

%Another crucial component when considering the \OCP\ is the heat pump and the related \cop. It is no secret that the efficiency of the air-to-water heat pump is highly dependent on ambient temperature, compressor speed, forward temperature, water flow and so on. Regardless of whether the model is static or dynamic, accounting for all these factors makes the \OCP\ highly non-linear and in many cases intractable. The question is then: \textit{what is the optimal trade off between model accuracy and computational complexity?} On one hand, accuracy implies better economical decisions but complexity might render the decisions unattainable. On the other, simplicity provides easy solutions that might lead to poor economical decisions. In \cite{verhelst_study_2012} the authors conclude that simplified linear versions of the \cop, compared to non-linear versions, lead to inefficient control unless heat power peaks are penalised in the cost function.\\\\
%Lately, many studies have focused on adding a \tes\ (\TES) or \bess\ (\BESS) to increase the heating flexibility. In \cite{bunning_robust_2022} the authors uses a \hp and a \TES, where the average temperature is modelled, to provide flexibility services to the electricity market. The test house, included in this study, has neither a \TES\ or \BESS\ but still shows a high degree of flexibility with regard to self consumption.\\\\
%This being the platform on which this work is carried out, the paper focuses on the challenges and methods related to the realization of online \textit{\mimpc} (\MIMPC) implemented on a real house occupied by its residents. The controller is retrofitted to an air-to-water heat pump in combination with floor heating. The retrofit kit enables control of the valves in the floor heating system and heat produced from the heat pump. The discrete parts of the house, which are modelled as binary states, are the heat pump (\hp) and the ON/OFF control valves in the floor heating (\fh) system.
%Our contribution here is sharing the knowledge gained from the implementing the controller in a real single-family house. Five questions are in focus: (1) \textit{What are the potential percentage and monetary savings}, (2) \questionTwo\ (3) \questionThree\ , (4) \questionFour\ and (5) \questionFive 

The layout for the rest of the paper is as follows. Section \ref{sec_system} presents the case, an overview of the heating side and the electrical side viewed from a control perspective. Section \ref{sec_control_strategy} presents the hierarchical control strategy, starting with the supervisory controller and followed by the mid-level controllers. Section \ref{sec_model} contains the models used in the paper. Section \ref{sec_experiment} describes the experiment before the results are presented in Section \ref{sec_results}. As the results are based on real data, Section \ref{sec_result_interpret} is dedicated to the authors' interpretation of the results. Finally, a common discussion section followed by conclusion in Sections \ref{sec_discussion} and \ref{sec_conclusion}, respectively.
\input{sections/introduction/test_house}
%In contrast to nature, where many systems develop gradually, human build systems tend to feature all kinds of discrete behavior, and these behaviors to be known quite well. It is therefor of course a desire to incorporate this knowledge into the control strategy.

%It is therefor of course desirable to be able to incorporate such behavior 

%As systems grow more flexible Multiple reasons for phasing climate instability 

%The single family house pose a particular grand challenge for this vision due since the unit is small and often owned by the residents themselves.
