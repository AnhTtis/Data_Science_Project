\section{Example Usage}
\label{sec:usage}

In the following, we show how the new features in \HEJ~2.2 can be used
in practice. For concreteness, we will generate
leading-order events with \textsc{Sherpa}~2.2 and analyse the output with \textsc{Rivet}~3~\cite{Bierlich:2019rhm}. However, we stress that any leading-order
generator that can produce event files in the LHEF
format~\cite{Alwall:2006yp} is supported. In addition to the direct
\textsc{Rivet} interface, \HEJ can write its output to event files in
various formats and allows arbitrary custom analyses via
plugins. Since these options are not new, we refer to the \HEJ
documentation on \url{https://hej.hepforge.org} for details.

\subsection{Same-sign W pair production with jets}
\label{sec:example_WW}

We first consider the process
$pp \to (W^- \to e \bar{\nu}_e) (W^- \to \mu \bar{\nu}_\mu) + \geq 2$
jets with the parameters shown in table~\ref{tab:WW_param}.
$H_T = p_{e\perp} + p_{\bar{\nu}_e\perp} + p_{\mu\perp} +
p_{\bar{\nu}_\mu\perp} + \sum_{i=1}^n p_{i\perp}$ is the sum of the
scalar transverse momenta of all outgoing particles.
\begin{table}[htb]
  \centering
  \renewcommand{\arraystretch}{1.1}
  \begin{tabular}{lp{5mm}l}
    \toprule
    Collider energy && $\sqrt{s} = 13$\,TeV\\[.3em]
    Scales && $\mu_r = \mu_f = \frac{H_T}{2}$\\[.3em]
    PDF set && CT14nlo\\[.3em]
    Electroweak input parameters && $\alpha = 1/132.3572$\\
                    && $m_W = 80.385$\,GeV\\
                    && $\Gamma_W = 2.085$\,GeV\\
                    && $m_Z = 91.1876$\,GeV\\
                    && $\Gamma_Z = 2.4952$\,GeV\\[.3em]
    Jet definition && anti-$k_t$~\cite{Cacciari:2008gp} \\
                    && $R = 0.4$ \\
                    && $p_\perp > 20$\,GeV\\
    \bottomrule
  \end{tabular}
  \caption{Parameters for the production of multiple jets together with a same-sign W boson pair decaying to charged leptons and neutrinos.}
  \label{tab:WW_param}
\end{table}

\subsubsection{Generating leading-order input}
\label{sec:input_WW}

To produce the required leading-order input, we can use \textsc{Sherpa} with the following runcard.
\lstinputlisting[language=sherpa,title=\texttt{Run.dat}]{examples/WW/Run.dat}
The various settings are explained in more detail in the
\textsc{Sherpa} manual. Since \HEJ treats all quarks as massless, we
have to set the charm and bottom quark masses to zero for
consistency. As explained in section~\ref{sec:low_pt}, leading-order
events containing particles with transverse momenta below the analysis
cuts can still contribute to the resummed prediction. For this reason,
we accept jets with transverse momenta as low as 15\,GeV, despite
having an analysis cut of 20\,GeV. In section~\ref{sec:low_pt_ex}, we
will discuss a computationally more efficient way to incorporate this
contribution from leading-order events that do not pass the analysis
transverse momentum cuts.

We can now generate input events for the case of two jets by running
\begin{lstlisting}[language=sh]
Sherpa
\end{lstlisting}
in the directory containing \texttt{Run.dat}. With the \textsc{Sherpa}
2.2.15 installation inside the \HEJ Docker image this yields a cross
section of $(1.88795 \pm 0.109611)\,$fb. Results may differ between
versions and when re-using integration grids from previous
\textsc{Sherpa} runs. We should then also produce event files for
higher jet multiplicities after adjusting the
\lstinline!EVENT_OUTPUT!, \lstinline!Process!, and
\lstinline!FastjetFinder! entries in \texttt{Run.dat}. Increasing the
number of jets to three leads to a cross section of
$(1.47689 \pm 0.10331)\,$fb.

To avoid the creation of large intermediate event files, we can use
named pipes instead, i.e.~we run \textsc{Sherpa} with
\begin{lstlisting}[language=sh]
mkfifo events_WW2j.lhe
Sherpa &
\end{lstlisting}
Previous \HEJ versions only accepted input from pipes if the total
cross section was equal to the sum of event weights, which is not the
case for \textsc{Sherpa} event files. This restriction is lifted in the new
version $2.2$, which removes a potential bottleneck in time and storage.

\subsubsection{\HEJ resummation}
\label{sec:resum_WW}

In addition to the leading-order event input, \HEJ needs a
configuration file. Adapting the template \texttt{config.yml}
distributed with the \HEJ source code to the parameters listed in
table~\ref{tab:WW_param} we get
\lstinputlisting[language=yaml,title=\texttt{config\_WWjets.yml}]{examples/WW/config_WWjets.yml}
Here, we choose to pass the resummed events directly to the
\textsc{Rivet} analyses\footnote{The   \texttt{MC\_WWINC} and \texttt{MC\_WWJETS} analyses are written for opposite-sign W boson pair production but can also be used for same-sign W boson pairs.} \texttt{MC\_WWINC} and \texttt{MC\_WWJETS}. Using the Docker
virtualisation software, we can run \HEJ~\cite{docker} with the
following command.
\begin{lstlisting}[language=sh]
docker run -v $PWD:$PWD -w $PWD hejdock/hej HEJ config_WWjets.yml events_WW2j.lhe
\end{lstlisting}
Alternatively, after compiling and installing \HEJ and its dependencies we can use
\begin{lstlisting}[language=sh]
HEJ config_WWjets.yml events_WW2j.lhe
\end{lstlisting}
\HEJ outputs a cross section of $(1.094 \pm 0.06614)\,$fb.
It also produces the \textsc{Rivet} analysis output file
\texttt{WW2j.yoda}. We produce resummed predictions for the
higher-multiplicity event files \texttt{events\_WWnj.lhe} in the same
way, after changing the \lstinline!analyses! entry in
\texttt{config\_WWjets.yml} to
\begin{lstlisting}[language=yaml]
analyses:
  - rivet: [MC_WWINC, MC_WWJETS]
    output: WWnj
\end{lstlisting}
and adjusting the event file name when running \HEJ. To guarantee
statistically independent output, it is also recommended to change the
\lstinline!seed! entry for each run. If we nonetheless use the default
seed with the previously generated event file
\texttt{events\_WW3j.lhe} we obtain a cross section of $(0.905 \pm 0.07534)\,$fb.

We then combine the results for the different jet multiplicities with
\begin{lstlisting}[language=sh]
yodastack -o WWjets.yoda WW*j.yoda
\end{lstlisting}
and produce plots with
\begin{lstlisting}[language=sh]
rivet-mkhtml WWjets.yoda
\end{lstlisting}
As examples, we show the inclusive jet multiplicities and the
distribution of the rapidity difference between the two W bosons
obtained from resumming fixed-order predictions with two and three
jets in figure~\ref{fig:distr}. In contrast to the recommended usage,
we have not modified the random number generator seeds between runs in
order to facilitate reproducing this figure.\footnote{We have slightly
  changed the plot ranges compared to the default
  \texttt{rivet-mkhtml} settings.} We observe that the bulk of the
events does not pass the analysis cuts.
\begin{figure}[htb]
  \centering
  \includegraphics[width=0.47\linewidth]{examples/WW/jet_multi_inclusive}
  \includegraphics[width=0.47\linewidth]{examples/WW/WW_deta}
  \caption{%
    Inclusive $N$-jet cross sections (left) and rapidity difference
    between the two W bosons (right) obtained with \textsc{Sherpa} and
    \HEJ 2.2 for the production of two leptonically decaying W$^-$ bosons
    with at least two jets.
  }
  \label{fig:distr}
\end{figure}

\subsubsection{Dedicated low transverse momentum runs}
\label{sec:low_pt_ex}

So far, we have generated the leading-order events with significantly
looser transverse momentum cuts than wanted for the final analysis. As
argued in section~\ref{sec:low_pt}, it is more efficient to
split the generation into a high-statistics run with the strict cuts
used in the final analysis and a low-statistics run with loose cuts
where in each leading-order event there is at least one particle that
does not pass the final cuts. For the jet transverse momentum cuts,
this separation is facilitated by a new option in \HEJ 2.2 which
ensures the presence of at least one ``soft'' jet in the input for the
low-statistics run. Note that this option only refers to jets; any
other particles should be generated according to the loose transverse
momentum cuts in both samples.

In detail, one should go through the following steps for the present
example of same-sign W pair production with jets:
\begin{enumerate}
\item Generate the high-statistics sample.
\begin{enumerate}
  \item Change the minimum transverse momentum in the \lstinline!FastjetFinder! entry in \texttt{Run.dat} from 15 to 20.
  \item Correspondingly, change
\begin{lstlisting}[language=yaml]
fixed order jets:
  min pt: 15
\end{lstlisting}
    to
\begin{lstlisting}[language=yaml]
fixed order jets:
  min pt: 20
\end{lstlisting}
    in \texttt{config\_WWjets.yml}
  \item Run \textsc{Sherpa} and \HEJ as before.
  \item Revert the changes to both configuration files.
  \end{enumerate}
\item Generate the low-statistics sample.
  \begin{enumerate}
  \item Reduce the number of events generated by Sherpa, for example
by setting the \lstinline!EVENTS! entry in \texttt{Run.dat} to 1000.
  \item Add the entry
\begin{lstlisting}[language=yaml]
require low pt jet: true
\end{lstlisting}
to \texttt{config\_WWjets.yml}.
\item In the \lstinline!event treatment! entry in \texttt{config\_WWjets.yml},
  change all \lstinline!keep! values to \lstinline!discard!. Specifically, change
\begin{lstlisting}[language=yaml]
event treatment:
  FKL: reweight
  unordered: keep
  extremal qqbar: keep
  central qqbar: keep
  non-resummable: keep
\end{lstlisting}
to
\begin{lstlisting}[language=yaml]
event treatment:
  FKL: reweight
  unordered: discard
  extremal qqbar: discard
  central qqbar: discard
  non-resummable: discard
\end{lstlisting}
\item Change the name of the output file, e.g.
\begin{lstlisting}[language=yaml]
analyses:
  - rivet: [MC_WWINC, MC_WWJETS]
    output: WW2j_lowpt
\end{lstlisting}
\item Run \textsc{Sherpa} and \HEJ.
  \end{enumerate}
\end{enumerate}
After repeating these steps for higher jet multiplicities, the
samples can again be combined with
\begin{lstlisting}[language=sh]
yodastack -o WWjets.yoda WW*j.yoda WW*j_lowpt.yoda
\end{lstlisting}
to reproduce the results obtained in section~\ref{sec:resum_WW} with
better statistics. Example plots resulting from
\begin{lstlisting}[language=sh]
rivet-mkhtml WWjets.yoda
\end{lstlisting}
with adjusted axis ranges are shown in figure~\ref{fig:distr_lowpt}.

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.47\linewidth]{examples/WW/jet_multi_inclusive_lowpt}
  \includegraphics[width=0.47\linewidth]{examples/WW/WW_deta_lowpt}
  \caption{%
    Inclusive $N$-jet cross sections (left) and rapidity difference
    between the two W bosons (right) combining dedicated high and low
    transverse momentum runs.
  }
  \label{fig:distr_lowpt}
\end{figure}

The cross sections for the various runs are summarised in
table~\ref{tab:xs_ref_lowpt}. Here, ``low $p_\perp$'' refers to the
contribution from the phase-space region where at least one jet is
softer than 20\,GeV. Conversely, ``high $p_\perp$'' implies that all
jets are harder than 20\,GeV. Since we do not impose an upper limit on
the transverse momenta of the jets in the \textsc{Sherpa} runcard, the
low-statistics run covers both of these regions. The ``high
$p_\perp$'' contribution is then removed when running \HEJ with the
\lstinline!require low pt jet! option, which requires that at least
one jet in the fixed-order input is below the analysis cut. While the
contributions from the low transverse momentum run are negligible in
this example, they can become relevant in high-statistics
distributions that probe the phase space near the minimum jet
transverse momentum. What is more, the impact tends to increase with
the jet multiplicity.
\begin{table}[htb]
  \centering
  \begin{tabular}{llcc}
    \toprule
    \multicolumn{2}{l}{Run} &$W^-W^- + 2$ jets&$W^-W^- + 3$ jets\\
    \midrule
    \multirow{2}{*}{\textsc{Sherpa}} & high $p_\perp$ & $1.67517 \pm 0.0702545$ & $1.4744 \pm 0.138443$\\
    & low + high $p_\perp$ & $2.3568 \pm 0.509278$ & $1.70446\pm 0.387036$\\
    \multirow{2}{*}{\HEJ}& high $p_\perp$ & $1.048 \pm 0.05616$ &$1.191 \pm 0.1316$\\
    & low $p_\perp$ $(\times 10^3)$ & $33.07 \pm 42.70$ & $1.018 \pm 1.024$\\
    \bottomrule
  \end{tabular}
  \caption{
    Reference cross sections in femtobarn when using dedicated
    low transverse momentum runs. All runs use the default random
    number generator seeds and the code versions in the \HEJ Docker
    image. \textsc{Sherpa} integration grids (\texttt{Results.db})
    should be deleted between runs to reproduce the exact numbers.
  }
  \label{tab:xs_ref_lowpt}
\end{table}

\subsection{Higgs boson production with one or more jets}
\label{sec:example_H}

% \todo[inline]{%
%   Sherpa does not write the photons to the Les Houches file for $H \to
%   \gamma\gamma$.  I think we can only do $H \to \gamma\gamma$ because
%   the Sherpa that's installed on the grid is a custom version hacked by
%   Marian.  So we have to talk about stable Higgs production here.
% }

We now consider the production of a Higgs boson together with one or
more jets. We use the parameters listed in
table~\ref{tab:H_param}. For the sake of simplicity, we first consider
the limit of an infinitely heavy top quark.

\begin{table}[htb]
  \centering
  \renewcommand{\arraystretch}{1.1}
  \begin{tabular}{lp{5mm}l}
    \toprule
    Collider energy && $\sqrt{s} = 13$\,TeV\\[.3em]
    Scales && $\mu_r = \mu_f = \frac{H_T}{2}$\\[.3em]
    PDF set && CT14nlo\\[.3em]
    Jet definition && anti-$k_t$ \\
                    && $R = 0.4$ \\
                    && $p_\perp > 20$\,GeV\\
    \bottomrule
  \end{tabular}
  \caption{Parameters for the production of a Higgs boson together with at least one jet.}
  \label{tab:H_param}
\end{table}

In close analogy with section~\ref{sec:example_WW}, we first generate
leading-order input events for Higgs boson production with a single
jet. We use \textsc{Sherpa} with the following run card
\lstinputlisting[language=sherpa,title=\texttt{Run.dat}]{examples/H/Run.dat}
For the resummation, we use a similar \HEJ configuration file as
before. Anticipating further runs with higher multiplicities, we
enable resummation for the supported NLL configurations. In the
present case this concerns configurations involving an unordered
gluon, which first contribute to Higgs boson plus dijet production,
cf.~section~\ref{sec:HEJ_summary}. Since there is no standard
\textsc{Rivet} analysis for stable Higgs boson production, we use the
generic \texttt{MC\_JETS} analysis.
\lstinputlisting[language=sherpa,title=\texttt{config\_Hjets.yml}]{examples/H/config_Hjets.yml}
As described in section~\ref{sec:example_WW}, we then add predictions
for higher jet multiplicities. We show reference cross sections in
table~\ref{tab:xs_ref_Hj} and example distributions in
figure~\ref{fig:distr_H}. We stress that, as in most examples shown here,
the \textsc{Sherpa} and \HEJ cross sections are not directly comparable.
This is because the \textsc{Sherpa} runcards use a lower transverse momentum
cut than \HEJ, for the reason explained in section~\ref{sec:low_pt}.
Therefore a significant fraction of the input events will not pass the
cuts after resummation (see section~\ref{sec:low_pt_ex} for an example
on how to deal with this in a more efficient way).

\begin{table}[htb]
  \centering
  \begin{tabular}{lccc}
    \toprule
    Run & $H+1$ jet& $H+2$ jets& $H+3$ jets\\
    \midrule
    \textsc{Sherpa}&$24.25 \pm 0.494414$ & $14.0615 \pm 0.469809$ & $6.38016 \pm 0.43697$\\
    \HEJ&$11.20 \pm 0.3732$ & $4.420 \pm 0.1953$ & $1.657\pm 0.1558$\\
    \bottomrule
  \end{tabular}
  \caption{Reference cross sections in picobarn for Higgs boson plus jet production.}
  \label{tab:xs_ref_Hj}
\end{table}

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.47\linewidth]{examples/H/jet_pT_1}
  \includegraphics[width=0.47\linewidth]{examples/H/jet_y_1}
  \caption{
    Hardest jet transverse momentum and rapidity for the
    production of a Higgs boson together with between one and three jets.
  }
  \label{fig:distr_H}
\end{figure}

\subsubsection{Quark mass corrections}
\label{sec:H_mt}

For accurate predictions in the high-energy region, we have to take
into account the finite top quark mass. In the following, we assume a
mass of 174\,GeV. On the \textsc{Sherpa} side, we can add \textsc{AMEGIC}~\cite{Krauss:2001iv}
 and \textsc{OpenLoops}~\cite{Cascioli:2011va,Buccioni:2019sur} to
\lstinline!ME_SIGNAL_GENERATOR! and insert the following lines into the
\lstinline[language=sherpa]!(run)! block:
\begin{lstlisting}[language=sherpa]
  # finite top mass effects
  KFACTOR GGH
  OL_IGNORE_MODEL 1
  OL_PARAMETERS preset 2 allowed_libs pph2,pphj2,pphjj2 psp_tolerance 1.0e-7
\end{lstlisting}
\HEJ needs to be compiled with support for
\textsc{QCDLoop}~\cite{Carrazza:2016gav} to incorporate quark mass
corrections in Higgs boson production. We can include them by adding
\begin{lstlisting}[language=yaml]
Higgs coupling:
   use impact factors: false
   mt: 174
\end{lstlisting}
to the configuration file.

For higher jet multiplicities, we face the problem that it is no
longer feasible to compute the leading-order input with exact
dependence on the top quark mass $m_t$. However, we can still retain this
dependence and also include the dependence on the bottom-quark mass $m_b$ in
the high-energy resummation.

As in equation~(\ref{eq:weight}), the weight $w$ of a leading-order matched
resummation event has the following dependence on the leading-order
matrix element $\mathcal{M}_{\text{LO}}$ and the all-order \HEJ matrix
element $\mathcal{M}_{\HEJ}(m_b, m_t)$:
\begin{equation}
  \label{eq:ME_wt}
  w \propto  \frac{\lvert\mathcal{M}_{\text{LO}}(m_b, m_t)\rvert^2 \lvert\mathcal{M}_{\HEJ}(m_b, m_t)\rvert^2}{\lvert\mathcal{M}_{\HEJ, \text{LO}}(m_b, m_t)\rvert^2}.
\end{equation}
% To avoid double counting, we have to divide by the modulus square of
% the leading-order truncation $\mathcal{M}_{\HEJ, \text{LO}}$ of the
% \HEJ matrix element, calculated for the kinematics of the
% leading-order input event.
For consistency, the values for the quark
masses have to match those used in
$\mathcal{M}_{\text{LO}}$. Therefore, if the leading-order input is
only known for $m_b \to 0, m_t \to \infty$ the correct reweighting
factor is
\begin{equation}
  \label{eq:ME_wt_mtinf}
  w \propto  \frac{\lvert\mathcal{M}_{\text{LO}}(0, \infty)\rvert^2 \lvert\mathcal{M}_{\HEJ}(m_b, m_t)\rvert^2}{\lvert\mathcal{M}_{\HEJ, \text{LO}}(0, \infty)\rvert^2} =  \frac{\lvert\mathcal{M}_{\text{LO}}(0, \infty)\rvert^2 \lvert\mathcal{M}_{\HEJ}(m_b, m_t)\rvert^2}{\lvert\mathcal{M}_{\HEJ, \text{LO}}(m_b, m_t)\rvert^2} \times \frac{\lvert\mathcal{M}_{\HEJ, \text{LO}}(m_b, m_t)\rvert^2}{\lvert\mathcal{M}_{\HEJ, \text{LO}}(0, \infty)\rvert^2}.
\end{equation}
Currently, there is no built-in \HEJ option for choosing different
quark mass values in $\mathcal{M}_{\HEJ}$ and $\mathcal{M}_{\HEJ,
\text{LO}}$. However, \HEJ supports flexible custom analyses, which
allow us to manually reweight by the correction factor
$\lvert\mathcal{M}_{\HEJ, \text{LO}}(m_b, m_t)\rvert^2 / \lvert\mathcal{M}_{\HEJ, \text{LO}}(0,
\infty)\rvert^2$ in equation~\eqref{eq:ME_wt_mtinf}. We can also use this
opportunity to include bottom quark mass corrections in the case where
only the exact leading-order dependence on the top quark mass is available.

Custom analyses are described in the \HEJ user documentation on
\url{https://hej.hepforge.org}, where also a template is provided. The
reweighting can be implemented as shown here:
\lstinputlisting[language=C++,title=\texttt{higgs\_matching\_analysis.cc}]{examples/H/higgs_matching_analysis.cc}
We can then compile the analysis into a shared object library with a
compiler supporting C++17, for instance a recent version of
\texttt{g++}:
\begin{lstlisting}[language=sh]
g++ -Wall -Wextra $(HEJ-config --cxxflags) -fPIC -shared -O2 \
  -fvisibility=hidden \
  -Wl,-soname,libhiggs_matching_analysis.so \
  -o libhiggs_matching_analysis.so higgs_matching_analysis.cc
\end{lstlisting}
To use our custom analysis, we adjust the \HEJ configuration file. We
use YAML anchors (starting with \lstinline!&!) and references
(starting with \lstinline!*!) to ensure that the settings passed to
the analysis are consistent. The following code listing is for the
case of a leading-order prediction in the infinite top-quark mass
limit.
\lstinputlisting[language=yaml,title=\texttt{config\_Hjets\_mbmt.yml}]{examples/H/config_Hjets_mbmt.yml}
If the leading order prediction includes the exact dependence on the
top-quark mass, but not the dependence on the bottom-quark mass, one
should replace the \lstinline!LO Higgs coupling! entry by
\begin{lstlisting}[language=yaml]
    LO Higgs coupling:
      use impact factors: false
      mt: 174
\end{lstlisting}
Table \ref{tab:xs_ref_Hj_mtmb} lists reference cross sections and
figure~\ref{fig:distr_H_mtmb} shows corresponding distributions
combining samples with up to three jets.

\begin{table}[htb]
  \centering
  \begin{tabular}{lccc}
    \toprule
    Run & $H+1$ jet&  $H+2$ jets & $H+3$ jets\\
    \midrule
    \textsc{Sherpa} & $25.911 \pm 0.442621$ &see tab.~\ref{tab:xs_ref_Hj} & see tab.~\ref{tab:xs_ref_Hj}\\
\HEJ &$11.50 \pm 0.2616$&$4.409 \pm 0.1947$&$1.648 \pm 0.1544$\\
    \bottomrule
  \end{tabular}
  \caption{
    Reference cross sections in picobarn for Higgs boson plus
    jets production with finite quark mass effects. All \HEJ resummation
    results account for massive bottom and top quarks. The
    \textsc{Sherpa} prediction for $H+1$ jet uses the physical
    top-quark mass, but assumes a massless bottom quark. The
    fixed-order predictions for higher multiplicities do not include
    finite quark mass effects.
  }
  \label{tab:xs_ref_Hj_mtmb}
\end{table}

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.47\linewidth]{examples/H/jet_pT_1_mtmb}
  \includegraphics[width=0.47\linewidth]{examples/H/jet_y_1_mtmb}
  \caption{
    Hardest jet transverse momentum and rapidity for the
    production of a Higgs boson together with between one and three
    jets including finite quark mass effects.
  }
  \label{fig:distr_H_mtmb}
\end{figure}


\subsubsection{Matching to next-to-leading order}
\label{sec:match_NLO_ex}

Using \HEJ 2.2, we can extend the fixed-order accuracy of
distributions from LO to NLO, cf.~section~\ref{sec:match_NLO}. In the
following, we consider NLO matching for the production of a Higgs boson
together with at least one jet. While we derive the matching in the
limit of an infinitely heavy top quark, the resulting rescaling factors
can also be used to improve HEJ predictions incorporating quark-mass
corrections. We apply the matching bin-by-bin in the resulting
histograms. We can generate an NLO prediction using \textsc{Sherpa} and
\textsc{OpenLoops} by adjusting the run card as follows.
\lstinputlisting[language=sherpa,title=\texttt{Run.dat}]{examples/H/Run_NLO.dat}
The resulting cross section is $(18.4425 \pm 3.83924)\,$pb.

For the \HEJ prediction, we add the option
\begin{lstlisting}[language=yaml]
NLO truncation:
  enabled: true
  nlo order: 1    # number of jets
\end{lstlisting}
to the configuration file \texttt{config\_Hjets.yml} from
section~\ref{sec:example_H}, change the name of the \textsc{Rivet}
output file to \texttt{Hj\_HEJ\_NLO\_1j.yoda}, and run \HEJ on the
previously generated leading-order input file assuming an infinitely
heavy top quark. We obtain a cross section of $(7.846 \pm
1.091)$\,pb. The result is \emph{exclusive} in the number of jets; in
contrast to the \textsc{Sherpa} prediction the contribution from
events with two jets is not included, yet. To generate the missing
piece, we remove the NLO process configuration from the above
\textsc{Sherpa} run card, i.e.\ we change the
\lstinline!ANALYSIS_OUTPUT! to \texttt{Hjj\_LO}, remove
\textsc{OpenLoops} from \texttt{ME\_SIGNAL\_GENERATOR} and delete the
following lines.  {\color{gray}
\begin{lstlisting}
  NLO_QCD_Mode Fixed_Order
  NLO_QCD_Part BVIRS
  Integration_Error 0.02
  Loop_Generator OpenLoops
\end{lstlisting}
}
We then increase the number of jets to two and run \textsc{Sherpa}
to generate a file \texttt{Hjj\_LO.yoda}, with a total cross section
of $(8.80745 \pm 0.321808)$\,pb. We add this contribution to the
truncated \HEJ result:
\begin{lstlisting}[language=sh]
  yodastack -o Hj_HEJ_NLO.yoda Hj_HEJ_NLO_1j.yoda Hjj_LO.yoda
\end{lstlisting}
To obtain the final NLO matched prediction, we should multiply each
histogram in the original \HEJ output by the ratio of the
corresponding histograms in \texttt{Hj\_NLO.yoda} and
\texttt{Hj\_HEJ\_NLO.yoda}. The following script gives an example of
how this reweighting can be implemented. For the sake of brevity we
have omitted the error handling code, which is of course essential in
actual applications.
\lstinputlisting[language=python,title=\texttt{reweight\_NLO.py}]{examples/H/reweight_NLO.py}
Generating \texttt{Hjets.yoda} as described in section~\ref{sec:H_mt},
the resulting NLO-matched rapidity distribution of the hardest jet is
shown in figure~\ref{fig:distr_H_NLO}.  Note that the
\texttt{MC\_JETS} \textsc{Rivet} analysis employs adaptive binning
for a number of distributions, causing the division of the respective
histograms to fail. This problem can of course be circumvented by
using a custom analysis.

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.47\linewidth]{examples/H/jet_y_1_NLO}
  \caption{%
    Differential NLO matching for the rapidity distribution of the
    hardest jet produced together with a Higgs boson.
  }
  \label{fig:distr_H_NLO}
\end{figure}

\subsection{Charged lepton pair production with many jets}
\label{sec:HEJFOG_ex}

The production of two charged leptons with jets was first implemented
in \HEJ~2.1~\cite{Andersen:2021qma} for at most moderate jet
multiplicities, where exact fixed-order matching is feasible. To
overcome this difficultly, in \HEJ~2.2 approximate high-multiplicity
events can be generated with the \HEJ Fixed Order Generator.

In the following example, we consider the process $pp \to \mu^+ \mu^-
+ \geq$ 2 jets with the same parameters as in previous examples, see
table~\ref{tab:WW_param}. We assume that predictions including up to 4
jets have already been produced as described in
sections~\ref{sec:example_WW} and~\ref{sec:example_H}. To generate
input events with 5 jets, we adapt the configuration file
\texttt{configFO.yml} distributed together with \HEJ:
\lstinputlisting[language=yaml,title=\texttt{configFO\_Zjets.yml}]{examples/Z/configFO_Zjets.yml}
By setting the \lstinline!peak pt! option we ensure that most events
are generated above the analysis cut of 20\,GeV. This means that there
is no need for two separate runs with different transverse momentum
cuts as described in section~\ref{sec:low_pt_ex} for conventional
fixed-order generators. We can now generate events with
\begin{lstlisting}
docker run -v $PWD:$PWD -w $PWD hejdock/hej HEJFOG configFO_Zjets.yml
\end{lstlisting}
when using the \HEJ Docker container or
\begin{lstlisting}
HEJFOG configFO_Zjets.yml
\end{lstlisting}
when using a local \HEJ installation. We obtain a cross section of
$(11.53 \pm 1.607)\,$pb. Afterwards, we can run \HEJ on the resulting
\texttt{events\_Z5j.lhe} event file to obtain resummed predictions
for $pp \to \mu^+ \mu^- +$ 5 jets. These could then be combined
with the results for lower multiplicities as described in
section~\ref{sec:resum_WW}.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
