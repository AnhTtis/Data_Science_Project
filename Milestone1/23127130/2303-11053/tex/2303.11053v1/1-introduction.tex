\section{Introduction}
Healthcare rationing has become an important issue in the world amidst the COVID-19 pandemic.
At certain times the scarcity of medical resources like vaccines, hospital beds, ventilators, medicines especially in developing countries  raised the question of fair and efficient distribution of these resources. 
One natural approach is to define priority groups. For example,
for vaccination, the main priority groups considered include health care workers, workers in other essential services, and people with vulnerable medical conditions \cite{Persad20,Truog20}. Racial equity has been another concern \cite{Bruce21}. Having made the 
priority groups, it still remains a challenge to allocate resources within the groups in a transparent manner \cite{Emanuel20,WHO20}.
A New York Times article has mentioned this as one of the hardest decisions for health organizations \cite{Fink20}. In light of this,
it is a major problem to decide how to allocate medical resources fairly and efficiently while respecting the priority groups and other
ethical concerns.

The healthcare rationing problem has been recently addressed by market designers. In \cite{Pathak20}, the problem was framed as
a two-sided matching problem (see e.g. \cite{Roth90}). Their model has reserve categories each with its own priority ordering of people.
This ordering is based on the policy decisions made according to various ethical guidelines. It is shown in \cite{Pathak20} that running the Deferred Acceptance algorithm of Gale and Shapley \cite{GS62} has desired properties like eligibility compliance, non-wastefulness and respect to priorities. This approach of \cite{Pathak20} has been
recommended or adopted by organizations like the NASEM (National Academies of Sciences, Engineering, and Medicine) \cite{NASEM20}. It has also been recognized in medical literature \cite{Persad20,Sonmez20}, and is mentioned by the Washington Post \cite{WP}. The Smart Reserves algorithm of \cite{Pathak20} gives a maximum matching satisfying the desired properties mentioned earlier. However, it assumes a global priority ordering on people. In a follow-up work, \cite{Aziz21} generalize this to
the case where categories are allowed to have heterogeneous priorities. Their Reverse Rejecting (REV) rule, and its extension to Smart Reverse Rejecting (S-REV) rule are shown to satisfy the goals like eligibility compliance, respect to priorities, maximum size, non-wastefulness, and strategyproofness.

However, the allocation of healthcare resources is an ongoing process. On a day-to-day basis, new units arrive in the market and they
need to be allocated to people. The variation in the availability of medical resources over a period of time, and the possible unavailability of recipients on certain days is an important factor in making allocation decisions. For example, while allocating vaccines, the unavailability of people on certain days might lead to wastage of vaccines, especially if the units are reserved for categories a priori. The previous models do not encompass this dynamic nature of resources. Moreover, the urgency with which a resource needs to be allocated to an individual also changes over time. While priority groups or categories aim to model this by defining a priority order on people, defining a strict ordering is not practically possible. While dealing with a large population, defining a strict ordering on people is not desirable. For instance, in the category of old people, it is neither clear nor desirable to define a strict order on people of the same age 
and same vulnerabilities. Even if categories are allowed to have ties in their ordering, the ordering still provides only an ordinal ranking.

Our model provides the flexibility to have cardinal rankings in terms of prioritizing people by associating a {\em utility value} for each individual. Thus, in our work, categories do not define an ordering over people, instead, there is a utility value associated with allocation of the resource to each person. The goal is to find an allocation with maximum total utility while respecting category quotas. However, utilities can change over time. For instance, the advantage of allotting a ventilator to a person today might be far more beneficial than allotting it tomorrow. Similarly, vaccinating the vulnerable population as early as possible is much more desirable from a social perspective than delaying it to a later day. We model this through {\em dynamic utilities}. Thus, we consider utilities that diminish over time. The {\em discounting factor}  $0<\delta<1$ is multiplicative. Such exponential discounting is commonly used in economics literature \cite{Ramsey1928,Samuelson1937}. %A smaller discounting factor indicates more urgency of allocating a resource to a person early on while a discounting factor close to $1$ indicates that the individual can be made to wait for a few days in the interest of allocating the resource to another individual who needs it more urgently. Thus, for vaccination, the discounting factor for a healthy, young individual will be much higher compared to an old person with serious ailments. 
Our utility maximization objective can thus be seen as maximization of {\em social welfare}. Another advantage is that the division of available units into various categories is not static. It is dynamically decided depending on the supply of units and availability of people on each day. 

%To achieve the above goals, we propose a network-flow based model for allocating resources to people, also referred to as agents in this paper, where priorities among agents are modelled in terms of utilities. The utilities change over days, capturing the urgency to provide a resource to an agent. The allocation problem then becomes a maximum-flow computation problem.
Our algorithms to find a maximum utility allocation are based on network flows. They adhere to the following important ethical principles which were introduced by Aziz et al in \cite{Aziz21}:
\begin{enumerate}
    \item complies with the eligibility requirements 
    \item is strategyproof (does not incentivize agents to under-report the categories they qualify for or days what they are available on),
    \item is non-wasteful (no unit is unused but could be used by some eligible agent)
\end{enumerate}

Additionally our algorithms give an approximate maximum weight matchings, where the weights denote the utility value of a matching. We note that the current state-of-practice algorithms such as first-come first-serve or random ordering do not guarantee non-wastefullness as the matching returned by them may not be of maximum size. Furthermore, matchings returned by these algorithms could be of arbitrarily low total utility. Using category quotas and utility values, we provide a framework in which more vulnerable populations can be prioritized while maintaining a balance among the people vaccinated through each category on a day-to-day basis. 
%Our models and algorithms are also applicable in other settings like school admissions\cite{as03}, refugee settlement\cite{delacretaz2016refugee,bansak2018improving,delacretaz2016refugee}, visa allocation \cite{kato2013quotas,delacretaz2021processing,clark2007explaining,borjas1993immigration}, hospital residents problem \cite{Kojima19,Aziz21,Kamada15,Kamada17}  etc. A detailed discussion about the related work is given in the Appendix. 

\subsection{Related Work}
The topic of constrained matching problems has been an active area or research and it has been studied in the context of school choice and hospital residents problem apart from healthcare rationing \cite{Kojima19,Aziz21,Kamada15,Kamada17,Biro10,Goto16,Sankar21}. The setting with two-sided preferences has been considered in \cite{Hamada16,Kavitha14,Huang10,Kamiyama16}. The fairness and welfare objectives have been covered in a comprehensive manner in \cite{Moulin03}. 

Another application of the constrained matching problem is in the refugee resettlement problem. Refugee resettlement is a pressing matter in the twenty-first century where people have been forced to leave their country in order to escape war, persecution, or natural disaster. 
In the refugee resettlement process the refugee families are settled from asylum countries to the host countries where the families are given permanent residentship. The reallocation is done keeping in mind the necessities of the families as well as the infrastructure capacities of the host countries. DelacrÃ©taz et al. \cite{delacretaz2016refugee} formalized refugee allocation as a centralized matching market design problem. 
The refugee allocation problems have been studied both in terms of matching problems with preferences \cite{andersson2016assigning,delacretaz2019matching,aziz2018stability,jones2017international,jones2018local,nguyen2021stability,sayedahmed2020refugee} and without preferences\cite{bansak2018improving,delacretaz2016refugee}. In the matching problem with preferences, the goal is to match the refugees to localities based on the preference of either one or both sides, while satisfying the multidimensional resettlement constraints. Delacretaz et al. considered the problem both in terms of with and without preferences. The problem without preference can be reduced to multiple multidimensional knapsack problems \cite{delacretaz2016refugee}. The branch-and-bound method can be used to find the exact solution. Bansak et al. \cite{bansak2018improving} used a combination of supervised machine learning and optimal matching to obtain a refugee matching that satisfies the constraints of refugees and localities.
The dynamic version of the refugee resettlement problem \cite{andersson2018dynamic,ahani2021dynamic,cilali2021location} has also been considered in literature. 

\subsection{Our Models}
We define our model below and then define its extension. %The restricted models have more efficient algorithms.
Throughout this paper, we consider vaccines as the medical resource to be allocated. People are referred to as agents.
Note that although the discussion assumes perishability 
of resources, it can easily be extended to non-perishable resources. %{\color{blue} Do we have to mention that our model is for perishable goods? Making the jump to non-perishable goods is not hard, but we have not talked about it here} although the same model and results are applicable to other resources as well.
\paragraph{Model 1: }\label{model_1}
Our model consists of a set of agents $A$, a set of categories $C$, and a set of days $D$. For day $d_j\in D$, there is a {\em daily supply} $s_j$ denoting the number of vaccine shots available for that day. For each category $c_i\in C$, %there are two types of quotas viz. {\em overall quota} $q_i$ and 
and each day $d_j\in D$, we define a {\em daily quota} $q_{ij}$. %Here, the overall quota $q_i$ denotes the maximum total number of vaccines that can be allocated through category $c_i$ over all the days, whereas 
Here $q_{ij}$ denotes the maximum number of vaccines that can be allocated for $c_i$ on day $d_j$. There is a priority factor $\alpha_k$ associated with an agent $a_k$. Let $\alpha_{\max}~=~\max_i\{\alpha_i~\mid~\alpha_i~\text{ is the priority factor of agent $a_i$}\}$ and $\alpha_{\min}~=~\min_i\{\alpha_i~\mid~\alpha_i~\text{ is the priority factor of agent $a_i$}\}$. Utilities have a {\em discount factor} $\delta\in (0,1)$ denoting the multiplicative factor with which the utilities for vaccinating agents reduce with each passing day. Thus if $a_k$ is vaccinated on day $d_j$, the utility obtained is $\alpha_k\cdotp\delta^j$. Each agent $a_k$ has an {\em availability vector} $v_k\in \{0,1\}^{|D|}$. The $j$th entry of $v_k$ is $1$ if and only if $a_k$ is available for vaccination on day $d_j$.% {\color{blue} perishability of vaccine not made clear I guess, while describing the model}. 


\paragraph{Model 2:}\label{model_2} Model 2 is an extension of Model 1 in the following way. The sets $A,C,D$ and the daily supply and daily quotas are the same as those in model 1. Apart from the daily quota, each category $c_i$ also has an {\em overall quota} $q_i$ that denotes the maximum total number of vaccines that can be allocated for category $c_i$ over all the days. Note that overall quota is also an essential quantity in 
applications like visa allocation and refugee settlement.

In both the models, a matching $M:A\rightarrow (C\times D)\cup \{\emptyset\}$ is a function denoting the day on which a person is vaccinated and the category through which it is done, such that the category quota(s) and daily supply values do not exceed on any day. Thus if we define variables $x_{ijk}$ such that $x_{ijk}=1$ if $M(a_k)=(c_i,d_j)$ and $x_{ijk}=0$ if $M(a_k)=\emptyset$, then
we have $\sum_{i,j} x_{ijk}\leq 1$ for each $k$, $\sum_{k,j}x_{ijk}\leq q_i$ for each $i$, $\sum_k x_{ijk} \leq q_{ij}$ for each $i,j$, and $\sum_{i,k} x_{ijk}\leq s_j$ for each $j$. Here $1\leq i \leq |C|, 1\leq j\leq |D|, 1\leq k\leq |A|$. If $M(a_k)=\emptyset$ for some $a_k\in A$, it means the person could not be vaccinated through our algorithm within $|D|$ days.

In both the models, the utility associated with $a_k$ is \(\alpha_k\cdotp\delta^{j-1}\) where $M(a_k)=(c_i,d_j)$. The goal is to find a matching that maximizes the total utility.  

%\paragraph{Restricted models:} We also consider various restrictions of the above mentioned model. 
%\begin{itemize}
%    \item {\bf Model 1: No overall quota} This model is the same as the general model except that there is no overall quota for the categories. 
%    \item {\bf Model 2: No daily quota } This model again has all the parameters from the general model except there are no daily quotas for categories.
%    \item {\bf Model 3: No daily supply} This model has all the parameters of the general model except the daily supply value. This model captures the case where the exact vaccine distribution among categories is decided a priory, and hence the daily supply is just the sum of the daily quotas of the categories. It does not appear as a separate parameter.
%\end{itemize}

\subsection{Our Contributions}
The utilities $\alpha_k$ and discounting factor $\delta$ have some desirable properties. If agent $a_k$ is to be given a higher priority over agent $a_\ell$, then we set $\alpha_k>\alpha_\ell$. On any day $d_j$, $\alpha_k\cdot \delta^j>\alpha_\ell\cdot \delta^j$. Moreover, the difference in the utilities of the two agents diminishes over time i.e. if $j<j'$ then $(\alpha_k-\alpha_\ell)\delta^j >(\alpha_k - \alpha_{\ell})\delta^{j'}$. Thus the utility maximization objective across all days vaccinates $a_k$ earlier than $a_\ell$. 

We consider both online and offline settings. The offline setting relies on the knowledge about availability of agents on all days. This works well in a system
where agents are required to fill up their availability in advance e.g. in case of planned surgeries, and visa allocations. The online setting involves knowing the availability of all the agents only on the current day as in a {\em walk-in} setting. 
Thus the availability of an agent on a day in future is not known.

We give an optimal algorithm for Model $1$ in the offline setting.. 
%We give online and offline algorithms for the restricted models, and an online algorithm for the general model.

\begin{theorem}\label{thm:off-opt}
There is a polynomial-time algorithm that computes an optimal solution for any instance of Model $1$ in the offline setting.
\end{theorem}

We also give algorithms for both Model $1$ and Model $2$ in the online setting.
%The online algorithms are useful in the {\em walk-in} setting where agents are not required to pre-book their appointments.
%Thus the online algorithms work in a setting where the availability on each day is revealed only at the beginning of that day.
We give theoretical guarantees on the performance of online algorithms in terms of their {\em competitive ratio} in comparison with the utility of an offline optimal solution. 

\begin{theorem}\label{thm:gen-on-same-utility}
There is an online algorithm (Algorithm~\ref{alg:online-greedy-m1}) that gives a competitive ratio of (i) $1+\delta$ for Model $1$ and (ii) of \(1+\delta + ({\alpha_{\max}}/{\alpha_{\min}})\delta\) for Model $2$ when $\delta$ is the common discounting factor for all agents. The algorithm runs in polynomial time.
\end{theorem}
We prove part $(i)$ of Theorem~\ref{thm:gen-on-same-utility} in Section~\ref{sec:analysis-model-1} whereas part $(ii)$ is proved in Appendix.
%In contrast to the above, we show in Section~\ref{sec:gen-on} that if the discount factor is not the same for all agents, then the competitive ratio can be arbitrarily large.
%\begin{theorem}\label{thm:diff-utility}
%If the discounting factor of each agent is chosen from the range $(0<\delta, \delta+ \alpha<1)$ then we have a 
%$(1 + \delta + \delta(1 + \frac{\alpha}{\delta})^{r+1})$-approximation algorithm, where $d=|D|$.
%\end{theorem}
\paragraph{Strategy-proofness:}
It is a natural question whether agents benefit by hiding their availability on some days. We show that the online algorithm is strategy-proof.
In this context, we analyze our online algorithm for Model $1$ from a game theoretic perspective. We exhibit that the offline setting has a {\em pure Nash equilibrium} that corresponds to the solution output by the online algorithm. For this, we assume that the tie-breaking among agents is done according to an arbitrary permutation $\pi$ of agents. 
\begin{theorem}\label{thm:nash}
Let an offline optimal solution that breaks ties according to a random permutation $\pi$ match agent $a_i$ on day $d_i$. Then for each agent $a_i$, reporting  availability exactly on day $d_i$ (unmatched agents mark all days as unavailable) is a pure Nash equilibrium. Moreover, the Nash equilibrium corresponds to a solution output by the online algorithm.
\end{theorem}

\paragraph{Experimental Results:}
We also give experimental results in Section~\ref{sec:simulation} using real-world datasets. Apart from maximization of utilities, we also consider the number of days taken by the online algorithm for vaccinating high priority people. Our experiments show that
the online algorithm almost matches the offline algorithm in terms of both of these criteria.
\paragraph{Selection of utility values:} An important aspect of our model is that the choice of utility values does not affect the outcome as long as the utility values have the same numerical order as the order of priorities among agents. Thus the output of online as well as offline algorithm remains the same as long as $\alpha_k>\alpha_\ell$ whenever agent $a_k$ has a higher priority over agent $a_\ell$.
