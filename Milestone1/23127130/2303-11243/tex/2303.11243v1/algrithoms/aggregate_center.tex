\setlength{\textfloatsep}{0.2cm}
\begin{algorithm}[t]
\linespread{1.0}\selectfont
\caption{\label{alg:st}APG Aggregation Pseudocode}

\SetAlgoNoLine

\KwIn{Predictions of different observations,\\
Raw prediction $\mathcal{P}_r$ of an unlabeled image,

Filtered prediction $\mathcal{P}_f^0$, $N = \text{len}(\mathcal{P}_f^0)$, 

Filtered predictions $\{\mathcal{P}_f^k\}_{k=1}^K$ of augmented images,

Threshold $\tau$ for kNN
}

\vspace{0.05cm}
\KwOut{Aggregated prediction $\mathcal{P}$}
\vspace{0.1cm}
Initialize set $\mathcal{S} \leftarrow \{\{p_1\},\cdots, \{p_N\}\},p_n\in \mathcal{P}_f^0$

% \For {center $c_i$, classification score $s_i$ $\in\mathcal{P}_f^0$} {
% $\mathcal{S}_a \leftarrow \mathcal{S}_a \cup \{p_i\}$,~~
% $\mathcal{S}_c \leftarrow \mathcal{S}_c \cup \{\{p_i\}\}$
% }

\For {image observation $k\in \{1, \dots, K\}$} {
    \For {prediction $p_i\in\mathcal{P}_f^k$} {
    $(\text{index } j, \text{distance } l)$ $\leftarrow$ kNN$(p_i, \mathcal{S})$
    
        \eIf{$l < \tau$}{
        $\mathcal{S}_j \leftarrow \mathcal{S}_j \cup \{p_i\}$ \# append $p_i$ to clusters
        }{
        $\mathcal{S}_j \leftarrow \mathcal{S}_j \cup \{\{p_i\}\}$ \# create new clusters
        }
    }
}

\For {loop index n, cluster set $\{p^m\}_{m=1}^M \in \mathcal{S}$ } {
location $\mu$, variance $\sigma = $ MLE $(\{p^m\}_{j=m}^M)$

\eIf{$n < N$}{
    $ \mathcal{P} \leftarrow \mathcal{P} \cup \{(\mathcal{S}_n[0], \sigma)\}$
}
{
    $\mathcal{P} \leftarrow \mathcal{P} \cup \{(\text{NearestSearch}(\mu, \mathcal{P}_r), \sigma)\}$
}
}

\Return {$\mathcal{P}$}
\end{algorithm}