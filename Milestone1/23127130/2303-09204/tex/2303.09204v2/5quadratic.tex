
In this section, we focus on the  decidability of the Membership Problem
for recurrences 
\begin{equation}
f(n)u_n - g(n)u_{n-1}=0, \qquad u_0=1
\tag{\ref{eq:rel}}
\end{equation}
in which both $f,g\in \Z[x]$ are monic 
and split completely over a quadratic (degree-two) extension $\K$ of $\Q$.

Recall that a number  field \(\K\) is \emph{quadratic} if and only if there is a square-free integer \(\beta\) such that \(\K = \Q(\sqrt{\beta})\).
The assumption that \(f\) and \(g\) are both monic ensures that the roots of both polynomials are algebraic integers 
in \(\Q(sqrt{\beta}) \).
As shown in~\cite[Chapter 3]{stewart2016algebraic}, the following holds.

\begin{theorem} \label{thm:quadratic}
Suppose that $\beta\in\Z$  is  square-free.
Then the ring of algebraic integers in $\Q(\sqrt{\beta})$ has the form $\Z[\theta]$, where
\[\theta= \begin{cases}
	\sqrt{\beta} & \text{if }\beta \not\equiv 1 \pmod{4},\\[3pt]
	 \textstyle\frac{\sqrt{\beta}-1}{2} & \text{if } \beta\equiv 1 \pmod{4}.
\end{cases}
\]
\end{theorem}

The main result of the section is as follows.

\begin{theorem}
\label{theo-decide-quad}
The Membership Problem for recurrences of the
form~\eqref{eq:rel} is decidable under the assumption that $f,g$
are both monic and both split over a  quadratic extension $\K$ of
$\Q$.
\end{theorem}

The proof of Theorem~\ref{theo-decide-quad} is given in \Cref{subsec-partition-roots,subsec-thre,subsec-primediv,subsec-conclud}.
The details differ slightly according to the two cases
for the generator $\theta$ of the ring of integers of $\K$, as presented in
Theorem~\ref{thm:quadratic}.  
In the subsections below, we treat the case for
$\theta=\frac{\sqrt{\beta}-1}{2}$.  
The necessary adjustments for the case
$\theta=\sqrt{\beta}$ are given in Appendix~\ref{app-sec-quad}.
Henceforth we assume a normalised instance of the Membership Problem,
given by the recurrence~\eqref{eq:rel} and target~$t\in \Q$.
Our goal is to exhibit an effective bound~$B$ such that $u_n\neq t$
for all $n>B$.  
To this end, our strategy is to find $B$ such that for
all~$n>B$ there exists a prime that divides $u_n$ but not~$t$.
At the conclusion of the proof of \autoref{theo-decide-quad}, we demonstrate the argument and techniques with a worked example, namely \autoref{ex:example2} in \Cref{subsec-conclud}.


Let $\beta\equiv 1\pmod{4}$ be a square-free integer and
$\K=\Q(\sqrt{\beta})$ a quadratic field over which the polynomials $f$
and $g$ in~\eqref{eq:rel} split completely.  Let
$\theta:=\frac{\sqrt{\beta}-1}{2}$ be such that $\Z[\theta]$ is the
ring of integers of $\K$.  Write
$m_{\theta}(x):=x^2+x+\frac{1-\beta}{4} \in \Z[x]$ for the minimal
polynomial of $\theta$.

\subsection{Partitioning the roots of \texorpdfstring{$fg$}{fg}}
\label{subsec-partition-roots}
Let $\mathcal R$ be the set of roots of $fg$.
We partition \(\mathcal{R}\) into disjoint subsets (which we shall call the \emph{classes} of \(\mathcal{R}\)) with \(\alpha,\tilde{\alpha}\in \mathcal{R}\) in the same class
if and only if \(\alpha-\tilde{\alpha}\in\Z\).
We say that a subset of $\mathcal{S}\subseteq \mathcal {R}$  is \emph{balanced} if $f$ and
$g$ have the same number of roots in $\mathcal S$, counting repeated roots
according  to their multiplicity. 
A subset is \emph{unbalanced} otherwise.
The linchpin of the proof of \autoref{theo-decide-quad} is the balance of roots in the classes.

If each class (as above) is
balanced then the roots of $f$ and $g$ can be placed in a bijection
under which corresponding roots differ by an integer and have the same
multiplicity in $f$ and $g$ respectively.  
In this case, by cancelling
common factors in the expression
$u_n = \prod_{k=1}^n
\frac{g({k})}{f({k})}$, we see that
for $n$ sufficiently large $u_n$ is a rational function in $n$.  
For such an instance, 
the Membership Problem reduces to the problem of deciding whether a univariate polynomial with rational integer
coefficients has a positive integer root, which is straightforwardly
decidable. 
A detailed account for this argument is given in~\cite[Appendix B]{NPSW022}.

Let us now consider the case where there is an unbalanced class~\(\mathcal{C}\).
By the assumption that $f$ and $g$ have the same
degree, there must, in fact, be at least two unbalanced
classes.
It follows that there is an unbalanced class that is not
contained in $\Z$ (i.e., an unbalanced class of quadratic integers).

Here it is convenient to define the following linear
ordering on~$\mathcal R$.  
Given elements $a\theta+b$ and
$a'\theta+b'$ in $\mathcal R$
(where \(a,a',b,b'\in\Z\)),
define $a\theta+b \prec a'\theta+b'$ if
and only if one of the following four mutually exclusive conditions
holds:
\begin{enumerate}
\item $a' \leq 0 < a$,
\item $0 < a < a'$,
\item $a<a' \leq 0$,
\item $a=a'$ and $b<b'$.
\end{enumerate}

Note that the classes in $\mathcal R$ are intervals
with respect to the order~$\prec$.  Thus the order lifts naturally to a linear order on classes.
In particular, the \emph{least
  unbalanced class}~$\mathcal C_0$ is well-defined.  Let
$\alpha_0=a_0\theta+b_0$ be the greatest element in $\mathcal C_0$.
Then $ \{\alpha\in\mathcal{R}: \alpha \preccurlyeq \alpha_0 \} $ is
unbalanced 
because this set is a disjoint union of balanced classes and~\(\mathcal{C}_0\).
Further, $a_0> 0$
because the least unbalanced class is necessarily a subset of quadratic integers of the form \(a_0\theta + \Z\).
Here we note that the image of an unbalanced class
under the
automorphism of~$\K$ that interchanges $\sqrt{\beta}$ and
$-\sqrt{\beta}$ is likewise an unbalanced class and so $a_0>0$.


\colorlet{cyan}{purple}
\begin{figure*}[t]
    \centering
    \begin{tikzpicture}
    \scalebox{.9}{
\def \x {3/5}

\draw[gray, ultra thick] (0,4) -- (20.5*\x,4);  
\foreach \y in {1,...,20}
\draw[draw=gray] (\y*\x,4.1)--(\y*\x,3.9);
\draw[gray, line width=1mm, opacity=.5] (0,4.2) arc[start angle=150, end angle=210, radius=.4cm];
\node[left] at (.2,3.5) {{\large  $0$}};
\node at (19*\x,3.5) {{\scriptsize $\frac{p-1}{2}$}};
\filldraw[gray] (20.5*\x+0.2,4) circle (0.5pt);
\filldraw[gray] (20.5*\x+0.4,4) circle (0.5pt);
\filldraw[gray] (20.5*\x+0.6,4) circle (0.5pt);


\filldraw [cyan!50!white, opacity=0.5] (1*\x,4.1) rectangle (3*\x,3.9);
\node at (2*\x,4.3) {\textcolor{cyan}{{\scriptsize images of some balanced classes}}};
 \node[left] at (1*\x+.4,3.7) {};%
 \filldraw[cyan] (1*\x,4) circle (2pt);
 \node[left] at (3*\x+.4,3.7) {};%
 \filldraw[cyan] (3*\x,4) circle (2pt);

 \filldraw [violet!50!white, opacity=0.5] (4.75*\x,4.1) rectangle (7.5*\x,3.9);
\node at (6.1*\x,4.3) {\textcolor{violet}{{\scriptsize $\varphi(\mathcal{C}_0)$}}};
 \node[left] at (4.75*\x+.4,3.7) {};%
 \filldraw[violet] (4.75*\x,4) circle (2pt);
 \node at (7.5*\x,3.7) {{\textcolor{violet}{\scriptsize $\varphi(\alpha_0) = a_0\theta' + b_0$}}};
 \filldraw[violet] (7.5*\x,4) circle (2pt);

\node[above] at (11*\x,4) {{\scriptsize $a_0 \theta' + \frac{1}{3}\theta'$}};
\filldraw[black] (11*\x,4) circle (2pt);

\node[above] at (13*\x,4) {{\scriptsize $n$}};
\filldraw[black] (13*\x,4) circle (2pt);

\node[above] at (15.5*\x,4) {{\scriptsize $a_0 \theta' + \frac{2}{3}\theta'$}};
\filldraw[black] (15.5*\x,4) circle (2pt);

 \draw [pen colour={RoyalPurple}, decorate, decoration = {calligraphic brace}, thick] (0,4.6) --  (13*\x,4.6);
 \node[right] at (1,4.9) {{\textcolor{RoyalPurple}{\scriptsize  $1 \leq \varphi(\alpha)  \leq n$ precisely when  $\alpha \preccurlyeq \alpha_0$}}};


}
\end{tikzpicture}
\caption{
Image of \(\varphi\) 
on \(\Z\) 
as well as  the positions of constants used in the proof of  \autoref{thm:quadratic} to determine that \(v_p(u_k)\neq 0\) for \(k\) that satisfy \(a_0\theta'+\frac{1}{3}\theta' \le k \le a_0\theta'+\frac{2}{3}\theta'\). 
Note that the preimages \(\alpha\in\mathcal{R}\) such that \(1\le \varphi(\alpha)\le n\) are precisely those roots for which~$\alpha \preccurlyeq \alpha_0$.}
\label{fig:pretty-things}
\end{figure*}







\subsection{Threshold conditions}
\label{subsec-thre}

Next we exhibit a threshold $B$ (defined in terms of the
recurrence~\eqref{eq:rel}) such that for all $n>B$ there are
rational integers $\theta'$ and $p$, with $p>n$ prime, satisfying the
following conditions:
\begin{enumerate}
\item[(P1)] $m_\theta(\theta')\equiv 0\pmod{p}$;
\item[(P2)]  The function $\varphi:\mathcal{R}\rightarrow\Z$ defined by
\[  \varphi(a\theta+b) = \begin{cases}
a\theta' + b & \text{if } a> 0,\\
a\theta' + b + p  & \text{if } a\leq 0
\end{cases}\]
is an order embedding of $(\mathcal{R},\prec)$
in $(\{0,1,\ldots,p-1\},<)$.
\item[(P3)] The set $\{ \alpha \in \mathcal{R} : 1 \leq \varphi(\alpha)
  \leq n \}$ is unbalanced.
\end{enumerate}


The definitions for $\theta'$ and $p$  follow.
Consider
the interval
\begin{gather} I(n):= \left\{ k\in\N : \frac{6n}{3a_0+2}\leq k-1\leq
    \frac{6n}{3a_0+1} \right\} \, .
    \label{eq:INT}
    \end{gather} 
    and let
    $M$ be an upper bound on $\{|a|,|b|: a \theta+b\in 
\mathcal{R}\}$, and the height of the minimal polynomials of the elements of $\mathcal{R}$.
By
\autoref{theo:bigprimespolyT}, there is an effective threshold $B$, which we may assume to be greater than $3M(M+1)$, 
such that for all $n>B$ there exists a prime $p > 3Mn$ that divides the
product
\[ \prod_{\substack{k\in I(n)\\ k \in 2\N+1}} k^2-\beta.\]
Furthermore, since \(p\) is prime, we deduce that there exists 
$k_0 \in I(n) \cap (2\N+1)$ such that $k_0^2 \equiv \beta \pmod{p}$. 
We define $\theta' \in \N$ to be the number such that $k_0=2\theta'+1$.

We will show that $\theta'$ and $p$ satisfy Conditions (P1)--(P3).  Now
\begin{equation*}
    m_\theta(\theta') = m_\theta \biggl(\frac{k_0 - 1}{2} \biggr) \equiv k_0^2-\beta \equiv 0 \pmod{p}.
\end{equation*}
Thus $\theta'$ satisfies
Condition (P1).

We turn next to establishing Condition (P2).
Since $k_0\in I(n)$ and $k_0=2\theta'+1$, we have
\begin{equation}
(a_0+\textstyle\frac{1}{3})\theta' \leq n \leq
(a_0+\textstyle\frac{2}{3})\theta'.
  \label{eq:INEQ}
\end{equation}
Combining~\eqref{eq:INEQ} with the inequality $1\leq a_0 \leq M$ and rearranging terms gives 
$\frac{n}{M+1} \leq \theta' \leq \frac{3n}{4}$.
Recalling that $p>3Mn$ and $n > B \geq 3M(M+1)$, we conclude that
\begin{equation}
3M \leq \theta' \leq \frac{p}{4M} \, . 
\label{eq:INEQQ}
\end{equation}
The inequality $\theta'\leq\frac{p}{4M}$
in~\eqref{eq:INEQQ}
implies that for all roots \(a\theta + b \in \mathcal{R}\), $\varphi(a\theta+b)$ is equal to
    \begin{align*}
       a\theta' + b \in &
            \left\{0,\ldots,\frac{p-1}{2}\right\} \text{ if } a>0, \text{ and } \\
       a\theta' + b + p \in & \left\{\frac{p-1}{2},\ldots,p\right\} \text{ if } a\leq 0
    \end{align*}
(for the latter, recall that $\mathcal{R}$ contains no positive integers).  
Further, since  $|b| \leq M<\theta'$
for all $a\theta+b\in \mathcal{R}$, we conclude that
$\varphi$ is an order
embedding of $(\mathcal{R},\prec)$ into 
$(\{0,\ldots,p-1\},<)$.
This establishes~(P2).

Equation~\eqref{eq:INEQ}  
and the inequality $\theta' \leq  3M$ from~\eqref{eq:INEQQ}
yields \[ \varphi(\alpha_0) < a_0\theta'+M < n < (a_0+1)\theta'-M \, .\] 
Hence \(\varphi(\alpha_0)\), the image of the greatest element in \(\mathcal{C}_0\) is upper bounded by \(n\).
From the definition of the order \((\mathcal{R},\preccurlyeq)\), for
$\alpha\in\mathcal R$ we have that $\alpha\preccurlyeq \alpha_0$ if and only if
$\varphi(\alpha) \leq n$.  
Thus (P3) follows from the fact that the set
$\{\alpha\in\mathcal{R}:\alpha \preccurlyeq \alpha_0\}$ is unbalanced.


\subsection{Prime divisors of \texorpdfstring{$u_n$}{un}}
\label{subsec-primediv}

To conclude the proof, we now explain why properties (P1)--(P3) imply that
$p$ divides $u_n$.  
Define $\psi:\Z[\theta]\rightarrow \Z/p\Z$ by
\[ \psi(a\theta+b):=(a\theta'+b)\bmod{p}.\]  
Condition (P2) entails that
$\psi$ and $\varphi$ agree on $\mathcal R$, while Condition (P1) entails
that $\psi$ is a ring homomorphism. 
(We note in passing that the kernel of $\psi$ is a prime 
ideal~$\mathfrak{p}$ appearing in prime ideal factorisation of $p\Z[\theta]$.)
Hence the polynomial $fg$ splits
over $\Z/p\Z$ and $\varphi$ maps the roots of $fg$ in $\K$ to roots of
$fg$ in $\Z/p\Z$.  



Consider the decomposition of the \(p\)-adic valuation
\begin{equation*}
    v_p(u_n) = \sum_{k=1}^n (v_p(g(k))-v_p(f(k))).
\end{equation*}

Let $h(x)$ be an irreducible factor of either $f$ or $g$.
Then $h(x)$ is monic, of degree at most $2$ and height at most $M$.  Since $p>3Mn$, we easily see that $|h(k)|<p^2$
for all $1\leq k \leq n$ and hence
$v_p(h(k)) \in \{0,1\}$.
It follows that $v_p(u_n)$ is equal to the number of roots of $g$ 
in $\Z/p\Z$ that lie in $\{1,\ldots,n\}$ minus the number of roots of $f$ in $\Z/p\Z$ that lie in $\{1,\ldots,n\}$, counting repeated roots according to their multiplicity. 
Observe that this count takes place on the set \(\{\alpha\in\mathcal{R} : 1\le \varphi(\alpha)\le n\}\).
By Condition (P3), the aforementioned set is unbalanced and so it quickly follows that
$v_p(u_n)\neq 0$.


\subsection{Concluding the proof of \autoref{theo-decide-quad}}
\label{subsec-conclud}
Finally, let us return to the decidability of the Membership Problem in the setting of \autoref{theo-decide-quad}.
By our standing assumption that all instances of the problem are normalised we have that $t\neq 0$.  We have exhibited a bound $B$ such that for all $n>B$ there exists a prime $p>3Mn$
such that $v_p(u_n)\neq 0$.  This means that if $p_0$ is the largest prime such that $v_{p_0}(t)\neq 0$ then
for $n>\max\left(B,\frac{p_0}{3M}\right)$ we have $u_n\neq t$.
Thus we have reduced the Membership Problem in this setting to a finite search problem.
This immediately establishes decidability and concludes our proof of \autoref{theo-decide-quad}.

We illustrate the construction underlying   \autoref{theo-decide-quad} with a worked example.



\begin{example} \label{ex:example2}
Let $\langle u_n \rangle_{n=0}^\infty$ be the hypergeometric sequence defined by the recurrence
\begin{equation*}
f(n)u_{n} - g(n)u_{n-1} = 0 \quad \text{with} \quad u_0=1,
 \end{equation*}
where
 \(f(x) :=  x^2 -x -1\) and \(g(x) :=  x^2 + 2x - 4\).



The polynomials  $f$ and $g$ both have
splitting field $\K = \Q(\sqrt{5})$, with  ring of integers $\Z[\frac{\sqrt{5} - 1}{2}]$. Define $\theta := \frac{\sqrt{5} - 1}{2}$, and write $m_\theta(x) = x^2 + x - 1$ for its minimal polynomial.

Since $f=(x-\theta-1)(x+\theta)$ and $g=(x-2\theta)(x+2\theta+2)$,
the set of roots of $fg$ is
$\mathcal{R} = \{\theta + 1, -\theta,  2\theta, -2\theta-2\}$. The definition of the linear ordering $\prec$ on $\mathcal{R}$ 
 (see Section~\ref{subsec-partition-roots}) yields
\[ \theta + 1 \prec 2\theta \prec -2\theta-2 \prec -\theta \, ,\]
with the least unbalanced class being $\mathcal{C}_0 := \{\theta + 1\}$.
Define $M := 4$, which is an upper bound on $\{|a|,|b|: a \theta+b\in 
\mathcal{R}\}$ and the heights of $f$ and $g$ (which are the respective minimal polynomials of the elements of $\mathcal{R}$). 

Write $p_0$ for the largest prime such that $v_{p_0}(t) \neq 0$.
 By \Cref{theo:bigprimespolyT}, there is a bound $B> 3M(M+1)$ such that for all $n > \max(B, \frac{p_0}{3M})$,  there is a prime $p$ with $v_p(u_n) \neq v_{p}(t)$. 
This permits us to reduce  the Membership Problem for \(\langle {u_n}\rangle_{n=0}^{\infty}\)  and $t$ to a finite search problem. 

Given a target $t$ and sufficiently large $n$, the process in the proof of \Cref{theo-decide-quad} 
finds a prime $p$ with 
$v_p(u_n)\neq v_p(t)$.  Below we illustrate the idea of the proof
in the specific case 
$t=\frac{11}{59}$ and $n=61$.  (Here we have $p_0=59$ and hence  $n>3M(M+1)$ and $n>\frac{p_0}{3M}$, as required in the proof of Theorem~\ref{theo-decide-quad}.) We will establish the existence of a  
 prime $p$ such that 
\(v_p(u_{61})\neq 0\) \text{and}  \(v_p(t)=0\),
witnessing that $u_{61} \neq t$.


Guided by the proof of  \Cref{theo:bigprimespolyT}, we observe that prime $p:=1481 > 3n M$ is a divisor of 
\[ \prod_{\substack{k\in I(61)\\ k \in 2\N+1}} k^2-\beta=(75^2 - 5)(77^2 - 5) \cdots(91^2-5).\]
In particular, we have $p|(77^2-5)$.
Choosing $\theta':=\frac{77-1}{2}=38$, we observe that
the pair  $p$ and $\theta'
$ satisfy conditions (P1)-(P3) in Section~\ref{subsec-thre}:
\begin{enumerate}
   \item[(P1)] $m_\theta(\theta')=38^2+38-1\equiv 0\pmod{p}$;
   \item[(P2)] 
The map 
$\varphi:\mathcal{R}\rightarrow \Z/p\Z$  is an order embedding of $(\mathcal{R},\prec)$
into $(\{0,\ldots,p-1\},<)$,  which can be seen  by noting that
\begin{align*}
  \varphi(\theta + 1) = 39 \qquad & \qquad  \varphi(2\theta) = 76\\
  \varphi(-2\theta -2) = 1403 \qquad & \qquad  \varphi(-\theta) = 1443 ,
\end{align*}
whence $\varphi(\theta + 1)  <  \varphi(2\theta) <  \varphi(-2\theta -2) <  \varphi(-\theta)$.
 \item[(P3)] The set $\{\alpha \in \mathcal{R}:1\leq \varphi(\alpha) \leq 61\} = \{\theta+1\}$ is unbalanced.
\end{enumerate}

By the  arguments above, in the equation
\[ v_p(u_{61}) = \sum_{k=1}^{61} (v_p(g(k))-v_p(f(k))),\]
the only non-zero term on the right-hand side is
\[ v_p(f(\varphi(\theta + 1))) = v_p(f(39)) = v_p(1481) = 1.\]
It follows that $v_p(u_{61}) = -1$, while
$v_p(t)=0$.



 




\end{example}

