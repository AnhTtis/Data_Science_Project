\newpage
\section{Numerical method for parallel dynamics}
\label{apx:numerics1d}

Dynamics parallel to the magnetic field are solved using a
2$^{nd}$-order slope-limiter method, briefly described in
section~\ref{sec:finite_differencing}.  For any number of fluids we
solve the number density $n$, momentum along the magnetic field,
$mnv_{||}$, and either pressure $p$ or energy $\mathcal{E}$. Here $m$
is the particle mass, so that $mn$ is the mass density. $v_{||}$ is
the component of the flow velocity in the direction of the magnetic
field, and is aligned with one of the mesh coordinate directions.  All
quantities are cell centered.

Cell edge values are by default reconstructed using a MinMod method
(other limiters are available, including 1st-order upwind, Monotonized
Central, and Superbee). If $f_i$ is the value of field $f$ at the
center of cell $i$, then using MinMod slope limiter the gradient $g$
inside the cell is:
\begin{equation}
g_i = \left\{\begin{array}{ll}
  0 & \textrm{if $\left(f_{i+1} - f_{i}\right) \left(f_{i} - f_{i-1}\right) < 0$} \\
  f_{i+1} - f_{i} & \textrm{if $\left|f_{i+1} - f_{i}\right| < \left|f_{i} - f_{i-1}\right|$} \\
  f_{i} - f_{i-1} & \textrm{Otherwise}
\end{array}\right.
\end{equation}
The values at the left and right of cell $i$ are:
\begin{align}
f_{i, R} &= f_i + g_i / 2 \nonumber \\
f_{i, L} &= f_i - g_i / 2
\end{align}
This same reconstruction is performed for $n$, $v_{||}$ and $p$ (or
$\mathcal{E}$).  The flux $\Gamma_{i+1/2}$ between cell $i$ and $i+1$
is:
\begin{equation}
\Gamma_{f, i+1/2} = \frac{1}{2}\left(f_{i,R} v_{||i,R} + f_{i+1,L}v_{||i+1,L}\right) + \frac{a_{max,i+1/2}}{2}\left(f_{i,R} - f_{i+1,L}\right)
\end{equation}
This includes a Lax flux term that penalises jumps across cell edges,
and depends on the maximum local wave speed, $a_{max}$. Momentum is
not reconstructed at cell edges; Instead the momentum flux is
calculated from the cell edge densities and velocities:
\begin{equation}
\Gamma_{nv, i+1/2} = \frac{1}{2}\left(n_{i,R} v_{||i,R}^2 + n_{i+1,L}v_{||i+1,L}^2\right) + \frac{a_{max,i+1/2}}{2}\left(n_{i,R}v_{||i,R} - n_{i+1,L}v_{||i+1,R}\right)
\end{equation}

The wave speeds, and so $a_{max}$, depend on the model being solved,
so can be customised to e.g include or exclude Alfv\'en waves or
electron thermal speed. For simple neutral fluid simulations it is:
\begin{equation}
a_{max, i+1/2} = \max\left(\left|v_{||i}\right|, \left|v_{||i+1}\right|, \sqrt{\frac{\gamma p_{i}}{mn_i}}, \sqrt{\frac{\gamma p_{i+1}}{mn_{i+1}}}\right)
\end{equation}

The divergence of the flux, and so the rate of change of $f$ in cell
$i$, depends on the cell area perpendicular to the flow, $A_i$, and cell volume $V_i$:
\begin{equation}
\nabla\cdot\left(\mathbf{b} f v_{||}\right)_{i} = \frac{1}{V_i}\left[\frac{A_{i} + A_{i+1}}{2}\Gamma_{f, i+1/2} - \frac{A_{i-1} + A_{i}}{2}\Gamma_{f, i-1/2}\right]
\end{equation}

\subsection{Boundaries}

At boundaries along the magnetic field the flow of particles and
energy are set by e.g.  Bohm sheath boundary conditions or no-flow
conditions. To ensure that the flux of particles is consistent with
the boundary condition imposed at cell boundaries, fluxes of density
$n$ and also $p$ or $\mathcal{E}$ are set to the simple mid-point
flux:
\begin{equation}
\Gamma_{f, i+1/2}^{boundary} = f_{i+1/2}v_{||i+1/2}
\end{equation}
where $f_{i+1/2} = \frac{1}{2}\left(f_{i} + f_{i+1}\right)$ and
$v_{||i+1/2} = \frac{1}{2}\left(v_{||i} + v_{||i+1}\right)$ are the
mid-point averages where boundary conditions are imposed.  It has been
found necessary to include dissipation in the momentum flux at the
boundary, to suppress numerical overshoots due to the narrow boundary
layers that can form:
\begin{equation}
\Gamma_{nv, i+1/2}^{boundary} = n_{i,R}v_{||i,R}v_{||i+1/2} + a_{max}\left[n_{i,R}v_{||i,R} - n_{i+1/2}v_{||i+1/2}\right]
\end{equation}
where $n_{i+1/2} = \frac{1}{2}\left(n_{i} + n_{i+1}\right)$.

\section{Plasma and neutral atom transport equations}
\label{sec:equations}

The equations solved in 1D in section~\ref{sec:1d-transport} and in 2D
in section~\ref{sec:applications-2d} are detailed here for
completeness.  A total of seven spatially varying quantities are
evolved in time: The deuterium ion and atom densities ($n_{d+}$ and
$n_d$); the flow of ions and atoms parallel to the magnetic field
($v_{||,d+}$ and $v_{||,d}$); and the pressure of the ions, atoms, and
electrons ($p_{d+}$, $p_{d}$ and $p_e$). SI units are used except
temperatures, which are in eV. In a 1D domain
(section~\ref{sec:1d-transport}) the anomalous diffusion terms are
omitted and all derivatives perpendicular to the magnetic field are
assumed to be zero.

The equations for the deuterium ion species density $n_{d+}$,
parallel velocity $v_{||,d+} \equiv \mathbf{b}\cdot\mathbf{v}_{d+}$ and
pressure $p_{d+} = en_{d+}T_{d+}$ are:
\begin{subequations}
\begin{align}
  \frac{\partial}{\partial t}n_{d+} =& -\nabla\cdot\left[\left(\mathbf{b}v_{||,d+} + \mathbf{v}_{\perp,d+}\right)n_{d+}\right] + R_{iz} - R_{rc} \\
  \frac{\partial}{\partial t}\left(m_{d+}n_{d+}v_{||,d+}\right) =& -\nabla\cdot\left[\left(\mathbf{b}v_{||,d+} + \mathbf{v}_{\perp,d+}\right)m_{d+}n_{d+}v_{||,d+}\right] -\mathbf{b}\cdot\nabla p_{d+} \nonumber \\
  & + en_{d+}E_{||} + R_{cx}m_d\left(v_{||,d} - v_{||,d+}\right) \nonumber \\
  & - R_{rc}m_dv_{||,d+} + R_{iz}m_dv_{||,d} \\
  \frac{\partial}{\partial t}\left(\frac{3}{2}p_{d+}\right) =& -\nabla\cdot\left[\left(\mathbf{b}v_{||,d+} + \mathbf{v}_{\perp,d+}\right)\frac{5}{2}p_{d+}\right] + v_{||,d+}\mathbf{b}\cdot\nabla p_{d+} \nonumber \\
  &+ \nabla\left(\mathbf{b}\kappa_{||,d+}\mathbf{b}\cdot\nabla T_{d+}\right) + \nabla\cdot\left(\chi_{d+}n_{d+}\nabla_\perp T_{d+}\right) \nonumber \\
  &+ \frac{1}{2}m_d \left(R_{cx} + R_{iz}\right) \left(v_{||,d} - v_{||,d+}\right)^2  \nonumber \\
  &+R_{iz}\frac{3}{2}eT_d - R_{rc}\frac{3}{2}eT_{d+} + W_{d+,e}
\end{align}
\end{subequations}
where $\mathbf{b} = \mathbf{B}/B$ is the unit vector in the direction
of the magnetic field, and the gradient in the plane perpendicular to
the magnetic field is $\nabla_\perp \equiv \nabla -
\mathbf{b}\mathbf{b}\cdot\nabla$. Particle diffusion across the
magnetic field is implemented as a cross-field ion drift velocity
$\mathbf{v}_{\perp,d+}$ with diffusion coefficient $D$:
\begin{equation}
  \mathbf{v}_{\perp,d+} = -D\frac{1}{n_{d+}}\nabla_\perp n_{d+}
\end{equation}
The charge exchange (CX), ionization (IZ) and recombination (RC)
reactions between species have rates (events per m$^3$ per second):
\begin{subequations}
\begin{align}
  R_{cx} =& n_{d+}n_d\left<\sigma v\right>_{cx} \\
  R_{iz} =& n_en_d\left<\sigma v\right>_{iz} \\
  R_{rc} =& n_en_{d+}\left<\sigma v\right>_{rc}
\end{align}
\end{subequations}
where the Maxwellian-averaged cross sections $\left<\sigma v\right>$
are taken from Amjuel~\cite{amjuel}, specifically Amjuel reaction H.4
2.1.5 (ionisation), H.4 2.1.8 (recombination) and H.3 3.1.8 (charge
exchange).  Hydrogenic charge-exchange reactions are adjusted for
isotope mass, ion and neutral temperatures by calculating an effective
temperature $T_{eff} = T_{atom} / A_{atom} + T_{ion} / A_{ion}$ as
described in the Amjuel manual.

There is a transfer of thermal energy to ions from electrons due to
collisions, $W_{d+,e}$:
\begin{equation}
W_{d+,e} = 3\nu_{d+,e}n_{d+}\frac{m_{d+}}{m_{d+} + m_e}e\left(T_e - T_{d+}\right)
\end{equation}
with ion-electron collision frequency $\nu_{d+,e} = \nu_{e,d+}m_e / m_{d+}$.

The electron density $n_e = n_{d+}$ is set by quasineutrality; the
electron parallel velocity $v_{||,e} = v_{||,d+}$ from assuming that
the parallel current is zero (Note that this is a choice in this
particular model, not a general feature of Hermes-3).  The electron
pressure equation is:
\begin{subequations}
  \begin{align}
    \frac{\partial}{\partial t}\left(\frac{3}{2}p_e\right) =& -\nabla\cdot\left[\left(\mathbf{b}v_{||,e} + \mathbf{v}_{\perp,d+}\right)\frac{5}{2}p_e\right] + v_{||,e}\mathbf{b}\cdot\nabla p_e \nonumber \\
    &+ \nabla\left(\mathbf{b}\kappa_{||,e}\mathbf{b}\cdot\nabla T_e\right) + \nabla\cdot\left(\chi_een_e\nabla_\perp T_e\right) \nonumber \\
    & - E_{iz} + E_{rc} - W_{d+,e}
  \end{align}
\end{subequations}
where $E_{iz}$ and $E_{rc}$ are the energy cost and gain due to
ionization and recombination atomic processes respectively. These are
calculated using Amjuel~\cite{amjuel}, reactions 2.1.5 and 2.1.8.
Ionization always removes energy from the electrons; Recombination may
be either a source or sink of electron energy, depending on the
temperature and density.  Electron force balance is used to calculate
the parallel electric field $E_{||} \equiv \mathbf{b}\cdot\mathbf{E}$
and so transfer electron pressure $p_e$ forces to the ions:
\begin{equation}
  en_eE_{||} = -\mathbf{b}\cdot\nabla p_e -\nabla\cdot\left[\mathbf{v}_{\perp,d+} m_en_ev_{||,e}\right]
\end{equation}

The equations for the neutral deuterium atom density $n_d$, parallel
velocity $v_{||,d}$ and pressure $p_d = en_dT_d$ are:
\begin{subequations}
  \begin{align}
    \frac{\partial}{\partial t}n_d =& -\nabla\cdot\left[\left(\mathbf{b}v_{||,d} + \mathbf{v}_{\perp,d}\right)n_d\right] - R_{iz} + R_{rc}  \\
    \frac{\partial}{\partial t}\left(m_dn_dv_{||,d}\right) =& -\nabla\cdot\left[\left(\mathbf{b}v_{||,d} + \mathbf{v}_{\perp,d}\right)m_dn_dv_{||,d}\right] -\mathbf{b}\cdot\nabla p_d \nonumber \\
    &- R_{cx}m_d\left(v_{||,d} - v_{||,d+}\right) + R_{rc}m_dv_{||,d+}\nonumber \\
    & - R_{iz}m_dv_{||,d} \\
    \frac{\partial}{\partial t}\left(\frac{3}{2}p_d\right) =& -\nabla\cdot\left[\left(\mathbf{b}v_{||,d} + \mathbf{v}_{\perp,d}\right)\frac{5}{2}p_d\right] + v_{||,d}\mathbf{b}\cdot\nabla p_d \nonumber \\
    &+ \nabla\left(\kappa_d \nabla T_d\right) + \frac{1}{2}m_d\left(R_{cx} + R_{rc}\right)\left(v_{||,d} - v_{||,d+}\right)^2 \nonumber \\
    &-R_{iz}\frac{3}{2}eT_d + R_{rc}\frac{3}{2}eT_{d+}
  \end{align}
\end{subequations}
The flow of neutral atoms across the magnetic field,
$\mathbf{v}_{\perp,d}$, is derived by balancing friction forces
against pressure gradient~\cite{rognlien-2002}:
\begin{equation}
  \mathbf{v}_{\perp,d} = - \frac{T_d}{m_d \nu_d p_d}\nabla_\perp p_d
\end{equation}

The thermal conduction coefficients for each species are:
\begin{equation}
  \kappa_{||,d+} = 3.9 \frac{p_{d+}}{m_{d+}\nu_{d+}} \qquad \kappa_{||,e} = 3.16 \frac{p_e}{m_e\nu_e} \qquad  \kappa_d = \frac{p_d}{m_d \nu_d}
\end{equation}
The collision frequencies for each species, $\nu_{d+}$, $\nu_e$ and $\nu_d$, are:
\begin{subequations}
  \begin{align}
    \nu_{d+} =& \nu_{d+,d+} + \frac{m_e}{m_{d+}}\nu_{e,d+} + n_d\left<\sigma v\right>_{cx} \\
    \nu_e =& \nu_{e,d+} + \nu_{e,e} \\
    \nu_d =& n_{d+}\left<\sigma v\right>_{cx} + n_da_0\sqrt{2eT_d/m_d}
  \end{align}
\end{subequations}
The collision frequency of charged species $a$ on charged species $b$
is given by~\cite{hinton1984}:
\begin{equation}
\nu_{a,b} = \frac{q_aq_b n_b \log\Lambda\left(1 + m_a/m_b\right)}{3\pi^{3/2}\epsilon_0^2m_a^2\left(v_a^2 + v_b^2\right)^{3/2}}
\end{equation}
with $v_a^2 = 2T_a/m_a$.
Neutral-neutral collisions assume a kinetic diameter of $2.8\times
10^{-10}$m (cross-section $a_0 = 2.5\times 10^{-19}$m$^2$), chosen
based on typical values for species considered ($2.89\times 10^{-10}$m
for H$_2$, $2.60\times 10^{-10}$m for He, $2.75\times 10^{-10}$m for
Ne~\cite{Wikipedia-kinetic-diameter}).

The Coulomb logarithm is different for electron-electron, ion-ion and
electron-ion species interactions, and is calculated using the NRL
formulary~\cite{Huba2013} (page 34). Converted to SI units with $T$ in
eV the Coulomb logarithms are:
\begin{subequations}
  \begin{align}
    \log \Lambda_{e,e} =& 30.4 - 0.5\log n_e + \frac{5}{4}\log T_e - \sqrt{\epsilon + \left(\log T_e - 2\right)^2/16} \\
    \log \Lambda_{e,i} =& \left\{\begin{array}{c c}
    31 - 0.5\log n_e + \log T_e & \textrm{if } T_i\frac{m_e}{m_i} < 10Z_i^2 < T_e \\
    30 - 0.5\log n_e - \log Z_i + 1.5\log T_e & \textrm{if } T_i \frac{m_e}{m_i} < T_e < 10Z_i^2 \\
    23 - 0.5\log n_i + 1.5 \log T_i - \log\left(Z_i^2 A_i\right) & \textrm{if } T_e < T_i m_e / m_i
    \end{array}\right. \label{eq:lambda_ei} \\
    \log \Lambda_{i,i} =& 29.91 - \log\left[\frac{Z_1 Z_2\left(A_1 + A_2\right)}{A_1 T_2 + A_2 T_1}\sqrt{n_1Z_1^2/T_1 + n_2 Z_2^2 / T_2}\right]
  \end{align}
\end{subequations}
Note that earlier versions of the NRL formulary had a factor of
$A_i^{-1}$ rather than $A_i$ in equation~\ref{eq:lambda_ei}.
