\documentclass[preprint,12pt]{elsarticle}

\usepackage{amssymb}

\usepackage[utf8]{inputenc}
\usepackage{hyperref}
\usepackage[nottoc,numbib]{tocbibind}
\usepackage{setspace}
\usepackage{booktabs}

\usepackage{listings}
\usepackage{xcolor}

\usepackage{caption}
\usepackage{subcaption}

\usepackage{amsmath}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\newcommand{\qpligature}{\ensuremath{\reflectbox{\text{P}}\mkern-6mu\text{P}}}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{blue},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
\lstset{style=mystyle}

\lstdefinelanguage{Ini}{
    basicstyle=\ttfamily\small,
    columns=fullflexible,
    morecomment=[s][\color{codegreen}\bfseries]{[}{]},
    morecomment=[l]{\#},
    morecomment=[l]{;},
    commentstyle=\color{gray}\ttfamily,
    morekeywords={},
    otherkeywords={=,:},
    keywordstyle={\color{green}\bfseries}
}

\journal{Comp. Phys. Comm.}

%\usepackage{draftwatermark}
%\SetWatermarkText{DRAFT}
%\SetWatermarkScale{5}

\begin{document}

\begin{frontmatter}
\title{Hermes-3: Multi-component plasma simulations with BOUT++}

\author[llnl]{Ben Dudson}
\author[york]{Mike Kryjak}
\author[york,ccfe]{Hasan Muhammed}
\author[york]{Peter Hill}
\author[ccfe]{John Omotani}

\affiliation[llnl]{organization={Lawrence Livermore National Laboratory},
            addressline={7000 East Avenue},
            city={Livermore},
            postcode={94550},
            state={CA},
            country={USA}}

\affiliation[york]{organization={School of Physics, Engineering and Technology, University of York},
            addressline={Heslington},
            city={York},
            postcode={YO10 5DD},
            country={UK}}

\affiliation[ccfe]{organization={United Kingdom Atomic Energy Authority},
            addressline={Culham Centre for Fusion Energy, Culham Science Centre},
            city={Abingdon},
            postcode={OX14 3DB},
            country={UK}}

\begin{abstract}
  A new open source tool for fluid simulation of multi-component
  plasmas is presented, based on a flexible software design that is
  applicable to scientific simulations in a wide range of fields. This
  design enables the same code to be configured at run-time to solve
  systems of partial differential equations in 1D, 2D or 3D, either
  for transport (steady-state) or turbulent (time-evolving) problems,
  with an arbitrary number of ion and neutral species.

  To demonstrate the capabilities of this tool, applications relevant
  to the boundary of tokamak plasmas are presented: 1D simulations of
  diveror plasmas evolving equations for all charge states of neon and
  deuterium; 2D transport simulations of tokamak equilibria in
  single-null X-point geometry with plasma ion and neutral atom
  species; and simulations of the time-dependent propagation of plasma
  filaments (blobs).

  Hermes-3 is publicly available on Github under the GPL-3 open source
  license.  The repository includes documentation and a suite of unit,
  integrated and convergence tests.
\end{abstract}

\begin{keyword}
%% keywords here, in the form: keyword \sep keyword

plasma \sep simulation \sep tokamak \sep BOUT++

%% PACS codes here, in the form: \PACS code \sep code

%% MSC codes here, in the form: \MSC code \sep code
%% or \MSC[2008] code \sep code (2000 is the default)

\end{keyword}

\end{frontmatter}

{\bf PROGRAM SUMMARY}

\begin{small}
\noindent
{\em Program Title:} Hermes-3  \\
{\em CPC Library link to program files:}  \\
{\em Developer's repository link:} https://github.com/bendudson/hermes-3 \\
{\em Code Ocean capsule:} \\
{\em Licensing provisions:} GPLv3 \\
{\em Programming language:} C++14 \\
{\em Nature of problem:}
Simulation of dynamics and steady-state solutions of multiple ion and neutral species
in magnetised plasmas using drift-reduced fluid plasma models in 1 to 3 spatial dimensions. 
Focused on but not restricted to the simulation of turbulence in the boundary of tokamaks. \\
{\em Solution method:}
Hermes-3 implements a system of flexible software components, that are configured
at run-time and coupled by passing a state object between them (the Encapsulate State
and Command patterns). Hermes-3 builds on BOUT++ [1], employing the Method of Lines
with implicit and explicit time-integration methods in curvilinear coordinates on block-structured
meshes, making use of libraries including SUNDIALS, PETSc and Hypre.
Hermes-3 implements drift-reduced plasma fluid equations using conservative finite difference methods,
and atomic processes that couple plasma and neutral fluids.
\begin{thebibliography}{0}
\bibitem{1} B.D.Dudson et al. CPC 180, 1467-1480 (2009)
\end{thebibliography}
\end{small}

\section{Introduction}
\label{sec:introduction}

An important feature of magnetically confined fusion plasmas in
tokamaks is that they consist of a mixture of different ion
species. Computational studies of fusion plasma phenomena, such as
plasma turbulence, have to date frequently treated plasmas as if they
consisted of a single ion species, typically deuterium due to its use
in experiments. In order to make predictions of phenomena important to
the performance and design of the divertor of future fusion reactors,
models must capture the interactions between plasma and neutral gas
species (deuterium and tritium in a reactor), as well as radiation
from impurity species (eg. Be, C, Ne, Ar, W), and pumping of helium
``ash'' and other species.  In many cases none of these species can be
treated as ``trace'' but are all coupled, so that all should be
considered self-consistently in the same simulation. For each of these
atomic species the density and dynamics of multiple states may need
to be considered, for example the ground state, multiple ionisation
stages, and molecular species. In some cases it may also be necessary
to track metastable states, such as vibrationally excited states or
charged molecules. The result is a potentially large number of species
types which must be solved for, together with a complex set of
reactions between them.

Historically there has been a division in terms of simulation tools
and to an extent also research communities, between multi-fluid
transport codes such as SOLPS~\cite{schneider-2006},
UEDGE~\cite{rognlien-2002}, EDGE2D~\cite{simonini-1994} and
BOUT++/trans-neut~\cite{wang2014}, which employ simplified models for
the cross-field transport (typically diffusive) but evolve many
different species, and the turbulence codes including
GBS~\cite{giacomin2021,halpern2016,ricci2012},
TOKAM3X~\cite{tamain2010,tamain2016}, (H)ESEL~\cite{madsen2016a}, and
various models built on
BOUT++~\cite{Dudson2009,dudson2015,bout:manual} such as
Hermes~\cite{Dudson2017} and STORM~\cite{easy2014,ukaea:storm}. These
latter models can solve for the 3D time-varying turbulent transport,
but typically only evolve a single ion species. During the last 5
years, and currently ongoing, are several efforts
(e.g.~\cite{BUFFERAND201982, coroado2021, shrish2021}) to develop codes which can solve for the
turbulent transport self consistently with multiple ion and neutral
gas species~\cite{LEDDY2017994}.

If the number of species states to be solved for is relatively small,
such as electrons, ions and a single atomic species as in
Hermes-2~\cite{dudson:hermes2} and recent versions of
STORM~\cite{ukaea:storm}, then code can be written for each
species. Unfortunately with this design the size of the code (number
of lines) grows linearly with the number of species states, becoming
increasingly error prone, difficult to test, and hard to maintain, as
the number of species is increased. The authors' experience with
Hermes-2 indicated that this was not a viable path to multi-species
simulations.

Here an open-source multi-fluid plasma simulation tool is presented,
along with the flexible software design which makes the resulting
model and software complexity manageable.  It is built on BOUT++,
which provides low-level data management and operations, and augments
this with a reusable model component system. By doing this we unify 1D
tokamak divertor simulation code SD1D~\cite{dudson2019} with 2D and 3D
transport and turbulence code Hermes~\cite{Dudson2017}, and enable
these tools to be extended towards multiple ion species simulations
that self-consistently include both plasma turbulence and transport
(atomic) physics.

In section~\ref{sec:numerical} the numerical methods are described; in
section~\ref{sec:software} the software architecture is outlined and
compared to prior work; and in section~\ref{sec:applications} a series
of applications are presented, which demonstrate some of the
capabilities of the new code. We conclude in section~\ref{sec:conclusions}.

\input{content/numerics}
\input{content/software}
\input{content/applications}

\section{Conclusions}
\label{sec:conclusions}

Advancing understanding of the physics of the edge of tokamak plasmas
drives the need for increasingly complex models. To address this need
a new open-source plasma simulation tool has been developed that
enables researchers to perform complex multi-species plasma
simulations by combining reusable software components. This is
achieved by building on the BOUT++ framework of partial differential
equation solvers, and defining a flexible yet robust method of
coupling components together within a parallelised high-performance
code.

Applications of this tool to simulations of tokamak plasmas have been
demonstrated: Time dependent simulations of plasma filament/blob
propagation and steady-state transport including atomic
reactions. Convergence tests and comparisons to analytic solutions
have been carried out, demonstrating good conservation properties and
convergence of the methods. The public Git repository includes a suite
of unit, integrated and Method of Manufactured Solutions (MMS) tests
that are used routinely to check the correctness of code changes.

Areas for future development and research have been identified:
Extending the steady state solver implemented using PETSc from 1D
transport problems (section~\ref{sec:1d-transport}) to 2D is a high
priority, as is benchmarking of Hermes-3 against other codes for both
transport and turbulence applications. These efforts have begun and
will be reported elsewhere once completed.

Hermes-3 is publicly available~\cite{dudson:hermes3} on Github under a
GPL-3 license. To maximise its utility to the plasma community a set
of examples are included, and a manual~\cite{dudson:hermes3-manual}
provides an introduction for new users.

\section*{Acknowledgements}

This work was in part performed under the auspices of the U.S. DoE by
LLNL under Contract DE-AC52-07NA27344, and received funding from LLNL
LDRD 23-ERD-015. B.Dudson would like to thank Dr. Wayne Arter (CCFE)
for useful discussions and suggestions. The Hermes-3 source code,
simulation inputs, and processing scripts needed to reproduce the
results shown in this paper are available at
\url{https://github.com/bendudson/hermes-3}, Git commit
\texttt{5f56919} (Version 1.1.0). LLNL-CODE-845139.

\clearpage
\bibliographystyle{elsarticle-num}
\bibliography{bibliography}

\appendix

\input{content/appendix}

\end{document}
