
\section{Results and Analysis}

In the following section, we showcase our method's outputs both qualitatively and quantitatively with a variety of method and summary statistics. 

\begin{figure*}[t!]
\begin{center}
\centerline{\includegraphics[width=\textwidth]{images/N128/lin_128.png}}
\caption{Two-point correlation comparison between the original linear field (target) and the linear field predicted by our model (prediction). For an exact prediction, the variation of power with wavenumber should be exactly similar for both the fields, and the values of transfer function fractional error and stochasticity should be exactly zero. }
\label{lin}
\end{center}
\end{figure*}

\begin{figure*}[t!]
\begin{center}
\centerline{\includegraphics[width=\textwidth]{images/N128/dis_128.png}}
\caption{Two-point correlation comparison between the original nonlinear field (target) and the nonlinear field generated from the predicted linear field given by the inverse model. For an exact prediction, the variation of power with wavenumber should be exactly similar for both the fields, and the values of transfer function fractional error and stochasticity should be exactly zero.}
\label{dis}
\end{center}
\end{figure*}

\subsection{Qualitative Analysis}\label{sec:qualitative-analysis}

Figure \ref{slices} shows the $x,y, \text{and } z$ direction displacements for a $128\times128$ slice of the linear displacement field and the corresponding linear field predicted by our inverse model. %The original linear field was sampled using the cosmological parameters of the training data. \sh{a rewrite needed on the previous sentence... I don't actually understand what you are trying to say ...} 
Qualitatively, the predictions of our model match very well with the original linear field that we wanted to predict.

To further evaluate the quality of the prediction, we used the forward-direction emulator again to generate the nonlinear field when fed the predicted linear field. We qualitatively compare this regenerated nonlinear field with the original nonlinear field in Figure \ref{slices_dis}. We find these displacement fields match very nicely qualitatively. The residuals are also not significant (especially one should take into account that the color bar at the residual plot is approximately 10 times smaller). 


\subsection{One-Point Statistics}\label{sec:one-point-stat}

The initial conditions of the simulation are set up in Fourier space, with each mode of the displacement field drawn from a random Gaussian distribution with a variance determined by the linear power spectrum $P(k)$, which is determined by the cosmological parameters. This construction yields a coordinate-space displacement field that is also Gaussian, so its statistics are uniquely determined by the two-point correlation function, which is simply the Fourier transform of the power spectrum. To demonstrate that we have accurately recovered the initial conditions of the simulation we must show that the output of our model has both the correct power spectrum and that its statistical distribution is Gaussian.

We plot the histogram of probability density of the displacements of the particles for the original linear field and the one predicted by our model (Figure \ref{one_pt_128}). Each particle has three displacements corresponding to the $x,y,$ and $z$ directions. Since the linear fields are sampled from a Gaussian distribution determined by the cosmological parameters, we expect the distribution of displacements to match $\mathcal{N}(0,5.275)$ for the simulation setting with $128^3$ particles in a box size of 250 Mpc/$h$. Specifically, the variance of displacements along the $i^{\mathrm{th}}$ Cartesian direction is given by:
\begin{align}
    \label{eq:sigdis}
    \sigma_{i}^2 = \int \frac{\mathrm{d}k^3}{(2\pi)^3} \frac{(k^{i})^2}{k^4} P(k),
\end{align}
where the integral is over all wave vectors in Fourier space, $k\equiv|\vec{k}|$ is the magnitude of the wave vector and $k^{i}$ is its $i^{\mathrm{th}}$ component. We numerically evaluate this integral on a Fourier space grid with the same dimensions as the initial simulation grid.

From Figure \ref{one_pt_128} we see that the statistics of our model output agree well with the expected Gaussian distribution. The bin counts also match the particular realization from this distribution of the target data out to displacements of $\sim 10\ \mathrm{Mpc}/h$, or 2$\sigma_i$. Extremely large displacements indicate a particle either flowing outwards in a rare, extremely underdense environment or inwards towards a rare, high-density peak. Based on the residuals, we see that the tails of the distribution predicted by the model are somewhat smaller than the target data, indicating the model misplaces these particles. This is unsurprising due both to the rarity of these trajectories and to the fact that these particles are the most affected by extreme non-linearities in their environments, which exacerbates the one-to-many problem.


\begin{figure}[h!]
\begin{center}
\centerline{\includegraphics[width=\columnwidth]{images/N128/one_pt_128.png}}
\caption{Distribution of the displacements of particles for a given linear field and the corresponding linear field predicted by our model. The distribution has been calculated by considering the $x,y, \text{and } z$ displacements of $128^3$ particles. Relative error denotes the relative errors in probability density for different bins.}
\label{one_pt_128}
\end{center}
\end{figure}


\subsection{Two-Point Correlation Comparison}\label{sec:two-point-corr}
The displacement power spectrum for a displacement field $\mathbf{\Psi}$ for wavenumber $k$ is defined as 
\begin{align}
    P(k) = \sum_{i \in \{x,y,z\}}\langle\mathbf{\Psi}_i(k)\mathbf{\Psi}_i(k)\rangle.
\end{align}

Using this definition of power spectrum in the Fourier space, we can now define the transfer function as
\begin{align}
    T(k) = \sqrt{P(k)},
\end{align}
and the correlation coefficient as 
\begin{align}
    r(k) = \frac{P_{pred \times true}(k)}{\sqrt{P_{pred}(k)P_{true}(k)}},
\end{align}
where $P_{pred}(k)$ is the displacement power spectrum predicted by our neural network, $P_{true}(k)$ is the ground truth power spectrum, and $P_{pred \times true}(k)$ is the cross power spectrum between the predicted and the ground truth fields. Using these two quantities, we define the transfer function fractional error,
\begin{align}
    \frac{\Delta T(k)}{T(k)} = \sqrt{\frac{P_{pred}(k)}{P_{true}(k)}}-1, 
\end{align}
to measure the discrepancy between amplitudes of the predicted and the true fields. We also define stochasticity,
\begin{align}
    1 - r^2(k) = 1 - \frac{P^2_{pred \times true}(k)}{{P_{pred}(k)P_{true}(k)}},
\end{align}
to capture the excess fraction of correlation in the prediction of our model that cannot be accounted for in the target data. For an ideal match between the target and the predicted field, the values of both these quantities should be exactly zero. Figure \ref{lin} shows the performance of our model in terms of these quantities for an original linear displacement field and its corresponding predicted linear field. We see that from large scales down to scales where $k\simeq0.5~\mathrm{Mpc}^{-1}~h$ the model achieves percent-level accuracy for both the transfer functions and stochasticities. Note that non-linearities become important at scales where $k > 0.1~\mathrm{Mpc}^{-1}~h$, so the model is able to accurately learn the inverse mapping even in the moderately nonlinear regime for in-distribution fields.

To further test the reliability of our model, we generated the nonlinear displacement field from our predicted linear field by using the forward direction emulator \cite{jamieson}. Since the mapping from the nonlinear displacement field to the linear displacement field is one-to-many, it becomes critical to see that the nonlinear field which gets generated from our predicted linear field matches the actual nonlinear field. Figure \ref{dis} shows the power spectra comparison between these two nonlinear displacement fields. We see that there is an excellent match between the powers of the two fields. The transfer function fractional errors and the stochasticity plots show a good match for large to medium scales ($k < 0.5~\mathrm{Mpc}^{-1}~h$). 


\subsection{Out-Of-Distribution Evaluation}\label{sec:ood}


Given that our model has been trained on simulations generated by a neural network emulator \cite{jamieson} with fixed cosmological parameters ($\Omega_m = 0.300, \Omega_b = 0.050, h = 0.700, n_s = 0.965, \sigma_8 = 0.799$), there is a legitimate concern about its ability to generalize to actual N-body simulations with different sets of cosmological parameters. In order to assess this out-of-distribution (OOD) performance, we have conducted a series of experiments on simulations from the Quijote suite \cite{villaescusa}.

The Quijote suite comprises 2000 linear and nonlinear fields, each consisting of $512^3$ particles that are uniformly distributed in a cube with a side length of $1000\ \mathrm{Mpc}/h$. To quantify the dissimilarity between these simulations and our training data, we rank them based on the sum of their relative percentage differences in $\Omega_m$ and $\sigma_8$ from our training values, since these two parameters have the most significant impact on the simulated distributions. This dissimilarity metric is then used to evaluate the model's performance on different percentiles, with the 100th percentile simulation representing the one on which we expect our model to perform the worst. Notably, our model's performance is unaffected by changes in the box size, as long as the mean particle density remains constant.

In order to evaluate the model's performance on out-of-distribution (OOD) Quijote simulation data, we qualitatively compare the $x, y, \text{and }z$ displacements of a $512 \times 512$ slice from the linear and nonlinear fields, similar to Section \ref{sec:qualitative-analysis}. The slices for the 0th percentile ($\Omega_m = 0.296, \Omega_b = 0.067, h = 0.523, n_s = 1.091, \sigma_8 = 0.806$) and the 20th percentile ($\Omega_m = 0.311, \Omega_b = 0.067, h = 0.673, n_s = 0.993, \sigma_8 = 0.977$) simulations are presented in Figures \ref{fig1:fields} and \ref{fig3:fields} respectively. Additionally, the one-point statistics for these simulations are provided in Figures \ref{one_pt_512_first} and \ref{one_pt_512_second}. It is worth mentioning that the Quijote simulations consist of $512^3$ particles in a box with a side length of $1000\ \mathrm{Mpc}/h$. Hence, based on Equation \ref{eq:sigdis}, the theoretical distributions for these simulations are $\mathcal{N}(0, 6.193)$ and $\mathcal{N}(0, 7.159)$ respectively. Furthermore, we present the two-point correlation comparisons for these simulations in Figures \ref{fig0:two_point} and \ref{fig2:two_point}.


For completeness, we present the results of our power spectra analysis of the actual linear field and our model's predictions for a range of percentiles of the dissimilarity metric in Figure \ref{ood_lin}. We are able to match the in-distribution performance for the 0th percentile simulation and we are able to do reasonably well for the 20th percentile simulation for medium scales. The performance gradually gets worse as we move towards the higher percentiles of the dissimilarity metric. Additionally, in Figure \ref{ood_dis}, we compare the actual nonlinear fields with the nonlinear fields generated by passing the output of our model through the forward direction emulator \cite{jamieson}. Once again, we see a good match for lower percentiles of the dissimilarity metric which progressively gets worse with increasing percentiles.



