\subsection{Density estimation and likelihood evaluation}
\label{sec:density}

It is well-known that the probability flow ODE can be used to solve the TE~\eqref{eq:transport}. Specifically we have
\begin{equation}
    \label{eq:te:sol}
    \rho_1(X_{t=1}) =  \exp\left( - \int_0^1 \nabla \cdot b_{\ODE}(t, X_t) dt \right) \rho_0( X_{t=0})
\end{equation}
For completeness, this equation is derived in Appendix~\ref{app:proof:generative}. If we solve  \eqref{eq:ode:1} backward in time from the final condition $\ X_{t=1}=x$, \eqref{eq:te:sol} allows us to express $\rho_1(x)$ at location $x$ in terms of $\rho_0(X_{t=0})$; conversely, if we solve  \eqref{eq:ode:1} forward in time from the initial condition $X_{t=0}=x$, \eqref{eq:te:sol} allows us to express $\rho_0(x)$ at location $x$ in terms of $\rho_1(X_{t=1})$.


Interestingly, we have  similar results using the SDE~\eqref{eq:sde:1} or the backward SDE~\eqref{eq:sde:R}, which show how to evaluate $\rho_0$ or $\rho_1$ at any $x\in {\RR^d}$ if we can evaluate  the other density:

\begin{restatable}{theorem}{FK}
    \label{prop:sde:rho}
    Let $\rho:$ be the PDF defined in~\eqref{eq:pdf:def:test}, and let $X^\fwd_t$ and $X^\rev_t$ be the solution of the SDE~\eqref{eq:sde:1} and the backward~\eqref{eq:sde:R}, respectively. Then:
    \begin{enumerate}[leftmargin=0.15in]
\item Assuming we can evaluate $\rho_0(x)$ at any any $x\in {\RR^d}$, $\rho_1(x)$ and its logarithm can also be estimated at any $x\in {\RR^d}$ using
\begin{equation}
    \label{eq:fk}
    \rho_1(x) = \EE_\rev^x \left(\exp\left(- \int_0^1\left(\nabla \cdot b_\fwd(t, X^\rev_t) + 2\epsilon|s(t, X_t^\rev)|^2\right) dt\right)  \rho_0(X_{t=0}^\rev)\right),
\end{equation}
and
\begin{equation}
    \label{eq:ito:rho:1:log:int}
    \begin{aligned}
    \log \rho_1(x) &= \EE^x_\rev\log \rho_0(X_{t=0}^\rev)- \int_0^1 \EE^x_\rev \left(\nabla \cdot b_\fwd(t, X^\rev_t) + \epsilon|s(t, X_t^\rev)|^2\right)dt,
    \end{aligned}
\end{equation}
where $\EE_\rev^x$ denotes expectation on the path of $X_t^\rev$ conditional on $X_{t=1}^\rev = x$.

\item Assuming we can evaluate $\rho_1(x)$ at any any $x\in {\RR^d}$, $\rho_0(x)$ and its logarithm can also be estimated at any $x\in {\RR^d}$ using
\begin{equation}
    \label{eq:fk:rev}
    \rho_0( x) = \EE_\fwd^x \left(\exp\left( \int_0^1\left(\nabla \cdot b_\rev(t, X^\fwd_t) - 2\epsilon|s(t, X^\fwd_t)|^2\right) dt\right)\rho_1(X^\fwd_{t=1})\right),
\end{equation}
and
\begin{equation}
    \label{eq:ito:rho:r:1:log:int}
    \begin{aligned}
    \log \rho_0(x) &= \EE_\fwd^x \log \rho_1(X^\fwd_{t=1}) + \int_0^1 \EE^x \left(\nabla \cdot b_\rev(t, X^\fwd_t) - \epsilon |s(t, X^\fwd_t)|^2\right) dt,
    \end{aligned}
\end{equation}
where $\EE_\fwd^x$ denotes expectation on the path of $X^\fwd_t$ conditional on $X^\fwd_{t=0} = x$.
\end{enumerate}
\end{restatable}

% Theorem~\ref{prop:sde:rho} can be used to estimate the Kullback-Leibler divergences from $\rho_0$ to $\rho_1$ and $\rho_1$ to $\rho_0$:
% \begin{corollary}
% \label{prop:kl}
% We have
% \begin{equation}
%  \label{eq:kl}
% D_{\text{KL}} (\rho_1|\rho_0)  = \EE_0 \EE^{x_0} \left(\log\rho_1(X_{t=1}) -\log \rho_0(X_{t=1})\right)
% \end{equation} 
% where $X_t$ is the solution to the SDE~\eqref{eq:sde:1}, $\EE^x$ denotes the expectation on $X_t$ conditional on $X_{t=0}=x_0$, and $\EE_0$ denotes the expectation on $x_0\sim\rho_0$. In~\eqref{eq:kl} we can use (from \eqref{eq:fk:rev})
% \begin{equation}
%     \label{eq:fk:rev:X1}
%     \log \rho_1(X_{t=1}) = \EE_\rev^{X_{t=1}} \log \rho_0(X_{t=0}^\rev)- \int_0^1 \EE_\rev^{X_{t=1}}\left(\nabla \cdot b(t, X^\rev_t) + \epsilon|s(t, X_t^\rev)|^2\right)dt, 
% \end{equation}
% where $\EE_\rev^{X_{t=1}}$ denotes expectation on the path of $X_t^\rev$ conditional on $X_{t=1}^\rev = X_{t=1}$. Similarly, we have
% \begin{equation}
%  \label{eq:kl:rev}
% D_{\text{KL}} (\rho_0|\rho_1)  = \EE_1 \EE_\rev^{x_1} \left(\log \rho_0(X^\rev_{t=0}) - \log\rho_1(X^\rev_{t=0})\right)
% \end{equation} 
% where $X^\rev_t$ is the solution to the SDE~\eqref{eq:sde:1}, $\EE_\rev^x$ denotes the expectation on $X^\rev_t$ conditional on $X^\rev_{t=1}=x_1$, and $\EE_1$ denotes the expectation on $x_1\sim\rho_1$. In~\eqref{eq:kl} we can use (from \eqref{eq:fk})
% \begin{equation}
%     \label{eq:fk:X0}
%     \rho_0(X^\rev_{t=0}) = \EE^{X^\rev_{t=0}}  \log \rho_1(X_{t=1}) + \int_0^1  \EE^{X^\rev_{t=0}}\left(\nabla \cdot b^\rev(t, X_t) - \epsilon |s(t, X_t)|^2\right) dt,
% \end{equation}
% where $\EE_\rev^{X^\rev_{t=0}}$ denotes expectation on the path of $X_t$ conditional on $X_{t=0}= X^\rev_{t=0}$.

% \end{corollary}


% Equations~\eqref{eq:kl} and \eqref{eq:fk:rev:X1} show that, if we can evaluate $\rho_0$ at any $x\in {\RR^d}$ and sample this density, we can estimate $D_{\text{KL}} (\rho_1|\rho_0)$ by the following algorithm:
% \begin{enumerate}[leftmargin=0.15in]
% \item generating $x_0\sim \rho_0$;
% \item propagating each of these $x_0$ forward in time using the SDE~\eqref{eq:sde:1} to generate $X_{t=1}$;
% \item propagating each of these $X_{t=1}$ backward in time using the backward SDE~\eqref{eq:sde:R} to generate $X^\rev_{t=0}$;
% \item averaging these data in~\eqref{eq:kl} and \eqref{eq:fk:rev:X1}.
% \end{enumerate}
% Similarly, equations~\eqref{eq:kl:rev} and \eqref{eq:fk:X0} show that, if we can evaluate $\rho_1$ at any $x\in {\RR^d}$ and sample this density, we can estimate $D_{\text{KL}} (\rho_0|\rho_1)$ by:
% \begin{enumerate}[leftmargin=0.15in]
% \item generating $x_1\sim \rho_1$;
% \item propagating each of these $x_1$ backward in time using the backward SDE~\eqref{eq:sde:R} to generate $X^\rev_{t=0}$;
% \item propagating each of these $X^\rev_{t=0}$ forward in time using the  SDE~\eqref{eq:sde:1} to generate $X_{t=1}$;
% \item averaging these data in~\eqref{eq:kl:rev} and \eqref{eq:fk:X0}.
% \end{enumerate}

\subsection{Cross-entropy calculations}
\label{sec:ce}

The results above can also be used if we replace the velocity $v$ and the score $s$ by approximate versions learned via minimization of~\eqref{eq:obj:v} and~\eqref{eq:obj:s}. Assuming that we can evaluate $\rho_0$ at any $x\in \RR^d$ and sample $\rho_1$ empirically (e.g. via an existing data set), this allows us to evaluate  the cross entropy of the density calculated with these approximate $v$ and $s$ relative to $\rho_1$, as stated in the following result

\begin{restatable}{theorem}{crossentsde}
    \label{prop:ce:sde}
    Given the PDFs $\rho_0$ and $\rho_1$, and the two velocity fields $\hat b: [0,1]\times\RR^d\to\RR^d$ and $\hat s: [0,1]\times\RR^d\to\RR^d$, both in $C^0([0,1];(C_b^1(\RR^d))^d)$
 let the time-dependent PDF $\hat \rho: [0,1]\times \RR^d \to \RR_{\ge0} $ be the solution to the FPE
\begin{equation}
    \label{eq:fpe:hat}
    \begin{aligned}
       \partial_t \hat \rho + \nabla \cdot (\hat b_\rev\hat \rho) = \eps  \Delta \hat \rho, \qquad \hat \rho(0) = \rho_0,
    \end{aligned} 
\end{equation}
and let $\hat X^\rev_t$ solve the backward SDE
\begin{equation}
    \label{eq:sde:R:hat}
    d\hat X^\rev_t = \hat b_\rev(t,\hat X^\rev_t)dt + \seps  dW^\rev_t, \quad W_t^\rev = -W_{1-t}.
\end{equation}
where
\begin{equation}
\label{eq:hat:b:r}
 \hat b_\rev(t,x) = \hat b(t,x) -\eps \hat s(t,x).
\end{equation}
Denote
\begin{equation}
    \label{eq:b:fwd:hat}
    \hat b_\fwd (t,x) = \hat b(t,x) + \eps \hat s(t,x).
\end{equation}
Then the cross-entropy of $\hat \rho(1)$ relative to $\rho_1$ is given by
\begin{equation}
    \label{eq:ce:sde}
    \begin{aligned}
    H(\rho_1|\hat \rho(1)) &= - \int_{\RR^d} \log \hat \rho(1,x) \rho_1(x) dx\\
   & = -\EE_1 \EE^{x_1}_\rev\log \rho_0(\hat X_{t=0}^\rev)+ \int_0^1 \EE_1 \EE^{x_1}_\rev \left(\nabla \cdot \hat b_\fwd(t, \hat X^\rev_t) + \epsilon|s(t, \hat X_t^\rev)|^2\right)dt,
   \end{aligned}
\end{equation}
where $\EE_\rev^x$ denotes the expectation on $\hat X^\rev_t$ conditional on $\hat X^\rev_{t=1}=x_1$, and $\EE_1$ denotes the expectation on $x_1\sim\rho_1$.
  
\end{restatable}

This theorem is proven in Appendix~\ref{app:ce}. If in~\eqref{eq:ce:sde} we approximate the expectation over $\rho_1$ by an empirical expectation over a data set from this density, this equation allows us to cross-validate different approximations of $v$ and $s$. It also allows to to compare the cross-entropy calculated with the backward SDE with the one calculated with the probability flow ODE, since we also have
\begin{restatable}{theorem}{crossentode}
    \label{prop:ce:ode}
    Given the PDFs $\rho_0$ and $\rho_1$, and the velocity field $\hat b: [0,1]\times\RR^d\to\RR^d$  in $C^0([0,1];(C_b^1(\RR^d))^d)$, let the time-dependent PDF $\check \rho: [0,1]\times \RR^d \to \RR_{\ge0} $ be the solution to the TE
\begin{equation}
    \label{eq:te:hat}
    \begin{aligned}
       \partial_t \check \rho + \nabla \cdot (\hat b_\ODE\check \rho) = 0, \qquad \check \rho(0) = \rho_0,
    \end{aligned} 
\end{equation}
and let $\hat{X}^{x}_t$ solve the ODE
\begin{equation}
    \label{eq:ode:hat}
    \frac{d}{dt}\hat{X}^{x_1}_t = \hat b_\ODE(t,\hat{X}^{x_1}_t), \qquad \hat{X}^{x_1}_{t=1} = x_1.
\end{equation}
Then the cross-entropy of $\check\rho(1)$ relative to $\rho_1$ is given by
\begin{equation}
    \label{eq:ce:ode}
    \begin{aligned}
    H(\rho_1|\check\rho(1)) &= - \int_{\RR^d} \log \check\rho(1,x) \rho_1(x) dx\\
   & = \EE_1 \log \rho_0(\hat{X}^{x_1}_{t=0})- \int_0^1 \EE_1  \nabla \cdot \hat b_{\ODE}(t, \hat{X}^{x_1}_t)dt,
   \end{aligned}
\end{equation}
where $\EE_1$ denotes the expectation on $x_1\sim\rho_1$.

 
\end{restatable} 

This theorem is also proven in Appendix~\ref{app:ce}.
