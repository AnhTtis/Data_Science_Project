\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}

% \setlength{\textheight}{8.8in}
% \setlength{\textwidth}{6.5in}
% \setlength{\evensidemargin}{-0.18in}
% \setlength{\oddsidemargin}{-0.18in}
% \setlength{\headheight}{10pt}
% \setlength{\headsep}{10pt}
% \setlength{\topsep}{0in}
% \setlength{\topmargin}{0.0in}
% \setlength{\itemsep}{0in}
% \renewcommand{\baselinestretch}{1.2}

\usepackage{fullpage}
\renewcommand{\baselinestretch}{1.1}

\usepackage{hyperref}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{cleveref}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage[linesnumbered]{algorithm2e}
\usepackage{thmtools}
\usepackage{thm-restate}



\def\proofname{proof}
\newtheorem{theorem}{Theorem}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{claim}[theorem]{Claim}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{observation}[theorem]{Observation}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{example}[theorem]{Example}
\newtheorem{question}[theorem]{Question}
% \numberwithin{equation}{section}
\renewenvironment{proof}{\noindent\bf{Proof.}\rm}{\hfill$\blacksquare$\bigskip}

\declaretheorem[name=Theorem,sibling=theorem]{rethm}
\declaretheorem[name=Corollary,sibling=theorem]{recor}
\declaretheorem[name=Proposition,sibling=theorem]{reprop}


\newcommand{\lexmax}{{\emph{lex-max-WS}}}
\newcommand{\items}{\mathcal{M}} 
\newcommand{\agents}{\mathcal{N}} 

\usepackage[]{color-edits}% suppress
\addauthor{UF}{red}
\newcommand{\ufc}[1]{{\UFcomment{#1}}}
\newcommand{\ufe}[1]{{\UFedit{#1}}}

\addauthor{GB}{blue}
\newcommand{\gbc}[1]{{\GBcomment{#1}}}
\newcommand{\gbe}[1]{{\GBedit{#1}}}


\title{On fair allocation of indivisible goods to submodular agents}

\author{Gilad Ben Uziahu\thanks{Weizmann Institute ---  E-mail: \texttt{gilad.ben-uziahu@weizmann.ac.il}.}\;\, and Uriel Feige\thanks{Weizmann Institute ---  E-mail: \texttt{uriel.feige@weizmann.ac.il}.}}

\begin{document}

\maketitle

\input{introduction.tex}

\section{Proofs of our results}

%\ufc{Short introduction to this section (optional).}

\input{preliminaries.tex}




\subsection{{Approximate} APS-fair allocations for submodular agents}
\label{sec:APS}


%\gbc{Removed:
%\begin{theorem}
%\label{thm:APSsubmodular}
%There is an allocation algorithm, for indivisible goods to agents with arbitrary entitlements and submodular valuations that gives every agent at least a $\rho$ fraction of her APS. The algorithm runs in polynomial time if 
%the valuation functions are accessed using value queries, and furthermore, the APS value of every agent is given. 
%\end{theorem}}

%\ufc{As secondary goal, we want to show that safe strategies in natural games give such a result}

%\gbc{Indeed the assumption of APS equals entitlement is not nedded}
%\gbc{Remove? We assume \ufc{the assumption is not needed at this stage.} that valuation functions are scaled so that for every agent $i$, her APS is equal to her entitlement $b_i$, and truncated so that no single item has value more than $b_i$.  \ufc{For submodular, truncated so that no bundle has value larger than $APS_i$.} (Note that we do not assume that the instance is ordered, as the transformation of Bouvert and Lamaitre assumes additive valuations.)}

We now describe an allocation game (introduced in~\cite{BEF21}), that we refer to as the bidding game.
Initially, every agent $i$ is {\em active}, is given a budget of $b^0_i = b_i$ (in particular, in the equal entitlement case $b^0_i = \frac{1}{n}$), and has an empty bundle $S^0_i$ of items. The set of initially unallocated items is denoted by $M^0$. 

The game proceeds in rounds, and in every round, one item is allocated. In round $r \ge 1$, to decide which item is allocated, we do the following.

\begin{enumerate}

\item If there are no active agents, end the allocation algorithm. (The remaining items, if there are any, can be allocated arbitrarily.)

%\gbc{I think we should remove this second bullet, since it is not describing the algorithm\textbackslash bidding-game, but the proportional-bidding-strategy, which presented when proving \Cref{thm:1/3_APS_guarantee}} \ufc{The second bullet should just describe what a legal bid is, and not how the agent chooses the bid.}
    
    \item {Every active agent $i$ submits a nonnegative bid $p_i^r$ of her choice, not exceeding her budget. Namely, $0 \le p_i^r \le b_i^{r-1}$.}
    % let $e_i^r$ be the item in $M^{r-1}$ of highest marginal value given $S_i^{r-1}$, and let $v_i^r$ be its marginal value. The agent bids $p_i^r = \min[v_i^r, b_i^{r-1}]$. 

    \item  The agent $i$ with the highest bid (breaking ties arbitrarily) wins, {and selects an arbitrary item of her choice. Denote this selected item as $e^r$.}  We update $M^r = M^{r-1} \setminus \{e^r\}$ and $S_i^r = S_i^{r-1} \cup \{e^r\}$. Her budget is updated to $b^r_i = b^{r-1}_i - p_i^r$. If $b^r_i =0$, then agent $i$ stops being active. In any case, for agents $j \not= i$, we have $S_j^r = S_j^{r-1}$ and $b^r_j = b^{r-1}_j$.
    %\gbc{Notice that in the above third bullet, I updated the original\textbackslash first version of the bidding-game to be where each agent can exploit her entire budget. Only later in the article we present the altruistic version of the bidding game, in which the algorithm turns the agents to inactive when surpassing a threshold of their budget.}

\end{enumerate}


%\ufc{For COMSOC, present a one page sketch of the proof for $\frac{1}{3}$-MMS, explain that full proof needs to handle APS and arbitrary entitlement, and move next five and a half pages to the appendix}


To help illustrate the key methods used in the proof of \Cref{thm:1/3_APS_guarantee}, we first present a sketch of proof for a weaker version. This will pave the way for the subsequent proof of \Cref{thm:1/3_APS_guarantee}.

\begin{proposition}
\label{pro:third}
    Consider the bidding game described above and an agent $p$ with a submodular valuation function in an equal entitlements setting. Employing a bidding-strategy referred to as $proportional(\frac{1}{3})$ guarantees agent $p$ a minimum value of $\frac{1}{3}\cdot MMS_p$.
\end{proposition}

\begin{proof}
In the bidding game, each agent is initially assigned a budget equal to her entitlement. In the equal entitlement case, each agent receives a budget of $\frac{1}{n}$. The $proportional(\frac{1}{3})$ bidding strategy involves the following steps. Initially, agent $p$ calculates $MMS_p$ (her $MMS$ value).  At the beginning of round $r$, let $\items^r$ denote the set of items that are still available, let $C^r$ denote the set of items that agent $p$ won prior to round $r$, and let $b_p^r$ denote the budget that the agent still holds. In round $r$, agent $p$ bids $\frac{3}{2}\cdot\frac{1}{n}\cdot\frac{1}{MMS_p}\cdot\max_{e\in\items^r}[v_p(e\mid C^r)]$. In other words, the bid of the agent is equal to $\frac{3}{2}$ times the {\em scaled value} of the marginal value of the item of highest marginal value that still remains, where the scaling factor $\frac{1}{n}\cdot\frac{1}{MMS_p}$ is such that after this scaling, the MMS value of $p$ equals the original budget of $p$.
If this bid value exceeds $b_p^r$ (the remaining budget of $p$), then $p$ bids $b_p^r$. In any case, if $p$ wins the bid, she selects the item of highest marginal value in $\items^r$, and pays her bid. We note here that the factor $\frac{3}{2}$ was chosen so as to equal $\frac{1}{2\rho}$, for our choice of $\rho = \frac{1}{3}$. The same type of expression, $\frac{1}{2\rho}$, will appear also in the proof of Theorem~\ref{thm:1/3_APS_guarantee}.

{We now provide a sketch of proof that the above bidding strategy guarantees agent $p$ a bundle of value at least $\frac{1}{3} MMS_p$. In this sketch, $\{B_i\}_{i=1}^n$ denotes an MMS partition for agent $p$. Namely, $v_p(B_i) \ge MMS_p$ for every $i$.}

{Call an item $e$ {\em large} if $v_p(e)>\frac{2}{3}MMS_p$. We claim that, without loss of generality, we can assume that there are no large items. As long as a large item exists, $p$ bids her entire budget. If agent $p$ wins the round, {we are done}. If a different agent $q$ wins the round, that agent spends her entire budget and leaves the bidding game after winning only a single item. 
%Thus, we have disposed of an item $e$ and an agent $q$. 
%Removing a single item and an agent does not decrease the MMS value of agent $p$, since $n-1$ bundles of the MMS partition of $p$ are still available. Therefore, 
Intuitively, $q$ did not ``hurt" $p$, since $n-1$ bundles of the MMS partition of $p$ still contain all their items, whereas only $n-1$ agents remain to compete on them. Further details of this argument are omitted.}



According to the bidding strategy, if agent $p$ manages to spend at least half of her budget during the bidding game, she will receive a $\frac{1}{3}$-fraction of her MMS. Therefore, our goal is to show that $p$ manages to spend at least half of her budget.
% Therefore we would like to show that $p$ manages to spend at least half of her budget.

The main idea is that until $p$ spent half of her budget, other agents cannot do much damage to $p$. The bidding strategy of $p$ has two key properties that are easy to verify. First, the bidding sequence is non-increasing (this is a consequence of submodularity of $v_p$). Second, {in the absence of large items (an assumption that we can make without loss of generality)}, as long as $p$ has spent at most half of her budget, her remaining budget does not constrain her from providing a full bid according to the bidding strategy. Due to this latter property, if another agent $q$ wins an item, {$q$ pays for the item that she takes {at least $\frac{3}{2}$ times} the scaled marginal value that $p$ has for the item.}

Next, we analyze how much harm the other agents {can cause $p$ up to the point when she spends} half of her budget. We denote by $C$ the bundle that $p$ holds {at the last point in time in which she has not spent half her budget.} 
A sufficient condition for $p$ to exceed $\frac{1}{3}MMS_p$ is if there exists a bundle $B_i$ from $p$'s MMS partition that has sufficiently high marginal value (relative to $C$, and after excluding from $B_i$ those items won by other agents) so that together with $C$, the value exceeds $\frac{1}{3}MMS_p$. 
For every item $e$ that another agent wins, that agent pays at least $\frac{3}{2}\frac{1}{n}\frac{1}{MMS_p}v_p(e\mid C)$. {(The fact that we can compare to marginal value relative to $C$ is a consequence of submodularity of $v_p$.)} Hence, the ratio between the value taken from bundles of the MMS partition, and the payment done by the other agents is $\alpha=\frac{3}{2}\frac{1}{n}\frac{1}{MMS_p}$.
Therefore, using the fact that the total budget of all the agents together is 1, we obtain an upper bound on the total value taken by the other agents, which is $\frac{2}{3}\cdot n\cdot MMS_p$. Hence, there must exist a bundle $B_i$ in which the other agents took items of marginal value relative to $C$ of at most $\frac{2}{3}MMS_p$. Hence, together with $C$, there is enough value left in $B_i$ for $p$ to surpass $\frac{1}{3}MMS_p$. (This last argument again uses submodularity of $v_p$.)
\end{proof}

Before presenting the proof of \Cref{thm:1/3_APS_guarantee}, we discuss some of the challenges we will face when extending the (sketch of) proof of Proposition~\ref{pro:third} to the more general setting of \Cref{thm:1/3_APS_guarantee}.

\begin{itemize}
    \item \Cref{pro:third} considers the MMS, whereas \Cref{thm:1/3_APS_guarantee} considers the APS, which is always at least as large as the MMS, and sometimes larger. The analysis needs to be extended to hold relative to this stronger notion, and in particular, can no longer assume the existence of an integral MMS partition.
    \item The setting considered in \Cref{thm:1/3_APS_guarantee} allows for arbitrary entitlements. The proof of \Cref{pro:third} uses the assumption that the setting is that of equal entitlement (for example, in its treatment of large items). 
    \item \Cref{thm:1/3_APS_guarantee} provides a guarantee that is somewhat better than $\frac{1}{3}$-fraction of the APS (that becomes significant if the entitlement is large).
\end{itemize}

We now proceed to present the proof of \Cref{thm:1/3_APS_guarantee}.

%In order to address the third challenge, we will utilize a bidding strategy we refer to as $proportional(\rho)$, in the proof of \Cref{thm:1/3_APS_guarantee}. This strategy takes a parameter $\rho$ as an input, which determines the proportion between the bids $p$ will raise with respect to the values of the items.
% The bidding strategy is simple: in round $r$, agent $p$ should bid $\max_{e\in\items^r}\frac{1}{2\rho}\frac{b_p}{APS_p}v_p(e|C^r)$.If this bid value exceeds her remaining budget, she bids her remaining budget.
%However, we present the strategy in a more complicated way to aid in the analysis of the proof of \Cref{thm:1/3_APS_guarantee}.


%\gbc{Todo - change the strategy to proportional-1 and proportional-2. Proportional-1 is conducted when there exists large items (satisfying $v_p(e)\geq2\rho APS$ in this case the agent bids her entire budget. If she wins we are good - if not, the agent conducts the proportional strategy on the reduced instance $I_s$ (or $\hat{I_s}$). When for the first time there are no more large items - then the agent bids $\frac{1}{2\rho}\frac{b_p}{APS}v_p(e)$ (in this case, this value does not exceed   her remained budget, unless she already won a value of $\rho APS_p$)} 

%\ufc{Our strategy should perhaps be called $2\rho$-proportional and not $\rho$-proportional, so that 1-proportional is proportional. Maybe keep $proportional(\rho)$, as something different from $\rho$-proportional.}
{We describe a bidding strategy for the bidding game in the arbitrary entitlement case. It has a parameter $\rho > 0$,
%satisfying $0 < \rho \le \frac{1}{2}$ \gbc{Consider removing this restriction of $\rho$, and change it to $\rho\leq\frac{1}{3-2b_p}$, As explained in my comment before \Cref{lem:1/3 guarantee no large items}}, 
and we refer to it as the proportional bidding strategy $proportional(\rho)$.}  
As we shall later prove, if $\rho$ is chosen to satisfy $\rho \le \frac{1}{3-2b_p}$, then the $proportional(\rho)$ bidding strategy will guarantee that agent $p$ receives a bundle of value at least $\rho APS_p$.
A player $p$ (with valuation function $v_p$ and entitlement $b_p$) 
%where $b_p = \frac{1}{n}$ in the equal entitlement case)  
that uses $proportional(\rho)$ first computes her $APS(\items, v_p, b_p)$  value, which we refer to as $APS_p$. 
Up to some minor technical details (that manifest themselves only if other agents spend their budgets at a rate that is higher than that dictated by the bids of $p$ -- these details do not affect the guarantees offered by the bidding strategy), $proportional(\rho)$ is equivalent to the following simple strategy. Scale the valuation function of $p$ such that her $APS$ equals her entitlement (and budget) $b_p$. In each round, bid $\frac{1}{2\rho}$ times the marginal value (with respect to the items that $p$ already holds) of the item of highest marginal value that is not yet allocated, if $p$ has sufficient budget to do so, and bid the total remaining budget otherwise. If $p$ wins the bid, she selects the item of highest marginal value.
%\gbc{For COMSOC from this point shift the rest of the section to the Appendix}
%\gbe{The more detailed presentation of the $proportional(\rho)$, and the proof of \Cref{thm:1/3_APS_guarantee}, is deferred to the appendix.}\gbc{Give an explicit reference to the subsection in the appendix?}

{To simplify the proofs that follow later, we now present the $proportional(\rho)$ bidding strategy in more detail, and introduce terminology that will be used in the proofs.}
%The partition of $proportional(\rho)$ into $proportional_1(\rho)$ and $proportional_2(\rho)$ is made only for convenience in the analysis.
%The strategy $proportional(\rho)$ is the combination of $proportional_1(\rho)$ and $proportional_2(\rho)$. 
%Before presenting our strategy in its full generality, 
We first present $proportional(\rho)$ in the special case in which $v_p(e)\leq 2\rho APS_p$ holds for all items. We refer to the strategy in this special case as $proportional_1(\rho)$. {At the beginning of round $r$, let $\items^r$ denote the set of items not yet allocated, let $C^r$ denote the set of items already allocated to $p$, and let $b_p^{r-1}$ denote the budget remaining for agent $p$. Then the agent bids $\frac{1}{2\rho}\cdot\frac{b_p}{APS_p}\cdot\max_{e\in\items^r}[v_p(e\mid C^r)]$ (the highest marginal value that a yet unallocated item has, scaled by $\frac{1}{2\rho}\frac{b_p}{APS_p}$) if this bid is not larger than $b_p^{r-1}$, and
bids her remaining budget $b_p^{r-1}$ otherwise. If the agent
wins her bid, she selects the item with the highest marginal value with respect to $C^r$.}

We now present the strategy for the remaining case, that in which there are large items that satisfy $v_p(e)>2\rho APS_p$. We refer to the strategy in this case as $proportional_2(\rho)$.

Prior to the beginning of the bidding game, agent $p$ truncates her valuation function, so that the value of each bundle $S$ is $\min[v_p(S), APS_p]$. In the notation of \Cref{def:$v^t_p$}, this new valuation function is denoted as $v_p^t$, with $t=APS_p$. This does not affect $APS_p$, {and preserves submodularity}. To keep notation simple, we still use the notation $v_p$ for this new valuation function.

In the bidding game itself, as long as there exists a large item that satisfies $v_p(e) > 2\rho APS_p$, $p$ bids her entire budget. If the agent
wins her bid, she selects the item with the highest value (which is at least $2\rho APS_p$) and leaves the game (as her budget is exhausted). If the agent does not win any of the large items, let $s$ denote the last round in which there are large items, i.e., from round $s+1$ onward, all unallocated items satisfy $v_p(e) \leq 2\rho APS_p$. At this point, agent $p$ basically switches to using $proportional_1(\rho)$. Below we introduce terminology that describes how this switch is done. This terminology will later be used in our proofs.
%\ufc{The natural thing now is to simply switch to $proportional_1(\rho)$. The paragraph and a half that follows here is part of the analysis, not part of the bidding strategy.}
%\gbc{In a few sentences it is written that $p$ simulates $proportional_1$ on $\hat{I_s}$. This statement makes sense only if $p$ did not win a large item, i.e., she is an active agent in $\hat{I_s}$} \ufc{We already said that in the previous sentence.} \ufc{Remove, and note that you keep on making the mistake of confusing $s$ with $s+1$. If $p$ did not win an item in the first $s+1$ rounds, then she continue as follows.} 

Let $I_s$ denote the {\em residual instance}  that remains after round $s$. It includes the set of items that were not yet allocated (which we denote by $\mathcal{\hat{M}}$), 
% \ufc{removed because $p$ took no items: the valuation function (over the remaining items) of {agent $p$ is} her marginal valuation function with respect to the items that she already has,}
and each agent has whatever remains from her budget after the $s$ rounds.
View $I_{s}$ as a new allocation instance, that we refer to as $\hat{I_{s}}$. The agents of $\hat{I_{s}}$ are the remaining active agents of $I_{s}$. The set of items of $\hat{I_{s}}$ is $\mathcal{\hat{M}}$ (those items remaining
in $I_{s}$). Setting $\gamma=b^s$ to be the total remaining budget of agents, we update the entitlement of each agent to be $\hat{b_i}=\frac{1}{\gamma} b_i$. Agent $p$ simulates $proportional_1(\rho)$ on $\hat{I_s}$. To do so, for every agent $i \not=p$, a bid $x_{i}^{r}$ in $I_{s}$ is viewed as a bid of $\frac{1}{\gamma}\hat{x}_{i}^{r-s}$ in 
    $\hat{I_{s}}$, and any intended bid $x^r$ of agent $p$ in $\hat{I_{s}}$ is translated to a bid $\gamma x^{r+s}$ in $I_s$. 
% \ufc{remove: Namely other agent bids $p_{i}^{r}$ in $I_{s}$ then $p$ simulate her bid in $\hat{I_{s}}$ as $\hat{p}_{i}^{r-s}=\frac{1}{\gamma}p_{i}^{r}$.
% Then, agent $p$ knows how to bid by considering scaling her bids in $\hat{I_{s}}$ by $\gamma$.}
(Since the ratio between a budget of an agent in $I_{s}$ and in $\hat{I_{s}}$ is $\frac{1}{\gamma}$, by taking a bid of another agent $i$ in $I_{s}$ and scaling it by $\frac{1}{\gamma}$ we get a legal bid of the agent in $\hat{I_{s}}$. Similarly, scaling by $\gamma$ a bid of agent $p$ in $\hat{I_{s}}$ induces a legal bid in $I_{s}$.)

Observe that by \Cref{claim:APS not decrease in I_s}, the APS of $p$ in $\hat{I_s}$ remains the same as the original value of $APS_p$.

   
    
    %The strategy $proportional(\rho)$ is the combination of $proportional_1(\rho)$ and $proportional_2(\rho)$. Up to some minor technical details (that manifest themselves only if other agents spend their budgets at a rate that is higher than that dictated by the bids of $p$ -- these details do not affect the guarantees offered by the proportional bidding strategy), it is equivalent to the following simple strategy. Scale the valuation function of $p$ such that her $APS$ equals her entitlement (and budget) $b_p$. In each round, bid $\frac{1}{2\rho}$ times the marginal value (with respect to the items that $p$ already holds) of the item of highest marginal value that is not yet allocated, if $p$ has sufficient budget to do so, and bid the total remaining budget otherwise. If $p$ wins the bid, she selects the item of highest marginal value. The partition of $proportional(\rho)$ into $proportional_1(\rho)$ and $proportional_2(\rho)$ is made only for convenience in the analysis.
    
    %\item In the case agent $p$ did not win an item by round $s$, she bids her entire budget in each of these rounds. Thus, any other agent wins an item and spends at least $b_p$ of her budget, and by round $s$, the total budget spent by other agents is at least $s\cdot b_p$. If we consider the worst case \gbc{I don't want to get into a formal explanation why this is the worst case} the budget spent by other agents is exactly $s\cdot b_p$, then the bids of $p$ in the remaining $I_s$ in round $r$ will be exactly $\frac{1}{2\rho}\frac{b_p}{APS_p}\max_{e\in \items^r} [v_p(e\mid C^r)]$ or the $b_p^r$ if the bid exceeds the remained budget. Hence one can verify that by simply bidding in every round $\frac{1}{2\rho}\frac{b_p}{APS_p}\max_{e\in \items^r} [v_p(e\mid C^r)]$ (or $b_p^r$ if the bid exceeds the remained budget), the same guarantees will hold as of the proportional bidding strategy presented above. \gbc{What I am trying to say by that is that the algorithm is basically simple to apply - the proportional bidding strategy is basically simple - in round $r$ bid $\frac{1}{2\rho}\frac{b_p}{APS_p}\max_{e\in \items^r} [v_p(e\mid C^r)]$ or $b_p^r$ if this exceeds the remaining budget }




%\gbc{Removed: The first stage of the bidding strategy is used as long as there are items with $v_p$ value greater than $2\rho \cdot APS_p$. {In the first stage, in every round $r$} agent $p$ bids her entire budget, and picks the item with the highest value if she wins. {If agent $p$ is still active} after no more items with a value greater than $2\rho \cdot APS_p$ remain, {then she moves to the second stage of the bidding strategy}. \ufc{We over complicated things. If we originally truncate the valuation function at APS, then at this stage $APS' = APS$, because the APS cannot increase. This simplifies the presentation.} She computes her new {$APS(\items', v_p, b'_p)$, that were refer to as $APS'$. Here}  $\items'$ is the {set of remaining} items, and {$b'_p=\frac{1}{n-s}$, where $s$ is the number of inactive agents.}  \ufc{Explain how to computed $b'_p$ in the arbitrary entitlement case.  $b'_p = \frac{1}{b'}b_p$, where $b'$ is the sum of entitlements that still remain, for active agents.}
%\ufc{removed: $b'=\frac{n}{n-s}\cdot b_p$, where $s$ is the number of inactive agents (in the equal entitlement case $b_p=\frac{1}{n}$ where $n$ is the number of agents).}\gbc{I think we should keep $b_p'=\frac{n}{n-s}\cdot b_p$ as I originally suggested, since it takes into consider both cases of equal and unequal entitlements} Then the agent scales her valuation function {$v_p$ to $v'_p$ so that $APS(\items', v'_p, b'_p) = b'_p$.}
%\ufc{removed: by $\frac{b_p}{APS}$.} \gbc{I still think that the agent need to scale her valuation function by $\frac{b_p}{APS(\items ', b_p'})$ so after scaling her new APS is equal $b_p=\frac{1}{n}$. This implies that all items satisfy $v_p'(e)\leq2\rho b_p$ and hence and the agent bids $\frac{1}{2\rho}v_p'(e\mid C^r)$} 
%At the beginning of a round $r$, let $\items^r$ denote the set of items not yet allocated, let $C^r$ denote the set of items already allocated to $p$, and let $b_p^r$ \ufc{you previously used $b_p^{r-1}$. stick to one version} denote the budget remaining for agent $p$. Then the agent bids $\frac{1}{2\rho}\cdot\frac{b_p}{b'_p}\cdot\max_{e \in \items^r}[v_p(e \mid C^r)]$ (the highest marginal value that a yet unallocated item has, scaled by $\frac{1}{2\rho}$) if this bid is not larger than $b_p^r$, and bids her remaining budget $b_p^r$ otherwise. If the agent wins her bid, she selects the item with the highest marginal value with respect to $C^r$.}

% The reader should keep in mind that the parameter $\rho$ will represent the fraction that the agent will be guaranteed to have from her $APS$ (or $MMS$). 
%\gbc{Removed:
% \ufc{State proposition $v'_p(e) \le 2\rho\cdot APS(\items', v'_p, b'_p)$, and in the proof say the contents of items 1 and 2 below.}

% \ufc{replace the observations below by the above proposition}

% \gbe{
% We state here convenient observations:
% \begin{enumerate}
% \ufe{\item $APS' \ge APS$.} \ufc{Refer to a proof that appears later, or alternatively, prove here.} \ufe{Consequently, at the end of the first stage, every remaining item has $v_p$ value at most $2\rho APS'$.}
     
%    \item After the agent scales her valuation function, her new $APS_p=b_p$ (respectively $MMS_p=b_p$).
     
%     \item\ufe{By observations~1 and~2 above}, at the second phase of the bidding strategy, i.e., after the agent scales her valuation function, \ufe{every remaining item $e$ satisfies} \ufc{remove: the items respect} \ufe{$v'_p(e)\leq 2\rho b'_p$.} 
%     \ufc{The following is not needed if you refer the reader to a proof of Observation 1.}
%     \gbc{Wondering whether a more detailed explanation is needed, such as the following. Denote $APS^0$ the $APS$ of the $p$ at the beginning. And $APS^s$ the APS of agent $p$ after $s$ rounds when there are no more items with value $2\rho APS^0$. Then $APS^s\geq APS^0$. Then by the proportional bidding, in the second phase of the strategy, the agent scales her valuation function by $\frac{b_p}{APS^s}$, so her new APS equals her budget $b_p$. Therefore, if we know that after $s$ rounds, no more items with value $2\rho APS^0$ exists, then, this guarantee translates to the guarantee that all the items have a value less than $2\rho b_p$ after scaling the valuation function by $\frac{b_p}{APS^s}$.} Since $\frac{1}{2\rho}\cdot 2\rho b_p\leq b_p$, up until the agent wins her first item; all her bids are $\frac{1}{2\rho}$ times the value of the item with the highest value (and the agent does not encounter the situation where this value is greater than her budget).
% \end{enumerate}
%  }

%}

%At every round, to compute the bids of the agents, value queries suffice. \ufc{This confuses two issues. One is the complexity of computing bids according the proportional strategy, given that the APS value is known, Here we need to compute marginal values, and this can be done by value queries. The other is that we will later claim theorems about wat happens when all agents use the proportional strategy.}

%\ufc{Needs to be rephrased so as to present the point of view of $p$, as not all agents use the proportional strategy.} Every agent that stops being active gets value at least $\rho$ times her APS. Hence it remains to choose a value for $\rho$ that guarantees that the set of remaining items does not become empty while there still are active agents. 


%\ufc{Either change to Observation (and when referring to it, refer to it as an observation), or provide a proof, or explain why not proof is needed.}
%\gbc{If you are ok with it, I changed it to observation - There is no proof for it since it's immediate.}

\begin{observation}
\label{obsrv: bidding sequence decreasing}
The sequence of bids of an agent that uses the proportional bidding strategy is weakly decreasing.
\end{observation}

%\gbc{The following changes are made in order to focus on agent $p$ instead of any agent $i$}
Consider an APS fractional partition %\gbc{Removed:$\{\lambda_j B_i^j\}_{j \ge 1}$ for agent $i$} 
{$\{\lambda_S\}_{S\subseteq\mathcal{M}}$ for agent $p$} , where {$\sum_S \lambda_S = 1$, $\sum_{S \; | \; e\in S} \lambda_S \le b_p$} %\gbc{Removed:$\sum_j \lambda_j = 1$, $\sum_{j \; | \; e\in B_i^j} \lambda_j \le b_i$} 
for every item $e$, and {$v_p(S) \ge APS_p$ for every $S$ with $\lambda_S$ in the support}.
%\gbc{Removed:$v_i(B_i^j) \ge APS_i$ for every $j$} 
We trace three parameters throughout the execution of the algorithm. One is a {\em lower bound} on the total marginal value of the set of all remaining items to agent {$p$}, %\gbc{Removed:$i$}
given her set of items at the time. Initially it is {$L^0 = \sum_S \lambda_S v_p(S) \ge {APS_p}$}. %\gbc{Removed:$L_i^0 = \sum_j \lambda_j v_i(B_i^j) \ge {APS_i}$}. 
Another is the budget of agent $i$, which initially is $b_i^0 = b_i$.  Another is the total remaining budget of all agents. Initially it is $b^0 = 1$. 

\input{1-3APS_equal_entitlements.tex}

% \gbe{
% \begin{lemma*}
% \textbf{Lemma 3.} In the equal entitlement case, where $b_{j}=\frac{1}{n}$
% for all $n$, we can set $\rho=\frac{n}{3n-2}$.
% \end{lemma*}

% In the equal entitlement case we assume that no single item $e$ has
% value $\rho\cdot b_{j}$ for any agent $j$, as otherwise we give
% $e$ to the agent and remove the agent. For the APS fractional partition
% of other agents, we remove the bundles containing $e$, and the APS
% does not decrease. \ufc{If the point of you rewriting the proof of Lemma 3 is to fill in missing details, then here you also need to explain that after removing the agent, the given allocation algorithm gives each other individual agent exactly the same items that she would get before removing the agent.}

% Suppose agent $p$ did not receive a $\rho$ fraction of her APS when
% the algorithm finished. First, some notation.
% Denote the valuation function of agent $p$ as $v_p$ and her entitlement $b=\frac{1}{n}$. As above,
% we assume her APS is also equal to $b.$ Denote $\{\lambda_{J}\}_{J\subseteq\mathcal{M}}$
% to be a set of weights associated with her APS {fractional partition} (i.e {for every $J\subseteq\mathcal{M}$,} 
% $\lambda_{J}>0\implies v(J)\geq b,$ also $\sum_{J}\lambda_{J}=1$,
% and $\forall e\in\mathcal{M},$ $\sum_{j|e\in j}\lambda_{j}\leq b$).

% Let $L^{0} = \sum_{J}\lambda_{J}v(j)$.}
% At the beginning of the algorithm (when no item has been
% allocated yet), $L^{0}$ is a lower bound on the marginal value
% of the set of all items to agent $p$

% Let $f$ denote the earliest round after which either all other agents become
% inactive, or all items have been allocated.
% Let $C\subseteq\mathcal{M}$ denote the set of items that agent $p$
% has by the end of round $f$, and let $O$ denote the set of items that the other agents
% have by the end of round $f$. Define $L^{f}=\sum_{J}\lambda_{J}\cdot v(J\setminus O\dot{\cup}C\mid C)$. namely, $L^f$ is the expected marginal value to agent $p$ (who already holds the set $C$ of items), of a bundle $J$ selected at random according to the probability distribution over bundles implied by the coefficients $\lambda_J$, after one removes from $J$ those items that were allocated by the end of round $f$.

% \ufc{The next claim appears to be formulated incorrectly.}

% \begin{claim}
% $L^{f}$ is a lower bound of the agent $p$'s value \ufc{not clear, value for what?} at the end of
% the algorithm. \ufc{Perhaps you mean to say (and then prove) that $\min[\rho b, v_p(C) + L^f]$ is a lower bound on the final total value of agent $p$.}
% \end{claim}
% \begin{proof}
% If there are other active agents at the end of the algorithm, then
% time $f$ is the end of the algorithm, and all the items have been
% allocated to agents (i.e., $C\dot{\cup}O=\mathcal{M})$. Thus, for
% each $J\subseteq\mathcal{M}$, $J\setminus O\dot{\cup}C=\emptyset$
% and $L^{f}=0$, so the bound is trivial.

% Otherwise, $p$ is the only active agent. Since $p$ is the only remained
% active agent, the rest of the not-yet allocated items will assign
% to her. \ufc{Not true -- that's not what the algorithm says.} So every term in the sum is a marginal value of a partial
% set of the not-yet-allocated items. Since the sum is convex, we obtain
% that$L^{f}$ is a lower bound on the value agent $p$ will has at
% the end of the algorithm.
% \end{proof}

% \ufc{The formulation of the next claim is problematic, as the notion of $e$ reducing $L^0$ is not defined. If you introduce notation for individual rounds, things become clearer. If $e$ is allocated in round $r$, then you compare $L^r - L^{r-1}$ with $B^r - B^{r-1}$, where $B^t$ denotes the total budget after round $t$.}

% \begin{claim}
% Let $\alpha\ge0.$ Consider the order of the allocation of items throughout
% the algorithm. For each item $e\in\mathcal{M}$ which is allocated
% to other agents, if it reduces $L^{0}$ by $b\cdot\alpha\geq o$,
% then the budget deduced from the agent winning the item is at least
% $\alpha$
% \end{claim}
% \begin{proof}
% Let $C'\subseteq C$ be the set of items agent $p$ already won when
% another agent wins item $e$. When the other agent wins item $e$,
% agent $p$ bids $v(e\mid C')\geq v(e\mid C)$. Thus, after deducting
% all the items of $C$ from the APS bundles, removing item $e$ decreases
% $L$ by at most $b\cdot v(e\mid C)$ (since the bundles of the APS
% partition in which item $e$ participates have a total weight of at
% most $b$), while the budget of the other agent decreased by at least
% $v(e\mid C')\geq v(e\mid C)$ (i.e., the budget of the other agent
% is reduced at least as the amount it reduces $L$)
% \end{proof}
% \begin{claim}
% Let $C\subseteq\mathcal{M}$ be the set of items agent $p$ won by
% time $f$. Then $C$ is reducing $L^{0}$ to $L^{f}$ by at most $v(C)$.
% \end{claim}
% \begin{proof}
% Consider one term in the sum of $L^{f}$ associated with the set $J\subseteq\mathcal{M}$.
% Then,
% \[
% v(J\setminus O\dot{\cup}C\mid C)=v((J\setminus O)\cup C)-v(C)\geq v(J\setminus O)-v(C)
% \]

% Since the above inequality holds for each term in the convex sum,
% the claim follows.
% \end{proof}

% By the above claims, other agent winning items reduce $L^{0}$ to
% $L^{f}$ by at most $b\cdot(b^{0}-2\rho b)=2\rho(b-b^{2})$ and hence $L^{f}$
% is at least
% \[
% L^{f}\ge APS-2\rho b+2\rho b^{2}-v(C)=b-2\rho b+2\rho b^{2}-v(C)=b\cdot(1-2\rho+2\rho b)-v(C)
% \]

% Recall that $L^{f}$ is a lower bound on the total \textbf{marginal
% value} of all remaining items (not yet allocated) in time $f$, and
% thus, agent $p$ is guaranteed to have a value of at least $v(C)+L^{f}\ge b\cdot(1-2\rho+2\rho b)=b\cdot(1-2\rho\cdot\frac{n-1}{n})$.

% Overall, by setting $\rho=\frac{n}{3n-2}$, agent $p$ is guaranteed
% to have at $\rho$ of her $APS$ as we wanted to show.

%\ufc{Review up to here}


%\begin{remark}
%There is slackness in the proof for equal entitlement, and hence the value of $\rho$ can probably be improved. Consider an agent $j \not= i$. If $j$ spent all her budget, she  won only two items. In general, if she won $k$ items she spent at most $\frac{k}{2k-2}$ fraction of her budget. If all agents but $i$ spent all their budget, then a weight of $\frac{2}{n}$ bundles still have value $1 - \rho$ left in them, and we can set $\rho = \frac{1}{2}$. Hence some agents do not spend all their budget, which should allow for a value of $\rho$ strictly larger than $\frac{1}{3}$. Try to provide rigorous proofs with as good bounds as possible, and further improve them when $n$ is small by having an additive $\Omega(\frac{1}{n})$ term.
%\end{remark}

%\gbc{The following 2 lemmas regarding $\rho=\frac{1}{3-2b_p}$ in the arbitrary entitlement case, since both cases of equal and arbitrary entitlements appears in \Cref{thm:1/3_APS_guarantee} and \Cref{lem:1/3 guarantee no large items}}
%\begin{lemma}
%\label{lemma:1-3 APS Arbitrary - using assumption no large items} In the case of the arbitrary entitlements, if $\rho = \frac{1}{3-2 b_p} (\le \frac{1}{3})$  and  there are no large items, i.e., $v_{p}(e) \le 2\rho APS_p$ for every item $e$, then the proportional bidding strategy guarantees agent $p$ a value of at least $\rho \cdot APS_p$.
%\end{lemma}




%\begin{lemma}
%\label{lem:1/3 arbitrary ent}
%When agents have arbitrary entitlements and agent $p$ has a submodular valuation function, setting $\rho$ to  $\frac{1}{3 - 2b_p}$, the proportional bidding strategy guarantees agent $p$ a value of at least $\rho \cdot APS_p$.
%\end{lemma}
%\begin{proof}
%In the proportional bidding strategy, in any round in which items with a value larger than $2\rho APS_p$ exist, agent $p$ bids her entire budget. If she wins one of these rounds, she guarantees herself $2\rho APS_{p}$. In case she did not win any of the first $s$ rounds, the agent simulates the bidding strategy on $\hat{I_{s}}$. A bid $p_{i}^{r}$ in $I_{s}$ is correlated with a bid of $\frac{1}{\gamma}\hat{p}_{i}^{r-s}$ in $\hat{I_{s}}$. Namely other agent bids $p_{i}^{r}$ in $I_{s}$ then $p$ simulate her bid in $\hat{I_{s}}$ as $\hat{p}_{i}^{r-s}=\frac{1}{\gamma}p_{i}^{r}$. Then, agent $p$ knows how to bid by considering scaling her bids in $\hat{I_{s}}$ by $\gamma$. Since the ratio between a budget of an agent in $I_{s}$ and in $\hat{I_{s}}$ is $\frac{1}{\gamma}$, by taking a bid of another agent $i$ in $I_{s}$ and scaling it by $\frac{1}{\gamma}$ we get a legal bid of the agent in $\hat{I_{s}}$. Similarly, scaling by $\gamma$ a bid of agent $p$ in $\hat{I_{s}}$ induces a legal bid in $I_{s}$. By \Cref{claim:APS not decrease in I_s}, the APS of agent $p$ at $\hat{I_{s}}$ is at least as the APS of $p$ in the original instance. Hence, by the end of the algorithm, agent $p$ will get the same bundle as she gets in the run on $\hat{I_{s}}$. Thus, by \Cref{lem:1/3 guarantee no large items}, this bundle is of value at least $\rho APS_p$ as desired.
%\end{proof}


%\begin{remark}
%For $n=42$, here is an example for which the proportional bidding strategy does not give $\rho > \frac{3}{8}$. There are $n-1$ additive agents and one submodular one. For every agent, the MMS partition is the same, and item values in every bundle are $(6,6,3,1)$. For the submodular agent, the $n$ items that are first in their bundle are all substitutes of each other. In the bidding, the submodular agent may first win a first item of value~6. Then 21 additive agents each win two items of value~6 (the second items in two different bundles), 14 additive agents each win three items of value~3 (the submodular agent does not bid~6 because the items of value~6 that remain are substitutes for the item that the agent already has), and 6 additive agents each win seven items of value~1. The items that remain have no value for the submodular agent.
%The conjectured worst case (for large number of agents) might be when some agents win two items, some three, and some seven. Then every bundle lost $(1 + \frac{1}{2} + \frac{1}{6})\rho = \frac{5\rho}{3}$, and using $1 - \frac{5\rho}{3} = \rho$ we get $\rho = \frac{3}{8}$. 
%\end{remark}



%\ufc{define the altruistic version of the bidding game and the $\rho$-proportional strategy, perhaps under different names.}


%\ufc{Remove:    So far, in \Cref{thm:1/3_APS_guarantee} we presented an algorithm based on a bidding game in which every agent has an initial budget, and in each round, the highest bidder chooses to pick an item. Each agent plays until she finishes her budget, and the game continues until there are no more items or the agents finish their budgets. Now we define another version of the bidding game in which agents might leave the game before finishing their budget.}


\subsection{Approximate MMS-fair allocations for submodular agents}
\label{sec:Approximated MMS-fair existance}

In the standard version of the bidding game, every agent has an initial budget, and in each round, the highest bidder picks an item. Each agent plays until she exhausts her budget, and the game ends when either there are no more items left, or all agents exhaust their budgets. Now we define another version of the bidding game, in which agents might leave the game before exhausting their budget.

%\ufc{Note to myself: should be $\rho$-altruistic game and 1-proportional bidding}
    
\begin{definition}
    The  $\rho$-altruistic version of the bidding game is the same bidding game with the change that every agent becomes inactive after spending a $\rho$-fraction of her budget. 
    % \gbc{Related to the next comment denoted with * - we need to choose one of the two. the budget of the agents is $b_p$ and she becomes inactive after spending $\frac{1}{2}$ of her budget
    % 2. the agent's budget is $2\rho MMS_p$ and she becomes inactive after spending $\rho$ of her budget
    % I think we should pick the second option. In the proofs we want to think of other agnets payments as the value of the items for agent $p$ (or at least an upper bound). I think considering each agent gets a budget of $2\rho b_p$ makes the arguments clearer}
\end{definition}

%\ufc{edit below, explaining the proportional bidding strategy when MMS=2.7 and so is the budget. Assume also that valuation is truncated at 2.7.}

We shall consider a bidding strategy for the $\rho$-altruistic bidding game, that we shall refer to as the {\em proportional bidding strategy}. We make two assumptions that simplify our presentation. These assumptions have no effect on the correctness of Theorem~\ref{thm:equal-10/27} that follows. These assumptions concern the submodular valuation function $v_p$ of agent $p$ that uses the proportional bidding strategy.

\begin{enumerate}
    \item The valuation function is scaled so that $MMS_p = b_p$ (the MMS of agent $p$ equals her entitlement).
    \item The valuation function is truncated at $MMS_p$ (as in Definition~\ref{def:$v^t_p$}). By Claim~\ref{claim:truncation}, this truncation does not affect the MMS value. 
    %\gbc{In the presentation of the proportional bidding strategy for the original version of the bidding game, I put the requirement of $p$ truncating her valuation function into the proportional bidding strategy. i.e, an agent who executes proportional strategy first truncates her valuation function}
\end{enumerate}

We now present the proportional bidding strategy, as used by agent $p$. At the beginning of round $r$, let $\items^r$ denote the set of items not yet allocated, let $C^r$ denote the set of items already allocated to $p$, and let $b_p^r$ denote the budget remaining for agent $p$. Then the agent bids $\max_{e\in\items^r}[v_p(e\mid C^r)]$  (the highest marginal value that a yet unallocated item has) %\gbc{Removed:, scaled by $\frac{b_p}{APS_p}$} 
if this bid is not larger than $b_p^{r}$, and bids her remaining budget $b_p^{r}$ otherwise. 
% \gbc{ * There is a problem - in the case of agent $MMS_p = b_p$, the bids of $p$ should be $\bold{\frac{1}{2\rho}}\cdot\max_{e\in\items^r}[v_p(e\mid C^r)]$, unless we assume the initial budget of the agent is $2\rho b_p$ and not $b_p$ (as done in the initial proof)} If the agent
% wins her bid, she selects the item with the highest marginal value with respect to $C^r$.




Recall \Cref{thm:equal-10/27}:
\altruistic*


% \begin{theorem}
% \label{thm:equal-10/27}
% In the equal entitlement case with submodular valuations, for $\rho = \frac{10}{27}$, every agent that uses the proportional strategy in the altruistic version of the bidding game is guaranteed to get a bundle of value at least a $\rho = \frac{10}{27}$ fraction of her MMS. 
% \end{theorem}


Before presenting the proof of Theorem~\ref{thm:equal-10/27}, we sketch the proof for a weaker version of the theorem, setting $\rho = \frac{4}{11}$ instead of $\rho = \frac{10}{27} > \frac{4}{11}$. Already this weaker version improves over the ratio of $\rho = \frac{n}{3n-2}$ of Theorem~\ref{thm:1/3_APS_guarantee} (when $n > 8$). Moreover, the proof of this weaker version of Theorem~\ref{thm:equal-10/27} conveys some intuition that may be helpful for following the proof of Theorem~\ref{thm:equal-10/27}. 

%\ufc{does this (and main theorem) work for APS with equal entitlement?}\gbc{No, at least not immediately. In our proof, we analyze inequalities implied by an MMS partition. for example when we analyze the distribution of the primary items in the MMS bundles. We also use claims such as no two primary items of type $X_1$ in the same MMS bundle.}

\begin{proposition}
\label{pro:4/11}
In the equal entitlement case with submodular valuations, for $\rho = \frac{4}{11}$, every agent that uses the proportional strategy in the altruistic version of the bidding game is guaranteed to get a bundle of value at least a $\rho = \frac{4}{11}$ fraction of her MMS. 
\end{proposition}

\begin{proof}
We only sketch the proof, as we shall later present a full proof for Theorem~\ref{thm:equal-10/27}.

If agent $p$ that uses the proportional bidding strategy manages to spend $\rho \cdot b_p$, then she also wins items of total value at least $\rho \cdot MMS_p$, and we are done. Hence it remains to exclude the case that agent $p$ failed to spend $\rho b_p$. In this case,  partition the agents other than $p$ into three classes, $X_0, X_1, Y$. 

Class $X_0$ contains those agents that by the end of the bidding game take only one item. %\gbc{Why add another demand on $X_0$ agent. Why not just agents that take only 1 item?} and at the time that the item was taken, the bid of agent $p$ was strictly larger than $\rho APS$. 
Intuitively, an agent $i$ of class $X_0$ who took one item does not ``hurt" $p$, because there are $n-1$ bundles in the MMS partition of $p$ from which agent $i$ does not take any item, and only $n-1$ agents (including $p$) compete for items in these bundles. Hence we may assume that no agent is in class $X_0$. See further details in \Cref{claim: no X_0 agents}. 
%\ufe{(This argument appears in a more rigorous form in the proof of Theorem~\ref{thm:1/3_APS_guarantee}, and hence further details are omitted here.)} \ufc{Instead: see more details in claim?} \gbc{I prefer: see more details in \Cref{claim: no X_0 agents}}

Class $X_1$ contains those agents that by the end of the bidding game take two items. Being in the $\rho$-altruistic bidding game implies that for the first item that such an agent $i$ took she paid at most $\rho b_p$ (here we use the fact that agents have equal entitlements), implying that the bid of $p$ at the time was at most $\rho b_p = \rho MMS_p$. By the proportional strategy, this bid was equal to the highest marginal value for $p$ for any of the remaining items at the time, and as the sequence of highest marginal values cannot increase as rounds progress, this further implies that the marginal $v_p$ values of items taken by agent $i$ is at most $2 \rho MMS_p$. A key observation is that if there are more than $\frac{n}{2}$ agents in class $X_1$, then there must be a bundle $B$ in the MMS partition of $p$ from which they took at least two items. As it does not matter for $p$ which of the agents in $X_1$ takes which of the items that the agents in $X_1$ collectively take (as long as each agent in $X_1$ takes two items, and each such item has marginal value at most $\rho b_p$), we may pretend that there is an agent $i$ in $X_1$ for which the two items that she takes are from this bundle $B$. This agent $i$ does not ``hurt" $p$, because there are $n-1$ bundles in the MMS partition of $p$ from which agent $i$ does not take any item, and only $n-1$ agents (including $p$) compete for items in these bundles. Hence, we may assume that at most $n/2$ agents are in class $X_1$. See further details in \Cref{claim: at most n/2 X_1  agents}.

Class $Y$ contains all remaining agents. Such an agent $i$ either takes no items (and then of course she does not hurt $p$), or takes only one item with marginal value (to $p$) of at most $\rho APS_p$, or takes $k \ge 3$ items. In the latter case, being in the $\rho$-altruistic bidding game implies that for her first $k-1$ items agent $i$ spent at most $\rho b_p$, and hence the bid of $p$ for the last item taken by $i$ was at most $\frac{1}{k-1} \rho b_p$. This implies that the total marginal $v_p$ values (with respect to items held by $p$) of items taken by $i$ is at most $\frac{k}{k-1} \rho MMS_p$. For $k \ge 3$, this is maximized when $k=3$, giving $\frac{3}{2} \rho MMS_p$.

Summing up, agents other than $p$ take a total marginal $v_p$ value of at most $\frac{n}{2}\cdot 2\rho MMS_p + (\frac{n}{2}-1)\cdot \frac{3}{2} \rho MMS_p = (\frac{7n}{4} - \frac{3}{2}) \rho MMS_p$. Hence from at least one of the bundles $B$ of the MMS partition of $p$, the total marginal value taken by other agents is at most $(\frac{7}{4} - \frac{3}{2n}) \rho MMS_p$. As the bidding game ended with $p$ spending strictly less than $\rho b_p = \rho MMS_p$, no items left in $B$ have any marginal value for $p$. Denoting the bundle that $p$ receives by $C$, this implies that $v_p(B\mid C)\leq (\frac{7}{4} - \frac{3}{2n})\rho MMS_p$. Hence. we have that $MMS_p \le v_p(B) \le v_p(B\mid C) + v_p(C) \le (\frac{7}{4} - \frac{3}{2n})\rho MMS_p + v_p(C)$. For $\rho = \frac{4}{11}$, the assumption that $v_p(C) < \rho MMS_p$ leads to a contradiction in the above inequality, thus proving that $v_p(C) \ge \rho MMS_p$, as desired.
\end{proof}

Observe that due to the slackness factor of $\frac{3}{2n}$ in the last paragraph of the proof of Proposition~\ref{pro:4/11}, we can adapt the proof to get a slightly better bound for $\rho$, of the order of $\frac{4}{11} + \Theta(\frac{1}{n})$. Though this slackness term does not substantially change the approximation ratio, it does prove useful for designing a polynomial time algorithm that outputs an allocation in which each agent receives at least a $\frac{4}{11}$ fraction of her APS. See more details in Section~\ref{sec:polynomial}.




Having seen the proof of Proposition~\ref{pro:4/11}, let us explain the source of improvement that leads to the proof of Theorem~\ref{thm:equal-10/27}. The $\frac{4}{11}$ approximation ratio (rather than a better one) comes from the possibility that agents other than $p$ take $2 \cdot \frac{n}{2}$ items of value $\rho MMS_p$, and $3 \cdot (\frac{n}{2}-1)$ items of value $\frac{1}{2}\rho MMS_p$, for a total value of nearly $\frac{7}{4} \rho MMS_p$. However, in this case the other agents take fewer than $3n$ items, implying that in at least one of the bundles of the MMS partition of $p$, they take at most two items, of values $\rho MMS_p$ and ${\frac{1}{2}\rho} MMS_p$ (recall that we may assume that no two items of value $\rho MMS_p$ are in the same bundle of $p$'s MMS partition). Hence one of these bundles still has value of $MMS_p - \frac{3}{2}{\rho}MMS_p$. The assumption that $p$ gets a value of at most $\rho MMS_p$ then implies {that} $MMS_p \le \frac{5}{2}\rho MMS_p$, implying that $\rho \ge \frac{2}{5}$.



The other agents may do damage to $p$ in a different way. $\frac{n}{2}$ agents might each take two items of value $\rho MMS_p$, $\frac{n}{3}$ agents might each take three items of value $\frac{1}{2}\rho MMS_p$, and $\frac{n}{6} - 1$ agents might each take six items of value $\frac{1}{5}\rho MMS_p$. Ignoring the missing one agent (that is important, but is ignored only for the sake of the argument), this allows the other agents to take three items from each MMS bundle, of values $\rho MMS_p$, $\frac{1}{2}\rho MMS_p$ and $\frac{1}{5}\rho MMS_p$. This leads to the inequality $MMS_p \le \frac{27}{10}\rho MMS_p$, implying that $\rho \ge \frac{10}{27}$. The proof of Theorem~\ref{thm:equal-10/27} shows that this is the most damage that the other agents can do. 
\bigskip
%\ufc{For COMSOC, rest of proof can be moved to appendix.}

We now present rigorous proofs for two claims that were used in the proof of \Cref{pro:4/11}, and will also be used in the proof of \Cref{thm:equal-10/27}. These claims imply that we can assume without loss of generality that there are no agents of type $X_0$, and at most $\frac{n}{2}$ agents of type $X_1$. For both claims, we present their proofs under a framework in which we prove by induction on $n$ (the number of players) the statement that the proportional bidding strategy guarantees a $\rho$ fraction of $MMS_{p}$ to agent $p$. The statement is clearly true for the base case of $n = 1$. Hence for a given value of $n > 1$, we just prove the inductive step (assuming that the statement has already been proved for all $n' < n$). To simplify the presentation of the proofs of the claims, we make two assumptions. We stress that these assumptions do not affect the correctness of the claims. (Alternatively, these assumptions can be turned into facts, by simply incorporating them as part of the description of the proportional bidding strategy.)


\begin{itemize}

\item Agent $p$ truncates her valuation function at $t=MMS_{p}$, (i.e.,
$v_{p}\leftarrow v_{p}^{t}$).

\item Agent $p$ fixes some order over $\mathcal{M}$ in order to break
ties consistently. If she wins a round and there is more than one item with the highest marginal value, she will break the tie by picking the item appearing earlier in this order.
%\ufc{So as to be able to compare bundles received in different runs}

\end{itemize}


\begin{claim}
\label{claim: no X_0 agents}
In the inductive framework presented above, suppose that there is an allocation instance $I$ with $n$ agents, and that agent $p$ has a submodular valuation function $v_p$ and uses the proportional bidding strategy. If in the run of the bidding game there is at least one agent of type $X_{0}$, then agent $p$ is guaranteed to receive a bundle of value at least $\rho MMS_p$.
\end{claim}

\begin{proof}
Recall that by our assumption, the original valuation function $v_p$ is truncated so that no bundle has value larger than $MMS_p$. Consider a run $R$ of the bidding game, in which agent $p$ uses the proportional bidding strategy with an order 
%\gbc{the notation of $O$ will be related soon to the set of items taken by \textbf{other} agents, therefore consider the notation $\Pi$ for permutation/order}. \gbc{Removed:$O$}
$\Pi$ over the items $\items$.
Suppose that in this run agent $i$ is of type $X_0$. Let $e$ denote the single item that agent $i$ takes, and let $r$ denote the round number in which $i$ took item $e$. Suppose for the sake of contradiction that in this run $R$ agent $p$ receives a bundle of value strictly smaller than $\rho MMS_p$. Then we show a new allocation instance $I'$ with only $n-1$ agents, and a run $R'$ in which an agent $p'$ that uses the proportional bidding strategy gets value smaller than $\rho {MMS_{p'}}$. This contradicts our induction hypothesis. 

The instance $I'$ contains $n-1$ agents and the set $\items' = \items \setminus \{e\}$ of items. The valuation $v_{p'}$ is identical to $v_p$, though defined only over $\items'$ (for every $S \subseteq \items'$ we have that $v_{p'}(S) = v_p(S)$). Note that even though there are $n-1$ agents, $MMS_{p'} = MMS_p$. (The MMS partition for $v_p$, after dropping the bundle containing $e$, can serve as an MMS partition for $v_{p'}$, showing that $MMS_{p'} \ge MMS_p$. Being truncated at $MMS_p$, we have that $MMS_{p'} \le MMS_p$.) The order {$\Pi'$} used by $p'$ over $\items'$ is identical to {$\Pi$} (but with item $e$ removed). The run $R'$ is identical to $R$, except for the following four changes:
\begin{itemize}
    \item Agent $i$ and her bids are removed.
    \item Agent $p'$ plays in $R'$ the role that agent $p$ played in $R$.
    \item Round $r$ (the one in which item $e$ was taken) is removed.
    \item All bids are scaled by $\frac{n-1}{n}$ (as the budgets of agents are $\frac{1}{n-1}$ rather than $\frac{1}{n}$)
\end{itemize} 
Consequently, the sequence of bids and item choices that $p'$ makes in $R'$, being derived from the bids of $p$ in $R$, is consistent with $p'$ using the proportional strategy. The bundle received by $p'$ in $R'$ is exactly the same bundle that $p$ received in $R$, and hence of value below $\rho {MMS_{p'}}$. This contradicts our induction hypothesis. 
%Now, consider the adversarial bids of other agents where agent $i$ gives a bid of her entire budget and takes item $e$, and the rest of the other agents raise the same bids as in the run in the original instance. Then each agent will have the same bundle at the end of the bidding game in both instances. In the latter instance, by removing agent $i$ and item $e$, we obtain a new instance with $n-1$ agents, and the $MMS$ value of $p$ stays the same (take the rest of $n-1$ MMS bundles do not contain $e$ in the original $MMS$ partition, with the rest of the items from $e$'s bundle spread arbitrarily, this partition for $n-1$ bundles serves as a witness for the $MMS$ value of $p$ stays the same). By induction, the proportional strategy guarantees $p$ a value of $\rho MMS_{p}$, and we handled this case.
\end{proof}







\begin{claim}
\label{claim: at most n/2 X_1  agents}
In the inductive framework presented above, suppose that there is an allocation instance $I$ with $n$ agents, and that agent $p$ has a submodular valuation function $v_p$ and uses the proportional bidding strategy. If in the run of the bidding game, more than $\frac{n}{2}$ agents are of type $X_{1}$, then agent $p$ is guaranteed to receive a bundle of value at least $\rho MMS_p$.
\end{claim}



\begin{proof}
Consider a run $R$ of the bidding game, in which agent $p$ uses the proportional bidding strategy with an order $\Pi$ over the items $\mathcal{M}$. Suppose that in this run, more than $\frac{n}{2}$ agents are of type $X_1$. Suppose for the sake of contradiction that in this run $R$ agent $p$ receives a bundle of value strictly smaller than $\rho MMS_p$. Then we show a new instance $I'$ with only $n-1$ agents, and a run $R'$ in which agent $p'$ that uses the proportional bidding strategy gets a value strictly smaller than $\rho MMS_{p'}$. This contradicts our induction hypothesis.


Consider an MMS partition $\{B_i\}_{i=1}^n$ with respect to $v_p$. Since there are more than $\frac{n}{2}$ agents of type $X_1$, there are at least $n+1$ items taken by these agents. Hence, there exists a bundle $B_i$ in the MMS partition that contains at least two of these items. Denote these items by $e_1$ and $e_2$, the agents who win them by $a_1$ and $a_2$, and the rounds in $R$ in which these items were taken by $r_1$ and $r_2$. 

The instance $I'$ contains $n-1$ agents and the set $\mathcal{M}'=\mathcal{M}\setminus\{e_1,e_2\}$ of items. The valuation $v_p'$ is identical to $v_p$, though defined only over $\mathcal{M}'$ (for every $S\subseteq\mathcal{M'}$ we have that $v_p'(S)=v_p(S)$). Note that even though there are $n-1$ agents, $MMS_{p'}=MMS_p$. ($\{B_i\}_{i=1}^n$, the MMS partition for $p$, can serve as an MMS partition for $p'$, after dropping the bundle containing $e_1$ and $e_2$, showing that $MMS_{p'}\geq MMS_p$. Being truncated at $MMS_p$, we have that $MMS_{p'}\leq MMS_p$). The order $\Pi'$ used by $p'$ over $\mathcal{M}'$ is identical to $\Pi$ (but with items $e_1,e_2$ removed). The run $R'$ is identical to $R$, except for the following changes:

\begin{itemize}

    \item Rounds $r_1$ and $r_2$ (the rounds in which items $e_1, e_2$ were taken) are removed.
    
    \item Agent $p'$ plays in $R'$ the role that agent $p$ played in $R$.

    \item Agent $a_1$ and her bids are removed. 
    
    \item If $a_1\neq a_2$ (i.e $e_1$ and $e_2$ were taken by different agents) then let $e_3$ denote the other item taken by $a_1$ in $R$, and let $r_3$ denote the round in which it was taken. In $R'$ 
    agent $a_2$ takes item $e_3$ in round $r_3$ (instead of $e_2$ that $a_2$ took in the run $R$ - recall that $e_2 \not\in \items'$).
    
    \item All bids are scaled by $\frac{n-1}{n}$ (as the budgets of agents are $\frac{1}{n-1}$ rather than $\frac{1}{n}$)

\end{itemize}

Consequently, the sequence of bids and item choices that $p'$ makes in $R'$, being derived from the bids of $p$ in $R$, is consistent with $p'$ using the proportional strategy. The bundle received by $p'$ in $R'$ is exactly the same bundle that $p$ received in $R$, and hence of value below $\rho MMS_{p'}$. This contradicts our induction hypothesis.
% Consider an agent $i$ who takes two items. We can assume each item is of value exactly $\rho MMS_{p}$. If it is not the case, consider the same instance but with the value of these two items raised to exactly $\rho MMS_{p}$ (more precisely for $S\mathcal{\subseteq M}$ includes this item, the new value of $S$ will be $\min\{MMS_{p},v_{p}(S)\}$). In this new instance, $p$ has the same $MMS$ (it can not go up due to the truncation step of $v_{p}$), and since there are no $X_{0}$ agents (\Cref{claim: no X_0 agents}), if there is an item worth more than $\rho MMS_{p}$, agent $p$ wins it and satisfied. Otherwise, these two items are with the highest value for $p$. Therefore, if agent $i$ gives two bids of $\rho$ in the very first two rounds, by adversarially tie-breaking of the bidding game, she can get these two items with value $\rho MMS_{p}$ each, and the same run of the original instance is a legal run of the bidding game in the new instance. At the end of the run, each agent will have the exact same items as in the original instance. Since we did not increase the MMS of $p$ in the new instance, she gets the same fraction of her $MMS_{p}$ at the end of the game in both instances.
% So far, we have shown that we can assume w.l.o.g, each agent of type $X_{1}$ wins items of value $\rho MMS_{p}$ each. Together with \Cref{claim: no X_0 agents} states that there are no agents of type $X_{0}$, we get that all the $X_{1}$ agents win their items at the beginning of the game (in consecutive steps). Thus, it is clear that the internal allocation of items of $X_{1}$ to the agents of $X_{1}$ does not affect the final bundle $p$ will have at the end of the algorithm. Hence we can assume w.l.o.g that if two items of $X_{1}$ agents have been taken from a bundle of the MMS partition of $p$, then they have been taken by the same agent and at the very first two rounds. Now by induction (similar to \Cref{claim: no X_0 agents}), in the instance without this agent and the two items, agent $p$ gets a bundle of value at least $\rho MMS_{p}$ as we wanted to show. 
\end{proof}

%\ufc{Also here you need to consider separately the case that there are items of value larger than $2\rho \cdot MMS$.}

%\gbc{
%The exact same proof as \cref{claim:APS not decrease in I_s} holds here, except the last argument - in \cref{claim:APS not decrease in I_s} we use \Cref{cl:item_reduce} to state that the $APS$ of agent $p$ in the instance $I_{\hat{s}}$ did not reduced. In the proof of this \Cref{thm:equal-10/27} our guarantee is based on the $MMS$. Hence, the argument should be that the $MMS$ of agent $p$ did not reduce in $I_{\hat{s}}$. This is because if we reduce an item and an agent from the instance, the original $MMS$ partition induces a partition in $I_{\hat{s}}$ for the remained agents, and the value of the minimal bundle did not reduce. (i.e., removing an agent and an item does not reduce the $MMS$ of the remained agents)}

%\ufc{Proof of what}
{We are now ready to prove \Cref{thm:equal-10/27}.}

\begin{proof}
Consider an arbitrary allocation instance with equal entitlement, and an arbitrary agent $p$ with a submodular valuation function $v_p$. We wish to show that by using the proportional strategy in the $\rho$-altruistic version of the bidding game (with a choice of $\rho = \frac{10}{27}$), $p$ receives a bundle of value at least $\frac{10}{27} \cdot MMS_p$. Equivalently (by scaling $v_p$ so that $MMS_p = \frac{27}{10}$), we wish to show that if $MMS_p = 2.7$, then $p$ receives a bundle of value at least~1. 

We begin by presenting a claim that will be used later.
Let $\left\{ B_{i}\right\} _{i=1}^{n}$ be an MMS partition of agent $p$, i.e., for each $i$ $v_{p}(B_{i})\geq MMS_{p}$. Let $f$ be the earliest round after which no other agents are active. Let $C$ denote the bundle $p$ has by the end of round $f$, and let $O\subseteq\mathcal{M}$ be the set of items taken by other agents.
The following claim is similar in nature to \Cref{Claim_second_bound_Lf}

\begin{claim}
\label{claim: No large value at each MMS bundle}
In the altruistic version of the bidding game, for each $i\in[n]$, the final value that $p$ has is at least 
\[\min\left\{ \rho MMS_{p},v_{p}(C)+v_{p}(B_{i}\setminus O\mid C)\right\} = \min\left\{ \rho MMS_{p},v_{p}(C
\cup\left\{  B_{i}\setminus O\right\})\right\}\]
\end{claim}

\begin{proof}
If $p$ is not active at the end of round $f$, then $p$ has a value of at least $\rho MMS_{p}$ at that time, i.e., $v_{p}(C)\geq\rho APS_{p}$, as desired. 

If $p$ is active at the end of round $f$, we consider two cases. If some items remain after round $f$, then agent $p$ is the only remaining active agent. Hence $p$ is the only agent to win items from $\mathcal{M}$. Then, the agent will keep winning items until either she becomes inactive (and has value at least $\rho MMS_{p}$) or until she wins all remaining items from $B_{i}\setminus O$. It remains to handle the case of agent $p$ being active after time $f$ while no items remain. In this case, $v_{p}(B_{i}\setminus O)=v_{p}(\emptyset)=0$, so the bound is trivial. 
\end{proof}

%\gbc{Removed: We set up a system of linear inequalities in which the variable $b$ expresses the $v_p$ value of the bundle that $p$ receives, and variable $z$ expresses the value of $MMS_p$ (hence we shall have the constraint $z = 2.7$). The linear inequalities encode various constraints on the $v_p$ value of items that agents other than $p$ receive, given that $p$ is using the proportional strategy and ends up with a value of $b$. We show that the system of inequalities is feasible only if $b \ge 1$, proving the lemma. }

%such that if any of the constraints is violated, the bundle received by $p$ under the $\rho$-proportional strategy necessarily has value strictly larger than~1.  Hence for the optimal value of $z$, we have that  $\alpha \ge \frac{1}{z}$. We show that by choosing $\rho = \frac{10}{27}$ in the $\rho$-proportional strategy, the constraints of the LP imply that $z \le \frac{27}{10}$, establishing that for this strategy $\alpha \ge \frac{10}{27}$, and proving the lemma.




 
Every negative example (i.e., an instance of the problem in which agent $p$ does not get at least $\rho MMS_p$) implies (by scaling the valuation function of the agent) the existence of another instance of the problem, in which $MMS_p = \frac{1}{\rho}$ and $p$ gets a bundle of value less than 1. Denote the $MMS$ of agent $p$ by $z$.
%and her MMS (which denoted $z$) is $\frac{1}{\rho}$.
%By scaling her valuation function, we can assume that $z=\frac{1}{\rho}$.
We set up a system of linear inequalities. The linear inequalities encode various constraints on the $v_p$ value of items that agents other than $p$ receive, given that $p$ is using the proportional strategy and ends up with a value of at most $1$. We show that the system of inequalities is feasible only if $z \le 2.7$. {This implies that %the fact that if $z \geq 2.7$ $p$ gets at least $1$ and having a $\rho$ guarantee, and 
$\rho \geq \frac{10}{27}$}. 

%\gbc{Removed: We claim that if $p$ uses the $\rho$-proportional strategy (with $\rho = \frac{10}{27}$), she gets a bundle of value at least~1 (and hence, at least her $\rho$-MMS).} 
% \gbe{Note that throughout the proof, we assume that there is no item $e$ which satisfies $v_p(e)\geq 2\cdot MMS_p$. Notice that the assumption does not harm loss of generality, since an existance of a negative instance on which  }

% The Linear Program's solution, which maximizes $z$, has a value of $2.7$. In order to show that this proves the
% lemma, assume by contradiction there exists a negative example, for $\rho'<\frac{10}{27}$. Then by the above argument, we will have another negative example in which the unsatisfied agent gets a value of at most $1$ and her MMS is $z=\frac{1}{\rho'}>2.7$. Now, this instance induces a feasible solution to the Linear Program with an objective value of $\frac{1}{\rho'}>2.7$, contradicting that the maximum is
% $2.7$. }



To simplify the presentation of the system of inequalities, we shall have a slight abuse of terminology. The term {\em payment} of an agent (say, for an item in round $r$) will correspond to the bid of agent $p$ (in round $r$), even though the actual payment might be larger (if the bid of the winning agent was strictly higher than the bid of agent $p$). With this abuse of notation, the sequence of payments that an agent makes is nonincreasing. This implies that the total payment of an agent that wins $t > 1$ items is at most $\frac{t}{t-1}$, because otherwise the agent spent more than~1 on the first $t-1$ items that she picked, and would become inactive before winning its $t$th item. Observe that the total payment of $p$ can be assumed to be not more than~1, as otherwise, the bundle that $p$ receives according to the proportional strategy has $v_p$ value at least~1, and we are done.


Consider a negative example for some $\rho$, i.e., an instance in which an agent does not get a $\rho$ fraction of her MMS, and she gets a value of at most $1$. Keeping this instance in mind, we will present our set of inequalities, and explain why the instance respects each of them.


The system of inequalities has nonnegative variables, $x_{1}, x_{2}, x_{3}, x_{4}, y, q, z$. For each $1 \le i \le 4$, $x_{i}$ represents the fraction of agents who satisfy the following two conditions:
\begin{enumerate}
\item The agent takes $i+1$ items.
\item The total payments that the agent made is at least $\frac{6}{5}$.
\end{enumerate}

The reason why we do not introduce a variable $x_0$ (for agents who take one item and pay at least $\frac{6}{5}$) is because Claim~\ref{claim: no X_0 agents} implies that we can assume that there are no such agents. This also implies that a payment for an item is never larger than~1.
Variable $y$ represents the fraction of the rest of the agents, those that either take at least six items or paid at most $\frac{6}{5}$. Observe that in either case, any such agent paid a total of at most $\frac{6}{5}$. 
Variable $z$ represents the MMS of agent $p$ (and recall that we scale the valuation $v_p$ so that $MMS_p = \frac{1}{\rho}$).
%\ufc{remove $a$ and use $v_p(C)$?} The variable $a$ represents the value that agent $p$ holds after round $f$. \ufe{Observe that if $a \ge 1$, then $p$ gets a bundle of value at least $\rho MMS_p$.}
%\gbc{Remove?: Notice that if at this time agent $p$ itself is also not active, then $p$ already holds a value of at least~1.} 
The variable $q$ needs a more detailed explanation. For every $0\le s\le\frac{1}{2}$, let $\alpha_{s}$ denote the fraction of agents that satisfy the following conditions:

\begin{enumerate}
\item The agent takes at least three items.
\item The total payments made by the agent is larger than $\frac{6}{5}$.
\item Her payment for the first item that she takes is $\frac{1}{2}+s$. 
\end{enumerate}

Note that this implies that the number of items that such an agent takes is either three, in which case her total payments are at most $\frac{3}{2}-s$, or four, in which case her total payments are at most $\frac{5}{4} - \frac{s}{2}$, which is smaller than $\frac{4}{3}-s$ for $s < \frac{1}{6}$ (note that if $s \ge \frac{1}{6}$ then her total payments when taking four items are at most $\frac{6}{5}$, and hence this case is excluded). The variable $q$ represents $\int_{0}^{\frac{1}{2}}s\cdot\alpha_{s}ds$.

%\gbe{Before we continue, we state an essential observation here. 
%Consider the MMS partition of agent $p$. In each step of the algorithm, assuming that agent $p$ is still active (this assumption is made without loss of generality, as otherwise she already got a value of at least $\rho \cdot MMS_p$), her bid is equal to the maximal marginal value among the remaining items. Therefore, if an agent other than $p$ wins the bid, whatever item $e$ she picks, she pays at least the marginal value that $e$ has to $p$.
%\gbc{Should we remove the two previous sentences? It is explained in the beginning of the proof when presenting the notion of \emph{payments} and why it is a slight abuse of notation} \ufc{Please write and explain this properly: Thus, if we look at a bundle $B_{i}$ from the MMS partition of agent $p$, and we denote by $B\subseteq B_{i}$ as the items other agents win throughout the algorithm, the total payments which other agents paid for items $B$ are at least as the marginal value of $B$ to agent $p$, w.r.t the items she won until all agents become inactive.} \gbc{Uri, I explained this properly in \Cref{claim: No large value at each MMS bundle}} \gbc{remove the next text in blue? We present the notation of time $f$, bundle $C\mathcal{M}$ at the beginning of the proof, before \Cref{claim: No large value at each MMS bundle}}\gbe{More formally, as in \Cref{thm:1/3_APS_guarantee} proof, we denote $f$ to be the earliest round, after which either all other agents become inactive or all items have been allocated. In addition, we denote $C\subseteq\mathcal{M}$ to be the set of items agent $p$ has by the end of round $f$. In a similar way to  \Cref{claim_other_agent_items_reducing_Lf} proof, we obtain that any item $e$ won by another agent $i$ she pays at least $v_p(e\mid C)$. Consider $\{B_i\}_i$ to be an $MMS_p$ partition of agent $p$. Then, the payment of other agents who won a bundle $B\subseteq B_i$ is at least $\sum_{e\in B}v_p(e\mid C)\geq v_p(B\mid C)$}}

{We turn to present the linear inequalities, and explain why each of these inequalities must hold if $p$ executes the proportional bidding strategy}

\begin{enumerate}

\item $x_{1}+x_{2}+x_{3}+x_{4}+y \le 1 - \frac{1}{n}$. The variables $x_1, x_2, x_3, x_4, y$ represent fractions of the total number of agents, and agent $p$ is not included in these fractions. As the total number of agents is $n$, the sum of the fractions is at most $1 - \frac{1}{n}$.


{\item $z-2x_{1}-(3/2)x_{2}-(4/3)x_{3}-(5/4)x_{4}-(6/5)y+q \leq 1$. Fix
$\left\{ B_{i}\right\} _{i=1}^{n}$, an MMS partition for agent $p$.
Since we assume $p$ is active at the end of the algorithm, \Cref{claim: No large value at each MMS bundle} implies that the final value of $p$ is at least $v_{p}(C) + v_{p}\left\{ B_{i}\setminus O\mid C\right\} )$. %\ufc{remove next sentence?}\gbc{This is a justification for the first inequality in the coming chain of inequalities.} 
Since the final value of $p$ is at most $1$, we obtain $1\geq v_{p}(C) + v_{p}\left\{ B_{i}\setminus O\mid C\right\} )$

Recall that $O\mathcal{\subseteq M}$ is the set of items taken by other agents. Consider the following partition of $O$ , $\left\{ O_{i}=B_{i}\cap O\right\} _{i=1}^{n}$. Then, for each $i$, 
%\ufc{More simply: $v_p(C) + v_p(O_i|C) = v_p(B_i) \ge z$ implies that $v_p(C) \ge z - v_p(O_i|C)$.} \gbc{I believe your statement is not true, since $v_p(C) + v_p(O_i|C) \leq v_p(B_i)$ But the inequality might be strict. Recall that $C$ is the bundle $p$ has by round $f$ which is not necessarily the end of the bidding game. I.e., $(C\cap B_i)\cup O_i\subseteq B_i$ but the inclusion might be strict.}
\begin{align*}
1 & \geq v_{p}(C)+v_{p}\left\{ B_{i}\setminus O\mid C\right\} )\\
 & =v_{p}(C)+v_p(B_{i}\setminus O_{i}\mid C)\\
 & \geq v_{p}(C)+v_{p}(B_{i}\mid C)-v_{p}(O_{i}\mid C)\\
 & =v_{p}(C\cup B_{i})-v_{p}(O_{i}\mid C)\\
 & \geq v_{p}(B_{i})-v_{p}(O_{i}\mid C)\\
 & =z-v_{p}(O_{i}\mid C)
\end{align*}


Denote the total payments of agents other than $p$ as $P_O$. Notice that $\sum_{i}v_{p}(O_{i}\mid C)\leq\sum_{i}\sum_{e\in O_i} v_{p}(e\mid C)\leq P_O$.
 Hence, there exists $i\in[n]$ for which $v_{p}(O_{i}\mid C)\leq\frac{1}{n}\cdot P_O$.
 
We now upper bound $\frac{1}{n}\cdot P_O$. Recall that the total payment of an agent that takes $t > 1$ items is at most $\frac{t}{t-1}$. Moreover, if agents of type $x_{2}$ and $x_{3}$  have a payment strictly larger than $\frac{1}{2}$ for their first item, then they do not reach the maximum payment they can achieve ($\frac{3}{2}$ and $\frac{4}{3}$). By the definition of $q$, we obtain that their total payment is reduced by at least $q$. (Recall the discussion that follows the definition of $q$. It shows that if an agent of type $x_{2}$ pays $\frac{1}{2}+s$ for her first item, then the maximum payment she might reach after taking her three items is at most $\frac{3}{2}-s$. Likewise, it shows that if an agent of type $x_{3}$ pays $\frac{1}{2}+s$ for her first item, then the maximum payment she might reach after taking her four items is at
most $\frac{4}{3}-s$.) Therefore we have
\[
\frac{1}{n}\cdot P_O {\leq}2x_{1}+(3/2)x_{2}+(4/3)x_{3}+(5/4)x_{4}+(6/5)y-q
\]
The constraint follows by using this last inequality and the two previous inequalities $1 \geq z-v_{p}(O_{i}\mid C)$ and $v_{p}(O_{i}\mid C) \le \frac{1}{n}P_0$.
%\gbc{Removed:, and the requirement that $v_p(C) \le 1$.}
% \gbc{Consider the above constraint instead of this and Remove:\\ $-2x_{1}-(3/2)x_{2}-(4/3)x_{3}-(5/4)x_{4}-(6/5)y+(2/3)q-a+z\le1-a$.
% $\quad$ Consider the time when all other agents are inactive. Then,
% every bundle $B_{i}$ of the MMS partition of the first agent will
% have less than $1-a$ marginal-value w.r.t the items the first agent
% already won throughout the algorithm (with a total value of $a$).
% Otherwise, the agent will take one of the remaining bundles, ensuring
% herself a value of 1. So z is upper bounded by the sum of payments
% paid by agents, plus 1. In order to upper bound the payments
% of agents, recall that the bidding sequence of each agent is decreasing.
% Combining this with the fact that an agent becomes inactive when surpassing
% a payment of 1, we have that agent of type $x_{1}$ pays at most
% 2 , agent of type $x_{2}$ pays at most $\frac{3}{2}$, etc. Now,
% if agents of type $x_{2}$ and $x_{3}$ pay for their first item,
% a payment strictly more than $\frac{1}{2}$, then they do not reach
% the maximum payment they can achieve (2, and $\frac{3}{2}$). By the
% definition of $q$ we obtain that the amount of payment reduced is
% at least $\frac{2}{3}q$ (if an agent of type $x_{2}$ pays $\frac{1}{2}+s$
% in her first item, then the maximum payment she might have after taking
% her three items is at most $\frac{3}{2}-s$. Likewise, an agent of
% type $x_{3}$ who pays for an item a payment of $\frac{1}{2}+s$ in
% the first item will have reached a total payment of at most $\frac{4}{3}-\frac{2}{3}s$).
% Therefore we have $z\le2x_{1}+(3/2)x_{2}+(4/3)x_{3}+(5/4)x_{4}+(6/5)y-\frac{2}{3}q+a+1-a$.
% By rearranging, we obtain the above constraint.}
\item $2x_{1} \le 1$. 
% \gbc{Removed:We can assume that the instance is reduced and is a
% minimal negative example in the number of agents. We claim that in the reduced instance, at most half the agents pick two items. Otherwise, there is a bundle in which two items are picked. Remove it and one of the agents, and we get a smaller negative example.}
We can assume that at most half of the agents are of type $x_1$, by \Cref{claim: at most n/2 X_1  agents}.

{
\item $\frac{6}{5}y+q \geq (z-1-\frac{3}{2})\cdot\left(3-2x_{1}-3x_{2}-4x_{3}-5x_{4}\right)$. {(This is not a linear inequality, but it will be linearized before it will be used.)}
% $-(2/5)x_{1}-(3/5)x_{2}-(4/5)x_{3}-x_{4}-(6/5)y-q\le-(3/5)$. 
We refer to items taken by agents represented by $x_{1},x_{2},x_{3},x_{4}$ as \emph{primary}, and to items taken by agents represented by $y$ as \emph{secondary}. How much payment do secondary items need to have so that payment of at least $z-1$ is paid for items in each bundle $B_i$ of the MMS partition (which is a necessary condition for $p$ having a total value of at most $1$ \Cref{claim: No large value at each MMS bundle})? The total number of primary items is $(2x_{1}+3x_{2}+4x_{3}+5x_{4})n$. We split the argument into two cases.

In the first case, there are at most $3n$ \emph{primary} items. The number of primary items missing to complete this number to $3n$ is $(3-2x_{1}-3x_{2}-4x_{3}-5x_{4})n$. {We refer to each such missing item as a \emph{deficiency unit}.} As noted above, we assume no two primary items of agents of type $x_{1}$ are taken from a single bundle. 
{We analyze the distribution of \emph{deficiency units} over the MMS bundles when a bundle with $\ell\leq3$ \emph{primary} items has $3-\ell$ \emph{deficiencies}. Then, we will find properties of the distribution of \emph{deficiencies} that minimizes the amount of payment to be paid by $y$ agents to reach $z-1$ payment in each MMS-bundle.

\begin{itemize}

    %\item A bundle $B_j$ in the MMS-partition with 0 deficiencies has three \emph{primary} items. In these three \emph{primary} items, there is at most one primary item of type $X_1$ agent, with a payment of $~1$. The remaining two primary items are valued at most $\frac{1}{2}+s$ each. Summing these three payments together, we obtain a total payment larger than $z-1$ for $z\leq3$. Thus, there is no guaranteed payment that needs to be paid by $y$ agents in such bundle $B_j$ with 0 \emph{deficiency units}
    %\gbc{Uri,  I think we should consider keeping the above bullet, analyzing a bundle of 0 unit-deficiencies. In every other bullet, we take the amount of payment needed to complete to $z-1$ and divide it by the amount deficiency units. In a sense, this bullet shows that in our analysis, the deficiency units indeed responsible for most of the payment should be paid by $y$ agents, so a bundle with no deficiencies might not have payments of $y$ agents.}
    %\ufc{I recommend removing this bullet. Otherwise, it needs serious rewriting. Each how can it have two primary items of payment $\frac{1}{2} + s$?}
    %\gbc{If you recommend removing this bullet, I will remove it. However, a bundle $B_j$ might have two primary items with payments $\frac{1}{2}+s_1$ and $\frac{1}{2}+s_2$ if they have been taken by different agents of type (Of type $x_i$ for $i>1$)}

    \item A bundle $B_j$ in the MMS partition with one \emph{deficiency unit}, has a payment for \emph{primary} items of at most $1+\frac{1}{2}+s$.  At least $z-1-\frac{3}{2}-s$ needs to be paid  by $y$ agents in order to surpass a $z-1$ payment in $B_j$. I.e., a $z-1-\frac{3}{2}-s$ for the one unit of deficiency.

    \item A bundle $B_j$ in the MMS partition with two \emph{deficiency units} has a payment for \emph{primary} items of at most $1$. At least $z-1-1$ needs to be paid by $y$ agents to surpass a $z-1$ payment in $B_j$. I.e., a $\frac{z-2}{2}$ on average per \emph{deficiency unit}.

    \item A bundle with three \emph{deficiency units}, needs a payment of at least $z-1$ by $y$ agents. I.e., a $\frac{z-1}{3}$ on average for per deficiency unit.
    \end{itemize}
    
    For $z\leq 3$, the minimum payment per deficiency occurs when every deficiency unit is in a different bundle (i.e., these bundles have one deficiency unit, the case of bullet two).}
%\ufc{impossible to understand next sentence} \gbc{Removed: The worst case, when there is the maximum payment to be paid by $y$ agents to reach $z-1$ payment in each bundle, is when each bundle is missing a primary item in a different bundle.} 
Then, in each bundle with two primary items, one item can have payment arbitrarily close to~1, and the other $\frac{1}{2}+s$, with $s$ as above. Hence, to reach $\sim(z-1)$, the bundle needs $\sim(z-1-\frac{3}{2})-s$. As integrating over \emph{all} $s$ we get $q$, the above considerations give the constraint $(6/5)y\ge(z-1-\frac{3}{2})\cdot(3-2x_{1}-3x_{2}-4x_{3}-5x_{4})-q$ as desired. 

In the second case, the number of {primary} items is greater than $3n$. {If $z > 2.5$, then the right-hand side of constraint~4 is a product of a positive scalar and a negative scalar, resulting in a negative scalar. By non-negativity of variables $q$ and $y$, the left-hand side of the constraint is a non-negative scalar. Hence constraint~4 is valid for the range of values of $z$ which will be considered in the proof, which only includes values larger than $2.5$.}

%\ufc{remove: Here we observe that we may assume \ufc{not true for small $n$} that $z > 2.5$. This follows from \Cref{hard instance altruistic version} (setting $k=2$ it its proof), which implies that for $\rho \geq 0.4$, the $proportional(\rho)$ does not guarantee a $\rho$ fraction of the $MMS$. As $z$ is supposed to equal $\frac{1}{\rho}$, we get that the range of interest for $z$ is only $z > 2.5$. Thus, in case there are more than $3n$ primary items, the right-hand side of constraint~4 is a product of a positive scalar and a negative scalar, resulting in a negative scalar. By non-negativity of variables $q$ and $y$, we obtain that the left-hand side of the constraint is a non-negative scalar. Overall, in case there are more than $3n$ \emph{primary}, the constraint states that a non-negative scalar is greater than a non-positive scalar, which is always true.}
% Observe that if the number of primary items is at least $3n$, the constraint holds immediately since the right-hand side of the inequality is negative while the left-hand side is positive.
}
}
\end{enumerate}

{The fourth constraint is not a linear inequality. Nevertheless we may make use of the system of four constraints as if it is a system of linear inequalities. We do so by substituting candidate values for $z$ (these values are larger than $2.5$, so that the fourth constraint remains valid), simplifying the second and fourth constraints after making this substitution, and checking whether the resulting system of inequalities is feasible. If it is not feasible, this certifies that the substituted value for $z$ was too high, and hence we obtain an upper bound on $z$. Substituting $z = 2.7$, the constraints become:

\begin{enumerate}
\item $x_{1}+x_{2}+x_{3}+x_{4}+y \leq 1 - \frac{1}{n}$
\item $- 2x_{1}-\frac{3}{2}x_{2}-\frac{4}{3}x_{3}-\frac{5}{4}x_{4}-\frac{6}{5}y+q \leq -1.7$
\item $2x_{1} \leq 1$
\item $-\frac{2}{5}x_{1}-\frac{3}{5}x_{2}-\frac{4}{5}x_{3}-x_{4}-\frac{6}{5}y-q \leq -\frac{3}{5}$. 
\end{enumerate}

Summing up the four constraints multiplied by coefficients $(1.8,1,0.2,0.5)$ 
respectively, we obtain:

$$(\frac{2}{5} - \frac{1}{3})x_3 + \frac{x_4}{20} + \frac{q}{2}  \le -\frac{1.8}{n}$$

As $x_3$, $x_4$ and $q$ are non-negative, this is a contradiction. Hence $z < 2.7$. In fact, the term $-\frac{1.8}{n}$ on the right hand side implies that $z \le 2.7 - \Omega(\frac{1}{n})$, which in turn implies that $\rho \ge \frac{10}{27} + \Omega(\frac{1}{n})$.}
\end{proof} 
%\gbc{Discuss with Uri about this proof.
% I believe the mistake in the previous version was assuming $n>1$. In case $n=1$ constraint 4 is no longer true. When $n=1$, there are no other agents, thus $x_i, y, q$ must be zero, and the forth constraint is reduced to $0\geq(z-1-\frac{3}{2})\cdot(3-0)$}

%\ufc{Note to Gilad. There are edits that we are doing in the arxiv version that you need not transfer to the thesis. However, the edits done in this last proof will have to be transferred into the thesis, as without them the proof is not readable.}


%\gbe{Observe that due to the slackness factor of $\frac{1}{n}$ in the first constraint (namely, the other agent are $(1-\frac{1}{n})$ of all agents), we can adapt the proof to get a slightly better bound for $\rho$, of the order of $\frac{10}{27}+\Theta\left(\frac{1}{n}\right)$. Though this slackness term does not substantially change the approximation ratio, it does prove useful for designing a polynomial time algorithm that outputs an allocation in which each agent receives at least a $\frac{10}{27}$ fraction of her APS. See more details in Section \Cref{sec:polynomial}}\\

%\ufc{remove next proof after approving previous one}

%\begin{proof}
%Consider the LP over the nonnegative variables, $x_1, x_2, x_3. x_4, y, q, z$. The LP assumes that item values are scaled by $\frac{1}{\rho}$, so that an item that had value $\rho$ now has value~1. $x_i$ represents the fraction of agents who take $i+1$ items, and moreover, the total value of items that they take is greater than $\frac{6}{5}$. $y$ represents the fraction of agents who take items of total value at most $\frac{6}{5}$, which in particular includes all agents that take at least six items. $z$ represents $\frac{1}{\rho}$, so maximizing $z$ minimizes $\rho$. We shall prove that $z \le 2.7$, implying that $\rho \ge \frac{10}{27}$. The variable $q$ needs a more detailed explanation. For every $0 \le s \le \frac{1}{2}$, let $\alpha_s$ denote the fraction of agents that satisfy three conditions: the first item that she takes has value $\frac{1}{2} + s$, the total values of items that she takes is larger than $\frac{6}{5}$, and the number of items that she takes is at least three. Note that this implies that the number of items that such an agent takes is either three (and then the total value that she takes is at most $\frac{3}{2} - s$) or four (and then the total value that she takes is smaller than $\frac{4}{3} - s)$. The variable $q$ represents $\int_0^\frac{1}{2} s\cdot \alpha_s ds$.

%The LP maximizes $z$ under the following constraints (writing them to be in canonical form):

%\begin{enumerate}
    
%    \item $x1 + x2 + x3 + x4 + y \le 1$. (The fraction of agents that pick items is at most~1.)
    
%    \item $-2*x1 - (3/2)*x2 - (4/3)*x3 - (5/4)*x4 - (6/5)*y + q + z \le 1$. ($z$ is upper bounded by the sum of item values.)
    
 %   \item  $2*x1 \le 1$. (At most half the agents pick two items. Otherwise, there is a bundle in which two items are picked. Remove it and one of the agents, and we get a smaller negative example.)
    
 %   \item $-(2/5)*x1 - (3/5)*x2 - (4/5)*x3 - x4 - (6/5)*y5 - q \le -(3/5)$. (We refer to items taken by agents represented by $x_1, x_2, x_3, x_4$ as {\em primary}, and to items taken by agents represented by $y$ as {\em secondary}. How much value do secondary items need to have so that a value of at least~1.7 is taken from each bundle (which is a necessary condition in order to have $z \ge 2.7$)? The total number of primary items is $(2x_1 + 3x_2 + 4x_3 + 5x_4)n$. The number of primary items missing to complete this number to $3n$ is $(3 - 2x_1 - 3x_2 - 4x_3 - 5x_4)n$. The worst case is when each missing primary item is missing in a different bundle. Then in each bundle with two items, one item can have value~1, and the other value $\frac{1}{2}+s$, with $s$ as above. Hence to reach~1.7 the bundle needs~$0.2-s$. As integrating over {\em all} $s$ we get $q$, the above considerations give the constraint  $(6/5)*y5 \ge 0.2(3 - 2x_1 - 3x_2 - 4x_3 - 5x_4) - q$.) 
%\end{enumerate}

%Summing up the four constraints multiplied by coefficients \ufe{$(1.8, 1, 0.2, 0.5)$} respectively, and using nonnegativity of the variables, we obtain the desired inequality $z \le 2.7$.
%\end{proof}


%In the arbitrary entitlement case, it is no longer true that if we remove a single agent and a single item, the APS of other agents does not decrease. Due to this reason, we add the following preprocessing stage to the algorithm.


%Fix $\rho' = 2\rho^2$. The preprocessing stage guarantees each agent that becomes inactive at least a $\rho'$ fraction of her APS. Taking $\rho = \frac{1}{3} + \Omega(\frac{1}{n})$ we get $\rho' = \frac{2}{9} + \Omega(\frac{1}{n})$.


%Initially all agents are active. Sort the agents from highest entitlement to lowest entitlement. Scan the agents in this order. For each agent $i$, if there is no item of value $\rho' b_i$, move to the next agent. If there is an item $e$ with $v_i(e) \ge \rho' b_i$, then do the following. Let $j$ be the active agent among those that have higher entitlement than $i$ (that is, $j < i$) for which $e$ has highest value. 

%\begin{enumerate}

%\item If $v_j(e) \le 2\rho b_i$, then give item $e$ to agent $i$ and make agent $i$ inactive. For agents with lower entitlement than $i$, the APS does not decrease \gbe{(by Claim \ref{cl:item_reduce})}. For agents with higher entitlement than $i$, this does not harm the analysis in the proof of Lemma~\ref{lem:equal}.

%\item If $v_j(e) > 2\rho b_i$, then give $e$ to agent $j$, and decrease the budget of $j$ by $b_i$ \gbc{It might be that agent $j$ has a total budget less than $b_i$}. For agent $i$ and agents with lower entitlement than $i$, the APS does not decrease \gbe{(by Claim \ref{cl:item_reduce})}. For agents with higher entitlement than $i$, this does not harm the analysis in the proof of Lemma~\ref{lem:equal}. If agent $j$ spent already $\rho b_j$, then make agent $j$ inactive. Observe that in this case agent $j$ has value at least $\rho \cdot 2\rho b_j = \rho' b_j$.

%\end{enumerate}

%The parameters of the algorithm above can be improved to $\rho' = \frac{7 - \sqrt{33}}{4}$ and $\rho = \frac{\sqrt{33} - 3}{6}$. For simplicity of the computations, let us present the analysis for suboptimal parameters $\rho' = \frac{3}{10}$ and $\rho = \frac{3}{7}$. Observe that if there are no items of value $\rho' b_j$, then in the main part of the algorithm every agent $j\not= i$ that becomes inactive spends budget of at most $\max[2\rho', \frac{3}{2}\rho]b_j < (1 - \rho')b_j$ \gbe{(if the agent wins 2 items, she spends at most $2\rho'b_j$. If she wins 3 items or more, she spends at most $\frac{3}{2}\rho b_j$)} . Hence the last active agent $i$ can take items of value at least $\rho' b_i$, and become inactive as well. In the preprocessing stage change the test to $v_j(e) \le (1 - \rho') b_i$. Note that if agent $j$ spends $\rho b_j$, she gets a value of at least $(1 - \rho')\rho b_j = \rho' b_j$.


%Using the above analysis we can plug $\rho = 0.3$ (in fact, a slightly higher value of $\frac{7 - \sqrt{33}}{4}$) in Theorem~\ref{thm:APSsubmodular} (note that our $\rho'$ is the approximation ratio $\rho$). 

% \begin{remark}
% Future work can try to improve the approximation ratio for submodular valuations further, both for equal entitlement and for arbitrary entitlement. One may also consider XOS valuations, subaddtive valuations, and subclasses of submodular such as GS, budget additive or coverage.
% \end{remark}


\subsection{Polynomial time algorithms}
\label{sec:polynomial}

%\gbe{We begin by briefly reviewing our results concerning polynomial time implementations of our result.}

Theorems~\ref{thm:1/3_APS_guarantee} and~\ref{thm:equal-10/27} imply (among other things) the existence of allocations that give each agent with a submodular valuation a certain fraction of her APS (or MMS). However, they do not provide polynomial time algorithms to find such allocations, because they assume that the value of the APS (or MMS) is known (or can be computed by the agent), whereas computing this value is NP-hard. Nevertheless, by using a technique presented in \cite{DBLP:conf/sigecom/GhodsiHSSY18}, we obtain a polynomial time implementation, proving \Cref{cor:polyTimeSubmodular}. The basic idea is as follows. One runs the bidding game with all agents using our proposed proportional strategy, but each agent starts with an estimate for her MMS (or APS) that is higher than the true value. If all agents get the desired fraction of their estimated MMS, we are done. If not, then for those agents that get a fraction that is too small, we lower their estimate for their MMS by a factor of $(1 - \epsilon)$, and repeat the whole process. No agent will ever need to lower her estimate to below a $(1 - \epsilon)$ fraction of her true MMS. We now provide more details.



\input{polynomial.tex}

\input{Hard_Instances_Submodular.tex}

\input{XOS_hardness_of_approximation_bidding_game.tex}



\bibliographystyle{alpha}
\bibliography{Refrences_DB}

\input{appendix}

\end{document}

There is slackness in our allocation algorithm, and hence it is likely that more sophisticated algorithms will give each agent an even higher fraction of her APS.



The proposed algorithm is a bidding strategy for the bidding game of [BEF21] (the version in which the winner of the bid can buy as many items as her budget allows).

The proposed strategy is as follows (for valuation functions normalized as in the theorem). (Note that we do not assume that the instance is ordered, as the transformation of Bouvert and Lamaitre assumes additive valuations.) Each agent bids the value of the item of highest marginal value to her. Note that we may assume that no item has value larger than the initial budget of the player, as truncating values would not lower the APS. The highest bidder wins. If the winner bid more than half her remaining budget, she takes a single item. If she bid at most half her remaining budget she make take more than one item. The optimal rule for how many items to take might be complicated. The simple rule of always taking one item should suffice in order to prove the theorem. The following extension may suffice in order to improve $\rho$: if this is the first time the agent wins a bid, and taking two items suffices in order to reach $\rho$ fraction of the APS, then take two items. In any other case, take only one item.

When an agent spends $\rho$ fraction of her budget, she leaves the game.

After each round, the winning agent updates her valuation function for the remaining items, to be the marginal value with respect to the items that she already holds. Consequently, the sum of marginal values of remaining items goes down.  A better value of $\rho$ may possibly be obtained by a careful choice of scaling the marginal valuation function, but might not be necessary if one only wants to prove the theorem. (If scaling is used, then an agent leaves the game  once she accumulated a $\rho$ fraction of her APS. This might requiring spending more than a $\rho$ fraction of her budget.)

The analysis will need to bound how much the marginal values decrease when an agent wins an item. They cannot decrease by too much due to the existence of an APS fractional partition, as it implies that for an item of low value, it cannot be that all other items are substitutes for it. 

Let us first provide analysis for the case of equal entitlement (MMS partition). For an agent with entitlement $1/n$, a lower bound on the initial sum of marginal values is~1, as there are $n$ bundles, each of value at least $\frac{1}{n}$. Whenever another agent wins an item, the lower bound decreases by at most the bid of the other agent. Whenever the agent wins an item of value $\delta$, the lower bound decreases by at most $n\delta$ (as each of the $n$ bundles in the MMS partition loses at most $\delta$ in its total value).

For MMS, we can take $\rho=\frac{1}{3}$. If some agent wins only a single item, she does not harm the MMS of other agents. If an agent wins at least two items, she spends at most $\frac{2}{3n}$ altogether. Hence other agents can cause the sum of marginal values to decrease by at most $\frac{2(n-1)}{3n} < \frac{2}{3}$. The agent herself can win items of total value $\frac{1}{3n}$ until no value is left. 

If true, the above recovers the previously known result of an allocation giving $\frac{1}{3}$ fraction of the MMS in the equal entitlement case, and suggests also an improvement by an $\Omega({1}{n})$ term. This new proof for MMS is more amenable to extensions to APS, as it does not make the explicit assumption that no item is worth more than a third of the APS.  


 