
{
\SetKwComment{Comment}{/* }{ */}
\SetCommentSty{footnotesize}
\SetAlFnt{\small}
\SetAlgoNlRelativeSize{-2}

\begin{algorithm}[t]
    \caption{
        \textbf{Our rendering algorithm.}
    }
    \label{alg_rendering}

    \ForEach{detector (pixel) $\mathcal{D}$}{
        $I \gets 0$%
        \Comment*[r]{will hold the computed detected intensity}

        \For(\Comment*[f]{sample the backward light transport}){$n \gets 1$ to $N$}{ 
            {\color{blue}{\small $\qty{\va{r}_0,\!\va{k}_0,\!\beta,\rho}$}$\gets$ source generalized ray}%
            \Comment*[r]{\cref{MC_sourcing}}

            % $\vb{\pi} \gets (n)$%
            % \Comment*[r]{tracks path indices}

            $\alpha \gets \tfrac{\alpha^{(n)}}{N p^{(n)}} $%
            \Comment*[r]{path weight; p is sampling probability}

            % \While{$\abs{\vb{\pi}}<$ max path depth}{
            \While{path depth $<$ max depth}{
                { \color{red!80!black}propagate the generalized ray {\small $\qty{\va{r}_0,\!\va{k}_0,\!\beta,\!\rho}$}}\;

                \BlankLine
                \Comment{measurement, or solve pass (\cref{section_sample_solve})}
                { \color{green!65!black}\small 
                $I \gets I + \alpha\cdot\mathfrak{I}\qty{
                    g_{\beta,\rho}\qty(\va{r}^\prime,\va{k}^\prime \argsep \va{r}_0, \va{k}_0)
                }$}%
                \Comment*[r]{\cref{measurement_operator}}

                \BlankLine
                \Comment{light-matter interaction}

                {\color{violet!80!black}
                $\mathpzc{K} \gets $ interaction operator around $\va{r}_0$%
                }%
                \;
                {\color{violet!80!black}\small
                $\husimiQ[o] \gets \mathpzc{K}\qty{
                    g_{\beta,\rho}\qty(\va{r}^\prime,\va{k}^\prime \argsep \va{r}_0, -\va{k}_0)
                }$%
                }%
                \Comment*[r]{rendering equation}

                {\color{violet!80!black}
                {\small $\qty{\va{r}_0,\!\va{k}_0,\!\beta,\!\rho}$} $\gets$  sample $\husimiQ[o]$ 
                }%
                \Comment*[r]{\cref{MC_light_transport_Q1}}

                \BlankLine
                % \Comment{update path}

                % $\vb{\pi} \gets \vb{\pi} + (n_m) $%
                % \Comment*[r]{$n_m$ is sampled index}
                $\alpha \gets \alpha \tfrac{\alpha^{\vb{\pi} + (n_m)}}{N_m}$%
                \Comment*[r]{update weight ($\alpha^{\vb{\pi} + (n_m)}, N_m$ as in \cref{MC_light_transport_Q1})}

            }
        }
    }
\end{algorithm}
}

