\newif\ifsingle
\twocolumn
% \singletrue % comment out for single column version

\newif\ifFullVersion
\FullVersiontrue % comment out for full proofs version


% ---- NIR SINGLE COLUMN VERSION START ----
\ifsingle
\documentclass[12pt,draftclsnofoot, onecolumn]{IEEEtran}		
\else		
\documentclass[10pt,final, twocolumn]{IEEEtran}
\fi

\let\labelindent\relax  %needed to use enumitem package

\usepackage{times}
\usepackage{amsmath,dsfont}
\usepackage{amssymb,amsthm}
\usepackage{epsfig,verbatim}
\usepackage{subfigure,stfloats}
\usepackage{setspace}
\usepackage{color}
\usepackage{cite}
\usepackage{epstopdf}
\usepackage{graphics}
\usepackage{accents}
\usepackage{acronym}
\usepackage[bookmarks,colorlinks]{hyperref}
\usepackage{booktabs}
\usepackage{mathtools}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{cuted}

\usepackage{enumitem}
\usepackage{bbm}

 \newcommand{\HYCmt}[1]{\footnote{\textcolor{blue}{Haiyang comment - #1}}}
 \newcommand{\TYCmt}[1]{\footnote{\textcolor{blue}{Tianyao comment - #1}}}%\newgeometry{margin=2cm}

% Here is a list of commands which I should consider using in the manuscript:

\newcommand{\myVec}[1]{{\bf {#1}}}
\newcommand{\myMat}[1]{{\bf{#1}}}
\newcommand{\mySet}[1]{\mathcal{#1}}
% Here is a list of commands which I should consider using in the manuscript:
\newcommand{\E}{\mathds{E}}		 			% Stochastic expectation
\newcommand{\myI}{{\myMat{I}}}			 		% Identity matrix
\newcommand{\myX}{{\myVec{x}}}			 		% Obsevations
\newcommand{\myY}{\myVec{y}}
\newcommand{\Nusers}{K}
\newcommand{\Ntraining}{n}
\newcommand{\Rate}{R}

\newcommand{\lenX}{n}			 			% observations length
\newcommand{\lenS}{k}			 			% Parameters length
\newcommand{\lenSset}{\mySet{K}}			 			% Parameters length
\newcommand{\lenXset}{\mySet{N}}			 			% Parameters length
\newcommand{\Quan}[2]{Q_{#1}^{#2}}
\newcommand{\myC}{{\myVec{c}}}			 		% Obsevations
\newcommand{\CovMat}[1]{\myMat{\Sigma}_{#1}}			% covariance matrix
\newcommand{\eig}[1]{\lambda_{#1}}			% covariance matrix 
\newcommand{\NirCmt}[1]{\footnote{\textcolor{blue}{Nir Comment - #1}}}
\newcommand{\FraCmt}[1]{\footnote{\textcolor{cyan}{Francesco Comment - #1}}}
\newcommand{\red}[1]{\color{red}{#1}}

\newcommand{\dF}{d_\mathrm{F}}

\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}
\newtheorem{corollary}{Corollary}
\newtheorem{proposition}{Proposition}
\newtheorem{lemma}{Lemma}
\newtheorem{remark}{Remark}
\newtheorem{example}{Example}


% ------ SINGLE COLUMN VERSION ------------------
\ifsingle
\newcommand{\figWidth}{0.65\columnwidth}
\newcommand{\figSpace}{\vspace{-0.2cm}}
\newcommand{\includefig}[1]{\includegraphics[width = 0.75\columnwidth]{#1} 	\vspace{-0.2cm}}
\setlength{\textfloatsep}{10pt}
% ------ DOUBLE COLUMN VERSION ------------------
\else
\newcommand{\figWidth}{\columnwidth}
\newcommand{\includefig}[1]{\includegraphics[width = 0.9\columnwidth]{#1} 	\vspace{-0.2cm}}
\newcommand{\figSpace}{\vspace{-0.6cm}}
\setlength{\textfloatsep}{0pt}
\fi % ------------------------------------------

% \acrodef{adc}[ADC]{analog-to-digital convertor}
% \acrodef{cs}[CS]{compressed sensing}
% \acrodef{csi}[CSI]{channel state information}
\acrodef{dma}[DMA]{dynamic metasurface antenna}
% \acrodef{dtft}[DTFT]{discrete-time Fourier transform}
% \acrodef{dnn}[DNN]{deep neural network} 
% \acrodef{map}[MAP]{maximum a-posteriori probability}
% \acrodef{snr}[SNR]{signal-to-noise ratio}
\acrodef{sinr}[SINR]{signal-to-interference-and-noise ratio}
\acrodef{bs}[BS]{base station} 
\acrodef{em}[EM]{electromagnetic} 
% \acrodef{iot}[IOT]{Interent of Things}
\acrodef{mimo}[MIMO]{multiple-input multiple-output}
% \acrodef{mse}[MSE]{mean-squared error}
% \acrodef{pdf}[PDF]{probability density function}
% \acrodef{rv}[RV]{random variable}
% \acrodef{fec}[FEC]{forward error correction}
% \acrodef{lti}[LTI]{linear time-invariant}
% \acrodef{wss}[WSS]{wide-sense stationary}
% \acrodef{psd}[PSD]{power spectral density}
\acrodef{ris}[RIS]{reconfigurable intelligent surface}
% \acrodef{lis}[LIS]{large intelligent surface}
% \acrodef{ser}[SER]{symbol error rate} 
% \acrodef{ber}[BER]{bit error rate} 
% \acrodef{sgd}[SGD]{stochastic gradient descent} 
% \acrodef{isi}[ISI]{intersymbol interference}  
\acrodef{awgn}[AWGN]{additive white Gaussian noise} 
% \acrodef{ut}[UT]{user terminal} 
% \acrodef{mmw}[mmWave]{millimeter wave}
\acrodef{ula}[ULA]{uniform linear array}
\acrodef{upa}[UPA]{uniform planar array}
\acrodef{dfrc}[DFRC]{dual-function radar-communication}
\acrodef{hris}[HRIS]{hybrid \ac{ris}}
\acrodef{fgs}[FGS]{fast grid search}
\acrodef{agd}[AGD]{auto gradient descent}
\acrodef{rf}[RF]{radio frequency}
\acrodef{fov}[FOV]{field of view}
\acrodef{ga}[GA]{genetic algorithm}
\acrodef{sdp}[SDP]{semidefinite programming}
\acrodef{sdr}[SDR]{semidefinite relaxation}
\acrodef{ad}[AD]{automatic differentiation}



\IEEEoverridecommandlockouts 

\input{definitions}


\makeatletter
\newenvironment{breakablealgorithm}
  {% \begin{breakablealgorithm}
   \begin{center}
     \refstepcounter{algorithm}% New algorithm
     \hrule height.8pt depth0pt \kern2pt% \@fs@pre for \@fs@ruled
     \renewcommand{\caption}[2][\relax]{% Make a new \caption
       {\raggedright\textbf{\ALG@name~\thealgorithm} ##2\par}%
       \ifx\relax##1\relax % #1 is \relax
         \addcontentsline{loa}{algorithm}{\protect\numberline{\thealgorithm}##2}%
       \else % #1 is not \relax
         \addcontentsline{loa}{algorithm}{\protect\numberline{\thealgorithm}##1}%
       \fi
       \kern2pt\hrule\kern2pt
     }
  }{% \end{breakablealgorithm}
     \kern2pt\hrule\relax% \@fs@post for \@fs@ruled
   \end{center}
  }
\makeatother








\title{Hybrid RIS-Assisted MIMO Dual-Function Radar-Communication System
}
\author{  
	\IEEEauthorblockN{Zhuoyang Liu,~\IEEEmembership{Graduate Student Member,~IEEE}, Haiyang Zhang,~\IEEEmembership{Member,~IEEE}, \\Tianyao Huang,~\IEEEmembership{Member,~IEEE}, Feng Xu,~\IEEEmembership{Senior Member,~IEEE}, \\Yonina C. Eldar,~\IEEEmembership{Fellow,~IEEE}\\
	} 
% 	\thanks{
% 	Parts of this work were accepted for presentation at the 2021 IEEE International Conference on Acoustics, Speech, and Signal Processing (ICASSP) as the paper \cite{zhang2021ICASSP}.
% 		This project was sponsored in part by  %the Benoziyo Endowment Fund for the Advancement of Science, the	Estate of Olga Klein -- Astrachan, 
% 		the European Union’s H2020 research and innovation program under grant No. 646804-ERC-COG-BNYQ, in part by the Israel Science Foundation under grant No. 0100101, and in part by the Theory Lab, Central Research Institute, 2012 Labs, Huawei Technologies Co.,Ltd.
		%	}
% 			\thanks{
% 		H. Zhang and Y. C. Eldar are with the Faculty of Math and CS, Weizmann Institute of Science, Rehovot, Israel (e-mail: \{haiyang.zhang; yonina.eldar\}@weizmann.ac.il). 
% 		N. Shlezinger is with the School of ECE, Ben-Gurion University of the Negev, Beer-Sheva, Israel (e-mail: nirshl@bgu.ac.il). 
% 		F. Guidi is with the National Research Council of Italy, Institute of Electronics, Computer and Telecommunication
% Engineering, Bologna, Italy (e-mail: francesco.guidi@ieiit.cnr.it). D. Dardari is with the Department of Electrical, Electronic, and Information Engineering “Guglielmo Marconi” - DEI-CNIT,
% University of Bologna, %Via Venezia 52, 47521 
% Cesena, Italy (e-mail:davide.dardari@unibo.it). 
% M. F. Imani is with the School of ECEE, Arizona State University, Tempe, AZ (email: mohammadreza.imani@asu.edu).}
	\thanks{
    Z. Liu and F. Xu are with the Key Lab for Information Science of Electromagnetic Wave (MoE), Fudan University, Shanghai 200433, China (e-mail: \{liuzy20; fengxu\}@fudan.edu.cn).
    H. Zhang is with the School of Communication and Information Engineering, Nanjing University of Posts and Telecommunications, Nanjing 210003, China (e-mail: haiyang.zhang@njupt.edu.cn).
    T. Huang is with the Department of Electronic Engineering, Tsinghua University, Beijing 100084, China (e-mail: huangtianyao@tsinghua.edu.cn).
    Y. C. Eldar is with the Faculty of Math and CS, Weizmann Institute of Science, Rehovot, Israel (e-mail: yonina.eldar@weizmann.ac.il).
    }
	
	\vspace{-1.0cm}
	
}
\vspace{-0.75cm}

\begin{document}
	
	\maketitle
	\pagestyle{plain}
	\thispagestyle{plain}
	%----------------------------------------------------------------------------------------
	%	ABSTRACT
	%----------------------------------------------------------------------------------------
\begin{abstract}
\Ac{dfrc} technology is emerging in next-generation wireless systems. \Ac{ris} arrays have been suggested as a crucial sensor component of the \ac{dfrc}. 
% However, the \ac{ris}-assisted \ac{dfrc} platform possesses significant improvements in power allocation and controllable \ac{em} environment while increasing the interference of radar and communication signals. 
In this paper, we propose a \ac{hris}-assisted \ac{mimo} \ac{dfrc} system, where the \ac{hris} is capable of reflecting communication signals to mobile users and receiving the scattering signal reflected from the radar target simultaneously. 
% , enabling reflecting the reflect communication signals and receiver the radar detecting signals at the same time.  
Under such a scenario, we are interested in characterizing the fundamental trade-off between radar sensing and communication. Specifically, we study the joint design of the beamforming vectors at the \ac{bs} and the parameter configuration  of the \ac{hris} so as to maximize the  \ac{sinr} of the radar while guaranteeing a communication  \ac{sinr} requirement. 
% Based on this \ac{hris}-assisted \ac{mimo} \ac{dfrc} system, we study the joint \ac{hris} and \ac{bs} beamforming designs by maximizing the \ac{sinr} of the radar while guaranteeing the communication performance.
To solve the formulated non-convex beamforming design problem, we propose an efficient alternating optimization approach. In particular, for fixed beams at the \ac{bs}, we use a fast grid search-assisted auto gradient descent (FGS-AGD) algorithm to seek the best \ac{hris} configuration; Then, a closed-form \ac{bs} beamforming solution is obtained using semidefinite relaxation. Numerical results indicate that compared with benchmark schemes, the proposed approach is capable of improving the radar performance and  communication quality significantly and simultaneously. 
% The performance gain is achieved by reducing the interference between communication and radar signals.

{\textbf{\textit{Index terms---}} \Acl{dfrc}, \Acl{hris}, Joint beamforming design, alternating optimization approach}
\end{abstract}



\acresetall	


%----------------------------------------------------------------------------------------
%	Introduction
%----------------------------------------------------------------------------------------
\vspace{-0.4cm}
\section{Introduction}
%\vspace{-0.1cm} 
	
\Ac{dfrc} systems have attracted significant attention in wireless networks. They enable radar sensing and communication functionalities by sharing the same hardware platform \cite{liu2022integrated}. \ac{dfrc} systems have the potential to be applied in autonomous driving, virtual reality, and other {control settings} due to their integrating radar and communication properties \cite{ma2020joint}. To enable the coexistence of both radar and communication, numerous researchers have studied the implementation of \ac{dfrc} in recent years. For example, the authors in \cite{huang2020majorcom} use the frequency and spatial agility properties of the carrier agile phased array radar to implement a \ac{dfrc} and achieved comparable communication performance to an independent device while guaranteeing radar performance. In \cite{hassanien2017dual}, the authors utilize frequency-hopping waveform codes to obtain different orthogonal radar waveforms and embed phase-shift keying to implement communication. Though \ac{dfrc} technology has made significant progress, it still faces several challenges in practice. A \ac{dfrc} system may suffer severe signal degradation when the user is sheltered by trees or buildings. In addition, when detecting short-range objects, the \ac{dfrc} antennas need to {operate} in duplex mode to avoid signal coupling between the transmit and receive channels, which is difficult to implement in most practical \acp{bs} \cite{sankar2021joint}.


Recently, \ac{ris} technology has emerged for future six-generation wireless systems. \ac{ris} is capable of enhancing communication performance by modifying the radio propagation, i.e., making the \ac{em} environment better for wireless communication \cite{elmossallamy2020reconfigurable,3}.   
 The passive reflection process of the \ac{ris} is similar to radar target scattering, which can be utilized to facilitate radar sensing by adjusting the reflection parameters of the \ac{ris} \cite{chepuri2022integrated}. 
 % In particular, the new channel estimation approaches of \ac{ris}-assisted wireless communication systems were studied in \cite{zhou2020joint,hu2021two,alexandropoulos2020hardware}, and in \cite{buzzi2021radar} the radar target detection method based on their \ac{ris}-enhanced sensing architecture is introduced. To this end, 
 Consequently, \ac{ris} has also been introduced to the field of \ac{dfrc} \cite{pan2021reconfigurable,pitilakis2020multi}, which enables broadening the communication \ac{fov} and radar detection by generating desirable reflecting beam patterns \cite{2}.
{However, since \ac{ris}-assisted \ac{dfrc} systems use passive reflection properties of the \ac{ris} to control the current radio environment, \ac{ris} will bring signal fading \cite{basar2021reconfigurable} and make transmitter-\ac{ris} and \ac{ris}-receiver links cascaded that are difficult to measure separately \cite{wang2021joint}.} For instance, \ac{ris} transforms the coherent superposition from a \ac{bs} into an incoherent superposition of the \ac{bs} transmitted signals and \ac{ris} reflected signals, and the original channel from \ac{bs} to users into \ac{bs}-\ac{ris} and \ac{ris}-user cascaded channel \cite{he2019cascaded}. 

 
\Acp{hris} have been suggested, that combine \acp{ris} with \acp{dma} to provide a particular amount of energy to each reflection unit on the intelligent surface for signal reception \cite{alexandropoulos2021hybrid}. In contrast to passive \ac{ris}, the \ac{hris} contains a few \ac{rf} connections to receive incoming signals while keeping the passive reflection performance of the meta-material elements. An \ac{hris}-assisted system can employ \ac{hris}'s signals or combine \ac{hris} and \ac{bs} signals for signal processing in order to perform target detection, sensing, positioning, and communication integration. Based on this incorporation of reflection and reception functionalities, \acp{hris} have potential applications in individual channel estimation \cite{zhang2022channel} and near-field user localization problems \cite{zhang2022hybrid}. To the best of our knowledge, the application of \acp{hris} to enhance both radar sensing and communication performance has not yet been studied, which motivates this work.




In this paper, we consider an \ac{hris}-assisted \ac{mimo} \ac{dfrc} system, where the \ac{hris} not only reflects the signal from the \ac{bs} to both the radar targets and communication users but also receives the echoes from the targets. The proposed \ac{hris}-assisted \ac{mimo} \ac{dfrc} system comprises a \ac{bs} and a \ac{hris} and the control center, which utilizes both \ac{bs} and \ac{hris} devices for sensing and communication. Based on the above architecture, the control center configures the transmitted signals of the \ac{bs}, and modifies the reflecting signal and receiving signal of the \ac{hris} to implement passing communication symbols to users and radar targets scattering echo reception. Compared with conventional \ac{mimo} \ac{dfrc}, the proposed system obtains improvements in both the radar and communication parts. Specifically, the presented \ac{dfrc} system broadens the view of communication and assists the communication with non-line of sight users  \cite{basar2019wireless,3}.
On the other hand, the radar receiver  is embedded in the \ac{hris}, usually located remotely from the \ac{bs}, which does not require the \ac{bs} to work in full-duplex mode  \cite{zhang2022channel,alexandropoulos2021hybrid}. Moreover, the \ac{hris} is comprised of cheap meta-material elements and has low hardware complexity, which makes the \ac{hris}-assisted \ac{mimo} \ac{dfrc} system more portable and deployable \cite{alexandropoulos2020hardware}. 


Under such an \ac{hris}-assisted \ac{mimo} \ac{dfrc} system, we study the joint beamforming design at the \ac{hris} and \ac{bs} to balance the performances of radar and communications. Specifically, we jointly design the transmit beamforming vectors at the \ac{bs} and the configurations of \ac{hris} to maximize the radar performance while guaranteeing communication performance. The joint beamforming design is a multi-parameter and combinatorial optimization problem, which is non-convex and thus challenging to solve. We propose an alternating method to solve the resulting problem by recasting the original problem into two sub-problems: the \ac{hris} configuration design and the design of the radar and communication transmitted beam of the \ac{bs}. To tackle those problems, we suggest an alternating optimization approach to design the parameters of the \ac{hris} configuration and \ac{bs}'s beamforming vectors. In particular, a \ac{fgs} assisted \ac{agd} algorithm is proposed for the \ac{hris} configuration design, and a \ac{sdr} technique is applied for \ac{bs} beamforming optimization.
% Aiming to support and verify the strength of our proposed model and solution, we analyze both radar and communication performance gain by \ac{sinr}.

The main contributions of this paper are as follows:
\begin{itemize}
    \item To the best of our knowledge, we are the first to propose an \ac{hris}-assisted \ac{mimo} \ac{dfrc} system, which utilizes the \ac{hris} to enhance both radar and communication performance. A multi-parameter optimization problem with respect to the joint beamforming of the \ac{hris}-assisted \ac{mimo} \ac{dfrc} system is formulated.
    
    \item To {address} the joint beamforming design problem, we present an alternating optimization method by optimizing the \ac{hris}'s and \ac{bs}'s parameters sequentially. To deal with these subproblems, we propose the \ac{fgs} assisted \ac{agd} algorithm for \ac{hris} configuration and \ac{sdr} for the \ac{bs} beamforming design, respectively. 
    
     \item 
     % Extensive numerical results are provided to demonstrate that the \ac{hris}-assisted \ac{mimo} \ac{dfrc} enhances the performance of both radar and communication, the \ac{sinr} comparisons on radar and communication of the \ac{bs}-only system and \ac{bs}-\ac{ris} system and \ac{hris}-assisted \ac{dfrc} system are given. 
Extensive numerical results are provided, which show that the performance of both radar and communication of \ac{hris}-assisted \ac{mimo} \ac{dfrc}  is significantly better than that of the two benchmark schemes, namely \ac{bs}-only system and \ac{bs}-\ac{ris} system. Furthermore, we study the impact of the integrated {beampattern} and power allocation of the \ac{hris} and the \ac{bs} on radar detection and wireless communication. In particular, under the same communication threshold and transmitted power, we show that the proposed system achieves around $3$~dB radar performance gain over the \ac{bs}-only system and $15$~dB gain over the \ac{bs}-\ac{ris} system.
\end{itemize}

The rest of this paper is organized as follows: Section \ref{sec:system} presents the \ac{hris}-assisted \ac{mimo} \ac{dfrc} system, reviews the considered antenna architectures, and formulates the joint optimization problem in our \ac{dfrc} system. Section \ref{sec:Solution} presents efficient methods to optimize the {beampattern} in both antenna architectures of the \ac{bs} and \ac{hris}, while Section \ref{sec:Sims} numerically demonstrates the solution of this proposed system and evaluates its performance in different \ac{dfrc} {settings}. Finally, Section \ref{sec:Conclusions} concludes the paper.

Throughout the paper, we use boldface lower-case and upper-case letters for vectors and matrices, respectively. For a matrix $\boldsymbol{A}$, the $(i, j)$-th element of $\boldsymbol{A}$
is denoted by $[\boldsymbol{A}]_{i,j}$. The $\ell_2$ norm, conjugate operation, transpose, Hermitian transpose, element-wise product, and stochastic expectation are written as $|\cdot |^2$, $(\cdot)^*$, $(\cdot)^T$, $(\cdot)^H$, $\odot$, and $\mathbf{E}( \cdot )$, respectively. {We use $\boldsymbol{I}_N$ to denote an $N$-dimensional
identity matrix, $\boldsymbol{0}_{M\times N}$ is an $M\times N$ zero matrix, and $\mathbbm{C}$ is the complex set.}


	
	%----------------------------------------------------------------------------------------
	%	System Model_hybrid
	%----------------------------------------------------------------------------------------
	\vspace{-0.2cm}
	\section{System Model and problem formulation}
	\label{sec:system}
	%\vspace{-0.1cm}

In this section, we first present the general system model of the proposed \ac{hris}-assisted \ac{mimo} \ac{dfrc} system in Section~\ref{sec:system_model}. We describe \ac{hris} operation in Section~\ref{sec:pre_hris}. Then, we introduce the performance evaluation metrics of radar and communication functionalities in such a \ac{dfrc} system in Section~\ref{sec:PM_JRC}. Finally, we formulate the joint beamforming design problem in Section~\ref{sec:pb_formular}.




\vspace{-0.2cm}
\subsection{System Model}
\label{sec:system_model}
%\vspace{-0.1cm}

We consider an \ac{hris}-assisted \ac{mimo} \ac{dfrc} system consisting of a \ac{bs}, a \ac{hris}, detecting zone and communication user terminals. {We assume the \ac{bs} consists of a \ac{ula} with $T$ antennas, and the \ac{hris} consists of $N$ elements.} In this system, both the \ac{bs} and a \ac{hris} are connected to a data control center by cables and controlled by the control center. This setup is graphically presented in Fig. \ref{fig:f2}, and it incorporates the downlink communication and radar objects detection with the assistance of an \ac{hris}. Specifically, the \ac{bs} sends both radar signals and communication signals to perform radar detection and communication simultaneously. As in \cite{zhang2022channel}, we assume there is no direct link between the \ac{bs} and communication users. The \ac{hris} helps forward the communication signals to the communication users and receive the radar signals reflected from the detecting zone.
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.95\linewidth]{images/HRIS4.pdf}
    \caption{The geometry of detecting zone and user terminals.}
    \label{fig:f2}
\end{figure}
In the case of multiple users, there are $K$ communication users who receive the communicated signals from the reflection of the \ac{hris} to communicate with the \ac{bs} independently. For radar detection, we divide the detecting zone into $P$ rows and $Q$ columns. Each block in the detecting zone can scatter the signal from both the \ac{bs} and the \ac{hris}, and the scattering signal is received by an \ac{rf} chain on the \ac{hris}.


We begin with the signals transmitted from the \ac{bs}. The discrete-time joint transmit beam signal of the \ac{bs} in time step $n$ is written as
\begin{equation}
\label{eq1}
    \begin{aligned}
    \centering
    \boldsymbol{x}(n)=\boldsymbol{W_cc}(n)+\boldsymbol{w}_{r}s(n), 
    \end{aligned}
\end{equation}
where $\boldsymbol{c}(n)=[c_1(n),...,c_K(n)]^T$ represents $K$ communication symbol streams intended for $K$ communication users, and $\boldsymbol{W}_c=[\boldsymbol{w}_1,...,\boldsymbol{w}_K]\in\mathbbm{C}^{T\times K}$ denotes the communication precoder matrix. Similarly, $s(n)$ is an individual radar waveform with unit power, and $\boldsymbol{w}_{r}\in\mathbbm{C}^{T\times 1}$ is the controllable radar beamforming vector of $T$ antennas. Without loss of generality, we assume each entry of the communication signals $\boldsymbol{c}(n)$ is a wide-sense stationary random process with zero-mean and unit power, {and uncorrelated with each other}, namely $\mathbf{E}(\boldsymbol{c}(n)\boldsymbol{c}^H(n))=\boldsymbol{I}_K$.
In addition, the communication symbols are uncorrelated with the radar waveform, meaning $\mathbf{E}(\boldsymbol{c}(n)s(n))=\boldsymbol{0}_{K\times1}$.
% Therefore, the real power of the radar and communication is dominated by the precoder matrices $\boldsymbol{W}_r$ and $\boldsymbol{W}_c$.

To illustrate the power constraint for the \ac{bs}, we denote the covariance matrix of the transmitted beamforming matrix by $\boldsymbol{R}\triangleq\boldsymbol{WW}^H$, where $\boldsymbol{W}=[\boldsymbol{W}_c,\boldsymbol{w}_{r}]\in \mathbbm{C}^{T\times (K+1)}$ is the joint controllable matrix of the \ac{bs}. Thus, each antenna's power constraint {implies} that
\begin{equation}
\label{eq_power}
    \begin{aligned}
    \centering
    [\boldsymbol{R}]_{j,j}=[\boldsymbol{W}_c\boldsymbol{W}_c^H + \boldsymbol{w}_{r}\boldsymbol{w}_{r}^H]_{j,j}=P_t,~j=1,...,T,
    \end{aligned}
\end{equation}
where $P_t$ is the transmit power for each antenna.


\vspace{-0.2cm}
\subsection{Preliminaries of HRIS}
\label{sec:pre_hris}
%\vspace{-0.1cm}
\ac{hris} is a new metamaterial device that achieves reflection and reception simultaneously. 
To achieve this hybrid operation, each metasurface element of the \ac{hris} must be capable of reflecting a component of the impinging signal while also receiving another portion of it in a controlled manner \cite{alexandropoulos2021hybrid}. The signals connected to the waveguides are then measured by the \ac{rf} chain and utilized to determine radar and communication information. In \cite{zhang2022channel}, the authors presented such a hybrid metamaterial surface {which} was applied to reflect in a reconfigurable function while using the received component of the signal to recover the target's angle of arrival locally. 

We model the coexistence of reflection and reception functions with a hybrid metasurface composed of $N$ adjustable meta-atom elements. Specifically, all the meta-atom elements are connected to an \ac{rf} chain to finish received data acquisition. 
%% function of HRIS
\begin{figure}[htbp]
	\centering  
	\includegraphics[width=0.95\linewidth]{images/function_HRIS.pdf}
	\caption{The receiving and reflecting operation of the \ac{hris}.}
	\label{function_HRIS}
\end{figure}
As illustrated in Fig. \ref{function_HRIS}, the control center can modify the reflected and received signals arriving at its surface by adjusting the surface's amplitude and phase shifts. Let $r_l(n)$ denote the discrete-time signal arriving at the $l$-th element of the \ac{hris} in time step $n$. Part of the signal is reflected to the desired direction with the adjustment by the parameter $\beta_l\in [0,1]$ and phase shift $\psi_l\in[0,2\pi)$. The forward reflected signal is consequently given as
\begin{equation}
\label{eqrf}
    \begin{aligned}
    \centering
    y_l^f(n)=\beta_le^{j\psi_l}r_l(n),~l=1,...,N.
    \end{aligned}
\end{equation}
Since per-element of the \ac{hris} enables to locally receive signals via analog combining and digital processing, the received signal collected by the \ac{rf} chain is expressed as
\begin{equation}
\label{eqrc}
    \begin{aligned}
    \centering
    y_{l}^r(n)=(1-\beta_l)e^{j\gamma_{l}}r_l(n),~l=1,...,N,
    \end{aligned}
\end{equation}
where $1-\beta_l$ is the amplitude allocated for receiving signal and $\gamma_{l}\in[0,2\pi)$ is an additional phase shift that controls the phaser connected to the \ac{rf} chain. 

By concatenating the arrived signal $r_l(n)$ and reflected signal $y_l^f(n)$ from the whole \ac{hris} into vectors $\boldsymbol{r}(n)$ and $\boldsymbol{y}^f(n)$, respectively, {the} received signal is formulated as
\begin{equation}
\label{eqrfh}
    \begin{aligned}
    \centering
    \boldsymbol{y}^f(n)=\boldsymbol{\Psi}(\boldsymbol{\beta},\boldsymbol{\psi})\boldsymbol{r}(n),
    \end{aligned}
\end{equation}
where the reflected matrix of the \ac{hris} is defined as $\boldsymbol{\Psi}(\boldsymbol{\beta},\boldsymbol{\psi})=\mathrm{diag}([\beta_1e^{j\psi_1},...,\beta_Ne^{j\psi_N}])$. Similarly, the reflected signal $y_{l}^r(n)$ from the \ac{rf} chain can be concatenated as a vector $\boldsymbol{y}^r(n)$ given by
\begin{equation}
\label{eqrch}
    \begin{aligned}
    \centering
    \boldsymbol{y}^r(n)=\boldsymbol{\phi}^H(\boldsymbol{\beta},\boldsymbol{\gamma})\boldsymbol{r}(n),
    \end{aligned}
\end{equation}
where the $l$-th element of the received vector is $[\boldsymbol{\phi}]_{l}=(1-\beta_l)e^{j\gamma_{l}}$.

The \ac{hris} enables to {change the \ac{em} environment} by externally controllable parameters. The beampattern adjustment performance is dominated by amplitude distribution on the surface of the \ac{hris} while slightly affected by the phased shifts in different elements of the \ac{hris} \cite{zhang2022channel}. Therefore, in this paper, we mainly control the beampattern of \ac{hris} by adjusting the power splitting factor $\boldsymbol{\beta}$
 with fixed phase shifts $\boldsymbol{\psi}$ and $\boldsymbol{\gamma}$. To be concrete, we optimize $\boldsymbol{\beta}$ with both $\boldsymbol{\psi}$ and $\boldsymbol{\gamma}$ set to zero in order to investigate the effect of power allocation on the \ac{hris}-assisted \ac{mimo} \ac{dfrc} system performance.




 

\vspace{-0.2cm}
\subsection{Performance Metrics of Radar and Communication}
\label{sec:PM_JRC}
%\vspace{-0.1cm}

\subsubsection{The Evaluation Metric of Communication}

 Let $\boldsymbol{G}\in\mathbbm{C}^{N\times T}$ and $\boldsymbol{h}_k\in\mathbbm{C}^{N\times 1}$ represent the channel from \ac{bs} to \ac{hris} and the channel from the \ac{hris} to the $k$-th user, respectively. The received communication signal at the $k$-th user, denoted by $u_k(n)$,  can be written as
\begin{equation}
\label{eq4}
    \begin{aligned}
    \centering
    u_k(n) = \boldsymbol{h}_k^H\boldsymbol{\Psi}(\boldsymbol{\beta})\boldsymbol{Gx}(n) + v_k(n),
    \end{aligned}
\end{equation}
where $v_k(n)$ is \ac{awgn} with covariance $\sigma^2$.

We assemble the communication channels from the \ac{hris} to multiple users, which we assume to be known, in the complex matrix $\boldsymbol{H}\triangleq[\boldsymbol{h}_1,...,\boldsymbol{h}_K]^H\in\mathbbm{C}^{K\times N}$. The signal received at $K$ users is represented as the $K \times 1$ vector $\boldsymbol{u}(n)\triangleq[u_1(n),...,u_K(n)]^T$ and we collect the $v_k(n)$ into a $K\times1$ vector $\boldsymbol{v}(n)$. Combining (\ref{eq1}) and (\ref{eq4}), we rewrite the received signal at $K$ users into radar-to-users parts and inter-users parts, given by
\begin{equation}
\label{eq5}
    \begin{aligned}
    \centering
    \boldsymbol{u}(n)= \boldsymbol{H\Psi}(\boldsymbol{\beta})\boldsymbol{GW}_c\boldsymbol{c}(n)
    +\boldsymbol{H\Psi}(\boldsymbol{\beta})\boldsymbol{Gw}_{r}s(n)+\boldsymbol{v}(n).
    \end{aligned}
\end{equation}
Let the cascaded communication channel $\boldsymbol{H}_e=[\boldsymbol{\hat{h}}_1,...,\boldsymbol{\hat{h}}_K]^H\in\mathbbm{C}^{K\times T}$ be denoted as
\begin{equation}
\label{cascaded channel}
    \begin{aligned}
    \centering
    \boldsymbol{H}_e(\boldsymbol{\beta})=\boldsymbol{H\Psi}(\boldsymbol{\beta})\boldsymbol{G}.
    \end{aligned}
\end{equation}

Similar to  \cite{4}, we use the \ac{sinr} to evaluate communication performance. {The communication power of the $k$-th user is }
\begin{equation}
\label{user_power}
    \begin{aligned}
        \centering
        \mathbf{E}\left(|[\boldsymbol{H}_e(\boldsymbol{\beta})\boldsymbol{W}_c]_{k,k}c_k(n)|^2\right)=[\boldsymbol{H}_e(\boldsymbol{\beta})\boldsymbol{W}_c\boldsymbol{W}_c^H\boldsymbol{H}_e^H(\boldsymbol{\beta})]_{k,k}.
    \end{aligned}
\end{equation}
The communication inter-user interference power is given by
\begin{equation}
\label{eq9}
    \begin{aligned}
        \centering
        \mathbf{E}&\left(\sum_{i\ne k}^K|[\boldsymbol{H}_e(\boldsymbol{\beta})\boldsymbol{W}_c]_{k,i}c_k(n)|^2\right)\\
        &~~~~~~~~~~~~~~~~~~=\sum_{i\ne k}^K \left[\boldsymbol{H}_e(\boldsymbol{\beta})\boldsymbol{W}_c\boldsymbol{W}_c^H\boldsymbol{H}_e^H(\boldsymbol{\beta})\right]_{k,i}.
    \end{aligned}
\end{equation}
The interference power between the communication signals and the radar signal is
\begin{equation}
\label{eq_rc_in}
    \begin{aligned}
        \centering
        \mathbf{E}\left(|[\boldsymbol{H}_e(\boldsymbol{\beta})\boldsymbol{w}_{r}]_{k,1}s(n)|^2\right)=[\boldsymbol{H}_e(\boldsymbol{\beta})\boldsymbol{w}_{r}\boldsymbol{w}_{r}^H\boldsymbol{H}_e^H(\boldsymbol{\beta})]_{k,1}.
    \end{aligned}
\end{equation}
Therefore, the \ac{sinr} of the $k$-th user is expressed by (\ref{eq10}). 
\begin{figure*}
    \begin{equation}
    \label{eq10}
    \begin{aligned}
    \centering
    \eta_c(\boldsymbol{w}_{r},\boldsymbol{W}_c,\boldsymbol{\beta};k) = \frac{[\boldsymbol{H}_e(\boldsymbol{\beta})\boldsymbol{W}_c\boldsymbol{W}_c^H\boldsymbol{H}_e^H(\boldsymbol{\beta})]_{k,k}}{\sum_{i\ne k}^K [\boldsymbol{H}_e(\boldsymbol{\beta})\boldsymbol{W}_c\boldsymbol{W}_c^H\boldsymbol{H}_e^H(\boldsymbol{\beta})]_{k,i}+[\boldsymbol{H}_e(\boldsymbol{\beta})\boldsymbol{w}_{r}\boldsymbol{w}_{r}^H\boldsymbol{H}_e^H(\boldsymbol{\beta})]_{k,1}+\sigma^2}.
    \end{aligned}
\end{equation}
\hrulefill
\end{figure*}


For convenience, let each column of $\boldsymbol{W}$ which represents the controllable codes of the \ac{bs} be denoted by $\boldsymbol{w}_i$. The covariance matrix $\boldsymbol{R}$ of the transmitted beamforming matrix $\boldsymbol{W}$ can then be rewritten as the sum of sub-covariance matrices $\boldsymbol{R}_i\triangleq \boldsymbol{w}_i\boldsymbol{w}_i^H$ of different codes:
\begin{equation}
\label{eq22}
    \begin{aligned}
    \centering
    \boldsymbol{R}=\sum_{i=1}^{K+1}\boldsymbol{w}_i\boldsymbol{w}_i^H = \sum_{i=1}^{K+1}\boldsymbol{R}_i,
    \end{aligned}
\end{equation}
{where beamforming matrix $\boldsymbol{W}$ consists of $K$ communication precoder vectors and one radar precoder vector.} Combining with the definition of the $k$-th user's cascaded communication channel in (\ref{cascaded channel}) and substituting (\ref{eq22}) into (\ref{eq10}), the $k$-th user's \ac{sinr} can be expressed as (\ref{eq23}),
\begin{figure*}
    \begin{equation}
    \label{eq23}
    \begin{aligned}
    \centering
    \eta_c(\boldsymbol{R},\boldsymbol{R}_k, \boldsymbol{\beta}; k) = \frac{\boldsymbol{\hat{h}}_{k}^H(\boldsymbol{\beta})\boldsymbol{R}_k\boldsymbol{\hat{h}}_{k}(\boldsymbol{\beta})}{\boldsymbol{\hat{h}}_{k}^H(\boldsymbol{\beta})\boldsymbol{R}\boldsymbol{\hat{h}}_{k}(\boldsymbol{\beta})-\boldsymbol{\hat{h}}_{k}^H(\boldsymbol{\beta})\boldsymbol{R}_k\boldsymbol{\hat{h}}_{k}(\boldsymbol{\beta})+\sigma^2},~  k=1, ..., K.
    \end{aligned}
\end{equation}
\hrulefill
\end{figure*}
with the constraint (\ref{eq22}) and
\begin{equation}
\label{rank_1}
    \begin{aligned}
        \centering
        {\rm rank}(\boldsymbol{R}_i)=1,~ i=1,...,K+1.
    \end{aligned}
\end{equation}
% Obviously, the covariance matrix $\boldsymbol{R}$ comprises of rank-one matrices $\boldsymbol{R}_i$, which implies that it has implicit constraints $ {\rm rank}(\boldsymbol{R}_i)=1$, for $i=1,..., K+1$.

\subsubsection{The Evaluation Metric of Radar Detection}

In the radar part, the signal from the \ac{bs} {illuminates} the detecting zone and the \ac{hris}, and then the \ac{hris} {reflects} the arriving signal to hit the detecting zone.
The arriving signal from the \ac{bs} to the radar target can be expressed as
\begin{equation}
\label{eq12}
    \begin{aligned}
    \centering
    y(n;p,q)=\boldsymbol{a}_t^H(p,q)\boldsymbol{x}(n),
    \end{aligned}
\end{equation}
where $\boldsymbol{a}_t(p,q)\in\mathbbm{C}^{T\times 1}$ is the steering vector from the \ac{bs} to the $(p,q)$ block in the detecting zone. 
Combined with (\ref{eq4}), the signal forwarded by the \ac{hris} is
\begin{equation}
\label{eq13}
    \begin{aligned}
    \centering
    \boldsymbol{r}_e(n)=\boldsymbol{\Psi}(\boldsymbol{\beta})\boldsymbol{Gx}(n),
    \end{aligned}
\end{equation}
and the arriving signal from the \ac{hris} can be written as
\begin{equation}
\label{eq14}
    \begin{aligned}
    \centering
    r_s(n;p,q)={\boldsymbol a}_h^H(p,q)\boldsymbol{r}_e(n),
    \end{aligned}
\end{equation}
where $\boldsymbol{a}_h(p,q)\in\mathbbm{C}^{N\times 1}$ is the steering vector from the \ac{hris} to the $(p,q)$ block. 
Using the \ac{hris} to receive the scattering signal and perform radar detection, the received signal at the \ac{hris} can be consequently formulated as
\begin{equation}
\label{eq16}
    \begin{aligned}
    \centering
    \boldsymbol{r}(n;p,q)=\boldsymbol{\phi}^H(\boldsymbol{\beta})\boldsymbol{a}_r(p,q)(r_s(n;p,q)+y(n;p,q)),
    \end{aligned}
\end{equation}
where $\boldsymbol{a}_r(p,q)\in\mathbbm{C}^{N\times 1}$ is the steering vector from the $(p,q)$ block in the detecting zone to the $n$-th element on the \ac{hris}.

For convenience of the analysis, {we define the cascaded reflected vector $\boldsymbol{\hat{a}}_h\in\mathbbm{C}^{T\times 1}$ and the cascaded received scalar $A_r$ as 
\begin{subequations}
\label{cascaded reflect}
    \begin{align}
        \centering
        &\boldsymbol{\hat{a}}_h^H(\boldsymbol{\beta}) = \boldsymbol{a}_h^H(p,q)\boldsymbol{\Psi}(\boldsymbol{\beta})\boldsymbol{G}, \\
        & A_r(\boldsymbol{\beta})=\boldsymbol{\phi}^H(\boldsymbol{\beta})\boldsymbol{a}_r(p,q).
    \end{align}
\end{subequations}}
Similar to the work in \cite{pritzker2022transmit}, we use the \ac{sinr} as the radar performance metric. To this end, we assume the transmitted radar waveform that hits the detecting zone is the valid signal, and the reflected signal from \ac{hris} is interference. Then, by substituting the expressions of the reflected vector and received scalar into (\ref{eq16}), the valid signal is {$A_r(\boldsymbol{\beta})s(n)\boldsymbol{a}_t^H\boldsymbol{w}_{r}$}.
{The useful radar sensing power of the $(p,q)$ block is then derived as
\begin{equation}
\label{use_radar}
    \begin{aligned}
        \centering
        \mathbf{E}\left(|A_r(\boldsymbol{\beta})s(n)\boldsymbol{a}_t^H\boldsymbol{w}_{r}|^2\right)=|A_r(\boldsymbol{\beta})|^2\boldsymbol{a}_t^H \boldsymbol{w}_{r}\boldsymbol{w}_{r}^H\boldsymbol{a}_t.
    \end{aligned}
\end{equation}
The interference power from \ac{hris} to the $(p,q)$ block is
\begin{equation}
\label{inter_radar}
    \begin{aligned}
        \centering
        \mathbf{E}\left(|A_r(\boldsymbol{\beta})\boldsymbol{\hat{a}}_h^H(\boldsymbol{\beta})\boldsymbol{x}(n)|^2\right) = |A_r(\boldsymbol{\beta})|^2\boldsymbol{\hat{a}}_h^H(\boldsymbol{\beta})\boldsymbol{W}\boldsymbol{W}^H\boldsymbol{\hat{a}}_h(\boldsymbol{\beta}).
    \end{aligned}
\end{equation}
Combining (\ref{use_radar}) with (\ref{inter_radar}), the \ac{sinr} of the radar is expressed as
\begin{equation}
\label{eq18_}
    \begin{aligned}
    \centering
    \eta_r(\boldsymbol{W},\boldsymbol{\beta};p,q) =  \frac{|A_r(\boldsymbol{\beta})|^2\boldsymbol{a}_t^H \boldsymbol{w}_{r}\boldsymbol{w}_{r}^H\boldsymbol{a}_t}{|A_r(\boldsymbol{\beta})|^2\boldsymbol{\hat{a}}_h^H(\boldsymbol{\beta})\boldsymbol{W}\boldsymbol{W}^H\boldsymbol{\hat{a}}_h(\boldsymbol{\beta})+\sigma^2}.
    \end{aligned}
\end{equation}}

Compared with other \ac{dfrc} works \cite{4, pritzker2022transmit}, we use the same metrics to evaluate radar and communication performance. However, due to the coexistence of the \ac{hris} device and the \ac{bs} in our proposed \ac{dfrc} system, we have another parameter $\boldsymbol{\beta}$ that affects both radar and communication performance.


\vspace{-0.2cm}
\subsection{Problem formulation}
\label{sec:pb_formular}
%\vspace{-0.1cm}
From (\ref{eq23}) and (\ref{eq18_}), both the radar and communication performance evaluation metrics are a function of the controllable coefficients in the \ac{bs} and the \ac{hris} {which are the beamforming matrix $\boldsymbol{W}=[\boldsymbol{w}_1,...,\boldsymbol{w}_{K+1}]$ and the power splitting factor $\boldsymbol{\beta}$.} As the \ac{hris}-assisted \ac{mimo} \ac{dfrc} system has the same controllable coefficients to determine the radar and communication performance, there is a trade-off between them.
Here, we are interested in characterizing this trade-off by concurrently optimizing the joint beamforming matrix of the \ac{bs} and configuring the parameters of the \ac{hris}. To this end, we aim at maximizing the radar \ac{sinr} $\eta_r$ while guaranteeing communication performance $\Gamma_c$. 
The resulting problem can be formulated as a joint beamforming optimization problem:
{\begin{subequations}
\label{eq19}
    \begin{align}
    \centering
    \max_{\boldsymbol{W},\boldsymbol{\beta}}& \  \eta_r(\boldsymbol{W},\boldsymbol{\beta};p,q),\\
    {\rm s.t.} \ &\eta_c(\boldsymbol{R},\boldsymbol{R}_k, \boldsymbol{\beta}; k)\ge \Gamma_c,~ k=1,...,K , \label{c_cons1}\\
    & \boldsymbol{R}_i = \boldsymbol{w}_i\boldsymbol{w}_i^H,~i=1,...,K+1,\\
    & \boldsymbol{R}=\sum_{i=1}^{K+1}\boldsymbol{R}_i,\\
    % & \mathrm{rank}(\boldsymbol{R}_i) = 1, ~i=1,...K,K+1,\label{c_cons2}\\
    & 0\leq\beta_l\leq 1 , ~l=1,...,N, \label{h_poewr}\\
    & [\boldsymbol{R}]_{j,j}=P_t, ~j=1,...,T \label{b_power},
    \end{align}
\end{subequations}
where $\boldsymbol{w}_i$ is the $i$-th column of the $\boldsymbol{W}$, $\eta_r(\boldsymbol{W},\boldsymbol{\beta};p,q)$ and $\eta_c(\boldsymbol{R},\boldsymbol{R}_k, \boldsymbol{\beta}; k)$ are defined by (\ref{eq18_}) and (\ref{eq23}), respectively.}

% For both the \ac{bs} and the \ac{hris} architectures, we optimize the corresponding beamforming precoder matrices $\boldsymbol{W_c}$ and $\boldsymbol{W_r}$ and the power splitting factor $\boldsymbol{\beta}$ to obtain the desirable radar performance with meeting communication requirements. In particular,

The objective of (\ref{eq19}) is the radar performance of the $\left(p,q\right)$ block detecting zone that we are interested in; (\ref{c_cons1})  is the communication constraint, with $\Gamma_c$ denoting the minimum communication SINR requirement. For the power constraints, (\ref{h_poewr}) denotes the power allocation of each element in the \ac{hris}, and (\ref{b_power}) is the antenna power budget on the \ac{bs}.

Since the optimized parameters controlling the configuration of the \ac{bs} and the \ac{hris} are coupled, the problem formulated in (\ref{eq19}) is non-convex. Moreover, compared to \cite{4, pritzker2022transmit}, we need to optimize the beamforming matrices of the \ac{bs} and the power splitting factor $\boldsymbol{\beta}$ of the \ac{hris} simultaneously. To address this challenging problem, we propose an efficient alternating optimization algorithm, which will be detailed in the next section.








\vspace{-0.2cm}
\section{Proposed alternating optimization algorithm}
\label{sec:Solution}
%\vspace{-0.1cm}
	
In this section, we develop an alternating optimization algorithm to optimize the beamforming matrices of the \ac{bs} and \ac{hris} configuration parameters.  We begin with introducing the \ac{hris} optimization for fixed \ac{bs} beamforming matrices in Section~\ref{sec:hris-design}, which we then utilize to design the \ac{bs} beamforming matrices in Section~\ref{sec:bs design}. The parameters update strategy during each iteration is summarized in Section~\ref{sec:alt_beam}.

% TODO NIR CONTINUE FROM HERE
\vspace{-0.2cm}
\subsection{HRIS configuration with fixed BS beamforming matrices }\label{sec:hris-design}	
%\vspace{-0.1cm}

% For the \ac{hris} configuration design, the controllable parameters $\boldsymbol{\beta}$ of the \ac{hris} affect the performance of both radar and communication. To this end, our goal is to maximize the radar  \ac{sinr} with the communication guarantee via designing \ac{hris} parameters. In particular, to avoid the influence of the \ac{bs} on the proposed system, a suggested strategy is to fix the \ac{bs}’s beamforming matrices to optimize the \ac{hris} configuration.
% Here, we fix the beamforming matrices as $\boldsymbol{\bar{W}}_t=[\boldsymbol{\bar{W}}_{c,t},\boldsymbol{\bar{W}}_{r,t}]$, where the communication precoder matrix in the $t$-th iterative step denotes by $\boldsymbol{\bar{W}}_{c,t}=[\boldsymbol{\bar{w}}_{1,t},...,\boldsymbol{\bar{w}}_{K,t}]$ and the radar precoder matrix denotes by $\boldsymbol{\bar{W}}_{r,t}$. In this case, the \ac{hris} configuration optimization problem in (\ref{eq19}) is rewritten as

In this section, we optimize the \ac{hris} configuration with fixed  \ac{bs} beamforming matrix. Let $\boldsymbol{\bar{W}}^{(t)}=[\boldsymbol{\bar{W}}_{c}^{(t)},\boldsymbol{\bar{w}}_{r}^{(t)}]$ denote the fixed beamforming matrices at the BS in the  $t$-th iteration, with $\boldsymbol{\bar{W}}_{c}^{(t)}=[\boldsymbol{\bar{w}}_{1}^{(t)},...,\boldsymbol{\bar{w}}_{K}^{(t)}]$ and $\boldsymbol{\bar{w}}_{r}^{(t)}$ denoting the corresponding communication precoder matrix and radar beamforming vector, respectively. In this case, (\ref{eq19}) can be simplified as
{\begin{subequations}
\label{eq19h}
    \begin{align}
    \centering
    \max_{\boldsymbol{\beta}}&\  \eta_r(\boldsymbol{\bar{W}}^{(t)},\boldsymbol{\beta};p,q),\\
    {\rm s.t.} \ &\eta_c(\boldsymbol{\bar{R}}^{(t)},\boldsymbol{\bar{R}}_{k}^{(t)},\boldsymbol{\beta};k)\ge \Gamma_c,~ k=1,...,K ,\\
    & \boldsymbol{\bar{R}}_{i}^{(t)}=\boldsymbol{\bar{w}}_{i}^{(t)}\boldsymbol{\bar{w}}_{i}^{(t)H},~i=1,...,K+1,\\
    &
    \boldsymbol{\bar{R}}^{(t)}=\sum_{i=1}^{K+1}\boldsymbol{\bar{R}}_i^{(t)},\\
    & 0\leq\beta_l\leq1 , ~l=1,...,N,
    \end{align}
\end{subequations}}
where $\boldsymbol{\bar{R}}^{(t)}$ and $\boldsymbol{\bar{R}}_i^{(t)}$ are the covariance matrix and the $i$-th sub-covariance matrix in the $t$-th iteration, respectively.
% where the covariance matrices $\boldsymbol{\bar{R}}^{(t)}$ is calculated by (\ref{eq22}).

% To compute the communication user's \ac{sinr} $\eta_c(\boldsymbol{\bar{W}}_{r,t},\boldsymbol{\bar{W}}_{c,t},\boldsymbol{\beta};k)$, we first represent the cascaded communication channel $\boldsymbol{H}_e=[\boldsymbol{\hat{h}}_1,...,\boldsymbol{\hat{h}}_K]$, it holds that
% \begin{equation}
% \label{cascaded channel}
%     \begin{aligned}
%     \centering
%     \boldsymbol{H}_e=\boldsymbol{H\Psi}(\boldsymbol{\beta})\boldsymbol{G}.
%     \end{aligned}
% \end{equation}

% Next, combining with (\ref{eq10}) and the definition of covariance $\boldsymbol{\bar{R}}_t=\boldsymbol{\bar{W}}_t\boldsymbol{\bar{W}}_t^H$ of the beamforming matrices. Then, the \ac{sinr} of the $k$-th user is explicitly written as
% \begin{equation}
% \label{eq36}
%     \begin{aligned}
%     \centering
%     \eta_c(\boldsymbol{\bar{W}}_{r,t},\boldsymbol{\bar{W}}_{c,t},\boldsymbol{\beta};k) = \frac{\boldsymbol{\hat{h}}_k^H[\boldsymbol{\bar{W}}_{c,t}\boldsymbol{\bar{W}}_{c,t}^H]_{k,k}\boldsymbol{\hat{h}}_k}{\boldsymbol{\hat{h}}_k^H\boldsymbol{\bar{R}}_t\boldsymbol{\hat{h}}_k-\boldsymbol{\hat{h}}_k^H[\boldsymbol{\bar{W}}_{c,t}\boldsymbol{\bar{W}}_{c,t}^H]_{k,k}\boldsymbol{\hat{h}}_k+\sigma^2}, ~k=1,...,K.
%     \end{aligned}
% \end{equation}


% The expectation of \ac{hris} configuration design is to get the highest radar performance, so the second step is to calculate the radar \ac{sinr} $\eta_{r}(\boldsymbol{\bar{W}}_{r,t},\boldsymbol{\bar{W}}_{c,t},\boldsymbol{\beta};p,q)$. For the convenience of analysis, we define the cascaded reflected matrix $\boldsymbol{A}_h$ and the cascaded received matrix $\boldsymbol{A}_r$ as 
% \begin{subequations}
% \label{cascaded reflect}
%     \begin{align}
%         \centering
%         &\boldsymbol{A}_h = \boldsymbol{a}_h^H(p,q)\boldsymbol{\Psi}(\boldsymbol{\beta})\boldsymbol{G}, \\
%         & \boldsymbol{A}_r=\boldsymbol{\Phi}(\boldsymbol{\beta})\boldsymbol{a}_r(p,q).
%     \end{align}
% \end{subequations}

% Therefore, by substituting the expressions for the cascaded received matrix and reflected matrix into (\ref{eq18}), the radar \ac{sinr} output of \ac{rf} chain at the \ac{hris} is given by: 
% \begin{equation}
% \label{eq38}
%     \begin{aligned}
%     \centering
%     \eta_{r}(\boldsymbol{\bar{W}}_{r,t},\boldsymbol{\bar{W}}_{c,t},\boldsymbol{\beta};p,q)=\frac{\boldsymbol{A}_r\boldsymbol{a}_t^H \boldsymbol{\bar{W}}_{r,t}\boldsymbol{\bar{W}}_{r,t}^H\boldsymbol{a}_t \boldsymbol{A}_r^H}{\boldsymbol{A}_r\boldsymbol{A}_h\boldsymbol{\bar{R}}_t\boldsymbol{A}_h^H\boldsymbol{A}_r^H+\sigma^2},
%     \end{aligned}
% \end{equation}

% To optimize the \ac{hris} configuration, we provide the following derivation which expresses 
We next express $\eta_c(\boldsymbol{\bar{R}}^{(t)},\boldsymbol{\bar{R}}_{k}^{(t)},\boldsymbol{\beta};k)$ and $\eta_{r}(\boldsymbol{\bar{W}}^{(t)},\boldsymbol{\beta};p,q)$ as functions of the power splitting factor $\boldsymbol{\beta}$ in the following proposition.
% in (\ref{eta_c}) and (\ref{eta_r}), respectively.

\begin{proposition}
\label{proposition1}
Given the noise variance $\sigma^2$, {the channel from \ac{bs} to \ac{hris} $\boldsymbol{G}$, and the channel from the \ac{hris} to the $k$-th user $\boldsymbol{h}_k$,} the communication user's \ac{sinr} and the radar \ac{sinr} can be recast as
\begin{subequations}
\label{eta_r_c}
    \begin{align}
    \centering
    &\eta_c(\boldsymbol{\beta};k) = \frac{\boldsymbol{\beta}^H\boldsymbol{C}_3\boldsymbol{\beta}}{\boldsymbol{\hat{h}}_k^H\boldsymbol{\bar{R}}^{(t)}\boldsymbol{\hat{h}}_k-\boldsymbol{\beta}^H\boldsymbol{C}_3\boldsymbol{\beta}+\sigma^2}, ~k=1,...,K, \label{eta_c}\\
    &\eta_r(\boldsymbol{\beta};p,q) = \frac{(1- \boldsymbol{\beta}^H)\boldsymbol{C}_1(1-\boldsymbol{\beta})}{(1-\boldsymbol{\beta}^H)\boldsymbol{a}_r\boldsymbol{\beta}^H \boldsymbol{C}_2\boldsymbol{\beta}\boldsymbol{a}_r^H(1-\boldsymbol{\beta})+\sigma^2},\label{eta_r}
    \end{align}
\end{subequations}
where $\boldsymbol{\hat{h}}_k$ is the cascaded communication channel calculated by (\ref{cascaded channel}), $\boldsymbol{C}_1$,  $\boldsymbol{C}_2$,  $\boldsymbol{C}_3$ are Hermitian matrices defined as follows:
\begin{subequations}
\label{C_1_2_3}
    \begin{align}
    \centering
    & \boldsymbol{C}_1 \triangleq \left(\boldsymbol{a}_t^H \boldsymbol{\bar{w}}_{r}^{(t)}\boldsymbol{\bar{w}}_{r}^{(t)H}\boldsymbol{a}_t\right)\boldsymbol{a}_r\boldsymbol{a}_r^H,\\
    & \boldsymbol{C}_2 \triangleq \boldsymbol{a}_h\odot\left(\boldsymbol{G}\boldsymbol{\bar{W}}^{(t)}\right)\left(\boldsymbol{a}_h\odot\left(\boldsymbol{G}\boldsymbol{\bar{W}}^{(t)}\right)\right)^H,\\
    & \boldsymbol{C}_3 \triangleq \boldsymbol{h}_k\odot\left(\boldsymbol{G}\boldsymbol{\bar{w}}_{k}^{(t)}\right)\left(\boldsymbol{h}_k\odot\left(\boldsymbol{G}\boldsymbol{\bar{w}}_{k}^{(t)}\right)\right)^H,~k=1,..,K.
    \end{align}
\end{subequations}
{Here, $\boldsymbol{\bar{W}}^{(t)}=\left[\boldsymbol{\bar{w}}_1^{(t)},...,\boldsymbol{\bar{w}}_K^{(t)},\boldsymbol{\bar{w}}_{r}^{(t)}\right]$ is the fixed \ac{bs}'s beamforming matrix for communication and radar sensing, $\boldsymbol{a}_t$ is the given transmitted steering vector of radar, and $\boldsymbol{a}_h$ and $\boldsymbol{a}_r$ are the given reflection and reception steering vectors of \ac{hris}, respectively.}
\end{proposition}

\begin{IEEEproof}
See Appendix \ref{app:Proof_1}.
\end{IEEEproof}

Using Proposition \ref{proposition1}, the \ac{hris} configuration design problem \eqref{eq19h} can be reformulated as
\begin{subequations}
\label{obj}
    \begin{align}
    \centering
    \max_{\boldsymbol{\beta}} \quad & \frac{(1- \boldsymbol{\beta}^H)\boldsymbol{C}_1(1-\boldsymbol{\beta})}{(1-\boldsymbol{\beta}^H)\boldsymbol{a}_r\boldsymbol{\beta}^H \boldsymbol{C}_2\boldsymbol{\beta}\boldsymbol{a}_r^H(1-\boldsymbol{\beta})+\sigma^2},\\
    {\rm s.t.} \ & {\frac{\boldsymbol{\beta}^H\boldsymbol{C}_3\boldsymbol{\beta}}{\boldsymbol{\hat{h}}_k^H\boldsymbol{\bar{R}}^{(t)}\boldsymbol{\hat{h}}_k-\boldsymbol{\beta}^H\boldsymbol{C}_3\boldsymbol{\beta}+\sigma^2}\geq \Gamma_c },~k=1,...,K,\label{com_beta}\\
    & 0\leq\beta_l\leq 1 , ~l=1,...,N.
    \end{align}
\end{subequations}
% We add a constant $\Gamma_r$ to transform the maximized optimized problem in (\ref{eq19h}) into a minimized regression problem in (\ref{obj}). While adding a constant $\Gamma_r$ to the objective function in (\ref{eq19h}), the original optimization problem is converted to obtain the stable solution closest to the predefined constant.
Problem (\ref{obj}) is still non-convex and challenging to solve.
% and it's infeasible to relax the objective function into a convex one.  We exploit the fact that this type of objective function in (\ref{obj}) is consistent with the loss function of the neural network, which motivates us to utilize the property of the neural network. Note that this optimization problem is constrained, whereas the loss function is unconstrained. 
{To proceed, we consider the following optimization problem:}
\begin{equation}
\label{objlag}
    \begin{aligned}
    \min_{\boldsymbol{\beta}\in \mathcal{S}}f(\boldsymbol{\beta}) \triangleq - \eta_r(\boldsymbol{\beta};p,q)
    + \mathcal{R}_\mathcal{S}(\boldsymbol{\beta}),
    % \underbrace{\lambda_1\cdot \alpha_1^{\Gamma_c - \eta_c(\boldsymbol{\beta};k)_{\min}}}_{\triangleq g_1(\boldsymbol{\beta})}
    % + \underbrace{\lambda_2\cdot(2\boldsymbol{\beta}^H-1)_{\max}^{\alpha_2}}_{\triangleq g_2(\boldsymbol{\beta})},
    \end{aligned}
\end{equation}
{where $\mathcal{S}$ represents the feasible set of the \ac{hris}'s power splitting vector $\boldsymbol{\beta}$, given by $\mathcal{S}\triangleq \{\boldsymbol{\beta}\in \mathbbm{R}:0\leq \beta_l\leq1, \forall l\in[1,N] \}$, and $\mathcal{R}_\mathcal{S}(\boldsymbol{\beta})$ is a Lagrangian operator, which converts the communication constraint (\ref{com_beta}) $\eta_c(\boldsymbol{\beta};k)\geq\Gamma_c$, for $k=1,..,K$ into the objective function.}
To this end, we apply the Lagrangian operator:
\begin{equation}
\label{lag}    
    \begin{aligned}
        \centering
        \mathcal{R}_\mathcal{S}(\boldsymbol{\beta})=\lambda_1\cdot\underbrace{ \alpha_1^{\Gamma_c - \eta_c(\boldsymbol{\beta};k)}}_{\triangleq g_1(\boldsymbol{\beta})}
    + \lambda_2\cdot\sum_{l=1}^{N}\underbrace{(2\beta_l-1)^{\alpha_2}}_{\triangleq g_2({\beta}_l)}, 
    \end{aligned}
\end{equation}
where $\lambda_1$ and $\lambda_2$ are {strictly positive} hyper-parameters to control the threshold of the communication user's \ac{sinr} and manage the power of the \ac{hris}. Formally, the communication guarantee and power constraints of the \ac{hris} in (\ref{obj}) are converted into $g_1(\boldsymbol{\beta})$ and $g_2({\beta}_l)$, respectively. Combining the properties of the exponential and power functions, {$g_1(\boldsymbol{\beta})$ is designed as the exponential function which needs to satisfy:~$0<g_1(\boldsymbol{\beta})\leq 1$, when $\eta_c(\boldsymbol{\beta};k)\geq \Gamma_c,~\forall k\in[1,K]$; $g_2({\beta}_l)$ is considered as the even power function to add a high penalty to the point approaching the boundary of $\mathcal{S}$: $g_2(\beta_l)\gg 1$, when $\beta_l\notin [0,1]$. Here, we set $\alpha_1=4$ and $\alpha_2=10$ empirically.}


We next propose a \acf{fgs} assisted \acf{agd} algorithm to address the non-convex unconstrained optimization problem in (\ref{objlag}). {The key idea of the proposed algorithm is to utilize \ac{ad} \cite{baydin2018automatic} to obtain a convergent solution according to the specific initialization parameters $\boldsymbol{\beta}$ generated by the proposed \ac{fgs}.
% As the final objective function $f(\boldsymbol{\beta})$ given in (\ref{objlag}) is non-convex, the aim here is to find the locally optimal solution.

We begin with the implementation of \ac{agd}, and then introduce the designed initialization strategy \ac{fgs}.}
First, to reduce the complexity of gradient calculation, we employ the advanced \ac{agd} approach {to obtain the solution of $\boldsymbol{\beta}$ after $M$ iterations}, as shown in Algorithm~\ref{al1_agd}. The $(i+1)$-th iterative step in conventional gradient descent is written as:
\begin{equation}
    \begin{aligned}
    \centering
    \boldsymbol{\beta}^{i+1} = \boldsymbol{\beta}^i + \Delta_i\cdot\nabla f(\boldsymbol{\beta}^i),
    \end{aligned}
\end{equation}
where $\nabla(\cdot)$ is the first-order gradient operator, and $\Delta_i$ is the step size.
% length along the direction of the gradient descent $\nabla f(\boldsymbol{\beta}_i)$. 
{We replace the traditional gradient operator $\nabla(\cdot)$ with the \ac{ad} tool. The main concept of \ac{ad} is to represent the objective function as a computational graph according to chain rules, to which the back-propagation algorithm is applied.} Thus, the gradient direction at point $\boldsymbol{\beta}^i$ is given by 
\begin{equation}
\label{grad_dire}
    \begin{aligned}
        \centering
        \nabla f(\boldsymbol{\beta}^i) \approx \mathbf{BP}(f(\boldsymbol{\beta}^i)),
    \end{aligned}
\end{equation}
where $\mathbf{BP}(\cdot)$ is the gradient computation operator based on \ac{ad} and $f(\boldsymbol{\beta}^i)$ is the input objective function. Here, we use autograd of PyTorch \cite{paszke2019pytorch} to {compute} $\mathbf{BP}(\cdot)$ {and generate the initial $\boldsymbol{\beta}^0$ randomly}.
The gradient descent's step length $\Delta_i$ is substituted by the learning rate $l_r$ and is updated by the Adam optimizer of the PyTorch \cite{kingma2014adam}. Therefore, we can achieve \ac{agd} with variable step size by adjusting the learning rate. 
% However, we only use the automatic gradient calculation of the PyTorch architecture, which means it's not a trainable method and will not learn parameters during the whole iteration.

\begin{algorithm}
    \caption{\ac{hris} configuration via \ac{agd} algorithm}
    \renewcommand{\algorithmicrequire}{\textbf{Input:}}
    \renewcommand{\algorithmicensure}{\textbf{Output:}}
    \label{al1_agd}
    \begin{algorithmic}[1]
        \REQUIRE \leavevmode \\
        Initialize: $\boldsymbol{\beta }^0$, $M$, $l_r$;\\
        \FOR{$i=0:M-1$}
        \STATE Calculate the objective $f(\boldsymbol{\beta}^i) = - \eta_r(\boldsymbol{\beta}^i;p,q)+\mathcal{R}_\mathcal{S}(\boldsymbol{\beta}^i)$;
        \STATE Calculate the gradient direction $\nabla f(\boldsymbol{\beta}^i)$ according to (\ref{grad_dire});
        \STATE Find the next point and update $\boldsymbol{\beta}^{i+1} = \boldsymbol{\beta}^i+ l_r\cdot\nabla f(\boldsymbol{\beta}^i)$;
        \ENDFOR
        \ENSURE \leavevmode \\
        \ac{hris} configuration vector $\boldsymbol{\beta}$.
    \end{algorithmic}
\end{algorithm}


{The performance of Algorithm~\ref{al1_agd} depends heavily on the initial point $\boldsymbol{\beta}^0$. 
% In particular, the boundary of the \ac{agd} is determined by the initial point $\boldsymbol{\beta}^0$, which limits the scope of the optimization. 
We design an \ac{fgs} algorithm to find a good initial $\boldsymbol{\beta}$, as shown in Algorithm \ref{al1}. 
The basic concept of \ac{fgs} is to set the value corresponding to the first half elements of the vector $\boldsymbol{\beta}$ to zero:~$\boldsymbol{\beta}(1:\frac{N}{2})=\boldsymbol{0}_{\frac{N}{2}\times 1}$; and then let the value of the second half elements vary in space $\mathcal{S}$:~$\boldsymbol{\beta}(\frac{N}{2}+1:N)=z\Delta_z \boldsymbol{I}_{\frac{N}{2}\times 1}$, for $z=0,...,Z_{\max}$. We define the number of grids in space $\mathcal{S}$ by $Z_{\max}$ and the grid step by $\Delta_z$, which satisfies:~$Z_{\max}\Delta_z=1$. Since the gird value $z\Delta_z$ of the slice of $\boldsymbol{\beta}$ is discrete and finite, the optimal solution of (\ref{objlag}) is obtained by traversing all grid values in space $\mathcal{S}$. In our designed \ac{fgs} algorithm, $\boldsymbol{\beta}$ is divided by $M_{\max}$ times to increase the freedom of the grid search. In the $m$-th iteration, we update the slice $(\zeta_1^m:\zeta_2^m)$ of the $\boldsymbol{\beta}^{m}$ by:
\begin{subequations}
\label{slices}
    \begin{align}
        \centering
        & (\zeta_1^m:\zeta_2^m)=\left(1:\frac{N}{2^m}\right),\\
        & (\zeta_1^m:\zeta_2^m)=\left(\frac{2^m-1}{2^m}N:N\right),
    \end{align}
\end{subequations}
while holding the same search space, expressed by
\begin{equation}
\label{fgs_grid}
    \begin{aligned}
        \centering
        \boldsymbol{\beta}^{m,z}(\zeta_1^m:\zeta_2^m)=z\Delta_z \boldsymbol{I}_{(\zeta_2^m-\zeta_1^m)\times 1},~ z= 0,...,Z_{\max},
    \end{aligned}
\end{equation}
Since the length of each slice needs to be not less than 1, the maximum iteration step size is $M_{\max}=\log_2^N$. 
Following the above discretization method, there exists an optimal solution $\boldsymbol{\beta}^{m}$ piloting to the minimal value of (\ref{objlag}). The $\boldsymbol{\beta}^m$ is thus updated based on the following operation:
\begin{equation}
\label{fgs_grid_up}
    \begin{aligned}
        \centering
        \boldsymbol{\beta}^{m+1} = \min_{\boldsymbol{\beta}^{m,z}} f\left(\boldsymbol{\beta}^{m,z}\right), ~ z= 0,...,Z_{\max}.
    \end{aligned}
\end{equation}}

\begin{algorithm}
    \caption{Initialization operation via \ac{fgs} algorithm}
    \renewcommand{\algorithmicrequire}{\textbf{Input:}}
    \renewcommand{\algorithmicensure}{\textbf{Output:}}
    \label{al1}
    \begin{algorithmic}[1]
        \REQUIRE \leavevmode \\
        Initialize: $\boldsymbol{\beta}^0=\boldsymbol{0}_{N\times1}$;\\
        \FOR{$m=1,...,M_{\max}$}
        \STATE Select the update slice $(\zeta_1^m:\zeta_2^m)$ {via (\ref{slices})};
        \FOR{$z=1,...,Z_{\max}$}
        \STATE Grid search $\boldsymbol{\beta}^{m,z}$ according to (\ref{fgs_grid});
        \STATE Calculate the objective function $f\left(\boldsymbol{\beta}^{m,z}\right)$;
        \ENDFOR
        \STATE Update the next point $\boldsymbol{\beta}^{m+1}$ according to (\ref{fgs_grid_up});
        \ENDFOR
        \ENSURE \leavevmode \\
        \ac{hris} initial point $\boldsymbol{\beta}^0$ used in Algorithm~\ref{al1_agd}.
    \end{algorithmic}
\end{algorithm}

In summary, we first proposed the \ac{fgs} approach to obtain a good initial point $\boldsymbol{\beta}^0$, which determines the boundary of the gradient descent. Then, the \ac{agd} approach based on the back-propagation of PyTorch's autograd is applied to find a solution of (\ref{objlag}).
% By using \ac{fgs}-\ac{agd}, we can get a satisfying \ac{hris} configuration $\boldsymbol{\bar{\beta}}^{(t)}$ quickly in the $t$-th iteration step. 


\vspace{-0.2cm}
\subsection{Transmitted Beam Design with fixed HRIS configuration}
\label{sec:bs design}
\vspace{-0.1cm} 
After the \ac{hris} configuration optimization, the power splitting vector $\boldsymbol{\bar{\beta}}^{(t)}$ of the reflected matrix $\boldsymbol{\Psi}$ and received vector $\boldsymbol{\phi}$ are obtained. We henceforth seek to optimize the joint beamforming matrix $\boldsymbol{W}=[\boldsymbol{W}_c,\boldsymbol{w}_{r}]$ of the \ac{bs} to maximize the radar performance with the fixed \ac{hris} configuration. The optimization problem (\ref{eq19}) becomes: 
{\begin{subequations}
\label{eq19b}
    \begin{align}
    \centering
    \max_{\boldsymbol{W}}& \  \eta_r\left(\boldsymbol{W},\boldsymbol{\bar{\beta}}^{(t)};p,q\right),\\
    {\rm s.t.} \ &\eta_c\left(\boldsymbol{R},\boldsymbol{R}_k, \boldsymbol{\bar{\beta}}^{(t)}; k\right)\ge \Gamma_c, ~k=1,...,K ,\\
    & \boldsymbol{R}_i = \boldsymbol{w}_i\boldsymbol{w}_i^H,~i=1,...,K+1,\\
    & \boldsymbol{R}= \sum_{i=1}^{K+1}\boldsymbol{R}_i,\\
    % & {\rm rank}(\boldsymbol{R}_i)=1,~ i=1,...,K+1,\\
    & [\boldsymbol{R}]_{j,j}=P_t, ~j=1,...,T.
    \end{align}
\end{subequations}}
% In this subsection, we strive to address this multi-parameter non-convex optimization problem. To this aim, we first represent the cascaded communication channel as $\boldsymbol{\hat{h}}_{k,t}$, for $k=1,..,K$, based on (\ref{cascaded channel}), and then express the \ac{sinr} for each user separately. 
% Let each column of the $\boldsymbol{W}$ which represents the controllable codes of \ac{bs} denoted by $\boldsymbol{w}_i$, and then the covariance matrix $\boldsymbol{R}$ is rewritten as the sum of sub-covariance matrices $\boldsymbol{R}_i$ of different codes:
% \begin{equation}
% \label{eq22}
%     \begin{aligned}
%     \centering
%     \boldsymbol{R}=\sum_{i=1}^{K+1}\boldsymbol{w}_i\boldsymbol{w}_i^H = \sum_{i=1}^{K+1}\boldsymbol{R}_i.
%     \end{aligned}
% \end{equation}
% Obviously, the covariance matrix $\boldsymbol{R}$ comprises of rank-one matrices $\boldsymbol{R}_i$, which implies that it has implicit constraints $ {\rm rank}(\boldsymbol{R}_i)=1$, for $i=1,...,K, K+1$.
% Then, by combining with (\ref{cascaded channel}) and substituting the (\ref{eq22}) into the (\ref{eq36}), the expression of the $k$-th user's \ac{sinr} is rewritten as
% \begin{equation}
% \label{eq23}
%     \begin{aligned}
%     \centering
%     \eta_c(\boldsymbol{R},\boldsymbol{R}_k; k) = \frac{\boldsymbol{\hat{h}}_{k,t}^H\boldsymbol{R}_k\boldsymbol{\hat{h}}_{k,t}}{\boldsymbol{\hat{h}}_{k,t}^H\boldsymbol{Rh}_{k,t}-\boldsymbol{\hat{h}}_{k,t}^H\boldsymbol{R}_k\boldsymbol{\hat{h}}_{k,t}+\sigma^2},~ k=1, ..., K.
%     \end{aligned}
% \end{equation}

{Similar to the expression of the user's \ac{sinr}, we represent the radar's \ac{sinr} in terms of the transmit sub-covariance matrices $\boldsymbol{ R}_i$
\begin{equation}
\label{eq18}
    \begin{aligned}
    \centering
    \eta_r(\boldsymbol{R},\boldsymbol{R}_{K+1}, \boldsymbol{\beta};p,q) =  \frac{|A_r(\boldsymbol{\beta})|^2\boldsymbol{a}_t^H \boldsymbol{R}_{K+1}\boldsymbol{a}_t}{|A_r(\boldsymbol{\beta})|^2\boldsymbol{\hat{a}}_h^H(\boldsymbol{\beta})\boldsymbol{R}\boldsymbol{\hat{a}}_h(\boldsymbol{\beta})+\sigma^2},
    \end{aligned}
\end{equation}
where $\boldsymbol{R}_{K+1}=\boldsymbol{w}_r\boldsymbol{w}_r^H$.
By updating the cascaded received scalar $\bar{A}_{r}^{(t)}$ and the cascaded reflected vector $\boldsymbol{\bar{a}}_{h}^{(t)}$ based on (\ref{cascaded reflect}) and replacing $\boldsymbol{R}_{K+1}=\left(\boldsymbol{R}-\sum_{k=1}^K\boldsymbol{R}_{k}\right)$ according to (\ref{eq22}),} the \ac{sinr} of the radar for a point target at position $(p,q)$ is
\begin{equation}
\label{eq33}
    \begin{aligned}
    \centering
    \eta_r(\boldsymbol{R}, \boldsymbol{R}_{k};p,q)=\frac{\left|\bar{A}_{r}^{(t)}\right|^2\boldsymbol{ a}_t^H\left(\boldsymbol{R}-\sum_{k=1}^K\boldsymbol{R}_{k}\right)\boldsymbol{a}_t}{\left|\bar{A}_{r}^{(t)}\right|^2\boldsymbol{\bar{a}}_{h}^{(t)H}\boldsymbol{R}\boldsymbol{\bar{a}}_{h}^{(t)}+\sigma^2}.
    \end{aligned}
\end{equation}

Thus, with the respective expression of radar's \ac{sinr} $\eta_r$ and communication's \ac{sinr} $\eta_c$ in (\ref{eq33}) and (\ref{eq23}) in terms of $\boldsymbol{R}_i$, (\ref{eq19b}) is reformulated as
\begin{subequations}
\label{st2}
    \begin{align}
    \centering
    \max_{\boldsymbol{R}_1,...,\boldsymbol{R}_K,\boldsymbol{R}_{K+1}} \quad & \eta_r(\boldsymbol{R}, \boldsymbol{R}_{k};p,q),\\
    {\rm s.t.} \
    & \eta_c(\boldsymbol{R},\boldsymbol{R}_k; k)\ge\Gamma_c,~ k=1,...,K ,\\
    & \boldsymbol{R}=\sum_{i=1}^{K+1}\boldsymbol{R}_i,\\
    & {\rm rank}(\boldsymbol{R}_i)=1,~ i=1,...,K+1,\\
    & [\boldsymbol{R}]_{j, j}=P_t, ~j=1,...,T.
    \end{align}
\end{subequations}
 
The \ac{bs} transmitted beam design problem (\ref{st2}) is non-convex. 
% According to other \ac{dfrc} work (\cite{4,pritzker2022transmit}), the relaxation strategy doesn't affect the optimal solution of (\ref{st2}), thus we can use the \ac{sdr} technique to obtain the optimal solution of the \ac{bs} transmitted beam design problem. 
According to \cite{zhang2010relationship}, (\ref{st2}) can be reduced to solving a sequence of convex feasibility problems. Thus, (\ref{st2}) is subsequently transformed as
\begin{subequations}
\label{st3}
    \begin{align}
    \centering
    \max_{\boldsymbol{R}_1,...,\boldsymbol{R}_K,\boldsymbol{R}_{K+1},\Gamma_r} ~&\Gamma_r,\\
    {\rm s.t.} \ & \eta_r(\boldsymbol{R}, \boldsymbol{R}_{k};p,q)\ge\Gamma_r,\\
    &\eta_c(\boldsymbol{R},\boldsymbol{R}_{k};k)\ge\Gamma_c,~ k=1,...,K ,\\
    & \boldsymbol{R}=\sum_{i=1}^{K+1}\boldsymbol{R}_i,\\
    & {\rm rank}(\boldsymbol{R}_i)=1,~ i=1,...,K+1,\\
    & [\boldsymbol{R}]_{j,j}=P_t, ~j=1,...,T.
    \end{align}
\end{subequations}

Let $\Gamma_r^*$ be the optimal solution of problem (\ref{st3}). Obviously, $\Gamma_r^*$ is also the optimal value of the original problem (\ref{st2}). If the following feasibility problem
\begin{subequations}
\label{st3_}
    \begin{align}
    \centering
    {\rm Find} ~&\boldsymbol{R}_1,...,\boldsymbol{R}_K,\boldsymbol{R}_{K+1},\\
    {\rm s.t.} \ & \eta_r(\boldsymbol{R}, \boldsymbol{R}_{k};p,q)\ge\Gamma_r,\\
    &\eta_c(\boldsymbol{R},\boldsymbol{R}_{k};k)\ge\Gamma_c,~ k=1,...,K ,\\
    & \boldsymbol{R}=\sum_{i=1}^{K+1}\boldsymbol{R}_i,\\
    & {\rm rank}(\boldsymbol{R}_i)=1,~ i=1,...,K+1,\\
    & [\boldsymbol{R}]_{j,j}=P_t, ~j=1,...,T,
    \end{align}
\end{subequations}
for a fixed $\Gamma_r$ is feasible, then it follows that $\Gamma_r^*\ge\Gamma_r$. If (\ref{st3_}) is infeasible, then $\Gamma_r^*<\Gamma_r$. Therefore, by giving a potential range of $\Gamma_r$ which contains $\Gamma_r^*$, the optimal solution of (\ref{st3}) can be obtained via bisection search. 

We next introduce the solution of (\ref{st3_}) which is still non-convex because of the rank-one constraints. It was shown in previous works \cite{4,pritzker2022transmit} that (\ref{st3_}) can be solved with \ac{sdr} without loss of optimality.
Omitting the rank-one constraint, (\ref{st3_}) is relaxed to
\begin{subequations}
\label{st5}
    \begin{align}
    \centering
    {\rm Find} ~&\boldsymbol{R}_1,...,\boldsymbol{R}_K,\boldsymbol{R}_{K+1},\\
    {\rm s.t.} \ & \eta_r(\boldsymbol{R}, \boldsymbol{R}_{k};p,q)\ge\Gamma_r,\label{eta_r_f}\\
    &\eta_c(\boldsymbol{R},\boldsymbol{R}_{k};k)\ge\Gamma_c,~ k=1,...,K ,\label{eta_c_f}\\
    & \boldsymbol{R}=\sum_{i=1}^{K+1}\boldsymbol{R}_i,\\
    & [\boldsymbol{R}]_{j,j}=P_t, ~j=1,...,T.
    \end{align}
\end{subequations}
We rewrite (\ref{eta_r_f}) and (\ref{eta_c_f}) with the following rearrangements:
\begin{subequations}
\label{objst}
    \begin{align}
        \centering
        &\Gamma_r^{-1}\boldsymbol{a}_t^H\left(\boldsymbol{R}-\sum_{k=1}^K\boldsymbol{R}_{k}\right)\boldsymbol{a}_t
    \ge\boldsymbol{\bar{a}}_{h}^{(t)H}\boldsymbol{R}\boldsymbol{\bar{a}}_{h}^{(t)}+{\sigma^2}/{\left|\bar{A}_{r}^{(t)}\right|^2},\label{etar_unequal}\\
    & (1+\Gamma_c^{-1})\boldsymbol{\hat{h}}_{k}^{(t)H}\boldsymbol{R}_k\boldsymbol{\hat{h}}_{k}^{(t)}\ge \boldsymbol{\hat{h}}_{k}^{(t)H}\boldsymbol{R}\boldsymbol{\hat{h}}_{k}^{(t)}+\sigma^2,~k=1,...,K,\label{etac_unequal}
    \end{align}
\end{subequations}
where the $\boldsymbol{\hat{h}}_{k}^{(t)}$ is the cascaded communication channel updated via (\ref{cascaded channel}). By respectively substituting rearrangements in (\ref{etar_unequal}) and (\ref{etac_unequal}) into constraints (\ref{eta_r_f}) and (\ref{eta_c_f}), problem (\ref{st5}) becomes convex and can be solved using CVX \cite{toh1999sdpt3}.

Similar to \cite{pritzker2022transmit}, the feasibility problem (\ref{st5}) has a closed-form solution
% Under this condition, this convex problem (\ref{st5}) is able to find a feasible solution that satisfies the rank-one constraints, which can be proved by the following theorem:
% \begin{theorem}
% \label{Theorem}
$\boldsymbol{\hat{R}}_1,...,\boldsymbol{\hat{R}}_K,\boldsymbol{\hat{R}}_{K+1}$,
% is the optimal solution of the relaxed problem (\ref{st5}),
% The problem (\ref{st4}) exists an optimal solution if and only if there exists a beamforming matrix $\boldsymbol{W}$ satisfying the per-antenna power control and each of the covariance matrices, denoted by $\boldsymbol{R}_1,...,\boldsymbol{R}_K,\boldsymbol{R}_{K+1}$, 
satisfying:
\begin{equation}
\label{theo_rank}
    \begin{aligned}
    \centering
    {\rm rank}(\boldsymbol{\hat{R}}_i)=1, ~i=1,...,K+1.
    \end{aligned}
\end{equation}
% \end{theorem}
% \begin{proof}
% \label{Proof}
% See Appendix \ref{app:Proof1}
% \end{proof}
{Obviously, for each $\Gamma_r$, if (\ref{st5}) is feasible, we have  a solution that satisfies rank-one constraints in (\ref{theo_rank}). 
% Thus, for the optimal solution $\Gamma_r^*$, (\ref{st5}) is feasible and has the close-form solution that satisfies (\ref{theo_rank}). 
By bisection search on $\Gamma_r$, we denote the solution of (\ref{st5}) corresponding to the maximum value of the variable $\Gamma_r$ as the optimal solution of the original maximization problem (\ref{st2}).}
 Then, the \ac{bs}'s communication beamforming matrix $\boldsymbol{W}_c=[\boldsymbol{w}_1,...,\boldsymbol{w}_K]$ is calculated by 
\begin{equation}
\label{eq:cholesky}
    \begin{aligned}
    \centering
    \boldsymbol{\hat{w}}_k = \left(\boldsymbol{\hat{h}}_{k}^{(t)H}\boldsymbol{\hat{R}}_k \boldsymbol{\hat{h}}_{k}^{(t)}\right)^{-\frac{1}{2}}\boldsymbol{\hat{R}}_k \boldsymbol{\hat{h}}_{k}^{(t)}, ~k=1,...,K,
    \end{aligned}
\end{equation}
and the radar beamforming vector $\boldsymbol{\hat{w}}_r$ is given by
\begin{equation}
\label{eq:cholesky2}
    \begin{aligned}
    \centering
    \boldsymbol{\hat{w}}_r = \left(\boldsymbol{a}_t^H \left(\boldsymbol{\hat{R}}-\sum_{k=1}^K\boldsymbol{\hat{R}}_{k} \right)\boldsymbol{a}_t\right)^{-\frac{1}{2}}\left(\boldsymbol{\hat{R}}-\sum_{k=1}^K\boldsymbol{\hat{R}}_{k} \right) \boldsymbol{a}_t.
    \end{aligned}
\end{equation}

{In summary, to accomplish the transmitted beam design with a fixed \ac{hris} configuration, we convert the maximization problem (\ref{st2}) into a feasibility problem (\ref{st3}) of the variable $\Gamma_r$. For a fixed $\Gamma_r$, we solve the feasibility problem (\ref{st3}). By using the \ac{sdr} technique \cite{4} to relax,  all the constraints in (\ref{st5}) are linear matrix inequalities over $\boldsymbol{R}_i$ and thus can be solved via CVX \cite{toh1999sdpt3}.
Correspondingly, the optimal value of $\Gamma_r$ can be obtained by a bisection search, and the beamforming matrix $\boldsymbol{W}$ is calculated by (\ref{eq:cholesky}) and (\ref{eq:cholesky2}).}



\vspace{-0.2cm}
\subsection{Alternating Optimization strategy in HRIS-assisted  MIMO DFRC System Beamforming}
\label{sec:alt_beam}
%\vspace{-0.1cm} 

In this section, we detail how to implement the alternating optimization of the \ac{bs} waveforms and \ac{hris} beam patterns, as well as the mechanism for updating system parameters throughout this alternating optimization process in Algorithm \ref{al2}. 
\begin{algorithm}
    \caption{\ac{hris}-assisted \ac{mimo} \ac{dfrc} system alternating optimization}
    \renewcommand{\algorithmicrequire}{\textbf{Input:}}
    \renewcommand{\algorithmicensure}{\textbf{Output:}}
    \label{al2}
    \begin{algorithmic}[1]
        \REQUIRE \leavevmode \\
        User's \ac{sinr} threshold $\Gamma_c$;\\
        Initialization: $\boldsymbol{\beta}^0=\boldsymbol{0}_{N\times 1}$;\\
        Set the objective function $f(\boldsymbol{\beta})$ based on (\ref{objlag}).
        \REPEAT
        \STATE Compute the optimal $\boldsymbol{\beta}$ by solving the non-convex optimization problem (\ref{obj}) according to Algorithm~\ref{al1_agd} and Algorithm~\ref{al1}.
        \STATE {Calculate the reflected vector $\boldsymbol{\hat{a}}_h$ and the received scalar $A_r$ via (\ref{cascaded reflect}).}
        \STATE Compute the covariance matrix $\boldsymbol{R}$ and its sub-covariance matrices $\boldsymbol{R}_i$ of the \ac{bs} by solving (\ref{st2}) with bisection search and \ac{sdr} techniques.
        \STATE Compute $\boldsymbol{w}_i$ via (\ref{eq:cholesky}) and (\ref{eq:cholesky2}).
        \STATE Update the matrices $\boldsymbol{C}_1$, $\boldsymbol{C}_2$, $\boldsymbol{C}_3$ via (\ref{C_1_2_3}).
        \UNTIL $ \left|f\left(\boldsymbol{\beta}^{(t)}\right)-f\left(\boldsymbol{\beta}^{(t-1)}\right)\right| < \epsilon$
        \STATE Select the total beamforming matrix $\boldsymbol{W}=[\boldsymbol{w}_1,..., \boldsymbol{w}_{r}]$
        \ENSURE \leavevmode \\
        The \ac{hris} configuration vector $\boldsymbol{\beta}$;\\
        The \ac{bs} beamforming matrix $\boldsymbol{W}$.
    \end{algorithmic}
\end{algorithm}

% First, as noted in solving the problem (\ref{obj}), the optimal beamforming of the \ac{hris} is determined utilizing non-convex optimization approaches. In this step, we seek to obtain the best \ac{hris} configuration, where Algorithm \ref{al1} is used to generate the initial \ac{hris} power splitting factor and the Algorithm~\ref{al1_agd} is applied to obtain the optimal \ac{hris} configuration in each alternating optimization round. 

% Second, we use this optimal solution to compute the reflected matrix $\boldsymbol{A}_h$ and received matrix $\boldsymbol{A}_r$, which are used to address the joint transmitted beamforming design (\ref{st5}). And then, we use the CVX toolbox to obtain the covariance matrix $\boldsymbol{R}$ by tackling the optimization problem (\ref{st5}). Furthermore, the \ac{bs}'s beamforming vector $\boldsymbol{w}_i$ of the radar waveform and the communication waveforms can be calculated by the eigendecomposition of the corresponding covariance matrix $\boldsymbol{R}_i$. Besides that, we are already able to complete the first round iteration of the \ac{hris}-assisted \ac{mimo} \ac{dfrc} system beamforming alternating optimization, and the next step is to repeat this alternating optimization process until the variation in the objective function is less than $\epsilon$. 
First, as noted in solving (\ref{obj}), {the configuration of the \ac{hris} is determined utilizing the \ac{fgs}-\ac{agd} approach. Second, we use this configuration to compute the reflected vector $\boldsymbol{\hat{a}}_h$ and received scalar $A_r$ according to (\ref{cascaded reflect})}, which are used to address the joint transmitted beamforming design (\ref{st2}). Then, {we use the bisection search and \ac{sdr} techniques} to obtain the covariance matrix $\boldsymbol{R}$ by tackling the optimization problem (\ref{st2}).

Note that the propagation matrices $\boldsymbol{C}_1$, $\boldsymbol{C}_2$, $\boldsymbol{C}_3$ will change with the \ac{bs} beamforming matrix $\boldsymbol{W}=[\boldsymbol{W}_c,\boldsymbol{w}_{r}]$, so that we need to update these system parameters during iterations. Combining with the definitions of the matrices $\boldsymbol{C}_1$, $\boldsymbol{C}_2$, and $\boldsymbol{C}_3$, we can update these propagation matrices according to (\ref{C_1_2_3}).
% \begin{subequations}
% \label{update}
%     \begin{align}
%     \centering
%     \boldsymbol{C}_1 = &\boldsymbol{a}_r\boldsymbol{a}_t^H(\boldsymbol{R}-\sum_{i=1}^K\boldsymbol{R}_{i})\boldsymbol{a}_t \boldsymbol{a}_r^H, \\
%     \boldsymbol{c_2} =& \boldsymbol{a}_h (\boldsymbol{GW}), \\
%     \boldsymbol{C}_2 =& \boldsymbol{c}_2\boldsymbol{c}_2^H, \\
%     \boldsymbol{c}_3 =& \boldsymbol{h}_k (\boldsymbol{G w}_k), ~k=1,..,K,\\
%     \boldsymbol{C}_3 =& \frac{\boldsymbol{c}_3\boldsymbol{c}_3^H} {\boldsymbol{h}_k^H\boldsymbol{Rh}_k-\boldsymbol{h}_k^H\boldsymbol{R}_k\boldsymbol{h}_k+\sigma^2}, ~k=1,..,K.
%     \end{align}
% \end{subequations}

As we complete updating the \ac{hris}-assisted \ac{mimo} \ac{dfrc} system parameters, we need to optimize the \ac{hris} configuration as well as the joint transmitted beam design of the \ac{bs} continually. After several iterations, the Algorithm~\ref{al2} stops {when $ \left|f\left(\boldsymbol{\beta}^{(t)}\right)-f\left(\boldsymbol{\beta}^{(t-1)}\right)\right|<\epsilon$.}



	%----------------------------------------------------------------------------------------
	%	NUMERICAL EVALUATIONS
	%----------------------------------------------------------------------------------------
	\vspace{-0.2cm}
	\section{Numerical Evaluations}
	\label{sec:Sims}
	%\vspace{-0.1cm} 
	
In this section, we provide numerical results to evaluate the performance of our proposed joint beamforming design algorithm for \ac{hris}-assisted \ac{mimo} \ac{dfrc} systems. Specially, we first describe the simulation setup of the \ac{hris}-assisted \ac{mimo} \ac{dfrc} system in section \ref{subsec:setup} and then present some numerical results to analyze the improvements in radar and communication performance compared with the \ac{bs}-only system and \ac{bs}-\ac{ris} system in section~\ref{subsec:converg}. 

\vspace{-0.2cm}
\subsection{Simulation Setup}
\label{subsec:setup}
%\vspace{-0.1cm}

The proposed \ac{hris}-assisted \ac{mimo} \ac{dfrc} configuration is illustrated in Table. \ref{tab:hrisplat}, where the wavelength $\lambda=0.1$~m. The total number of elements in \ac{hris} is $N=16$, which is a square planar array deployed on the 3D Cartesian coordinate's YOZ plane. 
\begin{table}[htbp]
    \centering
    \caption{The \ac{dfrc} platform simulation configuration}
    \begin{tabular}{c|c}
    \hline \hline
        Parameters & Value \\
        \hline
        Center frequency & $3$~GHz \\
        The inter-element spacing in \ac{hris} & $\lambda$ \\
        The inter-element spacing in \ac{bs} & $\lambda/2$ \\
        Position of the \ac{hris} center & $(0, 100\lambda, 30\lambda)$ \\
        Position of the \ac{bs} center& $(0, 0, 300\lambda)$ \\
        Position of the user & $(75\lambda, 100\lambda, 0)$ \\
        Position of the target & $(0,0,0)$\\
        $\Gamma_c$ & 5 dB \\
        $N$ & 16\\
        $T$ & 8\\
        \hline \hline
    \end{tabular}
    \label{tab:hrisplat}
\end{table}

% Based on this configuration, the predefined radar \ac{sinr} $\Gamma_r = 30$~dB and the threshold of communication is $\Gamma_c=5$~dB (Empirically). 
% In each evolution iteration of the alternative algorithm, we analyze different \ac{hris} configuration design approaches in the \ac{hris} configuration optimization and utilize the MATLAB CVX toolbox to obtain the optimal joint transmitted beam pattern.


\vspace{-0.2cm}
\subsection{Performance Analysis}
\label{subsec:converg}
%\vspace{-0.1cm}



First, we study the convergence performances of both the alternating optimization approach in Algorithm~\ref{al2} and the \ac{fgs}-\ac{agd} algorithm, where the user is deployed at $(75\lambda, 100\lambda, 0)$ and the radar target is put at 3D Cartesian coordinate center $(0, 0, 0)$. In particular, by applying the \ac{fgs}-\ac{agd} for \ac{hris} configuration optimization and the \ac{sdr} technique for \ac{bs} beamforming design, the convergence performance is shown in Fig. \ref{convergence_aia}, when the per-antenna power of the \ac{bs} is $P_t = 0$~dB.
It indicates the proposed algorithm achieves convergence very fast in less than four iterations. 
In addition, the convergence of the proposed \ac{fgs}-\ac{agd} method is shown in Fig. \ref{fig:agdsinr}. With the assistance of the initialization operation in Algorithm~\ref{al1}, Algorithm~\ref{al1_agd} converges to a fixed value within $1000$ iterations, which shows the efficiency and stability of the \ac{fgs}-\ac{agd} algorithm.
% This implies that the element's power $\boldsymbol{\beta}$ plays different roles in the radar performance and user communication in \ac{hris}, which gives us more freedom to design the reflected beam and received beam on the same platform.
\begin{figure}[htbp]
	\centering  
	\subfigtopskip=2pt %设置子图与上面正文或别的内容的距离
	\subfigbottomskip=2pt %设置第二行子图与第一行子图的距离，即下面的头与上面的脚的距离
	\subfigcapskip=-5pt %设置子图与子标题之间的距离
	\subfigure[Convergence of the proposed Algorithm~\ref{al2}.]{
		\label{convergence_aia}
		\includegraphics[width=0.9\linewidth]{images/Convergence_curve_AGD_30000_new-eps-converted-to.pdf}}
  
	\subfigure[Convergence of the \ac{fgs}-\ac{agd} algorithm.]{
		\label{fig:agdsinr}
		\includegraphics[width=0.9\linewidth]{images/SINR__Backward_dich-eps-converted-to.pdf}}
	\caption{Convergence performance of the alternating optimization approach in Algorithm~\ref{al2} and the \ac{fgs}-\ac{agd} algorithm. The red line is the radar's \ac{sinr}, the blue line is the communication user's \ac{sinr} and the pink dash is the threshold of communication.}
	\label{convergence}
\end{figure}

\begin{figure}[htbp]
	\centering  
	\vspace{-0.35cm} %设置与上面正文的距离
	\subfigtopskip=2pt %设置子图与上面正文或别的内容的距离
	\subfigbottomskip=2pt %设置第二行子图与第一行子图的距离，即下面的头与上面的脚的距离
	\subfigcapskip=-5pt %设置子图与子标题之间的距离
	\subfigure[Consistent.]{
		\label{fig:same_value}
		\includegraphics[width=0.9\linewidth]{images/SINR_all_elements_in_beta_have_the_same_values_0.00001_0.01_1-eps-converted-to.pdf}}
  
	\subfigure[Random.]{
		\label{fig:rand_value}
		\includegraphics[width=0.9\linewidth]{images/SINR_rand_100-eps-converted-to.pdf}}
	\caption{The \ac{sinr} of radar and communication. The red line represents the \ac{sinr} of radar, the blue line is the \ac{sinr} of the user, and the pink dash shows the threshold of the communication (a) All elements of the \ac{hris} have the same value. (b) The $\boldsymbol{\beta}$ is a random sequence.}
	\label{baseline}
\end{figure}

To evaluate the effect of the \ac{hris} configuration on the \ac{dfrc}'s performance, we explore the radar’s and communication’s \ac{sinr} behaviors via different amplitude distributions on the \ac{hris}. In Fig. \ref{fig:same_value}, all the elements in the \ac{hris} are set to have the same value, and the value of $\boldsymbol{\beta}$ varies between $0$ and $1$.  
It shows that the \ac{sinr} of the radar will degrade when the \ac{sinr} of the user tries to satisfy our constraints. This illustrates the essential trade-off between the \ac{sinr} performance of the radar and communication, which is determined by the operation of the \ac{hris} in splitting the power of each element attached. In Fig. \ref{fig:rand_value}, we randomize the value of $\boldsymbol{\beta}$, and get good performance in both radar and communication at some points. This demonstrates that the \ac{sinr} performance of both radar and communication will be enhanced by \ac{hris} configuration design.



We numerically evaluate the performance gain of our designed \ac{hris}-assisted \ac{mimo} \ac{dfrc} system with the \ac{bs}-only and \ac{bs}-\ac{ris} systems and compare the proposed \ac{fgs}-\ac{agd} algorithm with a conventional optimization approach, such as \ac{ga}. 
Specifically, the \ac{bs}-only system performs both radar sensing and communication using the same hardware, and its \ac{bs} has the same architecture as the proposed system. 
The \ac{bs}-\ac{ris} system utilizes the \ac{ris} to reflect the arriving signals to perform communication with mobile users and another receiver is deployed beside the \ac{ris} to achieve radar sensing. In addition, the \ac{ris} has the same number of elements as the \ac{hris} and they are deployed at the same place.
In Fig. \ref{fig:com_dfrc_sinr}, compared with the \ac{bs}-only and the \ac{bs}-\ac{ris} systems, the proposed \ac{hris}-assisted \ac{mimo} \ac{dfrc} system obtains the best radar performance with the same transmit power. This demonstrates that the optimized \ac{hris} configuration improved the performance of radar sensing and assured communication performance simultaneously. The reason is that the \ac{hris} can possess the dual-function of received and reflected signals.
Moreover, in Fig.~\ref{fig:com_dfrc_sinr}, we see that using the proposed \ac{fgs}-\ac{agd} algorithm and the \ac{agd} approach can achieve better radar performance than using conventional \ac{ga} for the joint problem of the \ac{bs}'s beamforming design and \ac{hris} configuration.
Moreover, we note that the \ac{fgs}-\ac{agd} algorithm achieves a more stable performance than the purely \ac{agd}, which verifies the effectiveness of adding the \ac{fgs} as the initialization strategy.


In order to comprehend the benefit of the \ac{hris} configuration design and the \ac{bs} transmitted beam design, we provide 2D beampattern results of the \ac{hris} by employing the proposed \ac{fgs}-\ac{agd} to demonstrate the power allocation impact of the radar waveform and communication waveform of the \ac{bs}.

\begin{figure}
    \centering
    \includegraphics[width=0.95\linewidth]{images/Comparison_DFRC_SINR_4-eps-converted-to.pdf}
    \caption{Comparison of the radar \ac{sinr} of three types of \ac{dfrc} systems under different per-antenna power supplies.}
    \label{fig:com_dfrc_sinr}
\end{figure}
\begin{figure*}[ht]
	\centering  
	\vspace{-0.35cm} %设置与上面正文的距离
	\subfigtopskip=2pt %设置子图与上面正文或别的内容的距离
	\subfigbottomskip=2pt %设置第二行子图与第一行子图的距离，即下面的头与上面的脚的距离
	\subfigcapskip=-5pt %设置子图与子标题之间的距离
	\subfigure[Beampattern on the YOZ plane.]{
		\label{fig:radar_gua}
		\includegraphics[width=0.95\linewidth]{images/AGD_ULA_radar_interference_angle_new-eps-converted-to.pdf}}
		
	\subfigure[Beampattern on the $\phi=90~^\circ$ plane.]{
		\label{fig:user_gua}
		\includegraphics[width=0.95\linewidth]{images/AGD_ULA_user_guaran_angle_new-eps-converted-to.pdf}}
	\caption{The comparison of the benchmark and that designed by \ac{fgs}-\ac{agd}.}
	\label{jrc_gua}
\end{figure*}
To understand what we get from this \ac{hris} configuration design, we analyze the visual results of the \ac{hris} beampattern and investigate the effects of the radar target's location and the communication user's position on \ac{hris} configuration design. 
In particular, we explore the correspondence between the beampattern direction modified by the \ac{hris} configuration and the \ac{dfrc} performance. To this aim, the beams of the \ac{hris} radiation pattern in the YOZ plane and the $\phi=90^\circ$ plane are illustrated in Fig. \ref{fig:radar_gua} and Fig. \ref{fig:user_gua}, respectively. 
Assuming that rotation angle $\phi$ is formed by rotation along the $y$ axis to the $z$ axis, and $\theta$ is the look-down angle of the \ac{hris}, Fig. \ref{jrc_gua} compares the beam patterns of the \ac{ris} with that the proposed \ac{hris} designed by \ac{fgs}-\ac{agd}. We observe the effect of the radar target's location on the \ac{hris} beam design on the YOZ plane and calculate that the rotation angle $\phi$ of the target relative to the \ac{hris} is around $198^\circ$. In Fig. \ref{fig:radar_gua}, the beam designed by \ac{fgs}-\ac{agd} reduces the side-lobe power level at $\phi\approx 200^\circ$, and results in the main-lobe widening, which means that the optimized \ac{hris} configuration can reduce the interference of the \ac{hris} reflected beam to the detection zone. Then, we study the effect of the communication user's position on the \ac{hris} reflected beam design on the $\phi=90^\circ$ plane and calculate that the look-down angle of the users is around $20^\circ$. We find a similar outcome in Fig. \ref{fig:user_gua}. The beam created by \ac{fgs}-\ac{agd} increases the side-lobe power level at the look-down angle of $\theta\approx 20^\circ$, and at the same time reduces the main lobe, which indicates that the optimized \ac{hris} configuration increases the effective power of communication user by increasing the corresponding side-lobe power level. Hence, we infer that the \ac{hris} adjusts the side-lobe of the beampattern by modifying the amplitude distribution of the surface components, thus increasing the quality of radar detection while maintaining the quality of communication.
\begin{figure}[htp]
	\centering  
	\vspace{-0.35cm} %设置与上面正文的距离
	\subfigtopskip=2pt %设置子图与上面正文或别的内容的距离
	\subfigbottomskip=2pt %设置第二行子图与第一行子图的距离，即下面的头与上面的脚的距离
	\subfigcapskip=-5pt %设置子图与子标题之间的距离
	\subfigure[\ac{ga}.]{
		\label{fig:gaafbs}
		\includegraphics[width=0.65\linewidth]{images/BS_AF_GA_21-eps-converted-to.pdf}}
  
	\subfigure[\ac{fgs}-\ac{agd}.]{
		\label{fig:agdafbs}
		\includegraphics[width=0.65\linewidth]{images/BS_AF_backward_21-eps-converted-to.pdf}}
	\caption{Optimized joint transmitted beampattern. (a) shows the communication and radar waveforms of the \ac{bs} by using the \ac{ga} to obtain the amplitude distribution of \ac{hris}, and (b) shows the joint transmitted waveforms by using the \ac{fgs}-\ac{agd} to design the \ac{hris} beampattern.}
	\label{transbeam}
\end{figure}
\begin{figure}[htp]
    \centering
    \includegraphics[width=0.95\linewidth]{images/Find_max_etaC_etaR_multi_user-eps-converted-to.pdf}
    \caption{Comparison of the \ac{sinr} of the radar under different communication thresholds.}
    \label{fig:maxsinr_com}
\end{figure} 



Next, in the joint transmitted beam design, we employ the optimized \ac{hris} configuration.
% We note that the transmitted beam optimization issue (\ref{st5}) is convex so we can address it by using the \ac{sdr} technique. 
Since we provide the \ac{fgs}-\ac{agd} approach and the \ac{ga} to accomplish the \ac{hris} configuration optimization, there are two types of amplitude distributions of the \ac{hris}. Based on each solution of \ac{hris} beam design, we are able to calculate an optimal solution of the joint transmitted beam design.
In Fig. \ref{transbeam}, we compare the optimization results of the joint transmitted beamforming for two different \ac{hris} amplitude distributions. By geometric calculation, the center of the \ac{hris} is located at a position of about $20~^\circ$ of the look-down angle on the \ac{bs}, and this angle corresponds precisely with the direction of the communication beam we designed. Meanwhile, the look-down angle of the radar beam is around $0~^\circ$ and points to the center of the detection zone, where our deployed radar target is placed. The fact shows that the joint beam design of the \ac{bs} realizes the spatial diversity of the radar and communication waveforms and that the two beam patterns will not conflict in space.
 

To further evaluate the impact of spatial diversity on the performance gain of the proposed \ac{dfrc} system, we explored the radar performance in a multi-user scenario. Specifically, we evaluate the radar \ac{sinr} variation under different communication thresholds $\Gamma_c$ in Fig. \ref{fig:maxsinr_com}, considering deploying another communication user at $(150\lambda, 100\lambda, 0)$. In this scenario, the transmit power of per-antenna on the \ac{bs} is set as $P_t=15$~dB and the $\Gamma_c$ varies from $-5$~dB to $5$~dB with an increasing step set at $2$~dB. 
From Fig.~\ref{fig:maxsinr_com}, we can see that with the communication threshold $\Gamma_c$ rising the radar’s \ac{sinr} decreasing, which demonstrates a clear trade-off between radar sensing and communication.
In addition, we note that the solutions of the \ac{bs}-based and \ac{ris}-based \ac{dfrc} systems disappeared when the communication threshold is over $1$~dB. This phenomenon is reasonable because the second user is sheltered by the first user in the view of \ac{bs}. However, our proposed system modifies the \ac{em} environment and adjusts the beam to illuminate the second user. Thus, from numerical results, our proposed \ac{hris}-assisted \ac{dfrc} system achieves the highest radar \ac{sinr} than others’ presented \ac{dfrc} systems. Specifically, the radar's \ac{sinr} improves $3$~dB than the \ac{bs}-only system and $15$~dB over the \ac{bs}-\ac{ris} system under the same communication threshold and same transmitted power.


	
	%----------------------------------------------------------------------------------------
	%	CONCLUSIONS
	%----------------------------------------------------------------------------------------
	\vspace{-0.2cm}
	\section{Conclusion}
	\label{sec:Conclusions}
	%\vspace{-0.1cm}
In this work, we proposed an \ac{hris}-assisted \ac{mimo} \ac{dfrc} system, where the \ac{hris} performed reflecting communication signals and receiving radar echo concurrently. With the \ac{sinr} as the evaluation metric of both radar and communication, we characterized the trade-off between radar and communication as a joint optimization problem of the \ac{bs} beamforming design and the \ac{hris} configuration design. Aiming to tackle this problem, we proposed an alternating optimization approach that consists of the \ac{fgs}-\ac{agd} algorithm for solving the \ac{hris} configuration optimization and an \ac{sdr} technique for the \ac{bs}'s transmitted beam design. Our simulation indicated an apparent trade-off between the performance of the radar and communication while optimizing the joint design of the \ac{bs} and the \ac{hris}. Numerical results demonstrated that the \ac{hris}-assisted system designed by the proposed approach can improve the radar sensing quality and ensure communication compared to the benchmark systems. 

% Future work may start with the effect of the \ac{hris} reflected phase shifts and the received phase shifts design on the system performance gain. Moreover, it is a challenging demand to accomplish the \ac{hris}-assisted \ac{mimo} \ac{dfrc} system with more complicated scenarios.


	
	

\ifFullVersion
%----------------------------------------------------------------------------------------
%	APPENDICES
%----------------------------------------------------------------------------------------
\vspace{-0.2cm}
\begin{appendix}
	%
	\numberwithin{proposition}{subsection} 
	\numberwithin{lemma}{subsection} 
	\numberwithin{corollary}{subsection} 
	\numberwithin{remark}{subsection} 
	\numberwithin{equation}{subsection}	
	%
	%-----------------------------------
	%	Proof of preconfiguration theorem
	%-----------------------------------
	
	
	\vspace{-0.2cm}
	\subsection{Proof of Proposition \ref{proposition1}}
	\label{app:Proof_1}
 
First, we separate the reflected matrix $\boldsymbol{\Psi}(\boldsymbol{\beta})$ into power splitting factor $\boldsymbol{\beta}$:~$\mathrm{diag}([\beta_1,...,\beta_N])$. From (\ref{cascaded channel}), the cascaded channel for the $k$-th user is given by 
\begin{equation}
\label{cascaded channel_k}
    \begin{aligned}
    \centering
    \boldsymbol{\hat{h}}_k(\boldsymbol{\beta})=\boldsymbol{h}_k^H \mathrm{diag}([\beta_1,...,\beta_N])\boldsymbol{G}.
    \end{aligned}
\end{equation}

Next, 
% and the definition of covariance $\boldsymbol{\bar{R}}^{(t)}=\boldsymbol{\bar{W}}^{(t)}\boldsymbol{\bar{W}}^{(t)H}$ of the beamforming matrices. Then, the \ac{sinr} of the $k$-th user is written as
% \begin{equation}
% \label{sinr_com}
%     \begin{aligned}
%     \centering
%     \eta_c(\boldsymbol{\bar{W}}_{r,t},\boldsymbol{\bar{W}}_{c,t},\boldsymbol{\beta};k) = \frac{\boldsymbol{\hat{h}}_k^H[\boldsymbol{\bar{W}}_{c,t}\boldsymbol{\bar{W}}_{c,t}^H]_{k,k}\boldsymbol{\hat{h}}_k}{\boldsymbol{\hat{h}}_k^H\boldsymbol{\bar{R}}_t\boldsymbol{\hat{h}}_k-\boldsymbol{\hat{h}}_k^H[\boldsymbol{\bar{W}}_{c,t}\boldsymbol{\bar{W}}_{c,t}^H]_{k,k}\boldsymbol{\hat{h}}_k+\sigma^2}, ~k=1,...,K.
%     \end{aligned}
% \end{equation}
by expressing the cascaded communication channel via (\ref{cascaded channel_k}) and combining with (\ref{eq23}), the received power at the user can be recast as (\ref{P_c_sim}).
\begin{figure*}
    \begin{equation}
    \label{P_c_sim}
    \centering \boldsymbol{\hat{h}}_k^H(\boldsymbol{\beta})\boldsymbol{\bar{R}}_k^{(t)}\boldsymbol{\hat{h}}_k(\boldsymbol{\beta})=\boldsymbol{\beta}^H\left(\boldsymbol{h}_k\odot\left(\boldsymbol{G}\boldsymbol{\bar{w}}_{k}^{(t)}\right)\right)\left(\boldsymbol{h}_k\odot\left(\boldsymbol{G}\boldsymbol{\bar{w}}_{k}^{(t)}\right)\right)^H\boldsymbol{\beta},~k=1,...,K.
\end{equation}
\hrulefill
\end{figure*}
Here, we denote $\boldsymbol{c}_3 = \boldsymbol{h}_k\odot\left(\boldsymbol{G}\boldsymbol{\bar{w}}_{k}^{(t)}\right)$ and $\boldsymbol{C}_3 = \boldsymbol{c}_3\boldsymbol{c}_3^H$. Then, the \ac{sinr} at the $k$-th communication user in (\ref{eq23}) is simplified to
\begin{equation}
\label{etac}
    \centering
    \eta_c(\boldsymbol{\beta};k) = \frac{\boldsymbol{\beta}^H\boldsymbol{C}_3\boldsymbol{\beta}}{\boldsymbol{\hat{h}}_k^H\boldsymbol{\bar{R}}^{(t)}\boldsymbol{\hat{h}}_k-\boldsymbol{\beta}^H\boldsymbol{C}_3\boldsymbol{\beta}+\sigma^2}, ~k=1,...,K.
\end{equation}

% Secondly, by substituting the expressions for the cascaded received matrix and reflected matrix into (\ref{eq18}), the \ac{sinr} of the \ac{rf} chain on the \ac{hris} is given by: 
% \begin{equation}
% \label{sinr_radar}
%     \begin{aligned}
%     \centering
%     \eta_{r}(\boldsymbol{\bar{W}}_{r,t},\boldsymbol{\bar{W}}_{c,t},\boldsymbol{\beta};p,q)=\frac{\boldsymbol{A}_r\boldsymbol{a}_t^H \boldsymbol{\bar{W}}_{r,t}\boldsymbol{\bar{W}}_{r,t}^H\boldsymbol{a}_t \boldsymbol{A}_r^H}{\boldsymbol{A}_r\boldsymbol{A}_h\boldsymbol{\bar{R}}_t\boldsymbol{A}_h^H\boldsymbol{A}_r^H+\sigma^2},
%     \end{aligned}
% \end{equation}

Compared to (\ref{P_c_sim}), we also transfer the expression of $\eta_r$ into a combination of quadratic forms. 	
We rewrite the cascaded reflected vector $\boldsymbol{\hat{a}}_h$ in the same way as we did in (\ref{cascaded channel_k}), and the decomposed expression of $\boldsymbol{\hat{a}}_h$ is 
\begin{equation}
\label{A_h}
    \centering
    \boldsymbol{\hat{a}}_h^H = \boldsymbol{a}_h^H \mathrm{diag}([\beta_1,...,\beta_N])\boldsymbol{G}.
\end{equation} 

Then, combining with (\ref{A_h}), the quadratic component $\boldsymbol{\hat{a}}_h^H(\boldsymbol{\beta})\boldsymbol{\bar{W}}^{(t)}\boldsymbol{\bar{W}}^{(t)H}\boldsymbol{\hat{a}}_h(\boldsymbol{\beta})$ of the interference power in (\ref{eq18_}) is rewritten by (\ref{A-hRA-h}).
\begin{figure*}[ht]
    \begin{equation}
\label{A-hRA-h}
    \centering
    \boldsymbol{\hat{a}}_h^H(\boldsymbol{\beta})\boldsymbol{\bar{W}}^{(t)}\boldsymbol{\bar{W}}^{(t)H}\boldsymbol{\hat{a}}_h(\boldsymbol{\beta})=\boldsymbol{\beta}^H\left(\boldsymbol{a}_h\odot\left(\boldsymbol{G\bar{W}}^{(t)}\right)\right)\left(\boldsymbol{a}_h\odot\left(\boldsymbol{G\bar{W}}^{(t)}\right)\right)^H\boldsymbol{\beta}.
\end{equation}
\hrulefill
\end{figure*}

Next, we use $\boldsymbol{c}_2$ to replace the $\boldsymbol{a}_h \odot\left(\boldsymbol{G}\boldsymbol{\bar{W}}^{(t)}\right)$, so that the interference power from \ac{hris} to the $(p, q)$ block is written as
\begin{equation}
\label{A_h_c2}
    \centering
    \mathbf{E}\left(|A_r(\boldsymbol{\beta})\boldsymbol{\hat{a}}_h^H(\boldsymbol{\beta})\boldsymbol{x}(n)|^2\right) = |A_r(\boldsymbol{\beta})|^2\boldsymbol{\beta}^H \boldsymbol{C}_2\boldsymbol{\beta},
\end{equation}
where $\boldsymbol{C}_2=\boldsymbol{c}_2{\boldsymbol c}_2^H$ is a Hermitian matrix. Similarly, we separate the \ac{hris}'s received vector $\boldsymbol{\phi}(\boldsymbol{\beta})$ into amplitude vector $1- \boldsymbol{\beta}$. Thus, the cascaded scalar $A_r$ can be rewritten as
\begin{equation}
\label{A-r}
    \centering
    A_r = (1-\boldsymbol{\beta}^H)\boldsymbol{a}_r.
\end{equation}

Now, we can recast the \ac{sinr} of the radar:
\begin{equation}
\label{eta}
    \centering
    \eta_r(\boldsymbol{\beta};p,q) = \frac{(1- \boldsymbol{\beta}^H)\boldsymbol{a}_r\boldsymbol{a}_t^H\boldsymbol{\bar{w}}_{r}^{(t)}\boldsymbol{\bar{w}}_{r}^{(t)H}\boldsymbol{a}_t\boldsymbol{a}_r^H(1- \boldsymbol{\beta})}{(1-\boldsymbol{\beta}^H)\boldsymbol{a}_r\boldsymbol{\beta}^H \boldsymbol{C}_2\boldsymbol{\beta}\boldsymbol{a}_r^H(1- \boldsymbol{\beta})+\sigma^2}.
\end{equation}

By substituting $\boldsymbol{C}_1$ for the $\left({\boldsymbol a}_t^H\boldsymbol{\bar{w}}_{r}^{(t)}\boldsymbol{\bar{w}}_{r}^{(t)H}\boldsymbol{a}_t\right)\boldsymbol{a}_r\boldsymbol{a}_r^H$,the $\eta_r$ is consequently reduced to:
\begin{equation}
\label{etar}
    \centering
    \eta_r(\boldsymbol{\beta};p,q) = \frac{(1- \boldsymbol{\beta}^H)\boldsymbol{C}_1(1- \boldsymbol{\beta})}{(1- \boldsymbol{\beta}^H)\boldsymbol{a}_r\boldsymbol{\beta}^H \boldsymbol{C}_2\boldsymbol{\beta}\boldsymbol{a}_r^H(1- \boldsymbol{\beta})+\sigma^2}.
\end{equation}
This concludes the proof.	


	
	
	
% 	\vspace{-0.2cm}
% 	\subsection{Proof of Theorem \ref{Theorem}}
% 	\label{app:Proof1}	
% We first prove that the constraints are sufficient and assume that there exists a beamforming matrix $\boldsymbol{W}$ such that
% \begin{equation}
% \label{pfW}
%     \begin{aligned}
%     \centering
%     \boldsymbol{\hat{R}}=\boldsymbol{W}\boldsymbol{W}^H = [\boldsymbol{W}_c\boldsymbol{W}_c^H+\boldsymbol{W}_r\boldsymbol{W}_r^H],
%     \end{aligned}
% \end{equation}

% It's clear that the beamforming matrix meets the requirement of the per-antenna power control, which implies the (\ref{st_power}). Moreover, the existing beamforming matrix satisfies the \ac{sinr} constraints of the radar and the communication:
% \begin{equation}
% \label{pfmur}
%     \begin{aligned}
%     \centering
%     \eta_r(\boldsymbol{\hat{R}},\boldsymbol{\hat{R}}_i;p,q)\ge\Gamma_r,
%     \end{aligned}
% \end{equation}
% \begin{equation}
% \label{pfmuc}
%     \begin{aligned}
%     \centering
%     \eta_c(\boldsymbol{\hat{R}},\boldsymbol{\hat{R}}_i; k)\ge \Gamma_c, k=,...,K,
%     \end{aligned}
% \end{equation}
% so the constraint (\ref{st_muc}) is satisfied. Next, by the definition of $\eta_r'(\boldsymbol{\hat{R}},\boldsymbol{\hat{R}}_i;p,q, \Gamma_r)$ and the condition (\ref{pfmur}), we have
% \begin{equation}
% \label{pfmur_}
%     \begin{aligned}
%     \centering
%     \eta_r'(\boldsymbol{\hat{R}},\boldsymbol{\hat{R}}_i;p,q, \Gamma_r)\ge \varsigma, \exists \varsigma\ge 0,
%     \end{aligned}
% \end{equation}
% it implies the constraint (\ref{st_mur}).

% For the $k$-th column of the matrix $\boldsymbol{W}$, we can calculate the sub-covariance matrices by
% \begin{equation}
% \label{pfrank}
%     \begin{aligned}
%     \centering
%     \boldsymbol{\hat{R}} _i= \boldsymbol{w}_i\boldsymbol{w}_i^H, i=1,...,K,K+1.
%     \end{aligned}
% \end{equation}

% Obviously, each $\boldsymbol{\hat{R}}_i$ and the whole covariance matrix $\boldsymbol{\hat{R}}$ are rank-one, so the final constraint (\ref{st_rank}) in problem (\ref{st4}) is satisfied. Thus, there exists a feasible solution to (\ref{st4}). This concludes the proof.

\end{appendix}	
\fi 
 
	%----------------------------------------------------------------------------------------
	%	BIBLIOGRAPHY
	%----------------------------------------------------------------------------------------
	\bibliographystyle{IEEEtran}
	\bibliography{IEEEabrv,mybib}
	
	
	
	
\end{document}
