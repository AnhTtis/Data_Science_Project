% \begin{algorithm}
%     \small
%     \caption{Propagation Transformer}
%     \hspace*{\algorithmicindent} \textbf{Input}: Extracted multi-view image features from recent time stamp $\mathbi F_{2d} =\{F_{2d}^1, F_{2d}^2, \cdots, F_{2d}^t\}$. A set of learnable reference points $Q_{p}^{init}$.  \\
%     \hspace*{\algorithmicindent} \textbf{Memory Queue}: Memory states of $N$ historical framse $\mathbi{X} = \{X^{t-1}, X^{t-2}, \cdots, X^{t-n}\}$. For each time stamp, we maintain the proposal states with top-K highest classification score, $X^{t-n} = \{\triangle t^{t-n}, Q_{c}^{t-n}, Q_{p}^{t-n}, v^{t-n}, E_{t-n}\}$.\\
%     % $\widehat{\mathbi{q}}_k^t \leftarrow \mathbi{0}$ if object $k$ does not appear in $I^t$. \\
%     \hspace*{\algorithmicindent} \textbf{Output}: 3D bounding boxes prediction with classification scores $\mathbi{b}_{all}^{t} = (x, y, z, l, w, h, \theta, v_x, v_y, cls)$.
%     \begin{algorithmic}[1]
%     \State $\mathbi{X} \leftarrow \O$
%     \For{$t \in \mathbi{T}$}
%         % hypothesis generation
%         % \State $z_1^t \leftarrow \textbf{Attn}$($I^t$)
%         \State $ {[\tilde{Q}_{p}^{t-n:t}, \tilde{E}_{t-n:t}^{t}]} \leftarrow \ EA([Q_{p}^{t-n:t}, E^{t-n:t}])$ 
%         \State $\tilde{Q}_{pe}^{t-n:t} \leftarrow Concat(\psi([Q_{p}^{init}, \tilde{Q}_{p}^{t-n:t}]))$
%         \State $\tilde{Q}_{c}^{t-n:t} \leftarrow Concat[Q_{c}^{init}, \tilde{Q}_{c}^{t-n:t}]$
%         \State $M \leftarrow [\tilde{E}_{t-n:t}^{t}, \triangle t^{t-n:t}, v^{t-n:t}]$
%         \State $\tilde{Q}_{pe}^{t-n:t} \leftarrow MLN(\tilde{Q}_{pe}^{t-n:t}, M)$
%         \State $\tilde{Q}_{c}^{t-n:t} \leftarrow MLN(\tilde{Q}_{c}^{t-n:t}, M)$
%         \For{$i \in L$}
%             \State $[\textbf{q}, \textbf{k}, \textbf{v}] \leftarrow [\tilde{Q}_{c}^{t-1:t}, \tilde{Q}_{c}^{t-n:t} + \tilde{Q}_{pe}^{t-n:t}, \tilde{Q}_{c}^{t-n:t}] $
%             \State $\textbf{q} \leftarrow MHA([\textbf{q}, \textbf{k}, \textbf{v}]) $
%             \State $\textbf{q} \leftarrow Spatial\_Attn([\textbf{q}, F_{2d}^t]) $
%         \EndFor
%         \State$\mathbi{b}_{all}^{t} \leftarrow FFN(\textbf{q})$
%         \State$ index \leftarrow TopK(\mathbi{b}_{all}^{t})$
%         \State $\mathbi{X}_{new} \leftarrow Gather(index)$ 
%         \State $\mathbi{X} \leftarrow \mathbi{X} + \mathbi{X}_{new}$
%     \EndFor
%     \end{algorithmic}
%     \label{alg:memot}
% \end{algorithm}

\begin{algorithm}
    \small
    \caption{Propagation Transformer}
    \hspace*{\algorithmicindent} 
    \textbf{Input}: Multi-view 2D features from streaming video $\mathbi F_{2d} =\{F_{2d}^1, F_{2d}^2, \cdots, F_{2d}^T\}$. A set of learnable reference points $Q_{p}^{init}$.  \\
    \hspace*{\algorithmicindent} \textbf{Memory Queue}: Memory queue of $N$ historical frames $\mathbi{X} = \{X^{t-N}, \cdots, X^{t-2}, X^{t-1}\}$. For each time stamp ${t-k}$, we maintain the query states with motion information, $X^{t-k} = \{\triangle t^{t-k}, Q_{c}^{t-k}, Q_{p}^{t-k}, v^{t-k}, E^{t-k}\}$.\\
    % $\widehat{\mathbi{q}}_k^t \leftarrow \mathbi{0}$ if object $k$ does not appear in $I^t$. \\
    \hspace*{\algorithmicindent} \textbf{Output}: 3D bounding boxes prediction with classification scores $\mathbi{b}^{t} = (x, y, z, l, w, h, \theta, v_x, v_y, cls)$.
    \begin{algorithmic}[1]
    \State $\mathbi{X} \leftarrow \O$
    \For{$t \in \mathbi{T}$}
    
        \!\!\!\!\! \textbf{(1) Motion compensation}
        \State $ {[\tilde{Q}_{p}^{t-N:t-1}, \tilde{E}_{t-N:t-1}^{t}]} \leftarrow Ego([Q_{p}^{t-N:t-1}, E^{t-N:t-1}])$ 
        \State $\tilde{Q}_{pe}^{t-N:t-1} \leftarrow \psi(\tilde{Q}_{p}^{t-N:t-1})$ 
        \State $M \leftarrow [\tilde{E}_{t-N:t-1}^{t}, \triangle t^{t-N:t-1}, v^{t-N:t-1}]$
        \State $\tilde{Q}_{pe}^{t-N:t-1} \leftarrow MLN(\tilde{Q}_{pe}^{t-N:t-1}, M)$
        \State $\tilde{Q}_{c}^{t-N:t-1} \leftarrow MLN(Q_{c}^{t-N:t-1}, M)$

        \!\!\!\!\! \textbf{(2) Propagate query}
        \State $Q_{pe}^{init} \leftarrow \psi(Q_{p}^{init})$ 
        \State $Q_{c}^{init} \leftarrow Zero\_Like(Q_{pe}^{init})$ 
        \State $Q_{pe}^{0}\;\;\leftarrow Concat([Q_{pe}^{init}, \tilde{Q}_{pe}^{t-1}])$
        \State $Q_{c}^{0}\;\:\enspace\leftarrow Concat[Q_{c}^{init}, \tilde{Q}_{c}^{t-1}]$

        \!\!\!\!\! \textbf{(3) Spatial-temporal interaction}
        \For{$i \in L$}
            \State $\tilde{Q}_{pe}^{hybrid} \leftarrow Concat([Q_{pe}^{i}, \tilde{Q}_{pe}^{t-N:t-1}])$
            \State $\tilde{Q}_{c}^{hybrid} \leftarrow Concat[Q_{c}^{i}, \tilde{Q}_{c}^{t-N:t-1}]$
            \State $Q_{c}^{i}\quad\leftarrow Hybrid\_Attn([Q_{c}^{i}, Q_{pe}, \tilde{Q}_{c}^{hybrid}, \tilde{Q}_{pe}^{hybrid}]) $
            \State $Q_{c}^{i+1} \leftarrow Cross\_Attn([Q_{c}^{i},Q_{pe}, F_{2d}^t, F_{3d\_pe}^t])$
            \State $Q_{pe}^{i+1} \leftarrow Q_{pe}^{i}$ 
        \EndFor

        \!\!\!\!\! \textbf{(4) Update memory queue}
        \State$\mathbi{b}^{t} \leftarrow Head(Q_{c}^{L})$
        \State$ index \leftarrow TopK(\mathbi{b}^{t})$
        \State ${X}^{t} \leftarrow Gather(index)$ 
        \State $\mathbi{X} \,\,\leftarrow \{X^{t-N+1}, \cdots, X^{t-1}, X^{t}\}$ 
    \EndFor
    \end{algorithmic}
    \label{alg:streampetr}
\end{algorithm}