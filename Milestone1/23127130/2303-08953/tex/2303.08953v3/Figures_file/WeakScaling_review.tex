\begin{figure}
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        xmode=log,
        width=\textwidth,
        height=.6\textwidth,
        bar width=.2cm,
        stack negative=separate,
        ybar stacked,
        ymin=-2,
        ymax=9,
        % xtick={1,2,4,8,16,32,64,128,256,512,1024,2048},
        %xticklabels={8M{\\}1N,16M{\\}2N,32M{\\}4N,64M{\\}8N,128M{\\}16N,256M{\\}32N,512M{\\}64N,1B{\\}128N,2B{\\}256N, 4B{\\}512N, 8B{\\}1024N, 16B{\\}2048N},
        xtick={1,4,16,64,256,1024,4096},
        xticklabels={8M{\\}1N,32M{\\}4N,128M{\\}16N,512M{\\}64N,2B{\\}256N,8B{\\}1024N,16B{\\}2048N},
        % xtick={2,8,32,128,512,2048},
        % xticklabels={16M{\\} 2N, 64M{\\}8N, 256M{\\}32N, 1B{\\}128N, 4B{\\}512N, 16B{\\}2048N},
        xticklabel style={align=center,text width=10mm},
        xlabel={Matrix dimension (1M=$10^6$, 1B=$10^9$), number of nodes (1N = 56 cores)},
        x label style={at={(axis description cs:0.5,-0.15)},anchor=north},
        ylabel={time (s)},
        ymajorgrids=true,  
        yminorgrids=true,   
        minor y tick num=1,
        legend pos=outer north east,
        legend columns=4,
        legend style={at={(0.5,1.35)}, anchor=north},
        % ytick={-0.2, 0, 0.2, 0.4, 0.6, 0.8, 1.0},
        % yticklabels={0.2, 0, 0.2, 0.4, 0.6, 0.8, 1.0},
    ]
    \addplot +[draw=black,
    color=blue2_2,
    fill opacity=0.8,
    bar shift=-.36cm] table [x=Node,y=SpMV_MGS] {Review/weak_L8.dat};
    \addlegendimage{draw=none,fill=blue3_2,opacity=0.8}; 
    \addlegendimage{draw=none,fill=blue4_2,opacity=0.8}; 
    \addlegendimage{draw=none,fill=blue5_2,opacity=0.8}; 
    \addplot +[draw=black,
    color=green2_2,
    fill opacity=0.8,
    bar shift=-.36cm] table [x=Node,y=Ortho_MGS] {Review/weak_L8.dat};
    \addlegendimage{draw=none,fill=green3_2,opacity=0.8}; 
    \addlegendimage{draw=none,fill=green4_2,opacity=0.8};
    \addlegendimage{draw=none,fill=green5_2,opacity=0.8};
    \addplot +[draw=black,
    color=black,
    fill opacity=0.8,
    bar shift=-.36cm] table [x=Node,y=Comm_MGS] {Review/weak_L8.dat};
    \addlegendimage{draw=none,fill=black,opacity=0.8}; 
    \addlegendimage{draw=none,fill=black,opacity=0.8};
    \addlegendimage{draw=none,fill=black,opacity=0.8};
    \addplot +[draw=black,
    color=hcred,
    fill opacity=0.8,
    bar shift=-.36cm] table [x=Node,y=Other_MGS] {Review/weak_L8.dat};
    % \addlegendimage{draw=none,fill=red2_1,opacity=0.8}; 
    \addlegendimage{draw=none,fill=red3_1,opacity=0.8};
    \addlegendimage{draw=none,fill=red4_1,opacity=0.8};
    \addlegendimage{draw=none,fill=red5_1,opacity=0.8};
    \legend{SpMV (MGS), SpMV (CGS2), MPK (TSQR), MPK (Adapt.), Comp. (MGS), Comp. (CGS2), Comp. (TSQR), Comp. (Adapt.), Comm. (MGS), Comm. (CGS2), Comm. (TSQR), Comm. (Adapt.), Other (MGS), Other (CGS2), Other (TSQR), Other (Adapt.)};
    \end{axis}
    \begin{axis}[
        xmode=log,
        width=\textwidth,
        height=.6\textwidth,
        bar width=.2cm,
        stack negative=separate,
        ybar stacked,
        ymin=-2,
        ymax=9,
        hide axis,
    ]
    \addplot +[draw=black,
    color=blue3_2,
    fill opacity=0.8,
    bar shift=-.12cm] table [x=Node,y=SpMV_CGS2] {Review/weak_L8.dat};
    \addplot +[draw=black,
    color=green3_2,
    fill opacity=0.8,
    bar shift=-.12cm] table [x=Node,y=Ortho_CGS2] {Review/weak_L8.dat};
    \addplot +[draw=black,
    color=black,
    fill opacity=0.8,
    bar shift=-.12cm] table [x=Node,y=Comm_CGS2] {Review/weak_L8.dat};
    \addplot +[draw=black,
    color=hcred,
    fill opacity=0.8,
    bar shift=-.12cm] table [x=Node,y=Other_CGS2] {Review/weak_L8.dat};
    \end{axis}
    \begin{axis}[
        xmode=log,
        width=\textwidth,
        height=.6\textwidth,
        bar width=.2cm,
        stack negative=separate,
        ybar stacked,
        ymin=-2,
        ymax=9,
        hide axis,
    ]
    \addplot +[draw=black,
    color=blue4_2,
    fill opacity=0.8,
    bar shift=.12cm] table [x=Node,y=SpMV_TSQR] {Review/weak_L8.dat};
    \addplot +[draw=black,
    color=green4_2,
    fill opacity=0.7,
    bar shift=.12cm] table [x=Node,y=Ortho_TSQR] {Review/weak_L8.dat};
    \addplot +[draw=black,
    color=black,
    fill opacity=0.8,
    bar shift=.12cm] table [x=Node,y=Comm_TSQR] {Review/weak_L8.dat};
    \addplot +[draw=black,
    color=hcred,
    fill opacity=0.8,
    bar shift=.12cm] table [x=Node,y=Other_TSQR] {Review/weak_L8.dat};
    \end{axis}
        \begin{axis}[
        xmode=log,
        width=\textwidth,
        height=.6\textwidth,
        bar width=.2cm,
        stack negative=separate,
        ybar stacked,
        ymin=-2,
        ymax=9,
        hide axis,
    ]
    \addplot +[draw=black,
    color=blue5_2,
    fill opacity=0.8,
    bar shift=.36cm] table [x=Node,y=SpMV_CholQR] {Review/weak_L8.dat};
    \addplot +[draw=black,
    color=green5_2,
    fill opacity=0.6,
    bar shift=.36cm] table [x=Node,y=Ortho_CholQR] {Review/weak_L8.dat};
    \addplot +[draw=black,
    color=black,
    fill opacity=0.8,
    bar shift=.36cm] table [x=Node,y=Comm_CholQR] {Review/weak_L8.dat};
    \addplot +[draw=black,
    color=hcred,
    fill opacity=0.8,
    bar shift=.36cm] table [x=Node,y=Other_CholQR] {Review/weak_L8.dat};
    \end{axis}
    \end{tikzpicture}
    \caption{Timing breakdown for weak scaling test of 3D Laplace matrix. Every four columns from left to right are: MGS-GMRES (MGS), CGS2-GMRES (CGS2), BCGS2-TSQR-GMRES (TSQR), adaptive s-step GMRES (Adapt.). The timing of SpMV/MPK is inverted and plotted below the x-axis in the bar plot to visually showcase the scalability of different operations without stacking all of them. The orthogonalization steps include both computational costs (Comp.) and communication costs (Comm.). Other miscellaneous operations such as updating the upper Hessenberg matrix and checking for convergence are included as well though their timings are almost negligible.}
    \label{fig:weakscaling}
\end{figure}