%\documentclass[letter]{amsart}
%\input{defs.tex}
%\author{Olivier Bernardi$^{*}$ \and \'{E}ric Fusy$^{\dagger}$ \and Shizhe Liang$^{+}$}
%\title[Grand Schnyder Woods]{Grand Schnyder Woods}
%\begin{document} 
%\section{Quasi Schnyder structures}



In this section, we give an extension of grand-Schnyder structures to so-called quasi $d$-adapted maps. For $d\geq 3$, a $d$-map $G$ is called \emph{quasi $d$-adapted} if every non-facial cycle has length at least $d-1$, and those enclosing at least one vertex have length at least $d$. In other words, the only non-facial cycles of length smaller than $d$ have length $d-1$ and have no vertex in their interior. Note that if a quasi $d$-adapted $d$-map $G$ has no inner face of degree less than $3$, then the cycles of length $d-1$ have at most one edge (and no vertex) in their interior. To avoid overly complicated formulations, we will only give the incarnations as angular orientations and as corner labelings, and will work with $d$-maps having only inner faces of degree at least $3$. 



% The incarnation as woods will only be given for the (particularly nice) case $d=5$ with triangulated inner faces, which will be detailed in Section~\ref{sec:5c_triang}. 


\subsection{Quasi-Schnyder angular orientations}\label{subsec:WGS-angular}

Let $d\geq 3$, and let $G$ be a $d$-map. 
For an inner edge $e$ of $G$, we let $\delta(e):=\mathrm{deg}(f)+\mathrm{deg}(f')-d-2$, where $f,f'$ are the faces incident to $e$.  
Note that if $G$ is $d$-adapted (resp. quasi $d$-adapted), then for each inner edge $e$ of $G$, we have $\delta(e)\geq 0$ (resp. $\delta(e)\geq -1$). 
%Let $G$ be a $d$-map such that any inner edge $e$ of $G$ satisfies $\delta(e)\geq -1$. 
An inner edge $e$ of $G$ is called \emph{special} if $\delta(e)=-1$. 
We let $\Gcr$ be the map obtained from $G^+$ by placing a vertex $v_e$, called an \emph{edge-vertex}, in the middle of every special edge; and adding one edge between $v_e$ and a star vertex $v_f$ on each side of $e$ (where $f$ is the face of $G$ incident to $e$ on that side of $e$), so that every edge-vertex has degree $4$ in $\Gcr$.
%in addition for each side of $e$ incident to an inner face $f$ of $G$, we add an edge (on that side of $e$) from $v_e$ to the star vertex in $f$ (thus $v_e$ has degree $4$). 
The edges of $\Gcr$ incident to edge-vertices are called \emph{extra edges}. The map $\Gcr$ is represented in Figure~\ref{fig:5_quasi_other}.


 

%\fig{width=\linewidth}{angular-map}{(a) A 5-map $G$. (b) The angular map $G^+$. (c) The corner graph of $C_G$.}

%\end{document}

\begin{definition}\label{def:quasiAngular}
Let $d\geq 3$, and let $G$ be a $d$-map. 
A \emph{quasi-Schnyder angular orientation}, or \emph{$d$-QS angular orientation}, of $G$ is a weighted orientation of $\Gcr$ satisfying the following conditions (shown in the top-part of Figure~\ref{fig:def-incarnations-QS}).
\begin{itemize}
\item[(A0')] The weight of every outer arc is 0. Any inner arc $a$ of $\Gcr$ whose initial vertex is an outer vertex $v_i$ has weight $0$, unless $a$ is the arc (on a star-edge) following the outer edge $(v_i,v_{i-1})$ around~$v_i$ (for this arc there is no condition), or $a$ is on an extra edge and has 
the inner face of $G$ incident to $(v_i,v_{i-1})$ on its right.
\item[(A1')] The outgoing weight of a star vertex $v_f$ is $d-\deg(f)$. For every star edge $e$ incident to $v_f$ and an original vertex $v$ the weight of $e$ is $\si(\eps)=d-\mathrm{deg}(f)-s$, where $s\in\{0,1,2\}$ is the number of special edges among the edges $e',e''$ preceding and following $e$ around~$v$.
%that delimit $c$. 
%, with $c$ the corresponding inner corner of $G$, the weight of $e$ is given by $\si(\eps)=d-\mathrm{deg}(f)-s$, with $s\in\{0,1,2\}$ the number of special edges that delimit $c$. \OB{I changed the notation from $\om(\eps)$ to $\si(\eps)$}
\item[(A2')] The outgoing weight of every inner original vertex is $d$. The weight of every original non-special inner edge $e$ is $\delta(e)$. 
%$\delta(e)=\deg(f)+\deg(f')-d-2$, where $f,f'$ are the faces of $G$ incident to~$e$. 
\item[(A3')] The outgoing weight of every edge-vertex is $1$. The weight of every extra edge is $1$. 
\end{itemize}
\end{definition}

A 5-QS angular orientation is shown in Figure~\ref{fig:5_quasi_other} (bottom-left part).

\fig{width=\linewidth}{def-incarnations-QS}{Definition of quasi-Schnyder structures.}

\begin{remark}
Note that if $G$ has no special edge, the definition of $d$-QS angular orientation exactly matches Definition~\ref{def:angular} of $d$-GS angular orientations.
\end{remark}

    
We now prove some rigidity properties in the vicinity of the outer face, similar to those in Remark~\ref{rk:frozen}.

\begin{lemma}\label{lem:rigid_qs}
Let $G$ be a $d$-map endowed with a $d$-QS angular orientation $\cA$. For $i\in[d]$ let $f_i$ be the inner face of $G$ incident to the outer edge $(v_{i-1},v_i)$, and 
let $s_i$ be the star vertex in $f_i$. Then the arc from $s_i$ to $v_i$ has weight $0$. Moreover, if there is a special inner edge $e$ incident to $v_i$ and $f_i$, 
  then the unique arc of weight 1 starting at $v_e$ ends at a star vertex of $G$. Furthermore, if $G$ has an outer vertex incident to at least two inner edges in $G$, then the arc of weight 1 starting at $v_e$ ends at $s_i$.
\end{lemma}
\begin{proof}
We define a faulty edge of $G$ as a special edge $e$ incident to an outer vertex $v_i$, such that in $\cA$ the outgoing edge of $v_e$ is the next edge after $(v_e,v_i)$ 
in clockwise order around $v_e$, as represented in Figure~\ref{fig:rigid}(a). 

We first prove that the lemma holds if there is no faulty edge. Consider any portion $v_{i'},\ldots,v_i$ of consecutive outer vertices that are incident to $f_i$, such that $v_{i'}$ 
and $v_i$ are incident to at least one inner edge in $G$, and let $e$ (resp. $e'$) be the inner edge of $G$ incident to $v_i$ (resp. $v_{i'}$) and $f_i$.  
If $e'$ is non-special, then by Conditions (A0') and (A1') the arc from $s_i$ to $v_{i'}$ has weight $d-\deg(f_i)$. Since $s_i$ has outgoing weight $d-\deg(f_i)$ by Condition~(A1'), all the other arcs from $s_i$ have weight $0$, in particular the arcs from $s_i$ to all vertices in $v_{i'+1},\ldots,v_i$ have weight $0$. Moreover, if $e$ is special then the arc from $s_i$ to $v_e$ has weight $0$, hence the unique
outgoing edge of $v_e$ is the edge ending at $s_i$, and thus the arc from $v_e$ to $v_i$ has weight $0$.
If $e'$ is special, then by Conditions (A0') and (A1') the arc from $s_i$ to $v_{i'}$ has weight $d-\deg(f_i)-1$, and moreover the arc from $s_i$ to $v_{e'}$ has weight $1$,
since $e'$ is not faulty. Hence the whole outgoing weight of $s_i$ is taken by these two arcs, so that all other arcs from $s_i$ have weight $0$. In particular the arcs from $s_i$ to all   vertices in $v_{i'+1},\ldots,v_i$ have weight $0$, and if $e$ is special then the arc from $s_i$ to $v_e$ has weight $0$, so that the unique outgoing edge of $v_e$ leads to $s_i$, and thus
the arc from $v_e$ to $v_i$ has weight $0$.


Assume now that there is a faulty edge $e$, with $v_i$ the outer vertex adjacent to $v_e$.   
Since $v_e$ has outdegree~$1$, the edge $(v_i,v_e)$ is directed toward $v_e$. Hence, by Condition (A0'), $e$ is incident to $f_i$ in $G$.
Let $s_i$ be the star vertex in $f_i$, let $v_{i'}$ be the next outer vertex after $v_i$ in counterclockwise order around the
outer face contour that is incident to $f_i$ and to an inner edge, and let 
$e'$ be the inner edge of $G$ incident to $v_{i'}$ and to $f_i$. 
Conditions (A0') and (A1') imply that the arc from 
$s_i$ to $v_{i'}$ has weight $d-\deg(f_i)-\delta_{e'\ \mathrm{special}}$, and Condition (A3') implies that the arc from $s_i$ to $v_e$ has weight $1$ (as $v_e$ has its outgoing edge on the other side of $e$), as represented in Figure~\ref{fig:rigid}(b). Since $s_i$
has outgoing weight $d-\deg(f_i)$, we conclude that $e'$ has to be special, and that the arc from $v_{e'}$ to $s_i$ has weight $1$. Hence $e'$ is also faulty. 
Condition~(A3') implies that the edge $(v_{i'},v_{e'})$ is directed toward $v_{e'}$, and then Condition~(A0') implies that $e'$ 
has to be the unique inner edge of $G$ incident to $v_{i'}$. Continuing iteratively in counterclockwise order around the outer face contour, until reaching $v_i$ again, 
we conclude that if there exists a faulty edge, then every outer vertex is either incident to no inner edge of $G$, or to a unique inner edge of $G$ that is faulty. 
In this situation it is then easy to check that the lemma holds (by a similar argument as the one used when there is no faulty edge); note that the very last point (which fails) does
not need to be checked since all outer vertices are incident to $0$ or $1$ inner edge in $G$.
\end{proof}


\fig{width=0.84\linewidth}{rigid}{(a) A faulty edge $e$, as defined in the proof of Lemma~\ref{lem:rigid_qs}.  (b) The situation when there exists a faulty edge $e$.}



%% \begin{remark}\label{rk:frozen_bis}
%% As in Remark~\ref{rk:frozen}, the arc $a$ following the outer edge $(v_i,v_{i-1})$ around~$v_i$, and also the next arc $a'$ if it belongs to an extra edge, have their weights fixed from the other conditions: their weight is equal to the weight of the edge they belong to (i.e., the opposite arc has weight $0$).  \OB{I think the preceding is not clear anymore (without the extra rigidity condition). Unless I am simple argument, I think the proof is almost exactly the same as for Lemma \ref{lem:rigid}, except that we always reach a contradiction at the end (even when all the outer vertices are incident to $\leq 1$ inner edges).}
%% Moreover, if $a'$ is on an extra edge, then the unique outgoing edge of the incident extra vertex  ends at a star vertex.
%% %is the one leading to the star vertex in the inner face of $G$ incident to $(v_{i-1},v_i)$.
%% \OB{I think the preceding sentence is false (as also noted by Shizhe) -- probably a remain of a previous version.}\EF{I have corrected it. However what is stated in the remark does not seem obvious (compared to similar remark for adapted case}
%% \end{remark}

%% We prove now that, under a mild assumption on outer vertices, another rigidity property follows from Conditions (A0'-A3') of $d$-QS angular orientations. 


%% \begin{lemma}\label{lem:rigid}
%% For $d\geq 3$, let $G$ be a $d$-map endowed with a $d$-QS angular orientation. If $G$ has an outer vertex with at least two incident inner edges, then we have the further property that any arc starting from an edge-vertex $v_e$ has weight $0$ if the next arc in counterclockwise order around $v_e$ ends at an outer vertex. This is represented in Figure~\ref{fig:rigid}(a).
%% \end{lemma}

%% \fig{width=0.84\linewidth}{rigid}{(a) A faulty edge $e$, as defined in the proof of Lemma~\ref{lem:rigid_qs}. (b) The situation when there exists a faulty edge $e$.}
%% %\fig{width=0.84\linewidth}{rigid}{(a) The rigidity property stated in Lemma~\ref{lem:rigid}. (b) The situation in the proof of Lemma~\ref{lem:rigid}.}

%% \OB{There are a few things to fix in the proof below. (I'll do it later)} \EF{I agree with the issues, I have tried to correct the proof.}\OB{Thanks! It is very clear now.}
%% \begin{proof}
%% Assume the property does not hold, for some edge-vertex $v_e$. Let $v_j$ be the outer vertex adjacent to $v_e$, \ef{and let $f_j$ be the inner face of $G$ incident to $(v_{j-1},v_j)$.} 
%% Since $v_e$ has outdegree~$1$, the edge $(v_j,v_e)$ is directed toward \ef{$v_e$}. Hence, by Condition (A0'), $e$ is incident to $f_j$ in $G$.
%% %and Condition~(A0') ensures that $(v_j,v_e)$ is the unique inner edge incident to $v_j$,
%% %\OB{I think this is incorrect}\EF{Yes, this should be changed to "$e$ is the unique inner edge of $G$ incident to $v_j$"}\OB{I don't understand the answer: I mean that there could be many original edges incident to $v_j$ a priory. The local condition at $v_j$ does not prevent it (unless I missed something).} see Figure~\ref{fig:rigid}(b). We call $v_j$ a \emph{faulty outer vertex}. Letting $v_i$ be some outer vertex with at least two 
%% %incident inner edges (so $v_i\neq v_j$), we can assume that $v_e$ is chosen so that there is no faulty outer vertex between $v_i$ and $v_j$ in clockwise order around the outer contour. 
%% Let $s_j$ be the star vertex in $f_j$, let $v_{j'}$ be the next outer vertex after $v_j$ in counterclockwise order around the
%% outer face contour that is incident to $f_j$ and to an inner edge, and let 
%% $e'$ be the inner edge of $G$ incident to $v_{j'}$ and to $f_j$. 
%% %\OB{There are more edges incident to $f_j$.}\EF{More outer edges, but a unique other inner edge (?)} \OB{No there are many inner edges incident to $f_j$ -- I am guessing you want to talk about those with an outer endpoint?} \EF{Yes, I have tried to correct.} 
%% Conditions (A0') and (A1') imply that the arc from 
%% $s_j$ to $v_{j'}$ has weight $d-\deg(f_j)-\delta_{e'\ \mathrm{special}}$, and Condition (A3') implies that the arc from $s_j$ to $v_e$ has weight $1$ (as $v_e$ has its outgoing edge on the other side of $e$), as represented in Figure~\ref{fig:rigid}(b). Since $s_j$
%% has outgoing weight $d-\deg(f_j)$, we conclude that $e'$ has to be special, and that the arc from $v_{e'}$ to $s_j$ has weight $1$. Hence the property 
%% does not hold for $v_{e'}$ either. Condition~(A3') implies that the edge $(v_{j'},v_{e'})$ is directed toward $v_{e'}$, and then Condition~(A0') implies that $e'$ 
%% has to be the unique inner edge of $G$ incident to $v_{j'}$. Continuing iteratively in counterclockwise order around the outer face contour, until reaching $v_j$ again, we get the contradiction that every outer vertex is incident to $0$ or $1$ inner edge of $G$.
%% %Hence the outer vertex $v_{j'}$ adjacent to $v_{e'}$ is faulty, and moreover it has to be between $v_i$ and $v_j$ in clockwise order around the outer contour, which gives a contradiction. 
%% \end{proof}






%The definition of $d$-grand-Schnyder angular orientations, or \emph{$d$-GS angular orientations} for short, is illustrated in the bottom row of Figure~\ref{fig:def-incarnations}. 

%\begin{remark}\label{rk:frozen}
%In the representation of Condition (A0) the weight of one of the star edges out of $v_i$ is indicated as $x$. Although this weight is not explicitly specified by Condition (A0), this weight is actually $d-\deg(f)$ where $f$ is the face of $G$ containing this star edge. Indeed, this is implied by combining Condition (A1) at $v_f$ with Condition (A0) for the other outer vertices incident to $f$.
%\end{remark}
%in Figure~\ref{fig:def-angular}.
%\fig{width=\linewidth}{def-angular}{Conditions (A0), (A1) and (A2) defining $d$-GS angular orientations. The weights of the orientation are indicated by arrowheads.}


\subsection{Quasi-Schnyder labelings}\label{subsec:WGS-labeling}
For $G$ a $d$-map, the \emph{derived map} $G'$ is the map obtained from $G^+$ by placing a vertex $v_e$, called an \emph{edge-vertex}, in the middle of every original edge $e$, and for each side of $e$ 
incident to an inner face $f$ of $G$, we add an edge (on that side of $e$) from $v_e$ to the star vertex $v_f$ (compared to $\Gcr$, we place an edge-vertex on every edge of $G$, not just on special edges). 
%The edges of $G'$ incident to edge-vertices are called \emph{extra edges}. 
The derived map $G'$ is represented in Figure~\ref{fig:5_quasi_other}.



\begin{definition}\label{def:WGS-labeling}
Let $d\geq 3$, and let $G$ be a $d$-map with no inner face of degree less than~$3$. 
%As usual, we assume that the outer vertices of $G$ are denoted by $v_1,\ldots,v_d$ in clockwise order around the outer face.
A \emph{quasi-Schnyder labeling}, or \emph{$d$-QS labeling}, of $G$ is an assignment to each inner face of $G'$ of a label in $[d]$ satisfying the following conditions (shown in the bottom-part of Figure~\ref{fig:def-incarnations-QS}).
\begin{itemize}
\item[(L0')] For $i\in [d]$, all the inner faces of $G'$ incident to $v_i$ have label $i$, except possibly for the last one (incident to $(v_{i-1},v_i)$),
and for the next to last one if that face is incident to (the extra edge on) a special edge of $G$.
\item[(L1')] For every inner vertex $v$ of $G$, the sum of clockwise label jumps around $v$ is $d$. The clockwise label jump across any star edge $\eps$ incident to $v$ is at most $\si(\eps)$, with $\si(\eps)$ given in (A1') of Definition~\ref{def:quasiAngular}; and the clockwise label jump across an edge $(v,v_e)$ (with $v_e$ an edge-vertex) is in $\{0,1\}$ if $e$ is special (there is no constraint if $e$ is not special).
\item[(L2')] For an edge $\eps$ between a star vertex $v_f$ and an edge-vertex $v_e$, the clockwise jump at $v_f$ across $\eps$ 
is $d-\mathrm{deg}(f)+1$ if $e$ is non-special, and is in $\{d-\mathrm{deg}(f)-1,d-\mathrm{deg}(f)\}$ if $e$ is special. 
% For $\eps$ an edge edge between an original vertex $v$ and an edge-vertex $v_e$, the clockwise jump at $v$ accross $\eps$ is in $\{0,1\}$. 
\item[(L3')] For each star vertex $v_f$, let $\Sigmacw$ be the sum of clockwise jumps across edges from $v_f$ to edge-vertices, and let $\Sigmaccw$ be the sum of 
counterclockwise jumps across edges from $v_f$ to original vertices. Then $\Sigmacw-\Sigmaccw=d$. 
\end{itemize}
\end{definition}
%The definition of $d$-grand-Schnyder corner labelings, or \emph{$d$-GS labelings} for short, is represented in the top row of Figure~\ref{fig:def-incarnations}.

%% \OB{Ok, I have had some trouble with everything related to quasi labeling. I think it stems from the fact that a property is never stated: \\
%% \begin{itemize}
%% \item[(L4')] Let $a=(v_f,v_e)$ and let $a'=(v_f,v)$ be the next in cw order around $v_f$. Let $x$ be the label jump from the left of $a$ to the right of $a$ and let $y$ be the label jump from the right of $a'$ to the left of $a'$. Then $y\geq x$. 
%% \end{itemize}
%% Is that a consequence of (L0'-L3')? Or is it a missing condition
%% }

A $5$-QS labeling is shown in Figure~\ref{fig:5_quasi_other} (bottom-right part).

\fig{width=.9\linewidth}{5_quasi_other}{Top: a quasi $5$-adapted map $G$ (special edges are shown in green). Bottom: on the left a $5$-QS angular orientation on $G^{\times}$; on the right the corresponding $5$-QS labeling (labeling of the inner faces of~$G'$).}

\begin{remark}\label{rk:ccw-quasi}
Similarly as for Lemma~\ref{lem:ccw-jumps-edges}, one can prove (using the Euler relation) that in a $d$-QS labeling, the sum of the 4 label jumps in counterclockwise order around any inner edge-vertex is equal to $d$. 
 \end{remark}
 
In order to explain the relation between $d$-QS labeling and $d$-GS labeling we introduce a bit of vocabulary.
We call \emph{right triangle} (resp. \emph{left triangle}) an inner face of $G'$ on the right (resp. left) of an arc of $G'$ from a star vertex to an original vertex. Note that every inner edge of $G'$ separates a right triangle and a left triangle.

\begin{remark}\label{rk:jumps-differences}
Let $G$ be a $d$-map.
Let $t_1,t_2,t_3$ be three consecutive faces of $G'$ in clockwise order around a star vertex $v_f$, with $t_1$ a right triangle (so that $t_2$ is a left triangle and $t_3$ is a right triangle). Let $i_1,i_2,i_3$ be the labels of $t_1,t_2,t_3$ respectively in a $d$-QS of $G$; see Figure~\ref{fig:labeling_wtos}(a). Then, by (L1') and (L2') the label jumps satisfy:
$$\jp(i_1,i_2)\geq \jp(i_3,i_2),$$
and this inequality is strict if $e$ is not special.
In particular, in the notation of Definition~\ref{def:WGS-labeling}, the difference $\Sigmacw-\Sigmaccw$ in Condition (L3') is the sum of the (non-negative) label jumps between right triangles in clockwise order around $v_f$.
\end{remark}


 \fig{width=\linewidth}{labeling_wtos}{(a) Situation described in Remark \ref{rk:jumps-differences} (the inequality $\jp(i_1,i_2)\geq \jp(i_3,i_2)$ always holds). (b) Turning a $d$-GS labeling into a $d$-QS labeling.}



\begin{remark} 
Let $G$ be a $d$-adapted map. A $d$-GS corner labeling $\cL$ can be turned into a $d$-QS labeling $\cL'$ as follows (see Figure~\ref{fig:labeling_wtos}(b)). 
%For every $a$ of $G'$ from an edge-vertex $v_e$ to a star vertex $v_f$, the right triangle on the right of $a$ get 
Every inner corner $c$ of $G$ correspond to star edge $\eps_c$ of $G'$, which is incident to a right triangle $t_c$; and we set the label of $t_c$ in $\cL'$ to be the label of $c$ in $\cL$. The label of the left triangles in $\cL'$ are then determined by Condition (L2'): for every extra edge $a=(v_e,v_f)$ incident to a star vertex $v_f$ the label of the left triangle incident to $e$ is equal to the label of the right triangle incident to $e$ plus $d-\deg(f)+1$.
%Every inner corner $c=(v,f)$ of $G$ (with $v$ the incident vertex and $f$ the incident face) corresponds to a star edge $\eps=(v_f,v)$, which itself yields two inner faces of $G'$. The face on the right of $\eps$ receives the label of $c$, and the face on the left of $\eps$ receives label $i+d-\mathrm{deg}(f)+1$, where $i$ is the label of the corner preceding $c$ around $f$, see Figure~\ref{fig:labeling_wtos}. 
One can easily check that, the constraints of Definition~\ref{def:GS-labeling} for $d$-GS labelings imply that $\cL'$ satisfy the constraints of Definition~\ref{def:WGS-labeling} for $d$-QS labelings. (For instance, Condition (L3) for $\cL$ implies that the sum of label jump around an original vertex $v$ are the same in $\cL'$ as in $\cL$ (hence equal to $d$); while Conditions (L1-L2) imply that the label jumps in $\cL$ from a corner to the next around a face $f$ are at most $d-\deg(f)-1$, ensuring that the label jumps across a star edge $\eps$ in $\cL'$ is at most $\si(\eps)$.)

Conversely if $\cL$ is a corner labeling of $G$ such that $\cL'$ is a $d$-QS labeling, then it is easy to check that $\cL$ is a $d$-GS labeling of $G$. (For instance, by Remark~\ref{rk:jumps-differences}, Condition (L3') for $\cL'$ implies that the sum of clockwise label jumps in $\cL$ around any inner face of $G$ is $d$, and Remark~\ref{rk:jumps-differences} also readily imply Condition (L2) and (L3) for $\cL$.) In conclusion, when $G$ is $d$-adapted, the above is a bijection between the $d$-GS labelings of $G$ and the $d$-QS labelings of $G$.
 \end{remark}

%\fig{width=\linewidth}{weak-label-from}{(a) A 5-map $G$. (b) The angular map $G^+$. (c) The corner graph of $C_G$.}


%\subsection{Bijection between weak $d$-GS angular orientations and $d$-GS labelings}

\subsection{Main result on quasi-Schnyder structures}

We state here the existence condition for $d$-QS structures, which extends Theorem~\ref{thm:main} (for the two relevant incarnations, and assuming no face has degree smaller than $3$).  


\begin{thm}\label{thm:main-quasi}
Let $d\geq 3$ and let $G$ be a $d$-map with all inner faces of degree at least $3$. There exists a $d$-QS angular orientation (resp. labeling) for $G$ if and only if $G$ is quasi $d$-adapted.

Moreover for any fixed $d$, there is an algorithm which takes as input a quasi $d$-adapted map, and computes a $d$-QS angular orientation (resp. labeling) 
in linear time in the number of vertices.

Lastly, the set $\bA_G'$ of $d$-GS angular orientations of $G$ and the set $\bL_G'$ of $d$-QS labelings of $G$ are in bijection.
\end{thm}

%\fig{width=\linewidth}{def-incarnations}{Conditions defining the $d$-grand-Schnyder structures.}


We will prove the necessity of being quasi $d$-adapted in Section~\ref{sec:proof-necessity-quasi}, and then the existence result in Section~\ref{sec:proof-existence-quasi}, 
and will also describe there the algorithm for computing a $d$-QS structure.\\

We now describe the bijection between $\bL_G'$ and $\bA_G'$. Let $d\geq 3$, and let $G$ be a $d$-map, with all inner faces of degree at least $3$, endowed with a $d$-QS labeling $\cL'$. 
We produce a weighted orientation $\cA'=\Phi'(\cL')$ of $\Gcr$ as follows. 
\begin{itemize}
\item
For each arc $a$ of $\Gcr$ whose initial vertex is an original vertex $v$ of $G$, the weight assigned to $a$ is the label-jump from the face of $G'$ on the left of $a$ to the face on the right of $a$ around $v$. If $a$ is on a star edge $\eps$, then the weight of the opposite arc $-a$ is assigned so that the sum of the two weights is $\si(\eps)$, with $\si(\eps)$ given in Definition~\ref{def:quasiAngular}.  If $a$ is on an extra edge, then the weight of the opposite arc $-a$ is assigned so that the sum of the two weights is 1.
\item For each arc $a$ of $\Gcr$ on an extra inner edge from a star vertex $v_f$ to an edge-vertex $v_e$, the weight of $a$ is 1 (resp. 0) if the label-jump from the face on the left to the face on the right of $a$ is $d-\mathrm{deg}(f)$ (resp. is $d-\mathrm{deg}(f)-1$). The weight of the opposite arc $-a$ is assigned so that the sum of the two weights is 1.
%% \item For each arc $a$ of $\Gcr$ from an original vertex to a star vertex, the weight assigned to $a$ is the label-jump from the face on the left of $a$ to the face on the right of $a$; 
%% the weight of the opposite arc $-a$ on the 
%% same star edge $\eps$ is then assigned so that the sum of the two weights is $\si(\eps)$, with $\si(\eps)$ given in Definition~\ref{def:quasiAngular}. 
%% \item 
%% For each arc $a=(u,v)$ of $\Gcr$ on a non-special original inner edge, letting $e$ be the edge of $G'$ corresponding to the half of $a$ incident to $u$, 
%% the weight assigned to $a$ is the label-jump from the face on the left of $e$ (looking from $u$) to the face on the right of $e$. 
%% \item
%% For each arc $a$ of $\Gcr$ on an extra inner edge, with $a$ from an original vertex to an edge-vertex, 
%% the weight assigned to $a$ is the label-jump from the face on the left of $a$ to the face on the right of $a$; the weight on the opposite arc $-a$ is assigned so that $\om(-a)=1-\om(a)$. 
%% For each arc $a$ of $\Gcr$ on an extra inner edge from a star vertex $v_f$ to an edge-vertex $v_e$, the weight of $a$ is 1 (resp. 0) if the label-jump from the face on the left
%% to the face on the right of $a$ is $d-\mathrm{deg}(f)$ (resp. is $d-\mathrm{deg}(f)-1$), and the weight on the opposite arc $-a$ is $\om(-a)=1-\om(a)$. 
\end{itemize}

%\begin{prop}\label{prop:bij-beta-p}
%The map $\Phi'$ is a bijection between the set $\bL_G'$ of $d$-GS labelings of $G$ and the set $\bA_G'$ of weak $d$-GS marked orientations of $G$. 
%\end{prop}
%\begin{proof}



It is easy to check that for any corner labeling $\cL\in\bL_G'$, the weighted orientation $\Phi'(\cL)$ is in $\bA_G'$. Indeed Conditions (L1') and (L2') (for edges) ensure that all the arc weights in $\Phi'(\cL)$ are non-negative, Remark~\ref{rk:ccw-quasi} ensures that $\Phi'(\cL)$ satisfies Conditions (A2') (for original edges) and (A3') (for edge-vertices), while Condition (L3') ensures that $\Phi'(\cL)$ satisfies Conditions (A1') (for star vertices). 
The inverse mapping $\bPhi'$ amounts to specifying the label jumps from the weighted orientation:
\begin{compactitem}
\item
For any inner arc $a$ of $\Gcr$ starting from an original inner vertex $v$, the weight of $a$ specifies the label jump from the inner face of $G'$ on the left of $a$ (considering the first half of $a$ if $a$ is on a non-special edge of $G$) to the inner face of $G'$ on the right of $a$. 
\item
For any arc $a$ from a star vertex $v_f$ to an edge-vertex $v_e$, if $e$ is non-special then the label-jump from the face on the left of $a$ to the face on the right of $a$ is 
$d-\mathrm{deg}(f)+1$; if $e$ is special and $a$ has weight $1$ (resp. $0$) then the label-jump from the face on the left of $a$ to the face on the right of $a$ is 
$d-\mathrm{deg}(f)$ (resp. $d-\mathrm{deg}(f)-1$).
\end{compactitem}
With these specifications, the sum of label-jumps in clockwise (resp. counterclockwise) order around an inner original vertex (resp. edge-vertex) is $d$, and 
for any star vertex, the jumps around it satisfy (L3'). 
Similarly as in the proof of Proposition~\ref{prop:bij-beta}, this ensures that the labels can be uniquely propagated, up to a global shift. Moreover, the weight configuration for inner arcs 
starting from an outer vertex ensure that there is a unique global shift so that the resulting labeling satisfies (L0').
By construction, the labeling also satisfies the other conditions of Definition~\ref{def:WGS-labeling}. Hence, $\bPhi'(\cA)\in\bL_G'$ for all $\cA\in\bA_G'$. 
Moreover, by construction, the two mappings $\Phi',\bPhi'$ are inverse of each other, hence bijections between $\bA_G'$ and $\bL_G'$.
%\end{proof} 

\begin{remark}
In the case where $G$ is a triangulation of the 5-gon, being quasi 5-adapted is equivalent to a notion of strong irreducibility: every 3-cycle must be the boundary of a face (irreducibility), and moreover every 4-cycle must bound an adjacent pair of faces. 
As we now explain, the QS angular orientations and labelings can be simplified in this case, and lead to an orientation of the \emph{primal-dual completion} of $G$ (the map obtained by superimposing $G$ and $G^*$), and a corner labeling of $G$. An example is shown in Figure~\ref{fig:5c_structure_simple}.

Consider first the $QS$ angular orientations of the triangulation $G$. All original inner edges of~$G$ are special, and all the star edges have weight $0$, except for the ones (of weight $1$) connecting an outer vertex $v_i$ or $v_{i-1}$ to the star vertex in the inner face incident to $(v_{i-1},v_i)$. We now assume that $G$ has at least $2$ inner vertices, so that the last property stated in Lemma~\ref{lem:rigid_qs} holds, hence the situation in the vicinity of outer edges is as shown in the left part of Figure~\ref{fig:5c_outer}(a).
 By performing the operations in Figure~\ref{fig:5c_outer}(a), and deleting the star edges, one gets an orientation of the inner edges of the primal-dual completion of $G$ characterized by the following conditions:
 \begin{itemize}
 \item
the outer vertices (which are primal vertices) have outdegree $0$, 
\item
the inner primal vertices have outdegree $5$, 
\item
the dual vertices have outdegree $2$, 
\item
the edge-vertices have outdegree $1$. 
 \end{itemize}
  
Consider now the $5$-QS labelings of the triangulation $G$. Note that each pair of inner faces of $G'$ corresponding to an inner corner of $G$ must have the same label (this follows from (L1'), the star edge $\eps$ in that corner satisfies $\si(\eps)=0$), except for the pairs corresponding to the first inner corner of $G$ at $v_i$ (the one incident to $(v_{i-1},v_{i})$).  
Hence, up to performing the label transfer shown in Figure~\ref{fig:5c_outer}(b) at the special pairs, and performing the natural label transfer for the other pairs (keeping the labels), the QS labeling of $G'$ yields a labeling of the inner corners of $G$ characterized by the following conditions:
\begin{itemize}
\item
for all $i\in[5]$, the inner corners incident to $v_i$ have label $i$,
\item
around every inner vertex, the incident corners form, in clockwise order, 5 non-empty intervals $I_1,I_2,I_3,I_4,I_5$, with all corners in $I_i$ having label $i$ for $i\in[5]$. 
\item
around every inner face, in clockwise order, there are two label-jumps equal to $2$ and one label-jump equal to $1$. 
\end{itemize}
These $5$-QS structures, the additional incarnation as woods, and a related drawing algorithm will be presented in a follow-up work~\cite{OB-EF-SL:5QS-drawing}.  The wood incarnation is represented in Figure~\ref{fig:5c_wood}.
\end{remark}

\fig{width=\linewidth}{5c_outer}{Operations to be performed in the neighborhood of outer edges for 5-QS structures of a quasi 5-adapted triangulation. (a) Operations for orientations. (b) Operations for labelings. The configuration shown here is frozen (see Lemma~\ref{lem:rigid_qs}).}

\fig{width=\linewidth}{5c_structure_simple}{Left: A quasi 5-adapted triangulated map $G$. Middle: the primal-dual completion of $G$, endowed with a $5$-QS angular orientations (more precisely, the orientation obtained from $5$-QS angular orientations by applying the operations of Figure~\ref{fig:5c_outer}(a), and deleting the star edges). Right: the corresponding $5$-QS labeling of $G$ (more precisely, the corner labeling of $G$ obtained from the $5$-QS labeling by applying the operations of Figure~\ref{fig:5c_outer}(b), and transferring the labels from inner faces of $G'$ to inner corners of $G$).}

\subsection{Proof of necessity in Theorem~\ref{thm:main-quasi}}\label{sec:proof-necessity-quasi}
A \emph{relaxed weighted orientation} is a weighted orientation where the arc-weights are in 
$\mathbb{Z}$. As usual, the \emph{outgoing weight} (shortly, the \emph{weight}) of a vertex $v$ is the sum of the weights of the arcs going out of $v$, and the \emph{weight} of an edge is the sum of weights of its two arcs. 
For a $d$-map $G$, with $G^+$ the angular map, a \emph{relaxed $d$-GS angular orientation} of $G$ is a relaxed weighted orientation of $G^+$ with exactly the same requirements as in Definition~\ref{def:angular}, the only difference being that negative arc-weights are allowed. By the exact same arguments as in the proof of Lemma~\ref{lem:ingoing-weight-angular} (these do not use positivity of the arc-weights), we obtain:

\begin{lemma} \label{lem:ingoing-weight-quasi-angular} 
Let $G$ be a $d$-map. Let $\cA$ be a relaxed weighted orientation of the angular map $G^+$ satisfying Condition (A1) and (A2) of $d$-GS angular orientations. Let $C$ be a simple cycle of $G$. The total weight $\inweight(C)$ of the arcs strictly inside $C$ with origin on $C$ is
$$\inweight(C)=\ell(C)-d+\sum_{a\in C}(d-\deg(f_a)),$$
where $\ell(C)$ is the length of $C$, the sum is over the arcs of $C$, and for an arc $a$ of $C$ the face incident to $a$ inside $C$ is denoted by $f_a$.
\end{lemma}

\fig{width=.9\linewidth}{local_rules_transition_other}{Starting from a $d$-QS angular orientation, and applying the shown local rules at every edge-vertex, one obtains a relaxed $d$-GS angular orientation (arcs with no weight indication have weight $1$, arcs not shown on their edge have weight~$0$).}

Let $G$ be a $d$-map with no face of degree smaller than $3$, admitting a $d$-QS angular orientation $\cA'$ of $\Gcr$. Let $\cA$ be the weighted orientation of $G^+$ obtained from $\cA'$ by applying the rules of Figure~\ref{fig:local_rules_transition_other} at each (special) edge-vertex of $\Gcr$. Note that $\cA$ is a relaxed $d$-GS angular orientation of $G$, where the only arcs of negative weight are on the special (original) edges: each such edge has an arc of weight $-1$ and an arc of weight $0$. 

We now aim at proving that $G$ is quasi $d$-adapted. For a simple cycle $C$ of $G$, we call \emph{chord} an edge strictly inside $C$ joining two vertices on $C$.
Let us first consider the length of chordless cycles. Let $C$ be a chordless non-facial simple cycle of $G$. 
For a face $f$ inside $C$ incident to at least one arc of $C$, let $k$ be the number of arcs of $C$ incident to $f$, and let $s$ be the number of arcs of $G$ inside $C$ that have weight $-1$, start from $C$, and have $f$ on their right (since $C$ is chordless, such an arc ends at a vertex strictly inside $C$). 
%For a face $f$ inside $C$ sharing at least one vertex with $C$, let $k$ be the number of edges of $f$ on $C$, and let $s$ be the number of arcs inside $C$ that have weight $-1$, start from $C$, and have $f$ on their right (since $C$ is chordless, such an arc ends at a vertex strictly inside $C$). 
Then, Condition (A1) and the rules of Figure~\ref{fig:local_rules_transition_other} ensure that the total contribution to $\inweight(C)$ of the edges incident to $v_f$ is at least $k(d-\deg(f))+s$ (indeed, letting $W_f$ be this contribution, $m$ be the number of vertices on $C$ adjacent to $v_f$, and $b$ be the sum of weights of arcs from $v_f$ to vertices not on $C$, we have $W_f=(m-1)(d-\deg(f))+b$, with $m\geq k+1$; and from Figure~\ref{fig:local_rules_transition_other} we see that $b\geq s$). 
This ensures that $\inweight(C)\geq\sum_{a\in C}(d-\deg(f_a))$, hence $\ell(C)\geq d$. 

Next, we consider a cycle $C$ of $G$ containing at least one vertex and having at least one chord. 
It admits a decomposition (at chords) into chordless cycles, as shown in Figure~\ref{fig:chord}. Since $C$ contains a vertex, one of these chordless components is non-facial, hence has length at least $d$. Moreover the length of $C$ is at least the length of any of its components, hence the length of $C$ is at least $d$. 

\fig{width=.6\linewidth}{chord}{Decomposition of a cycle into chordless components.}

Lastly, consider a non-facial simple cycle $C$ containing no vertex. The components of the chord decomposition of $C$ are facial cycles. Consider a pair of adjacent components, and let $C''$ be the contour of the union of these two faces. The length of $C''$ is at least $d-1$ since $G$ admits a $d$-QS angular orientation (so that every inner edge $e$ satisfies $\delta(e)\geq -1$). Hence the length of $C$ is at least $d-1$ as well, which concludes the proof that $G$ is $d$-adapted.
%In addition, if $C$ is not equal to $C''$, then and since we assume all faces of $G$ to have degree at least $3$, the length of $C$ is larger than the length of $C''$, hence is at least~$d$. 




\subsection{Proof of existence in Theorem~\ref{thm:main-quasi}}\label{sec:proof-existence-quasi}
The proof follows the same lines as the proof of existence of Theorem~\ref{thm:main}, so we only sketch it and highlight the main differences. 
For convenience in view of later proofs, we assume that $G$ has no inner edge connecting two outer vertices. The only quasi $d$-adapted maps having such edges are easily checked to be those with no inner vertex, and either one inner edge (separating two inner faces whose degrees add up to $d+2$, this case is actually $d$-adapted) 
or two inner edges (separating a chain of three inner faces $f_1,f_2,f_3$, where $\deg(f_1)=\deg(f_3)=3$, and $\deg(f_2)=d-2$). The existence of a $d$-QS angular orientation is 
then readily checked for those cases; see Figure~\ref{fig:dQS_with_chords} for the case $d=5$ with 3 inner faces.


\fig{width=0.6\linewidth}{dQS_with_chords}{Quasi 5-adapted map with 3 inner faces and no inner vertex (left drawing), endowed with its unique 5-QS angular orientation (right drawing).}
 
For the base case $d=3$, since we disallow here inner faces of degree smaller than $3$, every inner edge in a quasi $3$-adapted map $G$ 
satisfies $\delta(e)=1$. Hence there is no special edge, so being quasi 3-adapted is the same as being 3-adapted (here, being a simple triangulation), and the existence of 3-GS angular orientations is already established. The same remark actually holds for $d=4$ (assuming no inner face of degree less than $3$, the first value of $d$ for which there are quasi $d$-adapted maps that are not $d$-adapted is $d=5$).

For $d\geq 3$, let $G$ be a quasi $(d+1)$-adapted map with no inner face of degree less than $3$, and no inner edge connecting two outer vertices. We construct $\overline{G}_{\bullet}$ exactly as in the beginning of Section~\ref{sec:induction-step} (insertion of a copy of $X_d$ in each $(d+1)$-face, including the outer one, and re-rooting at a $d$-face in the outer copy of $X_d$). 
There is no non-facial cycle of length less or equal to $d$ in $G$, and the insertions of the copies of $X_d$ do not create non-facial cycles of length less or equal to $d$ either (by the same arguments as in Claim~\ref{claim:still-adapted}). Hence $\overline{G}_{\bullet}$ is $d$-adapted, so it admits a $d$-GS angular orientation $\overline{\cA}_{\bullet}$. Let $G_{\bullet}$ be the $(d+1)$-map obtained from $\overline{G}_{\bullet}$ by deleting the outer copy of $X_d$. In the orientation induced by $\overline{\cA}_{\bullet}$ on $G_{\bullet}^+$, as before the star edges incident to star vertices of degree $d$ have weight $0$, but now we also have inner original edges of weight $0$, which are precisely the special edges. 
Let $\widehat{G}_{\bullet}$ be the map obtained from $G_{\bullet}^+$ by deleting the star vertices of degree $d$ and their incident edges, and deleting 
the special (original) edges. Let $\cB_{\bullet}$ be the weighted orientation induced by $\overline{\cA}_{\bullet}$ on $\widehat{G}_{\bullet}$. 

The same arguments as in Claim~\ref{claim:co-accessible} ensure that $\cB_\bullet$ is co-accessible (indeed, the crucial property in that proof is that there is no $d$-cycle with at least one vertex inside). We can thus consider a spanning tree $T$ of $\widehat{G}_{\bullet}$ 
such that it contains all the outer edges of $G_{\bullet}$ except $(v_1,v_2)$, and for every inner edge of $T$, the arc traversed in the direction away from the outer vertices has positive weight. 
Then we use the transfer process of Section~\ref{sec:induction-step} (described after Claim~\ref{claim:co-accessible}) 
to obtain a weighted orientation $\widehat{\cA}_{\bullet}^+$ on $\widehat{G}_{\bullet}^+$ 
(the process can be formulated for any co-accessible orientation endowed with a compatible spanning tree). 
By the same arguments as in Section~\ref{sec:induction-step}, in $\widehat{\cA}_\bullet$ the weight of every inner vertex of $\widehat{G}_\bullet$ has increased by $1$ compared to $\cB_\bullet$, and the weight of every inner edge of $\widehat{G}_\bullet$ has decreased by $1$ compared to $\cB_\bullet$, while all the vertices and edges of $\widehat{\cA}_{\bullet}^+$ which were not in $\widehat{G}_{\bullet}$ have weight $1$. 
 
\fig{width=\linewidth}{face_three_types}{(a) The 3 types of inner faces in the map $\widehat{G}_\bullet$ (the second type, arising from special edges of $G$, does not appear when $G$ is $(d+1)$-adapted). (b) Contracting the small edges incident to a star vertex of $G_{\bullet}^+$.}



A notable difference with Section~\ref{sec:induction-step} is that there are now $3$ types of inner faces in $\widehat{G}_{\bullet}$, as shown in Figure~\ref{fig:face_three_types}(a). 
We call \emph{small triangles} the faces of the first type, that is, the inner faces of $\widehat{G}_{\bullet}$ made of two vertices of $G_{\bullet}$
and a star vertex of $G_{\bullet}^+$ of degree less than $d$. We call \emph{small edges} and \emph{small vertices} of $\widehat{G}_{\bullet}^+$ the vertices and 
edges that have been added inside the small triangle. We call \emph{edge-vertices} and \emph{extra edges} of $\widehat{G}_{\bullet}^+$ the vertices and edges that have been added inside the (quadrangular) faces of the second type in Figure~\ref{fig:face_three_types}(a). 

We then apply to $\widehat{G}_{\bullet}^+$ the contraction process indicated in Figure~\ref{fig:face_three_types}(b): contracting all the small edges incident to star vertices of $G_{\bullet}^+$. We obtain a map $\widetilde{G}_\bullet^\times$ closely related to $G_\bullet^\times$: it is $G_\bullet^\times$ except that for every star edge $e$ incident to a star vertex of degree less than $d$ in $\Gcr$ one has $t\in\{0,1,2\}$ additional small edges with the same endpoints as $e$. Precisely, we have $t=t_{\ell}+t_r$, where $t_{\ell}\in\{0,1\}$ (resp. $t_{r}\in\{0,1\}$) indicates whether there is an edge $e_\ell$ (resp. $e_r$) on the left (resp. right) side of $e$ resulting from the contraction of a small edge. Note that $t=2-s(e)$, with $s(e)$ the number of special edges among the two original edges that delimit the inner corner of $G_{\bullet}$ associated to $e$. 
%\fig{width=.5\linewidth}{existence-proof-construct-quasi}{Contracting the small edges incident to a star vertex of $G_{\bullet}^+$.}

We then let $\cA_\bullet'$ be the weighted orientation of $G_\bullet^\times$ obtained from $\widehat{\cA}_{\bullet}$ by this contraction process. That is to say, for every star edge $e$ of $G_\bullet^\times$ incident to a star vertex $v_f$ of degree less than $d$, the weights of the arcs of $e$ are taken as the sum of weights of the corresponding arcs in $e,e_{\ell},e_r$ (whenever $e_\ell,e_r$ exist). 
From the preceding, the weight of such an edge $e$ is $d+1-\mathrm{deg}(f)-s(e)$. This formula also holds for an edge $e$ that is a star edge of $G_\bullet^\times$ 
incident to a star vertex $v_f$ of $G_\bullet^\times$ of degree $d$. Indeed,
the weight in $\cA_{\bullet}'$ of such an edge is $1$, and it has $s(e)=0$ (this is ensured by the fact that there is no inner face of degree less than $3$, so that the $(d+1)$-map $G_\bullet$ has no special edge incident to a $d$-face). Since the weights of inner vertices and inner edges of $G_{\bullet}$ have not changed compared to $\cB_\bullet$, we conclude that the orientation $\cA_\bullet'$ (on $G_\bullet^\times$) satisfies all conditions of Definition~\ref{def:quasiAngular}, except possibly Condition (A0').
%, and the last statement in Condition (A3'). 

%A \emph{star-cycle} of $\Gcr$ (or $G^+$) is a cycle containing only star edges. If $G$ is $(d+1)$


%A \emph{border inner edge} of $G$ is an inner edge that is incident to an inner face that shares at least one edge with the outer face.  

A \emph{border} star vertex of $G_\bullet^\times$ (or $G_\bullet^+$) is a star vertex in a face of $G_\bullet$ that is incident to at least one outer edge of $G_\bullet$. 
A \emph{border} edge-vertex of $G_\bullet^\times$ is an edge-vertex that is adjacent to an outer vertex and to a border star vertex. 
To show that $\cA_{\bullet}'$ can be modified to satisfy Condition~(A0'), %the remaining conditions of Definition~\ref{def:quasiAngular}
 we prove the following:

\begin{lemma}\label{lem:conditions_A_prime_quasi}
In the orientation $\cA_\bullet'$, any arc starting from an outer vertex has weight $0$, except possibly if it ends at a border star vertex or at a border edge-vertex. 
%, or it ends at an edge-vertex that is adjacent to a border star vertex. 
Moreover, any arc starting from a border star vertex has weight $0$, except possibly if it ends at an outer vertex or at a border edge-vertex. 
Finally, for every border star vertex $v_f$, the outer vertices adjacent to $v_f$ are consecutive along the outer face.  
%\OB{I am a bit worried about this last statement. Would not it mean that in any quasi $(d+1)$-adapted map (with inner faces of degree $3\leq deg \leq d$) the outer edges incident to an inner face are always consecutive? But this seems to be false on small examples without inner vertices (2 faces of degree 3 separated by a face of degree $d-1$). Am I missing something? Maybe it is the only bad case though. My impression is that the case where there is a chord for the outer face should be treated separately.}
\end{lemma}
\begin{proof}
We let $\cR_\bullet$ be the weighted orientation of $\Gb^+$ obtained from $\cA_\bullet'$ 
by applying the operations of Figure~\ref{fig:local_rules_transition_other} at every star vertex. As in Section~\ref{sec:proof-necessity-quasi}, 
$\cR_\bullet$ is a relaxed orientation that satisfies Conditions (A1) and (A2) of Definition~\ref{def:angular}. Thus, letting $C$ be the outer cycle of $\Gb$, Lemma~\ref{lem:ingoing-weight-quasi-angular} applies: in $\cR_{\bullet}$ we have $\inweight(C)=\sum_{i=1}^{d+1}(d+1-\deg(f_i))$, where $f_i$ is the inner face incident to the outer edge $(v_{i-1},v_i)$. 
Let $S$ be the total weight (in $\cR_{\bullet}$) of arcs from border star vertices to inner vertices. 
Since the arcs on star edges have non-negative weight in $\cR_\bullet$, and since Conditions (A1) and (A2) hold, the contribution to $\inweight(C)$ of the arcs from outer vertices to border star vertices is at least $S+\sum_{i=1}^{d+1}(d+1-\deg(f_i))$, with equality if and only if for every border star vertex $v_f$, the outer vertices adjacent to $v_f$ are consecutive along the outer face. 
Hence, the total weight (in $\cR_\bullet$) of the arcs that start at an outer vertex and do not end at a border star vertex is at most $-S$. 
Hence, if we let $W$ be the total weight (in $\cR_\bullet$) of arcs that either start at an outer vertex and do not end at a border star vertex, or 
start at a border star vertex and end at an inner original vertex, then we have $W\leq 0$. 

We now look at the contributions to $W$ %given by arcs in $\cA_\bullet'$, where it is helpful to visualize these contributions
 in the intermediate step (with green edges) in Figure~\ref{fig:local_rules_transition_other}. Recall that we assume $G$ has no inner edge connecting two outer vertices,  and the same  holds for $\Gb$ (as the insertions of copies of $X_d$ can not create such edges), hence every edge-vertex $v_e$ has at most one outer neighbor.  
Then it is not difficult to see that every edge-vertex $v_e$ adjacent to an outer vertex or to a border star vertex yields a non-negative contribution to $W$
(contribution given by the special edge of weight $-1$ and the 4 green edges associated to $v_e$), 
and that the contribution is strictly positive whenever $v_e$ does not end at an outer vertex or at a border star vertex. 
%is zero if and only if the unique outgoing edge of $v_e$ ends at an outer vertex or at a border star vertex 
%(except in the hypothetical case where $v_e$ has two neighbors that are border star vertices, but no outer neighbor, this case yielding positive contribution even when the outgoing edge of $v_e$ ends at one of these two star vertices).  
On the other hand, for every arc $a$ in $\cA_\bullet'$ starting at an outer vertex, 
on a non-special original edge or on a star edge, and not ending at a border star vertex, the contribution of $a$ to $W$ is given by its weight in $\cA_{\bullet}'$. 
Similarly, for every arc $a$ in $\cA_\bullet'$ starting at a border star vertex and ending at an original inner vertex, the contribution of $a$ to $W$ is given by its weight in $\cA_{\bullet}'$. 
Since $W\leq 0$, and since all possible contributions are non-negative (grouping those associated to an edge-vertex as explained above), we conclude that the positive ones do not exist. 

Finally, the above inequality (for $S+\sum_{i=1}^{d+1}(d+1-\deg(f_i))$) has to be tight, so that the last statement holds.
\end{proof}

To turn $\cA_\bullet'$ into a $(d+1)$-QS angular orientation, we modify some arc weights in the neighborhood of the outer face, keeping the weights of edges and of inner vertices unchanged, as follows. 
For each edge $(v_i,v_{f_i})$, with $f_i$ the inner face of $G_\bullet$ incident to $(v_{i-1},v_i)$,  
we put all the weight on the arc out of $v_i$; and if $f_{i+1}\neq f_i$, we put all the weight of the edge $(v_i,v_{f_{i+1}})$ on the arc ending at $v_i$. 
For each border edge-vertex $v_e$ we choose the unique outgoing edge of $v_e$ as the one leading to the adjacent outer vertex $v$, unless
the next neighbor after $v$ in counterclockwise order around $v_e$ is a border star vertex $v_f$, in which case the unique outgoing edge of $v_e$ is the one leading to $v_f$.  
With these modifications, and given Lemma~\ref{lem:conditions_A_prime_quasi}, one easily checks that all conditions of Definition~\ref{def:quasiAngular} are now satisfied.

Finally, by the exact same arguments as those at the end of Section~\ref{sec:induction-step}, the $(d+1)$-GS angular orientation $\cA_\bullet'$ on $G_\bullet^\times$ yields a $(d+1)$-GS angular orientation $\cA'$ on $\Gcr$; see Figure~\ref{fig:existence-proof-construct}(b). Note that the special edges do not interfere with this last step,  
since they are not incident to inner faces of $G_\bullet$ of degree $d$, hence there is no special edge of $G_\bullet$ on a boundary of a copy of $X_d$, 
and there is no special edge inside a copy of $X_d$ either.


% (in particular (A0'), (A3'), and the fact that the outgoing weight of every border star vertex $v_f$ is $d+1-\mathrm{deg}(v_f)$). 
%\fig{width=13cm}{}{} 



%\bibliography{biblio-Schnyder}
%\end{document}

