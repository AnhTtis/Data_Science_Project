%\documentclass[letter]{amsart}
%\input{defs.tex}
%\author{Olivier Bernardi$^{*}$ \and \'{E}ric Fusy$^{\dagger}$ \and Shizhe Liang$^{+}$}
%\title[Grand Schnyder Woods]{Grand Schnyder Woods}
%\begin{document}
%\section{Proof of the existence of grand-Schnyder structures}


In this section we complete the proof of Theorem~\ref{thm:main}. Since we have already established the bijection between the different incarnations of grand-Schnyder structures (woods, labelings, marked orientations, and angular orientations), it suffices to show that a $d$-map $G$ admits a $d$-GS angular orientation if and only if $G$ is $d$-adapted.

The proof that $d$-adaptedness is a necessary condition for the existence of $d$-GS angular orientation is based on a simple counting argument.
Suppose that a $d$-map $G$ admits a $d$-GS angular orientation. Let $C$ be a non-facial simple cycle of $G$. We want to show that $C$ has length at least $d$.
Recall from Lemma~\ref{lem:ingoing-weight-angular} that the total weight $\om(C)$ of the arcs strictly inside $C$ with initial vertex on $C$ is
$$\om(C)=\ell(C)-d+\sum_{a\in C}(d-\deg(f_a)),$$
where $\ell(C)$ is the length of $C$, the sum is over the arcs of $C$, and for an arc $a$ of $C$ the face incident to $a$ inside $C$ is denoted by $f_a$.
Observe now for each inner face $f$ of $G$ inside $C$ and incident to $k\geq 1$ edges on $C$, there are at least $k+1$ corners of $f$ incident to a vertex on $C$. 
The weight condition (A1) then ensures that the total contribution to $\om(C)$ of the edges incident to $v_f$ is at least $k(d-\deg(f))$. Hence, $\om(C)\geq \sum_{a\in C}(d-\deg(f_a))$, so that $\ell(C)\geq d$. 


This prove that $d$-adaptedness is a necessary condition for the existence of $d$-grand-Schnyder structures. In order to complete the proof of Theorem~\ref{thm:main}, it remains to prove that any $d$-adapted map admits a $d$-GS orientation and that such an orientation can be computed \emph{in linear time}. Here and in the rest of this section we say that a structure for $d$-adapted maps can be computed \emph{in linear time} if it can be computed in a number of operations which is linear in the number of vertices of the $d$-adapted map. It should be noted that for $d$-adapted maps, the number of edges $\ee$ is linear in the number of vertices $\vv$ (it is easy to show that $\vv\leq \ee\leq 6\vv$ using the fact that there cannot be 3 edges with the same endpoints), and that the bijections between the different incarnations of $d$-GS structures described in Section~\ref{sec:incarnations} can be performed in linear time.\footnote{In~\cite{OB-EF:Schnyder} an existence proof was given for the special case of Schnyder decompositions (which correspond to $d$-GS structures on $d$-angulations) by using a ``min-cut max-flow'' type of argument. It may be possible to adapt this argument in the general case, however the proof in the present article is different: it is constructive and can be used to define a linear time algorithm for computing $d$-GS structures, thereby answering a question which was left open for Schnyder decompositions in~\cite{OB-EF:Schnyder}.}


The existence proof is by induction on~$d$. 
Since the induction step is rather technical, we will first present the main ideas on a simple case: we will explain how to deduce the existence of transversal structures (for 4-adapted triangulations of the square), from the existence of Schnyder woods (for 3-adapted triangulations).
%In order to preview our proof, we first explain how to construct 4-GS angular orientations assuming one already knows how to construct 3-GS angular orientations (an incarnation of the classical Schnyder woods). 


%% \subsection{Necessity of $d$-adaptedness}
%% We start by proving that any $d$-map which admits a $d$-GS structure is $d$-adapted.
%% \begin{lemma} \label{lem:ingoing-weight-angular} 
%% Let $G$ be a $d$-map. Let $\cA$ be a weighted orientation of the angular map $G^+$ satisfying Condition (A1) and (A2) of $d$-GS angular orientations. Let $C$ be a simple cycle of $G$. The total weight $\om(C)$ of the arcs strictly inside $C$ with origin on $C$ is
%% $$\om(C)=\ell(C)-d+\sum_{e\in C}(d-\deg(f_e)),$$
%% where $\ell(C)$ is the length of $C$, the sum is over the edges of $C$, and for an edge $e$ of $C$ the face incident to $e$ inside $C$ is denoted by $f_e$.
%% \end{lemma}

%% \begin{proof} 
%% Let $V,E,F$ the set of vertices, edges and faces strictly inside $C$. 
%% The total weight of the edges of the angular map inside $C$ is $\ds (d-2)|E|+\sum_{e\in C}(d-\deg(f_e))$.
%% The total weight of the vertices of the angular map inside $C$ are $d|V|+\sum_{f\in F}(d-\deg(f))$.
%% Hence, 
%% $$\om(C)=(d-2)|E|+\sum_{e\in C}(d-\deg(f_e))-d|V|-\sum_{f\in F}(d-\deg(f))$$
%% By the Euler relation one has $|V|+|F|=|E|+1$ and by the incidence relation between faces and edges one gets $\sum_{f\in F}\deg(f)=2|E|+\ell(C)$. Combining these relations gives $(d-2)|E|-d|V|-\sum_{f\in F}(d-\deg(f))=\ell(C)-d$. This gives the stated expression for $\om(C)$.
%% \end{proof}
%% From Lemma~\ref{lem:ingoing-weight-angular}, it is easy to see that if a $d$-map $G$ admits a $d$-GS angular orientation, then it is $d$-adapted. Indeed, let $C$ be a non-facial cycle of $G$. Then, for each inner face $f$ of $G$ inside $C$ and having $k\geq 1$ edges on $C$, there are at least $k+1$ corners of $f$ incident to a vertex on $C$. 
%% The weight condition (A1) then ensures that the total contribution to $\om(C)$ of the edges incident to $v_f$ is at least $k(d-\deg(f))$. Hence, $\om(C)\geq \sum_{e\in C}(d-\deg(f_e))$, so that $\ell(C)\geq d$. 


%% %if $C$ is a non-facial simple cycle of $G$, then the weight condition (A1) at the star vertices $v_{f_e}$ for $e$ in $C$ implied that $\om(C)\geq \sum_{e\in C}(d-\deg(f_e))$, hence $\ell(C)\geq d$.
 


\subsection{A preview of the existence proof: existence of 4-GS angular orientations}\label{sec:special-case-proof-exist}
%% In order to complete the proof of Theorem~\ref{thm:main}, it remains to prove that any $d$-adapted map admits a $d$-GS orientation and that such an orientation can be computed \emph{in linear time}. Here and in the rest of this section we say that a structure for $d$-adapted maps can be computed \emph{in linear time} if it can be computed in a number of operations which is linear in the number of vertices of the $d$-adapted map. It should be noted that for $d$-adapted maps, the number of edges $\ee$ is linear in the number of vertices $\vv$ (it is easy to show that $\vv\leq \ee\leq 6\vv$ using the fact that there cannot be 3 edges with the same endpoints), and that the bijections between the different incarnations of $d$-GS structures described in Section~\ref{sec:incarnations} can be performed in linear time.


%% The existence proof is by induction on~$d$. 
%% Since the induction step is rather technical, we will first present the main idea on a simple case: we will explain how to deduce the existence of transversal structures (for 4-adapted triangulations of the square), from the existence of Schnyder woods (for 3-adapted triangulations).
%% %In order to preview our proof, we first explain how to construct 4-GS angular orientations assuming one already knows how to construct 3-GS angular orientations (an incarnation of the classical Schnyder woods). 
Let us fix a 4-adapted map $G$ such that the inner faces have degree 3 or 4 (no face of degree 2). We want to construct a 4-GS angular orientation of $G$. The process is represented in Figure~\ref{fig:4-GS-existence}.



\fig{width=.85\linewidth}{4-GS-existence}{Construction of a 4-GS angular orientation $\cA$ for a 4-adapted map $G$. (a) The map $G$. (b) 
The triangulation $\bGb$ with a 3-GS orientation. Restricting the 3-GS orientation to $\Gb$ gives an orientation $\cBb$ such every inner-vertex has outdegree 3. (c) A spanning tree $T$ of $\Gb$ oriented from the outer vertices to the inner vertices, and the bijection between the edges in $\Gb\setminus T$ and the faces of $\Gb$. (d) Construction of the angular orientation $\hAb$ from $\cBb$. (e) The 4-GS angular orientation $\cAb$ closely related to $\hAb$ (the differences with $\hAb$ are highlighted). (f) Construction of the 4-GS angular orientation $\cA$ from~$\cAb$.}

%Step 1. Construct a 3-GS structure $\cBb$ on a related 3-map $\Gb$.
Let $\Gb$ be the triangulation obtained from $G$ by adding a vertex $u_f$ in each inner face $f$ of degree~4 and joining $u_f$ to each of the vertices of $f$, as represented in Figure~\ref{fig:4-GS-existence}(b). It is easy to see that $\Gb$ is 4-adapted. By adding a vertex in the outer face of $\Gb$ and joining it to the outer vertices of $\Gb$, one gets a 3-adapted triangulation. Since this triangulation admits a Schnyder wood, we can obtain the following structure for $\Gb$: an orientation $\cBb$ of the inner edges of $\Gb$ such that every inner vertex has outdegree 3. See Figure~\ref{fig:4-GS-existence}(b).

%Step 2. Modify the 3-GS structure using the co-accessibility property.
An important observation is that $\cBb$ is \emph{co-accessible}: for every inner vertex $v$ of $\Gb$ there exists a directed path in $\cBb$ from an outer vertex of $\Gb$ to $v$. We will justify this claim in Section~\ref{sec:induction-step}, and simply mention that this is a consequence of the fact that $\Gb$ is 4-adapted. As a consequence, there exists a spanning tree $T$ of $\Gb$ containing all the outer edges except $\{v_1,v_2\}$, such that the inner edges in $T$ form directed paths from the outer vertices to the inner vertices. See Figure~\ref{fig:4-GS-existence}(c). 

Next, we use $T$ to construct a 4-GS angular orientation of $\Gb$ as represented in Figure~\ref{fig:4-GS-existence}(c-d). We will use a bijection between the edges of $\Gb\setminus T$ and the inner faces of $\Gb$. This is a standard correspondence, that we now recall.

\begin{claim}\label{claim:inside-face}
Let $M$ be a plane map, and let $T$ be a spanning tree of $M$. To each edge $e$ in $M\setminus T$ we associate the face $\varphi(e)$ incident to $e$ which is enclosed by the unique cycle in $T\cup \{e\}$. The mapping $\varphi$ is a bijection between the set of edges in $M\setminus T$ and the inner faces of $M$.
\end{claim}
\begin{proof} The claim is classical, so we only sketch the proof idea here. The dual of the edges in $M\setminus T$ forms a spanning tree $T^*$ of the dual map $M^*$. We take the vertex of $M^*$ in the outer face to be the root of $T^*$. Then, the mapping $\varphi$ can be interpreted as the correspondence between the non-root vertices of $T^*$ and the edges of $T^*$ (each vertex is associated to its parent edge).
\end{proof}

Let $\Gb^+$ be the angular map of $\Gb$. We now describe an orientation of the star edges of $\Gb^+$.
Let $f$ be a face of $\Gb$, and let $e$ be the edge of $\Gb\setminus T$ such that $f=\varphi(e)$, where $\varphi$ is the bijection described in Claim~\ref{claim:inside-face}. Let $u$ be the terminal vertex of $e$ in the orientation $\cBb$ (by convention we orient the outer edge $\{v_1,v_2\}$ toward $v_1$) and let $v,w$ be the other vertices of $\Gb$ incident to $f$. We orient the star edges incident to the star vertex $v_{f}$ as follows: the star edge between $v_{f}$ and $u$ is oriented toward $u$ while the 2 others are oriented toward $v_{f}$. Let $\hAb$ be the resulting orientation of the star-edges of $\Gb^+$ (we forget the orientations of the original edges of $\Gb^+$). This is represented in Figure~\ref{fig:4-GS-existence}(c-d). 


It is not hard to check that the original inner vertices of $\Gb$ have outdegree~4 in $\hAb$ (and we delay the proof to Section~\ref{sec:induction-step}). 
%Indeed, the outdegree of an inner vertex $v$ in $\cBb$ is $\deg(v)-n_v$, where $n_v$ is the number of edges in $\Gb\setminus T$ oriented toward $v$; and since there is exactly 1 edge of $T$ oriented toward $v$, we have $$n_v=\indeg(v)-1=\deg(v)-\outdeg(v)-1=\deg(v)-4,$$ 
% where $\indeg(v)$ and $\outdeg(v)$ are the indegree and outdegree of $v$ in $\cBb$ respectively. 
Hence, the orientation $\hAb$ can be identified with a $4$-GS angular orientation of $\Gb$: the star edges have weight 1, the original edges have weight 0, the star vertices have weight 1 and the original vertices have weight~4. 
More precisely, we see that $\hAb$ satisfy condition (A1) and (A2) of angular orientation. Up to a simple adjustment of the orientation of the star-edges incident to the outer vertices of $\Gb$, one can obtain a 4-GS angular orientation $\cAb$ of $\Gb$. 
See Figure~\ref{fig:4-GS-existence}(e), and the proof in Section~\ref{sec:induction-step}. 

Lastly, we use $\cAb$ to construct a 4-GS angular orientation $\cA$ of $G$ as represented in Figure~\ref{fig:4-GS-existence}(e-f).
Let $G^+$ be the angular map of $G$. Recall that an angular orientation of $G$ must satisfy the following conditions: 
\begin{compactitem}
\item the weight of original inner vertices is~4, 
\item the weight of any star vertex inside a face of $G$ of degree~$3$ (resp.~4) is~1 (resp.~0),
\item the weight of any original inner edge is equal to the number of incident faces of $G$ of degree~4, 
%\item the weight of star vertices inside a face of $G$ of degree~$3$ (resp.~4) is~1 (resp.~0).
\end{compactitem}
We define $\cA$ as follows. For star arcs of $G^+$ inside faces of $G$ of degree $3$, we take their weight in $\cA$ to be the same as in $\cAb$. For an original inner arc $a$ of $G^+$, the weight $w_a$ of $a$ in $\cA$ is determined by looking at the triangles of $\Gb$ incident to $a$ which are inside a face of $G$ of degree~4: $w_a$ is the number of star edges in these triangles which are oriented toward the terminal vertex of $a$ in $\cAb$. 
This definition of $\cA$ is represented in Figure~\ref{fig:4-GS-existence}(e-f): the orientation $\cAb$ inside a face $f$ of $G$ of degree~4 is used to determine the weight of the arcs of $G$ incident to $f$ (one thing to observe is that the star-edges of $\Gb^+$ incident to the vertex $u_f$ of $\Gb$ are always oriented away from $u_f$). It is not hard to check that $\cA$ is indeed a 4-GS angular orientation of~$G$.

The above proof of the existence of a 4-GS angular orientation is constructive. Since there are algorithms for constructing 3-GS angular orientations in linear time~\cite{Schnyder:wood1}, the above process leads to an algorithm for constructing 4-GS orientations in linear time. This concludes this preview of our proof, and we will now tackle the general case.

%% \subsection{Case d=3}

%% Let us start with the base case $d=3$, which is a straightforward extension of Schnyder's result~\cite{Schnyder:wood1} (see Figure~\ref{fig:3-GS}).
%% \begin{lem} 
%% Any 3-adapted map admits a 3-GS angular orientation, and such an orientation can be computed in linear time.
%% \end{lem}
%% \OB{We should set once and for all what we mean by ``in linear time'' (\#operation is bounded by a linear function of the \#vertices)}

%% \begin{proof}
%% Let $G$ be a 3-adapted map. We want to show that $G$ admits a 3-GS weighted orientation. Since $G$ is adapted, the faces of $G$ have degree 2 (\emph{digons}) or 3 (\emph{triangles}). Moreover, digons cannot be adjacent (incident to the same edge). This implies that $G$ can be obtained from a triangulation $H$ by duplicating some of the edges of $H$ so as to create digons. This is represented in Figure~\ref{fig:3-GS}(a).

%% \fig{width=\linewidth}{3-GS}{(a) A 3-adapted triangulation $H$, and the 3-adapted map $G$ obtained from $H$ by transforming some edges into digons. (b) A Schnyder wood $\cW$ of $H$ (interpreted as a 3-orientation), and the corresponding 3-GS angular orientation $\cA$ of $G$. Note that in a 3-GS angular orientation of $G$, the original edges of $G^+$ incident to 2 triangles must have weight 1, the star edges in digons have weight 1, and the other edges have weight 0. We represent this structure as a partial orientation: indicating the orientation for the edges of weight 1.}

%% Since, $G$ is 3-adapted, the triangulation $H$ is also 3-adapted. By the results of Schnyder~\cite{Schnyder:wood1}, the triangulation $H$ admits a Schnyder wood $\cW$ and such a structure can be computed in linear time. We can think of $\cW$ as a \emph{3-orientation}, that is, an (unweighted) orientation of the inner edges of $H$ such that every inner vertices have outdegree 3 (and the outer vertices have outdegree 0). From this we create a 3-GS weighted orientation $\cA$ for $G$ as indicated in Figure~\ref{fig:3-GS}(b): 
%% \begin{compactitem}
%% \item For an edge $e$ of $H$ that is not transformed into a digon of $G$, the orientation of $e$ in $\cA$ is the same as in $\cW$.% (the edge $e$ is incident to 2 triangles in $G$, hence has weight $1$ in $\cA$ unless it is an outer edge).
%% \item For an edge $e$ of $H$ that is transformed into a digon $f$ of $G$, the star-edges inside $f$ are oriented as follows: if $e$ is oriented from $u$ to $v$ on $\cW$, or if $e$ is an outer edge with $u=v_i$ and $v=v_{i-1}$, then the star edges of $G^+$ are oriented from $u$ to $v_f$ and from $v_f$ to $v$. 
%% \item The other edges of $G^+$ are left unoriented on $\cA$ (they have weight 0).
%% \end{compactitem}
%% It is clear that $\cA$ is a 3-GS angular orientation, and that it can be computed in linear time from $\cW$.
%% \end{proof}





\subsection{Existence of $d$-GS angular orientations by induction on $d$}\label{sec:induction-step}
In this subsection we present the general induction step for the existence of $d$-GS orientations. To be precise, we will prove that every $d$-adapted map \emph{without multiple edges} admits a $d$-GS angular orientation that can be computed in linear time. The case of maps with multiple edges will be treated in the next subsection. 

As noted above, the case $d=3$ was established by Schnyder~\cite{Schnyder:wood1}. Indeed the 3-adapted maps without multiple edges are the 3-connected triangulations, and the Schnyder woods of triangulations are in easy bijection with 3-GS angular orientations. Moreover, as established in~\cite{Schnyder:wood1}, Schnyder woods can be computed in linear time.

Suppose now that for some $d\geq 3$ the existence of $d$-GS angular orientations has been established for $d$-adapted maps without multiple edges. We consider a $(d+1)$-adapted map $G$ without multiple edges, for which we want to construct a $(d+1)$-GS orientation. As a guide, Figure~\ref{fig:diagram_proof} shows the sequence of steps to be performed for this inductive process.

\fig{width=.9\linewidth}{diagram_proof}{The sequence of steps to obtain a $(d+1)$-GS angular orientation on a $(d+1)$-adapted map $G$. Regarding the sequence of operations on maps, in (1) to obtain $\overline{G}_\bullet$ from $G$, a copy of $X_d$ is inserted in each face of degree $d+1$ (including the outer one), and the map is re-rooted at a $d$-face in the outer $X_d$. In (2) to obtain $\widehat{G}_{\bullet}$ from $\overline{G}_{\bullet}^+$, the outer copy of $X_d$ is deleted (giving $G_{\bullet}^+$), and then the star-vertices of degree $d$ and their incident edges are deleted. In (4) to recover $G_{\bullet}^+$ from $\widehat{G}_{\bullet}^+$, the edges of $\widehat{G}_{\bullet}^+\backslash \widehat{G}_{\bullet}$ (``small'' edges) that are incident to star vertices of $G_{\bullet}^+$ are contracted. In (5) to recover $G$ from $G_{\bullet}$, the inner copies of $X_d$ are deleted. Regarding weighted orientations, all steps involve a trivial transfer (under edge contractions, edge deletions, or merger of edges), except step (3) where a directed spanning tree of $\widehat{G}_\bullet$ is used to orient the small edges and to decrement some arc weights in $\widehat{G}_\bullet$.
}
 
We first construct a new map $\Gb$ from $G$ by dissecting the faces of $G$ of degree $d+1$.
Let $X_d$ be the $(d+1)$-map represented in Figure~\ref{fig:face-plug} (the definition of $X_d$ depends on the parity of~$d$). Let $\Gb$ be the map obtained by gluing $X_d$ in each inner face of $G$ of degree $d+1$. 
 \fig{width=.65\linewidth}{face-plug}{The $(d+1)$-map $X_d$ in the case of odd $d$ (left, represented for $d=7$) and in the case of even $d$ (right, represented for $d=8$). The degree of the inner faces are indicated (the outer face has degree $d+1$).}

Note that the inner faces of $\Gb$ have degree at most~$d$. Moreover it is not hard to check the following claim.

 
\begin{claim}\label{claim:still-adapted} 
The map $\Gb$ has no non-facial simple cycle of length less than $d+1$.%, and no simple cycle of length less than $d+1$ enclosing some vertices of $\Gb$. 
\end{claim}

\begin{proof} 
If a non-facial simple cycle uses none of the inner edges from the copies of $X_d$, then it has length at least $d+1$ since $G$ is $(d+1)$-adapted. 
If a non-facial simple cycle stays within a copy of $X_d$ then it has length at least $d+1$. Finally, consider a non-facial simple cycle $C$ using some edges in a copy of $X_d$, but which is not confined to this copy. Then $C$ uses at least $d-1$ edges in the copy of $X_d$, and at least 2 additional edges (since $G$ does not have double edges, and cannot have an edge joining non-adjacent vertices of a face because it is $(d+1)$-adapted). 
%Then $C$ uses at least $d-1$ edges in the copy of $X_d$, and at least one additional edge (so $\Gb$ has no non-facial cycle of length less than $d$), and at least two additional edges if $C$ encloses some vertices since $G$ is $(d+1)$-adapted (so that $\Gb$ has no non-facial cycle of length less than $d+1$ enclosing some vertices).
\end{proof}

Let $X_d'$ be the map obtained from $X_d$ by ``taking one of its inner faces of degree $d$ to become the new outer face'' (this is better understood when picturing $X_d$ on a sphere with a face arbitrarily chosen to be the ``outer face''). The map $X_d'$ has an inner face of degree $d+1$, and we define $\bGb$ as the $d$-map obtained by gluing $\Gb$ in the face of degree $d+1$ of $X_d'$.
%Let us consider the $d$-map $\bGb$ obtained from $\Gb$ by gluing $X_d$ in the outer face of $\Gb$. \OB{OB:Need to explain better what is the new outer face etc...}
Using Claim~\ref{claim:still-adapted}, it it easy to see that $\bGb$ is $d$-adapted. Hence, by the induction hypothesis, $\bGb$ admits a $d$-GS angular orientation $\bAb$. By definition, the weight in $\bAb$ of a star edge $e$ is $d-\deg(f)$, where $f$ is the face of $\bGb$ containing $e$, and in particular this weight is 0 for star edges inside faces of $\bGb$ of degree $d$. Let $\hGb$ be the map obtained from $\Gb^+$ by deleting the star vertices and star edges in the faces of $\Gb$ of degree $d$. The map $\hGb$ is represented in Figure~\ref{fig:existence-proof-maps}. (We mention that for the special case $d=3$ treated in Section~\ref{sec:special-case-proof-exist}, we had $\hGb=\Gb$ because $\Gb$ only had faces of degree $d$.)

\fig{width=\linewidth}{existence-proof-maps}{The maps $\Gb$, $\hGb$ and $\hGb^+$. Left: a face of $\Gb$ of degree less than $d$, and a face of degree $d$. Middle: the corresponding faces in $\hGb$. Right: the corresponding faces in $\hGb^+$.}

Let $\cBb$ be the restriction of $\bAb$ to the map $\hGb$. It is not hard to check the following claim.

\begin{claim}\label{claim:positive-edges} Every inner edge of $\hGb$ has a positive weight in $\cBb$.
\end{claim}

\begin{proof} The claim is straightforward for star edges. For an original edge $e$ the weight in $\cBb$ is $\deg(f)+\deg(f')-d-2$, where $f$ and $f'$ are the faces of $\Gb$ incident to $e$. The cycle of $\Gb$ surrounding $f\cup f'$ has length $\deg(f)+\deg(f')-2$, hence this quantity is at least $d+1$ by Claim~\ref{claim:still-adapted}.
%Since $\Gb$ has is $(d+1)$-adapted, one has $\deg(f)+\deg(f')+2\geq d+1$ because the left-hand side is the length of the cycle of $\Gb$ surrounding $f\cup f'$. 
\end{proof}

Recall that a \emph{positive path} of a weighted orientation is a directed path of the underlying graph such that every arc on that path is positively weighted.
%We say that an inner vertex $v$ of $\hGb$ is \emph{co-accessible} in $\cBb$ there exists a directed path of $\cBb$ starting at an outer vertex and ending at $v$.
We say that $\cBb$ is \emph{co-accessible} if for every inner vertex~$v$ of $\hGb$ there exists a positive path of $\cBb$ starting at an outer vertex and ending at~$v$.




\begin{claim}\label{claim:co-accessible}
The weighted orientation $\cBb$ of $\hGb$ is \emph{co-accessible}.
\end{claim}

%% \ob{
%% \begin{proof} 
%% It suffices to show that every original inner vertex of $\Gb^+$ of $\hGb$ there exists a positive path of $\bAb$ starting at an outer vertex and ending at $v$. 
%% %It suffices to show that every original inner vertex of $\hGb$ is co-accessible (since it readily implies that star vertices are co-accessible as well).
%% Suppose for contradiction that no such path exist for an original inner vertex~$v$. Let $U$ be the set of original vertices $u$ of $\Gb^+$ such that there exists a positive path of $\bAb$ starting at $u$ and ending at $v$. We consider the open set $S$ made of the vertices in $U$, and the interior of the edges and faces incident to a vertex in $U$. By assumption $U$ does not contain any outer vertex, hence $S$ is finite and we consider the cycle $C$ of $\Gb$ which is the outer contour of $S$. 
%% The restriction of $\bAb$ to the interior of $C$ satisfies Conditions (A1) and (A2) of $d$-GS orientations, hence by Lemma~\ref{lem:ingoing-weight-angular}, the total weight $\om(C)$ of the arcs inside $C$ with initial vertex on $C$ is $\ell(C')-d-\sum_{a\in C}(d-\deg(f_a))$, where $\ell(C)$ is the length of $C$ and $f_a$ is the face in $S$ incident to the arc $a$. By Claim~\ref{claim:still-adapted}, we have $\ell(C)\geq d+1$, hence
%% $$\om(C)>\sum_{a\in C}(d-\deg(f_a)).$$
%% Recall that for all arc $a$ in $C$ the weight of the star vertex $v_{f_a}$ and the incident edges is $d-\deg(f_a)$. Observe also from the definition of $S$ that there cannot be an edge in the interior of $C$ with both endpoint on $C$, nor a face inside $C$ whose interior disconnects the interior of $C$. 
%% Hence the above inequality readily implies that either (i) there is an original arc $a'$ inside $S$ with positive weight having initial vertex on $C$, or (ii) there is $a\in C$ such that there is a star arc $a''$ with positive weight with initial vertex $v_{f_a}$ and terminal vertex not on $C$. In case (i) the arc $a'$ has terminal vertex in $U$, hence its initial vertex should be in $U$ as well, which is a contradiction. In case (ii) there is an arc from $C$ to $v_{f_a}$ with positive weight, which together with the arc $a''$ forms a positive path from $C$ to $U$, which also gives a contradiction.
%% \end{proof}
%% }

\begin{proof} 
It suffices to show that, for every original inner vertex of $\Gb^+$, there exists a positive path of $\cBb$ starting at an outer vertex and ending at $v$. 
%It suffices to show that every original inner vertex of $\hGb$ is co-accessible (since it readily implies that star vertices are co-accessible as well).
Suppose for contradiction that no such path exists for an original inner vertex~$v$. Let $U$ be the set of original vertices $u$ of $\Gb^+$ such that there exists a positive path of $\cBb$ starting at $u$ and ending at $v$. It is not difficult to see that the submap of $\Gb$ induced by the vertices in $U$ is connected. 
We consider the open set $S$ made of the vertices in $U$, and the interior of the edges of $\Gb$ and faces of $\Gb$ incident to a vertex in $U$. By assumption $U$ does not contain any outer vertex, hence $S$ is finite and we consider the cycle $C$ of $\Gb$ which is the outer contour of $S$. Note that the vertices on $C$ are not in $U$. 
The restriction of $\cBb$ to the interior of $C$ satisfies Conditions (A1) and (A2) of $d$-GS angular orientations, hence by Lemma~\ref{lem:ingoing-weight-angular}, the total weight $\om(C)$ of the arcs inside $C$ with initial vertex on $C$ is $\ell(C)-d-\sum_{a\in C}(d-\deg(f_a))$, where $\ell(C)$ is the length of $C$ and $f_a$ is the face of $\Gb$ in $S$ incident to the arc $a$. By Claim~\ref{claim:still-adapted}, we have $\ell(C)\geq d+1$, hence
$$\om(C)>\sum_{a\in C}(d-\deg(f_a)).$$
%The contour $C$ is not necessarily simple, but by ``cutting along $C$'' one would get a simple cycle $C'$ enclosing $S$. We consider the region $S'$ inside $C'$ (which may be larger than $S$ if $S$ is not simply connected). 
%The restriction of $\bAb$ to the interior of $C'$ satisfies Conditions (A1) and (A2) of $d$-GS orientations, hence by Lemma~\ref{lem:ingoing-weight-angular}, the total weight $\om(C)$ of the arcs inside $C'$ with initial vertex on $C'$ is $\ell(C')-d-\sum_{e\in C'}(d-\deg(f_e))$, where $\ell(C')$ is the length of $C'$ and $f_e$ is the face in $S$ incident to $e$. By Claim~\ref{claim:still-adapted}, we have $\ell(C')\geq d+1$, hence
%$$\om(C)>\sum_{e\in C'}(d-\deg(f_e)).$$
%Recall that for all $e$ in $C'$ the weight of the star vertex $v_{f_e}$ and the incident edges is $d-\deg(f_e)$. Observe also from the definition of $S$ that there cannot be an edge in the interior of $C$ with both endpoint on $C$, nor a face inside $C$ whose interior disconnects the interior of $C$. 
Recall that for any arc $a$ in $C$, the weight of the star vertex $v_{f_a}$ is $d-\deg(f_a)$, which is also the weight of its incident edges. Observe also from the definition of $S$ that there cannot be an edge of $\Gb$ in the interior of $C$ with both endpoints on $C$, nor a face of $\Gb$ inside $C$ whose interior disconnects the interior of $C$. 
Hence the above inequality readily implies that either (i) there is an original arc $a'$ inside $S$ with positive weight having initial vertex on $C$, or (ii) there is $a\in C$ such that there is a star arc $a''$ with positive weight with initial vertex $v_{f_a}$ and terminal vertex not on $C$. In case (i) the arc $a'$ has terminal vertex in $U$, hence its initial vertex should be in $U$ as well, which is a contradiction. In case (ii) there is an arc from $C$ to $v_{f_a}$ with positive weight, which together with the arc $a''$ forms a positive path from $C$ to $U$, which also gives a contradiction.
\end{proof}



Since $\cBb$ is co-accessible, there exists a spanning tree $T$ of $\hGb$ satisfying the following conditions:
\begin{compactitem}
\item $T$ contains all the outer edges of $\hGb$ except $\{v_1,v_2\}$, % and we take $v_1$ to be its root vertex,
\item taking $v_1$ as the root of $T$, for every inner edge $e$ of $\hGb$ belonging to the tree $T$, the arc of $e$ oriented from parent to child in $T$ is positively weighted in $\cBb$.
\end{compactitem}

We will now use $\cBb$ and $T$ to define a weighted orientation ${\hAb}$ of the angular map $\hGb^+$.
Recall from Claim~\ref{claim:inside-face} that there is a bijection $\varphi$ between the edges of $\hGb\setminus T$ and the inner faces of $\hGb$. For each inner face $f$ of $\hGb$, we consider the corresponding edge $e=\varphi^{-1}(f)$. By Claim~\ref{claim:positive-edges}, the weight of $e$ in $\cBb$ is positive and we pick an arc $a_f$ of $e$ with positive weight. Let $u_f$ be the terminal vertex of $a_f$. 
With this notation, we define the weighted orientation ${\hAb}$ of the inner edges of $\hGb^+$ as follows.
\begin{compactitem}
\item For an inner face $f$ of $\hGb$, the star edges of $\Gb^+$ incident to the star vertex $v_f$ have weight~1 and are oriented as follows: the edge $\{v_f,u_f\}$ is oriented toward $u_f$ (i.e. has weight 1 in this direction), while the other edges are oriented toward $v_f$.
\item For an original inner arc $a$ of $\hGb^+$, the weight $\hom_a$ of $a$ in ${\hAb}$ is equal to $\om_a-\eps_a$, where $\om_a$ is the weight of $a$ in $\cBb$ and $\eps_a=1$ if either $a=a_f$ for some inner face $f$ of $\Gb$, or if $a$ is in $T$ and oriented from parent to child (for $T$ rooted at the outer vertex $v_1$), and $\eps_a=0$ otherwise.
\end{compactitem}

Note that all the arc weights in ${\hAb}$ are non-negative. For an edge or vertex $x$ of $\hGb$, let $\om(x)$ and $\hom(x)$ be their weight in $\cBb$ and ${\hAb}$ respectively. It follows directly from the definition that for every inner edge $e$ of $\hGb$, one has $\hom(e)=\om(e)-1.$ 
We also claim that for every inner vertex $v$ of $\hGb$, one has $\hom(v)=\om(v)+1$. To show this, let us consider the set $\toward(v)$ of arcs of $\hGb$ having terminal vertex $v$, and the number $n_v$ of arcs in $\toward(v)$ of the form $a_f$ (equivalently, $n_v$ is the number of inner faces $f$ of $\hGb$ such that $u_f=v$). With this notation, the contribution of star edges to $\hom(v)$ is $\deg(v)-n_v$, while the contribution of original edges to $\hom(v)$ is $\om(v)-\eps_v$, where $\eps_v=\sum_{a\in \toward(v)}\eps_a=\deg(v)-1-n_v$.


Next, we use the orientation ${\hAb}$ of $\hGb^+$ to define an orientation ${\cAb}$ of $\Gb^+$. 
Let us call \emph{small triangles} of $\Gb^+$ the inner faces (of degree 3) of the angular map $\Gb^+$ incident to star vertices of degree less than~$d$ (see Figure~\ref{fig:existence-proof-maps}). Observe that $\hGb^+$ is obtained from $\Gb^+$ by placing a vertex in each small triangle of $\Gb^+$ and connecting it to the three incident vertices of $\Gb^+$. We call \emph{small} the vertices and edges of $\hGb^+$ which are in the small triangles of $\Gb^+$. 

By contracting all the small edges of $\hGb^+$ incident to star vertices of $\Gb^+$ one obtains a plane map $\tGb^+$ closely related to $\Gb^+$: precisely, $\tGb^+$ is the same as $\Gb^+$ except that for every star edge $e$ incident to a star vertex of degree less than $d$ one has 2 additional small edges $e_\ell,e_r$ with the same endpoint as $e$ ($e_\ell$ and $e_r$ are on the left and right of $e$ respectively). This is represented in Figure~\ref{fig:existence-proof-construct}(a).
%Let ${\tilde \cAb}^+$ be the weighted orientation of ${\tilde \Gb}^+$ obtained from ${\hAb}$ by contracting the the small edges of $\hGb^+$ incident to star vertices of $\Gb^+$. We define ${\cAb}$ as the weighted orientation of $\Gb^+$ obtained from ${\tilde \cAb}^+$ by defining the 
We define $\cAb'$ as the weighted orientation of $\Gb^+$ obtained from ${\hAb}$ by contracting the small edges of $\hGb^+$ incident to star vertices of $\Gb^+$: precisely, the weights in $\cAb'$ are the same as in $\hAb$ except that for every star edge $e$ incident to a star vertex of degree less than $d$, the weights of the arcs in $e$ are taken as the sum of the weights in $\hAb$ of the corresponding arcs in $e$, $e_\ell$ and $e_r$.

 
\fig{width=.9\linewidth}{existence-proof-construct}{(a) Contracting the small edges incident to a star vertex of $\Gb^+$. (b) Getting from the orientation $\cAb$ of $\Gb^+$ to the orientation $\cA$ of $G^+$ (situation inside a copy of $X_d$).}


\begin{claim}\label{claim:final-weights}
The weighted orientation $\cAb'$ of $\Gb^+$ satisfies the following properties:
\begin{compactitem}
\item[(i)] every original inner vertex has outgoing weight $d+1$,
\item[(ii)] every original inner edge $e$ has weight $\deg(f)+\deg(f')-d-3$, where $f$ and $f'$ are the faces of $\Gb$ incident to $e$,
\item[(iii)] every star vertex $v_f$ has outgoing weight $d+1-\deg(f)$,
\item[(iv)] every star edge $e$ incident to the star vertex $v_f$ has weight $d+1-\deg(f)$.
\end{compactitem}
\end{claim}

\begin{proof} Recall that the weight of a vertex or edge $x$ in ${\cBb}$ and ${\hAb}$ is denoted by $\om(x)$ and $\hom(x)$ respectively.\\
(i) The weight of an original vertex $v$ in $\cAb'$ is $\hom(v)=\om(v)+1=d+1$.\\
(ii) The weight of an original inner edge $e$ in $\cAb'$ is $\hom(e)=\om(e)-1=\deg(f)+\deg(f')-d-3$.\\
(iii) If the inner face $f$ of $\Gb$ has degree $d$, then the weight of $v_f$ in $\cAb'$ is $1=d+1-\deg(f)$. If the inner face $f$ of $\Gb$ has degree less than $d$, then it is easy to see that the weight of $v_f$ in $\cAb'$ is equal to $\hom(v_f)$, hence is equal to $\om(v_f)+1=d+1-\deg(f)$.\\
(iv) If the inner face $f$ of $\Gb$ has degree $d$, then the weight of the star edge $e$ in $\cAb'$ is $1=d+1-\deg(f)$. If the inner face $f$ of $\Gb$ has degree less than $d$, then it is easy to see that the weight of $e$ in $\cAb'$ is $\hom(e)+2=\om(e)+1=d+1-\deg(f)$.
\end{proof}

By Claim~\ref{claim:final-weights}, the orientation $\cAb'$ satisfies Conditions (A1) and (A2) of $(d+1)$-GS angular orientations of $\Gb$. 

In order to show that $\cAb'$ can be modified to satisfy Condition~(A0), %the remaining conditions of Definition~\ref{def:quasiAngular}
  we prove the following lemma. %We now examine Condition (A0).


\begin{lemma}\label{lem:conditions_A_prime}
In the orientation $\cA_\bullet'$, we call \emph{border star vertices} those in faces of $\Gb$ incident to at least one outer edge. 
Then any arc starting at an outer vertex has weight $0$ if it does not end at a border star vertex,  
%, or it ends at an edge-vertex that is adjacent to a border star vertex. 
and any arc starting at a border star vertex has weight $0$ if it ends at an inner (original) vertex. 
Finally, for every border star vertex $v_f$, the outer neighbours  of $v_f$ are consecutive along the outer face contour.   
\end{lemma}
\begin{proof}
Let $C$ be the outer cycle of $G$.  Lemma~\ob{\ref{lem:ingoing-weight-angular}} %\ref{lem:ingoing-weight-quasi-angular} 
gives
 $\inweight(C)=\sum_{i=1}^{d+1}(d+1-\deg(f_i))$, where $f_i$ is the inner face incident to the outer edge $(v_{i-1},v_i)$. 
Let $S$ be the total weight  of arcs from border star vertices to inner vertices. 
Since Conditions (A1) and (A2) hold, the contribution to $\inweight(C)$ of the arcs from outer vertices to border star vertices is at least  $S+\sum_{i=1}^{d+1}(d+1-\deg(f_i))$, with equality if and only if every border star vertex $v_f$ has its outer neighbours consecutive along the outer face contour (which means that the number of outer vertices incident to $f$ is one more than the number of outer edges incident to $f$). 
Hence, the total weight of the arcs that start at an outer vertex and do not end at a border star vertex is at most $-S$. Hence, $S=0$, giving the first two statement, and moreover the above inequality has to be tight, giving the third statement.
\end{proof}
To turn $\cA_\bullet'$ into a $(d+1)$-GS angular orientation $\cA_{\bullet}$, we modify some arc weights in the neighborhood of the outer face, keeping the weights of edges and of inner vertices unchanged, as follows. 
For each edge $(v_i,v_{f_i})$, with $f_i$ the inner face of $G_\bullet$ incident to $(v_{i-1},v_i)$,   
we put all the weight on the arc out of $v_i$; and if $f_{i+1}\neq f_i$, we put all the weight of the edge $(v_i,v_{f_{i+1}})$ on the arc ending at $v_i$.  
With these modifications, and given Lemma~\ref{lem:conditions_A_prime}, one easily checks that all conditions of (d+1)-GS angular orientations %Definition~\ref{def:quasiAngular}
 are now satisfied.




Finally, we construct from $\cAb$ a $(d+1)$-GS angular orientation $\cA$ of $G$. Recall that $\Gb$ is obtained from $G$ by adding a copy of $X_d$ in each inner face of degree $d+1$. For each copy of $X_d$, the weighted orientation $\cAb$ restricted to the interior of $X_d$ satisfies Conditions (A1) and (A2) of $(d+1)$-GS angular orientations of $X_d$. Thus, by Lemma~\ref{lem:ingoing-weight-angular}, the total weight $W$ of the arcs strictly inside $X_d$ having initial vertex an outer vertex of $X_d$ satisfies $W=d+1$. 
Let us call \emph{border faces} of $X_d$ the $d+1$ inner faces of $X_d$ that share an edge with its outer face. The border star vertices of $X_d$ are the star vertices corresponding to the border faces, and the \emph{border star edges} of $X_d$ are the star edges connecting a border star vertex to an outer vertex (there are two such edges incident to each border star vertex). 
%The \emph{border star edges} of $X_d$ the star edges of $X_d^+$ which are incident to the outer vertices of $X_d$, and \emph{border star vertices} the incident star edges. 
By definition, border star vertices and border star edges have weight 1 in $\cAb$. Hence, for each of the $d+1$ border star vertices, the contribution to $W$ of the two incident border star edges is in $\{1,2\}$. Since $W=d+1$ we conclude that this contribution is exactly $1$ for each border star vertex, and that $W$ has no other contribution. 

%Hence, for every border star vertex $s$, there is exactly one arc with weight 1 whose terminal vertex is $s$ and initial vertex is one of the outer vertices of $X_d$.
%Hence the only arcs with positive weight which are strictly inside $X_d$ and whose initial vertex is an outer vertex of $X_d$ belong to the border star edges. Moreover, every border star vertex has one ingoing border star edge and one outgoing border star edge. 

Consider the following operations on $\Gb^+$ and $\cAb$, which are represented in Figure~\ref{fig:existence-proof-construct}(b):
\begin{compactenum}
\item Delete all the non-border vertices and edges from every copy of $X_d$. 
\item Contract one incident border star edge for each border star edge.
\item Add a star vertex and star edges of weight 0 in each face of degree $d+1$ previously containing a copy of $X_d$.
\end{compactenum}
By the above, these operations do not affect the weight of the vertices of $G$ (hence they all have weight $d+1$). The remaining border edges are parallel to some original edges of $G$. For each original inner arc $a$ of $G$, we add to the weight of $a$ in $\cAb$ the weight of the parallel border arcs with the same initial and terminal vertices as $a$. Finally we delete all border edges and obtain the map $G^+$ endowed with a weighted orientation $\cA$. It is easy to check that $\cA$ is a $(d+1)$-angular orientation $\cA$ of $G$. This completes the proof of the existence of a $(d+1)$-GS angular orientation by induction.
 


The above process for getting a $(d+1)$-GS angular orientation of $G$ from a $d$-GS angular orientation of $\bGb$ is constructive and can easily be translated into an algorithm working in linear time in the number of vertices of $\bGb$. Since the number of vertices of $\bGb$ is linear in the number of vertices of $G$, and since the induction hypothesis ensures that a $d$-GS angular orientation of $\bGb$ can be computed in linear time, we conclude that a $(d+1)$-GS angular orientation of $G$ can be constructed in linear time.


\subsection{Case of maps with multiple edges}
In this subsection we complete the proof of Theorem~\ref{thm:main}. The existence of a $d$-GS angular orientation has been established for $d$-adapted maps without multiple edges. Let us now consider a $d$-adapted map $G$ with some multiple edges. 
 

Since $G$ is $d$-adapted, any cycle made by 2 parallel edges must be facial. By contracting the faces of degree 2 of $G$ into a single edge, one obtains a $d$-adapted map $G'$ without multiple edges. Let us call \emph{digons} the faces of $G$ of degree 2, and \emph{digon edges} the corresponding edges of $G'$. As established above, $G'$ admits a $d$-GS angular orientation $\cA'$. Since $G$ is $d$-adapted, any digon edge of $G'$ is incident to two faces of degree $d$. By definition of angular orientations, the digon edges of $G'$ have weight $d-2$. We construct from $\cA'$ an angular orientation $\cA$ of $G$ as indicated in Figure~\ref{fig:digon-opening}.
It is easy to see that the resulting orientation is a $d$-GS angular orientation. Moreover the above construction of $\cA$ is performed in linear time, which completes the proof.

\fig{width=.9\linewidth}{digon-opening}{The construction of the angular orientation $\cA$ starting from $\cA'$. The weights of the arcs in $\cA$ and $\cA'$ are the same except for digon edges of $G'$ which are transformed as indicated in this figure. The transformation for an inner digon edge is indicated on the left (the weights $\om$ and $\om'$ sum to $d-2$), while the transformation of an outer digon edge is indicated on the right. The two edges of $G$ incident to the digon have weight 0.}


%\bibliography{biblio-Schnyder}
%\end{document}
