%\documentclass{amsart}
%\input{defs.tex}
%\begin{document}
%\section{Lattice structure of $d$-GS structures on a fixed $d$-adapted map}\label{sec:lattice}

In this section we show that the set of grand-Schnyder structures on a fixed $d$-adapted map has the structure of a distributive lattice, and that the covering relations (flip/flop operations) have a simple characterization. Possible applications are efficient algorithms for the exhaustive generation and uniform random generation  of $d$-GS structures on a fixed $d$-adapted map (as explained in Remark~\ref{rk:random_gen}). For instance, the exhaustive generation of transversal structures (equivalently, 4-GS structures for triangulations of the square), was used in~\cite{eppstein2012area} for the construction of certain rectangular tilings with prescribed tile areas. 
%exhaustive generation has been used to generate, %when possible, certain ``cartogram representations'' with prescribed areas for regions~\cite{eppstein2012area}. 
%where the areas of regions can be arbitrarily prescribed~\cite{eppstein2012area}. 

For bipartite $d$-adapted maps, the class of bipartite-grand-Schnyder structures also has a distributive lattice structure, and the results are similar.


\subsection{Lattice structure for orientations with prescribed weights}\label{sec:general-uld-framework}
In this subsection we recall some definitions and results from~\cite{felsner2009uld} which underlie the lattice results for grand-Schnyder structures.
Let $M$ be a plane map, let $V$ be its vertex-set, and let be $E$ its edge-set. Let $\alpha:V\to \mathbb{N}$ and $\beta:E\to\mathbb{N}$ be functions. 
An \emph{$\alpha/\beta$-orientation} of $M$ is a weighted orientation of $M$ 
such that every vertex $v\in V$ has outgoing weight $\alpha(v)$, and every edge $e\in E$ has weight $\beta(e)$. The pair $(\alpha,\beta)$ is called \emph{feasible} if 
$M$ admits at least one $\alpha/\beta$-orientation. In that case, letting $\bX$ be the set of $\ab$-orientations of $M$, it follows from~\cite[Theo.6]{felsner2009uld} (via duality, as explained in~\cite[Lem.14]{OB-EF:Schnyder}) that $\bX$ carries the structure of a distributive lattice, which we now describe. 

%A \emph{directed walk} in a weighted orientation is a sequence of arcs of positive weights, such that the terminal vertex of every arc coincides with the initial vertex of the next arc along %the sequence. A \emph{closed directed walk} is a directed walk that ends at the vertex it starts from, in which case the arcs are considered as cyclically ordered.  
%A \emph{directed cycle} is a closed directed walk that does not visit twice a same vertex, in which case it is said to be clockwise (resp. counterclockwise) if its interior is on its right (resp. %left). 

Recall that a \emph{positive cycle} in a weighted orientation is a cycle such that each arc of the cycle has positive weight. 
The \emph{push} of a positive cycle is the operation of decreasing by $1$ the weights of the arcs of the cycle, and increasing by $1$ the weights of their opposite arcs. Any $\alpha/\beta$-orientation can be obtained from another by a sequence of push. 
Moreover, the set $\bX$ of $\alpha/\beta$-orientations can be endowed with a lattice order $\preceq$ defined as follows: for two orientations $\cX_1,\cX_2$ in $\bX$, we have $\cX_1\preceq \cX_2$ if and only if $\cX_2$ can be obtained from $\cX_1$ by a sequence of push-operations at counterclockwise cycles. %OB: removed (symmetrically, $\cX_1$ can be obtained from $\cX_2$ by a sequence of push-operations at clockwise cycles). 
The minimal (resp. maximal) element $\cX_{\mathrm{min}}$ (resp. $\cX_{\mathrm{max}}$) in the lattice is the unique $\ab$-orientation with no clockwise positive cycle
(resp. no counterclockwise positive cycle). 


A \emph{flip} (resp. \emph{flop}) is a push corresponding to a covering downward (resp. upward) relation in $\bX$. 
In other words, a flip (resp. flop) is a push on a clockwise (resp. counterclockwise) positive cycle, which cannot be realized by a sequence of several pushes on clockwise (resp. counterclockwise) positive cycles. Let $C$ be a simple cycle of $M$. A \emph{chordal path} for $C$ in a weighted orientation is a positive path staying strictly inside $C$ and such that its initial and terminal vertex are distinct and both on $C$.
We call a simple cycle of $M$ \emph{essential} if it has no chordal path in an $\alpha/\beta$-orientation (the existence of a chordal path does not depend on the $\alpha/\beta$-orientation considered since it is preserved by a cycle push). 
%\OB{I wrote the following about the characterization of essential cycles: not sure if we need to write more.}
It is not hard to see that the flip/flop operations are exactly the pushes on essential cycles. Indeed a push on a clockwise (resp. counterclockwise) non-essential cycle can be performed by a sequence of 2 pushes on simple clockwise (resp. counterclockwise) cycles, while a push on a clockwise (resp. counterclockwise) essential cycle cannot be performed by a sequence of several pushes on clockwise (resp.  counterclockwise) simple cycles.\footnote{We mention that the definition of essential cycles in \cite{Felsner:lattice} is slightly incorrect: it forbids chordal paths starting and ending at the same vertex of $C$, which is too restrictive.}

%, which are the cycles such that there is no positive path inside the cycle having its initial vertex and terminal vertex on the cycle.
%\OB{I think the definition of essential look weird: it seems to depend on the $\alpha/\beta$-orientation considered. But in truth the fact that there is a chord from u to v inside the cycle is only a function of $\alpha,\beta$. Should we mention this fact to make the discussion clearer?}

%In $\bX$ it corresponds to the push operations on directed cycles that cannot be decomposed into several push operations. 
% These are push operations on so-called \emph{essential cycles}, which are the directed cycles having no chordal path (i.e., a positive path inside the cycle, having its initial vertex and terminal vertex on the cycle). 

The distributive lattice property is established by associating to each element $\cX\in\bX$ a ``potential-vector'' (see~\cite[Sec.2.3]{Felsner:lattice} and~\cite[Sec.3]{felsner2009uld}), which is an integer vector indicating for each essential cycle $C$ how many times $C$ is pushed in any sequence of flops from $\cX_{\mathrm{min}}$ to $\cX$; it can be shown that the constraints to be satisfied by such vectors are stable under componentwise min and componentwise max, and this defines the join and meet operation in the lattice $\bX$. 

%% \OB{The following needs to be changed:}
%% We say that a weighted orientation of a plane map $M$ is \emph{accessible} if for every inner vertex $v$ there is a positive path starting at $v$ and ending at an outer vertex. It is easy to see (using pushes) that if an $\alpha/\beta$-orientation of $M$ is accessible, then every $\alpha/\beta$-orientation is accessible.
%% Given a simple cycle $C$ of $M$, we call inward weight of $C$ in an $\alpha/\beta$-orientation the sum of the weight of arcs with initial vertex on $C$ and lying strictly inside $C$. It is easy to see that the inward weight of $C$ is the same for all $\alpha/\beta$-orientations. Moreover we have the following lemma.
%% \begin{lemma}\label{lem:essential-for-accessible}
%% If the $\alpha/\beta$-orientations of $M$ are accessible, then the essential cycles of $\bX$ are the simple cycles with inward weight 0.
%% \end{lemma}
%% \begin{proof} 
%% %If a cycle $C$ is not essential, then it has a directed path starting and ending at $C$ and staying inside $C$ so the inward weight is non-zero. Conversely, 
%% If the inward weight is 0, then there can be no positive path starting and ending at $C$ and staying inside $C$, so the cycle is essential. Conversely, if the inward weight is non zero, there is a positive arc $a=(u,v)$ strictly inside the cycle, with $u$ on the cycle. Since there is a positive path from $v$ to an outer vertex, there exists a positive path starting with $a$ that starts and end on $C$, so $C$ is not essential.
%% \end{proof}

Let us finally mention an easy extension to the context of $\ab$-orientations of plane maps with \emph{frozen edges}, that is, with a subset of edges whose arc-weights are fixed. In that context, the set of $\ab$-orientations (respecting the frozen edges conditions) is also a distributive lattice (one can argue by turning to $0$ the weights of arcs on frozen edges, and updating the functions $\alpha$ and $\beta$ accordingly), with the push operations restricted to positive cycles having no frozen edge. The minimal (resp. maximal) element in the lattice is the unique $\ab$-orientation such that all the positive clockwise (resp. counterclockwise) cycles have at least one frozen edge. 
%Essential cycles correspond to cycles $C$ such that there is no unfrozen positive path inside of $C$ starting and ending on $C$.
Essential cycles correspond to cycles $C$ such that any chordal path of $C$ has at least one frozen edge.






%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Lattice for grand-Schnyder structures}\label{sec:lattice_GS}
Let $G$ be a $d$-adapted map, and let $G^+$ be its angular map. 
Let $V_{G^+}$ and $E_{G^+}$ be the vertex-set and edge-set of $G^+$. For $i \in [d]$, let $s_i$ be the star vertex for the inner face of $G$ which is incident to the outer edge $(v_{i-1},v_{i})$, and let $\delta_i$ be its degree. 
Let $\alpha:V_{G^+}\to\mathbb{N}$ be the function such that:
\begin{itemize}
\item
for all $i\in[d]$, $\alpha(v_i)=d-\delta_i$,
\item
for $v$ an inner vertex of $G$, $\alpha(v)=d$,
\item
for $v$ a star vertex of degree $k$, $\alpha(v)=d-k$.
\end{itemize}
Let $\beta:E_{G^+}\to\mathbb{N}$ be the function such that:
\begin{itemize}
\item
for $e$ an outer edge, $\beta(e)=0$,
\item
for $e$ a star edge incident to a star vertex of degree $k$, $\beta(e)=d-k$,
\item
for $e$ an original inner edge of $G$ whose incident faces in $G$ have degrees $k,k'$, $\beta(e)=k+k'-d-2$.
\end{itemize} 
Declare the \emph{frozen edges} of $G^+$ as all the edges incident to outer vertices, where for all $i\in[d]$ the arc from $v_i$ to $s_i$ has weight $d-\delta_i$ (and the opposite arc has weight 0) and all the other arcs out of $v_i$ have weight 0 (and the opposite arcs have the weight required by $\beta$).
Then it follows from Definition~\ref{def:angular} and Remark~\ref{rk:frozen} that the $d$-GS angular orientations of $G^+$ are exactly the $\ab$-orientations with these frozen edges.

%Declare the \emph{frozen edges} of $G^+$ as the edges $(v_i,s_i)$ for $1\leq i\leq d$, where the weight on the arc from $v_i$ is $d-\delta_i$, and the weight on the opposite arc is $0$. Then it follows from Definition~\ref{def:angular} and Remark~\ref{rk:frozen} that the $d$-GS angular orientations of $G^+$ are exactly the $\ab$-orientations with these frozen edges (indeed Condition (A0) is implied by the requirement $\alpha(v_i)=d-\delta_i$).

Thus, by the framework recalled in Section~\ref{sec:general-uld-framework}, the set $\bA_G$ of $d$-GS angular orientations of a $d$-adapted map $G$ carries the structure of a distributive lattice, where the order $\preceq$ on $\bA_G$ is defined by declaring $\cA\preceq \cA'$ if $\cA'$ can be obtained from $\cA$ by a sequence of push-operations at counterclockwise cycles not incident to outer vertices. Our aim is now to characterize the covering relation for this lattice, that is, to characterize the flip and flop operations. % $d$-GS angular orientations. 

 Let $G$ be a $d$-map. A simple cycle $C$ of $G^+$ is called \emph{compatible} if it is simple, does not visit star-vertices of degree~$d$, and for every original edge $e$ belonging to $C$ the star vertex incident to the inner face of $G^+$ incident to $e$ and lying inside $C$ has degree $d$.
 For a cycle $C$ of $G^+$, the \emph{enclosing cycle} $\hC$ of $C$ is the cycle of original edges 
 (possibly not forming a simple cycle, but with simply connected interior) ``just outside" of $C$, that is, $\hC$ visits the original edges visited by $C$, and for each black vertex $u$ on $C$, $\hC$ passes by the original edges that are opposite to $u$ on the contours of the triangular faces incident to $u$ in the exterior of $C$, as shown in Figure~\ref{fig:comp_cycle}. Note that $\hC$ cannot be the boundary 
 of a face, hence has length at least $d$. The length of $\hC$ is called the \emph{enclosing length} of $C$. 
 
 \begin{figure}[h!]
\begin{center}
\includegraphics[width=0.6\linewidth]{compatible_cycle}
\end{center} 
\caption{Left: a compatible cycle $C$ (shown in bold lines) on the angular map of a 5-map. Right: the same angular map, where the enclosing cycle $\hC$ of $C$ is shown in bold.}
\label{fig:comp_cycle} 
\end{figure}


Our main result is the following.

\begin{thm}\label{thm:flip}
For every $d$-adapted map $G$, the set of $d$-GS angular orientations on $G$ has the structure of a distributive lattice by the framework recalled in Section~\ref{sec:general-uld-framework}. A flip (resp. flop) for this lattice consists in pushing a clockwise (resp. counterclockwise) cycle not incident to outer vertices which is either
 \begin{itemize}
\item[(i)] the contour of an inner face of $G^+$, or %(made of a star vertex and two original vertices, or
 \item[(ii)] a compatible cycle of enclosing length $d$.
 \end{itemize}
\end{thm}

We will prove Theorem~\ref{thm:flip} in Section~\ref{sec:proof-lattice}. 

\begin{remark}\label{rk:flip_corner}
Via the bijective correspondences of Section~\ref{sec:statements}, the other incarnations of $d$-GS structures of $G$ inherit an isomorphic lattice structure. 

We first describe the covering relations in the corner labeling incarnation (see Figure~\ref{fig:flip_example}).  
For a $d$-cycle $C$ of $G$, a \emph{special corner} for $C$ is a corner $c$ of $G$ inside $C$ incident to a vertex $v\in C$, in a face of $G$ of degree smaller than $d$, and such that the edge of $G$ preceding $c$ in clockwise order around $v$ is on $C$. 
It is easy to check that, via the bijections, a flip (resp. flop) operation consists in either (i) decreasing (resp. increasing) by $1$ modulo $d$ the label of a single corner, or (ii) decreasing (resp. increasing) by $1$ modulo $d$ the labels inside a $d$-cycle $C$ of $G$ except for the special corners of $C$ whose labels are left unchanged. These operations correspond to a push on an essential cycle of type (i) or of type (ii) respectively in Theorem~\ref{thm:flip}, and they are only allowed if the resulting corner labeling is a valid $d$-GS labeling. % (in terms of orientations this corresponds to the pushed cycle being positive). 

We now describe the covering relations in terms of arc labelings, in the case where $G$ is edge-tight. Note that when $G$ is edge-tight all the essential cycles are of type (ii) since original edges have weight $0$ in $d$-GS angular orientations. In the incarnation as $d$-GS arc labelings, a flip (resp. flop) consists in decreasing (resp. increasing) by $1$ modulo $d$ all the arc labels inside a $d$-cycle $C$ of $G$ (of course, such an operation is only allowed if the the resulting arc labeling is a valid $d$-GS arc labeling). 
%% for an essential cycle of type (i)
%% Then, via the bijection, a simple verification ensures that a 
%% push of a clockwise (resp. counterclockwise) essential cycle of type (i) in Theorem~\ref{thm:flip} consists in decreasing (resp. increasing) by $1$ modulo $d$ the label of a single corner (the with the condition that the resulting corner labeling is valid (i.e., satisfies Definition~\ref{def:GS-labeling}). And a push of a clockwise (resp. counterclockwise) essential cycle of type (ii) consists in decreasing (resp. increasing) by $1$ modulo $d$ the labels inside a $d$-cycle $C$ of $G$ except for the special corners of $C$ (whose labels are left unchanged), again
%% with the condition that the resulting corner labeling is valid. Let us finally discuss the arc labeling incarnation. 
%% In the edge-tight case, all essential pushes are of type (ii) since original edges have weight $0$ in the $d$-GS angular orientations. In the incarnation as $d$-GS arc labelings, a flip (resp. flop) consists in decreasing (resp. increasing) by $1$ modulo $d$ the arc labels inside a $d$-cycle $C$ of $G$, again with the condition that the resulting arc labeling is valid (i.e., satisfies Definition~\ref{def:arcLabeling}). 
\end{remark}


 \begin{figure}[h!]
\begin{center}
\includegraphics[width=1\linewidth]{flip_example}
\end{center} 
\caption{The top row shows three $4$-GS angular orientations. The left (resp. right) one is obtained from the middle one by pushing an essential clockwise cycle of type (i) (resp. 
pushing an essential counterclockwise cycle of type (ii)), where the edges of the pushed cycle are shown bolder. 
The bottom row shows the effect of the push operations on the associated $4$-GS labelings, where the modified corner labels are colored.}
\label{fig:flip_example} 
\end{figure}

\begin{remark}
Compatible cycles of enclosing length $d$ are in 1-to-1 correspondence to the cycles of length $d$ in $G$: every cycle $\hC$ of length $d$ in $G$ is the enclosing cycle of a unique compatible cycle of enclosing length $d$. This is easy to check after observing that if a face of $G$ inside $\hC$ is incident to some edges of $\hC$ and has degree less than $d$, then the set of edges of $\hC$ incident to $f$ forms a subpath of $\hC$ (because $G$ is $d$-adapted). 
%This is due to the fact that % [SIMILAR ARGUMENT AS IN THE NECESSITY PROOF], for a cycle $\hC$ of length $d$ in $G$, and for $f$ an inner face of degree smaller than $d$ inside $\hC$ and incident with at least one edge on $\hC$, the fact that $G$ is $d$-adapted ensures that the set of edges in $f\cap C$ forms a subpath of $\hC$. 
\end{remark}



\begin{remark}\label{rk:random_gen}
Theorem~\ref{thm:flip} can be used to define an algorithm for the uniform random generation in the set $\bA_G$ of $d$-GS angular orientations on a fixed $d$-adapted map $G$.
The algorithm is based on a Markov chain with a stopping time defined using the ``coupling from the past'' method~\cite{propp1996exact}. Let us first describe the Markov chain dynamics (expressed in~\cite[Sec.2.1]{heldt2017mixing} for outdegree-constrained orientations), that is, how the next element $A'$ is randomly chosen from the current element $A\in\bA_G$. 
Given the pre-computed list $L(G)$ of essential cycles of $G^+$ (the cycles characterized in Theorem~\ref{thm:flip}), we draw a random element $C\in L(G)$ and a random sign $\sigma\in\{-,+\}$. If $\sigma\!=\!-$ (resp. $\sigma\!=\!+$), and if $C$ forms a clockwise (resp. counterclockwise) cycle, then $A'$ is obtained from $A$ by a flip (resp. flop) at $C$; otherwise $A'=A$. This yields a symmetric irreducible Markov chain, whose unique stationary distribution is the uniform one on $\bA_G$. 
An important remark is that, once $C,\sigma$ chosen, the action $A\to A'$ can be formulated as the action of a function $\Phi_{C,\sigma}:\bA_G\to\bA_G$ (one function for each element of $L(G)\times\{-,+\}$) that is monotone with respect to the lattice order (the monotonicity follows from the above mentioned encoding by potential-vectors). 
Therefore, the coupling from the past method from~\cite[Sec.2.2]{propp1996exact} can be applied to generate an element of $\bA_G$ uniformly at random.
The precomputation of $L(G)$ can be done in polynomial time by the above results, and the computation of the minimal and maximal elements of $\bA_G$ (needed for the coupling from the past) can also be done in polynomial time  (using Theorem~\ref{thm:main} and results from~\cite[Section 3]{khuller1993lattice}).
%, precisely its Lemma 3.2, Lemma 3.3, and Theorem 3.5}). 
However, as shown in~\cite{miracle2016sampling} in the case of Schnyder woods, it may happen that the coupling time is exponential for certain maps $G$.
\end{remark}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%






\subsection{Lattice for bipartite grand-Schnyder structures}
The set of $b$-BGS structures of a fixed bipartite $2b$-adapted map $G$ can also be given a lattice structure, and the results are very similar.  
First note that $b$-BGS angular orientations correspond to some $\ab$-orientations of $G^+$ with frozen edges defined as follows. Let $s_i$ (for $i\in [2b]$) be the star-vertex for the inner face of $G$ incident to $(v_{i-1},v_i)$, and let $\delta_i$ be the half-degree of $s_i$. Let $\alpha:V^+\to \NN$ and  $\beta:V^+\to \NN$ be defined as follows:
\begin{itemize}
\item
for all $i\in [2b]$,  $\alpha(v_i)=b-\delta_i$,
\item
for $v$ an inner original vertex, $\alpha(v)=b$,
\item
for $v$ a star vertex of degree $2k$, $\alpha(v)=b-k$, 
\item
for $e$ an outer edge, $\beta(e)=0$,
\item
for $e$ a star edge incident to a star vertex of degree $2k$, $\beta(e)=b-k$, 
\item
for $e$ an original inner edge of $G$, with $k,k'$ the half-degrees of the inner faces of $G$ incident to $e$,  $\beta(e)=k+k'-b-1$. 
\end{itemize}
Moreover, we declare the \emph{frozen edges} to be all the edges incident to outer vertices, where for all $i\in[d]$ the arc from $v_i$ to $s_i$ has weight $b-\delta_i$ (and the opposite arc has weight 0) and all the other arcs out of $v_i$ have weight 0 (and the opposite arcs have the weight required by $\beta$).
It follows from Definition~\ref{def:BGS-angular} and Remark \ref{rk:weight-frozen-bip} that the $b$-BGS angular orientations of $G^+$ are exactly these $\ab$-orientations with frozen edges. 
 
 \begin{thm}\label{thm:flip_bip}
For every bipartite $2b$-adapted map $G$, the set of $b$-BGS angular orientations on $G$ has the structure of a distributive lattice. The upward (resp. downward) covering relations consist in pushing a counterclockwise (resp. clockwise) simple cycle not incident to the outer vertices which is either
 \begin{itemize}
\item[(i)] 
the contour of an inner face of $G^+$, or % made of a star vertex and two original vertices, or
 \item[(ii)]
a compatible cycle of enclosing length $2b$.
 \end{itemize}
\end{thm}

The proof of Theorem~\ref{thm:flip_bip} will be given in Section~\ref{sec:proof-lattice}.



 

\begin{remark}\label{rk:flip_corner_bip}
As in Remark~\ref{rk:flip_corner}, the other incarnations of $b$-BGS structures of $G$ inherit the lattice structure via the bijections. 
In the corner labeling incarnation, a flip consists in either (i) decreasing by $2$ modulo $d=2b$ the label of a single corner, or (ii) decreasing by $2$ modulo~$d$ all the labels inside a simple $d$-cycle $C$ of $G$ except for the labels of the special corners which are left unchanged (and such an operation is allowed only if the resulting corner labeling is a  $b$-BGS labeling). 
When $G$ is edge-tight (which by Lemma~\ref{lem:degree-edge-tight} can only occur if $G$ is a quadrangulation of the hexagon or a map obtained from $2b$-angulation by opening some edges into 2-gons), only flips of type (ii) are ever valid. We call \emph{$b$-BGS arc labeling} a $2b$-GS arc labeling of $G$ whose arcs starting from black (resp. white) vertices have odd  (resp. even) label.  
In the incarnation as $b$-BGS arc labelings, a flip consists in decreasing by $2$ modulo $2b$ the arc labels inside a $2b$-cycle $C$ of $G$ (and such an operation is allowed only if the resulting arc labeling is a valid arc labeling). 
%In the corner labeling incarnation, a push of a clockwise (resp. counterclockwise) essential cycle of type (i) in Theorem~\ref{thm:flip_bip} consists in decreasing (resp. increasing) by $2$ modulo $d=2b$ the label of a single corner, with the condition that the resulting corner labeling is valid (i.e., satisfies Definition~\ref{def:BGS-labeling}). And a push of a clockwise (resp. counterclockwise) essential cycle of type (ii) consists in decreasing (resp. increasing) by $2$ modulo $d$ the labels inside a $d$-cycle $C$ of $G$ except for the special corners of $C$ (whose labels are left unchanged), again with the condition that the resulting corner labeling is valid. 
%In the edge-tight case, all essential pushes are of type (ii) since original edges have weight $0$ in the $b$-BGS angular orientations. In the incarnation as $b$-BGS arc labelings, a flip (resp. flop) consists in decreasing (resp. increasing) by $2$ modulo $2b$ the arc labels inside a $d$-cycle $C$ of $G$, with the condition that the resulting arc labeling is valid. 
\end{remark}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




\subsection{Recovering known lattices of orientations}
As we now explain, Theorem~\ref{thm:flip} provides a common generalization of the lattice structures already already known for Schnyder decompositions of $d$-angulations~\cite{OB-EF:Schnyder} and for transversal structures~\cite{Fu07b}. 
Similarly, in the bipartite setting, Theorem~\ref{thm:flip_bip} provides a common generalization of the lattice structure for even Schnyder decompositions of bipartite $2b$-angulations \cite{OB-EF:Schnyder} and the  lattice structure for  Felsner woods~\cite{Felsner:lattice}. 

\medskip

\textbf{Lattice structure for Schnyder decompositions of $d$-angulations.}
Recall from Section \ref{sec:Schnyder-decompositions} that $d$-GS angular orientations of a $d$-angulation $G$ coincide with the Schnyder decompositions $G$ as defined in \cite{OB-EF:Schnyder}. Via this correspondence, the lattice structure defined in Theorem~\ref{thm:flip} coincides with the lattice structure defined in~\cite{OB-EF:Schnyder} on Schnyder decompositions of $G$. In the particular case $d=3$, we recover the classical lattice structure defined on the set of Schnyder woods of a triangulation. Let us now fix a $d$-angulation $G$ and consider the characterization of flips given by  Theorem~\ref{thm:flip}. The compatible cycles of $G$ are the simple cycles of the original map $G$. Hence, by Theorem~\ref{thm:flip}, the essential cycles are simple cycles of $G$ of length $d$ (essential cycle of type (i) cannot occur for essential cycles, since star edges have weight $0$). 
In terms of $d$-GS labelings, a flip (resp. flop) operation consists in decreasing (resp. increasing) by $1$ modulo $d$ the labels of corners inside a $d$-cycle (note that there is no special corner, of unchanged label, inside the $d$-cycle, since all faces have degree $d$). We thus recover the lattice structure properties of~\cite[Sec.3.3]{OB-EF:Schnyder}. 


\medskip

\textbf{Lattice structure for even Schnyder decompositions of $2b$-angulations.}
As before, the lattice structure defined in  \cite{OB-EF:Schnyder} even Schnyder decompositions of a bipartite $2b$-angulation $G$ coincides with the lattice structure on $b$-BGS structures given by Theorem~\ref{thm:flip_bip} (via the identification given in Section \ref{sec:bipartite_angulations}).  By Theorem~\ref{thm:flip_bip} the essential cycles are $2b$-cycles of the original map $G$, and in the corner labeling incarnation, a downward (resp. upward) covering relation consists in decreasing (resp. increasing) by $2$ modulo $2b$ the labels of corners inside a given $2b$-cycle. This recovers the flip descriptions from \cite{OB-EF:Schnyder}.


 \begin{figure}
\begin{center}
\includegraphics[width=\linewidth]{flip_dangul}
\end{center} 
\caption{Left:  a flip/flop operation on a $5$-GS corner labeling of a pentagulation.% of girth $5$
Right: a flip/flop operation on a $3$-BGS) corner labeling of a hexangulation. %of girth $6$.
}
\label{fig:flip_flop_angulation} 
\end{figure}




\medskip

\textbf{Lattice structure for transversal structures.}
Let us now examine the lattice obtained when $G$ is a triangulation of the square.
Recall from Section \ref{sec:transversal} that the 4-GS structures of $G$ are in bijection with the transversal structures of $G$.
Via this correspondence, the lattice structure defined in Theorem~\ref{thm:flip} coincides with the lattice structure defined in~\cite{Fu07b} on the transversal structure of $G$.
Let us now consider the characterization of flips given by  Theorem~\ref{thm:flip}
In the 4-GS angular orientation of $G$, the original edges have weight~$0$, hence only the essential cycles of type (ii) can be positive.
Hence the flip/flop operations correspond to pushing a directed cycle (made of star edges) of enclosing length $4$.
%only essential cycles are enclosing length $4$ hence the directed cycles are made of star edges, and the essential ones are those of enclosing length $4$ (case (i) cannot occur for essential cycles, since original edges have weight $0$). 
In the incarnation as transversal edge-partitions, the flip/flop operations also have a nice formulation, as illustrated in the left part of Figure~\ref{fig:flip_flop_transversal}. Given a transversal edge-partition of $G$, a 4-cycle $C$ is called \emph{alternating} if the edges around $C$ are red/blue/red/blue (such a cycle is the enclosing cycle of an essential cycle in the associated GS angular orientation). 
 For such a cycle $C$ and $v\in C$, the left (resp. right) edge of $v$ is the edge on $C$ just after (resp. just before) $v$ in clockwise order around $C$. 
It is shown in~\cite{Fu07b} that only two situations can occur for the color of the edges inside $C$ and incident to $C$:
 \begin{itemize}
 \item
either every edge $e$ inside $C$ and incident to a vertex on $C$ has the color of the right edge of $v$, in which case $C$ is called a right alternating 4-cycle (it is the enclosing cycle of an essential clockwise cycle in the 4-GS angular orientation),
 \item
 or every edge $e$ inside $C$ and incident to a vertex on $C$ has the color of the left edge of $v$, in which case $C$ is called a left alternating 4-cycle (it is the enclosing cycle of an essential counterclockwise cycle in the 4-GS angular orientation).
 \end{itemize} 
Then, a flip (resp. flop) operation consists in switching the colors of all the edges inside a right (resp. left) 
alternating 4-cycle, turning it into a left (resp. right) one~\cite[Theo.2]{Fu07b}. 
This is consistent with the formulation of the flip/flop operation on $4$-GS arc labelings given in Remark~\ref{rk:flip_corner}, and the correspondence between arc labelings and transversal structures illustrated in Figure~\ref{fig:corresp_GS_transversal}. 


 \begin{figure}
\begin{center}
\includegraphics[width=\linewidth]{flip_flop_transversal}
\end{center} 
\caption{Left: a flip/flop operation on a transversal structure, corresponding to an alternating 4-cycle indicated in bold lines. Right: a flip/flop operation on a Felsner edge-coloring, corresponding to an alternating 6-cycle indicated in bold lines.}
\label{fig:flip_flop_transversal} 
\end{figure}


\medskip

\textbf{Lattice structure for Felsner woods.}
Let us lastly discuss the case where $G$ is a quadrangulation of the hexagon. 
In the 3-BGS angular orientations of $G$, the original edges have weight $0$, so that the positive cycles are made of star edges, and the essential ones are those of enclosing length $6$. 
We recover~\cite[Lem.17]{Felsner:lattice} (precisely, the identity $2k=a+6$ obtained in its proof). In the incarnation of Felsner edge-colorings, we have a formulation of the covering relations as for transversal edge-partitions, which is similar to the one given for transversal structures. This covering relation is indicated in the right side of Figure~\ref{fig:flip_flop_transversal}. In a Felsner edge-coloring, we call a 6-cycle $C$ \emph{alternating} if the colors of edges in a clockwise traversal of $C$ are red/blue/green/red/blue/green 
(these are the enclosing cycles of essential cycles in the associated $3$-BGS angular orientation). 
 For such a cycle $C$ and a vertex $v$ on $C$, the left (resp. right) edge of $v$ is the edge on $C$ just after (resp. just before) $v$ in a clockwise traversal of $C$. Then 
 two situations can occur: 
 \begin{itemize}
 \item
 every edge $e$ inside $C$ and incident to a vertex on $C$ has the color of the right edge of~$v$, in which case $C$ is called a right alternating 6-cycle (it is the enclosing cycle of an essential clockwise cycle in the 3-BGS angular orientation),
 \item
 or every edge $e$ inside $C$ and incident to a vertex on $C$ has the color of the left edge of~$v$, in which case $C$ is called a left alternating 6-cycle (it is the enclosing cycle of an essential counterclockwise cycle in the 3-BGS angular orientation).
 \end{itemize} 
A proof that only these two cases occur can be given along the same lines as in~\cite{Fu07b}: any 6-cycle $C$ is the enclosing cycle of an essential compatible cycle, and these have inward degree $0$ (see Lemma \ref{lem:compa}). Hence  (through the bijection $\Gamma$ between 3-BGS arc labelings and angular orientations of $G^+$),   at each vertex $v\in C$ the arcs inside $C$ with initial vertex $v$ all have the same color. Moreover, the fact that $C$ is left alternating (resp.  right alternating) is equivalent (under $\Gamma$) to the fact that the corresponding compatible cycle is directed, in counterclockwise (resp. clockwise) direction.

 
Then, a flip operation turns a right alternating 6-cycle into a left one, by applying $\{$red$\to$blue, blue$\to$green, green$\to$red$\}$ to the colors of the edges inside $C$; and conversely a flop operation turns a left alternating 6-cycle into a right one, by applying $\{$red$\to$green, blue$\to$red, green$\to$blue$\}$ to the colors of the edges inside $C$. Again, this is consistent with the formulation of the flip/flop operation on arc labelings given in Remark~\ref{rk:flip_corner_bip}, and the correspondence from these labelings to Felsner edge-colorings illustrated in Figure~\ref{fig:corresp_GS_transversal}. 







%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\subsection{Proof of Theorems~\ref{thm:flip} and~\ref{thm:flip_bip}}\label{sec:proof-lattice}
This subsection is devoted to the proof of Theorems~\ref{thm:flip} and~\ref{thm:flip_bip}. 
Roughly speaking, we will show that essential cycles for $d$-GS orientations need to be compatible and have ``inward weight'' 0. 
%Roughly speaking, the proof consists in showing that $d$-GS angular orientations are accessible (upon deleting star vertices of degree $d$), and then applying Lemma~\ref{lem:essential-for-accessible}. Before that we establish a counting lemma about $d$-GS orientations.
 
Let $C$ be a cycle of $G^+$ which is the contour of a simply connected finite region (equivalently, $C$ is the contour of an inner face of a connected submap of $G^+$). The \emph{inward weight} of the cycle $C$, denoted by $\inweight(C)$, is the sum of the weights of the arcs strictly inside $C$ with initial vertex on $C$.


\begin{lemma} \label{lem:ingoing-weight-angular} 
Let $G$ be a $d$-map. Let $\cA$ be a weighted orientation of the angular map $G^+$ satisfying Conditions (A1) and (A2) of $d$-GS angular orientations. 
Let $C$ be a cycle of $G$, which is the contour of a simply connected finite region. Then the inward weight of $C$ is
$$\inweight(C)=\ell(C)-d+\sum_{a\in C}(d-\deg(f_a)),$$
where $\ell(C)$ is the length of $C$, the sum is over the arcs of $C$, and for an arc $a$ of $C$ the face incident to $a$ inside $C$ is denoted by $f_a$.
\end{lemma}

\begin{proof} 
Let $V,E,F$ the set of vertices, edges and faces of $G$ strictly inside $C$. 
The total weight of the edges of $G^+$ inside $C$ is $\ds (d-2)|E|+\sum_{a\in C}(d-\deg(f_a))$.
The total weight of the vertices of $G^+$ inside $C$ is $d|V|+\sum_{f\in F}(d-\deg(f))$.
Hence, 
$$\inweight(C)=(d-2)|E|+\sum_{a\in C}(d-\deg(f_a))-d|V|-\sum_{f\in F}(d-\deg(f))$$
The Euler relation gives $|V|+|F|=|E|+1$, while the incidence relation between faces and edges gives $\sum_{f\in F}\deg(f)=2|E|+\ell(C)$. Combining these relations proves the lemma.
\end{proof}

%\SL{arc vs. edge in the preceding lemma?}

%% \begin{remark}
%% Lemma~\ref{lem:ingoing-weight-angular} can be used to prove that $d$-GS angular orientation are \emph{accessible}, that is, for every inner vertex $v$ which is not a star vertex of degree $d$ there exists a positive path in $G^+$ starting at $v$ and ending at an outer vertex. 
%% This generalizes the accessibility properties known for $d/(d-2)$-orientations~\cite[Theo.13]{Bernardi-Fusy:dangulations} and for the $\alpha$-orientations associated to transversal structures~\cite[Lem.3]{Fu07b}.
%% We will not give the details of the proof, but simply mention that it uses the fact (which can be derived from Lemma~\ref{lem:ingoing-weight-angular}) that for a cycle $C$ of $G$ which is the contour of a simply connected region which is not a face of $G$ and such that no edge in the interior region has both endpoints on $C$, the sum of the weights of the arcs strictly inside $C$ with terminal vertex on $C$ is always positive (in fact, at least $d$). 
%% %$\sum_{a\in I}(\mathrm{deg}(f_a')-2)-\textrm{length}(C)+d,$
%% %where $I$ is the set of arcs of $G$ strictly inside $C$ whose terminal vertex is on $C$, and for $a$ in $I$, $f_a'$ is the face of $G$ incident to $a$ and on the left of $a$ (and this quantity is always positive).
%% \end{remark}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Next we prove an accessibility property for $d$-GS angular orientations.
\begin{lemma}\label{lem:alpha-ori-acc}
Let $G$ be a $d$-adapted map endowed with a $d$-GS angular orientation. Then, for any vertex $v$ of $G^+$ which is not a star vertex of degree $d$, there exists a positive path in $G^+$ starting at $v$ and ending at an outer vertex. 
\end{lemma} 
\begin{proof}
It suffices to prove the property for the original vertices (because it then easily follow for the star vertices).
Let $U$ be the set of vertices $v$ of $G$ for which there exists a positive path in $G^+$ from $v$ to an outer vertex.
Let $G_U$ be the submap of $G$ made of $U$ and the edges of $G$ with both endpoints in $U$ (this is a connected submap containing the outer vertices and the outer edges). 
%We want to show that $G_U=G$, so it suffices to show that every face of $G_U$ is a face of $G$. Consider the contour $C$ of a face of $G_U$. We want to prove that $C$ is the contour of a Let $\om(C)$ (resp. $\overline \om(C)$) of the arcs of $G^+$ strictly inside $C$ and having there initial (resp. terminal) vertex on $C$.
Suppose for contradiction that there is a vertex $v$ of $G$ which is not in $U$. Then consider the contour $C$ of the face of $G_U$ containing $v$. By definition of $G_U$, there cannot be any edge of $G$ strictly inside $C$ with both endpoints on $C$. Consider the total weight $\om(C)$ (resp. $\overline \om(C)$) of the arcs of $G^+$ strictly inside $C$ and having their initial (resp. terminal) vertex on $C$. We will prove $\overline \om(C)>0$ and reach a contradiction.
By Lemma~\ref{lem:ingoing-weight-angular},
$$\om(C)=\textrm{length}(C)-d+\sum_{a\in C}(d-\deg(f_a)),$$
where the sum is over the arcs of $C$ and $f_a$ is the face of $G$ incident to $a$ inside $C$. Let  $J$ be the set of arcs of $G^+$ strictly inside $C$ whose terminal vertex is on $C$, and let $I\subseteq J$ be the subset of those on original edges. For $a\in J$, denote by $e_a$ the edge of $G^+$ that contains $a$, and for $a\in I$ denote by $f_a'$ the face of $G$ incident to $a$ and on the left of $a$. We claim that
$$\om(C)+\overline\om(C)=\sum_{a\in J}\beta(e_a)=\sum_{a\in C}(d-\deg(f_a))+\sum_{a\in I}(\deg(f_a')-2).$$
To see that this identity holds, we pair each arc $a\in I$ with the star arc $a'\in J$ preceding $a$ in clockwise order around the terminal vertex of $a$, and we observe  $\beta(e_a)+\beta(e_{a'})=(d-2)-(d-\deg(f_a'))=\deg(f_a')-2$. The unpaired arcs in $J$ are the star arcs $a'$ followed (in clockwise order around the terminal vertex of $a'$) by an arc $a\in C$, and satisfy  $\beta(e_{a'})=d-\deg(f_a)$; so the sum of $\beta(e_{a'})$ over these unpaired arcs is $\sum_{a\in C}(d-\deg(f_a))$. This proves the claimed identity, and from it we obtain
%% To see that this identity holds, note that for each arc $a\in I$, with $v\in C$ the terminal vertex of $a$, and 
%% $a'\in J$ the arc ending at $v$ on the next edge (a star edge) after $a$ in counterclockwise order around $v$, we have $\beta(e_a)+\beta(e_{a'})=(d-2)-(d-\deg(f_a'))=\deg(f_a')-2$.
%% Moreover, each not yet counted arc $a'\in J$ is on a star edge followed (in clockwise order around the terminal vertex of $a'$) by an edge bearing an arc $a\in C$, 
%% with $\beta(e_{a'})=d-\deg(f_a)$, so the sum of $\beta(e_{a'})$ over these arcs is $\sum_{a\in C}(d-\deg(f_a))$.} From the identity we obtain  
$$\overline\om(C)= \sum_{a\in I}(\mathrm{deg}(f_a')-2)-\textrm{length}(C)+d.$$
Moreover, $\textrm{length}(C)\leq \sum_{a\in I}\ell(f_a')$, where $\ell(f_a')$ is the number of arcs on $C$ incident to $f_a'$ (this is an equality unless $f_a'=f_b'$ for distinct arcs $a,b\in I$). Since there is no edge inside $C$ with both endpoints on $C$, we have 
%\EF{changed strict to large inequality here} \OB{Sorry this was just a typo.}
$\ell(f_a')\leq \mathrm{deg}(f_a')-2$ for all $a\in I$, hence $\overline\om(C)\geq d>0$. 
So there exists an arc $a=(s,u)$ of $G^+$ with positive weight, such that $s$ is strictly inside $C$ (hence not in $U$) and $u$ is on $C$ (hence in $U$). The vertex $s$ cannot be a vertex of $G$ (otherwise it would be in $U$), hence it is a star vertex. However this implies that for every vertex $w\neq u$ adjacent to $s$, the arc $(w,s)$ has positive weight, so that $w\in U$. This implies that $C$ is the contour of the face of $G$ corresponding to the star vertex $s$, which contradicts our assumption that the interior of $C$ contains a vertex $v$ of $G$ which is not in $U$.
%This contradicts the definition of $G_U$ because it shows that there is a vertex $s$ strictly inside $C$ that can reach $C$ by a positive arc of $G^+$, hence that can reach an outer vertex by a positive path of $G^+$ (this is impossible if $s$ is vertex of $G$, but also if $s$ is a star vertex, because in this case all the vertices of $G^+$ adjacent to $s$ are oncan reach an outer vertex by a positive path of $G^+$). 
\end{proof}
\begin{remark}
We say that a weighted orientation of a plane map is \emph{accessible} if for every vertex~$v$, there exists a positive path from $v$ to an outer vertex. 
Lemma~\ref{lem:alpha-ori-acc} shows that any $d$-GS angular orientation is accessible, upon deleting the star vertices of degree $d$ and their incident edges. This generalizes the accessibility properties known for $d/(d-2)$-orientations~\cite[Theo.13]{Bernardi-Fusy:dangulations} and for the $\alpha$-orientations associated to transversal structures~\cite[Lem.3]{Fu07b}.
\end{remark}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


 
%For $X$ a weighted orientation of a plane map $M$, and $C$ a cycle of $M$, an \emph{inward arc} of $C$ is arc inside $C$ whose initial vertex is on $C$. 
%The \emph{inward weight} of $C$ is the total weight of the inward arcs of $C$. 
 % Clearly, a directed cycle of inward weight $0$ is essential. Moreover, by Lemma~\ref{lem:alpha-ori-acc}, every directed cycle that is essential has to have inward weight $0$. 
 %Hence, the essential cycles in $\alpha$-orientations are exactly the directed cycles of inward weight $0$. 


A cycle $C$ of $G^+$ is called \emph{pseudo-compatible} if it is the contour of a simply connected region and does not visit star-vertices of degree~$d$, and for every original edge $e$ belonging to $C$ the star vertex incident to the inner face of $G^+$ incident to $e$ and lying inside $C$ has degree $d$. Clearly, pseudo-compatible cycles are a generalization of compatible cycles, and we will now extend the definition of enclosing length to pseudo-compatible cycles; see Figure~\ref{fig:pseudo-compatible}(a).
Let $C$ be a pseudo-compatible, let $\textrm{Orig}(C)$ be the set of arc of $C$ belonging to original edges of $G$, and let $\textrm{Star}(C)$ be the set of arcs in $C$ whose terminal vertex is a star vertex. For $a\in \textrm{Star}(C)$, we consider the terminal vertex $s$ of $a$ (which is a star vertex) and the next arc $a'$ along $C$, and we define $\ell(a):=\deg(s)-k$, where $k$ is the number of corners incident to $s$ between $a$ and $a'$ on the side of the region included by $C$ (if $C$ is a clockwise contour, then $\ell(a)$ is the number of corners from $a'$ to $a$ in clockwise order around $s$).
We define the enclosing length of $C$ as 
$$\pseudol(C)=|\textrm{Orig}(C)|+\sum_{a \in \textrm{Star}(C)}\ell(a).$$
Note that for a compatible cycle $C$, $\pseudol(C)$ coincides with the length of the enclosing cycle of $C$, and Figure~\ref{fig:pseudo-compatible}(a) provides a generalization of this interpretation for pseudo-compatible cycles.

\fig{width=\linewidth}{pseudo-compatible}{(a) A pseudo-compatible $C$ in a map $G^+$ enclosing a simply connected region $R$. The star vertices on $C$ are indicated (by squares) together with the contour of the face of $G$ corresponding to these star vertices (represented as circles). For an arc $a$ in $\textrm{Star}(C)$, the quantity $\ell(a)$ represents the length of a portion of the contour of the face of $G$ corresponding to the star vertex. Putting together these partial face contours and the arcs in $\textrm{Orig}(C)$ gives a cycle $\hC$ of $G$ of length $\pseudol(C)$. (b) Duplicating part of the oriented map $G^+$, one can get a compatible cycle $C'$ and its enclosing cycle $\hC'$ (in an angular map which is not $G^+$) such that the interior of $C'$ is the same as the interior of $C$, and the interior of $\hC'$ satisfies the conditions of $d$-GS orientations (in terms of weights of vertices and edges). (c) Notation for the proof of Theorem~\ref{thm:flip}.}
%Our next result concern the inward weight of pseudo compatible cycles.
%The following result is useful to characterize essential cycles. %; it is stated for a $d$-map (rather than a $d$-adapted map) since it will be useful to show (in Section~\ref{}) that being $d$-adapted is necessary to admit a $d$-GS angular orientation. 
 
 \begin{lemma}\label{lem:compa}
 Let $G$ be a $d$-map endowed with a $d$-GS angular orientation. Let $C$ be a pseudo-compatible cycle of $G^+$, and let $\ell$ be its enclosing length. Then the inward weight of $C$ is equal to $\ell-d$. 
\end{lemma}
\begin{proof}
Let us first prove the formula when $C$ is simple, that is, a compatible cycle.
Let $C$ be a compatible cycle and let $\hC$ be the enclosing cycle.
Let $V,E$ (resp. $\hat V,\hat E$) be the sets of vertices and edges of $G^+$ that are strictly inside the cycle $C$ (resp. $\hat C$).
The inward weights of $C$ and $\hat C$ are given by 
$$\inweight(C)=\sum_{e\in E}\be(e)-\sum_{v\in V}\al(v)~\textrm{ and }~\inweight(\hC)=\sum_{e\in \hat E}\be(e)-\sum_{v\in \hat V}\al(v).$$
Let $F$ be the set of faces of $G$ inside $\hC$ which are incident with an edge on $\hC$. For $f\in F$, let $\ell(f)$ be the number of arcs on $\hC$ that are on the contour of $f$. It is easy to see that $\sum_{e\in \hat E\backslash E}\be(e)=\sum_{f\in F}(\ell(f)+1)(d-\deg(f))$, and $\sum_{v\in \hat V\backslash V}\al(v)=\sum_{f\in F}(d-\deg(f))$.
Hence, $\inweight(\hC)-\inweight(C)=\sum_{f\in F}\ell(f)(d-\deg(f))$, and 
$$\inweight(C)=\inweight(\hC)-\sum_{a\in \hC}(d-\deg(f_a)),$$
where the sum is over the arcs of $\hC$ and $f_a$ is the face of $G$ incident to $a$ inside $\hC$. Using the expression for $\inweight(\hC)$ provided by Lemma~\ref{lem:ingoing-weight-angular} gives  $\inweight(C)=\ell-d$ as claimed.
%% By Lemma~\ref{lem:ingoing-weight-angular},
%%  $$\inweight(\hC)=\ell-d+\sum_{a\in C}(d-\deg(f_a)),$$
%% hence $\inweight(C)=\ell-d$.


Let us now prove the formula for a pseudo-compatible cycle $C$ which is not simple. The idea of the proof is represented in Figure~\ref{fig:pseudo-compatible}(b). Upon duplicating part of the angular map $G^+$, it is possible to obtain a simple cycle $\hC'$, the interior of which is the angular map of a map $M'$ with outer face $\hC'$ endowed with a weighted orientation with the same edges and vertex weight as a $d$-GS orientation, and such that $\hC'$ is the enclosing cycle of a compatible cycle $C'$, such that 
$\pseudol(C)=\pseudol(C')$ (which is the length of $\hC'$) and $\inweight(C)=\inweight(C')$ (because the weighted orientations in the inner regions of $C$ and $C'$ are identical). Hence applying the above reasoning on the compatible cycle $C'$ gives the result for the pseudo-compatible cycle $C$.
\end{proof}
%% \begin{proof}
%% Let $V,E,F$ be the sets of vertices, edges and faces of $G$ that are \ob{strictly} inside the enclosing cycle $\hC$ of $C$. 
%% Let $F'\subseteq F$ be the set of faces inside $\hC$ 
%% that share at least one edge with $\hC$. To every edge $e=(u,v)\in E$ are associated two star edges, which are consecutive to $e$ in counterclockwise order around $u$ (resp. $v$).
%% By definition, the total weight of $e$ and its two star edges is $d-2$. It follows that $(d-2)|E|$ is the total weight of the edge-set formed by the edges (including star edges) inside $C$ and by the star edges on $C$ that have the interior of $C$ on their left when traversed from the star vertex extremity to the original vertex extremity. Hence, the total weight of the edges inside $C$
%% is $(d-2)|E|-\sum_{f\in F'}(d-\mathrm{deg}(f))$. The total weight of the original vertices inside $C$ is $d|V|$, and the total weight of the star vertices insides
%%  $C$ is $\sum_{f\in F\backslash F'}(d-\mathrm{deg}(f))$. Hence, the inward weight of $C$ satisfies
%% \begin{align*}
%% \mathrm{inweight}(C)&=(d-2)|E|-\sum_{f\in F'}(d-\mathrm{deg}(f))\ -d|V|-\sum_{f\in F\backslash F'}(d-\mathrm{deg}(f))\\
%% &=(d-2)|E|-d|V|-d|F|+\sum_{f\in F}\mathrm{deg}(f).
%% \end{align*}
%% Since $\sum_{f\in F}\mathrm{deg}(f)=2|E|+\mathrm{length}(\hC)$, we obtain 
%% \[
%% \mathrm{inweight}(C)=\mathrm{length}(\hC)+d|E|-d|V|-d|F|. 
%% \]
%% Finally, the Euler relation yields $|V|-|E|+|F|=1$, which concludes the proof.
%% \end{proof}

We can now complete the proof of Theorem~\ref{thm:flip}.
\begin{proof}[Proof of Theorem~\ref{thm:flip}]
Let $G$ be a $d$-map endowed with a $d$-GS angular orientation. A flip/flop operation in the lattice of $d$-GS angular orientations of $G$ correspond to pushing a positive simple cycle which is not incident to the outer vertices, and is essential. Let $C$ be a positive simple cycle not incident to the outer vertices, which is essential, and is not the contour of an inner face of $G^+$. We want to show that $C$ is a compatible cycle of enclosing length $d$.

Suppose for contradiction that $C$ is not compatible. Since $C$ is not compatible, it has at least one original edge $e=\{u,v\}$ whose incident face $f$ inside $C$ has degree less than $d$. Consider the star edges $\eps_1=\{v_f,u\}$ and $\eps_2=\{v_f,v\}$ joining $u,v$ to the star vertex $v_f$. The weights of $\eps_1,\eps_2$ in angular orientations are $\om(\eps_1)=\om(\eps_2)=\om(v_f)=d-\deg(f)>0$. Hence either (a) both arcs $a_1=(u,v_f)$ and $a_2=(v,v_f)$ have positive weights, or (b) $a_1$,$-a_2$ form a positive path from $u$ to $v$, or (c) $a_2,-a_1$ form a positive path from $v$ to $u$. Since $C$ is essential (and not reduced to $e,\eps_1,\eps_2$), cases (b) and (c) are excluded. Hence, we are in case (a). By Lemma \ref{lem:alpha-ori-acc} there exists a positive path $P$ from $v_f$ to one of the vertices on $C$. Concatenating either $a_1$ or $a_2$ with $P$ gives a chordal path for $C$, which is a contradiction. 

Thus, $C$ is a compatible cycle, and it remains to prove that it has enclosing length $d$. Suppose for contradiction that the enclosing length is greater than $d$. Then the inward weight of $C$ is positive by Lemma~\ref{lem:compa}. Let $a=(u,v)$ be an arc inside $C$ with positive weight, having initial vertex $u$ on $C$. Let $U$ be the set of vertices on $C$ or inside $C$ that can be reached from $u$ by a positive path of arcs strictly inside $C$. The situation is represented in Figure~\ref{fig:pseudo-compatible}(c).
By assumption $C$ is essential, so $u$ is the only vertex from $U$ on $C$. Let $G_U$ be the submap of $G^+$ made of the vertices and edges on $C$, together with the vertices in $U$ and the edges with both ends in $U$. The submap $G_U$ is connected. Let $f$ be the inner face $f$ of $G_U$ incident to the edges of $C$, and let $C'$ be the clockwise contour of $f$.
It is easy to see that $C'$ is a pseudo-compatible cycle of $G^+$. Moreover, $\inweight(C')<\inweight(C)$ (since any arc inside $f$ having initial vertex in $U$ has weight 0) and $\pseudol(C)<\pseudol(C')$. However these inequalities are incompatible with Lemma~\ref{lem:compa}, which gives a contradiction.

We have thus proved that any non-facial essential cycle of $G^+$ has to be a compatible cycle of enclosing length $d$. Conversely, by Lemma~\ref{lem:compa}, any compatible cycle of enclosing length $d$ 
has inward weight $0$, hence is essential.
%Since the weight of $a$ is positive, the terminal vertex $v$ of $a$ is not a star vertex of degree $d$. Hence by Lemma~\ref{lem:alpha-ori-acc}, there is a positive path from $v$ to the outer vertices. This proves that there is a positive path inside $C$ starting at $u$ and ending at another vertex of $C$. This contradicts the fact that $C$ is essential. 
\end{proof}


\begin{proof}[Proof of Theorem~\ref{thm:flip_bip}]
The proof of Theorem~\ref{thm:flip_bip} is almost identical to that of Theorem~\ref{thm:flip}. The inward weight results of Lemma~\ref{lem:compa} can be used to give an analogue for $b$-BGS angular orientations since such orientations are obtained by halving the weights of even $2b$-GS orientations. Then, the characterization of the essential cycles involved in flips/flops use the same arguments as for $d$-GS angular orientations.
\end{proof}
 
%% \begin{lemma}\label{lem:flip} te
%% Let $C$ be a \ob{positive} cycle in a $d$-GS angular orientation of $G^+$. 
%% Then $C$ is essential if and only if it is either the (triangular) contour of \ob{an inner face of $G^+$}, %made of a star vertex and two original vertices, 
%% or a compatible cycle of enclosing length $d$.
%%  \end{lemma}
%%  \begin{proof}
%% Lemma~\ref{lem:alpha-ori-acc} ensures that a positive cycle $C$ in a $d$-GS angular orientation is essential if and only if it has inward weight $0$. \OB{The preceding might need an explaination -- especially since there are frozen edges.}
%% Hence, if $C$ is a compatible cycle, then it is essential if and only if it has enclosing length~$d$, according to \ob{Lemma~\ref{lem:compa}}. %Lemma~\ref{lem:alpha-ori-acc}. 

%% It remains to show that if $C$ is a directed essential cycle that is not compatible, then it is the contour of \ob{an inner face of $G^+$}. 
%% %Assume without loss of generality that $C$ is \cw. 
%% Since $C$ is not compatible, it has at least one original edge $e=\{u,v\}$ whose incident face $f$ inside $C$ has degree less than $d$. Consider the edges $\eps_1=\{v_f,u\}$ and $\eps_2=\{v_f,v\}$ joining $u,v$ to the star vertex $v_f$. The weights of $\eps_1,\eps_2$ in angular orientations are $\om(\eps_1)=\om(\eps_2)=\om(v_f)=d-\deg(f)$. Hence there is either a positive path from $u$ to $v$ or from $v$ to $u$ using the edges $\eps_1,\eps_2$. Since $C$ is essential, it means that $\eps_1,\eps_2$ are not strictly inside $C$, hence $C$ is made of $e,\eps_1,\eps_2$ which is the contour of an inner face of $G^+$.
%% %% Old version:
%% %% Assume without loss of generality that $C$ is \cw. 
%% %% Since $C$ is not compatible, it has at least one original arc $a=(u,v)$ whose incident face $f$ inside $C$ has 
%% %% degree smaller than $d$. Let $s$ be the star vertex corresponding to $f$, let $i<d$ be its degree, and let $\eps_1=\{s,u\}$ and $\eps_2=\{s,v\}$. 
%% %% Assume that the triangle $T=(e,\eps_1,\eps_2)$ forms a \cw\ cycle. Then $T$ is essential, and it shares an edge with $C$, hence $T=C'$.
%% %% Given that $\om(s)=\om(\eps_1)=\om(\eps_2)=d-i$, the only possible situation where $T$ does not form a \cw\ cycle is when $\eps_1$ is saturated
%% %% toward~$s$. Since $C$ has inward weight $0$, it implies that $\eps_1$ is on the boundary of $C$. However, in that case, both extremities of $\eps_2$ are on the boundary of $C$. Hence, the only way for $C$ to not have inward weight~$0$ is that $T=C'$.%, contradicting the fact that $\hC$ is directed. 
%% \end{proof}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%
%
%\bibliographystyle{plain}
%\bibliography{biblio-Schnyder}
%\end{document}
