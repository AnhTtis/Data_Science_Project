\documentclass{article} %
\usepackage[dvipsnames]{xcolor}
\usepackage{hyperref}
\usepackage{iclr2023_conference,times}

\input{math_commands.tex}

\usepackage[linesnumbered,ruled,lined,norelsize]{algorithm2e}

\usepackage{url}

\usepackage{cleveref}
\usepackage{amsthm}
\usepackage{multirow}
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage{array}
\usepackage{subcaption}
\usepackage{threeparttable}
\usepackage{tikz}
\usepackage{wrapfig}
\usepackage{pgfplots}
\usetikzlibrary{
    shapes.arrows,
    chains,
    shapes.geometric,
    positioning,
    calc,
    matrix,
    shapes.multipart}
\pgfplotsset{compat=1.16}

\usepackage{enumitem}
\setenumerate{leftmargin=5mm}
\setitemize{leftmargin=5mm}


\definecolor{myblue}{HTML}{2C6CBF}
\definecolor{myred}{HTML}{D92211}
\definecolor{mygreen}{HTML}{59D986}

\definecolor{myc1}{HTML}{A6949F}
\definecolor{myc2}{HTML}{D9D9D9}
\definecolor{myc3}{HTML}{BFBFBF}
\definecolor{mygreen}{HTML}{DCF2EC}
\definecolor{myc5}{HTML}{A8BFAA}

\definecolor{mygray}{HTML}{D9D9D9}
\definecolor{myc6}{HTML}{E3D1D1}
\definecolor{myyellow}{HTML}{F2D06B}
\definecolor{myc8}{HTML}{A9A7D9}
\definecolor{myorange}{HTML}{F29849}

\newcommand\mycommfont[1]{\textcolor{myblue}{#1}}
\newcommand\red[1]{\textbf{\textcolor{myred}{#1}}}
\SetCommentSty{mycommfont}
\DontPrintSemicolon
\setlength{\algomargin}{1em}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{prop}{Proposition}

\title{Optimal Transport for Offline Imitation Learning}

\iclrfinalcopy

\author{Yicheng Luo\\
University College London
\And Zhengyao Jiang\\
University College London
\And Samuel Cohen \\
University College London
\AND Edward Grefenstette\\
University College London \& Cohere
\And Marc Peter Deisenroth \\
University College London \\
}


\newcommand{\fix}{\marginpar{FIX}}
\newcommand{\new}{\marginpar{NEW}}

\begin{document}

\maketitle

\begin{abstract}
With the advent of large datasets, offline reinforcement learning (RL) is a promising framework for learning good decision-making policies without the need to interact with the real environment.
However, offline RL requires the dataset to be reward-annotated, which presents practical challenges when reward engineering is difficult or when obtaining reward annotations is labor-intensive.
In this paper, we introduce Optimal Transport Reward labeling (OTR), an algorithm that assigns rewards to offline trajectories, with a few high-quality demonstrations. OTR's key idea is to use optimal transport to compute an optimal alignment between an unlabeled trajectory in the dataset and an expert demonstration to obtain a similarity measure that can be interpreted as a reward, which can then be used by an offline RL algorithm to learn the policy. OTR is easy to implement and computationally efficient. On D4RL benchmarks, we show that OTR with a single demonstration can consistently match the performance of offline RL with ground-truth rewards\footnote{Code is available at \url{https://github.com/ethanluoyc/optimal_transport_reward}}.
\end{abstract}

\section{Introduction}

\looseness=-1Offline Reinforcement Learning (RL) has made significant progress recently, enabling learning policies from logged experience without any interaction with the environment. Offline RL is relevant when online data collection can be expensive or slow, e.g., robotics, financial trading and autonomous driving. A key feature of offline RL is that it can learn an improved policy that goes beyond the behavior policy that generated the data. However, offline RL requires the existence of a reward function for labeling the logged experience, making direct applications of offline RL methods impractical for applications where rewards are hard to specify with hand-crafted rules. Even if it is possible to label the trajectories with human preferences, such a procedure to generate reward signals can be expensive. Therefore, enabling offline RL to leverage unlabeled data is an open question of significant practical value. 

Besides labeling every single trajectory, an alternative way to inform the agent about human preference is to provide expert demonstrations. For many applications, providing expert demonstrations is more natural for practitioners compared to specifying a reward function. In robotics, providing expert demonstrations is fairly common, and in the absence of natural reward functions, `learning from demonstration' has been used for decades to find good policies for robotic systems; see, e.g.,~\citep{Atkeson1997, Abbeel2004, Calinon2007, Englert2013}. One such framework for learning policies from demonstrations is imitation learning (IL). IL aims at learning policies that imitate the behavior of expert demonstrations without an explicit reward function. 


There are two popular approaches to IL: Behavior Cloning (BC)~\citep{pomerleau1988ALVINN} and Inverse Reinforcement Learning (IRL)~\citep{Ng2000a}. BC aims to recover the demonstrator's behavior directly by setting up an offline supervised learning problem. If demonstrations are of high quality and actions of the demonstrations are recorded, BC can work very well as demonstrated by \citet{pomerleau1988ALVINN}, but generalization to new situations typically does not work well. IRL learns an intermediate reward function that aims to capture the demonstrator's intent. 
Current algorithms have demonstrated very strong empirical performance, requiring only a few expert demonstrations to obtain good performance \citep{ho2016GAIl,dadashi2022PWIL}. While these IRL methods do not require many demonstrations, they typically focus on the \emph{online} RL setting and require a large number of environment interactions to learn an imitating policy, i.e., these methods are not suitable for offline learning. 


\looseness=-1In this paper, we introduce Optimal Transport Reward labeling (OTR), an algorithm that uses optimal transport theory to automatically assign reward labels to unlabeled trajectories in an offline dataset, given one or more expert demonstrations. This reward-annotated dataset can then be used by offline RL algorithms to find good policies that imitate demonstrated behavior.
Specifically, OTR uses optimal transport to find optimal alignments between unlabeled trajectories in the dataset and expert demonstrations.
The similarity measure between a state in unlabeled trajectory and that of an expert trajectory is then treated as a reward label.
These rewards can be used by any offline RL algorithm for learning policies from a small number of expert demonstrations and a large offline dataset. \Cref{fig:otil-illustration} illustrates how OTR uses expert demonstrations to add reward labels to an offline dataset, which can then be used by an offline RL algorithm to find a good policy that imitates demonstrated behavior.
Empirical evaluations on the D4RL~\citep{fu2021D4RL} datasets demonstrate that OTR recovers the performance of offline RL methods with ground-truth rewards with only a single demonstration. 
Compared to previous reward learning and imitation learning approaches, our approach also achieves consistently better performance across a wide range of offline datasets and tasks.


\begin{figure}[tb]
    \centering
    \include{figures/illustration}
    \caption{Illustration of Optimal Transport Reward Labeling (OTR). Given expert demonstrations (left) and an offline dataset without reward labels (center), OTR adds reward labels $r_i$ to the offline dataset by means of optimal transport (orange, center). The labeled dataset can then be used by an offline RL algorithm (right) to learn policies.}
    \label{fig:otil-illustration}
\end{figure}

\section{Offline Reinforcement Learning and Imitation Learning}

\paragraph{Offline Reinforcement Learning}
In offline/batch reinforcement learning, we are interested in learning policies directly from fixed offline datasets~\citep{lange2012Batcha,levine2020Offlineb}, i.e., the agent is not permitted any additional interaction with the environment. Offline RL research typically assumes access to an offline dataset of observed transitions $\mathcal{D} = \{(s^i_t, a^i_t, r^i_t, s^i_{t+1})\}_{i=1}^N$.
This setting is particularly attractive for applications where there is previous logged experience available but online data collection is expensive (e.g., robotics, healthcare). Recently, the field of offline RL has made significant progress, and many offline RL algorithms have been proposed to learn improved policies from diverse and sub-optimal offline demonstrations~\citep{levine2020Offlineb,fujimoto2021TD3-BC,kumar2020CQL,kostrikov2022IQL,wang2020CRR}.

Offline RL research typically assumes that the offline dataset is reward-annotated. That is, each transition $(s^i_t, a^i_t, r^i_t, s^i_{t+1})$ in the dataset is labeled with reward $r^i_t$. One common approach to offline RL is to leverage the reward signals in the offline dataset and learn a policy with an actor-critic algorithm purely from offline transitions~\citep{levine2020Offlineb}. However, in practice, having per-transition reward annotations for the offline dataset may be difficult due to the challenges in designing a good reward function. \citet{zolna2020oril} propose ORIL which learns a reward function based on positive-unlabeled (PU) learning~\citep{elkan2008Learning} that can be used to add reward labels to offline datasets, allowing for unlabeled datasets to be used by offline RL algorithms.

\paragraph{Imitation Learning}
Imitation Learning (IL) aims at learning policies that can mimic the behavior of an expert demonstrator. Unlike the typical RL setting, a reward function is not required. Instead, IL methods assume access to an expert that can provide demonstrations of desired behavior.

There are two commonly used approaches to imitation learning. Behavior Cloning (BC)~\citep{pomerleau1988ALVINN} learns a policy by learning a mapping from states to actions in the trajectory demonstrated by an expert. By formulating policy learning as a supervised learning problem, BC can suffer from classical problems of supervised regression: generalizing the policy to unseen states may not be successful due to overfitting; multiple expert trajectories that follow different paths (bifurcation) will cause challenges.
Inverse Reinforcement Learning (IRL) considers first learning a reward function based on expert demonstrations. The learned reward function can then be used to train a policy using an RL algorithm.
Previous work shows that IRL-based methods can learn good policies with a small number of expert demonstrations. However, popular recent IRL methods, such as GAIL~\citep{ho2016GAIl}, require a potentially large number of online samples during training, resulting in poor sample efficiency. Moreover, algorithms, such as GAIL, follow a training paradigm that is similar to Generative Adversarial Networks (GANs)~\citep{goodfellow2014GAN}, by formulating the problem of IRL as a minimax optimization problem to learn a discriminator that implicitly minimizes an f-divergence. It was found, however, that Adversarial imitation learning (AIL) methods such as GAIL can be very difficult to optimize, requiring careful tuning of hyperparameters~\citep{orsini2021What}. Another popular approach is to perform distribution matching between the policy and the expert demonstrations~\citep{Englert2013,kostrikov2022ValueDICE}.

More recently, IRL methods based on Optimal Transport (OT) have demonstrated success as an alternative method for IRL compared to AIL approaches. Unlike AIL approaches,  OT methods minimize the Wasserstein distance between the expert's and the agent's state-action distributions. Building on this formulation,~\citet{xiao2019Wasserstein} propose to minimize the Wasserstein distance via its dual formulation, which may lead to potential optimization issues. More recently, \citet{dadashi2022PWIL} introduce PWIL, which instead minimizes the Wasserstein distance via its primal formulation, avoiding the potential optimization issues in the dual formulation. Along this line of work,~\citet{cohen2021Imitation} propose a series of improvements to the primal Wasserstein formulation used in PWIL and demonstrate strong empirical results in terms of both sample efficiency and asymptotic performance. Still, these approaches require a large number of online samples to learn good policies. While progress has been made to improve the sample efficiency of these approaches~\citep{kostrikov2022DiscriminatorActorCritic}, imitation learning without any online interaction remains an active research area.  In this paper, we provide a constructive algorithm to address the issue of offline imitation learning by using optimal transport to annotate offline datasets with suitable rewards.

\section{Offline Imitation Learning with Optimal Transport}
We consider learning in an episodic, finite-horizon Markov Decision Process (MDP) $(\mathcal{S}, \mathcal{A}, p, r, \gamma, p_0, T)$ where $\mathcal{S}$ is the state space, $\mathcal{A}$ is the action space, $p$ is the transition function, $r$ is the reward function, $\gamma$ is the discount factor, $p_0$ is the initial state distribution and $T$ is the episode horizon. A policy $\pi$ is a function from state to a distribution over actions. The goal of RL is to find policies that maximize episodic return. Running a policy $\pi$ in the MDP generates a state-action episode/trajectory $(s_1, a_1, s_2, a_2, \dots, s_T)=:\tau$.

We consider the problem of imitation learning purely from offline datasets. Unlike in the standard RL setting, no explicit reward function is available.
Let $\tau =(s_1, a_1, s_2, a_2, \dots, s_T)$ denote an episode of interaction with the MDP using a policy that selects actions $a_t$ at time steps $t = 1,\ldots, T-1$.
Instead of a reward function, we have access to a dataset of \emph{expert} demonstrations $\mathcal{D}^e = \{\tau_e^{(n)}\}_{n=1}^N$ generated by an expert policy $\pi_e$ and a large dataset of \emph{unlabeled} trajectories $\mathcal{D}^u = \{\tau_\beta^{(m)}\}_{m=1}^M$ generated by an arbitrary behavior policy $\pi_\beta$. We are interested in learning an offline policy $\pi$ combining information from the expert demonstrations and unlabeled experience, without any interaction with the environment. We will address this problem by using optimal transport, which will provide a way to efficiently annotate large offline RL datasets with rewards.


\subsection{Reward Labeling via Wasserstein Distance}
\label{ssec:online-imitation-learning}

Optimal Transport (OT)~\citep{cuturi2013Sinkhorn,peyre2020Computational} is a principled approach for comparing probability measures.
The (squared) Wasserstein distance between two discrete measures $\mu_x = \frac{1}{T} \sum^T_{t=1} \delta_{x_t}$ and $\mu_y = \frac{1}{T'} \sum^{T'}_{t=1} \delta_{y_t}$ is
\begin{equation}
    \mathcal{W}^2(\mu_x, \mu_y) = \min_{\mu \in M}  \sum_{t=1}^{T}\sum_{t'=1}^{T'} c(x_t, y_{t'}) \mu_{t,t'},
\end{equation}
where $M = \{\mu \in \mathbb{R}^{T \times T'} : \mu \mathbf{1} = \frac{1}{T} \mathbf{1}, \mu^T \mathbf{1} = \frac{1}{T'} \mathbf{1}\}$
is the set of coupling matrices, $c$ is a cost function, and $\delta_x$ refers to the Dirac measure for $x$. The optimal coupling $\mu^*$ provides an alignment between the samples in $\mu_x$ and $\mu_y$. Unlike other divergence measures (e.g., KL-divergence), the Wasserstein distance is a metric and it incorporates the geometry of the space.


Let $\hat{p}_e = \frac{1}{T'} \sum^{T'}_{t=1} \delta_{s_t^e}$ and $\hat{p}_\pi = \frac{1}{T} \sum^{T}_{t=1} \delta_{s_t^\pi}$ denote the empirical state distribution of an expert policy $\pi_e$ and behavior policy $\pi$ respectively. Then the (squared) Wasserstein distance
\begin{equation}\label{eq:otil-min-problem}
\mathcal{W}^2(\hat{p}_\pi, \hat{p}_e) = \min_{\mu \in M} \sum_{t=1}^{T}\sum_{t'=1}^{T'} c(s_t^\pi,s^e_{t'})\mu_{t,t'}
\end{equation}
can be used to measure the distance between expert policy and behavior policy. 
Let $\mu^*$ denote the optimal coupling for the optimization problem above, then~\cref{eq:otil-min-problem} provides a reward signal
\begin{equation}\label{eq:otil-reward-function}
r_{\text{ot}}(s_t^\pi) = -\sum_{t'=1}^{T'} c(s_t^\pi, s_{t'}^e) \mu^*_{t,t'},
\end{equation}
which can be used for learning policy $\pi$ in an imitation learning setting. 
\begin{figure}
    \centering
    \includegraphics{figures/demo_plot_v2.pdf}
    \caption{\looseness=-1Illustration of the computations performed by OTR. In this example, we consider an MDP with a two-dimensional state-space ($|\mathcal{S}|=2$). We have two empirical state distributions from an expert $\hat{p}_e$ with samples $\{s_{t'}^e\}_{t'=1}^{T'}$ (${\circ}$) and policy $\hat{p}_\pi$ with samples $\{s_{t}^\pi\}_{t=1}^{T}$ ($\textcolor{CornflowerBlue}{\bullet}$) as denoted by points in the leftmost figure. OTR assigns rewards $r_{\text{ot}}$ (\textcolor{CornflowerBlue}{blue}) to each sample in the policy's empirical state distribution as follows: (i) Compute the pairwise cost matrix $C$ (\textcolor{Orchid}{purple}) between expert trajectories and trajectories generated by behavior policy; (ii) Solve for the optimal coupling matrix $\mu$ (\textcolor{LimeGreen}{green}) between $\hat{p}_\pi$ and $\hat{p}_e$; (iii) Compute the reward for $s_t^\pi$ as $r_{\text{ot}}(s_t^\pi) = -C_t^T \mu^*_t$. Consider for example a state $s_t^\pi \in \hat{p}_\pi$; 
    the row $C_t$ in the cost matrix corresponds to the costs between $s_t^\pi$ and $\{s_{t'}^e\}_{t'=1}^{T'}$. $\mu^*_t$ represents the optimal coupling between $s_t^\pi$ and  the expert samples. The optimal coupling moves most of the probability mass to $s^e_3$ and a small fraction of the mass to $s^e_4$ (green lines in the leftmost figure).
    }
    \label{fig:computation}
\end{figure}



\subsection{Imitation Learning Using Reward Labels From Optimal Transport}

We leverage the reward function from~\cref{eq:otil-reward-function} to annotate the unlabeled dataset with reward signals. Computing the optimal alignment between the expert demonstration with trajectories in the unlabeled dataset allows us 
to assign a reward for each step in the unlabeled trajectory.
\Cref{fig:computation} illustrates the computation performed by OTR to annotate an unlabeled dataset with rewards using demonstrations from an expert.

\begin{algorithm}

\KwIn{unlabeled dataset $\mathcal{D}^{u}$, expert dataset $\mathcal{D}^{e}$}
\KwOut{labeled dataset $\mathcal{D}^{\text{label}}$}
\SetKwFunction{SolveOT}{SolveOT}
$\mathcal{D}^{\text{label}} \gets \emptyset$\;
\ForEach(\tcp*[f]{Label each episode in the unlabeled dataset}){
    $\tau^{(m)}$ \text{in} $\mathcal{D}^u$}{
    $C^{(m)}, \mu^{*(m)} \gets \SolveOT(\mathcal{D}^e, \tau^{(m)})$\tcp*{Compute the optimal alignment with~\cref{eq:otil-min-problem}}\label{alg:otr-solve-ot}
    \For{$t$ = $1$ to $T$}{
        $r_{\text{OT}}(s^{(m)}_t) \gets -\sum_{t'=1}^{T'} C^{(m)}_{t,t'}\mu^{*(m)}_{t,t'}$\tcp*{Compute the per-step rewards with~\cref{eq:otil-reward-function}}\label{alg:otr-reward}
    }
    $\mathcal{D}^{\text{label}} \gets \mathcal{D}^{\text{label}} \cup (s_1^{(m)}, a_1^{(m)}, r_1^{\text{OT}}, \dots, s_T^{(m)})$ \tcp*{Append labeled episode}
}
\KwRet{$\mathcal{D}^{\text{label}}$}\;
\caption{Pseudo-code for Optimal Transport Reward labeling (OTR)}\label{algo:otil}
\end{algorithm}

The pseudo-code for our approach is given in~\cref{algo:otil}. OTR takes the unlabeled dataset $\mathcal{D}^u$ and expert demonstration $\mathcal{D}^e$ as input. For each unlabeled trajectory  $\tau^{(m)} \in \mathcal{D}^u$, 
OTR solves the optimal transport problem for each, obtaining the cost matrix $C^{(m)}$ and optimal alignment $\mu^{*(m)}$ (\cref{alg:otr-solve-ot}). OTR then computes the per-step reward label following~\cref{eq:otil-reward-function} (\cref{alg:otr-reward}). The reward-annotated trajectories are then combined, forming a reward-labeled dataset $\mathcal{D}^{\text{label}}$.

\looseness=-1Solving~\cref{eq:otil-min-problem} requires solving the OT problem to obtain the optimal coupling matrix $\mu^*$. This amounts to solving a linear program (LP), which may be prohibitively expensive with a standard LP solver. In practice, we solve the entropy-regularized OT problem with Sinkhorn's algorithm~\citep{cuturi2013Sinkhorn}. We leverage the Sinkhorn solver in OTT-JAX~\citep{cuturi2022OTT} for this computation.
Once OTR has annotated the unlabeled offline dataset with intrinsic rewards, we can use an offline RL algorithm for learning a policy. Since we are working in the pure offline setting, it is important to use an offline RL algorithm that can minimize the distribution shifts typically encountered in the offline setting.

Unlike prior works that compute rewards using online samples~\citep{dadashi2022PWIL,cohen2021Imitation}, we compute the rewards entirely offline, prior to running offline RL training, avoiding the need to modify any part of the downstream offline RL pipeline. Therefore, our approach can be combined with any offline RL algorithms, providing dense reward annotations that are required by the downstream algorithms. \Cref{fig:otil-illustration} illustrates the entire pipeline of using OTR for relabeling and running an offline RL algorithm using the reward annotated datasets.

Compared to previous work that aims at solving offline imitation learning with a single algorithm, OTR focuses on generating high-quality reward annotations for downstream offline RL algorithms. In addition, our approach enjoys several advantages:
\begin{itemize}
    
    \item \looseness=-1Our approach does not require training separate reward models or discriminators, which may incur higher runtime overhead. By not having to train a separate parametric model, we avoid hyper-parameter tuning on the discriminator network architectures.
    \item Unlike other approaches, such as GAIL or DemoDICE, our approach does not require solving a minimax optimization problem, which can suffer from training instability~\citep{orsini2021What}.
    \item Our approach is agnostic to the offline RL methods for learning the policy since OTR computes reward signals independently of the offline RL algorithm.
\end{itemize}


\section{Experiments}
\label{sec:experiments}

\begin{figure}[h]
\begin{subfigure}{.2\textwidth}
  \centering
  \includegraphics[width=.9\linewidth]{figures/halfcheetah-medium-v2.png}
\end{subfigure}%
\begin{subfigure}{.2\textwidth}
  \centering
  \includegraphics[width=.9\linewidth]{figures/walker2d-medium-v2.png}
\end{subfigure}%
\begin{subfigure}{.2\textwidth}
  \centering
  \includegraphics[width=.9\linewidth]{figures/hopper-medium-v2.png}
\end{subfigure}%
\begin{subfigure}{.2\textwidth}
  \centering
  \includegraphics[width=.9\linewidth]{figures/antmaze-medium-play-v0.png}
\end{subfigure}%
\begin{subfigure}{.2\textwidth}
  \centering
  \includegraphics[width=.9\linewidth]{figures/hammer-cloned-v0.png}
\end{subfigure}
\caption{Benchmark tasks: D4RL Locomotion, Antmaze, and Adroit.}
\label{fig:benchmarks}
\end{figure}
In this section, we evaluate OTR on D4RL Locomotion, Antmaze, and Adroit benchmark tasks (see also \Cref{fig:benchmarks}) with the goal of answering the following research questions:
\begin{enumerate}
    \item Can OTR recover the performance of offline RL algorithms that has access to a well-engineered reward function (i.e., ground-truth rewards provided by the environment)?
    \item Can OTR handle unlabeled datasets with behaviors of unknown and mixed quality?   
    \item How does OTR perform with a varying number of expert demonstrations?
    \item How does OTR compare with previous work on offline imitation learning in terms of performance and runtime complexity?
\end{enumerate}

We demonstrate that OTR can be effectively combined with an offline RL algorithm to learn policies from a large dataset of unlabeled episodes and a small number of high-quality demonstrations. Since OTR is only a method for reward learning, it can be combined with any offline RL algorithm that requires reward-annotated data for offline learning. In this paper, we combine OTR with the Implicit $Q$-Learning (IQL) algorithm~\citep{kostrikov2022IQL}.

\subsection{Setup}
\looseness=-1We evaluate the performance of OTR+IQL on the D4RL locomotion benchmark~\citep{fu2021D4RL}. We start by evaluating OTR on three environments (\texttt{HalfCheetah-v2}, \texttt{Walker-v2}, \texttt{Hopper-v2}) from the OpenAI Gym MuJoCo locomotion tasks. For each environment, we use the \texttt{medium-v2}, \texttt{medium-replay-v2} and \texttt{medium-expert-v2} datasets to construct the expert demonstrations and the unlabeled dataset.
For the expert demonstrations, we choose the best episodes from the D4RL dataset based on the episodic return.\footnote{In practice, the expert demonstrations can be provided separately; we only select the expert demonstration in this way for ease of evaluation.}
To obtain the unlabeled dataset, we discard the original reward information in the dataset. We then run OTR to label the dataset based on the optimal coupling between the unlabeled episodes and the chosen expert demonstrations. Afterward, we proceed with running the offline RL algorithm.

For OTR, we follow the recommendation by~\citet{cohen2021Imitation} and use the cosine distance as the cost function. When there are more than one episode of expert demonstrations, we compute the optimal transport with respect to each episode independently and use the rewards from the expert trajectory that gives the best episodic return.
Similar to~\citep{dadashi2022PWIL,cohen2021Imitation}, we squash the rewards computed by~\cref{alg:otr-reward} with an exponential function $s(r) = \alpha \exp(\beta r)$. This has the advantage of ensuring that the rewards consumed by the offline RL algorithm have an appropriate range since many offline RL algorithms can be sensitive to the scale of the reward values. We refer to~\cref{ssec:hyperparams} for additional experimental details and hyperparameters.

\paragraph{Implementation}
\looseness=-1We implement OTR in JAX~\citep{bradbury2018JAX}. For computing the optimal coupling, we use OTT-JAX~\citep{cuturi2022OTT}, a library for optimal transport that includes a scalable and efficient implementation of the Sinkhorn algorithm that can leverage accelerators, such as GPU or TPU, for speeding up computations. Our IQL implementation is adapted from~\citep{kostrikov2022IQL}\footnote{\url{https://github.com/ikostrikov/implicit_q_learning}}, and we set all hyperparameters to the ones recommended in the original paper. All of our algorithms and baselines are implemented in Acme~\citep{hoffman2022Acme}.

Our implementation is computationally efficient\footnote{An efficient implementation of OTR is facilitated by JAX, which includes useful functionality that allows us to easily parallelize computations. Concretely, we JIT-compile the computation of rewards for one episode and further leverage the \texttt{vmap} function to compute the optimal coupling between an unlabeled episode with all of the expert episodes in parallel. Efficiently parallelizing the computation of the optimal coupling requires that all the episodes share the same length. This is necessary both for parallelizing the computation across multiple expert demonstrations as well as for avoiding recompilation by XLA due to changes in the shape of the input arrays. To achieve high throughput for datasets with varying episodic length, we pad all observations to the maximum episode length allowed by the environment (which is $1000$ for the OpenAI Gym environments) but set the weights of the observations to zero. Padding the episodes this way does not change the solution to the optimal coupling problem. Note that padding means that a 1M transition dataset may create more than $1000$ episodes of experience, in this case, the runtime for our OTR implementation may be higher effectively due to having to process a larger number of padded episodes.}, requiring only about $1$ minute to label a dataset with $1$ million transitions (or $1000$ episodes of length $1000$)\footnote{Runtime measured on \texttt{halfcheetah-medium-v2} with an NVIDIA GeForce RTX 3080 GPU.}. For larger-scale problems, OTR can be  scaled up further by processing the episodes in the dataset in parallel. Our implementation of OTR and re-implementation of baselines are computationally efficient. Even so, the training time for IQL is about $20$ minutes, so that OTR adds a relatively small amount of overhead for reward annotation to an existing offline RL algorithm.



\paragraph{Baselines}
We compare OTR+IQL with the following baselines:
\begin{itemize}
    \item IQL (oracle): this is the original Implicit $Q$-learning~\citep{kostrikov2022IQL} algorithm using the ground-truth rewards provided by the D4RL datasets.
    \item DemoDICE: an offline imitation learning algorithm proposed by~\cite{kim2022DemoDICE}. DemoDICE was found to perform better than previous imitation learning algorithms (e.g., ValueDICE~\citep{kostrikov2022ValueDICE}) that can also (in principle) work in the pure offline setting. We ran the original implementation\footnote{\url{https://github.com/geon-hyeong/imitation-dice}} under the same experimental setting as we used for the other algorithms in the paper.
    \item ORIL: a reward function learning algorithm from~\citep{zolna2020oril}. ORIL learns a reward function by contrasting the expert demonstrations with the unlabeled episodes. The learned reward function is then used for labeling the unlabeled dataset. We implement ORIL in a comparable setting to the other baselines.
    \item UDS: we keep the rewards from the expert demonstrations and relabel all rewards from the unlabeled datasets with the minimum rewards from the environment. This was found to perform well in~\citep{yu2022cds}. This also resembles online imitation learning methods such as SQIL~\citep{reddy2020SQIL} or offline RL algorithms, such as COG~\citep{singh2020COG}.
\end{itemize}

Since UDS and ORIL are also agnostic about the underlying offline RL algorithm used, we combined these algorithms with IQL so that we can focus on comparing the performance difference due to different approaches used in generating reward labels.

For all algorithms, we repeat experiments with $10$ random seeds and report the mean and standard deviation of the normalized performance of the last $10$ episodes of evaluation. We compare all algorithms by using either $K=1$ or $K=10$ expert demonstrations. Obtaining the results on the locomotion datasets took approximately $500$ GPU hours. 

\subsection{Results}

\begin{table}[htb]
    \centering
    \include{results/otil_iql}
    \caption{D4RL performance comparison between IQL with ground-truth rewards and OTR+IQL with a single expert demonstration ($K=1$). We report mean $\pm$ standard deviation per task and aggregate performance and highlight near-optimal performance in \textbf{bold} and extreme negative outliers in \red{red}. OTR+IQL is the only algorithm that performs consistently well across all domains.}
    \label{table:otil-iql-results}
\end{table}
\paragraph{MuJoCo Locomotion} \Cref{table:otil-iql-results} compares the performance between OTR+IQL with the other baselines. Overall, OTR+IQL performs best compared with the other baselines in terms of aggregate score over all of the datasets we used, recovering the performance of IQL with ground-truth rewards provided by the dataset. While we found that other baselines can perform well on some datasets, the performance is not consistent across the entire dataset and can deteriorate significantly on some datasets. In contrast, OTR+IQL is the only method that consistently performs well for all datasets of different compositions.


\paragraph{Runtime} \looseness=-1 Despite applying optimal transport, we found that with a GPU-accelerated Sinkhorn solver~\citep{cuturi2022OTT}, combined with our efficient implementation in JAX, OTR achieves a faster runtime compared to algorithms that learn additional neural networks as discriminators (DemoDICE~\citep{kim2022DemoDICE}) or reward models (ORIL~\citep{zolna2020oril}). For methods that learn a neural network reward function, an overhead of at least $10$ minutes is incurred, whereas OTR only incurs approximately $2$ minutes of overheads when compared with the same amount of expert demonstrations.

\paragraph{Effect of the number of demonstrations}
\begin{wraptable}{r}{0.4\textwidth}
    \scriptsize
    \centering
    \vspace{-3mm}
    \begin{tabular}{lrr}
    \toprule
    locomotion-v2-total & $K = 1$ & $K = 10 $\\
    \midrule
    DemoDICE & 585.3 & 589.3 \\
    IQL+ORIL & 588.5 & 618.3 \\
    IQL+UDS & 494.9 & 575.8 \\
    OTR+IQL & \textbf{685.5} & \textbf{694.3} \\
    IQL (oracle) & & 692.4 \\
    \bottomrule
    \end{tabular}
    \caption{Aggregate performances of different reward labeling algorithms with different numbers of expert demonstrations. OTR is the only algorithm that leads to an offline RL performance close to using ground-truth rewards.}\label{table:otil-iql-results-sample-size}
        \vspace{-4mm}
\end{wraptable}
We investigate if the performance of the baselines can be improved by increasing the number of expert demonstrations used.
\Cref{table:otil-iql-results-sample-size} compares the aggregate performance on the locomotion datasets between OTR and the baselines when we increase the number of demonstrations from $K=1$ to $K=10$. 
DemoDICE's performance improves little with the additional amount of expert demonstrates. While ORIL and UDS enjoy a relatively larger improvement, they are still unable to match the performance of IQL (oracle) or OTR in terms of aggregate performance despite using the same offline RL backbone. OTR's performance is close to IQL (oracle) even when $K=1$ and matches the performance of IQL (oracle) with $K=10$.

\paragraph{Antmaze \& Adroit} \looseness=-1We additionally evaluate OTR+IQL on the \texttt{antmaze-v0} and \texttt{adroit-v0} datasets. \Cref{table:otil-iql-results-antmaze-adroit} shows that OTR+IQL again recovers the performance of IQL with ground-truth rewards. This suggests that OTR+IQL can learn from datasets with diverse behavior and human demonstrations even without ground-truth reward annotation; additional results in~\cref{ssec:experiment-results}.

\begin{table}[h]
\begin{subtable}[t]{.5\linewidth}\centering
\include{results/antmaze_short}
\end{subtable}
\begin{subtable}[t]{.5\linewidth}
\centering
\include{results/adroit_short}
\end{subtable}
\caption{\looseness=-1Performance of OTR+IQL on \texttt{antmaze} and \texttt{adroit} with a single expert demonstration. Similar to the results on locomotion, OTR+IQL recovers the performance of offline RL with ground-truth rewards. We report mean $\pm$ standard deviation per task and aggregate performance.}
\label{table:otil-iql-results-antmaze-adroit}
\end{table}

\begin{figure}[htb]
\subcaptionbox{\label{fig:reward-prediction}Ground-truth return vs labeled return.}{
    \centering
\includegraphics[height=2.7cm]{figures/reward_prediction.pdf}
}
\hfill
\subcaptionbox{\label{fig:antmaze-reward-prediction}Top trajectories selected by OTR.}{
    \centering
    \includegraphics[height=2.7cm]{figures/antmaze_reward_visualization}
}
\captionsetup{subrefformat=parens}
\caption{Visualization of rewards predicted by OTR and baselines. \subref{fig:reward-prediction} Qualitative differences between the rewards predicted by OTR, ORIL and UDS on \texttt{hopper-medium-v2}. \subref{fig:antmaze-reward-prediction} Visualization of top trajectories selected by OTR on \texttt{antmaze-medium-play-v0}. Left: Expert demonstrations. Right: ranking of trajectories according to rewards per step computed by OTR. Trajectories with lighter colors have higher rewards per step.}
\end{figure}
\paragraph{Qualitative comparison of the reward predictions} \Cref{fig:reward-prediction} provides a qualitative comparison of the reward predicted by OTR, ORIL, and UDS. UDS annotates all transitions in the unlabeled dataset with the minimum reward from the environment. Thus, the episodes with non-zero rewards are expert demonstrations. This means that UDS is unable to distinguish between episodes in the unlabeled datasets.
Compared to reward learning algorithms, such as ORIL, OTR's reward prediction more strongly correlates with the ground-truth rewards from the environment, which is a good precondition for successful policy learning by downstream offline RL algorithm.
We also evaluate OTR's reward prediction on more diverse datasets, such as those in antmaze. \Cref{fig:antmaze-reward-prediction} shows the expert demonstrations we used in \texttt{antmaze-medium-play-v0} (left) and the trajectories that received the best OTR reward labels in the unlabeled dataset (right). OTR correctly assigns more rewards to trajectories that are closer to the expert demonstrations.



\paragraph{Summary}
Our empirical evaluation demonstrates that OTR+IQL can recover the performance of offline RL with ground-truth rewards given only a single episode of expert demonstration. Compared to previous work, it achieves better performance even with a larger number of demonstrations. Our qualitative comparison shows that OTR assigns better reward estimates that correlate strongly with a hand-crafted reward function.

\section{Discussion}
OTR can be effective in augmenting unlabeled datasets with rewards for use by downstream offline RL algorithms (see~\cref{sec:experiments}). Compared to prior imitation learning and reward learning approaches, OTR enjoys better and more robust performance on the benchmarks we have considered in this paper. Furthermore, our approach is easy to implement. Most of the complexity of our approach arises from solving the optimal transport problem. However, there are libraries for solving OT efficiently in different frameworks or programming languages\footnote{For example, see Python Optimal Transport (POT)~\citep{flamary2021POT}, which supports PyTorch, JAX, or TensorFlow.}.

Unlike prior works, such as ValueDICE or DemoDICE, we split offline imitation learning into the two distinct phases of reward modeling via OTR and a subsequent offline RL. This improves modularity, allows for improvements in the two phases to be made independently, and adds flexibility. However, this modularity means that a practitioner needs to make a separate choice for the downstream offline RL algorithm.

We believe that OTR is most useful in situations where providing ground-truth rewards is difficult but providing good demonstrations and unlabeled data is feasible. However, it will not be feasible in cases where collecting expert demonstrations is difficult.

The Wasserstein distance formulation we used can be extended to perform cross-domain imitation learning by using the Gromov--Wasserstein distance to align expert demonstrations and offline trajectories from different spaces~\citep{fickinger2022CrossDomain}.

\section{Conclusion}
We introduced Optimal Transport Reward labeling (OTR), a method for adding reward labels to an offline dataset, given one or more expert demonstrations. OTR computes Wasserstein distances between expert demonstrations and trajectories in a dataset without reward labels, which then are turned into a reward signal. The reward-annotated offline dataset can then be used by an(y) offline RL algorithm to determine good policies. OTR adds minimal overhead to existing offline RL algorithms while providing the same performance as learning with a pre-specified reward function.

\subsubsection*{Acknowledgments}
Yicheng Luo is supported by the UCL Overseas Research Scholarship (UCLORS). Samuel Cohen is supported by the UKRI AI Centre for Doctoral Training in Foundational Artificial Intelligence
(EP/S021566/1).

\bibliography{biblio}
\bibliographystyle{iclr2023_conference}

\appendix
\include{appendix}
\end{document}
