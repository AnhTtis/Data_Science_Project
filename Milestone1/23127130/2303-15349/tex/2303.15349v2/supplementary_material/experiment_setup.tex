\section{Experiment Setup}
\label{appendix:experiment_setup}
\subsection{Environments and Datasets}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Obstacle Avoidance}
\label{appendix:obs_avoidance}
%\begin{figure}[htb!]%[t]
        % \centering
%        \begin{minipage}[t!]{0.235\textwidth}
%            \centering 
%            \includegraphics[width=\textwidth]{supplementary_material/figures/oa_env_final.png}
%        \end{minipage}
%         \hfill
%         \begin{minipage}[t!]{0.235\textwidth}
%            \centering 
%            \includegraphics[width=.6\textwidth]{supplementary_material/figures/Fig:ICML23:obsavoid_data.pdf}
%        \end{minipage}
%         \hfill
%        \caption[]
%        {\small Obstacle avoidance environment. The right figure shows 6 out of 24 modes for this task.
%        }
%        \label{fig:obs_avoid_env}
%    \end{figure}

\begin{figure}[htb!]%[t]
        \begin{minipage}[t!]{0.3\textwidth}
            \includegraphics[width=\textwidth]{supplementary_material/figures/obsavoid_data.pdf}
        \end{minipage}
        \hfill
        \begin{minipage}[t!]{0.3\textwidth}
            \includegraphics[width=\textwidth]{supplementary_material/figures/contexts.pdf}
        \end{minipage}
        \hfill
        \begin{minipage}[t!]{0.3\textwidth}
            \includegraphics[width=\textwidth]{supplementary_material/figures/kitchen_env.png}
        \end{minipage}
        \hfill
        \caption[]{\small The left figure shows 6 out of 24 ways of completing the obstacle avoidance task. The middle figure shows 30 randomly sampled initial block configurations for the block pushing task. The right figure visualizes the Franka kitchen environment.}
        \label{fig:obs_hbp}
\end{figure}
    
\textbf{Dataset.} The obstacle avoidance dataset contains $96$ trajectories resulting in a total of $7.3$k $(\mathbf{o}, \mathbf{a})$ pairs. The observations $\mathbf{o} \in \mathbb{R}^{4}$ contain the end-effector position and velocity in Cartesian space. Please note that the height of the robot is fixed. The actions $\mathbf{a} \in \mathbb{R}^{2}$ represent the desired position of the robot. The data is recorded such that there are an equal amount of trajectories for all $24$ ways of avoiding the obstacles and reaching the target line. For successful example trajectories see Figure \ref{fig:obs_hbp}.

\textbf{Performance Metrics.} The \textit{success rate} indicates the number of end-effector trajectories that successfully reach the target line (indicated by green color in Figure \ref{fig:planar_reacher_vis}). The \textit{entropy} 
\begin{equation*}
    \mathcal{H}(\beta) = - \sum_{\beta} p(\beta) \log_{24} p(\beta),
\end{equation*}
is computed for successful trajectories, where each behavior $\beta$ is one of the 24 ways of completing the task. To assess the model performance, we simulate $1000$ end-effector trajectories. We count the number of successful trajectories for each way of completing the task. From that, we calculate a categorical distribution over behaviors $p(\beta)$ which is used to compute the entropy. By the use of $\log_{24}$ we make sure that $\mathcal{H}_{24}(\vtau) \in [0, 1]$. If a model is able to discover all modes in the data distribution with equal probability, its entropy will be close to $1$. In contrast, $\mathcal{H}(\beta) = 0$ if a model only learns one solution.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Block Pushing}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\begin{figure}[t]
%        \centering
%        \begin{minipage}[t!]{0.235\textwidth}
%            \centering 
%            \includegraphics[width=\textwidth]{supplementary_material/figures/hbp_env_final.png}
%        \end{minipage}
%        \hfill
%        \begin{minipage}[t!]{0.235\textwidth}
%            \centering 
%            \includegraphics[width=\textwidth]{supplementary_material/figures/contexts.pdf}
%        \end{minipage}
%         \hfill
%        \caption[ ]
%        {\small \textbf{Block pushing environment.}}
%        \label{fig:box_env}
%    \end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{appendix:block_pushing}
\textbf{Dataset.} The block pushing dataset contains $500$ trajectories for each of the four push sequences (see Figure \ref{fig:box_env_trajs}) resulting in a total of $2000$ trajectories or $463$k $(\mathbf{o}, \mathbf{a})$ pairs. The observations $\mathbf{o} \in \mathbb{R}^{16}$ contain the desired position and velocity of the robot in addition to the position and orientation of the green and red block. Please note that the orientation of the blocks is represented as quaternion number system and that the height of the robot is fixed. The actions $\mathbf{a} \in \mathbb{R}^{2}$ represent the desired position of the robot. This task is similar to the one proposed in \cite{florence2022implicit}. However, they use a deterministic controller to record the data whereas we use human demonstrators which increases the difficulty of the task significantly due to the inherent versatility in human behavior.  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure*}[h!]
        \centering
        \begin{minipage}[t!]{0.235\textwidth}
            \centering 
            \includegraphics[width=\textwidth]{supplementary_material/figures/gg_rr_env_023_05.pdf}
        \end{minipage}
        \hfill
        \begin{minipage}[t!]{0.235\textwidth}
            \centering 
            \includegraphics[width=\textwidth]{supplementary_material/figures/rr_gg_env_009_05.pdf}
        \end{minipage}
         \hfill
        \centering
        \begin{minipage}[t!]{0.235\textwidth}
            \centering 
            \includegraphics[width=\textwidth]{supplementary_material/figures/gr_rg.pdf}
        \end{minipage}
        \hfill
        \begin{minipage}[t!]{0.235\textwidth}
            \centering 
            \includegraphics[width=\textwidth]{supplementary_material/figures/rg_gr.pdf}
        \end{minipage}
         \hfill
        \caption[ ]
        {{ \textbf{Block pushing:} Top view of four different push sequences. Starting from the black cross, the gray line visualizes the end-effector trajectory of the robot manipulator. The small rectangles indicate different box configurations in the push sequence, the big rectangles mark the target zones.}}
        \label{fig:box_env_trajs}
    \end{figure*}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\textbf{Performance Metrics.} The \textit{success rate} indicates the number of end-effector trajectories that successfully push both blocks to different target zones. To assess the model performance on non-successful trajectories, we consider the \textit{distance error}, that is, the Euclidean distance from the blocks to the target zones at the final block configuration of an end-effector trajectory. As there are a total of four push sequences $\beta$ (see Figure \ref{fig:planar_reacher_vis}) we use the expected \textit{entropy}
\begin{equation*}
    \E_{p(\obs_0)} \big[\mathcal{H}(\beta|\obs_0) \big] \approx - \frac{1}{N_0} \sum_{\obs_0 \sim p(\obs_0)} \sum_{\beta} p(\beta|\obs_0) \log_{4} p(\beta| \obs_0),
\end{equation*}
to quantify a model's ability to cover the modes in the data distribution. Please note that we use $\log_{4}$ for the purpose of enhancing interpretability, as it ensures $\mathcal{H}(\beta)\in [0,1]$. An entropy value of 0 signifies a policy that consistently executes the same behavior, while an entropy value of 1 represents a diverse policy that executes all behaviors with equal probability and hence matches the true behavior distribution by design of the data collection process. Furthermore, we set $p(\obs_0) = 1/30$ as we sample $30$ block configurations uniformly from a configuration space (see Figure \ref{fig:obs_hbp}). For each $\obs_0$ we simulate $16$ end-effector trajectories. For a given configuration, we count how often each of the four push-sequences is executed successfully and use the result to calculate a categorical distribution $p(\beta|\obs_0)$. Once repeated for all $30$ configurations , we compute $ \E_{p(\obs_0)} \big[\mathcal{H}(\beta|\obs_0) \big]$.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsubsection{Franka Kitchen} 
% \textbf{Dataset.} The Franka kitchen environment was introduced in \cite{gupta2019relay}. It contains $566$ human-collected trajectories resulting in a total of $128$k $(\mathbf{o}, \mathbf{a})$ pairs. 
% The observations $\mathbf{o} \in \mathbb{R}^{30}$ contain information about the position and orientation of the task-relevant objects in the environment. The actions $\mathbf{a} \in \mathbb{R}^{9}$ represent the signals to control the robot and the gripper. The dataset comprises sequences that successfully solve $4$ out of $7$ tasks in different orders.   

% \textbf{Performance Metrics.} First, we consider the \textit{success rate} for a different number of tasks solved. We additionally compute the \textit{entropy} over task sequences. 
% This is computed using $100$ simulated robot trajectories. For trajectories with a single task solved, we count how frequently each of the tasks is executed. From that, we calculate a categorical distribution which is then used for computing the entropy. We generalize this concept to more successful task completions, by calculating a categorical distribution over all $7^k$ possible task sequences for $k$ task completions.
% \label{appendix:fk_kitchen}
% \begin{figure}[htb!]%[t]
%         % \centering
%         \begin{minipage}[t!]{0.35\textwidth}
%             \centering 
%             \includegraphics[width=\textwidth]{supplementary_material/figures/kitchen_env.png}
%         \end{minipage}
%          \hfill
%         \caption[]
%         {\small \textbf{Franka kitchen environment.} 
%         }
%         \label{fig:fk_env}
%     \end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Table Tennis}
\textbf{Dataset.} The table tennis dataset contains $5000$ $(\mathbf{o}, \mathbf{a})$ pairs. The observations $\mathbf{o} \in \mathbb{R}^{4}$ contain the coordinates of the initial and target ball position as projection on the table. Movement primitives (MPs) \cite{paraschos2013probabilistic} are used to describe the joint space trajectories of the robot manipulator using two basis functions per joint and thus $\mathbf{a} \in \mathbb{R}^{14}$.

\textbf{Metrics.} To evaluate the different algorithms on the demonstrations recorded using the table tennis environment quantitatively, we employ two performance metrics: The \textit{success rate} and the \textit{distance error}. The success rate is the percentage of strikes where the ball is successfully returned to the opponentâ€™s side. The distance error, is the distance between the target position and landing position of the ball for successful strikes.

\subsubsection{Human Subjects for Data Collection}
For the obstacle avoidance as well as the block pushing experiments we used data collected by humans. We note that all human subjects included in the data collection process are individuals who are collaborating on this work. The participants did, therefore, not receive any financial compensation for their involvement in the study. 

\subsection{IMC Details and Hyperparameter}
\label{section:imc_experiment_details}
IMC employs a parameterized inference network and conditional Gaussian distributions to represent experts. For the latter, we use a fixed variance of $1$ and parameterize the means as neural networks. For both inference network and expert means we use residual MLPs \cite{du2019implicit}. For all experiments, we use batch-size $|\mathcal{B}| = |\mathcal{D}|$, number of components $N_z = 50$ and expert learning rate equal to $5 \times 10^{-4}$. Furthermore, we initialized all curriculum weights as $p(\obs_n, \act_n|z) = 1$.
% In every M-step, we optimize the experts for $5$ epochs. We add a new component after performing $5$ E- and M-steps or if the lower bound $L(\vpsi, q)$ converges. 
For the table tennis and obstacle avoidance task, we found the best results using a multi-head expert parameterization (see Section \ref{appendix:experts}) where we tested $1-4$ layer neural networks. We found that using $1$ layer with $32$ neurons performs best on the table tennis task and $2$ layer with $64$ neurons for the obstacle avoidance task. 
% For the block pushing and Franka kitchen experiments, we considered $3$ and $4$ layers. We found that $3$ layers with $64$ neurons yield the best results for the block pushing task and $4$ layer with $100$ neurons for Franka kitchen.
For the block pushing and Franka kitchen experiments, we obtained the best results using a sigle-head parameterization of the experts. We used $6$ layer MLPs with $128$ neurons for both tasks. For the inference network, we used a fixed set of parameters that are listed in Table \ref{table:imc_hp}. For the entropy scaling factor $\eta$ we performed a hyperparameter sweep using Bayesian optimization. The respective values are $\eta = 1/30$ for obstacle avoidance, $\eta = 2$ for block pushing and Franka kitchen and $\eta = 1$ for table tennis. 
\begin{table}[htb!]
\caption{\textbf{IMC \& EM Hyperparameter.}}
\label{table:imc_hp}
\vskip 0.15in
\begin{center}
\begin{small}
\begin{sc}
\begin{tabular}{ll}
\toprule
    Parameter & Value \\ 
    \midrule
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Entropy scaling ($\eta$)
    % & $[10^{-2}, 10^{2}]$
    % \\
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Expert learning rate
    & $10^{-4}$
    \\
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Expert batchsize
    & $1024$
    \\
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Expert variance ($\sigma^2$)
    & $1$
    \\
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Inference net hidden layer
    & $6$
    \\
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Inference net hidden units
    & $256$
    \\
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Inference net epochs
    & $800$
    \\
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Inference net learning rate
    & $10^{-3}$
    \\
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Inference net batchsize
    & $1024$
    \\
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \bottomrule
  \end{tabular}
\end{sc}
\end{small}
\end{center}
\vskip -0.1in
\end{table}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{supplementary_material/baselines.tex}