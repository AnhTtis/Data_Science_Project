\documentclass[conference]{IEEEtran}
%\documentclass[letterpaper, 10 pt, conference]{ieeeconf} 
\IEEEoverridecommandlockouts

% \documentclass[runningheads]{llncs}

% The preceding line is only needed to identify funding in the first footnote. If that is unneeded, please comment it out.
\usepackage{url}
\usepackage{cite}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{accents}
% \usepackage{algorithmic}
\usepackage[linesnumbered,ruled]{algorithm2e}
\usepackage[noend]{algpseudocode}
% \usepackage[nottoc]{tocbibind}
% \usepackage{diagbox}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage[table,xcdraw]{xcolor}
\usepackage{xcolor}
\usepackage{comment}
\usepackage{multicol,multirow}
\usepackage[T1]{fontenc}
\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
\usepackage{todonotes}
\usepackage{caption}
\usepackage{wrapfig}
\usepackage{subfig}
\newsavebox{\measurebox}
%\usepackage[disable]{todonotes}
\usepackage{threeparttable}
\usepackage[font=small]{caption} 
\usepackage{enumitem}
% \setlist[itemize]{align=left,left=-10pt..-5em}
% \usepackage[hang,flushmargin]{footmisc}
% \usepackage{lipsum}

%One must be careful when importing hyperref. Usually, it has to be the last package to be imported, but there might be some exceptions to this rule.
\usepackage{hyperref}
\hypersetup{
    colorlinks=false
}

\def\UrlBreaks{\do\/\do-}

\makeatletter
\newcommand{\algorithmfootnote}[2][\footnotesize]{%
  \let\old@algocf@finish\@algocf@finish% Store algorithm finish macro
  \def\@algocf@finish{\old@algocf@finish% Update finish macro to insert "footnote"
    \leavevmode\rlap{\begin{minipage}{\linewidth}
    #1#2
    \end{minipage}}%
  }%
}
\makeatother

\newcommand*{\Scale}[2][4]{\scalebox{#1}{$#2$}}%

\begin{document}
\bstctlcite{IEEEexample:BSTcontrol}

\title{Short: Bolus-Adjust: Trend Prediction Alerts and Adjusted Boluses for Hyperglycemia Prevention} 

\author{Short Paper}
\begin{comment}
\author{Chloe Smith\\
% }
% \authorrunning{F. Author et al.} 
% First names are abbreviated in the running head.
% If there are more than two authors, 'et al.' is used.
%

% \institute
{ University of Virginia, Charlottesville, VA 22904, USA %\\
\email
%Department of Electrical and Computer Engineering,
{\{cas8ds\}@virginia.edu}\\



}
}
\end{comment}

\maketitle
\thispagestyle{plain}
\pagestyle{plain}

\begin{abstract} 
Significant advancements in type 1 diabetes treatment have been made in the development of state-of-the-art Artificial Pancreas Systems (APS). However, lapses currently exist in the timely treatment of unsafe blood glucose (BG) levels, especially in the case of rebound hyperglycemia. We propose a machine learning (ML) method for predictive BG scenario categorization that outputs messages alerting the patient to upcoming BG trends in order to allow for earlier, educated treatment. 
In addition to standard notifications of predicted hypoglycemia and hyperglycemia, we introduce BG scenario-specific alert messages and the preliminary steps towards precise bolus suggestions for prevention of rebound hyperglycemia.
%As part of this method, we introduce carbohydrate input in a state of hypoglycemia as a parameter to determine increase basal insulin rates to be precisely recommended in our messages when a safe state is recovered in order to prevent rebound hyperglycemia. 
Experimental evaluation on the DCLP3 clinical dataset achieves >98\% accuracy and >79\% precision for predicting rebound high events for patient alerts.
\end{abstract}
%on a realistic closed-loop APS testbed using simulated data, an actual clinical dataset, and one participant's data

\begin{IEEEkeywords}
safety, cyber-physical systems, medical device, wearable systems, body sensor networks.
\end{IEEEkeywords}

% \vspace{-2em}
\section{Introduction}
%para 1
% millions of people are suffering from Type I diabetes. APS is one of the effective treatments, however, often makes over- or under-adjustments of the BG and insulin amount, causing hypoglycemia to hyperglycemia rebound ...

%para 2
% limitations of current work: (1) only use the nighttime data \cite{Taisa2020, Dutta2018,dsn2021zhou,zhou2023knowsafe} (2) without meals input

%para 3
% we propose a novel framework that encodes the carb info into an attention layer and considers its impact on the weights of each neuron at the different periods after taking a meal for better prediction of future BG sequences. The encoded carb info is stored as a short memory in the NN that indicated whether additional insulin adjustment is required using a binary output layer according to the BG sequence prediction. 
%experiments on the UVA-Padova simulator and an actual dataset from xx patients 

Patients with type 1 Diabetes are tasked with the monitoring and treatment of their BG levels, as their pancreases do not successfully produce the required levels of insulin. Great strides have been made in the management of type 1 Diabetes in the last 50 years, and in particular the development of wearable insulin pumps and Continuous Glucose Monitors (CGM) \cite{pumpHist},\cite{cgmHist}. Recent diabetes management research largely focuses on the development of closed-loop APS that combine insulin pump and CGM technology \cite{closedSupport}. One large task at hand is the improvement of APS controllers \cite{study1}, \cite{study2},\cite{study3} to detect and prevent cases of hyperglycemia\cite{hyper} and hypoglycemia\cite{hypo} which in mild cases can cause blurred vision, difficulty concentrating, weakness or drowsiness, and in extreme cases result in a coma or even death. 

%Several studies have focused on addressing various lapses in this process \cite{study1}, \cite{study2},\cite{study3}. 
%One such lapse is in rebound highs/lows \cite{reboundCGM}. 
One of the limitations of the existing APS is in addressing the rebound highs/lows \cite{reboundCGM}.   
These are typical scenarios for patients with type 1 diabetes where after having treated an episode of hypoglycemia, their BG levels increase beyond the target range into a range of hyperglycemia ("rebound high"). Similarly, it is not uncommon for patients, after having treated hyperglycemia, to fall past the safe range into unsafe hypoglycemia ("rebound low"). Current BG prediction models and APS can alert users about the rebound highs/lows, but they neglect to take or advise precise treatment actions.
%Hypoglycemia in a mild case can cause "blurred vision, difficulty concentrating, confused thinking, slurred speech, numbness, and drowsiness" among other symptoms. If hypoglycemia persists, it can cause "seizures, coma, and very rarely death" \cite{hypo}. Hyperglycemia commonly causes frequent urination, increase thirst, blurred vision, and feeling weak or unusually tired. In extreme cases, it can cause ketoacidosis, which can result in a coma or even death \cite{hyper}.

%In this paper, we discuss two causes of concern that, when addressed, can decrease the time out of the safe BG range.
In this paper, we propose methods for the prediction and prevention of rebound hyperglycemia which can be integrated with the existing APS applications to address the two following rebound concerns.
%\begin{itemize}
%    \item {
The first is the concern that patients with type 1 diabetes in the safe range may take action too late to prevent BG levels outside of the safe range. 
%For instance, if the CGM is currently reading a BG level in range (e.g., 140 mg/dL), the patient may not know when to consume carbs and/or glucose if at all, even if the BG level is indicated to be decreasing. By the time the patient is made aware of BG being low, the BG is already in the state of hypoglycemia or close to it. 
To address this case, we propose a predictive alert mechanism that uses an ML algorithm to estimate BG levels an hour in advance, categorizes BG trends into one of the several BG scenarios, and outputs messages alerting the user of both general high/low BG levels and specific rebound scenarios.
%[decide if we want treatment suggestion as well. Most diabetics would know what to do with this existing message I would hope, but we could add "consider eating some carbs" if we want] 
Since carbohydrate ingestion takes time to affect BG levels, and insulin takes even longer to do so, earlier action can mitigate unsafe BG levels. This will not only help prevent rebounds, but can also help stay within the safe range. %those in the safe range to stay within it.
%}
%\item{

The second concern is of the over-correction of low BG levels. In addition to the generation of predictive BG alerts mentioned above, we introduce a method to recommend increases in bolus injections administered by the insulin pump by a threshold when BG has shifted to the safe range, based on carbohydrate input entered when BG was below the safe range. This adjusted bolus output acts as a "carb carry-over" for earlier carbohydrate inputs to account in the safe range, preventing a reactionary hyperglycemia episode from occurring after experiencing hypoglycemia.
%}
%\end{itemize}
Addressing the issues of not foreseeing future BG trends and not carrying-over insulin that accounts for carbs after hypoglycemia both help to attain in-range BG values. %for patients with type 1 diabetes.

Our contributions are as follows: 
\begin{enumerate}
    \item Predictive blood sugar alert mechanism with scenario-specific language based on an ML prediction model for BG scenario categorization 
    \item Preliminary steps towards developing a carry-over carb input method for increased bolus recommendations to patients for preventing hyperglycemia 
    \item Evaluation using a realistic testbed's simulated data and actual patient data
\end{enumerate}

%\section{Random notes -- ignore! Thanks}
%Suspension of basal insulin to avoid hypoglycemia in type 1 diabetes treated with insulin pump - https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4285755/
%\\
%Evidence That Hyperglycemia After Recovery From Hypoglycemia Worsens Endothelial Function and Increases Oxidative Stress and Inflammation in Healthy Control Subjects and Subjects With type 1 Diabetes - https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3478543/
%\\
%: Ask UVA Endocrinologists about rebound high -- done
%\\Our main contributions are as follows: 
%\\1) Carry-over carb input method for hypoglycemia
%\\2) ML blood sugar prediction method
%\\3) an app to alert user to Carry-over carb and critical blood sugar predictions
%\\4) Quantitative simulation and qualitative in-person evaluation

\section{Background}
\textbf{Artificial Pancreas Systems:}
\begin{figure}
        \centering
    \includegraphics[scale=.38]{Figures/APS picture-5.png} \\
        \caption{Artificial Pancreas System}
        \label{fig:APS}
        \vspace{-1.5em}
    \end{figure}
As shown in Figure \ref{fig:APS}, APS are closed-loop systems that mimic the work of the pancreas to control blood sugar levels using three devices: (i) a CGM that detects BG levels, (ii) a controller that intakes BG levels from the CGM (and at times external user input, such as carbohydrate input) and determines insulin pump instructions (insulin dose) based on the inputs, and (iii) an insulin pump which delivers insulin into the body based on the instructions from the controller. %This link between the body, CGM, controller, and insulin pump injecting back into the body causes the APS to be referred to as a \emph{Closed Loop System}. 
In this paper, we focus on the APS that allows for standard carbohydrate input. Users can also interact with the system by changing BG levels through temporary basal rate adjustments (e.g., for exercise), extended boluses (e.g., for fat-heavy meals), or consuming carbohydrates (e.g., in treating low BG).

\textbf{BG Safe Ranges: }
The safe range for BG levels is defined to be between 70 and 180 $mg/dL$. BG values within this range are considered safe since they do not cause unpleasant symptoms or health risks. %that occur outside of the specified range. 
\emph{Hypoglycemia} refers to the cases in which BG levels are below 70 $mg/dL$, and \emph{hyperglycemia} refers to the cases where BG levels are above 180 $mg/dL$.

\textbf{Over-correction of Low BG: }
Over-correction of low BG occurs when consumption of carbohydrates is beyond what is required to draw BG levels up from hypoglycemia to the safe range. 
%For example, if a patient with type 1 Diabetes has hypoglycemia at the start of a meal containing more carbohydrates than is needed to treat the hypoglycemia and does not carefully track BG level changes and administer insulin appropriately, an over-correction of low BG is likely to occur, resulting in hyperglycemia.
%For example, it is not uncommon for a patient with type 1 Diabetes to have a dip in BG before a meal. Yet, as the patient may receive an alert that their BG is below range soon before a meal and BG takes roughly 15-20 minutes to rise to a safe level, it is a notable case to consider the consumption of carbohydrates above what is required to raise BG from hypoglycemia (such as would be found in a typical meal). In this case, the insulin pump would be reticent to inject insulin for the whole carbohydrate intake (rightly so) as a safety precaution, since insulin lowers BG and the patient is currently in a state of hypoglycemia in this scenario. Yet, with the excessive ingestion of carbohydrates, it is common for this overcorrection to cause a spike in BG following the recovery of the safe state.
When a patient with type 1 diabetes experiences hypoglycemia, also called "low blood sugar," proper treatment involves raising BG levels by consuming fast-acting carbohydrates (around 15-20 grams of sugary substances, such as glucose tablets or juice) and then waiting for a short period of time (typically about 15 minutes) \cite{mayolow}. Afterwards, if BG levels remain below range, then the aforementioned treatment  is repeated. Once the BG is back in range, the patient consumes a portion of protein and longer-acting carbohydrates 
in order to prevent the BG from dropping back down into the low range.
This dosing of carbohydrates in the case of hypoglycemia is less precise than a correction insulin dose for high blood sugar, which is calculated based on the exact BG level
%. This makes it easier to incorrectly dose 
(although incorrect insulin dosing is also a problem \cite{smartPump}). In addition, hypoglycemia at the start of meals can lead to the consumption of more carbohydrates than is needed to treat the hypoglycemia, but insulin dosing to counter them when in a state of hypoglycemia can be risky.
    
\textbf{Rebound High/Low: }
When an over-correction of carbohydrates lifts the BG above the safe range rather than settling within the safe range, it is referred to as a "rebound high." Rebound hyperglycemia is defined in previous works as a "series of sensor glucose values (SGVs) >180 $mg/dL$ starting within two hours of an antecedent SGV <70 $mg/dL$" \cite{reboundCGM}. %In our system, 2 hours is equivalent to 24 APS timesteps.
%The term "rebound high" can become messy in the literature, as the same term is at 
The term "rebound high" is at times also used in the literature to refer to the Somogyi effect \cite{Somogyi}.
%, which is itself often confused with the Dawn Phenomenon. The Dawn Phenomenon refers to a natural hormone release that increases in blood sugar in the morning while asleep. The Somogyi effect also occurs in the morning, but it is an increase in blood sugar that comes as a rebound from low blood sugar overnight, typically caused by natural hormone releases as an attempt to raise BG levels \cite{defDawnSomogyi}.
The Somogyi effect is an increase in blood sugar that comes in the morning as a rebound from low blood sugar overnight, typically caused by natural hormone releases as an attempt to raise BG levels \cite{defDawnSomogyi}.
Although the Somogyi effect \emph{is} a rebound high, %However, in this study, when we refer to "rebound highs," we are not talking specifically about the rebounds that occur without intervention. We are speaking of rebound highs that occur from over-correction of hypoglycemia which then causes a spike in blood sugar.
%However, 
in this paper, we refer to "rebound highs" that occur due to over-correction of low BG causing a spike in blood sugar, and not the rebounds that occur without intervention. 

\section{Related Work}
%Type 1 Diabetes has been a target area of research for years, and thus there is a large body of related works from which we highlight the main categories that this paper builds upon.

%\begin{itemize}
%\item{
\textbf{Predictive BG Alerts:} Great strides have been made in predictive BG monitoring and notification in recent years. Some of the most popular manufacturers of medical devices for the management of type 1 Diabetes have rolled out predictive BG messages. For instance, Medtronic's Guardian Connect System reports to be able to predict BG 10-60 minutes in advance and to notify the patient in order to inform preemptive treatment decisions \cite{fdaGuardian}. 
%ML-based prediction
Recent advancement in data-driven technologies has also promoted research works that can predict BG accurately for a maximum period of 2 hours in the future \cite{Taisa2020,Dutta2018}. However, these works primarily focus on BG prediction at nighttime without considering more complex scenarios, such as multiple variate meal inputs. %zhou2023knowsafe
In addition, they do not recognize and refer to common scenarios (such as "rebound high") beyond general hyperglycemia and hypoglycemia 
alerts and lack precise treatment advice. 
%In addition, though they seem to be fairly proficient at predictive notification, another limitation of them that we sought to address in our study was sorting various scenarios with the common language of "rebound high" or "rebound low" when on the outside of the range on either end and predicting to swap to the other. Though this sort of adjustment is small, it is helpful to progress the notifications to recognize and use language for scenarios that are common and used in the language of both endocrinologists and lay patients with type 1 diabetes. A third limitation we address is the lack of precise treatment advice. We sought to provide insulin dosage suggestions based on carbohydrate input in the case of a predicted rebound high.
%}

%\item{
\textbf{Rebound Hyperglycemia:}
A large focus of our work is rebound hyperglycemia cases. A very recent study on this topic evaluates using predictive BG alerts to prevent rebound hyperglycemia events \cite{reboundCGM}. The study utilized existing predictive alerts that notify patients of predicted hyperglycemia and hypoglycemia in general. With this system in place, they evaluated the impact of the predictive systems on preventing cases of specifically rebound hyperglycemia within participants.
However, there are similar limitations in this rebound-focused work that we address.
%\begin{enumerate}
    %\item{
    First, this study also did not use alerts that specifically recognize the case of rebound highs and/or use that language in the predictive alerts.%}
    %\item {
    Second, alerts that simply notify the user of predicted out-of-range BG values require the user to create treatment actions without direct recommendations of insulin amounts. %and we use them in our own study, they act as calls to action for the user to give treatment based on the alert information. This creates a limitation of relying on user action when it is not needed.
    %\\There is research on giving automatic corrective insulin doses for high blood sugar \cite{smartPump}, but an automated increase in basal insulin rate or automatic extended bolus insulin dose once back in safe range based on carbs entered while in a state of hypoglycemia is largely missing from this discussion.}
    %}

    In order to address the limitations of existing works, we propose a BG prediction model that produces messages by acknowledging specific scenarios by name and recommending a precise increased insulin in the case of a rebound high.
%\end{enumerate}
%}
%\end{itemize}

\section{Methods}
\begin{figure}[t!]
    \centering
\includegraphics[scale=.45]{Figures/Fig2RememberBolus.png} \\
    \caption{Overall Design of Rebound High Evaluation Module}
    \label{fig:reboundHighArch}
    \vspace{-1.5em}
\end{figure}
We propose to supplement the existing APS controllers with mechanisms for preventing rebound hyperglycemia events. 
As shown in Figure \ref{fig:reboundHighArch}, our proposed Rebound High Evaluation module is designed using
%A preliminary survey, 
ML-based APS state prediction, a recommended increased bolus insulin to carry-over prior carbohydrate input, and response alert message generation to assist patients in the detection and mitigation of rebound highs. %which can be integrated with the existing APS controllers to assist patients in 

\begin{comment}
\subsection{Preliminary Survey}A preliminary survey was sent to ~10 participants to gain a general understanding of hypoglycemia treatment and rebound highs in the experience of actual
patients. The survey involved three demographic questions and eight questions about responding to and predicting out-of-range BG levels.
\end{comment}

\subsection{ML Model for Blood Sugar Prediction}\label{workflowdata}
\begin{figure}[b!]
    \vspace{-2em}
    \centering
\includegraphics[scale=.2]{Figures/FigEncodeDecode-6.png} \\
    \caption{ML Model for Blood Sugar Prediction}
    \label{fig:encodeDecode}
\end{figure}
To forecast future BG levels and detect future BG trends, we design an encoder-decoder ML model with an attention layer that takes in a sequence of APS states, where each state contains BG, insulin dosage, insulin on board (IOB), and carbohydrates, and outputs expected BG values (see Figure \ref{fig:encodeDecode}). The encoder generates a deep representation of the sequence of input states that the decoder uses to initialize its internal state as it predicts the BG value for the next timestep using the current APS state.
The following equations describe the flow of information through the model:
%\vspace{-1em}
%{%\scriptsize
\begin{align*}
    h_{enc} &= Encoder(X_{[t-n+1, t]}) \\
    s_{t'+1} &= (h_{t'+1}, z_{t'+1}) = LSTM(x_{t'}, s_{t'}, c_{t'+1}) \\
    c_{t'+1} &= A \cdot h_{enc} \\
    A &= \text{softmax}\left( w_v \cdot \text{tanh} ( W_q h_{t'} + W_k h_{enc} ) \right) \\
    \widehat{bg}_{t'+1} &= f(h_{t'+1})
\end{align*}
%}%
\noindent where $X_{[t-n+1, t]}$ is the past $n$ APS states, and $h_{enc}$ represents the input learned by the encoder for all timesteps. In the decoder, $x_{t'}$ is the projected APS state for future time $t'$, $s_{t'}$ is the decoder's internal state composed of a hidden state $h_{t'}$ and a cell state $z_{t'}$, and $c_{t'}$ is the context vector generated by the attention layer using the attention weight matrix $A$. The decoder's hidden state $h_{t'}$ is passed through a feedforward neural network, $f$, to generate the predicted BG value, $\widehat{bg}$. The decoder calculates $s_{t'}$ for $t' \in [t+1, t+m]$, where $m$ is the length of BG predictions. $W_q$, $W_k$, and $w_v$ are weights tuned in the attention layer.

The attention layer within the decoder calculates how much the decoder should weigh each part of the input data (i.e. how much attention it should give) and uses a feedforward neural network to generate attention weights \cite{BahdanauAttn}. In order to help the model learn the delayed action of carbohydrates on BG which needs 15-30 minutes to start impacting BG \cite{30min, freeman2009}, we customize the attention layer to increase the attention weight for input states 30 minutes after a carbohydrate input by 10\%.
%to focus the model's attention on more physiologically relevant parts of the input.   
\subsection{Recommended Increased Bolus for Carb Carry-over}
We propose a method to find a bolus increase threshold for when carbohydrates are entered into the APS controller by the patient while BG is below the safe range. We calculate an increased bolus (IB) using the existing carbohydrate input data in the Basal-Bolus controller (typically used for meal bolus generation). We then recommend the IB to be applied once the BG level has returned to a safe range.

% There exists an increase bolus such that if the increase bolus is injected (given carbohydrates?), then from current time until 24 timesteps (2 hours) from now, BG will be in range
Specifically, our goal is to find a new, corrected bolus $IB$ that is $\delta$ units of insulin greater than the current basal rate, $r_t$, for time $t$ such that all predicted BG values once the target range is entered are in range within the next hour $BG_{[t,t+12]}$: 
\begin{equation}
    IB = r_t + \delta \Rightarrow 70 < BG_{[t,t+24]} < 180
    % \exists {IB} \ni Inj(IB) \rightarrow (i = t, ..., t+24 | 70 < x_i < 180)
\end{equation}

%As a simple solution, we can use fixed $\delta$s (0.0, 0.2, 0.4, ... 3.8, 4.0). 
We set an optimization problem that minimizes timesteps outside of the BG safe range by running in the prediction model using a set of fixed  $\delta$s to find an optimal $\delta$ among them. We then add this $\delta$ value to the normal basal rate to find an $IB$ to be suggested in the alert message.
%Where $Inj()$ is to inject, $i$ is an APS timestep, $t$ is current time, and $x_t$ is predicted BG at time $t$
Solving this optimization problem for the most accurate IB is the subject of future work and beyond the scope of this paper. For this paper, we used domain knowledge and heuristics to add some fixed $\delta$ values for the ideal value to be found among them. 
%Future work will implement an optimization of IB.
%A solution to this problem involves... which is the subject of future work and beyond the scope of this paper.
\subsection{Rebound High Evaluation and Alert Generation}
\begin{table*}[]
    \centering
    \caption{Rebound High Alert System Performance Metrics}
    \vspace{-0.5em}
    \begin{tabular}{c|c|c}
        &\textbf{BG Scenario} & \textbf{Alert Message} \\
        \hline
        1 & $((x_{p} > 180)\wedge(t=p-24,...,p|x_t \not < 70)$ & "Your blood sugar is predicted to increase to 180 mg/dL in the next hour.” \\
        2 & $((x_{p} > 180)\wedge(t=p-24,...,p|x_t < 70)$ & “You are predicted to have a rebound high in the next hour.  \\
        &&  Give a bolus of $IB$ once you are back in range.”  \\
        3 & $((x_{p} < 70)\wedge(t=p-24,...,p|x_t \not > 180)$ & “Your blood sugar is predicted to decrease to 70 $mg/dL$ in the next hour.”  \\
        4 & $((x_{p} < 70)\wedge(t= p-24,...,p|x_t > 180)$ & "You are expected to have a rebound low in the next hour. Consider suspending \\
        && insulin for a period."\\
        5 & else & - no message - \\
        \vspace{1em}
    \end{tabular}
    
    $x_t$ represents predicted BG level at a given timestep $t$, $p$ is the most up-to-date predicted timestep, $IB$ is the calculated Increased Bolus value.
    \label{tab:alert_messages}
    \vspace{-1em}
\end{table*}
% how model is used for rebound high detection
The forecasted BG sequence from the prediction model can be used to detect hyperglycemia, hypoglycemia, and rebound events in advance. Predicted BG and past BG states are categorized to output appropriate alert messages as shown in Table \ref{tab:alert_messages}.
If BG is predicted to be above range without having been below range in the past hour (row 1), or BG is predicted to be below range without having been above range in the past hour (row 3), then general alerts such as those in the existing models \cite{fdaGuardian} are issued.
%If the model is set to make BG predictions for the next hour, a rebound high can be anticipated up to 1 hour beforehand by checking whether any of the expected BG levels are hyperglycemic when after a recent hypoglycemic BG value.
%In the case that a BG is predicted to be out of range (70 mg/dL to 180 mg/dL), a message will be generated to notify the patient of the predicted BG value and the estimated time, as seen in \ref{tab:alert_messages}. A typical prediction horizon 12 timesteps from the current state, where each time step is 5 minutes, resulting in prediction up to 60 minutes before the occurrence of an adverse event. This means that we can generate alerts to warn users to take preventative action well before their BG levels become abnormal. Messages have the format of “Your blood sugar is predicted to (increase/decrease) to (70 $mg/dL$/180 $mg/dL$) in 60 minutes.” 
%Similar message of general high/low predictions, as output by our classifying ML method, exist in current models \cite{fdaGuardian}
%However, in addition to these notifications of general high and low BG alerts (as is commonplace), we have included messages more tailored to the situations of rebound highs and lows. For instance, the message "You are predicted to have a rebound high in the next hour. Please increase basal rate by XXx\% for additional carbs once you are back in range." followed by a message once back in range reminding the patient to increase basal by a suggested amount for excess carbohydrates.
If BG is predicted to be high within two hours of being below range (row 2), then a rebound high alert with recommended IB is issued.
If BG is predicted to be low within two hours of being above range (row 4), then a rebound low alert with recommended basal suspension is issued.
These messages include scenario-specific language for the rebound cases, and they provide specific action suggestions.


% we may need to formally define the problem and ML structure as we did in the KnowsSafe paper
%\textbf{Problem Statement:}
We specifically define the following contextual conditional event to trigger an alert for a rebound high:
%over a combined of input BG trace $BG_{[t-n+1, t]}$ and output BG trace $BG_{[t+1, t+m]}$: 

\vspace{-1em}
% \begin{align}
{%\scriptsize
%Given that current BG is below 70, the probablility of a rebound high is the probablility that predicted BG will be above 180 within 24 steps of the low
%P(RH|x_{c} > 180)= P((x_{t} < 70 | (c - 24) < t < c))
%\begin{equation}    
%P(RH|x_c < 70) = P(x_t > 180 | t = c,...,c+24)
%\end{equation}
}%

\begin{equation}    
%y_t = P(\exists k \in [0. 24]: x_{t_{c}+24-k}>24 |x_{t_{c}-k}<70)
% \Scale[0.8]{y_t = P(\exists l, h \in [t-12,t+12]: l < h \hspace{0.5mm} \wedge \hspace{0.5mm} BG_{l}<70 \hspace{0.5mm} \wedge \hspace{0.5mm} BG_{h}>180)}
%\Scale[0.9]{y_t = P(\exists t \ni t-12<l<h<t+12: BG_{l}<70 \wedge BG_{h}>180)}
\Scale[0.9]{y_t = P(\exists t-12<l\leq t < h\leq t+12: BG_{l}<70 \wedge BG_{h}>180)}
%
% {y_t = P(\exists l, h \in [0,12]: BG_{t-l}<70 \hspace{0.5mm} \wedge \hspace{0.5mm} BG_{t+h}>180)}
\end{equation}
%\begin{equation}    
% RH \Leftrightarrow \exists t_l, t_h \in [t-n+1, t+m] \text{s.t.} t_l < t_u \wedge BG_{t_u} < 70 \wedge BG_{t_h} > 180
%y_t = P(\exists l, h \in [0,24]: BG_{u}>180 |BG_{l}<70)
%\end{equation}
% \begin{equation}
% \label{eq:ml-model}
% \begin{split}
%     % x_{t} &= (x_{1}(t),x_{2}(t),...,x_{m}(t))^T \\ 
%     x_{t} &= (x_{1_{t}},x_{2_{t}},...,x_{n_{t}}) \\
%    % 
%     y_{t} &= p(\exists t'\in [t,t_{e}]: x_{t'} \in {\mathcal{X}}_{h}|x_{t},u_{t})
% \end{split}
% \end{equation}
\noindent where $t$ is the current time and $l$, $h$ are APS timesteps. An alert triggers whenever $y_t \ge 0.5$. $BG$ is the sequence of blood glucose values over 2 hours: (1) observed BG values within the previous hour and (2) predicted BG values for the next hour from the prediction model. This allows for the detection of rebound highs up to 1 hour in advance.
%The prediction model takes in the first hour of BG values as input and predicts the next hour of BG values as output, allowing for detection of rebound highs up to 1 hour in advance.
%\noindent Where $k$ and $t$ are APS timesteps, $t_c$ is current time, $BG$ indicates measured BG, and $x$ represents predicted BG at a given time
%where $RH$ is a rebound high event, $c$ represents current time, $t$ indicates timesteps, $BG$ indicated measured BG, and $x$ represents predicted BG to detect rebound highs.



% we also need to define rebound high/low more apparently as well as its labelling method.
% how we label rebound highs
%A rebound hyperglycemia occurs in when the BG level exceeds 180 mg/dL after being below 70 mg/dL within 2 hours (24 APS timesteps) prior. 

%  I think we could have an overall struct figure of our design in the beginning and then present each section in the similar workflow in the graph.

%\subsection{Predictive Critical BG Alerts:} moved above
\begin{comment}
{\emph{Carb Entry Checker:} 
    %In the "Any clarification/notes about early questions/responses?" the only note left was "Not the best diabetic at remembering to dose."
    For a patient to manage their type 1 diabetes well, it is critical for them to give insulin doses for the amount of carbohydrates they consume. Yet, the failures in dosing appropriately have been widely reported \cite{doseprob1, doseprob3}, with the general conclusion that "Adherence to insulin therapy is generally poor" \cite{doseprob2}. Though patients can set reminders to dose on devices such as phones, with varying mealtimes this is not entirely effective. There are two options for carb reminders in this proposed application:
    \\\begin{enumerate}
    \item {A very general and simplistic method can exist to generate warning messages when blood sugar readings from the CGM increase have increased more than 10 mg/dL within 4 CGM time steps (20 minutes). Of course, this would be an unnecessary message in the case of raising blood sugar apart from a meal, such as routinely occurs during exercise.
    \item A more precise measurements can be found in state-of-the-art meal detection studies. For example, in an earlier work, a simulation-based explanation of meal detection is proposed which is able to detect a meal an average of 27 minutes into the meal within 1 g of carbohydrates consumed \cite{mealDetect}. In order to add this to an app it would have to be partnered with one of these algorithms, made similarly from scratch, or found as an open-source version.
    \\The message at a time when a meal has been detected would be structured like this: "Your blood sugar is increasing rapidly. Please check that you have entered all carbs." If using a more precise algorithm, it could even recommend a predicted carb count, or even inject an insulin dose automatically. This alert would act as a safety net for missing insulin doses.
    %\\It is very pertinent to the discussion surrounding the prevention of rebound hyperglycemia. As in the survey, all participants indicated that when they noticed low blood sugar at the start of the meal they would eat immediately after treating with glucose, and 66.7\% indicated that they typically waited until they were back in range to give insulin for their meal, combined with the facts that the main CGMs on the market today do not notify the patient when their blood sugar is back in range and there has been evidence of missing insulin doses within the treatment of type 1 diabetes among patients, a reminder alert to give insulin for carbs consumed once BG values are increasing could clearly decrease the number of times that a patient forgets to give insulin for an over-correction of low BG.
    }
    \end{enumerate}}
\emph{General Carb entry reminders:} This element of the app is the least complex, but in the same vein of it being critical for patients with type 1 diabetes to have carbs accounted for in their systems, we envision the app having regular reminds several times in a day at common meal (and potentially snack) times.

This feature existing within the same app as the carb entry checker makes sense since they are so closely related, and it can prevent hyperglycemia through patients having support to build carb-entering habits.
%\end{itemize}
\end{comment}


\section{Experimental Evaluation}
\subsection{Datasets}
\begin{figure}
        \centering
    \includegraphics[scale=.45]{Figures/FigEvalGenRemember.png} \\
        \caption{Experimental Evaluation with Realistic Testbeds and Datasets}
        \label{eval}
        \vspace{-2em}
    \end{figure}
As shown in Fig. \ref{eval}, %our closed-loop APS testbed uses the Basal-Bolus controller with UVA-Padova Type I Diabetes Simulation. 
we use three different datasets for developing and evaluating our models, including (i) simulation data generated from a closed-loop APS testbed, (ii) a dataset collected from diabetes patients in a clinical trial, and (iii) APS data collected from one patient  with type 1 diabetes. 

% Simulation data description
\textbf{Simulation Data:} The first dataset we used was generated using the UVA/Padova Type I Diabetes Simulator integrated with an open-source APS controller (Basal-Bolus) \cite{zhou2022design}. 
The simulator uses an Ordinary Differential Equation (ODE)-based patient model that updates using insulin received from the pump and pre-scheduled meals. The pump insulin is determined by the controller, which sets basal rates based on the virtual patient's profile and assigns boluses after a meal. CGM readings are taken from the true patient subcutaneous BG with simulated noise. This simulates a closed-loop APS system, and meals can be scheduled to occur at any simulation time \ref{eval}.

For 10 adult virtual patients, we chose 6 initial BG values each from 80 to 180 and ran 75 simulations at each initial value. In each simulation, the data interacts with the controller for 145 timesteps (12 hours + initial state), with each timestep in the simulation representing 5 minutes in the actual APS. Each simulation had a meal of a random size between 30 and 100 grams of carbohydrates after the first hour. This yielded 65,250 samples per patient, or roughly 7.5 months of data.


% Clinical trail data description
\textbf{Clinical Trial Data:} We also used DCLP3, a publicly-available clinical trial dataset with 6 months of CGM and insulin pump data for each participant \cite{DCLP3-dataset}. We chose 5 patients with at least 6 months of data to use.

% Chloe's data
\textbf{Participant Data:} We also used 5 days of APS data (BG and insulin) retrieved from a patient with type 1 diabetes participating in our research. Because this is not enough data to train the model alone, we used transfer learning with testbed simulation data to supplement model learning.
%by training the model on data from 5 different virtual patients from the UVA/Padova simulator, then fine tuning the model using part of the participant data, and finally evaluating the model on the rest of the participant data.

\subsection{Labeling and Model Training}
For the Simulation and DCLP3 Clinical Trial datasets, we split the data for each patient into train and test sets using an 80/20 split. For participant data, we used the same 80/20 split, but we first trained the model on data from 5 different virtual patients from the UVA/Padova simulator and then fine tuned the model with a low learning rate to the participant train data. The model was trained using teacher forcing and mean squared error (MSE) loss. 

Because carbohydrate inputs from meals are recorded as one large input regardless of consumption rate, we assumed a casual eating rate of 5 CHO g/min and split the carbohydrates from the meal across multiple timesteps. For example, if a meal of 60 g of CHO was recorded a timestep $t$, we split this into 25 g at $t$, 25 g at $t+1$, and 10 g at $t+2$. This eating rate is an approximation across different patients and different food types and is meant to help the model learn by increasing the number of inputs where the CHO value is non-zero.

To determine frequency of rebound highs in each dataset, we traversed through the dataset sorted by time,  keeping track of the most recent BG level below 70 $mg/dL$. For each CGM measurement above 180 $mg/dL$, we checked whether it was within 2 hours (24 timesteps) of the most recent BG sample below 70 $mg/dL$, and if it was, it was labeled as a rebound high and the < 70 sample was reset to prevent double counting.

The model monitor generates a rebound high alert whenever a high BG level follows a low BG level in the combined sequence of input and predicted BG values. To test the ability of the model to generate an alert when necessary, we used the test data from the regression task. If the combined sequence of input and true BG values contained a rebound high, then the combined sequence of input and predicted BG values should also contain a rebound high. Otherwise, the alert would not be triggered. Therefore, we could use the regression test data to evaluate the accuracy of rebound high alerts as well. 

\subsection{Results}
% results
The accuracy of BG regression model on each patient is shown in Table \ref{reg_results}. In general, the root mean squared error (RMSE) of the model is higher on clinical trial patient data than simulated data because the clinical trial data suffers from missing records of carbohydrate meals, time inconsistencies, and minor physiological effects not accounted for in the simulation's patient model. During the simulation of virtual patients, we could record both CGM measurements and the patient's actual subcutaneous BG levels that the CGM samples, allowing us to determine simulation sensor error by calculating the RMSE between CGM measurements and subcutaneous BG levels. This CGM RMSE provides a target for model performance, because the model learns from CGM data and cannot reduce this random noise on its own. We do not have a similar estimate for clinical trial data because we do not know the patients' true internal states. % Prediction accuracy for the BG Regression is shown in Table \ref{reg_results}.

% \subsection{Simulation Evaluation}
The number of rebound high events in each dataset is shown in Figure \ref{fig:rebound_high_hist}. Rebound highs are much more frequent in real patient data, as all but one DCLP3 patient had over 90 rebound highs in 6 months and the participant had 3 in 5 days, while simulated patients only had 3-12 in 225 days of simulation. 
\begin{table}[t!]
    %\vspace{-2em}
    \centering
    \caption{Prediction Accuracy for BG Regression}
    \begin{tabular}{c c c c c c c}
         \multicolumn{2}{c}{\textbf{Patient ID}} & \textbf{RMSE} & \textbf{CGM RMSE} & \multicolumn{2}{c}{\textbf{Patient ID}} & \textbf{RMSE} \\
        \hline
        
        \parbox[t]{10mm}{\multirow{10}{*}{UVA Sim.}} & 1 & 11.808 & 11.011 & \parbox[t]{10mm}{\multirow{5}{*}{DCLP3}} & 3 & 27.750\\
         & 2 & 13.539 & 11.061 && 4 & 28.546\\
         & 3 & 14.166 & 11.148 && 5 & 17.988\\
         & 4 & 12.043 & 11.105 && 6 & 32.718\\
         & 5 & 14.010 & 11.114 && 7 & 38.050\\ \cline{5-7}
         & 6 & 12.342 & 11.027 & Participant & P & 31.213\\
         & 7 & 13.338 & 11.020 \\
         & 8 & 11.875 & 10.982 \\
         & 9 & 12.390 & 11.039 \\
    \end{tabular}
    \label{tab:reg_results}
    \label{reg_results}
    \vspace{-1.5em}
\end{table}
\begin{comment}
\begin{table}[t!]
    %\vspace{-2em}
    \centering
    \caption{Prediction Accuracy for BG Regression}
    \begin{tabular}{c c c c}
         \multicolumn{2}{c}{\textbf{Patient ID}} & \textbf{RMSE} & \textbf{CGM RMSE} \\
        \hline
        \parbox[t]{10mm}{\multirow{10}{*}{UVA Sim.}} & 1 & 11.808 & 11.011 \\
         & 2 & 13.539 & 11.061 \\
         & 3 & 14.166 & 11.148 \\
         & 4 & 12.043 & 11.105 \\
         & 5 & 14.010 & 11.114 \\ 
         & 6 & 12.342 & 11.027 \\
         & 7 & 13.338 & 11.020 \\
         & 8 & 11.875 & 10.982 \\
         & 9 & 12.390 & 11.039 \\
         & 10 & 14.748 & 11.129 \vspace{1mm}\\ \hline
         \parbox[t]{10mm}{\multirow{5}{*}{DCLP3}} & 3 & 27.750 & - \\
         & 4 & 28.546 & - \\
         & 5 & 17.988 & - \\
         & 6 & 32.718 & - \\
         & 7 & 38.050 & - \\ \hline
         Participant & P & 31.213 & - 
    \end{tabular}
    \label{tab:reg_results}
    \label{reg_results}
    \vspace{-1.5em}
\end{table}
\end{comment}
Because the DCLP3 patients had far more rebound high events, we use these patients to evaluate the rebound high alert system, as shown in Table \ref{tab:alert_metrics}. One of the DCLP3 patients (number 5) did not have the same high number of rebound highs as the others, and ended up having no rebound highs in the test data to trigger an alert, and was therefore omitted. The model performed with >98\% accuracy and >79\% precision for all DCLP3 patients, but suffered from a low recall score, indicating that false negatives were too frequent and may be a consequence of the model's poorer performance on clinical trial data.

%Using simulation data as detailed previously \ref{workflowdata}, we achieved Xxx\% accuracy and Xxx\% timeliness in Xxx runs.
%get our data, (transfer learning on my data), train the model, evaluate on test

%\subsubsection{Participant Data}
%In the participant data (trained using UVA/Padova Type I Diabetes Simulator and tuned on some of the participant data \ref{workflowdata}), we found 3 rebound high events in ~5 days of data.
%This resulted in Xxx\% accuracy and Xxx\% timeliness.


\begin{table}[h!]
    \caption{Rebound High Alert System Performance Metrics}
    \resizebox{\columnwidth}{!}{%
    \begin{tabular}{c|c|c|c|c|c}
        \textbf{DCLP3} & \textbf{Rebound High} & \textbf{Accuracy} & \textbf{Precision} & \textbf{Recall} & \textbf{F1 Score} \\
        \textbf{Patient}&\textbf{Alerts to Issue}&&&& \\
        \hline
        3 & 148 & 98.3 & 96.0 & 21.7 & 35.4 \\
        4 & 221 & 99.1 & 79.4 & 36.5 & 50.0 \\
        6 & 231 & 98.8 & 89.9 & 46.3 & 61.1 \\
        7 & 221 & 98.6 & 96.9 & 28.5 & 44.1 \\
    \end{tabular}
    }
    \label{tab:alert_metrics}
    \vspace{-1.5em}
\end{table}

\begin{comment}
\subsection{Initial Survey}

The commonplace of rebound hyperglycemia is supported by the survey responses of a survey we sent to ~10 patients with type 1 diabetes. When asked to select on a scale from "Never" to "Very Often" with the statement "After I have low blood sugar, I have a rebound high blood sugar" all of them answered in a mid range but one who selected "Very often." When asked the same in regards to the statement "After I have a high blood sugar, I have a rebound low blood sugar" all of them answered in a mid range.

All participants indicated that "If [they] realize [they] have low blood sugar at the start of a meal," they will still eat the meal before their blood sugar returns to safe range. Two-thirds stated that in the case of being low at a mealtime, they would wait until they are back in range to give insulin for the meal. Of the participants who indicated waiting until they were back in range, 74.96\% said they would give a full injection for the carbohydrates eaten, whereas the remaining 25.04\% give a partial insulin injection for the carbohydrates eaten. This section of the survey gives support for our carry-over carb method and application reminders for when the user is back in range, since all of the participants indicated over correcting for their hypoglycemia at mealtimes, and the majority wait until they are back in range to give any insulin. This leaves room for error, since current CGMs do not typically alert users when they are back in range.

Two-thirds of participants indicated that they don't feel low blood sugar symptoms until they are in the low range (they start feeling symptoms at 70 $mg/dL$ or below), and 83.3\% indicated that they don't begin to feel high BG symptoms until they are in high range (they start feeling symptoms at 180 $mg/dL$ or above). This gives support for rebound high predictive alerts and our carry-over carb method to prevent the rebound highs. 
\end{comment}

\section{Conclusion and Future Work}
This paper proposes extending the APS controllers with capabilities for the prediction and prevention of rebound hyperglycemia events. We present an ML BG prediction method that outputs trending alert messages using scenario-specific language to refer to rebound highs along with suggested increased bolus thresholds based on carbohydrate input in cases of hypoglycemia when a rebound high is predicted. Experimental results show that the proposed method achieves >98\% accuracy and >79\% precision for all DCLP3 patients.

Future work will involve the optimization and automation of carbohydrate carry-over bolus increases since our process has the limitations of heuristics and requiring unnecessary user action. 
In addition, future work will involve calculating more exact carbohydrate intake recommendations in the cases of hypoglycemia and the case of rebound lows
%In addition, we conducted a small survey surrounding habits of out of range BG prediction and treatment, which supported the need for study. We also 
%future work includes the proposal, creation, and evaluation of an application or feature set to be added to an existing controller in order to synthesize our prediction and alert system with carbohydrate entry reminders (both reminders at set time intervals and detected reminders based on meal prediction). 
We will also focus on the integration of the proposed rebound evaluation module with carbohydrate entry reminders on an existing APS controller and evaluation using patient feedback. 
%In addition, future work will involve calculating more exact carbohydrate intake recommendations in the cases of hypoglycemia and the case of rebound lows, similarly to how we calculated IB in this paper.

\begin{figure}[t!]
    \vspace{-0.5em}
    \centering
    \includegraphics[scale=0.45]{Figures/rebound_high_histogram.png}
    \vspace{-0.2em}
    \caption{Rebound High Count Across Patients}
    \label{fig:rebound_high_hist}
    \vspace{-1em}
\end{figure}

%As we have proposed an app that will synthesize several of our ideas, in the future a creation of the app and a study of its effects would be a good step forward. An extended research study on both the app once created as well as the carry-over carb method using real-time participants could prove very useful. Finally, an automation of the carry-over insulin increase rather than a reminder for patient action would eliminate unnecessary patient action in the instance of predicted rebound high.

\begin{comment}

% \vspace{-1em}
\section*{Acknowledgment}
\vspace{-0.75em}
This material is based upon work supported by the National Science Foundation (NSF) under Grant No. 1748737.
\end{comment}

%This work was supported by a grant from the U.S. National Science Foundation (No. 1748737) and a research innovation award from the University of Virginia.
% %This work was partially supported by a grant from the U.S. National Science Foundation (Award No. 1748737) and a SEAS research innovation award from the University of Virginia, School of Engineering and Applied Science (SEAS).
% \vspace{-1.5em}
\bibliographystyle{IEEEtran}
\bibliography{main.bib}
%%TC:endignore
% \input{appendix.tex}
\end{document}

