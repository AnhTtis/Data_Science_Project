\tikzset{enc_net/.pic={
    \node[draw, circle, fill] (il1) at (-1, 0.5) {};
    \node[draw, circle, fill] (il2) at (-1, -0.5) {};

    \node[draw, circle, fill] (hl1) at (0, 1) {};
    \node[draw, circle, fill] (hl2) at (0, 0) {};
    \node[draw, circle, fill] (hl3) at (0, -1) {};
    
    \foreach \start in {il1, il2}
    {
        \foreach \stop in {hl1, hl2, hl3}
            \draw[-stealth] (\start) -- (\stop);
    }        
    
    \node[draw, circle, fill] (ol1) at (1, 1) {};
    \node[draw, circle, fill] (ol2) at (1, 0) {};
    \node[draw, circle, fill] (ol3) at (1, -1) {};

    \foreach \start in  {hl1, hl2, hl3}
    {
        \foreach \stop in {ol1, ol2, ol3}
            \draw[-stealth] (\start) -- (\stop);
    }
}
}

\tikzset{dec_net/.pic={
    \node[draw, circle, fill] (il1) at (-1, 1) {};
    \node[draw, circle, fill] (il2) at (-1, 0) {};
    \node[draw, circle, fill] (il3) at (-1, -1) {};
    
    \node[draw, circle, fill] (hl1) at (0, 1) {};
    \node[draw, circle, fill] (hl2) at (0, 0) {};
    \node[draw, circle, fill] (hl3) at (0, -1) {};
    
    \foreach \start in {il1, il2, il3}
    {
        \foreach \stop in {hl1, hl2, hl3}
            \draw[-stealth] (\start) -- (\stop);
    }        
    
    \node[draw, circle, fill] (ol1) at (1, 0.5) {};
    \node[draw, circle, fill] (ol2) at (1, -0.5) {};

    \foreach \start in  {hl1, hl2, hl3}
    {
        \foreach \stop in {ol1, ol2}
            \draw[-stealth] (\start) -- (\stop);
    }
}
}

\tikzset{rnn_node/.pic={
    \node[draw, circle, fill] (il1) at (-1, 1) {};
    \node[draw, circle, fill] (il2) at (-1, 0) {};
    \node[draw, circle, fill] (il3) at (-1, -1) {};
    
    \node[draw, circle, fill] (hl1) at (0, 1) {};
    \node[draw, circle, fill] (hl2) at (0, 0) {};
    \node[draw, circle, fill] (hl3) at (0, -1) {};
    
    \foreach \start in {il1, il2, il3}
    {
        \foreach \stop in {hl1, hl2, hl3}
            \draw[-stealth] (\start) -- (\stop);
    }        
    
    \node[draw, circle, fill] (ol1) at (1, 1) {};
    \node[draw, circle, fill] (ol2) at (1, 0) {};
    \node[draw, circle, fill] (ol3) at (1, -1) {};

    \foreach \start in  {hl1, hl2, hl3}
    {
        \foreach \stop in {ol1, ol2, ol3}
            \draw[-stealth] (\start) -- (\stop);
    }
}
}

\tikzset{>={Latex[width=2mm, length=3mm]}}

\begin{tikzpicture}[every node/.style={scale=1.5}, thick]
    \def\netscale{0.6}
    \tikzstyle emphs=[scale=1.5,thin,rectangle,draw,fill=green!10!white, rounded corners=8pt]
    %\node[draw, rectangle, fill=white] (encoder) at (0, 0) {$\Encoder$};
    \def\rcenter{(0, 6)}
    
    \draw[] ++\rcenter +(-2, -2) rectangle +(2, 2);
    \node[anchor=north west] at ([shift={\rcenter}]-2, 2) {Encoder};
    \node[] at ([shift={\rcenter}]0, -2) (encoderbelow) {};
    \node (encodertop) at ([shift=\rcenter] 0, 2) {};
    
    \node[anchor=south, above= of encodertop, style=emphs] (X) {$x_0$};
    \draw[->] (X) -- (encodertop.center) ;
    \begin{scope}[shift={(\rcenter)}]
        \pic[scale=\netscale, draw, fill=red]{enc_net};
    \end{scope}
    
    \draw[dashed, fill=blue!5!white] (-2.5, -2.5) rectangle (17.5, 2.5);
    \node[anchor=south, scale=1.2] at (7.5, 2.5) {RNN};
    
    \def\rcenter{(0,0)}
    \node[draw, circle] at \rcenter {};
    \draw ++\rcenter +(-2, -2) rectangle +(2, 2);
    \node[anchor=north west] at ([shift={\rcenter}]-2, 2) {RNN cell};
    \node[] at ([shift={\rcenter}]-2, 0) (rnnleft0) {};
    \node[] at ([shift={\rcenter}]2, 0) (rnnright0) {};
    \node[] at ([shift={\rcenter}]0, 2) (rnntop0) {};
    \node[] at ([shift={\rcenter}]0, -2) (rnnbelow0) {};
    \draw[->] (encoderbelow.center) -- (rnntop0.center) node[scale=1.2, midway, anchor=east] {$z_0$};
    \node[below= of rnnbelow0, anchor=north, style=emphs] (u1) {$(u_1, \tau_1)$} ;
    \draw[->] (u1) -- (rnnbelow0.center);
    \begin{scope}[shift={(\rcenter)}]
        \pic[scale=\netscale, draw, fill=blue]{rnn_node};
    \end{scope}
     
     \foreach \i / \x [remember=\i as \iprev initially 0, evaluate={\inext=int(\i+1)}] in {1/5, 2/10, 3/15}
     {
         \def\rcenter{(\x,0)}
         \node[draw, circle] at \rcenter {};
         \draw ++\rcenter +(-2, -2) rectangle +(2, 2);
         \node[anchor=north west] at ([shift={\rcenter}]-2, 2) {RNN cell};
         \node[] at ([shift={\rcenter}]-2, 0) (rnnleft\i) {};
         \node[] at ([shift={\rcenter}]2, 0) (rnnright\i) {};
         \node[] at ([shift={\rcenter}]0, 2) (rnntop\i) {};
         \node[] at ([shift={\rcenter}]0, -2) (rnnbelow\i) {};
         \draw[->] (rnnright\iprev.center) -- (rnnleft\i.center) node[scale=1.2, midway, anchor=south] {$z_{\i}$};
         \node[below= of rnnbelow\i, anchor=north, style=emphs] (u\inext) {$(u_{\inext}, \tau_{\inext})$};
         \draw[->] (u\inext) -- (rnnbelow\i.center);
         
         \begin{scope}[xshift=\x cm]
             \pic[scale=\netscale, draw, fill=blue]{rnn_node};
         \end{scope}
    }
    
    \def\rcenter{(15,6)}
    \node[draw, circle] at \rcenter {};
    \draw ++\rcenter +(-2, -2) rectangle +(2, 2);
    \node[anchor=north west] at ([shift={\rcenter}]-2, 2) {Decoder};
    \node[] at ([shift={\rcenter}]0, -2) (decoderbelow) {};
    \node[] at ([shift={\rcenter}]0, 2) (decodertop) {};
    \begin{scope}[shift={(\rcenter)}]
        \pic[scale=\netscale, draw, fill=green]{dec_net};
    \end{scope}     
    
    \draw[->] ([shift={(0, 0.5)}]rnntop3.center) -- (decoderbelow.center) node[scale=1.2, midway, anchor=east] {$\tau_4 z_4 + (1 - \tau_4)z_3$};
    \node[anchor=south, above=of decodertop, style=emphs] (Y) {$\hat\Flow(s, x_0, u)$};
    \draw[->] (decodertop.center) -- (Y) ;
\end{tikzpicture}