\documentclass[12pt]{article}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{graphicx,psfrag,epsf}
\usepackage{psfrag,epsf}
\usepackage{enumitem}
\usepackage{natbib}
\usepackage{url} % not crucial - just used below for the URL 
\usepackage[titletoc,title]{appendix}
\usepackage{array}
\usepackage{bm}
\usepackage{color}
\usepackage{graphicx}
\usepackage{epstopdf}
\usepackage[letterpaper, portrait, margin=1in]{geometry}
\usepackage{lipsum}
\usepackage{listings}
\usepackage{fancyref}
\usepackage{float}
\usepackage[font=footnotesize,labelfont=bf]{caption}
\usepackage{color}	
\usepackage{lscape}
\usepackage{mathtools}

\usepackage{xr}
\externaldocument{iv_post_append}

\usepackage{xcite}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{booktabs}
\usepackage[normalem]{ulem}

\newtheorem{lemma}{Lemma}[section]
\newtheorem{theorem}{Theorem}[section]
\newtheorem{proposition}{Proposition}[section]
\newtheorem{corollary}{Corollary}[section]
\newtheorem{assumption}{Assumption}[section]
\newtheorem{result}{Result}[section]
%\newtheorem*{remark}{Remark}

\usepackage{setspace}


 
\newtheorem*{remark}{Remark}

\newcommand{\ind}[1]{\b1_{\left\{#1\right\}}}
\newcommand*\ITT{\text{ITT}}
\newcommand*\CACE{\tau}


\title{Improving instrumental variable estimators with post-stratification}
\author{  Nicole E. Pashley\\Department of Statistics, Rutgers University \and Luke Keele \\Departments of Surgery and Biostatistics, University of Pennsylvania\and Luke W. Miratrix\\Graduate School of Education, Harvard University }



\begin{document}
\maketitle

\begin{abstract}
An instrumental variable (IV) is a device that encourages units in a study to be exposed to a treatment.
Under a set of key assumptions, a valid instrument allows for consistent estimation of treatment effects for compliers (those who are only exposed to treatment when encouraged to do so) even in the presence of unobserved confounders. Unfortunately, popular IV estimators can be unstable in studies with a small fraction of compliers. Here, we explore post-stratifying the data using variables that predict complier status (and, potentially, the outcome) to yield better estimation and inferential properties. We outline an estimator that is a weighted average of IV estimates within each stratum, weighing the stratum estimates by their estimated proportion of compliers. 
We then explore the benefits of post-stratification in terms of bias reduction, variance reduction, and improved standard error estimates, providing derivations that identify the direction of bias as a function of the relative means of the compliers and non-compliers. We also provide a finite-sample asymptotic formula for the variance of the post-stratified estimators.
We demonstrate the relative performances of different IV approaches in simulations studies and discuss the advantages of our design-based post-stratification approach over incorporating compliance-predictive covariates into two-stage least squares regressions.
In the end, we show covariates predictive of outcome can increase precision, but only if one is willing to make a bias-variance trade-off by down-weighting or dropping those strata with few compliers. Our methods are further exemplified in an application.
\end{abstract}

\noindent%
{\it Keywords:} Blocking; Compliance; Instrumental Variables; Post-stratification; Randomization Inference.
\vfill


\doublespacing

\section{Introduction}

In many studies focused on the estimation of causal effects, the investigator assumes there are no unobservable differences between the treated and control groups (possibly after conditioning on observed characteristics of the units).
While this assumption may be plausible in some settings, treatments are often purposefully chosen and the data may not record all the reasons why a particular treatment was administered or withheld. One alternative to the assumption of no unmeasured confounding is to identify an instrument. Instruments arise primarily in two ways. First, in randomized experiments with noncompliance, randomization to treatment arms serves as an instrument for compliance with the experimental protocol. The second type of instrument is a form of natural experiment, where some circumstance produces haphazard encouragement for units to be exposed to a treatment. In either setting, for a variable to be an instrument the following three core assumptions must hold: (1) the IV must have a nonzero effect on treatment exposure, (2) the IV must be randomly or as-if randomly assigned, (3) the IV must itself not have a direct effect on the outcome \citep{AngImbRub96}. If these assumptions hold, an IV design provides a consistent estimate of the causal effect of the exposure on the outcome for so-called \emph{compliers} (those who only take treatment upon encouragement \citep{AngImbRub96}), even in the presence of unobserved confounding between the treatment and the outcome. For example, \citet{davies2013cox} present an application where IV estimates are consistent with the results from randomized trials, while estimates based on the assumption of no unmeasured confounding contradict these results.

One strand of research has explored how to use auxiliary covariate information to improve IV analyses. For example, covariates have been used to help bound effects when the exclusion restriction, a key IV assumption, does not hold \citep{mealli2013using,miratrix2018bounding}. Covariates also play a vital role in the principal scores literature \citep{ding2017principal, feller2017principal}, which relaxes the exclusion restriction with a weaker principal ignorability assumption.
Covariates are also routinely used in Bayesian principal stratification to reduce model dependence and improve precision \citep{imbens1997bayesian, hirano2000assessing, mealli2012refreshing}.

Here, we focus on how to use baseline covariates to improve IV estimates in applications where the instrument is not strongly predictive of treatment. When the instrument has only a small impact on the proportion of subjects who take treatment, the instrument is said to be weak \citep{Bound:1995,Staiger:1997}. When an IV is weak, IV estimates may be biased and the associated confidence intervals may have poor coverage. As such, analysts generally test for the presence of a weak instrument as an initial step in an IV analysis \citep{Stock:2005}. One interesting question is how analysts might improve studies where the instrument manages to pass a weak instrument test, but is not strong. One natural source of improvement would be to use covariates in the analysis.

Generally, the literature has not focused on how to exploit covariates that are only predictive of \emph{compliance}. We show that covariates predictive of compliance do not benefit an analysis the same way as covariates predictive of precision. In particular, we demonstrate that classic IV estimation methods such as two-stage least squares (2SLS) provide minimal gains with complier-predictive covariates. We therefore propose a method based on post-stratification, where we stratify units based on baseline covariates, estimate a separate IV estimator within each stratum, and then take their average, weighting by the estimated number of compliers. If some strata are estimated to have zero compliers, we drop them from our overall estimate. The goal is to concentrate our compliers into a few strata where we can estimate impacts more easily. The strata with only a few compliers can be down-weighted, as they would be less relevant for the overall impact estimate.
Our proposed post-stratification methods are related to extant methods where, when the IV is continuous, matching methods are used to match units that are different in terms of their exposure to the IV \citep{Small:2008,baiocchi2012near,keele2016strong}.
In the matching IV literature, a similar estimator to one of our post-stratified IV estimators is for the complier average treatment effect.
However, the goal in the matching IV literature is to mitigate bias from confounders in the observational setting and to match units that are far apart in terms of the instrument.
We, on the other hand, are focusing on the use of post-stratification (which is more general than standard pairwise matching) to reduce variation and we discuss how modifications of the natural post-stratified IV estimator can lead to better precision gains.


Ideally, post stratification strategy would give a more precise estimator if the covariates used for stratification are predictive of outcome or compliance, due to inherently more stable estimates within each group. Surprisingly, we find that although this estimator does take advantage of stratification variables predictive of outcome, it can fail to take advantage of covariates predictive of compliance.
Furthermore, most gains are driven by dropping empty strata, because of the precision boost from eliminating unstable IV estimators that are just contributing noise to the overall estimator. However, as we show, if we are not able to separate compliers and non-compliers cleanly enough to reliably drop any strata, our post-stratified estimator is identical to the ratio of a post-stratified estimate of the intent-to-treat (ITT) effect and a post-stratified estimate of the compliance proportion, which in turn is very similar to the ineffective 2SLS estimator. As such, we explore other stratification estimators that more aggressively drop or down-weight those strata with few compliers to obtain further gains. Dropping or down-weighting strata does come at a cost of some additional bias, however, leaving us with a bias-variance tradeoff when using complier-predictive covariates.

Overall, we outline how post-stratification estimators can provide three potential benefits for impact estimation: (1) a reduction in the variance, (2) a reduction in the bias, and (3) a reduction in the variability of the estimated standard error. We first provide theoretical derivations for the behavior of this estimator. We then study the properties of the post-stratification IV estimator using a detailed simulation study. We find that post-stratification shows improvement in overall precision with covariates predictive of outcome, and that the versions that drop low weight strata can also achieve precision gains at the cost of a small amount of bias.
We then apply these methods to two empirical examples, one regarding a get-out-the-vote study and one regarding impact of intensive care admission on mortality. We conclude with a discussion of when post-stratification IV estimators could be usefully employed.


\section{The IV Framework}

We have $N$ units. Each unit has treatment indicator $Z_i \in \{0,1\}$ and associated outcomes under treatment and control, $Y_i(1)$ and $Y_i(0)$. We also have indicators for actual treatment receipt when assigned to treatment $z$, $D_i(z) \in \{0,1\}$.
$D_i$ and $Y_i$ will be the observed values for unit $i$ after treatment assignment. We assume the Stable Unit Treatment Value Assumption \citep[SUTVA,][]{rubin_1980}: what happens to any unit does not impact the potential outcomes of any other unit and there are no hidden treatment levels. 

Under this framework, the three core IV assumptions are \citep{AngImbRub96}:

\begin{assumption}\label{assump:iv} The three core IV assumptions:

\begin{enumerate}[wide=\parindent, label={\textbf{Part~\Alph*:}},
  ref={assumption~\theassumption.\Alph*}]

	\item Effective random assignment: $Z$ is independent of $D(z)$ and $Y(z)$, given $\bm X$, for $z = 0,1$. More narrowly, we assume there are $n_1$ units randomly assigned to treatment according to complete randomization, leaving $n_0 = N-n_1$ units in control. We take $p =n_1/N$ with $p \in (0,1)$ as fixed.\footnote{For asymptotic arguments, this can be relaxed to just ensure that $n_1/N \to p$ and $N \to \infty$.}
\item Exclusion restriction: $Z_i$ only impacts $Y_i$ through $D_i$, meaning there are no treatment impacts on anyone but the compliers, so $Y_i(1) = Y_i(0)$ if $D_i(1) = D_i(0)$.
	\item Relevance: $Z$ has a nonzero effect on $D$, i.e., we have at least some compliers in our dataset.
\end{enumerate} 
\end{assumption}

In the IV design, we can stratify the study population into the following groups, where unit $i$ is a...
\begin{align*}
\text{complier} & \text{ if } D_i(1) = 1, D_i(0)=0,\\
\text{always-taker} & \text{ if } D_i(1) = 1, D_i(0)=1,\\
\text{never-taker} & \text{ if } D_i(1) = 0, D_i(0)=0,\\
\text{defier} & \text{ if } D_i(1) = 0, D_i(0)=1.
\end{align*}

Beyond these core IV assumptions, many IV studies, including this one, also invoke the monotonicity assumption, which is that there are no ``defiers,'' or those who do the opposite of their assigned status.
This assumption is usually stated as:

\begin{assumption}\label{assump:mono}
Monotonicity: $D_i(1) \geq D_i(0)$.
\end{assumption}

Next, let $\pi_c$ be the true proportion of compliers.
Further let $n_c = \pi_cN$ be the number of compliers and $n_{c,z}$ be the number of compliers under treatment $z$. We use analogous notation for quantities related to always-takers and never-takers (e.g., $\pi_a$ and $\pi_n$ for the proportion of always-takes and never-takers, respectively).
Define an indicator for being a complier as $C_i = 1$ if $D_i(1) = 1, D_i(0) = 0$, and $C_i = 0$ otherwise.
Under monotonicity, we focus on the complier average causal effect (CACE) estimand:
\[ 
\CACE = \bar{Y}_c(1) - \bar{Y}_c(0) \mbox{ where } \bar{Y}_c(z) = \frac{1}{n_c}\sum_{i=1}^N C_i Y_i(z).
\]

Another useful quantity is the intention-to-treat effect (ITT).
The ITT is $\bar{Y}(1) - \bar{Y}(0)$ with $\bar{Y}(z) = \frac{1}{N}\sum_{i=1}^N Y_i(z)$.
Due to the exclusion restriction and monotonicity we have
\[ 
\ITT = \frac{1}{N} \sum_{i=1}^N\left[ Y_i(1) - Y_i(0) \right]= \frac{1}{N} \sum_{i: C_i = 1} \left[Y_i(1) - Y_i(0) \right]+ \frac{1}{N} \sum_{i: C_i \neq 1} \left[Y_i(1) - Y_i(0)\right] = \pi_c \tau .
\] 

\subsection{IV Point and Variance Estimation}\label{sec:standard_iv_est}

The standard IV estimator for the CACE is
\[ 
\widehat{\CACE}_{\text{IV}} = \frac{ \widehat{\ITT} }{ \widehat{f} } ,
\]
where the ITT estimator of $\widehat{\ITT} = \bar{Y}^{obs}(1) - \bar{Y}^{obs}(0)$, with
\[
\bar{Y}^{obs}(z) = \frac{1}{n_z}\sum_{i: Z_i=z}Y_i(z), 
\]
is the numerator and the estimated proportion of compliers, $\pi_c$, is the denominator.
We can estimate $\pi_c$ via
\[
\widehat{f} =\bar{D}^{obs}(1) - \bar{D}^{obs}(0)= \frac{1}{n_1}\sum_{i=1}^NZ_iD_i(1) - \frac{1}{n_0}\sum_{i=1}^N(1-Z_i)D_i(0). 
\]
Because $E[  \widehat{\ITT} ] = \pi_c \tau $ and $E[ \widehat{f} ] = \pi_c$, $\widehat{\CACE}_{\text{IV}}$ provides a reasonable estimate of $\tau$.
That being said, $\widehat{\CACE}_{\text{IV}}$, as a ratio estimator, will not be unbiased because $E[ A / B] \neq E[ A ]/ E[B]$ in general.

We can approximate the variance of $\widehat{\CACE}_{\text{IV}}$ using the delta method.
To define the finite-sample asymptotic variance, we require the following regularity assumptions:

\begin{assumption}\label{assump:IV_CLT}
Let $c(z) = \max_{1 \leq i \leq N} \left(Y_i(z) - \bar{Y}(z)\right)^2$. As $N \to \infty$,
\[\max_{z\in \{0,1\}}\frac{1}{n_z^2}\frac{c(z)}{n_0^{-1}S^2_Y(0) + n_1^{-1}S^2_Y(1) - N^{-1}S^2_Y(01)}\]
\end{assumption}

\begin{assumption}\label{assump:IV_CLT_uptake}
$\pi_{c}$, $\pi_{a}$, and $\pi_{n}$ have asymptotic limiting values such that at least two of those proportions are nonzero.\footnote{See Supplementary Material~\ref{app:var_cond_simple} for why this condition is sufficient for obtaining a central limit theorem result for treatment uptake. }
\end{assumption}

\begin{assumption}\label{assump:delta}
$N\text{var}(\widehat{\ITT})$ has a finite limiting value, to help ensure $\widehat{\ITT} - \ITT \overset{p}{\to} 0 $.
\end{assumption}
Next, we define:
\[S^2_Y(z) = \frac{1}{N-1}\sum_{i=1}^N \left(Y_i(z) - \bar{Y}(z) \right)^2\]
and
\[S^2_Y(01) = \frac{1}{N-1}\sum_{i=1}^N \left(Y_i(1) -Y_i(0)  - \bar{Y}(1) + \bar{Y}(0) \right)^2.\]
\begin{align*}
S^2_D(1) &= \frac{N}{N-1}\pi_{n}(\pi_{c} + \pi_{a}),\\
S^2_D(0) &= \ \frac{N}{N-1}\pi_{a}(\pi_{c} + \pi_{n}),
\end{align*}
and
\begin{align*}
S^2_D(01) = \frac{N}{N-1}\pi_{c}(\pi_{a} + \pi_{n}).
\end{align*}

We can apply the finite-population Central Limit Theorem (CLT) framework to our $\widehat{\ITT} $ estimator under Assumption~\ref{assump:IV_CLT} based on Theorem 4 of \cite{LiDin17}. Similarly, we can obtain a finite-population CLT for treatment uptake, $\widehat{f}$, under Assumption~\ref{assump:IV_CLT_uptake}. 
By combining the CLT with Assumption~\ref{assump:delta} and an asymptotic  version of the relevance assumption (Assumption~\ref{assump:iv}.3), where $\pi_c$ has a nonzero limiting value, we can use the finite-population delta method to derive an asymptotic variance for $\widehat{\tau}_{\text{IV}}$ \citep{pashley2019note}. The formal expression for the asymptotic variance for $\widehat{\tau}_{\text{IV}}$ is
\begin{align}
\text{asyVar}\left(\widehat{\CACE}_{\text{IV}} \right) &=\frac{1}{\pi_c^2}\textrm{var}(\widehat{\ITT}) +\CACE^2\frac{1}{\pi_c^2}\textrm{var}(\widehat{f}) -2\CACE\frac{1}{\pi_c^2}\textrm{cov}(\widehat{\ITT}, \widehat{f}). \label{eq:delta_variance}
\end{align}
%The expression for $\widehat{f}$ is analogous.\cmntM{To what?  Isn't this one just Neyman?}
If all units are compliers, Equation~\ref{eq:delta_variance} collapses to $\textrm{var}(\widehat{\ITT})$.
We can rewrite the asymptotic variance as follows:
\begin{align*}
\text{asyVar}(\widehat{\CACE}_{\text{IV}})=&\frac{1}{\pi_c^2}\textrm{var}\left(\widehat{\ITT}- \CACE \widehat{f}\right) \\
=& \frac{1}{\pi_c^2}\frac{1}{(N-1)}\Bigg \{ \frac{1}{n_0}\sum_{i=1}^N\left( \tilde{Y}_i(0) - \bar{\tilde{Y}}(0) \right)^2 
  + \frac{1}{n_1}\sum_{i=1}^N \left(\tilde{Y}_i(1) - \bar{\tilde{Y}}(1) \right)^2 \\
& - \frac{1}{N}\sum_{i=1}^N \left(\widetilde{ITT}_i -  \widetilde{ITT}\right)^2  \Bigg \} ,
\end{align*}
where $\tilde{Y}_i(z) = Y_i(z) - \tau D_i(z)$ is an adjusted potential outcome based on $Y_i(z)$ and $D_i(z)$, so that $\widetilde{ITT}_i = Y_i(1) - Y_i(0) - \tau \left[D_i(1) -D_i(0) \right]$ and $\widetilde{ITT} = \tau\left[1-\pi_c\right]$.
In other words, the variance of our CACE estimate is equivalent to a $1/\pi_c^2$ scaling of the variance of an experiment where the average complier treatment impact has been subtracted off according to uptake behavior.
While the $\tilde{Y}_i(z)$ are always unobserved due to dependence on the estimand $\tau$, this formulation is important for further derivations detailed below and helps build intuition as to sources of variance for our CACE estimators.
The derivation is provided in Supplementary Material~\ref{append:iv_var}. 

Under the delta method, standard errors are estimated by plugging in estimates of all the terms in Equation~\ref{eq:delta_variance} \citep{CausalInferenceText}: 
\begin{align*}
\widehat{\text{var}}_{\text{DELTA}} \left(\widehat{\CACE}_{\text{IV}}\right) &= \frac{\widehat{\text{var}}\left(\widehat{\ITT}\right)}{\widehat{f}^2}+ \frac{\widehat{\ITT}^2\widehat{\text{var}}\left(\widehat{f}\right)}{\widehat{f}^4} - 2\frac{\widehat{\ITT}\widehat{\text{cov}}\left(\widehat{\ITT}, \widehat{f}\right)}{\widehat{f}^3}\\
&= \frac{1}{\widehat{f}^2}  \left( \frac{s_Y^2(1)}{n_1} + \frac{s_Y^2(0)}{n_0} \right)  
     + \frac{1}{\widehat{f}^4} \widehat{\ITT}^2\left(\frac{s_D^2(1)}{n_1} + \frac{s_D^2(0)}{n_0}\right) 
      - \frac{2}{\widehat{f}^3} \widehat{\ITT} \left(\frac{s_{Y,D}(1)}{n_1} + \frac{s_{Y,D}(0)}{n_0}\right)  
\end{align*}
where
\[s_{A,B}(z) = \frac{1}{n_z-1}\sum_{i:Z_i=z}\left(A_i(z) - \bar{A}^{obs}(z)\right)\left(B_i(z) - \bar{B}^{obs}(z)\right),
\]
and $s_A^2(z) = s_{A,A}(z)$, for $A= Y, D$ and $B= Y, D$.

One alternative method for estimating the IV standard error is the Bloom method (also sometimes called the Wald method), which essentially treats the denominator of our IV estimators as fixed \citep{Bloom:1984}. The Bloom method uses just the first term in the delta method expansion as the nominal variance of our estimator:
\begin{align*}
\text{var}\left(\widehat{\CACE}_{\text{IV}} \right) &\approx \frac{1}{\pi_c^2}\textrm{var}(\widehat{\ITT}).
\end{align*}
The plug-in estimate for this is then:
\begin{align*}
\widehat{\text{var}}_{\text{BLOOM}}\left(\widehat{\CACE}_{\text{IV}}\right) 
    = \frac{\widehat{\text{var}}\left(\widehat{\ITT}\right)}{\widehat{f}^2}
    = \frac{1}{\widehat{f}^2} \left( \frac{s_Y^2(1)}{n_1} + \frac{s_Y^2(0)}{n_0} \right)  .
\end{align*}
The Bloom method will perform well if the second and third terms are small and/or cancel out. See \citet{Keele:2017fiv} for a detailed comparison of the delta and Bloom methods. 

\section{Post-stratification}

In many cases we might have a covariate that we believe to be predictive of complier status, or outcome, or both.
We would want to use this covariate to improve the precision of our IV estimator.
Motivated by the intuition that if we could isolate most of our compliers into a subset of our data then we could more reliably estimate impacts for those compliers as the instrument within that subset would be stronger, we turn to post stratification.

With post stratification we, after randomization, separate our units into $G$ groups based on some categorical (baseline) covariate that ideally predicts compliance (or outcome).
Let $s_i = g$ if unit $i$ is assigned to group $g$. Let there be $N_g$ units in group $g$ with $N_{g,z}$ assigned to treatment $z$. We assume that $N_{g,z} \geq 1$ for $z\in\{0,1\}$ and $g = 1,\dots, G$. We can then apply each of the above estimators to each group $g$:
\begin{align*}
 \widehat{\ITT}_g= \frac{1}{N_{g,1}}\sum_{i:s_i=g}Z_iY_i(1) - \frac{1}{N_{g,0}}\sum_{i:s_i=g}(1-Z_i)Y_i(0)\\
 \widehat{f}_g = \frac{1}{N_{g,1}}\sum_{i:s_i=g}Z_iD_i(1) - \frac{1}{N_{g,0}}\sum_{i:s_i=g}(1-Z_i)D_i(0).
 \end{align*}

We initially offer two different estimators for a post-stratified CACE. First, we can post-stratify, followed by IV estimation within each stratum, with $\widehat{\tau}_g = \widehat{ITT}_g / \widehat{f}_g$. These $G$ IV estimators are combined to estimate the overall CACE by weighting by the estimated number of compliers. Formally, this estimator is our ``IV-within'' estimator of
\begin{align}
\widehat{\CACE}_{\text{IV-w}} = \sum_{g=1}^G \frac{\widehat{f}_gN_g}{\sum_{k=1}^G\widehat{f}_k N_k} \frac{\widehat{\ITT}_g}{\widehat{f}_g}. \label{eq:IV-w}
\end{align}
If $\widehat{f}_g = 0$ then $\widehat{\tau}_g = \widehat{ITT}_g / \widehat{f}_g$ is undefined, but the weight $\widehat{f}_g N_g = 0$. 
We therefore define $\widehat{\CACE}_{\text{IV-w}}$ by dropping all strata where $\widehat{f}_g = 0$. 
That is, we drop those portions of the experimental sample that we estimate as having no compliers from the analysis.

An alternate approach to post-stratification is to use the usual IV estimator using post-stratified estimates of the numerator term, $\widehat{\ITT}$, and denominator term, $\widehat{f}$.
This gives our ``IV-across'' estimator of:
\begin{align}
\widehat{\CACE}_{\text{IV-a}} & =  \frac{ \widehat{\ITT}_{\text{PS}}}{\widehat{f}_{\text{PS}}} =  \frac{ \sum_{g=1}^G\frac{N_g}{N}\widehat{\ITT}_g}{\sum_{g=1}^G\frac{N_g}{N}\widehat{f}_g}. \label{eq:IV-a}
\end{align}
Our first estimator, $\text{IV-w}$, calculates IV estimates \emph{within} the strata, and the second, $\text{IV-a}$, calculates one IV estimate \emph{across} the strata. These estimators are related to each other and to a version of two-stage least squares, as the following two lemmas show.

First, Lemma~\ref{lemma:2sls_connection} outlines the equivalence between $\text{IV-a}$ and a two-stage weighted least squares estimation strategy.

\begin{lemma}\label{lemma:2sls_connection}
$\widehat{\CACE}_{\text{IV-a}}$ will equal $\hat{\beta}_{1, S2}$, the coefficient for predicted compliance in the second stage of a two-stage weighted least squares regression (with weighting in both stages) with weights $w_i = \frac{N_{g}}{N_{g,z}}\frac{n_z}{N}$ for unit $i$ in strata $g \in \{1,\dots,G\}$ assigned to treatment $z \in \{0,1\}$.
\end{lemma}
\noindent See Supplementary Material~\ref{append:2sls} for proof. 
With large strata, these weights are all approximately 1 given, for unit $i$ in group $g$, 
\begin{align*}
w_i = \frac{N_g}{N_{g,z}}\frac{n_z}{N} = \frac{1}{p_g} p \approx 1 ,	
\end{align*}
as random assignment will ensure each strata has roughly the same proportion treated, with $p_g \approx p$.
This suggests that in large samples with large strata, the weighted 2SLS estimate will generally be close to the usual, unweighted, 2SLS.


Second, Lemma~\ref{lemma:w_a_connection} shows that $\widehat{IV}_w$ and $\widehat{IV}_a$ are equivalent when all strata have non-zero estimated proportions of compliers:

\begin{lemma}\label{lemma:w_a_connection}
If $\widehat{f}_g \neq 0$ for all $g = 1,\dots, G$, then the estimator in Equation~\ref{eq:IV-w} is mathematically equivalent to the estimator in Equation~\ref{eq:IV-a}:
\begin{align}
\widehat{\CACE}_{\text{IV-w}} &= \sum_{g=1}^G \frac{\widehat{f}_gN_g}{\sum_{k}\widehat{f}_k N_k} \frac{\widehat{\ITT}_g}{\widehat{f}_g} \nonumber\\
&= \sum_{g=1}^G  \left( \frac{N_g}{\sum_{k }N_k\widehat{f}_k} \right) \widehat{\ITT}_g \label{eq:weighted_ITT}\\
&=  \frac{ \sum_{g=1}^G\frac{N_g}{N}\widehat{\ITT}_g}{\sum_{k=1}^G\frac{N_k}{N}\widehat{f}_k} = \widehat{\CACE}_{\text{IV-a}} . \nonumber
\end{align}
\end{lemma}

The equivalence between $\widehat{\CACE}_{\text{IV-a}} $ and $\widehat{\CACE}_{\text{IV-w}}$ whenever $\hat{f}_g \neq 0$ for all $g=1,\dots,G$ allows us to use either representation to derive the asymptotic results.
Later, we find in simulations (with a fixed, finite sample) that $\widehat{\CACE}_{\text{IV-w}}$, which drops strata estimated to have zero compliers, has better properties than $\widehat{\CACE}_{\text{IV-a}}$.
This finding motivates estimators that weight those strata with more compliers more heavily as a means of achieving greater performance gains; see Section~\ref{sec:weighting}.

\subsection{Asymptotic Variance for Post-stratification Estimators}

Derivation of the asymptotic variance of $\widehat{\tau}_{IV-a}$ and $\widehat{\tau}_{IV-w}$ requires several finite-population central limit theorem results, which we include in the Supplemental Materials.
Let $W_i(g) = 1$ if $s_i = g$ and $W_i(g) = 0$ if $s_i \neq g$.
Then we can define variance components within each stratum:
\[S^2_{g,Y}(z) = \frac{1}{N_g-1}\sum_{i=1}^N W_i(g)\left(Y_i(z) - \bar{Y}_g(z) \right)^2,\]
\[S^2_{g,Y}(1,0)=  \frac{1}{N_g-1}\sum_{i=1}^NW_i(g)\left(Y_i(1) - \bar{Y}_g(1)\right)\left(Y_i(0) - \bar{Y}_g(0)\right),\]
and
\[S^2_{g, Y}(01) = \frac{1}{N_g-1}\sum_{i=1}^N W_i(g)\left(Y_i(1) - Y_i(0) -\left[ \bar{Y}_g(1) - \bar{Y}_g(0) \right]\right)^2.\]

Based on the conditions in the Supplemental Materials, we get the asymptotic variance as given in the following theorem:

\begin{theorem}\label{thm:main_clt}
If we have Assumptions \ref{assump:iv}, \ref{assump:mono}, \ref{assump:strata_prop}, \ref{assump:li_ding_cond_main}, \ref{assump:clt_cond2_main}, \ref{assump:delta_post_strat}, and \ref{assump:clt_cond_d}, we have an asymptotic variance of
\begin{align*}
\text{asyVar}(\widehat{\CACE}_{\text{IV-a}}) =&\frac{1}{\pi_c^2}\text{asyVar}\left(\widehat{\ITT}_{\text{PS}}\right) +\CACE^2\frac{1}{\pi_c^2}\textrm{asyVar}(\widehat{f}_{\text{PS}}) -2\CACE\frac{1}{\pi_c^2}\textrm{asyCov}(\widehat{\ITT}_{\text{PS}}, \widehat{f}_{\text{PS}})
\end{align*}
where
\begin{align*}
\text{asyVar}\left(\widehat{\ITT}_{\text{PS}}\right) 
& =  \sum_{g=1}^N\frac{N_g}{N}\frac{N_g-1}{N-1}\left[\frac{S^2_{g,Y}(0)}{(1-p)N_g} +\frac{S^2_{g,Y}(1)}{pN_g} - \frac{S^2_{g, Y}(01)}{N_g}\right]\\
& \approx  \sum_{g=1}^N\frac{N_g^2}{N^2}\left[\frac{S^2_{g,Y}(0)}{(1-p)N_g} +\frac{S^2_{g,Y}(1)}{pN_g} - \frac{S^2_{g, Y}(01)}{N_g}\right]
\end{align*}

and 
\begin{align*}
\text{asyVar}(\widehat{f}_{\text{PS}}) 
&= \sum_{g=1}^G\frac{N_g}{N(N-1)}\left[(1-p)^{-1}\left(\pi_{g,c} + \pi_{g,a}\right)\pi_{g,n} + p^{-1}\left(\pi_{g,c} + \pi_{g,n}\right)\pi_{g,a} - \left(\pi_{g,a} + \pi_{g,n}\right)\pi_{g,c}\right]
\end{align*}
\label{thm:aymp_var_PS}
\end{theorem}
Theorem~\ref{thm:aymp_var_PS} comes from two finite-population central limit theorem results being combined with a finite-population delta method argument \citep{pashley2019note, poststrat_clt}.
See Supplementary Material~\ref{append:clt_itt} for details of the proof, along with lemmas that give finite-population central limit theorem results for the ITT estimators. 

The asymptotic covariance term can similarly be approximated by a blocked covariance (see Supplementary Material~\ref{append:two_sided_bias}):
\begin{align*}
\textrm{asyCov}(\widehat{\ITT}_{\text{PS}}, \widehat{f}_{\text{PS}})
& \approx  \sum_{g=1}^N\frac{N_g^2}{N^2}\Bigg[\frac{\pi_{g,n}\pi_{g,c}}{p(N_g-1)}\left(\bar{Y}_{g,c}(1) - \bar{Y}_{g,n}(0)) + \frac{\pi_{g,n}\pi_{g,a}}{p(1-p)(N_g-1)}(\bar{Y}_{g,a}(1) - \bar{Y}_{g,n}(0)\right)\\
& \qquad \qquad \qquad + \frac{\pi_{g,a}\pi_{g,c}}{(1-p)(N_g-1)}\left(\bar{Y}_{g,a}(1) - \bar{Y}_{g,c}(0)\right) - \frac{\pi_{g,c}(1-\pi_{g,c})}{N_g-1}\CACE_g\Bigg],
\end{align*}
where $\bar{Y}_{g,t}(z)$ is the average potential outcome for units of compliance type $t \in \{a, c, n\}$ in stratum $g$ under treatment $z$.

Similar to the standard IV estimator, we can rewrite this asymptotic variance as the variance of $\frac{1}{\pi_c^2}\textrm{var}\left(\widehat{\ITT}_{\text{PS}} - \CACE \widehat{f}_{\text{PS}}\right)$, which corresponds to the post-stratified variance of a completely randomized experiment with potential outcomes $\tilde{Y}_i(z) = Y_i(z) - D_i(z)\tau$, where $\tau$ is the true CACE (across strata).

Due to the correspondence between $\widehat{\CACE}_{\text{IV-w}}$ and $\widehat{\CACE}_{\text{IV-a}}$, we further have $\text{asyVar}(\widehat{\CACE}_{\text{IV-w}}) = \text{asyVar}(\widehat{\CACE}_{\text{IV-a}})$ if we have constants $c_g >0$ such that $f_g \to c_g$ as $n \to \infty$ for all $g \in \{1,\dots,G\}$, guaranteeing that (asymptotically) IV-w does not drop any strata.

The Bloom approximation for the post-stratified estimator is 
\begin{align*}
\text{asyVar}\left(\widehat{\CACE}_{\text{IV-a}} \right) = \text{asyVar}\left(\widehat{\CACE}_{\text{IV-w}} \right) &\approx \frac{1}{\pi_c^2}\textrm{var}(\widehat{\ITT}_{\text{PS}}).
\end{align*}

\subsection{Variance Estimator}

Estimation of $\text{asyVar}\left(\widehat{\ITT}_{\text{PS}}\right)$ and $\text{asyVar}(\widehat{f}_{\text{PS}})$, proceeds by estimating the variance within each stratum and then aggregating. For the Bloom method, the across strata estimator is
\begin{align*}
\widehat{\text{var}}_{\text{BLOOM}}\left(\widehat{\CACE}_{\text{IV-a}} \right) &\approx \frac{1}{\widehat{f}_{\text{PS}}^2}\sum_{g=1}^G\frac{N_g^2}{N^2}\widehat{\textrm{var}}(\widehat{\ITT}_{g}).
\end{align*}
We can estimate $\widehat{\textrm{var}}(\widehat{\ITT}_{g})$ if there are at least two units assigned to treatment and two units assigned to control in stratum $g$. If not, blocked variance estimators for blocks with only a single treated or control unit may be employed \citep{pashley2021insights}.

Under the delta method, there are separate variance estimators for $\widehat{\CACE}_{\text{IV-a}}$ and $\widehat{\CACE}_{\text{IV-w}}$. If $N_{g,z} \geq 2$ for all $g=1,\dots,G$ and $z \in\{0,1\}$, the variance estimator for $\widehat{\CACE}_{\text{IV-a}}$ is:
\begin{align*}
&\widehat{\text{var}}_{\text{DELTA}} \left(\widehat{\CACE}_{\text{IV-a}}\right)\\
&=\frac{1}{\left(\widehat{f}_{\text{PS}}\right)^2} \sum_{g=1}^G\frac{N_g^2}{N^2}\Bigg(\frac{s_{Y,g}^2(1)}{N_{g,1}} + \frac{s_{Y,g}^2(0)}{N_{g,0}} + \left(\widehat{\CACE}_{\text{IV-a}}\right)^2\left(\frac{s_{D,g}^2(1)}{N_{g,1}} + \frac{s_{D,g}^2(0)}{N_{g,0}}\right) - 2\widehat{\CACE}_{\text{IV-a}}\left(\frac{s_{Y,D,g}(1)}{N_{g,1}} + \frac{s_{Y,D,g}(0)}{N_{g,0}}\right)\Bigg).
\end{align*}
\noindent This estimator is based on the modified potential outcome representation within strata, and summing across strata with weights $N_g^2/N^2$. A variance estimator for $\widehat{\CACE}_{\text{IV-w}}$ is the following weighted sum of stratum-level IV variance estimates:
\begin{align*}
&\widehat{\text{var}}_{\text{DELTA}}(\widehat{\CACE}_{\text{IV-w}})=\sum_{g=1}^G\frac{\hat{f}_g^2N_g^2}{N^2\widehat{f}_{\text{PS}}^2}\widehat{\textrm{var}}\left(\widehat{\CACE}_{\text{IV, g}}\right)\\
&= \sum_{g=1}^G\frac{\hat{f}_g^2N_g^2}{N^2\widehat{f}_{\text{PS}}^2}\Bigg(\frac{1}{\hat{f}_g^2}\left(\frac{s_{Y,g}^2(1)}{N_{g,1}} + \frac{s_{Y,g}^2(0)}{N_{g,0}}\right) + \frac{\widehat{\CACE}_{\text{IV-w}}^2}{\hat{f}_g^2}\left(\frac{s_{D,g}^2(1)}{N_{g,1}} + \frac{s_{D,g}^2(0)}{N_{g,0}}\right) - 2\frac{\widehat{\CACE}_{\text{IV-w}}}{\hat{f}_g^2}\left(\frac{s_{Y,D,g}(1)}{N_{g,1}} + \frac{s_{Y,D,g}(0)}{N_{g,0}}\right)\Bigg).
\end{align*}
Due to cancelations of $\hat{f}_g$ terms, $\widehat{\text{var}}_{\text{DELTA}}(\widehat{\CACE}_{\text{IV-a}}) = \widehat{\text{var}}_{\text{DELTA}}(\widehat{\CACE}_{\text{IV-w}})$ whenever all $\hat{f}_g$ are nonzero.
Again, if there are not enough units per stratum to estimate variance within each, a combined blocked variance estimator would be necessary \citep{pashley2021insights}.

\section{Benefits of Post-stratification for IV estimates}

In this section we analytically derive three potential benefits from post-stratification for IV estimators. Specifically, we focus on how post-stratification can affect (1) variance reduction, (2) increased precision of standard errors, and (3) bias reduction. 

\subsection{Variance Reduction and Standard Errors}

Post-stratification on a covariate predictive of either complier status or the outcome would ideally reduce the variance of our IV estimator. 
However, covariates predictive of compliance and those predictive of outcome are not equal in terms of their ability to increase precision, especially if we are not dropping low-compliance strata from the analysis.

Compare the delta-method asymptotic variances for the IV estimator before and after post-stratification:
\begin{align*}
\text{asyVar}(\widehat{\CACE}_{\text{IV}}) &= \frac{1}{\pi_c^2}\textrm{var}\left(\widehat{\ITT}- \frac{\ITT}{\pi_c}\widehat{f}\right) \mbox{ and } \\
\text{asyVar}(\widehat{\CACE}_{\text{IV-a}}) &= \frac{1}{\pi_c^2}\textrm{var}\left(\widehat{\ITT}_{\text{PS}} - \frac{\ITT}{\pi_c}\widehat{f}_{\text{PS}}\right) .
\end{align*}
As shown above, we can view both these asymptotic variances as exactly the (scaled) variances we would get from running a completely randomized experiment with potential outcomes $\tilde{Y}_i(z) = Y_i(z) - \frac{\ITT}{\pi_c}D_i(z)$, either unadjusted or with post-stratification, respectively.

The comparison of asymptotic variance for $\widehat{\CACE}_{\text{IV}}$ vs $\widehat{\CACE}_{\text{IV-a}}$ therefore amounts to whether post-stratification would be beneficial in an experiment with potential outcomes $\tilde{Y}_i(z) = Y_i(z) - \frac{\ITT}{\pi_c}D_i(z)$.
Based on \citet{miratrix2013adjusting}, we should expect (informally) for post-stratification to be beneficial in terms of variance reduction the more the variability of $\tilde{Y}_i(1)$ and $\tilde{Y}_i(0)$ is between strata than within.
From this result, to reduce variability through post-stratification we might consider reducing within stratum variability via either of the two pieces of $\tilde{Y}_i(z)$: make units within each stratum similar in terms of potential outcomes, $Y_i(z)$, without regard to the compliance aspect, or make units within each stratum similar in terms of $D_i(z)$ (compliance type).\footnote{A third option would be to target the entire expression $Y_i(z) - \frac{\ITT}{\pi_c}D_i(z)$, but we believe that it would be difficult to find covariates to do this directly.}
We expect reducing overall variation by targeting variation in compliance to be difficult for at least two reasons.
First, because the $D_i(z)$ terms are multiplied by the CACE in the $\tilde{Y}_i(z)$ expressions, if the CACE is small relative to overall variation in $Y_i(z)$, the impact of targeting $D_i(z)$ will likely be minor.
Second, if compliance is relatively rare, then the number of units that are actually differentially adjusted across treatment arms will be few, again making the impact of the second term minor.
Put differently, if the CACE is 0, then even if we stratify perfectly on compliance, we will only have gains if this stratification were effective for the original $Y_i(z)$, meaning our stratification variable was predictive of the original $Y$s as well.


Regarding the precision of standard errors, we can again use our post-stratification results for the modified potential outcomes.
In particular, if we reduce the true variance of our estimator, we should also expect to reduce the variance in our estimate of that variance \citep{pashley2020block}.
In our simulation study, we explore the extent of improvement in the standard error estimates.

Note that we focused here on the comparison of $\widehat{\CACE}_{\text{IV}}$ with $\widehat{\CACE}_{\text{IV-a}}$ rather than $\widehat{\CACE}_{\text{IV-w}}$.
Recall  $\widehat{\CACE}_{\text{IV-a}}$ and $\widehat{\CACE}_{\text{IV-w}}$ are the same when there are no strata with zero estimated compliers.
Our simulations in Section~\ref{sec:sims} demonstrate that the feature of $\widehat{\CACE}_{\text{IV-w}}$ of dropping strata with no estimated compliers reduces variability, and that these benefits can be even greater when we drop or down-weight strata more aggressively, as we will discuss in Section~\ref{sec:weighting}.


\subsection{Bias}

Post-stratification can also reduce bias in the IV estimates. Critically, the bias reduction depends on whether noncompliance is one or two-sided. That is, in some applications controls are unable to access treatment receipt such that $P(D_i = 0|Z_i=0) = 1$. This is referred to as one-sided noncompliance. When this does not hold, there is two-sided noncompliance. 

We can more precisely characterize the possible bias reduction due to post-stratification with one-sided noncompliance.
Under one-sided noncompliance, $\hat{f}$ is the observed proportion of those who took treatment in the treatment group. When noncompliance is one-sided, we can write the bias in the standard IV estimator as:
\begin{align}
E\left[\widehat{\CACE}_{\text{IV}}\right] - \CACE 
&=  \frac{1}{1-p}\left(1  - E\left[ \frac{1}{\hat{f}}\right]E[\hat{f}]\right)\left( \bar{Y}_c(0)-\bar{Y}_n(0)\right) = \frac{1}{1-p}\text{cov}\left(\hat{f},  \frac{1}{\hat{f}}\right)\left( \bar{Y}_c(0)-\bar{Y}_n(0)\right) . \label{eq:bias}
\end{align}
\noindent The derivation of this result can be found in Supplementary Material~\ref{append:one_sided_bias}.
The dependence of Equation~\ref{eq:bias} on the covariance between $\hat{f}$ and $1/\hat{f}$ and a further Taylor approximation given in Supplementary Material~\ref{append:one_sided_bias} reveals that the bias depends on the magnitude of the $\text{var}(\hat{f})$. 
As such, reducing the variance of $\hat{f}$ can also reduce bias in the estimator. Therefore, the variance reduction properties of post-stratification can reduce bias as well. We can also characterize the direction of the bias reduction.
The bias reduction depends on the relative averages of outcomes of the compliers under control and the never-takers (under control or treatment).
We can express this quantity as $\Delta = \bar{Y}_c(0)-\bar{Y}_n(0)$, where $\bar{Y}_c(z)$ is the average potential outcome for all compliers in the sample under treatment $z$, and $\bar{Y}_a(z)$ and $\bar{Y}_n(z)$ are averages for the always- and never-takers.
A negative $\Delta$ implies the bias will be positive, and a positive $\Delta$ implies the bias will be negative.

When noncompliance is two-sided, we can express the bias in the standard IV estimator as
\begin{align*}
E\left[\frac{\widehat{\ITT}}{\hat{f}}\right] - \CACE & \approx  \frac{1}{\pi_c^2} \left[ \CACE \text{var}(\hat{f})- \textrm{cov}(\widehat{\ITT}, \hat{f}) \right] \\
& = \frac{1}{\pi_c^2(N-1)}\Bigg[ \frac{\pi_n((1-p)\pi_c + \pi_a)}{p(1-p)}(\bar{Y}_n(0) - \bar{Y}_c(0)) + \frac{\pi_a(p\pi_c + \pi_n)}{p(1-p)}(\bar{Y}_c(1) -\bar{Y}_a(1) )\Bigg]
\end{align*}
\noindent See Supplementary Material~\ref{append:two_sided_bias} for the derivation. In this context, the bias again depends upon the magnitude of the variance of $\hat{f}$. However, characterizing the direction of the bias is more complicated than in the one-sided noncompliance case. The direction of the bias now depends on the relative group means of compliers, always-takers, and never-takers.
The relative differences between these three groups can either offset or increase the bias terms. Specifically, there will be a positive bias if $\bar{Y}_n(0) > \bar{Y}_c(0)$ and $\bar{Y}_c(1) >\bar{Y}_a(1)$, and there will be a negative bias if $\bar{Y}_n(0) < \bar{Y}_c(0)$ and $\bar{Y}_c(1) <\bar{Y}_a(1)$.

In this section we have focused on the bias reduction implied by reducing variability.
But the story is more complicated when we use any of the methods that drop strata or re-weight strata.
Because we drop strata with no (or low) \textit{estimated} compliers, we will sometimes drop strata that do have compliers.
If those compliers are different, in terms of their treatment effects, then compliers in strata with higher compliance rates, this will introduce bias.
Further, in one-sided noncompliance we only drop those strata with no compliers in the treatment side, as that is where we estimate the compliance rate, but do not do so for the control side, leading to an imbalance.
Estimators that use an alternative weighting, such as using the precision-weighted estimator discussed in Section~\ref{sec:weighting}, similarly will cause bias when there is treatment effect heterogeneity among compliers as we are no longer weighting towards the overall average but rather up-weighting or down-weighting units for stability.
The practical implications of this bias introduction are explored further in the simulation section.


\section{Alternative post-stratification strategies}
\label{sec:weighting}

The original intuition of our post-stratification approach was that if we could isolate compliers into a few strata, we could benefit by the improved estimation in those strata.
The story turns out to be more complex than this, in that those strata with few compliers become so unstable that, even though they have less overall weight in the final estimate, they are so variable that they can undo the precision gains achieved by having a greater proportion of compliers in the high-complier-rate strata.

To see this, consider the second line of Equation~\ref{eq:weighted_ITT} (Lemma~\ref{lemma:w_a_connection}): this line shows $IV_a$ (and $IV_w$ with no strata dropped) as a weighted average of ITT estimates, with the weights of the strata not dependent on the number of compliers, but instead the overall strata sizes.
This weighting by strata size means our strategy to upweight complier-rich strata is ineffective. 
In particular, even if stratum $g$ has few compliers, it will contribute just the same to the overall CACE estimate as it would to an ITT estimate!

If we are willing to possibly incur some further bias (beyond the normal bias of an IV estimator), we could decrease the weight of those strata with fewer compliers to potentially achieve precision gains by avoiding the weak instrument problem.
In this section we discuss two strategies for achieving this that build upon post-stratification.
The first strategy is to outright prune those strata with few compliers, similar to trimming an observational study of hard-to-match units.
The second strategy is to weight strata roughly proportional to complier prevalence or CACE estimator precision.

The $IV_w$ estimator already drops strata when $\widehat{f}_g = 0$ and, as we will see in the simulation study, even this limited pruning can stabilize the overall estimator.
If, however, $\widehat{f}_g \approx 0$ then we would include the stratum estimate of $\widehat{\ITT}_g/\widehat{f}_g$, which will be quite unstable due to the small denominator, in the overall weighted average.
We can avoid including such unstable estimates by thresholding at something other than exactly 0.
For example, we could drop any strata with estimated compliance less than 2\% (or any threshold of our choosing); we call this estimator the ``Drop-Small-Strata'' (DSS) estimator.
An alternative version of this estimator, which we call the ``Drop-Small-F'' (DSF) estimator, drops any stratum from the estimator where we fail the weak instrument test \citep{Stock:2005} for that stratum based on the F statistic for the importance of $Z$ in predicting $D$.
In particular, following common practice for IV estimation, we drop those strata where $F < 10$.

Dropping strata with low compliance has two benefits: first, we avoid unstable and potentially very large estimates from the low-compliance strata.
In other words, we focus our weighted average of ITT estimates on those strata with more compliers, and thus on those with more information on the treatment effect of compliers.
Second, we avoid odd behavior in the two-sided noncompliance case when $\widehat{f}_g < 0$.
Without dropping such strata, for a stratum with $\widehat{f}_g < 0$ we would be including an estimate of ITT in the overall average that depends on an overabundance of always-takers in the control side, and a sign flip, neither of which have anything to do with treatment impact for the compliers in the stratum.


For an alternate approach, consider that post-stratification is a weighted average of subgroup estimates. 
We saw that we weighted the CACE estimates for $\widehat{\CACE}_{\text{IV-w}}$ by the estimated number of compliers within each stratum, and the component parts of $\widehat{\CACE}_{\text{IV-a}}$ by the number of individuals within each stratum.
We might naturally wonder about other weightings of these component parts.
In particular, we might weight by the (estimated) precision of each strata using a Precision Weighted IV estimator (PWIV).
The PWIV estimator has a form similar to $\widehat{\CACE}_{\text{IV-w}}$ but weights by the (Bloom) estimated precision of each stratum: 
\[
\widehat{\tau}_{\text{PWIV}} = \frac{1}{Z}\sum_{g=1}^G \frac{\widehat{f}_g^2}{\widehat{\text{var}}(\widehat{\ITT}_g)} \widehat{\CACE}_{g} \mbox{ with } Z = \sum_{h=1}^G \frac{\widehat{f}_h^2}{\widehat{\text{var}}(\widehat{\ITT}_h)}.
\]
This estimator more heavily weights the estimated proportion of compliers than $IV_w$ (see the $\hat{f}^2_g$ term in the weight, vs. $\hat{f}_g$ in $IV_w$).

Either by dropping strata or reweighting them, the overall goal is to discount those strata with fewer compliers and focus attention on strata where, in principle, estimating the complier average impact is  easier.
This can incur bias: if the CACE is different across strata, our final estimand will not be the overall CACE, but rather a reweighted CACE tilted towards the CACE of those compliers that tend to be in strata predicted to have a higher prevalence of compliers.
If CACE is homogenous, or if the proportion of compliers left out of the overall estimate is small, than this bias will be minimal.


As a further advantage of these estimators, focusing attention on the complier-rich strata could partially control bias in contexts where the exclusion restriction is violated.
In particular, in the strata with more compliers, the bias caused by violation of the exclusion restriction via treatment impact on the noncompliers would be attenuated, as there are fewer noncompliers in the ITT estimate.
The bias is, in other words, isolated into the low-compliance strata, which are then discounted in the overall estimate.

\section{Simulation Study}
\label{sec:sims}

We explore the analytic results using a simulation study to compare the different estimation strategies. We investigate $\widehat{\CACE}_{\text{IV-a}}$ and $\widehat{\CACE}_{\text{IV-w}}$, the two stratification approaches described above. Of course, as we mathematically show, these estimators are identical except when some strata have $\hat{f}_g = 0$; we will examine which estimator tends to perform better overall, including when this event occurs.
We also include the Drop-Small-F (DSF) and Precision Weighted IV (PWIV) estimators from Section~\ref{sec:weighting}.

As a baseline we consider the simple IV estimator that ignores the covariate entirely. We also include the usual two-stage least squares estimator (as implemented by the AER package in R), using the stratification category as a covariate. We finally include an Oracle estimator of the simple difference in means estimate applied to the subset of compliers; this represents a best-case context where we know complier status perfectly.

For each estimator (save the Oracle and 2SLS) we have two methods for calculating a standard error: (1) the Bloom approach, where we consider the proportion of compliers as fixed, and (2) the delta method approach, which accounts for the uncertainty in estimating the compliance rate.
We compare the performance of these two standard error estimators along with the performance of the point estimators.

For each simulated dataset, we generate four strata, in line with our empirical example.
We consider one-sided compliance for simplicity, and vary several simulation factors of interest:

\begin{enumerate}
	\item Overall size of the experiment ($N = 500, 1000, 2000$).
	\item Overall proportion of compliers (5\%, 7.5\%, and 10\%).
	\item Whether group membership predicts complier status or not.
	\item Whether group membership predicts the outcome or not.
	\item Whether the mean of the never-takers is below, equal to, or above the mean of the compliers' control potential outcomes.
	\item Whether the treatment impact is different across strata, or constant.
\end{enumerate}

See Supplementary Materials~\ref{app:simulation} for further details on the data generating process.


\subsection{Results}

Overall performance characteristics across all simulation scenarios are shown in Figure~\ref{fig:overall_performance}.
Here, we average the performance metrics across all the scenarios for a given sample size to get trends across the other specifications.
In general, we find that the post-stratified estimators have less bias, lower standard errors, and lower RMSEs than doing nothing. The 2SLS and $IV_a$ estimators basically coincide, as anticipated, in terms of performance; the lines are over-plotted in the figure. Relative to the standard error, the bias is negligible.

We verified that our two versions of post-stratification give identical point estimates if all strata are defined, as anticipated.
For the scenarios considered, about half of the time at least one stratum was empty due to a mix of small strata, small sample size, and low overall compliance.
Notably, having some strata estimated to be have zero compliers does impact overall performance.
Note how, in Figure~\ref{fig:overall_performance}, the average standard error and RMSE of $IV_{a}$ (IV across, using adjusted numerator and denominator for the overall ratio) is larger than that for $IV_{w}$ (IV within and then average).
We calculated the ratio of the RMSEs of $IV_{w}$ vs. $IV_{a}$ for each individual context, and found that $IV_w$ could be more than 30\% smaller (with a 9\% average reduction across all scenarios) with the gains being correlated to the chance of dropped strata.

\begin{figure}[hbt]
  \includegraphics[width=\textwidth]{figures/overall_performance_plot_pool.pdf}
  \caption{Overall performance characteristics of the point estimators with absolute bias, true Standard Error, and RMSE averaged across the different simulation scenarios grouped by overall sample size.}
  \label{fig:overall_performance}
\end{figure}

\subsubsection{Variance reduction}

We next examine which factors drive the degree of improvement in the standard errors.
Because the ``Within'' approach ($IV_w$) is generally superior (smaller SEs) or the same as ``Across'' ($IV_a$), we primarily focus on the within estimator and calculate the ratio of its variance to the unstratified estimator for each simulation scenario.
A ratio of 75\%, for example, would represent a 25\% reduction in the variance if one post-stratifies using $IV_{w}$ vs. the unstratified IV. Figure~\ref{fig:variance_ratio_plot} shows that stratifying by covariate predictive of $Y$ (outcome) or $C$ (compliance status) both help.
It is clear that using covariates predictive of outcome can substantially improve precision.
For covariates predictive of compliance, gains are largest in the cases of low compliance and smaller sample sizes. This is driven by dropping strata with 0 estimated compliers; see the second row for $IV_a$ that show no real gains of compliance.

For $IV_w$, we actually see a benefit when the covariate is neither predictive of compliance status nor outcome, when $\pi_c$ and sample size is low (see top left of figure). This stems from the benefits of dropping those strata with no observed compliers, which adds substantial stability to the estimator, providing benefits well beyond the bias incurred.
We unpack this surprising finding in the supplementary materials. It is related to the discussion of why a complier-predictive covariate fails to provide much gains for 2SLS, which we discuss further in Section~\ref{sec:complier_predictive_covariate}


\begin{figure}[hbt]
  \includegraphics[width=\textwidth]{figures/variance_ratio_plot_v2_pool.pdf}
  \caption{Ratio of variance of $IV_{w}$ to unstratified IV.}
  \label{fig:variance_ratio_plot}
\end{figure}



\subsubsection{Bias reduction}


\begin{figure}[hbt]
  \includegraphics[width=\textwidth]{figures/bias_ntshift_plot_pool.pdf}
  \caption{Bias of estimators relative to bias of the unstratified estimator. Below 100\% means estimator tends to have less bias, across scenarios of given sample size, than the simple IV. PWIV is cropped to keep scaling of the figure.}
  \label{fig:relative_bias}
\end{figure}

For the scenarios considered, bias is a much smaller share of the overall RMSE than variance; see the low range of biases on Figure~\ref{fig:overall_performance}, relative to the SEs. That being said, DSF and PWIV have elevated levels of bias, as expected: they are estimating the CACE of the kept strata in the first case, and weighting the higher-compliance more heavily in the second case, which shifts their respective estimands. $IV_w$, in principle, does the same by dropping low-compliance strata when the estimated compliance is precisely 0. Even so, the bias reduction due to stratification for this estimator cause it to be the least biased of all the estimators considered. $IV_a$ (and by extension 2SLS) has less bias than the simple IV, but the relative improvement is not nearly as large as for $IV_w$ for the smaller sample sizes.




\subsubsection{Standard error estimation}

A standard error estimator is well calibrated if it is, on average, equal to the true standard error in a given context.
To assess this we calculate the square root of the ratio of the average of the squared standard error estimates to the true squared standard error (the estimator variance) for each context.\footnote{We calculate the ratio of variances because usual standard error estimators generally give unbiased variance, not SE, estimates. The outer square root brings the ratio back to the scale of standard error.}
Results are on Figure~\ref{fig:se_estimator_plot}.
The delta method for calculating standard errors can give standard errors that are a bit too high (15\% or more for many scenarios when $N=500$, for example), while the simpler Bloom estimator generally performs well, although they can be anti-conservative when sample sizes are small. The 2SLS standard errors are also somewhat inflated for small sample size.
The DSF estimator, and to a lesser extent the PWIV estimator, tend to have overly large Bloom standard errors for some scenarios.

\begin{figure}[hbt]
\center
  \includegraphics{figures/se_estimator_plot_pool.pdf}
  \caption{Relative percent change of average estimated standard error to true standard error, calculated as the square root of the mean estimated squared standard error divided by true variance (as estimated across simulation trials) for both the delta method and Bloom standard errors. Each point is a specific simulation scenario. Points above 100\% indicate standard errors systematically too large, and below systematically too small.}
  \label{fig:se_estimator_plot}
\end{figure}

In Supplementary Material~\ref{sec:se_stability} we further show that the stability of the estimated standard errors for the post-stratified estimators, relative to their true standard errors, is about the same as for the unstratified estimators.


\subsection{Complier Predictive Covariates}
\label{sec:complier_predictive_covariate}


\begin{figure}[hbt]
\centering
  \includegraphics[width=\textwidth]{figures/predC_Bias_SE_RMSE}
 \caption{Simulation results with compliers increasingly concentrated in the upper strata.}
  \label{fig:pred_C_only}
\end{figure}


To explore the tension between increased instability in strata with few compliers and their having less weight, we conducted a set of simulations where we generated a series of datasets with the same overall compliance rate (15\%), but an ever-increasingly predictive predictor of compliance ranging from the compliers being evenly distributed across the strata (no prediction) to all the compliers being in the same stratum (perfect prediction).
Results are in Figure~\ref{fig:pred_C_only}.

The middle plot of Figure~\ref{fig:pred_C_only} shows the relative size of the true SE of an estimator to the unstratified baseline on the $y$ axis. The $x$-axis shows the $R^2$ of a regression of compliance onto the strata variable. Even when we have near 100\% $R^2$ (perfect prediction of compliance) the $IV_a$ estimator has virtually no gains. For $IV_w$, we do see precision gains but only at very high values of $R^2$.
The Drop-Small-F (DSF) estimator, more aggressive than $IV_w$ in dropping strata, more quickly realizes gains in the standard errors.
The Precision-Weighted-IV Estimator (PWIV) has an even sharper drop off in variance, but also is the most biased.
Figure~\ref{fig:pred_C_only} also allows for comparing all estimators to an oracle (the bottom line) of the simple difference in means of the known compliers.
This estimator could be achieved if we knew the complier status of all units.
This knowledge is extremely beneficial; the oracle has a standard error less than half of the unstratified estimator. 
Only when we have perfect prediction do $IV_w$, DSF, and PWIV converge to this oracle.

When we have even only a few compliers across all strata, we immediately are faced with countervailing forces: on one hand, we can down-weight those strata that we know represent a small fraction of the compliers.
On the other hand, the low compliance rates in those strata generate extremely unstable estimates, and so weighting by estimated number of compliers still allow those extreme values to destabilize the overall weighted average. 
When we \emph{drop} small strata, however, this destabilization does not occur, and we see benefits; note the DSF estimator's steadily increasing performance in particular.
Similarly, PWIV will down-weight those unstable strata more heavily than just weighting by estimated number of compliers as in $IV_a$.

Dropping strata or re-weighting does open the door for bias, however.
In our simulation, the treatment impact is higher for compliers in the lower strata, and for scenarios where the compliers are concentrated in the higher strata, the lower strata get dropped either by random 0 estimates of compliance rate (for $IV_w$) or when failing the F-test (for DSF), thus attenuating the estimated treatment impact.
For PWIV, the re-weighting of strata introduces bias when there is treatment effect heterogeneity across strata because we are no longer weighting to the sample average, but rather the precision weighted average.
However, the bias is relatively small: compare the PWIV line in the SE and RMSE plots. Therefore, at least in these simulations, the drawbacks of introducing bias appear to be more than off-set by the benefits of increasing precision.



\subsection{Discussion}

In our simulations, we considered two properties, prediction of outcome and prediction of compliance, of variables that can be used for post-stratification.
Post-stratifying can directly improve precision when using covariates predictive of outcome.
To gain from a complier-predictive covariate, however, we have to do more than post-stratify: we have to down-weight or drop the ``empty'' or low compliance rate strata.
The stability gained from dropping such strata is general: in fact, as we show in the supplementary materials, precision gains can be achieved even if stratifying on covariates completely unrelated to compliance or outcome, although this comes with associated bias gains, if overall compliance is low in a one-sided non-compliance context.
The standard errors of the post-stratified estimators tend to be relatively well calibrated, with the delta approach---that nominally takes into account all forms of uncertainty---actually performing a bit worse than Bloom approach for many of the contexts we explored.

These results imply that to exploit a variable predictive of compliance, we would want to be able to create multiple strata from that variable, with some of those strata having very low proportions of compliers.
This would give a better chance of having estimated compliance rates of zero or close to zero in some strata, which is where the gains come from. In particular, a single binary variable is unlikely to be useful unless it can nearly perfectly separate compliers and noncompliers. One could in theory combine several binary variables to create many strata; this would work if we are able to create strata with virtually no compliers in them. In this vein, analysts could estimate compliance rates by strata to understand whether a candidate variable is likely to be useful for post-stratification.


\section{Empirical Applications}

Next, we applied our methods to two different empirical applications. For the first application, we re-analyze data from randomized controlled trials (RCTs) on the effectiveness of get-out-the-vote (GOTV) efforts in U.S. elections. RCTs are are often used to evaluate different GOTV methods \citep{Green:2013}. In these RCTs, researchers seek to understand whether contacting voters through phone calls, mail, and in-person appeals can increase voter turnout rates. 

In the second application, we then re-analyze an observational study on whether being admitted to the Intensive Care Unit (ICU) reduces mortality among critically ill patients in the United Kingdom \citep{keele2019does}. In this application, the IV is based on a natural experiment.  As such, assignment of the IV is haphazard rather than randomly assigned by the investigators. Such IVs are common in the applied literature but present a more complicated setting, since typically adjustments need to be made not only to improve precision but to mitigate confounding bias. We believe that the post-stratified IV methods we have developed will be useful in observational settings, but a full exploration is beyond the scope of this paper. Therefore, we use the ICU example as a basic illustration, and acknowledge that any conclusions should be interpreted with care as we do not make adjustments to address confounding.

The first study we analyze is an RCT designed to gauge the effectiveness of three practices to increase voter turnout: door-to-door canvassing, phone calls, or sending mailers urging people to vote \citep{gerber2000effects}.
This RCT was conducted in New Haven, Connecticut ahead of the November 1998 election.
Households with one or two registered voters were randomized to receive some combination (or none) of the three practices.
To simplify here, we focus on door-to-door canvasing where households either received face-to-face contact from canvassers encouraging them to vote, i.e. treatment, or were not contacted, i.e. control.
However, similar results in terms of standard error reduction of post-stratification were found using a factorial analysis estimating the Marginal Average Complier Effect, as defined in \cite{blackwellpashley}.
In addition, covariates on household members such as age and whether they voted in the 1996 election, as well as household size were collected.
The outcome of interest is whether either household member voted in the 1998 election.
We use the version of the data from \cite{gg_gotv_data, hansen2009attributing}.

In the original analysis, the analysts estimated the CACE using two-stage regressions with coefficients \citep{gerber2000effects}.
We post-stratify based on age, vote in 1996, and household size.
Age and household size are likely predictors of compliance (in this case, being home and answering the door if assigned to door-to-door canvasing).
Prior vote behavior is likely predictive of future vote behavior (the outcome).
For stratification, age is averaged for two-voter households and then the average household age is split into four approximately equal size groups.
Vote in 1996 is defined here as whether either household member voted in two-voter households.
We end up with 23,450 households and 17 strata which are all combinations of these covariates plus a strata defined as those with missing block variables.
Estimated compliance rates across the strata range from about 16\% to 43\%, providing some indication that we are stratifying in a meaningful way in terms of compliance.
Estimated CACEs similarly varied across strata from about -0.19 to 0.43.
Table~\ref{tab:outcomes1} contains CACE estimates based on an unstratified estimator and the proposed stratification methods.
We see around a 14\% reduction in standard error using all the post-stratified estimators, except for DSF which has around a 18\% reduction.
 This indicates appreciable gains in precision by using post-stratification.


\begin{table}[ht]
\centering
\caption{Results from unstratified and various post-stratified IV estimators for door-to-door canvassing GOTV experiment.  Bloom SEs reported.  ``\% SE'' is percent change of SE relative to Unstratified}
\label{tab:outcomes1}
\begin{tabular}{lrrrrrr}
  \toprule
Method & $\widehat{\pi}_c$  & $\widehat{CACE}$ & $\widehat{SE}$ & \% SE & $n$ & p-value\\ 
  \midrule
UNSTRAT & 0.296 & 0.084 & 0.0275 & 100 & 23,450 & 0.0024 \\ 
  $IV_w$ & 0.298 & 0.095 & 0.0238 & 86.2 & 23,450 & 0.0001 \\ 
  $IV_a$ & 0.298 & 0.095 & 0.0238 & 86.2 & 23,450 & 0.0001 \\ 
  DSS (2\%) & 0.298 & 0.095 & 0.0238 & 86.2 & 23,450 & 0.0001 \\ 
  PWIV  & 0.298 & 0.092 & 0.0226& 82.0& 23,450 & 0.0000 \\ 
  DSF  & 0.298 & 0.095 & 0.0238 & 86.2 & 23,450 & 0.0001 \\
   \bottomrule
\end{tabular}
\end{table}


In the second study, we re-analyze data from the (SPOT)light study, previously analyzed in \cite{harris2018impact} and \cite{keele2019does}. This study was a prospective cohort study to assess admission to the Intensive Care Unit (ICU) on outcomes for deteriorating ward patients \citep[see,][for more]{spotlight}. Investigators identified the number of ICU beds available as an IV for ICU admission \citep{harris2018impact}. 
This study provides an example where the instrument may not be technically classified as weak, but where the compliance rate is low and thus there is an opportunity to increase precision and improve stability of estimates.
After removing missing values, the dataset we will use here has 12,852 patients. We stratify individuals based on their recommended level of care with 0 or 1 being recommendations for normal ward care, 2 for care within high dependency unit, and 3 for ICU care. Results are given in Table~\ref{tab:outcomes}.

We see in this example that the $IV_w$ estimator did not drop any strata, and yet the estimate from this method (and $IV_a$) differs quite a bit from the standard unstratified estimator. This indicates that the original data set has some significant imbalance with respect to recommended level of care of patients.
We see increased estimated standard errors using $IV_w$ (and $IV_a$) compared to the unstratified estimator.
Because we are comparing estimates of standard errors, these may not be reflections of a true increase in variance under post-stratification (which can happen if the stratifying variable is not very predictive), but rather a reflection of the higher variability of the unstratified variance estimate.
The DSF estimator, which drops any strata that fail the F-test, is significantly smaller in magnitude than the other estimators. Looking at the last column of Table~\ref{tab:outcomes}, DSF drops multiple strata and thus about two thirds of the original sample. That being said, even with this substantial data loss, the standard error for DSF is smaller than the unstratified estimator; focusing attention on smaller samples with higher rates of compliance can give real precision gains. This emphasizes that for IV estimates, not all data are useful.

Table~\ref{tab:blocks} shows the strata-specific estimates of CACE, which vary considerably across the strata.
For example, the estimated CACE that is largest in magnitude belongs to the stratum with the second smallest estimated compliance rate. Such heterogeneity helps explain why the estimators that drop or re-weight strata could result in different conclusions.
Interestingly, the DSS estimator, which only drops the single stratum (stratum 3) with an estimated compliance of below 2\%, and thus is targeting an estimand closer to the full-sample CACE, gives a significant estimate ($t = -2.27$, $p = 0.02$).
$IV_w$ and $IV_a$ are right at the 0.05 line under a full normal approximation, with $t = 1.98$.

\begin{table}[ht]
\centering
\begin{tabular}{lrrrrrr}
  \hline
  Method & $\widehat{\pi}_c$  & $\widehat{CACE}$ & $\widehat{SE}$ & \% SE & $n$ & p-value\\ 
  \hline
     UNSTRAT & 0.087 & -0.129 & 0.086 & 100 & 12,852 & 0.134 \\ 
 $IV_w$ & 0.073 & -0.205 & 0.103 & 120 & 12,852 & 0.047 \\ 
 $IV_a$ & 0.073 & -0.205 & 0.103 & 120 & 12,852 & 0.047 \\ 
   DSS(2\%) & 0.078 & -0.225 & 0.099 & 115 & 11,651 & 0.023 \\ 
   PWIV & 0.073 & -0.115 & 0.080 & 93 & 12,852 & 0.152 \\ 
   DSF & 0.156 & -0.074 & 0.083 & 96 & 4,672 & 0.369 \\ 
   \hline
\end{tabular}
\caption{Results from applying standard unstratified and various post-stratified IV estimators for (SPOT)light study.  Bloom SEs reported.}\label{tab:outcomes}
\end{table}


\begin{table}[ht]
\centering
\begin{tabular}{r|rrrr}
  \hline
 Block & $\widehat{\pi}_c$  & $\widehat{CACE}$ & $\widehat{SE}$ & $n$ \\ 
  \hline
   0 & 0.091 &  0.131 & 0.286 & 918 \\ 
   1 & 0.026 & -0.825 & 0.368 & 6,979 \\ 
   2 & 0.172 & -0.101 & 0.086 & 3,754 \\ 
   3 & 0.019 &  0.607 & 1.499 & 1,201 \\ 
     \hline
\end{tabular}
\caption{Stratum level results. The first column gives the recommended level of care for the stratum. Bloom SEs reported.}\label{tab:blocks}
\end{table}

\section{Conclusion}

We have examined the benefits of combining IV estimators with post-stratification theoretically and through simulation.
We largely focus on how to take advantage of a baseline covariate predictive of compliance behavior, rather than outcome.
Classic IV approaches do not benefit much, if at all, from including such covariates. Post-stratification on these covariates, isolating compliers in some strata and dropping the rest, can, however, provide real precision gains. Along the way we also study the post-stratified IV estimator more broadly. The theoretical advantages of this approach include lower bias, lower variance, and lower variability of the SE estimates, especially when stratifying on a covariate predictive of outcome.


\clearpage

\bibliographystyle{apalike}
\bibliography{iv_ref}{}

\begin{appendices}
\include{iv_post_append}
\end{appendices}






\end{document}