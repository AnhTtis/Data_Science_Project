\section{Introduction}\label{sec:intro}
We study the stable marriage problem in the presence of {\em ties} in preferences and {\em critical vertices}. 
 Formally, the input to our problem is a bipartite graph $G=(\AA\cup\BB,E)$, where $\AA$ and $\BB$ are two sets of vertices and $E$ denotes the set of all the acceptable vertex-pairs. %Every vertex $u\in \AA\cup\BB$ has a preference ordering on its neighbours, called the {\em preference list} of $u$, denoted as $\prefu$. 
 Each vertex $u \in \AA \cup \BB$ ranks a subset of vertices in the other partition (its neighbours in $G$)  in order of its preference possibly involving ties -- this ordering is denoted as $\prefu$. 
 For a vertex $u$ let $v_1$ and $v_2$ be its neighbours in $G$. The vertex $u$ strictly prefers $v_1$ over $v_2$  (denoted as $v_1 \succ_u v_2$) if the rank of the edge $(u, v_1)$ is smaller than the rank of the edge $(u, v_2)$.  The vertex $u$ is tied
 between $v_1$ and $v_2$ (denoted as $v_1 =_u v_2$) if the ranks on the edges $(u, v_1)$ and $(u, v_2)$ are the same. We use  $v_1\succeq_u v_2$ to denote that the rank of $v_1$ is at least as good as the rank of $v_2$ in $\prefu$.
In addition, the input consists of a set $\CC\subseteq (\AA\cup\BB)$ of \emph{critical vertices}. %Our goal is to compute a matching in $G$ that matches maximum number of critical vertices. 
Critical vertices are a generalization of lower-quota vertices that {\em must} be matched in any assignment. In our setting, critical vertices can be left unassigned, however, we wish to minimize the number of critical vertices left unassigned.
%\clr{In literature, the stable marriage problem with ties and incomplete lists is denoted by \SMTI. We denote our setting -- the stable marriage problem with two-sided ties and two-sided critical vertices by \SMTTLQ. Note that we allow the preference lists to be incomplete in our setting.}

A \emph{matching} $M\subseteq E$ in $G$ is a set of edges that do not share an end-point. For each vertex $u\in\AA\cup\BB$, we denote by $M(u)$, the neighbour of $u$ that is assigned to $u$ in $M$. %In the matching $M$, a vertex $u\in\AA\cup\BB$ is called \emph{matched} if $|M(u)| = 1$ and \emph{unmatched} if $|M(u)| =0$. %A critical vertex $u$ is \emph{deficient} in a matching $M$ if it is unmatched in $M$, and a non-critical vertex $u$ is \emph{surplus} in $M$ if $u$ is matched in $M$.  
In the presence of critical vertices, the most important attribute of any matching is to match as many critical vertices as possible. A matching $M$ is \emph{critical}~\cite{Kavitha2021} if there is no matching  that matches more critical vertices than $M$.  In this work, we are interested in computing a critical matching that is {\em optimal} with respect to the preferences of the vertices in an instance of our setting.

Lower-quotas or critical vertices/positions naturally arise in applications like Hospital-Residents problem~\cite{HIM16} where rural hospitals must be prioritized to ensure sufficient staffing.  
Another example is the problem of assigning sailors to billets~\cite{tan2001designing} in the US Navy where some critical billets cannot be left vacant~\cite{robards2001applying,yang2003two}. Ties in preferences is yet another important practical consideration in matching problems and has been extensively investigated in the literature~\cite{manlove2002hard,mcdermid20093,Kiraly13,paluch2014faster,dean2015factor,huang2015improved,hamada2019strategy}. However, there is a limited investigation of matching problems with ties as well critical vertices~\cite{goko2022maximally} and ours is the first work that allows ties as well as critical vertices on both sides of the bipartition.
 


% \begin{definition}[Critical Matching]\label{def:critical}
% A matching $M$ in $G$ is critical if there is no matching $N$ in $G$ such that $\Df{N}<\Df{M}$. 
% \end{definition}

Stability which is  the de-facto notion of optimality for two-sided preferences is defined by the absence of a blocking pair. Informally,  an assignment is stable if no unassigned pair wishes to deviate from it. 
%In literature the notion  of stability is suitably relaxed (weakened) to individually  address ties and critical vertices.
%We first present the definition of stability.
\begin{definition}[Stable Matchings]\label{def:bPT}
Given a matching $M$, a  pair $(a,b)\in E\setminus M$ is called blocking pair w.r.t. $M$ if (i) either $a$ is unmatched or $b \succ_a M(a)$ and (ii) either $b$ is unmatched or $a\succ_b M(b)$. The matching $M$ is stable if there is no blocking pair w.r.t. $M$.
\end{definition}
When all preferences are strict, that is there are no ties, every instance of the stable marriage problem admits a stable matching and it can be computed using the famous Gale and Shapley algorithm~\cite{GS62}. In addition, it is well known~\cite{roth1984stability,roth1986allocation} that all stable matchings  have the same size.

\noindent {\bf Stable matching in the presence of ties: }  When preferences are allowed to have ties, the notion of stability defined above is referred to as ``weak stabilty" (referred to as stability in the rest of the paper).  We remark that for a pair $(a, b)$ to block a matching $M$, both $a$ and $b$ prefer each other {\em strictly} over their current partners in $M$.
Every instance of the stable marriage problem with ties admits a stable matching and it can be efficiently computed. However, unlike in the case of strict lists, all stable matchings need not have the same size and the problem of computing a maximum or minimum size stable matching is NP-hard~\cite{manlove2002hard} under severe restrictions -- the ties occur at the end of preference lists and on one side of bipartition only, there is at most one tie per list, and each tie is of length two.

\noindent \noindent {\bf Stable/popular matching in the presence of critical vertices:} When preferences of all the vertices are strict and we have critical vertices as a part of the input, a stable matching always exists.  However,  stable matching which is also critical may not exist (see Figure~\ref{subfig:exRSMSMTTLQ}). %this holds even when critical vertices are present only on one side of the bipartition.  %One such example is shown in Figure~\ref{subfig:exSMLQ}. Any critical matching in the instance in Figure~\ref{subfig:exSMLQ} must match $b_2$ with $a_1$ which results in the blocking edge $(a_1,b_1)$. 
Since stability and criticality are not simultaneously guaranteed, an alternate notion of optimality, namely \emph{popularity}~\cite{G75} is extensively investigated in the literature~\cite{NN17,NNRS21,Kavitha2021}. The goal is to compute   {\em popular} amongst the set of critical matchings.  Informally, a matching $M$ is \emph{popular} in a  set of matchings if no majority of vertices wish to deviate from $M$ to any other matching in that set. %For the example instance in Figure~\ref{subfig:exRSMSMTLQ},  the matching $M=\{(a_1,b_2),(a_2,b_1)\}$  is critical as well as popular. 
%for the instance shown in Figure~\ref{subfig:exSMLQ}. It is easy to verify that no majority of vertices wish to deviate to any other critical matching from $M$. Thus, $M$ is popular amongst critical matchings. 
It is known~\cite{Kavitha2021,NNRS21} that an instance with strict preference lists \emph{always} admits a matching which is popular amongst critical matchings and such a matching can be computed efficiently. Hence, it is natural to consider popularity in the presence of critical vertices and ties. 

However, even when ties are present in the preferences only on one side of the bipartition (even with no critical vertices),
 popular matchings are not guaranteed to exist~\cite{biro2010popular}, and deciding whether a popular matching exists is NP-Hard. 
 In light of this, we explore  the notion of  {\em relaxed stability}.
 
\noindent {\bf Relaxed stability in the presence of ties and critical vertices: } The notion of relaxed stability was introduced and  studied by Krishnaa~\etal~\cite{krishnaa2020envy} for the Hospital-Residents problem  with lower quotas (\HRLQ).  In their setting, preferences are assumed to be strict. The  \HRLQ\ setting is a many-to-one matching problem where a hospital $h$ can accept at most  $q^+(h)$ many residents and has $q^-(h) \leq q^+(h)$ many critical positions.  
To satisfy the critical positions at a hospital, certain residents may be {\em forced} to be matched to the hospital. The notion of relaxed stability allows only such residents to participate in blocking pairs. In addition, if a resident matched to $h$ participates in a blocking pair then the hospital $h$ should not be {\em surplus}, that is $|M(h)| \leq q^-(h)$.

In the \HRLQ\ setting, preferences are strict, hospitals have  capacities as well as critical positions are
allowed only for hospitals. In contrast, we allow ties in preferences as well as critical vertices to appear on {\em both sides} of the bipartition. However, our setting is one-to-one. 
%for every hospital $h$; moreover, a subset of hospitals have lower quotas (denoted by $q^-(h)$ for a hospital $h$) which denote the number of critical posts in that hospital.
 %In the journal version of their work, Krishnaa~\etal~\cite{krishnaa2023envy} strengthen their definition of relaxed stable matching for the the \HRLQ\ setting, which is given as Definition~\ref{def:rsmHRLQ} below.

 %The instance shown in Figure~\ref{subfig:exRSMSMTLQ} contains ties and critical vertices on only one side. Moreover, ties and critical vertices are both on the same side. Critical vertices are denoted as a red-coloured vertex. A critical matching of this instance matches all three critical vertices and hence the deficiency of any critical matching in this instance is zero. Since any stable matching has to match $a_1$ with $b_1$, it is clear that no stable matching of this instance is critical. Observe that there are 6 critical matchings but each of these six critical matchings is beaten by some other critical matching in a head-to-head election where vertices cast votes for these matchings. So, we conclude that no critical matching is popular for the given instance. Hence, critical popular matching does not exist in this instance.

 

%\begin{definition}[Relaxed stability in \HRLQ\ ]~\cite{krishnaa2023envy}\label{def:rsmHRLQ} A matching $M$ is relaxed stable if, no unmatched resident blocks $M$ and for a blocking resident $r$, the hospital $h = M(r)$ satisfies $|M(h)| \le q^-(h)$.
%\end{definition}

%Intuitively, some residents may be forced to match to critical positions. This notion of relaxed stability allows only such residents to participate in blocking pairs. Furthermore, if hospital $h$ has a resident $r$ matched to it such that $r$ forms a blocking pair, then $h$ should not be matched with more than $q^-(h)$ many residents. We denote a relaxed stable matching by \RWSM. %Authors in~\cite{krishnaa2023envy} show that a critical \RSM\ \emph{always} exists in an \HRLQ\ instance. They also show that computing a maximum size critical relaxed stable matching is NP-Hard. Finally, they give an efficient algorithm for computing critical \RSM\ $M$ in an \HRLQ\ instance such that $M$ is a $\frac{3}{2}$-approximation of a maximum size critical \RSM.

%Relaxed stability and popularity are not the same even in the strict list setting and critical vertices are restricted to one side only (see Appendix~\ref{append:RSvsPop}).

%Our first contribution is to adapt the above definition to the case when critical vertices can be present on both sides of the bipartition. Informally, in our setting, 
We now  define the notion of relaxed stability \RWSM\ for our setting.
Intuitively, a matching  $M$ is a \RWSM\ if  every blocking pair $(a, b)$  w.r.t. $M$ is \emph{justified} by either the $a$ endpoint or by the $b$ endpoint.  A vertex $a$ justifies the blocking pair if  $M(a)$ is a critical vertex. That is, $M(a)$ forces $a$ to be matched to a lower-preferred vertex than $b$. Similarly, the vertex $b$ can justify the blocking pair $(a, b)$. 
%if either $a$ is matched to a critical vertex or $b$ is matched to a critical vertex or both. We define the \RWSM\ for our setting in Definition~\ref{def:rsm11}. 

\begin{definition}[Relaxed stability in our setting]\label{def:rsm11} A matching $M$ is \RWSM\ if for every blocking pair $(a,b)$ w.r.t. $M$ one of the following holds:
        \begin{enumerate}
            \item\label{itm:1rwsm} $a$ is matched and $b'= M(a)$ is critical, or
            \item\label{itm:2rwsm} $b$ is matched and $ a'= M(b)$ is critical.
        \end{enumerate} 
\end{definition}

% \begin{figure}[!h]
% \centering
% % \begin{subfigure}{.5\textwidth}
% % \centering
% % \input{exFig1.tex}
% % \caption{}
% % \label{subfig:exSMLQ}
% % \end{subfigure}%
% % \begin{subfigure}{.5\textwidth}
% % \centering
% \input{exFig2.tex}
% % \caption{}
% % \label{subfig:exRSMSMTTLQ}
% % \end{subfigure}%
% \caption{\label{subfig:exRSMSMTTLQ} %\label{fig:CexRWSMMM}%
% Red vertices are critical,  black vertices are non-critical. The numbers on the edges denote the ranks of the respective end-points. The instance does not admit any critical stable matching because $b_2$ remains unmatched in each stable matching. $M_1=\{(a_1,b_2),(a_2,b_1),(a_3,b_3)\}$ is critical but not \RWSM\ because the blocking edges $(a_2,b_3)$ and $(a_2,b_4)$ are not justified. $M_2=\{(a_1,b_2),(a_2,b_4),(a_3,b_3)\}$ is \CRWSM\ because the only blocking edge $(a_1,b_1)$ is justified by $a_1$.}
% \end{figure}
 

\begin{figure}
	\begin{center}
		\scalebox{0.8}{\input{exFig2.tex}}
	\end{center}
	\caption{Red vertices are critical,  black vertices are non-critical. The numbers on the edges denote the ranks of the respective end-points. The instance does not admit any critical stable matching because $b_2$ remains unmatched in every stable matching. $M_1=\{(a_1,b_2),(a_2,b_1),(a_3,b_3)\}$ is critical but not \RWSM\ because the blocking edge $(a_2,b_4)$ is not justified. $M_2=\{(a_1,b_2),(a_2,b_4),(a_3,b_3)\}$ is \CRWSM\ because the only blocking edge $(a_1,b_1)$ is justified.}\label{subfig:exRSMSMTTLQ}
\end{figure}


A matching $M$ is called critical relaxed stable matching (\CRWSM) if it is \emph{critical} as well as \emph{relaxed stable}. In the instance shown in Figure~\ref{subfig:exRSMSMTTLQ}, the matching $M_1$ is critical but not \RWSM\ whereas $M_2$ is \CRWSM.

Our first contribution is to show that a \CRWSM\ always exists in our setting. We remark that when $\CC=\emptyset$, an instance of our setting is the same as stable marriage setting with ties but without critical vertices, and hence the set of \CRWSM\ is the same as the set of stable matchings. This immediately implies that computing a maximum size critical \RWSM\ is NP-Hard~\cite{manlove2002hard} and hard to approximate~\cite{halldorsson2007improved}. For the problem of computing a maximum sized stable matching in the presence of two-sided ties, the current best approximation factor \cite{Kiraly13,mcdermid20093,paluch2014faster} is $\frac{3}{2}$. The main result  (Theorem~\ref{theo:main}) provides the same approximation size guarantee for a maximum sized \CRWSM\ in our setting.


 %The main contribution of this work is an efficient algorithm to compute a $\frac{3}{2}$-approximation of a maximum size \CRWSM\ for an instance of our setting.  
\begin{theorem}\label{theo:main}
  Let $G=(\AA\cup\BB,E)$ be an instance of the stable marriage problem with two-sided ties and two-sided critical vertices. Then $G$ always admits a matching $M$ such that $M$ is \CRWSM\ and can be computed efficiently. Moreover, $|M|\ge \frac{2}{3}|M'|$, where $M'$ is a maximum size \CRWSM\ in $G$.  
\end{theorem}


\noindent{\bf Related work:}
As mentioned earlier, the generalizations of the stable marriage problem to allow one of ties in preferences or critical vertices/lower-quota positions has been extensively investigated.
%\cite{manlove2002hard,biro2010popular,hamada2019strategy,NN17,Kavitha2021,NNRS21}. 
The only work which we are aware of allows both ties and critical vertices is a recent work by Goko \etal~\cite{goko2022maximally}. They study the Hospital-Residents problem with lower-quotas with ties on both sides. However, one side of the bipartition cannot have critical vertices. Furthermore, their results are for complete preference, a restricted setting. 
Goko \etal define the maximum satisfaction ratio which for our one-to-one setting coincides with the definition of critical matchings. However, their goal is to compute amongst all stable matchings the one that achieves criticality. %Hence our results are incomparable to theirs.

For strict preferences and lower-quotas / critical vertices, various notions like envyfreeness~\cite{Yokoi20,krishnaa2023envy}, popularity~\cite{NN17,Kavitha2021,NNRS21,nasre2022popular}, and relaxed stability~\cite{krishnaa2020envy,krishnaa2023envy} have been studied. Relaxed stability and popularity do not define the set of matchings even in the one-to-one strict-list setting and critical vertices restricted to one side only (see Appendix~\ref{append:RSvsPop}). Hamada \etal~\cite{HIM16} consider the problem of computing a matching with minimum number of blocking pairs or blocking residents. 

For the stable marriage problem with ties (without critical vertices) there is a long line of investigation \cite{kiraly2011better,mcdermid20093,Kiraly13,paluch2014faster,iwama201425,dean2015factor,huang2015improved} in order to improve the approximation ratio under various restricted settings. The best known approximation algorithm for the case of one-sided ties is by Lam and Plaxton~\cite{lam20191} whereas the best known for the case of two-sided ties is by ~\cite{Kiraly13,mcdermid20093,paluch2014faster}.
We use Kir{\'a}ly's algorithm~\cite{Kiraly13} in our work.

%The notion of \RSM\ was introduced and studied by Krishnaa \etal~\cite{krishnaa2020envy} for \HRLQ\ setting. The authors showed that a critical relaxed stable matching always exists in an \HRLQ\ instance, but computing a maximum-sized relaxed stable matching is NP-hard and hard to approximate below $\frac{21}{19}$. An efficient algorithm for computing a $\frac{3}{2}$-approximation of the maximum size critical relaxed stable matching was also given. 

%Different notions are introduced to deal with the ties in the preference lists and critical vertices. In order to deal with lower quotas in \HRLQ\ problem, Hamada \etal~\cite{HIM16} considered the problem of computing a feasible matching with \emph{minimum} number of blocking pairs or blocking residents -- both these problems turned out to be NP-Hard.  Nasre and Nimbhorkar~\cite{NN17} used the notion of popularity to deal with lower quotas and showed that the maximum cardinality popular matching amongst feasible matchings for an \HRLQ\ problem is efficiently computable. \emph{Envy-freeness}~\cite{wu2018lattice}, a relaxed notion of stability, is another well-investigated optimality notion in \HR\ settings. Yokoi in~\cite{Yokoi20} investigated envy-freeness for \HRLQ\ setting and provided a characterization for \HRLQ\ instances that admit an envy-free matching. %She also gave a linear-time algorithm to compute an envy-free matching, if it exists. 
%Kavitha~\cite{Kavitha2021} and Nasre \etal~~\cite{NNRS21} explored the popularity for two-sided criticality and showed that a maximum size popular matching amongst all critical matchings is efficiently computable.

%Different stable matchings of an instance containing ties can be of different sizes~\cite{irving1994stable}. It is natural to consider the problem of finding a maximum size stable matching. This problem is called \MAXSMTI\ in the literature and is NP-Hard~\cite{iwama1999stable,manlove2002hard}. A $\frac{3}{2}$-approximation algorithm was given by McDermid~\cite{mcdermid20093} and Kir{\'a}ly~\cite{Kiraly13}. Hamada \etal~\cite{hamada2019strategy} studied the tradeoff between strategy-proofness and approximability for the \MAXSMTI\ problem. 

%The closest to our setting is the \emph{marriage model} considered by Goko \etal~\cite{goko2022maximally}. Authors in~\cite{goko2022maximally}, studied \HRLQ\ problem with two-sided ties under four different scenarios. One of the scenarios is the marriage model where ties are allowed on both sides and critical vertices are restricted to one side. This problem has two differences with our setting. Throughout the paper they have assumed that -- (i) the critical vertices are only on one side of bipartition, and (ii) all the preference lists are complete. Thus, our setting is a generalisation of the marriage model considered in~\cite{goko2022maximally}. They studied the problem of computing stable matching with maximum total \emph{satisfaction ratio} for lower quotas, where the satisfaction ratio of each hospital $h$ is given by $\min \{1,\frac{|M(h)|}{q^-(h)}\}$ if $q^-(h)>0$, and 1, otherwise. It is easy to observe that for the marriage model, a matching $M$ has the maximum total satisfaction ratio if and only if it is critical. Also, note that a \emph{stable matching} with maximum total satisfaction ratio may not be critical because an instance may not even admit a critical stable matching. Recall that we are interested in computing a \emph{critical} matching that is {\em optimal}. Thus, although the definitions of critical matching and matching with maximum total satisfaction ratio coincide for the marriage model, the problem considered in~\cite{goko2022maximally} is completely different from ours.



%\noindent{\bf Organisation of the paper:} Section~\ref{sec:prelim} discusses the techniques we use in our algorithm. Algorithm for computing $\frac{3}{2}$-approximation of a maximum size \CRWSM\ is given in Section~\ref{sec:algo}. We prove the correctness of our algorithm in Section~\ref{sec:correct}.% Finally, Section~\ref{sec:conclude} concludes the paper. 