\section{Algorithm for computing \CRWSM} \label{sec:algo}
Our algorithm (see Algorithm~\ref{algo:criRSM}) is a combination of Kir{\'a}ly's algorithm and the popular critical matching algorithm discussed in the previous section. In each level, vertices in $\AA$ propose and vertices in $\BB$ accept or reject. The set of vertices that $a\in \AA$ proposes to depends on its level. Furthermore, depending on the level of $a$, the preference list at that level may be strict or may contain ties. Throughout Algorithm~\ref{algo:criRSM}, $b$ uses its original preference list $\prefb$ which possibly contains ties. For a vertex $a \in \AA$, let $\prefsa$ denote a {\em strict} preference list obtained by breaking ties in $\prefa$ so that the vertices in ties are ordered by increasing order of their indices. Furthermore, let $\prefslqa$ be the strict list obtained from $\prefsa$ by omitting all the non-critical vertices from $\prefsa$.
For example, assume $\prefa = (b_2, b_1), b_5, (b_3, b_4)$ where $b_4$ and $b_5$ are critical vertices. Here, $a$ ranks
$b_1$ and $b_2$ as rank-1, $b_5$ as rank-2 and $b_3$ and $b_4$ as rank-3. We have $\prefsa = b_1, b_2, b_5, b_3, b_4$ and $\prefslqa = b_5, b_4$ where comma separated vertices denote a strict ordering.

%Phase~1 corresponds to fulfilling the deficiencies of the vertices on the $\BB$-side up to the maximum possible extent, phase~2 corresponds to matching the remaining vertices on $\BB$-side and also to increasing the size of the matching, and phase~3 corresponds to fulfilling the deficiencies of the vertices on the $\AA$-side up to the maximum possible extent.  Recall that $\prefa$ and $\prefb$ denote respectively the preference lists of $a\in\AA$ and $b\in\BB$ which may contain ties.  Let $\prefsa$ for $a\in \AA$ denote the preference list obtained by breaking the ties from $\prefa$ in such a way that the vertices in ties are ordered increasingly in their indices. Thus, $\prefsa$ for each $a\in \AA$ is a \emph{strict} preference list. Also, assume that $\prefslqa$ denotes $\prefsa$ restricted to critical nodes. That is, $\prefslqa$ is the strict preference list obtained from $\prefsa$ by omitting all the non-critical nodes from $\prefsa$.


Initially, all the vertices in $\AA$ have their levels set to 0. A vertex $a$ at level $\ell$ is denoted as $a^\ell$.  At a level less than $\T$ (see Line~\ref{alg:all2lqs}--Line~\ref{alg:all2lqe} of Algorithm~\ref{algo:criRSM}), each $a\in\AA$ proposes to vertices in $\prefslqa$. Each time it remains unmatched, it proposes to its \emph{most preferred} neighbour $b$. The most preferred neighbour in $\prefslqa$ or $\prefsa$ is the best-ranked neighbour $b$ to whom $a$ has not yet proposed at the current level. If $a$ remains unmatched after proposing to all its neighbours in $\prefslqa$ at a level $\ell<\T - 1$, then $a$ raises its level to $\ell+1$ and again proposes to vertices in $\prefslqa$. In this part of the algorithm, we invoke \texttt{CriticalPropose()} which encodes the level-based accept/reject by $b$. A vertex $b\in\BB$ prefers $a_i^\ell$  over $a_j^{\ell'}$ if : 
\begin{itemize}
    \item[(i)] either $\ell > \ell'$ (ranks of $a_i$ and $a_j$ in $\prefb$ do not matter) or
    \item[(ii)] $\ell = \ell'$ and $a_i\succ_b a_j$.
\end{itemize} 


\begin{algorithm}[ht]
    \SetKwFunction{deficient}{CriticalPropose}
    \SetKwFunction{tiespropose}{TiesPropose}
    \caption{Critical relaxed stable matching in $G = (\AA \cup \BB, E)$ }\label{algo:criRSM}
    \DontPrintSemicolon
    \SetAlgoLined
    Set $M=\emptyset$, Initialize a queue $Q=\{a^0\ :\ a\in \AA\}$\;
    \While{$Q$ is not empty}{
        Let $a^\ell=dequeue(Q)$ \tcc*{ $a$ is unmatched}
        \If {$\ell<\T$ \label{alg:all2lqs} } { 
            \If{ $a^\ell$ has not exhausted $\prefslqa$}{
               \deficient{$a^\ell,\prefslqa,M,Q$ }\;
            }
            \Else{$\ell=\ell+1$ and add $a^\ell$ to $Q$\; \label{alg:all2lqe}}
        }
        \uElseIf{$\ell==\T$ or $\ell==\T^*$}{  
         \If{$\exists\ b'\in\prefa$ which is marked/unproposed by $a^\ell$ \label{alg:kiralyS}}{   
            % $b=$\favnbr{$a^\ell,\prefa$}\;% \tcc*{ $b$ is the favourite neighbour of $a$}\; 
            \tiespropose{$a^\ell, \prefa, M, Q$}\;
            % Let $b$ be the favourite neighbour of $a$ in $\prefa$ at rank $k$\label{alg:favNbr}\; 
            % \textbf{if} $b$ was marked by $a$ \textbf{then} $a$ unmarks $b$\;
            % \If{$b$ is unmatched}{
            %     $M=M\cup \{(a^\ell,b)\}$\;
            %     \If{there exists an unmatched $b''$ at rank $k$ in $\prefa$ }{
            %         Set $(a^\ell,b)$ as uncertain proposal}
            % }
            % \uElseIf{$b$ is part of an uncertain proposal $(a_j^y,b)$}{
            %     $M=(M\setminus \{(a_j^y,b)\}) \cup \{(a^\ell,b)\}$\;
            %     $a_j^y$ marks $b$ and add $a_j^y$ to $Q$}
            % \uElseIf{$b$ is not part of an uncertain proposal}{
            %     Let $a_j^y= M(b)$\;
            %     \If{$\ell==\T$}{                   
            %         \If{($y<\T$) or (($y==\T$ or $y==\T^*$) and $a\succ_b a_j$)}{
            %             $M=M\setminus \{(a_j^y,b)\}\cup \{(a^\ell,b)\}$ and add $a_j^y$ to $Q$\;}
            %         \Else{add $a^\ell$ to $Q$}
            %     }
            %     \If{$\ell==\T^*$}{                   
            %         \If{($y<\T$) or ($y==\T$ and $a\succeq_b a_j$) or ($y==\T^*$ and $a\succ_b a_j$)}{
            %         $M=M\setminus \{(a_j^y,b)\}\cup \{(a^\ell,b)\}$ and add $a_j^y$ to $Q$\;}
            %         \Else{add $a^\ell$ to $Q$}
            %     }                
            %     }
            }
            \Else{
                \textbf{if} $\ell==\T$ \textbf{then} $\ell=\T^*$ and add $a^\ell$ to $Q$  \label{alg:kiralyE}\;
                \textbf{if} $\ell==\T^*$ \textit{and} $a$ is critical \textbf{then} $\ell=\T+1$ and add $a^\ell$ to $Q$\;
            }
        } 
        \Else{
            \If{$a^\ell$ has not exhausted $\prefsa$ \label{alg:lqToAllS}}{
                \deficient{$a^\ell,\prefsa,M,Q$ }\;
            }
            \Else{ 
                \If{$\ell<\S+\T$ and $a$ is critical \label{alg:lq}}{$\ell=\ell+1$ and add $a^\ell$ to $Q$ \label{alg:lqToAllE}\;}
                 }
        }
    }
    \Return $M$
\end{algorithm}
If vertex $a$ remains unmatched after exhausting $\prefslqa$ at level $\T-1$, $a$ attains level $\T$ where it uses its original preference list $\prefa$ which may contain ties. At level $\T$ our algorithm executes Kir{\'a}ly's algorithm~\cite{Kiraly13}. This corresponds to Line~\ref{alg:kiralyS}--Line~\ref{alg:kiralyE} of Algorithm~\ref{algo:criRSM}. { Kir{\'a}ly's algorithm is encoded in the procedure \texttt{TiesPropose()}.} Since we have two-sided ties at this level, we need the notion of a favourite neighbour and uncertain proposal defined in Section~\ref{sec:prelim}. If the vertex $a$ remains unmatched after exhausting $\prefa$ at level $\T$, it attains the $*$ status, and for this, we have the sub-level $\T^*$. The interpretation of the $*$ status is the same as discussed in Section~\ref{sec:prelim}. %Let $a_i$ and $a_j$ be two neighbours of $b$ in $\prefb$ such that $a_i$ is at level $\T^*$ whereas $a_j$ is at level $\T$. Then $a_i^{\T^*}\succ_b a_j^{\T}$ if and only if $a_i=_b a_j$ or $a_i\succ_b a_j$.

\setlength{\textfloatsep}{8pt}% Remove \textfloatsep
\begin{procedure}
\caption{CriticalPropose($a^\ell,\prefal,M,Q$)}\label{proce:Decide}
    \DontPrintSemicolon
    \SetAlgoLined
    Let $b$ be the most preferred unproposed vertex by $a^\ell$ in $\prefal$ \;
                \If{$b$ is unmatched in $M$}{
                    $M=M\cup \{(a^\ell,b)\}$}
                \Else{
                    Let $a_j^y= M(b)$\;
                    \If{($\ell>y$) or ($\ell==y$ and $a\succ_b a_j$)}{
                    $M=M\setminus \{(a_j^y,b)\}\cup \{(a^\ell,b)\}$ and add $a_j^y$ to $Q$\;
                    }
                    \textbf{else } add $a^\ell$ to $Q$ 
                }
\end{procedure}
If a \emph{critical} vertex $a$ remains unmatched after exhausting its preference list $\prefa$ at level $\T^*$, $a$ raises its level to $\T+1$, and starts proposing to vertices in $\prefsa$ (see Line~\ref{alg:lqToAllS}--Line~\ref{alg:lqToAllE} of Algorithm~\ref{algo:criRSM}). It continues doing so until either it is matched or it has exhausted $\prefsa$ at level $\S+\T$.
In contrast, if a non-critical vertex $a$ remains unmatched after exhausting its preference list $\prefa$ at level $\T^*$, $a$ does not propose any further. 
Recall that $\prefsa$ is a strict preference list containing all the neighbours (not restricted to critical vertices). Here, Algorithm~\ref{algo:criRSM}, again invokes \texttt{CriticalPropose()} for the  level-based accept/reject by $b$. 
%Note that from level 0 to level $\T-1$, a vertex $a\in\AA$ uses its strict preference list restricted to critical vertices, that is $\prefslqa$. This corresponds to Line~\ref{alg:all2lqs}-Line~\ref{alg:all2lqe}.
The algorithm terminates when either (i) all the vertices in $\AA$ are matched or (ii) all unmatched critical $a\in\AA$ have exhausted $\prefsa$ at level $\S+\T$ and all unmatched non-critical $a\in\AA$ have exhausted $\prefa$ at level $\T^*$. %Throughout the algorithm, once a vertex $a$ raises its level, it starts proposing to vertices from the beginning of its current preference list until it is matched. The approach is formally described in Algorithm~\ref{algo:criRSM}. Algorithm~\ref{algo:criRSM} uses a procedure \texttt{CriticalPropose()}. This procedure is the standard accept/reject procedure and is called in phase 1 and phase 2 of our algorithm. Thus, in \texttt{CriticalPropose()} either only critical nodes receive proposals (when $\ell<\T$) or  only critical nodes propose (when $\ell\ge \T+1$). This completes the description of our algorithm. Let $M$ be the output matching of our algorithm. %Algorithm~\ref{algo:criRSM} uses  two procedures \texttt{CriticalProposal()} and \texttt{GetFavNbr()}. The first procedure is the standard accept/reject procedure and is called in phase 1 and phase 2 of our algorithm. Thus, in \texttt{CriticalProposal()} either only critical nodes receive proposals (when $\ell<\T$) or  only critical nodes propose (when $\ell\ge \T+1$). The second procedure \texttt{GetFavNbr()} is used to get the most favourite neighbour of $a$ from the preference list containing ties. Assume $k$ is the best rank at which some unproposed or marked neighbours of $a$ exist in $\prefa$. If there exists an unmatched vertex at rank $k$, then \texttt{GetFavNbr()} returns one such vertex as the favourite neighbour (to ensure that the algorithm behaves deterministically \texttt{GetFavNbr()} chooses the lowest index such vertex). If all vertices at rank $k$ are matched then it returns one which is unproposed by $a$, and if all vertices at rank $k$ are matched and no vertex at rank $k$ remains unproposed by $a$ then it returns one which is marked by $a$.  This completes the description of our algorithm. Let $M$ be the output matching of our algorithm. 
We note that $\S+\T=|\CC|=O(n)$, where $n=|\AA\cup\BB|$ and each edge of $G$ is explored at most $\S+\T+3$ times (at most three times at level $\T$, the Kir{\'a}ly's step, and at most once at every other level). Thus, the running time of our algorithm is $O(n\cdot |E|)$.



%============================================================================================================
%============================================================================================================

% \begin{procedure}%
%     \caption{TiesPropose($a^\ell,\prefal, M, Q$)}\label{proce:TiesProp}
%     \DontPrintSemicolon
%     \SetAlgoLined
%                 Let $b$ be the favourite neighbour of $a$ in $\prefa$ at rank $k$\label{alg:favNbr}\; 
%             \textbf{if} $b$ was marked by $a$ \textbf{then} $a$ unmarks $b$\;
%             \If{$b$ is unmatched}{
%                 $M=M\cup \{(a^\ell,b)\}$\;
%                 \If{there exists an unmatched $b''$ at rank $k$ in $\prefa$ }{
%                     Set $(a^\ell,b)$ as uncertain proposal}
%             }
%             \uElseIf{$b$ is part of an uncertain proposal $(a_j^y,b)$}{
%                 $M=(M\setminus \{(a_j^y,b)\}) \cup \{(a^\ell,b)\}$\;
%                 $a_j^y$ marks $b$ and add $a_j^y$ to $Q$}
%             \uElseIf{$b$ is not part of an uncertain proposal}{
%                 Let $a_j^y= M(b)$\;
%                 \If{$\ell==\T$}{                   
%                     \If{($y<\T$) or (($y==\T$ or $y==\T^*$) and $a\succ_b a_j$)}{
%                         $M=M\setminus \{(a_j^y,b)\}\cup \{(a^\ell,b)\}$ and add $a_j^y$ to $Q$\;}
%                     \textbf{else } add $a^\ell$ to $Q$
%                 }
%                 \If{$\ell==\T^*$}{                   
%                     \If{($y<\T$) or ($y==\T$ and $a\succeq_b a_j$) or ($y==\T^*$ and $a\succ_b a_j$)}{
%                     $M=M\setminus \{(a_j^y,b)\}\cup \{(a^\ell,b)\}$ and add $a_j^y$ to $Q$\;}
%                     \textbf{else } add $a^\ell$ to $Q$
%                 }                
%                 }
% \end{procedure}
% \setlength{\intextsep}{8pt}% Remove \textfloatsep







% \begin{procedure}
% \caption{GetFavNbr($a,\prefa$)}\label{proce:favNbr}
%     \DontPrintSemicolon
%     \SetAlgoLined
%     Let $k$ be the best rank at which some unproposed or marked neighbours of $a$ exist in $\prefa$\;
%     \If{there exists an unmatched neighbour at $k^{th}$ rank}{
%         Let $b$ has the lowest index among all unmatched neighbours at $k^{th}$ rank\;
%     }
%     \uElseIf{there exists an unproposed vertex at $k^{th}$ rank}{
%         Let $b$ has the lowest index among all unproposed neighbours at $k^{th}$ rank\;
%     }
%     \uElseIf{there exists a vertex at $k^{th}$ rank which is marked by $a$}{
%         Let $b$ has the lowest index among all the marked neighbours by $a$ at $k^{th}$ rank\;
%     }
%     return $b$\;
% \end{procedure}



% \begin{algorithm}
%     \SetKwFunction{favnbr}{GetFavNbr}
%     \caption{Critical relaxed stable matching in $G = (\AA \cup \BB, E)$ }\label{algo:criRSMOld}
%     \DontPrintSemicolon
%     \SetAlgoLined
%     Set $M=\emptyset$, Initialize a queue $Q=\{a^0\ :\ a\in \AA\}$\;
%     \While{$Q$ is not empty}{
%         Let $a^\ell=dequeue(Q)$ \tcc*{ $a$ is unmatched}
%         \If {$\ell<\T$ \label{alg:all2lq} } { 
%             \If{ $a^\ell$ has not exhausted $\prefslqa$}{
%                 Let $b$ be the most preferred unproposed vertex by $a^\ell$ in $\prefslqa$ \;
%                 \textbf{if} $b$ is unmatched \textbf{then} $M=M\cup \{(a^\ell,b)\}$\;
%                 \Else{
%                     Let $a_j^y= M(b)$\;
%                     \If{($\ell>y$) or ($\ell==y$ and $a\succ_b a_j$)}{
%                     $M=M\setminus \{(a_j^y,b)\}\cup \{(a^\ell,b)\}$ and add $a_j^y$ to $Q$} \label{dec:st2}
%                 }
%             }
%             \Else{$\ell=\ell+1$ and add $a^\ell$ to $Q$\;}
%         }
%         \uElseIf{$\ell==\T$ or $\ell=\T^*$}{  
%          \If{there exists a marked/unproposed vertex by $a^\ell$ in $\prefa$}{   
%            $b=$\favnbr{$a^\ell,\prefa$}\; 
%             \textbf{if} $b$ is marked by $a$ previously \textbf{then} $a$ unmarks it\;
%             \textbf{if} $b$ is unmatched \textbf{then} $M=M\cup \{(a^\ell,b)\}$\;
%             \uElseIf{$b$ is matched and is part of an uncertain proposal $(a_j^y,b)$}{$M=(M\setminus \{(a_j^y,b)\}) \cup \{(a^\ell,b)\}$, $b$ is marked by $a_j$ and $a_j^y$ is added to $Q$}
%             \uElseIf{$b$ is matched and is not part of an uncertain proposal}{
%                 Let $a_j^y= M(b)$\;
%                 \If{$\ell==\T$}{                   
%                     \If{($\ell>y$) or ($y==\T$ and $a\succ_b a_j$)}{
%                     $M=M\setminus \{(a_j^y,b)\}\cup \{(a^\ell,b)\}$ and add $a_j^y$ to $Q$\;}
%                 }
%                 \If{$\ell==\T^*$}{                   
%                     \If{($y< \T$) or ($\ell==y$ and $a\succ_b a_j$) or ($y== \T$ and $a =_b a_j$)}{
%                     $M=M\setminus \{(a_j^y,b)\}\cup \{(a^\ell,b)\}$ and add $a_j^y$ to $Q$\;}
%                 }
                
%                 }
%             }
%             \Else{
%                 \textbf{if} $\ell==\T$ \textbf{then} $\ell=\T^*$\;
%                 \textbf{if} $\ell==\T^*$ \textit{and} $a$ is deficient \textbf{then} $\ell=\T+1$\;
%             }
%         } 
%         \Else{
%             \If{$a^\ell$ has not exhausted $\prefsa$}{
%                 Let $b=$ the most preferred unproposed vertex by $a^\ell$ in $\prefsa$\;
%                 \textbf{if} $b$ is unmatched \textbf{then} $M=M\cup \{(a^\ell,b)\}$\;
%                 \Else{
%                     Let $a_j^y= M(b)$\;
%                     \If{($\ell>y$) or ($\ell==y$ and $a\succ_b a_j$)}{
%                     $M=M\setminus \{(a_j^y,b)\}\cup \{(a^\ell,b)\}$ and add $a_j^y$ to $Q$}
%                 }
%             }
%             \Else{ 
%                 \If{$\ell<\S+\T$ and $a$ is deficient \label{alg:lq}}{$\ell=\ell+1$ and add $a^\ell$ to $Q$ \label{alg:lq1}\;}
%                  }
%         }
%     }
%     \Return $M$
% \end{algorithm}

