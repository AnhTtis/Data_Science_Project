\newpage
\section{Generalised Kir{\'a}ly's algorithm}\label{append:kiralyMM}
The pseudocode for the adaptation of the Kir{\'a}ly's algorithm~\cite{Kiraly13} to the many-to-many setting is given in Algorithm~\ref{algo:23stableMM}. As mentioned earlier, each vertex $a\in \AA$ proposes to its neighbors until the vertex $a$ is either fully subscribed or has proposed with the $*$ status to all vertices in its preference list. Throughout the algorithm, we use $|M(a)|$ to denote the number of vertices matched to $a$ and $a^*$ combined. During the course of the algorithm, a vertex $a$ can propose $b$ at most three times -- at most two times without $*$ status and at most once with $*$ status. Line~\ref{alg1:upgrade} in Algorithm~\ref{algo:23stableMM} ensures that a vertex $a$ is matched to $b$ at most once. Once a vertex $b\in\BB$ is fully subscribed, it remains fully subscribed throughout the algorithm. Subsequently, for $b$ to receive a proposal from some vertex $a$, the vertex $b$ must be the favorite neighbor of $a$. By the definition of favorite neighbor (Definition~\ref{def:favNbr}), it implies that if $b$ receives a proposal from a vertex $a$, then there does not exist any other neighbor $b'$ at the \emph{same} rank of $b$ for the vertex $a$ such that $b'$ is under-subscribed. Thus, during the course of the algorithm, once a vertex $b$ is fully subscribed, no subsequent proposal to $b$ can be labelled uncertain. We record this as the following observation.


\begin{observation}\label{obs:fullNotuncertain}
Let $b\in\BB$ become fully subscribed at time $t$ during the course of Algorithm~\ref{algo:23stableMM}. Then, after time $t$, no proposal to the vertex $b$ can be labelled as uncertain.
\end{observation}

% During the course of our algorithm, let $M(b)$ for a vertex $b\in \BB$ denote the set of matched partners of $b$ with respect to the current matching $M$. Whenever $b$ receives a proposal from a vertex, say $a$, after $b$ is fully subscribed,  we compare $a$ with some least preferred partners in the set $M(b)$ to decide whether $b$ should accept or reject the proposal by $a$. Therefore, we need to identify the least preferred partners in the set $M(b)$. Note that some vertices in $M(b)$  may have the 
% $*$ status, whereas others may not have the $*$ status.
% %Vertex $b$ prefers a lower-ranked neighbor in $M(b)$ over any higher ranked neighbor in $M(b)$ irrespective of star status of the two vertices. Amongst two vertices having the same rank in $b$'s preference list, 
% %the vertex $b$ prefers a star status neighbor over another neighbor without a star status.  
% Let $j$ be the rank of the highest-ranked neighbor in $M(b)$ for the vertex $b$. If there exists a vertex in $M(b)$ at rank $j$ without $*$ status, then all such vertices are the least preferred partners of $b$. Otherwise (all vertices in $M(b)$ at rank $j$ have star status), all vertices at rank $j$ are the least preferred partners of $b$.

% %Let us assume that vertices $a$ and $\Bar{a}$ are at ranks $i$ and $j$ respectively in $\prefb$. As mentioned earlier, $b$ prefers $a^*$ over a vertex $\Bar{a}$ (vertex $\Bar{a}$ without $*$ status) if and only if $i\le j$. Thus, for any particular rank, say $j$, w.r.t. $\prefb$, we order all the vertices at rank $j$ in $M(b)$ in a way that all $*$  status vertices at rank $j$ are preferred over all vertices at rank $j$ which are without $*$ status. Therefore, the term \textit{lowest preferred} in Algorithm~\ref{algo:23stableMM} refers to the following vertex $\Bar{a}$. Let $a'$ be one of the lowest preferred partners in $M(b)$ and $a'$ is at rank $j$ in $\prefb$. 
% %\begin{itemize}
%  %   \item If there exists $a''\in M(b)$ at rank $j$ in $\prefb$ such that $a''$ is without $*$ status then $\Bar{a}$ refers to any such vertex $a''$.
%   %  \item If all $a'\in M(b)$ at rank $j$ in $\prefb$ are with $*$ status then $\Bar{a}$ refers to any such vertex $a''$.
% %\end{itemize}

\begin{algorithm}
    \caption{$3/2$-approximation of maximum size stable matching in $G = (\AA \cup \BB, E)$ }\label{algo:23stableMM}
    \DontPrintSemicolon
    \SetAlgoLined
    Set $M=\emptyset$, initialize a queue $Q=\{a\ :\ a\in \AA\}$, each $a\in \AA$ unmarks all $b\in \prefa$\;
    
    \While{$Q$ is not empty}{
        let $a=dequeue(Q)$\tcp*{$a$ can be with or without $*$ status}
        \If{$a$ is not with $*$ status}{
            \If{there exists a vertex in $\prefa$ which is marked/unproposed by $a$% has not proposed to all vertices 
            }{
                let $b$ be the favorite neighbor of $a$ at some rank, say $k$\; 
                label uncertain proposals from $a$, if any, at rank $k-1$ as `not uncertain'\;
                \textbf{if} $b$ was marked by $a$ \textbf{then} $a$ unmarks $b$\;
                $a$ proposes to $b$\;
                \If {$b$ is under-subscribed}{
                    $M=M\cup \{(a,b)\}$\;
                    \If{ $\exists\ b'\not= b$ at rank $k$ in $\prefa$ with $|M(b')|<q^+(b')$ and $b'$ is unproposed by $a$}{
                    label $(a,b)$ as an uncertain proposal\tcp*{the first proposal by $a$ to $b$}}
                    }
                \Else{ %b is fully subscribed
                    \If {$\exists \ a'\in M(b)$ such that $(a',b)$ is uncertain}{
                        % Let $a''$ be one of such $a'\in M(b)$\; 
                        $M=(M\setminus \{(a',b)\}) \cup \{(a,b)\}$\;
                        $a'$ marks $b$ \label{alg1:mark}\;
                        add $a'$ to $Q$ if $a'\notin Q$
                    }
                    \Else{%no proposal to $b$ is uncertain and b is fully subscribed
                        let $a'$ be one of the \textit{least preferred} partners in $M(b)$\;
                        \If {$a\succ_b a'$}
                        {
                            $M=(M\setminus \{(a',b)\}) \cup \{(a,b)\}$\;
                            add $a'$ to $Q$ if $a'\notin Q$
                        }
                    }
                }
                \textbf{if} $|M(a)|< q^+(a)$ and $a\notin Q$ \textbf{then} add $a$ to $Q$\label{alg1:underSubA11}\;
        }
        \textbf{else}  add $a^*$ to $Q$ if $a\notin Q$ \tcp*{$a^*$ proposes from the begining of $\prefa$}
        }
        \Else
        {
            \If{$a^*$ has not proposed to all vertices in $\prefa$}{
            let $b$ be the favorite neighbor of $a^*$\;
            \If{$a\in M(b)$}{$M=(M\setminus\{(a,b)\})\cup \{(a^*,b)\}$ \label{alg1:upgrade}\;}
            \Else{
                $a^*$ proposes to $b$ \tcp*{$b$ is full \& no proposal to $b$ is labelled uncertain}
                % no proposal to b can be uncertain at this moment
                let $a'$ be one of the \textit{least preferred} partners in $M(b)$ \;
                \If{$a =_b a'$ and $a'$ is without $*$ status } 
                {
                    $M=(M\setminus \{(a',b)\}) \cup \{(a^*,b)\}$ and add $a'$ to $Q$ if $a'\notin Q$\;
                }
            }
            \textbf{if} $|M(a)|< q^+(a)$ and $a\notin Q$ \textbf{then} add $a^*$ to $Q$ \label{alg1:underSubA12}\;}
        }
}
return $M$\;
\end{algorithm}




% \begin{algorithm}
%     \caption{$3/2$-approximation stable matching in $G = (\AA \cup \BB, E)$ }\label{algo:23stableMM}
%     \DontPrintSemicolon
%     \SetAlgoLined
%     Set $M=\emptyset$, initialize a queue $Q=\{a\ :\ a\in \AA\}$\;
    
%     \While{$Q$ is not empty}{
%         Let $a=dequeue(Q)$\tcc*{$a$ can be with or without $*$ status}
%         \If{$a$ is not with $*$ status}{
%             \If{$a$ has not exhausted $\prefa$}{
%                 Let $b$ be the favorite neighbor of $a$ at some rank, say $k$, in $\prefa$\;
               
%                 \If{$\exists \ b'$ at rank $k-1$ in $\prefa$ such that $(a,b')$ is an uncertain proposal}{Label all such uncertain proposals involving $a$ as `not uncertain'}
                
%                 \textbf{if} $b$ was marked by $a$ \textbf{then} $a$ unmarks $b$\;
%                 $a$ proposes to $b$\;
%                 \If {$b$ is under-subscribed}{
%                     $M=M\cup \{(a,b)\}$\;
%                     \If{ $\exists\ b'\not= b$ at rank $k$ in $\prefa$ with $|M(b')|<q^+(b')$ and $b'$ is unproposed by $a$}{
%                     Label $(a,b)$ as an uncertain proposal\tcc*{the first proposal by $a$ to $b$}}
%                     }
%                 \Else{ %b is fully subscribed
%                     \If {$\exists \ a'\in M(b)$ such that $(a',b)$ is uncertain}{
%                         Let $a''$ be one of such $a'\in M(b)$\; 
%                         $M=(M\setminus \{(a'',b)\}) \cup \{(a,b)\}$\;
%                         $a''$ marks $b$ \label{alg1:mark}\;
%                         add $a''$ to $Q$ if $a''\notin Q$
%                     }
%                     \Else{%no proposal to $b$ is uncertain and b is fully subscribed
%                         Let $a'$ be one of the lowest preferred partners in $M(b)$ and $a'$ is at rank $j$ in $\prefb$\;
%                         \If {$\exists \ a''\in M(b)$ at rank $j$ in $\prefb$ such that $a''$ is without $*$ status }{
%                             Let $\Bar{a}$ be one of such $a''$\;
%                         }
%                         \uElseIf {all $a''\in M(b)$ at rank $j$ in $\prefb$ are with $*$ status }{
%                             Let $\Bar{a}$ be one of such $a''$\;
%                         }
%                         \If {$a\succ_b \Bar{a}$}
%                         {
%                             $M=(M\setminus \{(\Bar{a},b)\}) \cup \{(a,b)\}$\;
%                             add $\Bar{a}$ to $Q$ if $\Bar{a}\notin Q$
%                         }
%                     }
%                 }
%                 \textbf{if} $|M(a)|< q^+(a)$ and $a\notin Q$ \textbf{then} add $a$ to $Q$\label{alg1:underSubA11}\;
%         }
%         \textbf{else if}  $a\notin Q$ \textbf{then} add $a^*$ to $Q$ \tcc*{$a^*$ proposes from the begining of $\prefa$}
%         }
%         \Else
%         {
%             \If{$a^*$ has not exhausted $\prefa$}{
%             Let $b$ be the favorite neighbor of $a^*$\;
%             \If{$a\in M(b)$}{$M=(M\setminus\{(a,b)\})\cup \{(a^*,b)\}$ \;}
%             \Else{
%                 $a^*$ proposes to $b$ \tcc*{$b$ is full \& no proposal to $b$ is labelled uncertain}
%                 % no proposal to b can be uncertain at this moment
%                 Let $a'$ be one of the lowest preferred partners in $M(b)$ and $a'$ is at rank $j$ in $\prefb$\;
%                 \If{$a \succ_b a'$ \textbf{and} $\exists \ a''\in M(b)$ at rank $j$ in $\prefb$ such that $a''$ is without $*$ status }
%                 {
%                     $M=(M\setminus \{(a'',b)\}) \cup \{(a^*,b)\}$ and  add $a''$ to $Q$ if $a''\notin Q$\;
%                 }
%                 \uElseIf{$a \succ_b a'$ \textbf{and} all $a''\in M(b)$ at rank $j$ in $\prefb$ are with $*$ status }
%                 {
%                     $M=(M\setminus \{(a',b)\}) \cup \{(a^*,b)\}$ and add $a'$ to $Q$ if $a''\notin Q$\;
%                 }
%             }
%             \textbf{if} $|M(a)|< q^+(a)$ and $a\notin Q$ \textbf{then} add $a^*$ to $Q$ \label{alg1:underSubA12}\;}
%         }
% }
% Return $M$\;
% \end{algorithm}



\subsection{Correctness of the generalised  Kir{\'a}ly's algorithm}\label{sec:GenKiralyCorr}
To show the correctness, we prove that the matching $M$ output by Algorithm~\ref{algo:23stableMM} is stable and is a $\frac{3}{2}$-approximation to the maximum size stable matching in $G$.




\begin{lemma}\label{lem:stableAlgo2}
The matching $M$ output by Algorithm~\ref{algo:23stableMM} is stable.
\end{lemma}
\begin{proof}
Assume for contradiction that $(a,b)$ is a blocking pair w.r.t. $M$. We consider three cases:
\begin{itemize}
    \item \textbf{$b$ is under-subscribed:} Clearly, $b$ did not receive enough proposals. This implies that $a$ did not propose to $b$. This further implies that $a$ is fully subscribed before proposing to $b$. Hence, $a$ does not strictly prefer $b$ over any matched partners in $M(a)$. This contradicts that $(a,b)$ is a blocking pair.
    
    \item \textbf{$a$ is under-subscribed:} Each time $a$ is under-subscribed, it is added to the queue (see Line~\ref{alg1:underSubA11} and Line~\ref{alg1:underSubA12} of Algorithm~\ref{algo:23stableMM}). It proposes again until it exhausts all the vertices in $\prefa$ with $*$ status or it is fully subscribed. Since $a$ remains under-subscribed, we conclude that $a$ proposed to all vertices in its preference list with the $*$ status. Thus, $a^*$ proposed to $b$ and $b$ rejected $a^*$. This implies that when $a^*$ proposes to $b$, $b$ was fully subscribed with all $a'\in M(b)$ at least as good as $a^*$, and $b$ was not part of any uncertain proposal. This further implies that $a^*$ is not strictly better preferred than any $a'\in M(b)$ at the time when $b$ rejected the proposal from $a^*$. By Observation~\ref{obs:fullNotuncertain}, no proposal to $b$ is labelled uncertain after $b$ is fully subscribed. Since $b$ was not part of any uncertain proposal when it rejected $a^*$, and no proposal to $b$ was labelled uncertain afterwards, $b$ does not accept proposals from lower-preferred vertices than $a$. Thus, $a$ is not strictly better than any $a'\in M(b)$. This contradicts our assumption that $(a,b)$ is a blocking pair.

    \item \textbf{$a$ and $b$ both are fully subscribed:} Since $(a,b)$ is a blocking pair, $a$ must strictly prefer $b$ over some $b'\in M(a)$. This implies $a$ proposed to $b$ before proposing to $b'$. This further implies that $b$ rejected the proposal from $a$. Suppose $b$ rejected $a$ because $b$ is fully subscribed with all the partners as good as $a$ and no partner $a'\in M(b)$ is such that the proposal $(a',b)$ is uncertain. Then, by Observation~\ref{obs:fullNotuncertain}, no proposal to $b$ was labelled uncertain. Since the partners of $b$ do not get worse, $(a,b)$ is not a blocking pair. So, let us assume that $a$ was rejected by $b$ because $(a,b)$ was an uncertain proposal, $b$ was fully subscribed, and $b$ received a proposal from some $a'$.  But, in this case, by the design of the algorithm, $a$ marked $b$ (see Line~\ref{alg1:mark} of Algorithm~\ref{algo:23stableMM}). Since $b'$ is strictly lower preferred than $b$, $a$ must propose to $b$ again before proposing to $b'$ (recall Definition~\ref{def:favNbr}). Also note that when $a$ proposes to $b$ again, the proposal $(a,b)$ is not uncertain as this is not the first proposal to $b$ by $a$. The fact that $b$ rejected $a$  again implies that $b$ was not part of any uncertain proposal when it rejected $a$, and all the partners of $b$ were at least as good as $a$. By Observation~\ref{obs:fullNotuncertain}, no proposal to $b$ was labelled uncertain afterwards; hence, it is not matched to any lower-preferred partner than $a$. Thus, all the partners of $b$ are at least as good as $a$. This is a contradiction that $(a,b)$ is a blocking pair.
\end{itemize}
Thus, the matching $M$ output by Algorithm~\ref{algo:23stableMM} is stable.
\end{proof}

\begin{lemma}\label{lem:23stable}
Let $M$ be the output of Algorithm~\ref{algo:23stableMM} for an instance $G$ and $M_{opt}$ is a maximum size stable matching in $G$ then $|M_{opt}|\le \frac{3}{2}\cdot |M|$.
\end{lemma}

\begin{proof}
    We prove this by showing no 1-length augmenting path\footnote{A 1-length augmenting path w.r.t. $M$ is an edge $(a,b)\notin M$ such that both $a$ and $b$ are under-subscribed in $M$.} or a 3-length augmenting path\footnote{A 3-length augmenting path w.r.t. $M$ is a 3-length path $\langle a',b,a,b'\rangle$ such that $(a,b)\in M$, $(a',b), (a,b')\notin M$ and both $a'$ and $b'$ are under-subscribed in $M$.} exists w.r.t. $M$ in $M_{opt}\oplus M$. Since the matching is stable, it is clear that there does not exist any 1-length augmenting path w.r.t. $M$ in $M_{opt}\oplus M$. Thus, we need to show that there is no 3-length augmenting path w.r.t. $M$ in $M_{opt}\oplus M$. 
    
    Suppose for contradiction that there is a 3-length augmenting path $\langle a_1, b, a, b_1\rangle$ such that $(a,b)\in M$ and the other two edges are in $M_{opt}$.    Clearly, $a_1$ remains under-subscribed in $M$ at the end of the algorithm. This implies that the proposal of $a_1^*$ was rejected by $b$. This further implies that $b$ is fully subscribed, and there is no uncertain proposal involving $b$ when $b$ rejected $a_1^*$. By Observation~\ref{obs:fullNotuncertain}, no proposal to $b$ is labelled uncertain afterwards. Also, note that $b_1$ is under-subscribed in $M$ and $(a,b_1)\notin M$. This implies that $a$ never proposed $b_1$, which further implies that $a$ did not exhaust proposing all vertices in $\prefa$ even without $*$ status. Therefore, $a$ did not achieve the $*$ status during the course of our algorithm. Since $b$ rejected $a_1^*$, we conclude that $a\succ_b a_1$, that is, $b$ ranks $a$ strictly better than $a_1$ in $\prefb$.

    Since $a$ did not propose $b_1$ during the course of Algorithm~\ref{algo:23stableMM}, $a$ is full even before proposing to $b_1$. This further implies that $b_1\not\succ_a b$, that is, $a$ ranks $b$ either strictly better than $b_1$ or at the same rank as $b_1$. Thus, $b \succeq_a b_1$. Now, we show that $b\succ_a b_1$. This immediately contradicts the stability of $M_{opt}$. 
    
    Suppose $b_1=_a b$ such that $b$ and $b_1$ are at $k^{th}$ rank in $\prefa$. Since $a$ is matched to a $k^{th}$-rank neighbor $b$ and an unproposed under-subscribed neighbor $b_1$ exists at the same rank $k$,  the proposal $(a,b)$ is labelled uncertain. Note that $a$ did not propose to any $(k+1)^{th}$-rank neighbor during the course of the algorithm because at least one $k^{th}$-rank neighbor $b_1$ remains unproposed by $a$ at the end of the algorithm. We consider the following two cases based on who among $a_1^*$ and $a$ proposed $b$ first.

\vspace{0.1in}

    \noindent\textbf{$a_1^*$ proposes to $b$ before $a$ proposes to $b$:} As the proposal from $a_1^*$ to $b$ is not the first proposal from $a_1$ to $b$, the proposal $(a_1^*,b)$ cannot be labelled uncertain. Three things can happen when $b$ receives the proposal from $a_1^*$ -- $(i)$ $b$ rejects $a_1^*$, $(ii)$ $b$ accepts $a_1^*$ and is fully subscribed and $(iii)$ $b$ accepts $a_1^*$ and is under-subscribed.  In the first two scenarios, $b$ cannot be the favorite neighbor of $a$ until $b'$ is proposed by $a$. So, $a$ must propose $b_1$ before $a$ proposes $b$. The fact that $(a,b)\in M$, $a$ must have proposed to $b$, which implies $a$ also proposed to $b_1$. Since $b_1$ is under-subscribed, $b_1$ accepts $a$, and hence, $(a,b_1)\in M$ -- a contradiction. In $(iii)$, the proposal, $(a,b)$ is labelled as an uncertain proposal because $b_1$ is under-subscribed and is unproposed by $a$. Since the proposal $(a_1^*,b)$ is not uncertain and $(a,b)$ is uncertain, $b$ must reject $a$ before rejecting $a_1^*$. The fact that $(a_1^*,b)\notin M$ implies that $b$ rejected $a_1^*$ and thus it also rejected $a$. Now, $a$ must propose $b_1$ before proposing to $b$. The fact that $(a,b)\in M$ implies that $a$ proposed to $b$ again, and hence it proposed to $b_1$.  Since $b_1$ is under-subscribed, $b_1$ accepts $a$, and $(a,b_1)\in M$ -- a contradiction.
    

\vspace{0.1in}

     \noindent\textbf{$a$ proposes to $b$ before $a_1^*$ proposes to $b$:} The proposal $(a,b)$ is an uncertain proposal because $b_1$ is under-subscribed and is unproposed by $a$.  The fact that $(a_1,b)\not\in M$ implies $b$ rejected $a_1^*$ ($a_1^*$ must have proposed to $b$ as it remained under-subscribed in $M$). But $(a_1^*,b)$ is not an uncertain proposal. Thus, $b$ must reject $a$ before rejecting $a_1^*$. The fact that $(a_1^*,b)\notin M$ implies that $b$ rejected $a_1^*$ and thus it also rejected $a$. Now, $a$ must propose $b_1$ before proposing to $b$. The fact that $(a,b)\in M$ implies that $a$ proposed to $b$ again, and hence it proposed to $b_1$.  Since $b_1$ is under-subscribed, $b_1$ accepts $a$, and $(a,b_1)\in M$ -- a contradiction.
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \begin{algorithm}
%     \caption{$3/2$-approximation stable matching in $G = (\AA \cup \BB, E)$ }\label{algo:23stableMMold}
%     \DontPrintSemicolon
%     \SetAlgoLined
%     Set $M=\emptyset$, initialize a queue $Q=\{a\ :\ a\in \AA\}$\;
    
%     \While{$Q$ is not empty}{
%         let $a=dequeue(Q)$\tcc*{$a$ can be with/without $*$ status}
%             \If{$a$ has not exhausted $\prefa$}{
%                 let $b$ be the favorite neighbor of $a$ in $\prefa$ at some rank, say $k$\;
%                 \textbf{if} $a$ is with $*$ status and $a\in M(b)$ \textbf{then} $M=(M\setminus\{(a,b)\})\cup \{(a^*,b)\}$ and \textbf{continue}\;
%                 % make all such uncertain proposals as `not uncertain'\;
%                 \If{$\exists \ b'$ such that $(a,b')$ is uncertain proposal and $b'$ is $(k-1)^{th}$ rank neighbor in $\prefa$}{make all such uncertain proposals as `not uncertain'}
                
%                 \textbf{if} $b$ was marked by $a$ \textbf{then} $a$ unmarks $b$\;
%                 $a$ proposes to $b$\;
%                 \If {$b$ is under-subscribed}{$M=M\cup \{(a,b)\}$\;
%                 \If{ there exists an under-subscribed $b''$ at rank $k$ which is unproposed by $a$ in $\prefa$ and $a$ never proposed to $b$ earlier with/without $*$ status}{
%                     set $(a,b)$ as uncertain proposal}
%                     }
                
%         % \Else(\tcc*[h]{$b$ is fully subscribed}){
%         \Else{
%             \If {$\exists \ a'\in M(b)$ such that $(a',b)$ is uncertain}{
%                 let $a''$ be the highest indexed agent in $\prefb$ among all such $a'\in M(b)$\; 
%                 $M=(M\setminus \{(a'',b)\}) \cup \{(a,b)\}$\;
%                 $a''$ marks $b$ \label{alg1:marking}\;
%                 add $a''$ to $Q$ if $a''\notin Q$}
%             \uElseIf {%no proposal to $b$ is uncertain and 
%             $\exists\ a'\in M(b)$ such that $a'\prec_b a$}{
%                 let $a''$ be the highest indexed agent amongst lowest preferred partners in $M(b)$\;
%                 $M=(M\setminus \{(a'',b)\}) \cup \{(a,b)\}$\;
%                 add $a''$ to $Q$ if $a''\notin Q$}
%         %         \Else{add $a$ to $Q$ if $a\notin Q$}
%         % % }
%         }
%         \If{$|M(a)|< q^+(a)$ and $a\notin Q$\label{alg1:underSubA21}}{add $a$ to $Q$\label{alg1:underSubA22}\;}}
%         \Else{
%             \If{$a$ is not with $*$ status}{
%                 $a$ achieves $*$ status\;
%                 add $a^*$ to $Q$ \tcc*{$a^*$ proposes from the begining of $\prefa$}}
%         }
% }
% \end{algorithm}


