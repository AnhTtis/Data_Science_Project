\section{Motion Averaging}
\label{sec:motavg}
In this section, we propose a method for motion averaging by leveraging novel definitions of averages on the flag manifold. This will also act as a good example of how to use flag manifolds for performing computations on other groups. To this end, we now define the group of $3$D rotations and translations, $SE(3)$. Then we outline how to navigate between points on $SE(3)$ and points on a flag. Finally, we describe our \emph{motion averaging on flag manifolds}. 

\begin{dfn}[3D motion]
The configuration (position and orientation) of a rigid body moving in free space can be described by a homogeneous transformation matrix $\M$ corresponding to the displacement from any inertial reference frame to another. The set of all such rigid body transformations in three-dimensions form the $SE(3)$ group:
\begin{equation}
\label{eq:se3}
SE(3) = \left \{\bm{\gamma}:=
\begin{bmatrix} 
\Rot & \tb \\ 
\zero^\top & 1 
\end{bmatrix}\,:\, \Rot\in SO(3) \,\mathrm{\,and\,}\, \tb\in\R^3
\right\},\nonumber
\end{equation}
where $\tb$ denotes a \emph{translation} (positional displacement) and $\Rot$ captures the angular displacements as an element of the special orthogonal group $SO(3)$:
\begin{equation}
\label{eq:so3}
SO(3) = \left \{
\Rot \in \R^{3\times 3} \colon \Rot^\top\Rot = \Id \,\wedge\, \det \Rot = 1
\right\}.
\end{equation}
\end{dfn}

\begin{prop}[Motion contraction~\cite{ozyesil2018synchronization}]\label{prop:se3so4} We call \\ $\Phi_{\lambda}:SE(3)\to SO(4)$ a \emph{Saletan contraction}, \ie $\Phi_{\lambda}(\bm{\gamma}) = \U \V^T$ where the left ($\U$) \& right ($\V$) singular vectors are obtained via the singular value decomposition:
\begin{equation}
\U \bm{\Sigma} \V^T = \begin{bmatrix} \Rot & \tb/\lambda  \\ 
\zero^\top & 1 \end{bmatrix} \text{ \emph{for} } \bm{\gamma} \in SE(3).
\end{equation}
\end{prop}

\begin{prop}[Inverse motion contraction~\cite{ozyesil2018synchronization}]\label{prop:so4tose3}
We call the inverse contraction map $\Phi_{\lambda}^{-1}: SO(4)\to SE(3)$. Let $\mathbf{M} \in SO(4)$, then $\bm{\gamma} = \Phi_{\lambda}^{-1}(\mathbf{M})$ where
\begin{align}
    \tb &=  \frac{2\lambda}{\mathbf{M}_{4,4}}\mathbf{M}_{1:3,4},\\
    \Rot &= \begin{cases}
    \mathbf{M}_{1:k, 1:k}, & 
\| \tb \|_2 < \epsilon\\
    \left( \mathbf{M}_{4,4}\frac{\tb \tb^T}{\| \tb\|_2^2} +  \mathbf{P'} \right)^{-1} \mathbf{M}_{1:k,1:k}, & \mathrm{o.w.}
    \end{cases},
\end{align}
and $\U \bf{\Sigma} \V^T = \tb^T$ is the SVD and $\mathbf{P'} = \V_{:,2:4}\V_{:,2:4}^T$.


    
    
\end{prop}

\input{content/alg_motionavg.tex}

\begin{prop}[Flag representation of motion~\cite{selig2005study}]\label{prop:so4flag}







Any contracted motion $\mathbf{M} \in SO(4)$ can be represented as a point on the flag, $[[\X]] \in \flag^+(1,2,3;4)$ as the first $3$ columns of $\mathbf{M}$. Namely, $[[\X]]$ is
\begin{equation}\label{eq: x flag def}
 \left[\mathbf{m_1}\right] \subset \left[\mathbf{m_1}, \mathbf{m_2}\right] \subset \left[\mathbf{m_1}, \mathbf{m_2}, \mathbf{m_3} \right] \subset \R^4.
\end{equation}
\end{prop}
\begin{remark}
Note that the elements of the group of rigid body motions, $SE(3)$, which we represent by points on $SO(4)$, can be imagined as the points of a six-dimensional quadric in seven-dimensional projective space, $\mathbb{P}^7$, called the \emph{Study quadric}~\cite{selig2005study}. The well known dual quaternions are the very coordinates of this space. Such a bijection between $\mathbb{P}^{7}$ and $SO(4)$~\cite{nawratil2016fundamentals} is the reason why our free parameter $\lambda$ resembles the \emph{dual unit} $\varepsilon$ in dual quaternions~\cite{selig2005study,ablamowicz2004lectures,busam2016_iccvw}. 
Moreover, our flag manifold, $\flag^+(1,2,3;4)$ is homeomorphic to $SO(4)$. We leave the investigation of these deeper connections to future work.
\end{remark}

\begin{prop}[Motion representation of a flag \cite{selig2005study}]\label{prop:FLtoSO4}
Given $[[\X]] \in \flag^+(1,2,3;4)$ with the same basis vectors from~\cref{prop:so4flag}, the corresponding point on $SO(4)$ is:
\begin{equation}
\left[ \m_1, \m_2, \m_3, \frac{\hat{\z}}{\|\hat{\z}\|_2} \right] \in SO(4),
\end{equation}
where the fourth vector $\hat{\z}$ is obtained by 
\begin{equation}
    \mathbf{\hat{z}} = \left( \I - [\mathbf{m_1}, \mathbf{m_2}, \mathbf{m_3}]^T [\mathbf{m_1}, \mathbf{m_2}, \mathbf{m_3}] \right) \mathbf{z}.
\end{equation}

\end{prop}











\begin{figure}[t]
    \includegraphics[width=\linewidth]{figures/flagmeancompare.pdf}
    \caption{$100$ points from a synthetic data set on $\flag(1,3;10)$. The vertical axis is the chordal distance on $\flag(1,3;10)$ between the predicted averages and the ``center'' of the data set.}
    \label{fig:flagmeancompare}
\end{figure}

\subsection{Single Motion Averaging}
With these constructs, we are now ready to formally define the motion averaging problem for points on $SE(3)$.\vspace{0mm}
\begin{dfn}%
Given a set of motions $\{\bm{\gamma}_i\in SE(3)\}_{i=1}^p$, the centroid is defined to be the solution of the following optimization procedure:
\begin{equation}
    \bm{\gamma}^* = \argmin_{\bm{\gamma}\in SE(3)} \sum_{i=1}^p \alpha_i \|\bm{\gamma}_i - \bm{\gamma}\|^q_F
    \label{eq:motavg}
\end{equation}
where $q=2$ for mean estimation, $q=1$ for the median and $\alpha_i\in\mathbb{R}$ denote the individual weights.
\end{dfn}
To solve~\cref{eq:motavg}, we simply map each $\bm{\gamma}_i\in SE(3)$ to $\X^{(i)} \in FL(1,2,3;4)^+$. To this end, we first map each $\bm{\gamma}_i$ to $\phi_{\lambda}(\bm{\gamma}_i) = \M_i \in SO(4)$ via~\cref{prop:se3so4} and subsequently use~\cref{prop:so4flag} to represent $\M_i$ as %
$[[\X^{(i)}]] \in FL(1,2,3;4)^+$. Then we use our flag-mean ($q=2$) or -median algorithm ($q=1$) to solve
\begin{equation}
    [[\Y^*]] = \argmin_{[[\Y]]\in FL(1,2,3;4)^+} \sum_{i=1}^p \alpha_i d_c([[\X^{(i)}]], [[\Y]])^q
    \label{eq:motavgflag}
\end{equation}
The desired solution $\bm{\gamma}^*\in SE(3)$ is then obtained by first mapping $[[\Y^*]]$ back to $\M^*\in SO(4)$ via~\cref{prop:FLtoSO4} and subsequently using $\bm{\gamma}^* = \phi_{\lambda}^{-1}(\M^*)$ by~\cref{prop:so4tose3}. We present this chordal Flag motion averaging in~\cref{alg:motionavg}. %


