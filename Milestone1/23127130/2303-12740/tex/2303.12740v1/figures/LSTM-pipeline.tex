\def\bgcolor{white}
\def\boxcolor{black!35}

\begin{tikzpicture}[
    mynode/.style={draw, rectangle, rounded corners, align=center, text centered, minimum height=1cm, fill=\bgcolor},
    mybox/.style={dashed, ultra thick, rounded corners, color=\boxcolor},
    node distance=1.5cm
]
    \def\dy{1.5}
    
    %\draw (0,0) rectangle (+.25,+.25) node {$x$};
    %\draw[rounded corners] (0,0) rectangle (+2,+4);
    \node   () [mynode, text width=1.3cm] at (-.2,+.2) {};
    \node  (0) [mynode, text width=1.3cm, label={[yshift=.2cm]}] at (-.1,+.1) {};
    \node  (1) [mynode, text width=1.3cm] at (0, 0) {Sensor data};
    \node  (2) [right=of 1, mynode, text width=1.8cm] {Normalised Sequence Input\\ on $(\mu, \sigma)$};
    \node  (3) [right=of 2, mynode, label={[align=center, text width=1.5cm]$\nhid$ hidden units}] {LSTM};
    \node  (4) [right=of 3, mynode] {SLP};
    \node (5a) [mynode, text width=1.6cm] at ($(4)+(3,+\dy)$) {Predict};
    \node (5b) [mynode, text width=1.6cm] at ($(4)+(3,-\dy)$) {SoftMax};
    \node (6b) [right=of 5b, mynode, text width=1.6cm] {Classify};
    
    \draw[mybox] ($(4)+(.75,.25)$) rectangle ++(7,2);
    \draw[mybox] ($(4)+(.75,-.25)$) rectangle ++(7,-2);
    
    \node[color=\boxcolor] at ($(4)+(.7,.5)+(3.5,0)$) {Prediction Mode};
    \node[color=\boxcolor] at ($(4)+(.7,-.5)+(3.5,0)$) {Classification Mode};
    
    
    \draw[->] (1) -- (2);
    \draw[->] ([yshift=+.3cm]1.east) -- ([yshift=+.3cm]2.west);
    \draw[->] ([yshift=-.3cm]1.east) -- ([yshift=-.3cm]2.west);
    \draw[->] (2) -- node[below]{$\nin$} (3);
    \draw[->] (3) -- node[below]{$\nhid$} (4);
    \draw[->, rounded corners] (4) -- ($(4)+(1,0)$) -- ($(4)+(1,+\dy)$) -- node[below]{$\npred$} (5a);
    \draw[->, rounded corners] (4) -- ($(4)+(1,0)$) -- ($(4)+(1,-\dy)$) -- node[below]{$\nclass$} (5b);
    \draw[->] (5b) -- node[below]{$\nclass$} (6b);
    \draw[->] ([yshift=-.4cm]3.east) to[out=-20,in=-160,looseness=3.5] node[below]{feedback} ([yshift=-.4cm]3.west);
    \draw[->] ([yshift=+.2cm]5a.east) to[out=+20,in=+60,looseness=5] node[above,xshift=-.3cm,yshift=.1cm]{(R)MSE} ([xshift=+.4cm]5a.north);
    \draw[->] ([yshift=-.2cm]6b.east) to[out=-20,in=-60,looseness=5] node[below,xshift=-1.1cm]{$k$-Cross Entropy} ([xshift=+.4cm]6b.south);
\end{tikzpicture}