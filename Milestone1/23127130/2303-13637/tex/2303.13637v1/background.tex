\section{Background and Motivation}\label{sec:background}

\subsection{HRV from ECG}

\begin{figure}
  \centering
  \includegraphics[width=0.8\linewidth]{pic/ecg_rrv3.pdf}
  \caption{An example of ECG waveform showcasing R peaks (red dots) and RR intervals.}
  \label{fig:ecg_rr_example}
\end{figure}

Human heart rate, when measured as beat-to-beat intervals, is not constant and varies over time~\cite{1965-Schneider-HRV}. This variation, commonly known as Heart Rate Variability (HRV), is an effective indicator of various health and mental problems~\cite{2012-Xhyheri-HRVToday}. The traditional medical device to measure HR and HRV is ECG. ECG records heart activity utilizing electrodes placed at certain skin spots on the human body and produces an electrocardiogram, which is a graph that shows the heart's activity over time.
%By analyzing electrocardiograms, doctors can measure how the heart is functioning. 
Electrocardiogram contains the QRS complexes information, which is an important waveform in an electrocardiogram that shows the spread of a stimulus through the ventricles \cite{dohare2014efficient,GOLDBERGER201811}. 
R peaks, which roughly represent heartbeats, can be computed from the QRS complex. The intervals between R peaks are called RR intervals. Figure~\ref{fig:ecg_rr_example} gives an example output from an ECG device that shows the heartbeats and RR intervals. Note that, normal RR intervals are also called NN intervals in the literature~\cite{2012-Xhyheri-HRVToday}.
%More specifically, because the RR interval is the interval between heartbeats, the reciprocal of the RR interval is the HR\cite{LANFRANCHI2011226}.
%Although the ECG produces accurate HRV, attaching electrodes to the human body makes it inconvenient to use.
% ECG can export the RR intervals, which is the elapsed time between two consecutive R waves of the QRS complex.
% And then, we can use the RR intervals to calculate HR and HRV.

%\subsubsection{HR from ECG}
%Usually, ECG devices will come with software that processes the electrocardiogram and exports the RR intervals. 
% Therefore, we can easily calculate the HR based on the reported RR intervals obtained. 
%ECG can export RR intervals accurately. 
%Consequently, in this work, we apply the HR generated from ECG as labels for HR learning models.

HRV is defined as the variation of the RR intervals within a time period. HRV is an important health indicator because it represents the adaptive ability of the heart to unpredictable changing circumstances. There is no one standard or best method to calculate HRV \cite{londhe2019heart}. 
% The HRV measurement is categorized into linear and non-linear methods. 
In this work, we focus on two commonly used time-domain linear measures for HRV - the Standard Deviation of RR intervals (SDNN) and the Root Mean Square of Successive Differences (RMSSD) \cite{kleiger2005heart}. SDNN is usually recommended for overall HRV estimation and represents both sympathetic and parasympathetic modulation of heart rate, whereas RMSSD is recommended for estimating short-term components of HRV and represents parasympathetic activity~\cite{2012-Xhyheri-HRVToday,1996-Euro-HRV-Circulation}. 

An SDNN or RMSSD is calculated from the RR intervals in a chosen time window, which is usually between 0.5 and 5 minutes~\cite{acharya2006heart}, and a sequence of HRVs over 5 minutes to 24 hours are typically used in medical practice~\cite{1996-Euro-HRV-Circulation}.
The definitions of SDNN and RMSSD are,

\begin{equation}
    \label{eq:sdnn}
    \text{SDNN}=\sqrt{\frac{\sum_{i=1}^{N}(RR_i - \overline{RR})^2}{N}},
\end{equation}

\begin{equation}
    \label{eq:rmssd}
    \text{RMSSD}=\sqrt{\frac{\sum_{i=1}^{N-1}(RR_{i+1} - RR_i)^2}{N-1}},
\end{equation}

where $RR_i$ is the $i^{th}$ RR interval, $\overline{RR}$ is the average, and $N$ is the number of RR intervals within the chosen time window.

%Some studies exploited ECG sensors to estimate HRV
Although the ECG produces accurate HRVs, attaching electrodes to the human body can be inconvenient for long-term monitoring~\cite{rajanna2018iot,sutar2013development}. 
%For example, Rajanna et al. implemented a framework to monitor HRV in real-time which collects ECG data in IoT and uploads it to the cloud \cite{rajanna2018iot}. 
%Sutar et al. developed a low-cost embedded system for HRV monitoring using an ECG sensor \cite{sutar2013development}. 
% But they did not focus on how to process the ECG signal to obtain accurate HRV.
Therefore, in this work, we focus on using PPG instead of ECG. %since ECG is hard to implement in daily life and focuses on how to process the PPG data to monitor HRV more accurately. 
Nonetheless, we did use ECG to collect reliable HRV readings as the groundtruth to train and evaluate our PPG-based HRV solutions.

\subsection{HRV from PPG}
PPG sensors are popular due to their non-invasive nature. They
are usually attached to human skins at certain locations, such as fingertips, earlobe, and wrist \cite{castaneda2018review}. These sensors utilize infrared light that penetrates the skin to detect changes in the blood circulation -- if there is a change in the blood flow, the intensity of the infrared light also changes~\cite{schafer2013accurate}. Hence, by monitoring the light changes, PPG sensors can detect blood flow changes, which in turn, can be used to infer HR/HRV. 

The main challenge to using PPG for HR/HRV monitoring is light signal noises, especially the motion artifact (MA), which represents the signal noises due to body/hand movements~\cite{fine2021sources}. There are also noises from the environment~\cite{fine2021sources,castaneda2018review} or from the inherent sensor inaccuracy/bias (e.g., sensor sensitivity and calibration issues). Accurate HR/HRV monitoring requires the removal or reduction of these noises~\cite{zhang2014troika,castaneda2018review}.

\subsection{Motivation}\label{sec:motivation}

% \begin{figure}
%   \centering
%   \input{pic/motivate_mape}
%   %\vspace{-4mm}
%   \caption{HRV estimation errors of the signal-processing-only, CNN-only, MLP-only, and our compound and direct ("Signal+MLP") methods, using the ISPC dataset.}
%   \label{fig:motivation_acc}
%   %\vspace{-4mm}
% \end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.8\linewidth]{pic/mydata_hrv_plot221113_motivation_mape.pdf}
  \caption{HRV estimation errors of the signal-processing-only \cite{zhang2014troika}, CNN-only \cite{everson2019biotranslator}, MLP-only, and our compound and direct ("Sig-proc+MLP") methods, using the ISPC dataset.}
  \label{fig:motivation_acc}
\end{figure}

% the BioTranslater model has 42657 trainable parameters, if each is 32 bits, aka 4 Bytes, then the total is 42657*4/1000 KB = 170.628KB, but our Sig-proc + MLP model only has 7341 parameters, and size is 124KB
% \vspace{-2mm}
\begin{table}
\centering
%\renewcommand{\arraystretch}{1.5}
\begin{tabular}{|c|c|c|c|}
\hline
RR MAPE  & RMSSD MAPE & SDNN MAPE \\ \hline
1\% & 10.24\%  & 4.99\%  \\ \hline
2\% & 27.83\%  & 14.14\% \\ \hline
3\% & 41.55\%  & 23.87\% \\ \hline
4\% & 52.58\%  & 33.19\% \\ \hline
5\% & 61.18\%  & 41.97\% \\ \hline
\end{tabular}
\vspace{2mm}
\caption{RR estimation error amplification after converting to RMSSD and SDNN.}
\vspace{-2mm}
\label{tab:rr_vs_hrv}
\end{table}

\begin{table}[]
\begin{tabular}{|c|c|c|c|}
\hline
HRV   & CNN Only & MLP Only & Sig-proc + MLP \\ \hline
SDNN  & 195KB    & 47.9MB  &  47.9KB   \\ \hline
RMSSD & 195KB    & 122.5MB  &  49.8KB  \\ \hline
\end{tabular}
\vspace{2mm}
\caption{CNN or MLP model sizes of the CNN-only \cite{everson2019biotranslator}, MLP-only, and our compound and direct ("Sig-proc+MLP") methods, using the ISPC dataset. }
\vspace{-2mm}
\label{tab:motivation_size}
\end{table}
Although there have been many studies on applying PPG in HRV inference, these studies were usually limited by their methodology and/or by small datasets. To illustrate these limitations, and as a motivation for this study,  we explored the HRV inference accuracy of a signal-processing-only method~\cite{zhang2014troika} and ML-only method with Convolutional Neural network (CNN) based encoder-decoder~\cite{everson2019biotranslator} using the popular ISPC dataset. 

Figure~\ref{fig:motivation_acc} gives the MAPEs (mean absolute percentage error) of these two methods. For the signal-processing-only method, we reproduced its processing procedures to generate estimations of HRV, which were then compared with the ECG ground truths in the ISPC dataset to calculate the MAPEs. For the CNN-only method, its MAPEs were directly calculated based on results reported in its paper. As Figure~\ref{fig:motivation_acc} shows, both methods have high errors for HRV estimations. Especially for RMSSD, both methods have over 50\% error.  

We observe four reasons that cause these high errors. 
\begin{enumerate}
    \item First, the static signal processing cannot always effectively remove all noises in the PPG signals.
    %, which are quite common in the ISPC datasets. 
    Therefore, for RMSSD, which measures the short-time components of HRV, the remaining signal noises could significantly degrade the accuracy of the signal-processing-only method. Interestingly, the signal-processing-only method's SDNN estimation accuracy is less affected, as SDNN represents long-term variability and is less sensitive to the remaining signal noises.
    \item Second, the CNN-only method suffers from error amplification. This method does not directly estimate RMSSD or SDNN. Instead, it estimates RR intervals, which are then converted to RMSSD/SDNN using Equations~(\ref{eq:sdnn}) and~(\ref{eq:rmssd}). However, this conversion amplifies the estimation error. Table~\ref{tab:rr_vs_hrv} illustrates this error amplification, where we generated five sets of RR estimations with random errors based on certain average errors (MAPE), converted them into HRV (RMSSD/SDNN), and evaluated the errors of the converted HRV. Table~\ref{tab:rr_vs_hrv} shows that a small 3\% MAPE in RR estimations amplifies to 41.55\%/23.87\% error for RMSSD/SDNN. 
    \item Third, for the CNN-only method, although it can remove most of the noises in theory, the small ISPC dataset does not provide enough data for the CNN model to learn the noise removal completely. The ISPC dataset only has PPG signals from five minutes of monitoring, whereas a single HRV reading requires half to five minutes~\cite{acharya2006heart}. This small dataset further contributes to the CNN model's high errors for both RMSSD and SDNN estimations in Figure~\ref{fig:motivation_acc}. 
    \item Fourth, the model used in the CNN-only method could be too small and not sophisticated enough to process noisy signals.  Table~\ref{tab:motivation_size} shows that this CNN model is only 195KB (42657 trainable parameters). As shown later, inferring HRV with raw noisy PPG signal would require complex neural network models of tens or hundreds of MBs, as the noise removal computation is typically nonlinear and non-polynomial. Large models, however, are unsuitable for small wearable devices with only hundreds of KBs of on-chip memory.
\end{enumerate} 

%Besides the accuracy, Table~\ref{tab:motivation_size} also shows that the size of the CNN model is very large that contains in total of 42657 trainable parameters up to \TODO{xxx} MB.  Such a large model, however, is usually necessary when using only neural networks to remove signal noises, 

Based on the above observation, our \textit{\textbf{hypothesis}} is that a \textit{compound and direct method} that combines signal processing and ML, and directly estimates RSMSSD/SDNN, can achieve both high accuracy and small ML model size. To verify this hypothesis, we trained MLP-based models to directly estimate RMSSD and SDNN using the signal-processed ISPC's PPG data. The accuracy and model size of our method are also given in Figure~\ref{fig:motivation_acc} and Table~\ref{tab:motivation_size} under the label "Sig-proc+MLP". As Figure~\ref{fig:motivation_acc} shows, our method had lower error than both the signal-processing-only and ML-only methods. Table~\ref{tab:motivation_size} also shows that this compound and direct method had small model sizes of less than 50KB because many signal noises are already treated by signal processing. 
%It is also worth noting that the error of RMSSD estimations is still high for the direct and compound methods due to the small data size, indicating more data may be necessary.

For the sake of comparison completeness, we also trained MLP models using the original PPG signals from the ISPC dataset to directly estimate RMSSD/SDNN. That is, we also compared an ML-only method with MLP models. These MLP models went through hyperparameter tuning, and the errors of the most-accurate MLP models are reported in Figure~\ref{fig:motivation_acc} under the label "MLP-only", %Being a direct HRV estimation, this MLP-only method had lower or similar errors than the indirect CNN-only model. Nonetheless, 
which shows that this MLP-only method has lower accuracy than our compound and direct method, mainly due to the small dataset. Moreover, as Table~\ref{tab:motivation_size} shows, the sizes of the MLP-only models are much larger than our compound models, due to the need of relying on pure neural networks to remove all noises.

In summary, the above results show that our hypothesis is likely to be valid, although more data are required to further validate this hypothesis. In the rest of this paper, we will present the details of our methodology for data collection and HRV estimation.
