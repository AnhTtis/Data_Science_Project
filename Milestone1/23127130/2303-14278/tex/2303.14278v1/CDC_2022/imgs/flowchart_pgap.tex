\tikzstyle{block} = [draw, rectangle, text centered, thick,rounded corners=2pt,
                     minimum height=1.5em, minimum width=5em, inner sep=4pt]
\tikzstyle{typical} = [fill=white!95!black]
\tikzstyle{reddish} = [draw=red,fill=white!95!red]
\tikzstyle{blueish} = [draw=blue,fill=white!95!blue]
\tikzstyle{greenish} = [draw=green!40!gray,fill=white!95!green]
\tikzstyle{longblock} = [draw,rectangle,text centered,thick,rounded corners=2pt,
                     minimum height=1.5em, minimum width=8em, inner sep=4pt]
\tikzstyle{largeBlock} = [draw, rectangle, very thick,
                     minimum height=19.3em, minimum width=25em, inner sep=4pt]
\tikzstyle{smallBlock} = [draw, rectangle, text centered, thick, dashed,
                     minimum height=13.25em, minimum width=15em, inner sep=4pt]
\tikzstyle{dashedBlock} = [draw, dashed, rectangle,
                     minimum height=2em, minimum width=4em, inner sep=4pt]
\tikzstyle{dottedBlock} = [draw, rectangle, text centered, ultra thick,
					 minimum height=1.5em, 
					 minimum width=8em, inner sep=4pt,
					 dash pattern=on 1pt off 2pt on 4pt off 2pt] 
\tikzstyle{newtip} = [->, very thick]
\tikzstyle{bidir} = [<->, very thick]
\tikzstyle{newtip_dashed} = [->, very thick, dashed]
\begin{tikzpicture}[auto, inner sep=0pt, outer sep=0pt, >=latex]

  % Column 1 - relative to laserscan block and then north.
  % This block defines the origin of the tikzpicture.
  \node[block, reddish] (laserscan) {Laserscan};

%   \node[anchor=south] (goal) at ($(laserscan.north) + (0, 1.0)$) {Goal};
    
  % Column 2
%   \node[block,reddish,anchor=west] (egocircle) 
%     at ($(laserscan.east) + (0.80, 0)$) 
%     {\centering Egocircle};
  \node[block,reddish,anchor=south] (egocircle) 
    at ($(laserscan.north) + (0, 3em)$) 
    {\centering Egocircle};
  \node[block, typical, anchor=south] (worldmap)  
    at ($(egocircle.north)+(0, 1)$)
    {\centering World Map};
    
%   \node[anchor=center] (goal) at (worldmap.west-|laserscan.north) {Goal};
  \node[anchor=south] (goal) at ($(worldmap.north)+(0,1.5em)$) {Goal};

  % Column 3: Global Planner down.
  \node[longblock, typical, anchor=west] (global) 
    at ($(worldmap.east) + (1.6, 0)$)  
    {\centering Global Planner};

  \node[longblock, blueish, anchor=west, text width=8em] 
    (gap) at (egocircle-|global.west)
    {\centering Gap Generation \\ and Selection};

  \node[longblock,blueish,anchor=north, text width=8em] (traj) 
    at ($(gap.south) - (0, 0.5)$) 
    {\centering Multi-Trajectory \\ Synthesis};
  
  \node[longblock,blueish,anchor=north, text width=8em] (score) 
    at ($(traj.south) - (0, 0.5)$) {\centering Trajectory \\ Scoring};
    
  \node[longblock,greenish,anchor=north, text width=8em] (controller) 
    at ($(score.south) - (0, 1.1)$) {\centering Trajectory \\ Controller};
    
  % Surrounding block: Local Planner
  \node[smallBlock, draw=blue!90!black,anchor=north] (local) 
    at ($(gap)!0.09!(gap) + (1em, 1)$){};
  \node[anchor=north,xshift=-1em,yshift=-4pt] (localtext) at (local.north) 
      {\sc Local Planner};

  % Big surrounding block: Navigation System.
%   \node[largeBlock, draw=blue!90!black,anchor=north] (planning) 
%     at ($(global)!0.09!(worldmap) + (-0.9-1.5em, 0.9)$){};
%   \node[anchor=north,xshift=0em,yshift=-4pt] (planningtext) at (planning.north) 
%       {\sc Hierarchical Navigation System};

  % Arrows - Columns 1 and 2.
  \draw[newtip] (laserscan.north) -- (egocircle.south);
  \draw[newtip] (egocircle.north) -- node[midway,right,xshift=2pt]{sensor info} 
    (worldmap.south);

  % Arrows - Column 2 to 3.
  \draw[newtip] (worldmap.east) -- (global.west);
  \draw[newtip] (egocircle.east) -- (gap.west);

  % Arrows - Column 3 down.
  \draw[newtip] (gap.south) -- (traj.north);
  \draw[newtip] (traj.south) -- (score.north);

  \draw[newtip] (score.south) -- node [midway,left,xshift=-3pt]{Recent Best Trajectory}(controller.north);
  
  \draw[newtip,<-] (gap.east) -- ($(gap.east)+(30pt,0pt)$) |-
  node[midway,left,anchor=east,xshift=-2pt,yshift=19pt]{Replan}(score.east);

%  % Arrows - new parts.
%  \draw[newtip,<->](cc.east) --node[midway,yshift=2pt]{precheck} (NI.west); 
  \draw[newtip] ($(goal.south)+(0pt,0pt)$) -- (worldmap.north);
%
%  \draw[newtip] ($(local.south) - (0, 0)$) -- (NI.north);
%  \draw[newtip] (NI.east) -- (following.west);
%
%  \draw[newtip](following.north) -- (replan.south); 
%  \draw[newtip](NI.north east) to[in=250] ([xshift=-5pt]replan.south);
%  \draw[newtip](replan.south west) -- (local.east);
%  \draw[newtip](replan.north west) -- (global.east);

  % Level text.
%   \node[anchor=north west, xshift=5pt] (LT) at (planning.north east)
%   {\sc Level};
%   \node[anchor=center] at (LT|-global) {High};
%   \node[anchor=center] at (LT|-local) {Mid};
%   \node[anchor=center] at (LT|-controller) {Low};
  
  % Legend on the bottom left
%   \node[dottedBlock,anchor=north west,minimum width=1em,text width=1em] (legend) at ($(laserscan.south west) + (0, -4.5)$) {};
%   \node[anchor=west] (legend_name) at ($(legend.east) + (0.2, 0)$) {Contributions};
\end{tikzpicture}