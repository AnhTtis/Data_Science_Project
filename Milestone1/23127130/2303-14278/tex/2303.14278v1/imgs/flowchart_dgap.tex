\tikzstyle{block} = [draw, rectangle, text centered, thick,rounded corners=2pt,
                     minimum height=1.5em, minimum width=5em, inner sep=4pt]
\tikzstyle{typical} = [fill=white!95!black]
\tikzstyle{reddish} = [draw=red,fill=white!95!red]
\tikzstyle{blueish} = [draw=blue,fill=white!95!blue]
\tikzstyle{greenish} = [draw=green!40!gray,fill=white!95!green]
\tikzstyle{longblock} = [draw,rectangle,text centered,thick,rounded corners=2pt,
                     minimum height=1.5em, minimum width=8em, inner sep=4pt]
\tikzstyle{largeBlock} = [draw, rectangle, very thick,
                     minimum height=18em, minimum width=43.5em, inner sep=4pt]
\tikzstyle{smallBlock} = [draw, rectangle, text centered, thick, dashed,
                     minimum height=9em, minimum width=41.5em, inner sep=4pt]
\tikzstyle{dashedBlock} = [draw, dashed, rectangle,
                     minimum height=2em, minimum width=4em, inner sep=4pt]
\tikzstyle{dottedBlock} = [draw, rectangle, text centered, ultra thick,
					 minimum height=1.5em, 
					 minimum width=8em, inner sep=4pt,
					 dash pattern=on 1pt off 2pt on 4pt off 2pt] 
\tikzstyle{newtip} = [->, very thick]
\tikzstyle{bidir} = [<->, very thick]
\tikzstyle{newtip_dashed} = [->, very thick, dashed]
\begin{tikzpicture}[auto, inner sep=0pt, outer sep=0pt, >=latex]

  % Column 1 - relative to laserscan block and then north.
  % This block defines the origin of the tikzpicture.
  \node[block, reddish] (laserscan) {Laserscan};

%   \node[anchor=south] (goal) at ($(laserscan.north) + (0, 1.0)$) {Goal};
    
  % Column 2
  \node[block,reddish,anchor=west, text width=5em] (kalman) 
    at ($(laserscan.east) + (0.80, 0)$) 
    {\centering Kalman \\ Filter};
%   \node[block, typical, anchor=south] (worldmap)  
%     at ($(kalman.north)+(0, 1)$)
%     {\centering World Map};
    
  \node[anchor=south] (goal) at ($(kalman.north)+(0,1.5em)$) {Goal};

  % Column 3: Global Planner down.
%   \node[longblock, typical, anchor=west] (global) 
%     at ($(worldmap.east) + (1.6, 0)$)  
%     {\centering Global Planner};
  
  \node[dottedBlock, blueish, anchor=west, text width=5em] 
    (egocircle) at ($(kalman.east)+(5.5em,0)$)
    {\centering Inflated \\ Egocircle};
    
  \node[dottedBlock, blueish, anchor=west, text width=8em] 
    (gap) at ($(egocircle.east) + (2em, 0)$)
    {\centering Gap Generation \\ and Selection};

  \node[dottedBlock,blueish,anchor=west, text width=8em] (traj) 
    at ($(gap.east) + (2em, 0)$) 
    {\centering Multi-Trajectory \\ Synthesis};
    
  \node[dottedBlock,blueish,anchor=west, text width=6em] (prop) 
    at ($(traj.east) + (2em, 0)$) 
    {\centering Agent State \\ Prediction};
  
  \node[dottedBlock,blueish,anchor=north] (cfs) 
    at ($(egocircle.south) - (0, 6em)$) {\centering CFS};
    
  \node[dottedBlock,blueish,anchor=center, text width=8em] (uncert) 
    at (kalman.south|-cfs.west) {\centering Uncertainty \\ Analysis};
  
  \node[longblock,blueish,anchor=north, text width=8em] (score) 
    at ($(cfs.south) - (0, 0.5)$) {\centering Trajectory \\ Scoring};
    
  \node[longblock,greenish,anchor=north, text width=8em] (controller) 
    at ($(score.south) - (0, 1.1)$) {\centering SSA \\ Controller};
  
  % Surrounding block: DGap
  \node[smallBlock, draw=blue!90!black,anchor=north] (dgap) 
    at ($(egocircle)!0.09!(egocircle) + (15.7em, 1.1)$){};
  \node[anchor=north,xshift=-0em,yshift=-4pt] (dgaptext) at (dgap.north) 
      {\sc DAGap};

  % Surrounding block: Local Planner
  \node[largeBlock, draw=blue!90!black,anchor=north] (local) 
    at ($(egocircle)!0.09!(egocircle) + (15.7em, 1.3)$){};
  \node[anchor=south,xshift=14em,yshift=1em, text width=4.5em] (localtext) at (local.south) 
      {\centering {\sc Local \\ Planner}};

  % Big surrounding block: Navigation System.
%   \node[largeBlock, draw=blue!90!black,anchor=north] (planning) 
%     at ($(global)!0.09!(worldmap) + (-0.9-1.5em, 0.9)$){};
%   \node[anchor=north,xshift=0em,yshift=-4pt] (planningtext) at (planning.north) 
%       {\sc Hierarchical Navigation System};

  % Arrows - Columns 1 and 2.
  \draw[newtip] (laserscan.east) -- (kalman.west);
%   \draw[newtip] (kalman.north) -- node[midway,right,xshift=2pt]{sensor info} 
%     (worldmap.south);

  % Arrows - Column 2 to 3.
%   \draw[newtip] (worldmap.east) -- (global.west);
  \draw[newtip] (kalman.east) -- ($(kalman.east) + (4.5em, 0)$)
  node[midway,align=center,anchor=center,xshift=-0.5em,yshift=0.1em, text width=3em]{\centering Agent \\[0.8em] State};

  % Arrows - Column 3 down.
  \draw[newtip] (egocircle.east) -- (gap.west);
  \draw[newtip] (gap.east) -- (traj.west);
  \draw[newtip] (traj.east) -- (prop.west);
  
  \draw[newtip,<-] ($(egocircle.south)+(0,0)$) -- ($(egocircle.south)+(0,-3em)$) -- 
  node[midway,anchor=south,xshift=0em,yshift=1em]{Iterate N Steps}($(prop.south) + (0,-3em)$) -- (prop.south);
  
  \draw[newtip] ($(cfs.north)+(0,1.6em)$) -- (cfs.north);
  \draw[newtip] (cfs.south) -- (score.north);

  \draw[newtip] (score.south) -- node [midway,left,xshift=-3pt,yshift=-0.5em]{Recent Best Trajectory}(controller.north);
  
  \draw[newtip,<-] ($(traj.south)+(0em,-4.6em)$) -- (traj.south|-score.east) |-
  node[midway,left,anchor=east,xshift=-5pt,yshift=19pt]{Replan}(score.east);

%  % Arrows - new parts.
%  \draw[newtip,<->](cc.east) --node[midway,yshift=2pt]{precheck} (NI.west); 
  \draw[newtip] ($(goal.east)+(3pt,0em)$) -- ($(goal.east)+(5.5em,0em)$);
  
  \draw[newtip] (kalman.south) -- (uncert.north);
  \draw[newtip] (uncert.east) -- (cfs.west);
  \draw[newtip] ($(uncert.north)+(2.5em,0)$) -- ($(uncert.north)+(2.5em,4em)$) -- ($(uncert.north)+(7.5em,4em)$);
%
%  \draw[newtip] ($(local.south) - (0, 0)$) -- (NI.north);
%  \draw[newtip] (NI.east) -- (following.west);
%
%  \draw[newtip](following.north) -- (replan.south); 
%  \draw[newtip](NI.north east) to[in=250] ([xshift=-5pt]replan.south);
%  \draw[newtip](replan.south west) -- (local.east);
%  \draw[newtip](replan.north west) -- (global.east);

  % Level text.
%   \node[anchor=north west, xshift=5pt] (LT) at (planning.north east)
%   {\sc Level};
%   \node[anchor=center] at (LT|-global) {High};
%   \node[anchor=center] at (LT|-local) {Mid};
%   \node[anchor=center] at (LT|-controller) {Low};
  
  % Legend on the bottom left
  \node[dottedBlock,blueish,anchor=north west,minimum width=1em,text width=1em] (legend) at ($(laserscan.south west) + (1.5, -5.5)$) {};
  \node[anchor=west] (legend_name) at ($(legend.east) + (0.2, 0)$) {Contributions};
\end{tikzpicture}