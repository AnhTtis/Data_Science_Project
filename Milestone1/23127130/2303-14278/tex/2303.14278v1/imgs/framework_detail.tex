\usetikzlibrary{backgrounds}

\tikzstyle{block} = [draw, rectangle, text centered, thick,
                     minimum height=2em, minimum width=10em, inner sep=4pt]
\tikzstyle{reddish} = [draw=red,fill=white!95!red]
\tikzstyle{greenish} = [draw=green!40!gray,fill=white!95!green]
\tikzstyle{blueish} = [draw=blue,fill=white!95!blue]
\tikzstyle{newtip} = [->, very thick]

\begin{tikzpicture}[auto, inner sep=0pt, outer sep=0pt, >=latex]

  % Column 1 - relative to laserscan block and then north.
  % This block defines the origin of the tikzpicture.
  \node[centered] (kalman) {Kalman Filter};
  
  \node[centered,anchor=south,align=center] (uncert) at ($(kalman.north)+(0,3em)$) {Uncertainty \\ Analysis};

  \node[centered,anchor=west] (gap) at ($(uncert.east)+(5.5em,1.5em)$) {DAGap};
  
  \node[centered,anchor=west] (cfs) at ($(uncert.east)+(5.5em,-1.5em)$) {CFS};
  
  \node[centered,anchor=west] (ssa) at ($(kalman.east)+(9em,0em)$) {SSA};
  
  \begin{scope}[on background layer]
  \node[block,greenish,anchor=west,minimum height=2.5em, minimum width=19em] (control) at ($(kalman.west)+(-1.5em,0)$) {};
  
  \node[block,blueish,anchor=south west,minimum height=5em, minimum width=15em] (plan) at ($(uncert.south west)+(-1em,-1.5em)$) {};
  \end{scope}
  
  \draw[newtip] ($(kalman.west)+(-6.5em,0)$) -- ($(kalman.west)+(-0.1em,0)$)
  node[midway,anchor=south,xshift=-1em,yshift=0.5em]{Laserscan};
  
  \draw[newtip] (control.east) -- ($(control.east)+(5em,0)$)
  node[midway,anchor=south,xshift=0em,yshift=0.5em]{Control};
  
  \draw[newtip] ($(kalman.east)+(0.1em,0em)$) -- ($(ssa.west)+(-0.1em,0em)$);
  
  \draw[newtip] ($(kalman.north)+(0em,0.1em)$) -- ($(uncert.south)+(0,-0.1em)$);
  
  \draw[newtip] ($(uncert.east)+(0.1em,0em)$) -- ($(uncert.east)+(3.5em,0em)$)
  node[midway,anchor=north,xshift=0em,yshift=-0.5em]{$d_{safe}$} -- ($(cfs.west)+(-2em,0em)$) -- ($(cfs.west)+(-0.1em,0)$);
  
  \draw[newtip] ($(uncert.east)+(3.5em,0em)$) -- ($(gap.west)+(-2em,0em)$) -- ($(gap.west)+(-0.1em,0)$);
  
  \draw[newtip] ($(plan.east)+(0em,0em)$) -- (plan.east-|ssa.north) --
  node[midway,anchor=west,xshift=0.2em,yshift=0em]{Trajectory}($(ssa.north)+(0,0.1em)$);
  
  \node[centered,anchor=north] at ($(control.south)+(-0.8em,-0.8em)$) {Controller Thread};
  \node[centered,anchor=south] at ($(plan.north)+(0em,0.8em)$) {Planner Thread};
\end{tikzpicture}