\section{Background on Network Calculus}
\label{sec: background}


\begin{figure*}[tbh]
\centering
\begin{subfigure}[b]{0.3\textwidth}
    \centering
    \includegraphics[width=\linewidth]{images/in-out.png}
    \caption{Arrival and departure data and their relation with delay $d(t)$ and backlog $b(t)$. For a FIFO system, the delay is the horizontal distance between $R(t)$ and $R^*(t)$ but some other multiplexing techniques may shift the data to a later priority, causing a longer delay.}
    \label{fig: data in-out}
\end{subfigure}
\hfill
\begin{subfigure}[b]{0.35\textwidth}
    \centering
    \includegraphics[width=\linewidth]{images/arrival-service.png}
    \caption{Characteristics of an arrival curve and a service curve. From any point of observation, the arriving data never exceeds its arrival curve; the departure data is also never less than the service curve with respect to the data arrival.}
    \label{fig: arrival-service curves}
\end{subfigure}
\hfill
\begin{subfigure}[b]{0.33\textwidth}
    \centering
    \includegraphics[width=\linewidth]{images/bound.png}
    \caption{Delay and backlog bounds of a system. Backlog is the maximum vertical distance between $\alpha(t)$ and $\beta(t)$; FIFO delay is their maximum horizontal distance; but for arbitrary multiplexing, the delay guarantee is when the system clears its buffer, thus it's the intersection of $\alpha(t)$ and $\beta(t)$.}
    \label{fig: system bounds}
\end{subfigure}
\caption{Network calculus framework. We let $R(t)$ and $R^*(t)$ be the arrival and departure data flow of a system; $\alpha(t)$ be the piecewise linear concave arrival curve and $\beta(t)$ be the piecewise linear convex service curve of a system.}
% \hossein{Better to show piece-wise linear concave arrival curve and piece-wise linear convex service curve instead of token-bucket and rate-latency.}}
\end{figure*}

We recall some of the network calculus essentials for a better understanding of the framework used in Saihu. In the following context, we use the following notation: $\mbb{R}^+$ is the set of non-negative real numbers; $[x]_+$ denotes $\max(0, x)$

The data flow is by convention modeled as a left-continuous wide-sense increasing function $R(t): \mbb{R}^+ \mapsto \mbb{R}^+$ with respect to time $t$~\cite{ncbook2001leboudec}. 

A system $\mcal{S}$ receives arrival data described as a cumulative function $R(t)$ and delivers departure data as another cumulative function $R^*(t)$. Figure~\ref{fig: data in-out} illustrates such a system $\mcal{S}$. The benefit of representing a system like this is that we can observe system backlog and delay with such a model. 

\begin{definition}[Backlog and Delay~\cite{ncbook2001leboudec}]
    The backlog of a system at time~$t$ is
    \begin{equation}
        b(t) = R(t) - R^*(t)
    \end{equation}
    
    The virtual delay of a FIFO system at time $t$ is
    \begin{equation}
        d_{FIFO}(t) = \inf \lbp \tau \geq 0 : R(t) \leq R^*(t+\tau) \rbp
    \end{equation}
\end{definition}



The backlog of a system can be viewed as the vertical distance between $R$ and $R^*$. The FIFO (\textit{First-in First-out}) delay is the horizontal distance between $R$ and $R^*$. One may obtain other delay values if the multiplexing technique is not FIFO.

% \begin{figure}
%     \centering
%     \includegraphics[width=0.9\linewidth]{images/in-out.png}
%     \caption{In/out data flow; delay and backlog}
%     \label{fig: data in-out}
% \end{figure}

Since we are interested in the system guarantee instead of a single instance of data flow, we would like to have general bounds to the arrival and departure data flows. Therefore, we define \textit{arrival curve} and \textit{service curve} as the bounds of arrival and departure data flows.

\begin{definition}[Arrival Curve~\cite{ncbook2001leboudec}]
    Given a wide-sense increasing function $\alpha: \mbb{R}^+ \mapsto \mbb{R}^+$, we say that a flow $R(t)$ is $\alpha$-constrained if and only if for all $s \leq t$:
    \begin{equation}
        R(t) - R(s) \leq \alpha(t-s)
    \end{equation}
    We say $R(t)$ has $\alpha$ as an arrival curve.
\end{definition}

\begin{definition}[Service Curve~\cite{ncbook2001leboudec}]
    Given a wide-sense increasing function $\beta: \mbb{R}^+ \mapsto \mbb{R}^+$ and $\beta(0) = 0$. A system $\mcal{S}$ having $R(t)$ and $R^*(t)$ as its arrival and departure flows. We say $\mcal{S}$ offers a service curve $\beta$ if and only if
    \begin{equation}
        R^*(t) \geq (R \otimes \beta)(t) =: \inf_{s \leq t} \lbp R(s) + \beta(t-s) \rbp
    \end{equation}
    where $\otimes$ denotes the min-plus convolution
\end{definition}

Figure~\ref{fig: arrival-service curves} illustrates the arrival and service curves. Any segment of arrival flow $R(t)$ is constrained by arrival curve $\alpha$ and the output curve $R^*(t)$ is always no less than the curve $R\otimes\beta$. As a result, an arrival curve upper bounds the incoming traffic, and a service curve lower bounds the outgoing traffic.

% \begin{figure}
%     \centering
%     \includegraphics[width=\linewidth]{images/arrival-service.png}
%     \caption{Arrival/Service curve}
%     \label{fig: arrival-service curves}
% \end{figure}

We consider 2 special types of curves throughout this paper, \textit{token-bucket} (or sometimes called \textit{leaky-bucket}) curve and \textit{rate-Latency} curve.

\begin{definition}[Token-bucket and Rate-latency~\cite{ncbook2001leboudec}]
    A token-bucket curve $\gamma_{r,b}$ with arrival rate $r$ and burst $b$ is defined as
    \begin{equation}
        \gamma_{r,b}(t) = b + rt
    \end{equation}

    A rate-latency curve $\beta_{R,T}$ with service rate $R$ and latency $T$ is defined as
    \begin{equation}
        \beta_{R,T}(t) = R \lb t - T \rb_+
    \end{equation}
\end{definition}

A token-bucket curve is determined by a burst $b$ and an arrival rate~$r$. Burst represents the maximum possible data volume that can arrive simultaneously, and arrival rate represents the maximum long-term data rate~\cite{bouillard2022tradeoff}.
A rate-latency curve is determined by a latency~$T$ and a service rate~$R$. Latency represents the time a server needs before starting to process the incoming data, and service rate represents the minimum rate to process data after the initial latency.

With the help of arrival and service curves, we can derive delay and backlog bounds for a system $\mcal{S}$ illustrated in Figure~\ref{fig: system bounds}. Suppose a system $\mcal{S}$ has arrival curve $\alpha$ and service curve~$\beta$, its worst-case backlog $b^*$ is the maximum vertical distance between~$\alpha$ and~$\beta$. Similarly, depending on the multiplexing technique applied to the system, its worst-case delay bound $d^*$ is the maximum horizontal distance between $\alpha$ and $\beta$ if $\mcal{S}$ is a FIFO system. If we don't have any information about its multiplexing technique, referred to as arbitrary multiplexing, the best we can say is that when $\alpha$ and $\beta$ intersect each other, where all data has been delivered out of the system. Consequently, the worst-case delay bound for arbitrary multiplexing is the time required for $\mcal{S}$ to clear its buffer.

% \begin{figure}
%     \centering
%     \includegraphics[width=\linewidth]{images/bound.png}
%     \caption{System delay/backlog bounds}
%     \label{fig: system bounds}
% \end{figure}

While a service curve captures the slowest possible output speed of a system, a link's transmission capacity limits the speed as well. Hence, we model this phenomenon using a \textit{greedy shaper} with a sub-additive function $\sigma: \mbb{R}^+ \mapsto \mbb{R}^+$ concatenated with a server. We consider a concatenation as shown in Figure \ref{fig: system}. By convention we assume $\sigma(0) = 0$ and $\beta(t) \leq \sigma(t), \forall t \in \mbb{R}^+$, meaning that the buffer is cleared at the beginning and the service never exceed its physical limitation. With the above definition, such greedy shaper conserves the service provided by the system due to theorem \ref{thm: shaping}.

\begin{figure}[thb]
    \centering
    \includegraphics[width=0.7\linewidth]{images/system.png}
    \caption{Shaping of departure data. A flow that has an arrival curve $\alpha$ feeds into a server with an arrival data flow $R(t)$. The server having service curve $\beta$ takes $R(t)$ and gives a departure data flow $R^*(t)$ to a shaper with shaping function $\sigma$. The shaper takes $R^*(t)$ and shape the data flow as another departure $D(t)$.}
    \label{fig: system}
\end{figure}


\begin{theorem}[Shaping conserves service \cite{ncbook2001leboudec}]
\label{thm: shaping}
Following the system shown in Figure \ref{fig: system}, we have
\begin{equation}
     D = R^* \otimes \sigma \geq \lp R \otimes \beta \rp \otimes \sigma = R \otimes \lp \beta \otimes \sigma \rp = R \otimes \beta
\end{equation}
\end{theorem}

In the following context, we model the shaping function $\sigma$ as a token-bucket curve $\gamma_{C,L}$ with transmission capacity $C$ and the packet size $L$ to capture the link capacity and packetization~\cite{bouillard2022tradeoff}.
