In this section we describe the cosmological simulation, halo finder, and associated halo properties used for our models. We also present the data from which we select parent galaxy samples for training our models, as well as the DESI LRG target selection functions.


\subsection{Simulations}\label{subsec:sims}

We use halo catalogs and merger histories obtained with the publicly available \texttt{ROCKSTAR} phase-space temporal halo finder \citep{behroozi_etal13b} for the MultiDark Planck 2 (MDPL2) simulation\footnote{www.cosmosim.org} \citep{klypin_etal16}.
MDPL2 assumes Planck cosmology \citep[$h=0.6777$, $\Omega_{\rm m}=0.307115$;][]{planck_collab16} and evolves $3840^3$ dark matter particles in a 1~\Gpch cubic volume, beginning at $z=120$.
The particle resolution is $1.51\times10^9\ h^{-1}\ \msun$. In total 126 snapshots are available between $z\sim15$ and $z=0$. For this work we use three snapshots at $z=0.425$, 0.523, and 0.628.

The \texttt{ROCKSTAR} halo finder is designed to preserve particle--halo membership and identify accurate halo merger trees across multiple time steps of a simulation.
For MDPL2, \texttt{ROCKSTAR} halo catalogs are mass-complete for halos (including subhalos) above ${\mvir\gtrsim11.4\times10^{11}\ h^{-1}\ \msun}$.

\subsubsection{Subhalo abundance matching}\label{subsubsec:sham}

In SHAM modeling, mock galaxies are assigned to dark matter halos by exploiting the correlation between some galaxy property---usually stellar mass or luminosity---and a halo property such as virial mass or circular velocity. Circular velocity is defined as ${\vcirc(r,z) \equiv \sqrt{GM(<r,z)/r}}$, where $M(<r,z)$ is the enclosed mass within radius $r$ at redshift $z$.
SHAM has been tested with several versions of halo circular velocity. In this work we use \vpeak, the peak value of maximum circular velocity (${\vmax(z) = {\rm max}\{v_{\rm circ}(r,z)\}}$) achieved throughout a halo's entire assembly history.


\subsubsection{Age distribution matching}\label{subsubsec:adm}

\input{fig_zstarve_example}

Age distribution matching assumes a correlation at fixed luminosity between galaxy color and some proxy (at fixed model luminosity) for the age of the halo in which each mock galaxy resides. Redder colors (i.e., older, quenched galaxies) are generally assigned to older halos.
Model colors are assigned at fixed luminosity (in practice in narrow luminosity bins) because the galaxy color distribution is highly dependent on luminosity.

We equate the cumulative distribution $\mathcal{D}_{\rm gal}$ of galaxies of $K$-corrected color $\mathcal{C}$ at fixed absolute magnitude $M_X$ to the cumulative distribution $\mathcal{D}_{\rm halo}$ of halo age proxy $A$ at fixed model absolute magnitude:
%
\begin{equation}\label{eq:color_assign}
\mathcal{D}_{\rm gal} ( < \mathcal{C}\ |\ M_X )=\mathcal{D}_{\rm halo}( < A\ |\ {\rm model}\ M_X ).
\end{equation}

\noindent In Equation~\ref{eq:color_assign} $(\mathcal{C},M_X) = {(r-z, M_z)}$ OR ${(r-W1, M_{W1})}$ for this work.

Implementations of age distribution matching at $z\sim0$ using spectroscopic galaxy redshifts from SDSS have used halo starvation redshift, \zstarve, for the halo age proxy $A$ in Eq.\ \ref{eq:color_assign} \citep{hearin_watson13, hearin_etal14, safonova_etal21}. In general, \zstarve represents the redshift at which a galaxy loses its supply of cold gas, which leads to the quenching of star formation and the reddening of the galaxy. Multiple physical processes relevant to a halo's assembly history can affect the value of \zstarve for a given halo, which \citet{hearin_watson13} incorporate into the following definition:
%
\begin{equation}\label{eq:zstarve}
\zstarve \equiv \max\{\zchar,\, \zacc,\, \zform\}.
\end{equation}

\noindent In Equation~\ref{eq:zstarve}:
%
\begin{itemize}
\item \zchar is either the redshift at which a halo's mass first exceeds some characteristic value, \mchar, or the redshift of the relevant simulation snapshot (\zsim) for halos that never achieve \mchar;
%
\item \zacc is the redshift at which a subhalo accretes onto a parent halo (for host halos ${\zacc=\zsim}$). \citet{hearin_watson13} follow \citet{behroozi_etal13c}, which defines \zacc as the snapshot after which a subhalo always remains a subhalo. They note that alternative definitions, such as that of \citet{wetzel_etal14}, where \zacc is the snapshot at which a subhalo has been identified as such for two consecutive snapshots, have little impact on their results.
%
\item \zform is the ``formation" redshift at which a halo transitions from the fast to slow accretion regime.
\end{itemize}
\noindent We use same definition of \zform as \citet{hearin_watson13}, motivated by \citet{wechsler_etal02}:
%
\begin{equation}\label{eq:zform}
\zform \equiv \frac{c_{\rm vir}}{4.1 a_0} - 1,
\end{equation}

\noindent where ${c_{\rm vir} = R_{\rm vir}/R_{\rm s}}$ is a halo's concentration at the time of observation, indicated by $a_0$. For host halos $a_0$ is the scale factor of the relevant simulation snapshot, while for subhalos $a_0$ is the scale factor at the time of accretion: ${\zacc = 1/{a_0} - 1}$. $R_{\rm vir}$ is the virial radius of a halo, and $R_{\rm s}$ is the NFW scale radius \citep{navarro_etal97}.

We adopt the value of ${\mchar=10^{12}\ \msunh}$ used in \citet{hearin_watson13}, who note that their results are insensitive to the precise value of \mchar used. The empirical and physical motivation for \mchar are described in detail in \S6.3 of \citet{hearin_watson13}. Briefly, there is empirical support for a characteristic halo mass above which star formation is highly inefficient: ${\sim10^{12}\ \msunh}$ is the halo mass at which the SHMR peaks, falling off rapidly at higher halo masses \citep{behroozi_etal13a, yang_etal12, yang_etal13, moster_etal13, watson_conroy13}, and \citet{behroozi_etal13d} have shown that this mass remains essentially constant throughout much of cosmic history.

We compute \zstarve for all halos in our model from the publicly available \texttt{ROCKSTAR} halo merger trees for MDPL2. Figure~\ref{fig:zstarve_example} shows sample halo mass accretion histories and corresponding \zstarve values for four randomly selected halos from the $\zsim=0.425$ snapshot of MDPL2.


\subsection{Photometry and redshift estimates}\label{subsec:photometry}

We use publicly available catalogs from the ninth data release (DR9) of the DESI Legacy Imaging Surveys\footnote{www.legacysurvey.org/dr9} \citep{dey_etal19}. The Legacy Surveys provide optical imaging in the $g$, $r$, and $z$ bands from a combination of three public surveys:\ the DECam Legacy Survey \citep[DECaLS;][]{flaugher_etal15, blum_etal16},
the Beijing-Arizona Sky Survey \citep[BASS;][]{zou_etal17b},
and the Mayall $z$-band Legacy Survey \citep[MzLS;][]{silva_etal16}.
The Legacy Surveys also include four mid-infrared bands from the Wide-field Infrared Survey Explorer \citep[WISE;][]{wright_etal10},
although only the 3.4 micron $W1$-band is relevant for DESI LRG target selection.

In total the Legacy Surveys cover $14,000$ square degrees visible from the northern hemisphere, comprised of two contiguous regions within the northern and southern galactic caps. To avoid effects from systematic differences among data from the three component optical surveys, we limit our study to the approximately 9,000 square degrees covered by DECaLS.

\citet{zhou_etal20b} compute photometric redshifts for the full catalog of DECaLS DR7 objects using the random forest regression machine learning algorithm in \texttt{Scikit-Learn} \citep{pedregosa_etal11} and a ``truth" dataset of spectroscopic and many-band photometric redshifts for objects within DR7.
They quantify the accuracy of their photometric redshifts with the normalized median absolute deviation \citep[NMAD;][]{dahlen_etal13}:\ $\sigma_{\rm NMAD}=1.48 \times {\rm median}( | \Delta z | /(1+z_{\rm spec}))$, where $\Delta z = \zphot - z_{\rm spec}$ and $z_{\rm spec}$ are the redshift truth values used to train the random forest algorithm, and report $\sigma_{\rm NMAD}=0.021$ for LRGs.
Their outlier rate for LRGs is 1\%, where outliers are objects with $| \Delta z | > 0.1\times(1+z_{\rm spec})$.
Additionally, \citet{zhou_etal20b} estimate their redshifts are accurate for objects with apparent $z$-band magnitude $z < 21$, well beyond the $z<20.7$ cut we use to select our target galaxy samples, described in \S\ref{subsec:parent_samples} below.


\subsection{DESI LRG target selection}\label{subsec:lrg_target_select}

The DESI LRG target sample is intended to serve as a cosmological tracer spanning the redshift range $\sim0.4 < z \lesssim 1.0$. The sample lies between the low-redshift Bright Galaxy Survey \citep[BGS;][]{hahn_etal22} tracer sample at $z\lesssim0.4$, and the Emission Line Galaxy \citep[ELG;][]{raichoor_etal22} sample, optimized to trace the density field over the approximate range ${1.0 < z < 1.6}$.

Two different selection algorithms were considered for the DESI LRG sample:\ an optical selection function based on $z$-band magnitude and ${r-z}$ color, and an infrared selection function based on $W1$-band magnitude and ${r-W1}$ color. Both selections are tuned to yield a constant LRG target density of $\sim600$ objects per square degree and a comoving number density around ${5\times10^{-4}\ h^3\ {\rm Mpc}^{-3}}$ at ${0.4 < z < 0.8}$. Both the optical and IR selections were tested in DESI's Survey Validation (SV; DESI et al., in prep.) observations. Based largely on the calibration of $W1$-band imaging, the DESI Main Survey uses exclusively the IR selection. A complete description of DESI LRG target selection is given in \citet{zhou_etal22}. Here we cover the details most relevant for this work.

Due to slight differences in photometry among BASS, MzLS, and DECaLS, the optical and IR DESI LRG target selections use slightly different cuts for the north (BASS and MzLS) and south (DECaLS) galactic caps. As this work uses $g$, $r$, and $z$ magnitudes from DECaLS, we use the corresponding optical LRG target selection cuts \citep{zhou_etal20a}:
%
\begin{subequations}\label{eq:lrg_opt}
  \begin{align}
   % stellar rejection cut               
   & z - W1 > 0.8\times(r - z) - 0.6\label{eq:lrg_opt_stellar}, \\
   \begin{split}
   % eliminate low-redshift or bluer objects
   & ( (g - W1 > 2.6)\ {\rm AND}\ (g - r > 1.4) )\ {\rm OR} \\
   & \phantom{00} (r - W1 > 1.8)\label{eq:lrg_opt_lowz},
   \end{split} \\
   \begin{split}
   % color-dependent magnitude limit selects only most luminous objects at given redshift
   & ( r - z > 0.45\times(z - 16.83) )\ {\rm AND}\ (r - z > 0.7) \\
   & \phantom{00}{\rm AND}\ (r - z > 0.19\times(z - 13.80) )\label{eq:lrg_opt_color-mag},
   \end{split} \\
   %& r - z > 0.7, \\
   % ensure targets yield secure spec-z measurements
   & z_{\rm fiber} < 21.5\label{eq:lrg_opt_fiber}.
   \end{align}
\end{subequations}
%
\noindent The relevant IR LRG target selection cuts for this work are \citep{zhou_etal22}:
%
\begin{subequations}\label{eq:lrg_ir}
   % stellar rejection cut
  \begin{align}
   & z - W1 > 0.8 \times (r - z) - 0.6\label{eq:lrg_ir_stellar}, \\
   % eliminate low-redshift or bluer objects
   & ( g - W1 > 2.9)\ {\rm OR}\ (r - W1 > 1.8)\label{eq:lrg_ir_lowz}, \\
   \begin{split}
   % color-dependent magnitude limit selects only most luminous objects at given redshift
   & ( ( r - W1 > 1.8 \times (W1 - 17.14) )\ {\rm AND} \\
   & \phantom{00} ( r - W1 > W1 - 16.33 ) )\ {\rm OR}\ ( r - W1 > 3.3 )\label{eq:lrg_ir_color-mag},
  \end{split} \\
   % ensure targets yield secure spec-z measurements
   & z_{\rm fiber} < 21.6\label{eq:lrg_ir_fiber}.
  \end{align}
\end{subequations}

Equations~\ref{eq:lrg_opt_stellar} and \ref{eq:lrg_ir_stellar} are designed to reject stars, Eqs.\ \ref{eq:lrg_opt_lowz} and \ref{eq:lrg_ir_lowz} remove blue and low-redshift objects, Eqs.\ \ref{eq:lrg_opt_color-mag} and \ref{eq:lrg_ir_color-mag} are color-dependent magnitude limits that select only the most luminous objects at a given redshift, and $z_{\rm fiber}$ in Eqs.\ \ref{eq:lrg_opt_fiber} and \ref{eq:lrg_ir_fiber} is the expected $z$-band flux within a DESI fiber. All magnitudes in Eqs.\ \ref{eq:lrg_opt} and \ref{eq:lrg_ir} use the AB system, and are corrected for galactic extinction using the relevant \texttt{MW\_TRANSMISSION} values from the Legacy Surveys DR9.


\subsection{Parent galaxy samples}\label{subsec:parent_samples}

\input{fig_abs_mag_cuts}

\input{fig_cmd}

\input{table_masks}

\input{table_parent_samples}

\input{table_mag_bins}

A primary goal of this work is to create mock galaxy catalogs that are both statistically complete and represent a superset of the color--magnitude space occupied by DESI LRG targets. Selection of DESI LRG targets is based entirely on $g$, $r$, $z$, and $W1$ apparent magnitudes (see \S\ref{subsec:lrg_target_select}), so we would ideally create mock catalogs where every mock galaxy has an apparent magnitude in each of these bands. SHAM, however, exploits the correlation between some physical halo property (e.g., circular velocity) and a physical galaxy property independent of redshift (e.g., luminosity). We therefore train our mock catalogs on galaxy samples that are complete to an \emph{absolute} magnitude threshold that includes all DESI LRG targets (in the relevant redshift bin; see below).

To select suitable parent galaxy samples, we first apply an apparent $z$-band magnitude cut of $z < 20.7$, and take an additional step to remove stars by excluding catalog sources with ${\rm TYPE} = \texttt{PSF}$. We also apply the masks described in Table~\ref{tab:masks}, which are provided with DECaLS DR9, to remove sources affected by bad pixels or contamination from bright stars. Finally, a geometric mask is applied to ensure complete angular coverage by the catalogs of random points provided with DR9 (see \S\ref{subsec:wprp}). The resulting sample contains $\mathcal{O}(10^8)$ galaxies, sufficient to divide it into redshift bins and maintain low statistical error.

We initially tested six redshift bins of width $\Delta\zphot=0.1$ between $\zphot=0.4$ and $\zphot=1.0$, but found that DECaLS photometry is only deep enough to apply our model up to $\zphot \sim 0.7$. At $\zphot \gtrsim 0.7$ the data are incomplete above the absolute magnitude threshold that encompasses DESI LRG targets. We therefore limit our study to three redshift bins of $\Delta\zphot=0.1$ within $0.4 < \zphot < 0.7$.

For each redshift bin we compute $z$- and $W1$-band absolute magnitudes using photometric redshifts to obtain distance moduli.
We $K$-correct absolute magnitudes to the redshift of the relevant simulation snapshot, \zsim (see Table~\ref{tab:parent_samples}) with the \idl package \kcorrect \citep{blanton_roweis07}
using DECam $g$, $r$, and $z$ and WISE $W1$ and $W2$ filter responses.
For each redshift bin we use the simulation snapshot closest to the median \zphot of the data, e.g., galaxies in the ${0.4 < \zphot < 0.5}$ bin are $K$-corrected to $\zsim=0.425$.

The final step in selecting parent galaxy samples is to identify $z$- and $W1$-band absolute magnitude cuts in each redshift bin that yield complete samples which also include the full absolute magnitude range of DESI LRG targets in that bin. Figure~\ref{fig:abs_mag_cuts} shows $K$-corrected absolute magnitude distributions for all $z<20.7$ DECaLS galaxies in each redshift bin. For each bandpass and redshift bin combination, we identify an absolute magnitude cut (dashed black lines in Figure~\ref{fig:abs_mag_cuts}) that eliminates fainter galaxies where DECaLS becomes incomplete, while preserving $\gtrsim99\%$ of DESI LRG targets (solid orange and hatched purple histograms).

Table~\ref{tab:parent_samples} lists the details of each parent galaxy sample, including the relevant absolute magnitude cut, sample size, effective number density, and the included fractions of IR and optical DESI LRG targets. Besides enforcing statistically complete parent samples, these magnitude cuts also eliminate galaxies with larger photometric redshift errors, increasing the accuracy of clustering measurements (see \S\ref{subsec:wprp}).

Figure~\ref{fig:cmd} shows example optical ($r-z$ versus $M_z$) and IR ($r-W1$ versus $M_{W1}$) color--magnitude diagrams of the magnitude-limited parent galaxy samples for the {$0.4 < \zphot < 0.5$} redshift bin. Also shown in Figure~\ref{fig:cmd} are the color--magnitude distributions of optical and IR DESI LRG targets.
