In this section we describe our modeling procedure and the two-point statistics we use to constrain the model parameters.

\subsection{Projected correlation functions}\label{subsec:wprp}

One goal of this work is to exploit the completeness and enormous volume of DECaLS data, which comes at the expense of the precision clustering measurements achievable with spectroscopic redshifts. \citet{zhou_etal20b} demonstrate the constraining power of the projected correlation function, \wprp, of DECaLS galaxies computed with line-of-sight distances derived from photometric redshifts (they use this statistic to compute HOD parameters of ``DESI-like" LRGs selected from DECaLS DR7). The projected correlation function conveys 3D correlation function, \xir, integrated along the line-of-sight, effectively eliminating the effects of radial distance uncertainty due to photometric redshift errors:
% 
\begin{equation}
\wprp \equiv \int_{-\pimax}^{\pimax}\!\xi(\rp,\pi)\,d\pi = 2\!\int_0^{\pimax}\!\xi(\rp,\pi)\,d\pi,
\end{equation}
 
\noindent where \rp is the projection of $r$ into the plane perpendicular to the line-of-sight separation, $\pi$.

We use the \corrfunc package \citep{sinha_garrison17, sinha_garrison19} to calculate \wprp for both our target galaxy samples and mock catalogs in 19 logarithmic bins between ${\rp>0.1\ \Mpch}$ and ${\rp \lesssim 44\ \Mpch}$. We also compute \wprp in additional bins at ${\rp<0.1\ \Mpch}$ but do not use these measurements for model fitting.

As our data samples are confined to narrow redshift bins of width ${\Delta z_{\rm phot} = 0.1}$, photometric redshift errors will cause some galaxies that belong to a given redshift bin to scatter into an adjacent bin and be excluded from the calculation of \wprp for their true bin. To account for this we adopt the method used by \citet{zhou_etal20b} (see their Figure 8):\ we use the Landy-Szalay estimator \citep{landy_szalay93} for the cross-correlation of two samples, $D_1$ and $D_2$:
%
\begin{equation}\label{eq:landy-szalay}
\wprp = 2\pimax\!\left(\frac{D_1D_2 - D_1R_2 - D_2R_1}{R_1R_2} + 1 \right).
\end{equation}

\noindent Each term of Eq.\ \ref{eq:landy-szalay} denotes pair counts between two samples, where $D$ and $R$ respectively indicate samples of data (i.e., galaxies) and random points with the same angular and redshift distributions as the corresponding data sample. Here $D_1$ is all galaxies within a given redshift bin: ${\zmin < \zphot < \zmax}$, where \zmin and \zmax are the limits of the bin, while $D_2$ is all galaxies within a wider redshift range defined by ${(\zmin-\pimax) < \zphot < (\zmax+\pimax)}$, where ${\pimax=150~\Mpch}$.
We verify our implementation of this method with \corrfunc by reproducing the projected correlation functions of DECaLS LRGs from \citet{zhou_etal20b} (see their Figure 9) using different clustering code.

DECaLS data include catalogs of random points with the same angular sky coverage and mask information as the survey footprint, which we use to construct our random samples. We use 20 times as many random as data points for each galaxy sample, and draw redshifts for random points from the redshift distribution of the corresponding data sample.

To measure \wprp of our mock catalogs we take advantage of the \corrfunc \texttt{theory} module, which can quickly calculate the autocorrelation function of a sample within a periodic volume using analytic random pair counts. We confirmed that this method produces the expected result by calculating \wprp of several mock catalogs directly from pair counts between mock galaxies and catalogs of random points constructed for the simulation volume.


\subsection{Jackknife error estimation and goodness-of-fit}\label{subsec:error}

To estimate the uncertainty of the \wprp measurements of our target galaxy samples we use \texttt{healpy}\footnote{healpix.sourceforge.net} \citep{gorski_etal05, zonca_etal19} with $N_{\rm side}=6$ to divide the angular sky coverage of each galaxy sample into $N_{\rm jk}$ regions of roughly equal area, suitable for jackknife resampling. We then measure \wprp in each jackknife sample, where each jackknife sample consists of the entire galaxy sample with one jackknife region removed, and compute the covariance matrix as follows:
%
\begin{equation}\label{eq:cov}
{\rm Cov}_{ij} = \frac{N_{\rm jk}-1}{N_{\rm jk}}
\sum^{N_{\rm jk}}_{\ell=1}\left(\omega^\ell_i-\overline{\omega}_i\right) \left(\omega^\ell_j-\overline{\omega}_j\right),
\end{equation}

\noindent where $\omega^\ell_i$ and $\omega^\ell_j$ are \wprp of the $\ell$th jackknife region for the $i$th and $j$th \rp bins, respectively, and $\overline{\omega}_i$ and $\overline{\omega}_j$ are the mean values of \wprp across all jackknife regions for the $i$th and $j$th \rp bins, respectively.

With the covariance matrix in hand we quantify how successful any instance of our model is at fitting the projected correlation function of the data by computing $\chi^2$ per degree of freedom $(\chisqred)$:
%
\begin{equation}\label{eq:chisq}
\chisqred=\frac{1}{\nu}\sum_{i=1}^{N_{r_{\rm p}}}
\sum_{j=1}^{N_{r_{\rm p}}}\left(\omega_i-\omega^{\rm mod}_i\right)
\!\left({\rm Cov}^{-1}\right)_{ij}\!\left(\omega_j-\omega^{\rm mod}_j\right)\!,
\end{equation}

\noindent where $N_{\rp}$ is the number of \rp bins used for fitting, $\nu$ is equal to $N_{\rp}$ minus the number of free model parameters, $\omega_i$ and $\omega_j$ are the data \wprp values in the $i$th and $j$th \rp bins, respectively, and $\omega^{\rm mod}_i$ and $\omega^{\rm mod}_j$ are the \wprp values of the relevant mock catalog in the $i$th and $j$th \rp bins, respectively.


\subsection{Luminosity assignment}\label{subsec:luminosity_assign}

\input{figures/fig_wp_mag_bins_ir}

\input{figures/fig_wp_mag_bins_opt}

\input{figures/fig_wp_full_sample}

\input{tables/table_scatter_params}

We use SHAM to create mock galaxy populations with the same number density and luminosity distribution of the parent galaxy sample by assuming the following relation:
%
\begin{equation}\label{eq:sham}
\neff(<M)=n_{\rm h}(>\vpeak),
\end{equation}
%
\noindent i.e., the (effective) number density of galaxies, \neff, of magnitude $M$ or brighter equals the number density of halos, $n_{\rm h}$, with circular velocity \vpeak or greater.

To assign absolute magnitudes to halos in each redshift bin we implement the following procedure:
%
\begin{enumerate}
\item \label{step:neff}
Compute for each parent galaxy sample the effective galaxy number density as a function of absolute magnitude in band ${X \in \{z, W1\}}$, $\neff(<M_X)$. We compute $\neff(<M_X)$ for each parent galaxy sample as follows. For each galaxy in the sample we calculate an effective volume, $V_{\rm eff}$:
%
\begin{equation}
{V_{\rm eff}(M_X) = f_\Omega \left( V_{\rm max}(M_X)-V_{\rm min} \right)},
\end{equation}
%
where $f_\Omega$ is the fractional solid angle covered by the parent galaxy sample, and $V_{\rm min}$ is the comoving volume of the lower limit of the redshift bin. $V_{\rm max}(M_X)$ is the comoving volume of either the upper limit of the redshift bin, or of the maximum possible redshift a galaxy of magnitude $M_X$ could have and still be observed at the magnitude limit of the sample, whichever is smaller.
The effective galaxy number density is the sum of the inverse of $V_{\rm eff}(M_X)$ over all galaxies in the sample:
%
\begin{equation}\label{eq:neff}
  \neff(<M_X) = \sum_i \left[ V^i_{\rm eff}(M_X) \right]^{-1}.
\end{equation}
%
\item \label{step:nh}
Assign absolute magnitudes to mock galaxies with no scatter in the luminosity--\vpeak relation according to Eq.\ \ref{eq:sham}. For each halo we find the cumulative number density $n_{\rm h}(>\vpeak)$ corresponding to its value of \vpeak. We then assign to each halo a mock galaxy with the absolute magnitude $M_X$ at which the effective number density $\neff(<M_X)$ of the parent galaxy sample equals $n_{\rm h}(>\vpeak)$.
%
\item \label{step:sham_scatter}
To incorporate magnitude-dependent scatter into the luminosity--\vpeak relation, we assign to each mock galaxy a new absolute magnitude, $M'_X$, where $M'_X$ is drawn from a Gaussian distribution centered at $M_X$ with width \sigmamag. \sigmamag is proportional to the absolute value of $M_X$, and the constant of proportionality is a free parameter in the model.
We then rank order all mock galaxies (including their \vpeak values) by $M'_X$, rank order the original distribution of mock magnitudes $M_X$, and assign the ordered original mock magnitude distribution to the mock galaxy catalog ordered by $M'_X$. This method incorporates scatter into the luminosity--\vpeak relation while replicating the target luminosity function exactly in the resulting mock galaxy catalog.
%
\item \label{step:los_scatter}
Scatter the positions of mock galaxies along one of the three axes of the simulation volume to mimic the uncertainty in radial (line-of-sight) position of our target galaxy samples due to photometric redshift errors.
For each mock galaxy we draw a ``scattered" coordinate $x'$ from a Gaussian distribution of width \sigmalos centered at the galaxy's original $x$ position.
Mock galaxies that scatter out of the simulation volume of $1~h^{-3}\ {\rm Gpc}^3$ are wrapped back in to preserve the periodic boundary conditions, e.g., a mock galaxy at $x=25~\Mpch$ that scatters to $x'=-50~\Mpch$ is placed at $x=950~\Mpch$.
We repeat this process for the other two simulation axes (i.e., $y$ and $z$).
%
\item \label{step:model_wp}
For each mock catalog, compute the projected correlation function, \wprp (see \S\ref{subsec:wprp}), averaged over the three axes of the simulation volume as described in the previous step.
We then compute the goodness-of-fit per degree of freedom, \chisqred (see \S\ref{subsec:error}), of the model fit to the mean \wprp of the relevant parent galaxy sample. We measure \chisqred for each mean \wprp in bins of absolute magnitude ($M_z$ or $M_{W1}$).
%
\item \label{step:model_refine}
Repeat steps \ref{step:sham_scatter} through \ref{step:model_wp} for additional values of \sigmamag and \sigmalos as needed to minimize \chisqred in each luminosity bin. In practice we first coarsely sample a wide range of values of \sigmamag and \sigmalos:
%
\begin{subequations}
  \begin{align}
    0 \leq \frac{\sigmamag}{|M_X|} \leq 1.0,\ & \Delta \!\! \left[\frac{\sigmamag}{|M_X|}\right]=0.1 \\
    0 \leq \sigmalos \leq 150~\Mpch,\ & \Delta \sigmalos=10~\Mpch.
  \end{align}
\end{subequations}
%
We then more densely sample (using $\Delta(\sigmamag/|M_X|)=0.01$ and ${\Delta \sigmalos=5~\Mpch}$) narrower ranges of both parameters around the initial coarse-grained values that minimize \chisqred.
%
\item \label{step:sigma_linear}
Finally, identify the value of \sigmamag that coincides with the region of \sigmamag--\sigmalos parameter space containing the minimum \chisqred across all luminosity bins, and parameterize the dependence of \sigmalos on absolute magnitude, $M_X$, as follows:
%
\begin{equation}\label{eq:sigmalos}
  \sigmalos(M_X) = s_{\rm LOS}\, M_X + \sigma_{{\rm LOS},0}.
\end{equation}
%
\noindent The best-fit values of \sigmamag, $s_{\rm LOS}$, and $\sigma_{{\rm LOS},0}$ are given in Table~\ref{tab:scatter_params}. The values of $s_{\rm LOS}$ and $\sigma_{{\rm LOS},0}$ are determined by linear fits to $\sigmalos^i$ versus $\langle M^i_X \rangle$, where $\sigmalos^i$ are the values that minimize \chisqred of \wprp at fixed \sigmamag\footnote{We tested using \sigmamag with linear dependence on absolute magnitude instead of a constant value across all luminosity bins, and found that fixing \sigmamag while allowing \sigmalos to scale linearly with luminosity reproduces \wprp (\S\ref{subsec:wprp}) better than if both parameters have linear luminosity dependence.} in the $i$th luminosity bin, $M^i_X$.
\end{enumerate}

The luminosity assignment stage of our modeling procedure involves three free parameters, \sigmamag, $s_{\rm LOS}$, and $\sigma_{{\rm LOS},0}$, which account for scatter in the luminosity--\vcirc relation and photometric redshift errors of our target galaxy samples. We constrain these parameters by fitting the projected correlation functions of mock galaxy catalogs created from our model to those of the corresponding parent galaxy samples.

Figures~\ref{fig:wp_mag_bins_ir} and \ref{fig:wp_mag_bins_opt} show \wprp for the $W1$- and $z$-band absolute magnitude-limited parent galaxy samples, respectively, and corresponding mock galaxy catalogs. The agreement between the data and model increases with increasing luminosity within each redshift bin, and with increasing redshift overall.

The clustering of the full magnitude-limited parent galaxy samples and corresponding mock catalogs is shown for each redshift bin in Figure~\ref{fig:wp_full_sample}, with \wprp for each redshift bin offset by 0.15 dex for clarity. Agreement between the model and data increases with increasing redshift. We emphasize that while the model \wprp deviates from that of the data for the full magnitude-limited parent samples in the ${0.4 < \zphot < 0.5}$ redshift bin, there is still good data--model agreement within the highest luminosity bins, where the vast majority of LRGs reside, for both the $W1$- and $z$-band models (Figures~\ref{fig:wp_mag_bins_ir} and \ref{fig:wp_mag_bins_opt}, respectively).


\subsection{Color assignment}\label{subsec:color_assign}

\input{figures/fig_color_assign}

Figure~\ref{fig:color_assign} shows an illustration of our color assignment algorithm (Eq.\ \ref{eq:color_assign}) with age distribution matching for the ${0.4<\zphot<0.5}$ redshift bin of the $z$-band model. The dotted purple curve is the cumulative distribution of $^{0.43}(r-z)$ color for galaxies in the $-23.0 > {^{0.43}M_z} > -23.05$ luminosity bin, and the solid gray curve is the halo \zstarve distribution of $\zsim=0.425$ mock galaxies in the same model luminosity bin. The magenta arrows in Figure~\ref{fig:color_assign} indicate that a mock galaxy in this luminosity bin in a halo with $\zstarve\approx2.6$ is assigned a $^{0.43}(r-z)$ color of 0.96.
%An equivalent procedure is used to assign ${r-W1}$ model colors at fixed $M_{W1}$ and in other redshift bins.

Implementation of the color assignment algorithm with no scatter in the color--\zstarve relationship yields mock LRG samples (see \S\ref{subsec:mock_lrg_select} below) that generally overpredict the clustering amplitude compared to the data, with the exception optical LRGs selected from the $W1$-band model (see Figure~\ref{fig:wp_lrg}). We tested the effect of introducing scatter into the color--\zstarve relation on the clustering of mock LRGs using an analogous method to how scatter is incorporated into the luminosity--\vpeak relation (see \S\ref{subsec:luminosity_assign}). After assigning model colors $\mathcal{C}$ without scatter according to Eq.\ \ref{eq:color_assign} as described above, we assign to each mock galaxy a new color $\mathcal{C}'$, where $\mathcal{C}'$ is drawn from a Gaussian distribution centered at $\mathcal{C}$ with width $\sigma_{\rm color}$. We then rank order all mock galaxies by $\mathcal{C}'$, rank order the original distribution of mock colors $\mathcal{C}$, and assign the ordered original color distribution to the mock galaxy catalog ordered by $\mathcal{C}'$.

For mock LRGs (both optical and IR) from the $z$-band model, as well as mock IR LRGs from the $W1$-band model, clustering amplitude decreases with increasing $\sigma_{\rm color}$ until $\sigma_{\rm color}$ is sufficiently large that model colors are effectively assigned at random, at which point the decrease in clustering amplitude levels off at a constant value that still overpredicts \wprp relative to the data.
The exception to this is the predicted clustering of mock optical LRGs from the $W1$-band model, which largely agrees with the data with \emph{no} scatter in the color--\zstarve relation.
Additionally, $\sigma_{\rm color} > 0$ in this instance does \emph{not} affect the predicted clustering amplitude of mock optical LRGs.
This implies that color is uncorrelated with halo age for LRGs, which we discuss further in \S\ref{subsec:clust_lrg}, and motivates our decision to proceed with two versions of our models (rather than introduce and constrain $\sigma_{\rm color}$ as an additional parameter):\
(1) a ``default" age distribution model, in which galaxy color increases monotonically with increasing halo \zstarve at fixed luminosity (i.e., $\sigma_{\rm color} = 0$), and (2) a ``random color'' model, in which there is no correlation between galaxy color and halo \zstarve.
Both models yield magnitude-limited mock galaxy catalogs with identical color--magnitude distributions that reproduce the target distribution of the relevant data; the only difference is whether galaxy color is maximally correlated (default model) or entirely uncorrelated (random color model) with halo \zstarve.


\subsection{Selecting mock LRGs}\label{subsec:mock_lrg_select}

\input{figures/fig_lrg_frac}

\input{figures/fig_not-lrg_outliers}

DESI LRG target selection (see \S\ref{subsec:lrg_target_select} above) is entirely a function of apparent $g$, $r$, $z$, and $W1$ (and $z_{\rm fiber}$) magnitudes. As such it would be ideal to have mock galaxy catalogs with each of these model magnitudes for every galaxy; mock LRG samples could then be obtained simply by applying the DESI LRG target selection functions (Eqs.\ \ref{eq:lrg_opt} and \ref{eq:lrg_ir}) to the full mock for each redshift bin. However the SHAM and age distribution matching techniques we employ create mock galaxy catalogs with absolute $z$- or $W1$-band magnitudes and corresponding ${r-z}$ or ${r-W1}$ colors.

To select mock DESI LRG targets using only these model quantities we first identify where actual DESI LRG targets reside in $K$-corrected color--magnitude space in each redshift bin for both optical and IR DESI LRG targets. In each redshift bin we compute the fractions of galaxies that are optical and IR DESI LRG targets in narrow two-dimensional bins in color--magnitude space. This is shown in Figure~\ref{fig:lrg_frac}.

We then use these optical and IR LRG fractions in color--magnitude space to statistically select mock optical and IR LRGs from our mock galaxy catalogs in the corresponding model color--magnitude space, i.e., in each color--magnitude bin we draw mock galaxies and flag them as LRGs until the LRG fraction in that bin matches the value from the data.

It is worth noting that the LRG fraction in most of color--magnitude space is either $\sim0$ or $\sim1$ by design, especially for optical LRGs in ${r-z}$ versus $M_z$ (i.e., optical) space, and IR LRGs in ${r-W1}$ versus $M_{\rm W1}$ (i.e., IR) space. This is clearly shown in Figure~\ref{fig:lrg_frac}.

The first and second columns of Figure~\ref{fig:lrg_frac} show the fractions of optical and IR LRG targets, respectively, in optical space, i.e., ${r-z}$ color versus $M_z$ magnitude, and the red sequence is clearly visible in each panel. For example, in the ${0.4<\zphot<0.5}$ redshift bin the red sequence corresponds almost entirely to the region where the LRG fraction is $\sim1$, i.e., where ${M_z \lesssim -22.5}$ and ${r-z}$ is between $\sim0.9$ and $\sim1.3$ (with a shift toward redder colors in higher redshift bins).

Interestingly, the LRG fraction begins to deviate from $\sim1$ in the \emph{most luminous} region of optical space ($M_z\lesssim-23.7$), and this is true for both optical and IR LRG targets.
Both selections (Eqs.\ \ref{eq:lrg_opt} and \ref{eq:lrg_ir}) exclude some of the most luminous red-sequence objects in optical space, but \emph{not} in IR space (third and fourth columns of Fig.~\ref{fig:lrg_frac}).

To investigate why these luminous, red-sequence objects in the first two columns of Figure~\ref{fig:lrg_frac}) are not selected as DESI LRG targets we looked at their positions in color--color and color--magnitude space relative to the full set of DESI LRG target selection cuts (Eqs.\ \ref{eq:lrg_opt} and \ref{eq:lrg_ir}).
This is shown in Figure~\ref{fig:not-lrg_outliers}, where light blue and gray contours in each panel show the distributions of \emph{all} optical and IR DESI LRG targets with photometric redshifts between 0.4 and 0.7.

The color-coded points in each panel are luminous (${M_z<-23.7}$), red-sequence objects in the same redshift range that are \emph{not} DESI LRG targets despite passing the stellar cut (Eqs.\ \ref{eq:lrg_opt_stellar} and \ref{eq:lrg_ir_stellar}; solid black line in panel (a))
and the optical and IR color--magnitude cuts (Eq.\ \ref{eq:lrg_opt_color-mag}; dashed black line in panel (e), and Eq.\ \ref{eq:lrg_ir_color-mag}; solid black line in panel (b)),
as well as the $z_{\rm fiber}$ cut (Eqs.\ \ref{eq:lrg_opt_fiber} and \ref{eq:lrg_ir_fiber}; not shown).

Panel (d) of Figure~\ref{fig:not-lrg_outliers} shows that the low-redshift or blue color cut (Eqs.\ \ref{eq:lrg_opt_lowz} and \ref{eq:lrg_ir_lowz}) excludes these objects from selection as DESI LRG targets.