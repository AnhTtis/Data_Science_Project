\documentclass[10pt]{article}
\usepackage{amsfonts}
\usepackage{mathrsfs}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{float}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{mathrsfs}
%\usepackage{txfonts}
\usepackage{color}
\usepackage{mathrsfs,amscd,amssymb,amsthm,amsmath,bm,graphicx,psfrag,subfigure,url}
%\input{psfig.sty}
%\input{bibnames.sty}

\setlength{\evensidemargin}{-2.5cm} \setlength{\oddsidemargin}{-5mm}
\setlength{\textwidth}{17.3cm} \setlength{\textheight}{23cm}
\setlength{\headsep}{1.4mm}

\makeatletter

\renewcommand{\@seccntformat}[1]{{\csname the#1\endcsname}{\normalsize .}\hspace{.5em}}
\makeatother
\renewcommand{\thesection}{\normalsize \arabic{section}}
\renewcommand{\refname}{\normalsize \bf{References}}
\renewcommand{\thefootnote}{\fnsymbol{footnote}}

\usepackage{indentfirst}
\def\theequation{\thesection.\arabic{equation}}
\def \[{\begin{equation}}
	\def\]{\end{equation}}
\def \mi{{\rm mi}}
\newtheorem{thm}{Theorem}[section]
\newtheorem{prop}{Proposition}
\newtheorem{defi}{Definition}
\newtheorem{claim}{Claim}
\newtheorem{fact}{Fact}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{cor}[thm]{Corollary}
\newtheorem{ex}[thm]{Example}
\newtheorem{pb}[thm]{Problem}
\newtheorem{res}[thm]{Research Problem}
\newtheorem{conj}[thm]{Conjecture}
\newtheorem{remark}{Remark}
\newenvironment{kst}
{\setlength{\leftmargini}{2\parindent}
	\begin{itemize}
		\setlength{\itemsep}{-1.1mm}}
	{\end{itemize}}

\newenvironment{lst}
{\setlength{\leftmargini}{0.85\parindent}
	\begin{itemize}
		\setlength{\itemsep}{-1.1mm}}
	{\end{itemize}}

\newenvironment{wst}
{\setlength{\leftmargini}{1.5\parindent}
	\begin{itemize}
		\setlength{\itemsep}{-1.1mm}}
	{\end{itemize}}
%\def\qed{\nopagebreak\hfill{\rule{4pt}{7pt}}}
\begin{document}
	
	\begin{center}
		\setlength{\baselineskip}{15pt}
		{\Large \bf {The asymptotic formulae of sums of two smooth squares for divisor function}}
		
		{\large Nanxiang Wang $^{a}$\ \ Haobo Dai $^{a}$\footnote{Corresponding author. \\ \hspace*{5mm}{\it Email addresses} :dedekindbest@126.com} \ \   }\vspace{2mm}
		\setcounter{section}{0}
	
	School of Mathematics and Big Data, Anhui University of Science and Technology, Huainan, China
	\end{center}
	\noindent {\bf Abstract}:
	A natural number $n$ is $y$-smooth if the greatest prime factor of $n$ does not exceed $y$. Let $s_{1}$ and $s_{2}$ are $y$-smooth numbers. We consider sums of smooth squares of the binary Titchmarsh divisor problem and give asymptotic formulae for $\sum_{s_{1}^{2}+s_{2}^{2}\le x}\tau(s_{1}^{2}+s_{2}^{2}+1)$ for $(\log x)^{K}\le y<x^{\frac{1}{2}}$,  where $K$ is large enough.
	
	\vspace{2mm} 
	
	\noindent{\bf Keywords}: sums of squares; smooth numbers; divisor function
	\begin{center}
		\section{\normalsize Introduction}
	\end{center}
	Let $\tau(n)=\sum_{d|n}1$ be the divisor function.
	The Titchmarsh divisor problem is concerned with finding an asymptotic formula for the average
	$$\sum_{p\le x}\tau(p-1),$$
	where $p$ belongs to the set of primes. 
	Under the Generalized Riemann Hypothesis
	(GRH), Titchmarsh[16] proved that
	$$\sum_{p\le x}\tau(p-1)=\frac{\zeta(2)\zeta(3)}{\zeta(6)}x+O\left(\frac{x\log\log x}{\log x}\right).$$
	Bombieri, Friedlander and Iwaniec[2] as well as Fouvry[4]  improved Titchmarsh's result to
	$$\sum_{p\le x}\tau(p-1)=\frac{\zeta(2)\zeta(3)}{\zeta(6)}x+cLi(x)+O\left(\frac{x}{(\log x)^{A}}\right),$$ 
	where $c$ and $A$ are constants, $Li(x)=\int_{2}^{x}\frac{dt}{\log t}$.
	In [11], Li considered a binary quadratic Titchmarsh divisor function. He proved that
	$$\sum_{p^{2}+q^{2}\le N}\tau(p^{2}+q^{2}+1)=\frac{\pi}{4}\prod_{p>2}\left(1-\frac{1+3p\left(\frac{-1}{p}\right)}{(p-1)^{2}p}\right)\frac{N}{\log N}\left(1+O\left(\frac{(\log\log N)^{2}}{\log N}\right)\right)$$
	for $N$ large enough, where $p$ and $q$ belong to the set of primes.
	Let $s_{1}, s_{2}$ be $y$-smooth numbers .
	In this paper, we give asymptotic formulae for
	$$\sum_{s_{1}^{2}+s_{2}^{2}\le x}\tau(s_{1}^{2}+s_{2}^{2}+1).$$
	Our main results are following theorems:
	\begin{thm}
		Let $s_{1}$, $s_{2}$ be $y$-smooth numbers, $x^{\frac{1}{K}}\le y<x^{\frac{1}{2}}$, $K$ be large enough.
		As $x\to\infty$, one has
		$$\sum_{s_{1}^{2}+s_{2}^{2}\le x}\tau(s_{1}^{2}+s_{2}^{2}+1)=C_{1}\frac{\pi}{4}\rho\left(\frac{\log x}{2\log y}\right)^{2}x\log x+O(x(\log\log x)^{2})$$
		where $$C_{1}=\frac{3}{4}\left(\prod_{p\equiv1\bmod{4}}\left(1-\frac{1}{p^{2}}\right)\right)\left(\prod_{p\equiv3\bmod{4}}\left(1+\frac{1}{p}+\frac{2}{p^{2}-p}\right)\left(1-\frac{1}{p}\right)\right)$$
		is convergent. 
	\end{thm}
	\begin{thm}
		Let $s_{1}$, $s_{2}$ be $y$-smooth numbers, $(\log x)^{K}\le y\le e^{(\log\log x)^{\frac{31}{15}}}$, $K$ be large enough. Then one has
		$$\sum_{s_{1}^{2}+s_{2}^{2}\le x}\tau(s_{1}^{2}+s_{2}^{2}+1)=\frac{\alpha_{1}}{2} B\left(\frac{\alpha_{1}}{2},\,\frac{\alpha_{1}}{2}+1\right)\mathfrak{S}(F)\Psi(\sqrt{x},\,y)^{2}\log x+O\left(\frac{\Psi(\sqrt{x},\,y)^{2}\log y(\log x)^{\sqrt{2}-1}}{\left(\log\frac{\log x}{2\log y}\right)}\right),$$
		where
		$$\mathfrak{S}(F)=\frac{2^{\alpha_{1}-1}-2^{-\alpha_{1}+1}C_{2}}{2^{\alpha_{1}}}$$	
		is convergent.
		Here $\alpha_{1}=\alpha(\sqrt{x},y)$ is defined by$$\sum_{p\le y}\frac{\log p}{p^{\alpha(x,y)}-1}=\log x,$$ 
		$C_{2}$ is defined in (3.8).
	\end{thm}
	\begin{thm}
		Let $s_{1}$, $s_{2}$ are $y$-smooth numbers, $e^{(\log\log x)^{\frac{31}{15}}}\le y\le x^{\frac{1}{K}}$. As $x\to\infty$, one has
		$$\sum_{s_{1}^{2}+s_{2}^{2}\le x}\tau(s_{1}^{2}+s_{2}^{2}+1)=\frac{\pi}{4}C_{1}x\rho\left(\frac{\log x}{2\log y}\right)^{2}\log x+O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)^{2}\log x}{\log y}\right).$$
	\end{thm}
	\begin{center}
	\section{\normalsize The proof of Theorem 1.1}
\end{center}
In this section we summarize here some lemmas on the distribution of smooth numbers firstly. Let $P(k)$ denote the greatest prime factor of the natural number $k\ge2$, and put $P(1)=1$, $P(0)=\infty$. 
Let
\begin{eqnarray}
	\Psi(x,\,y;\,q,\,a)&=&\#\{k\leq x:\,k\equiv a\bmod{q},\,P(k)\leq y\},\\
	\Psi_{q}(x,\,y)&=&\#\{k\leq x:\,(k,\,q)=1,\,P(k)\leq y\}.
\end{eqnarray}
Fouvry and Tenenbaum[5] have shown that for $(q,\,a)=1$ one has
$$\Psi(x,\,y;\,q,\,a)-\frac{\Psi_{q}(x,\,y)}{\varphi(q)}\ll\frac{x}{(\log x)^{A}}.$$ Note that there is no restriction on the ranges of $q$, $x$, or $y$ here.
However, $q$ and $a$ may have common factors, therefore we put 
$$E(x,\,y;\,q,\,a)=\varphi\left(\frac{q}{(q,\,a)}\right)^{-1}\Psi_{\frac{q}{(q,\,a)}}\left(\frac{x}{(q,\,a)}\right)-\Psi(x,\,y;\,q,\,a).$$
Observe that 
$$\Psi(x,\,y;\,q,\,a)=\Psi\left(\frac{x}{(q,\,a)},\,y;\,\frac{q}{(q,\,a)},\,\frac{a}{(q,\,a)}\right)$$
unless $P((q,\,a))>y$. Then whenever $(q,\,a)=1$, $E(x,\,y;\,q,\,a)=\Psi_{q}(x,\,y)-\Psi(x,\,y;\,q,\,a)$.        Hence the definition of $E(x,\,y;\,q,\,a)$ is valid.
\begin{lem}
	Let $0<\delta<1$, $A>0$. Then, whenever $x^{\delta}\leq y\leq x$, one has
	$$E(x,\,y;q,a)\ll x(\log x)^{-A}.$$
\end{lem}
\begin{proof}
	See [1, Lemma 2.1].
\end{proof}
\begin{lem}
	Let $0<\delta<1$ and $A>0$. Then, whenever $x^{\delta}\leq y\leq x$, one has
	$$\sum_{q\leq Q}\sum_{\substack{a=1 \\ (q,\,a)=1}}^{q}E(x,\,y;\,q,\,a)^2\ll Qx+x^{2}(\log x)^{-A}.$$
\end{lem}
\begin{proof}
	See [1, Lemma 2.2].
\end{proof}
\par 
And there is a trivial bound about $E$, that is
$$E(x+h,\,y;\,q,\,a)-E(x,\,y;\,q,\,a)\ll\frac{h}{q}+1.$$ 
It follows from the definition of $E$, (2.1), (2.2), and there is at most $O\left(\frac{h}{q}+1\right)$ integers in an interval of length $h$ belong to an arithmetic progression of modulus $q$.
\begin{lem}
	Let $0<\delta<1$, $\rho$ be the Dickman function, $\gamma$ be the Euler's constant,  and $\Pi(q)=\sum_{p|q}\frac{\log p}{p-1}$, where $p$ is prime.
	Then for $x^{\delta}\leq y\leq X$ and any $a$, $q$ with $q\leq x^{A}$,
	one has 
	$$\Psi(x,y;q,a)=\frac{x}{q}\left(\rho\left(\frac{\log\left(\frac{x}{(q,a)}\right)}{\log y}\right)+\rho'\left(\frac{\log\left(\frac{x}{(q,a)}\right)}{\log y}\right)\frac{\Pi\left(\frac{q}{(q,a)}\right)+\gamma-1}{\log y}\right)-E(x,y;q,a)+O\left(\frac{x\left(\log\log x\right)^{3}}{q\left(\log y\right)^{2}}\right).$$
\end{lem}
\begin{proof}
	See [1, Lemma 2.3].
\end{proof}
\begin{lem}
	Fix $k\ge0$, $0\le c<1$, and $\kappa\in\mathbb{C}$, and consider a multiplicative function $f$ such that $|f|\le\tau_{k}$,
	$$\sum_{p\le x}\frac{f(p)\log p}{p}=\kappa\log x+O(1)\quad\quad(x\ge2)$$
	and
	$$\sum_{p\le x}\frac{|f(p)|-\Re(f(p))}{p}\le c\log\log x+O(1)\quad\quad(x\ge2),$$
	where $\tau_{k}(n)=\sum_{d|n}\tau_{k-1}(d)$, $\tau_{0}(n)=\tau(n)=\sum_{d|n}1$.
	
	We then have 
	$$\sum_{n\le x}\frac{f(n)}{n}=\frac{\mathfrak{S}(f)}{\Gamma(\kappa+1)}(\log x)^{\kappa}+O((\log x)^{Re(\kappa)+c-1}),$$
	where
	$$\mathfrak{S}(f)=\prod_{p}\left(1-\frac{1}{p}\right)^{\kappa}\left(1+\frac{f(p)}{p}+\frac{f(p^{2})}{p^{2}}+...\right).$$
\end{lem}
\begin{proof}
	See [10, Theorem 14.3].
\end{proof}
\begin{lem}
	Let $n\in\mathbb{N^{+}}$, $p^{l}|q$ where $p$ is an odd prime number. And $\lambda_{n}(q)$ is an arithmetic function defined by 
	$$q\lambda_{n}(q)=\#\{1\leq a_{1}, \,a_{2}\leq q:\,a_{1}^{2}+a_{2}^{2}\equiv n\bmod{q}\}.$$ 
	One has
	$$\lambda_{n}(p^{l})=\sum_{k=0}^{l}\chi(p)^{k}p^{-k}c_{p^{k}}(n),$$
	where $$c_{q}(n)=\sum_{\substack{a=  1\\(a,q)=1}}^{q}e\left(\frac{an}{q}\right).$$
	
\end{lem}
\begin{proof}
	See [1, Lemma 2.8].
\end{proof}
By Hardy and Wright[6, Theorem 67 and 272], one has
$$c_{q}(n)=\varphi(q)\frac{\mu\left(\frac{q}{(q,\,n)}\right)}{\varphi\left(\frac{q}{(q,\,n)}\right)}.$$
\begin{lem}
	One has
	$$\sum_{d\le x}\frac{\lambda_{d-1}(d)}{d}=C_{2}\log x+O(1)$$
	where $$C_{1}=\frac{3}{4}\left(\prod_{p\equiv1\bmod{4}}\left(1-\frac{1}{p^{2}}\right)\right)\left(\prod_{p\equiv3\bmod{4}}\left(1+\frac{1}{p}+\frac{2}{p^{2}-p}\right)\left(1-\frac{1}{p}\right)\right).$$ 
\end{lem}
\begin{proof}
	Let $g(d)=\frac{d\lambda_{d-1}(d)}{d}=\lambda_{d-1}(d)$, $p$ be an odd prime number, $p^{l}|d$, $l\ge1$, $\chi$ be the non-principal character modulo 4.
	Then we have
	$$\lambda_{d-1}(p^{l})=\sum_{k=0}^{l}\chi(p)^{k}p^{-k}c_{p^{k}}(d-1)=\sum_{k=0}^{l}\chi(p)^{k}p^{-k}\mu(p^{k}).$$
	By Chinese Remainder Theorem we have $g(d)$ is multiplicative. And it is easy to see that $g(d)\le\tau(d)$.
	Hence if $p\equiv1\bmod{4}$, $\lambda_{d-1}(p^{l})=1-\frac{1}{p}$, if $p\equiv3\bmod{4}$, $\lambda_{d-1}(p^{l})=1+\frac{1}{p}$.
	By the definition of  $\lambda_{d-1}(2)$, we have
	$\lambda_{d-1}(2)=1$.
	Let us consider the congruence equation
	$$u^{2}+v^{2}\equiv-1\bmod{2^{l}}, \,l\ge2.$$
	If the equation has solutions, then $u$, $v$ will not be all even nor odd. Let $u=2n$, $v=2m+1$, $m$, $n$ are positive integers.
	Then we have $u^{2}+v^{2}\equiv1\bmod{4}$. But the right-hand side of the above equation is $-1\bmod{4}$. It has produced a contradiction. Therefore we get $$2^{l}\lambda_{d-1}(2^{l})=0, \,l\ge2.$$ 
	Thus $$\lambda_{d-1}(2^{l})=0, \,l\ge2.$$
	Therefore by Lemma 2.4 we have
	$$\sum_{p\le x}\frac{g(p)\log p}{p}=\frac{\log 2}{2}+\sum_{\substack{p\ne2\\p\le x}}\frac{\log p}{p}-\sum_{\substack{p\le x\\p\equiv1\bmod{4}}}\frac{\log p}{p^{2}}+\sum_{\substack{p\le x\\p\equiv3\bmod{4}}}\frac{\log p}{p^{2}}=\log x+O(1).$$
	It means $\kappa=1$.
	And then we show that $\mathfrak{S}(g)$ is convergent. By Lemma 2.4, we have
	\begin{eqnarray*}
		\mathfrak{S}(g)&=&\prod_{p}\left(1-\frac{1}{p}\right)\left(1+\frac{g(p)}{p}+\frac{g(p^{2})}{p^{2}}+...\right)\\
		&=&\frac{3}{4}\left(\prod_{p\equiv1\bmod{4}}\left(1-\frac{1}{p^{2}}\right)\right)\left(\prod_{p\equiv3\bmod{4}}\left(1+\frac{1}{p}+\frac{2}{p^{2}-p}\right)\left(1-\frac{1}{p}\right)\right).\\
		\prod_{p\equiv1\bmod{4}}\left(1-\frac{1}{p^2}\right)&=&O(1),\\
		\prod_{p\equiv3\bmod{4}}\left(1-\frac{1}{p}\right)\left(1+\frac{1}{p}+\frac{2}{p^{2}-p}\right)&=&\prod_{p\equiv3\bmod{4}}\left(1-\frac{1}{p}\right)\left(1+\frac{1}{p}+O\left(\frac{1}{p^{2}}\right)\right)=O(1).
	\end{eqnarray*}
	Hence $\mathfrak{S}(g)$ is convergent, let $\mathfrak{S}(g)=C_{1}$.
	Therefore
	$$\sum_{d\le x}\frac{\lambda_{d-1}(d)}{d}=\sum_{d\le x}\frac{g(d)}{d}=C_{2}\log x+O(1).$$
\end{proof}
\begin{lem}
	Let $Q$, $L>0$. One has 
	$$\sum_{q\leq Q}\sum_{\substack{a_{1},a_{2}\bmod{q}\\a_{1}^{2}+a_{2}^{2}\equiv n\bmod{q}\\(a_{1},q)>L}}\frac{1}{q^{2}}\ll L^{-\frac{1}{3}}(\log Q)^{4}.$$
\end{lem}
\begin{proof}
	See [1, Lemma 2.12].
\end{proof}
Now we start to prove Theorem 1.1.
To simplify the notations, let
\begin{eqnarray*}
	\mathfrak{A}&=&s_{1}^{2}+s_{2}^{2},\\
	S(x)&=&\sum_{s_{1}^{2}+s_{2}^{2}\le x}\tau(s_{1}^{2}+s_{2}^{2}+1).
\end{eqnarray*} 
By using Dirichlet's hyperbola method, we split $S(x)$ into three parts.
Let
\begin{eqnarray*}
	\sigma_{1}(\mathfrak{A})&=&\sum_{\substack{d|\mathfrak{A}+1\\d\le\frac{\sqrt{\mathfrak{A}+1}}{(\log x)^{100}}}}1,\\
	\sigma_{2}(\mathfrak{A})&=&\sum_{\substack{d|\mathfrak{A}+1\\\frac{\sqrt{\mathfrak{A}+1}}{(\log x)^{100}}<d<\sqrt{\mathfrak{A}+1}(\log x)^{100}}}1,\\
	\sigma_{3}(\mathfrak{A})&=&\sum_{\substack{d|\mathfrak{A}+1\\d\ge\sqrt{\mathfrak{A}+1}(\log x)^{100}}}1.
\end{eqnarray*}
Then we have
$$S(x)=\sum_{\mathfrak{A}\le x}\tau(\mathfrak{A}+1)\\
=\sum_{\mathfrak{A}\le x}\sum_{d|\mathfrak{A}+1}1\\
=\sum_{\mathfrak{A}\le x}\sum_{i=1}^{3}\sigma_{i}(n).$$
By the property of divisor function, we have
$$\sigma_{3}(\mathfrak{A})=\sum_{\substack{d|\mathfrak{A}+1\\d\ge\sqrt{\mathfrak{A}+1}(\log x)^{100}}}1=\sum_{\substack{\delta d=\mathfrak{A}+1\\\delta\le\frac{\sqrt{\mathfrak{A}+1}}{(\log x)^{100}}}}1=\sum_{\substack{\delta|\mathfrak{A}+1\\\delta\le\frac{\sqrt{\mathfrak{A}+1}}{(\log x)^{100}}}}1=\sigma_{1}(\mathfrak{A}).$$
Therefore we can show that
\begin{eqnarray*}
	S(x)&=&2\sum_{\mathfrak{A}\le x}\sigma_{1}(\mathfrak{A})+\sum_{\mathfrak{A}\le x}\sigma_{2}(\mathfrak{A})\\
	&=&2M(x)+R(x),
\end{eqnarray*}
where 
\begin{eqnarray*}
	M(x)&=&\sum_{\mathfrak{A}\le x}\sigma_{1}(\mathfrak{A}),\\
	R(x)&=&\sum_{\mathfrak{A}\le x}\sigma_{2}(\mathfrak{A}).
\end{eqnarray*}
It is not hard to get that
$$\sum_{\substack{\mathfrak{A}\le x\\s_{1}\equiv u\bmod{d}\\s_{2}\equiv v\bmod{d}}}1\le\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x}\\s_{2}\equiv v\bmod{d}}}1\ll\frac{x}{d^{2}}.$$
Let 
\begin{eqnarray*}
	R_{1}(x)&=&\sum_{\mathfrak{A}\le\frac{x}{(\log x)^{100}}}\sum_{\substack{d|\mathfrak{A}+1\\\frac{\sqrt{\mathfrak{A}+1}}{(\log x)^{100}}<d<\sqrt{\mathfrak{A}+1}(\log x)^{100}}}1,\\
	R_{2}(x)&=&\sum_{\frac{x}{(\log x)^{100}}<\mathfrak{A}\le x}\sum_{\substack{d|\mathfrak{A}+1\\\frac{\sqrt{\mathfrak{A}}+1}{(\log x)^{100}}<d<\sqrt{\mathfrak{A}+1}(\log x)^{100}}}1.\\
\end{eqnarray*}
Then we have 
\begin{eqnarray*}
	\sum_{\mathfrak{A}\le x}\sigma_{2}(\mathfrak{A})&=&\sum_{\mathfrak{A}\le x}\sum_{\substack{d|\mathfrak{A}+1\\\frac{\sqrt{\mathfrak{A}+1}}{(\log x)^{100}}<d<\sqrt{\mathfrak{A}+1}(\log x)^{100}}}1\\
	&=&R_{1}(x)+R_{2}(x).
\end{eqnarray*} 
Now we estimate $R_{1}(x)$ firstly. By Lemma 2.6 we have
\begin{eqnarray*}
	\sum_{\mathfrak{A}\le\frac{x}{(\log x)^{100}}}\sum_{\substack{d|\mathfrak{A}+1\\\frac{\sqrt{\mathfrak{A}+1}}{(\log x)^{100}}<d<\sqrt{\mathfrak{A}+1}(\log x)^{100}}}1
	&\ll&\sum_{d\le\frac{\sqrt{x+1}}{(\log x)^{50}}}\sum_{\substack{\mathfrak{A}\le\frac{x}{(\log x)^{100}}\\\mathfrak{A}\equiv-1\bmod{d}}}1\\
	&\ll&\sum_{d\le\frac{\sqrt{x+1}}{(\log x)^{50}}}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{\mathfrak{A}\le\frac{x}{(\log x)^{100}}\\s_{1}\equiv u\bmod{d}\\s_{2}\equiv v\bmod{d}}}1\\
	&\ll&\frac{x}{(\log x)^{100}}\sum_{d\le\frac{\sqrt{x+1}}{(\log x)^{50}}}\frac{\lambda_{d-1}(d)}{d}\\
	&\ll&\frac{x}{(\log x)^{99}}.
\end{eqnarray*}
Hence $R_{1}(x)=O\left(\frac{x}{(\log x)^{99}}\right)$. And analogous estimate holding for $R_{2}(x)$, we have  $R_{2}(x)=O(x\log\log x)$. Therefore
$$S(x)=2M(x)+O(x\log\log x).$$
Let $Q=\frac{\sqrt{x+1}}{(\log x)^{100}}$, we have 
\begin{eqnarray*}
	M(x)&=&\sum_{d\le Q}d\lambda_{d-1} (d)\sum_{\substack{\mathfrak{A}\le x\\s_{1}\equiv u\bmod{d}\\s_{2}\equiv v\bmod{d}}}1\\
	&=&\sum_{d\le Q}d\lambda_{d-1} (d)\sum_{\substack{s_{1}\le \sqrt{x}\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x-s_{1}^{2}}\\s_{2}\equiv v\bmod{d}}}1\\
	&=&\sum_{d\le Q}d\lambda_{d-1} (d)\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\Psi(\sqrt{x-s_{1}^{2}},\,y;\,d,\,v).
\end{eqnarray*}
Next, we want to use a mean value estimate in the evaluation of $M(x)$, but the range $s_{1}\le\sqrt{x}$
is too large, so we split it into two parts, over $s_{1}\le\sqrt{x-\frac{x}{L}}$ and $s_{1}\sqrt{x-\frac{x}{L}}\le\sqrt{x}$ where $L=(\log x)^{15}$. And there is a trivial bound for $\Psi\left(\frac{\sqrt{x}}{(u,\,d)},\,y;\,\frac{d}{(u,\,d)},\,\frac{u}{(u,\,d)}\right)$, that is
\begin{eqnarray*}
	\Psi\left(\frac{\sqrt{x}}{(u,\,d)},\,y;\,\frac{d}{(u,\,d)},\,\frac{u}{(u,\,d)}\right)-\Psi\left(\frac{\sqrt{x-\frac{x}{L}}}{(u,\,d)},\,y;\,\frac{d}{(u,\,d)},\,\frac{u}{(u,\,d)}\right)&=&\frac{\sqrt{x}}{d}\rho\left(\frac{x}{2\log y}\right)-\frac{\sqrt{x-\frac{x}{L}}}{d}\rho\left(\frac{\log\left(x-\frac{x}{L}\right)}{2\log y}\right)\\
	&\ll&\frac{\sqrt{x}}{dL}\rho\left(\frac{\log x}{2\log y}\right).
\end{eqnarray*}
Use the trivial bound and Lemma 2.6, the second part does not exceed
\begin{eqnarray*}
	\sum_{d\le Q}\sum_{\substack{u,\,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{\sqrt{x-\frac{L}{x}}\le s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\frac{\sqrt{x}}{d}\rho\left(\frac{\log x}{2\log y}\right)&\ll&\frac{\sqrt{x}}{L}\rho\left(\frac{\log x}{2\log y}\right)^{2}\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,\,d),\,(v,\,d)\le L}}\frac{1}{d^{2}}\\
	&\ll&\frac{\sqrt{x}}{L}\rho\left(\frac{\log x}{2\log y}\right)^{2}\log x=\frac{\sqrt{x}}{(\log x)^{14}}\rho\left(\frac{\log x}{2\log y}\right)^{2}.
\end{eqnarray*}
Therefore the first part contains the main term.
Let 
\begin{eqnarray}
	\Xi_{d,\,v}(z)=\frac{z}{d}\left(\rho\left(\frac{\log\left(\frac{z}{(d,\,v)}\right)}{\log y}\right)+\rho'\left(\frac{\log\left(\frac{z}{(d,\,v)}\right)}{\log y}\right)\frac{\Pi\left(\frac{d}{(d,\,v)}\right)+\gamma-1}{\log y}\right).
\end{eqnarray}
By using Lemma 2.3 we have
$$\Psi(z,\,y;\,d,\,v)=\Xi_{d,\,v}(z)-E(z,\,y;\,d,\,v)+O\left(\frac{z(\log\log x)^{3}}{d(\log x)^{2}}\right).$$
Therefore
$$M(x)=\sum_{d\le Q}\Lambda(d)\sum_{\substack{s_{1}\le x\\s_{1}\equiv u\bmod{d}}}\left(\Xi_{d,v}(\sqrt{x-s_{1}^{2}})-E(\sqrt{x-s_{1}^{2}},\,y;\,d,\,v)+O\left(\frac{\sqrt{x}(\log\log x)^{3}}{d(\log x)^{2}}\right)\right).$$
The contribution of the error term does not exceed
$$\frac{x(\log\log x)^{3}}{(\log x)^{2}}\sum_{d\le Q}\frac{\lambda_{d-1} (d)}{d}\ll\frac{x(\log\log x)^{3}}{\log x}.$$
Let $\omega(d)$ be the number of the distinct prime factors of $d$.
By Chinese Remainder Theorem, we have $$\sum_{\substack{u\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}1\le2^{\omega(d)}\le\tau(d).$$
Let $\Delta=Q(\log x)^{50}, H=(\log x)^{50}\sqrt{1-\frac{1}{L}}$, and sort $a$ ranges $(h-1)\Delta<a\le h\Delta$.
Therefore the contribution of $E(\sqrt{x-s_{1}^{2}},\,x^{\frac{\theta}{2}};\,d,\,v)$ does not exceed
\begin{eqnarray*}
	&&\sum_{d\le Q}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}|E(\sqrt{x-s_{1}^{2}},\,y;\,d,\,v)|\\
	&=&\sum_{d\le Q}\sum_{v\bmod{d}}\sum_{\substack{u\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}|E(\sqrt{x-s_{1}^{2}},\,y;\,d,\,v)|\\
	&\ll&\sum_{d\le Q}\sum_{v\bmod{d}}\tau(d)\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}|E(\sqrt{x-s_{1}^{2}},\,y;\,d,\,v)|\\
	&\ll&\sum_{h\le H}\sum_{d\le Q}\sum_{v\bmod{d}}\tau(d)\sum_{\substack{(h-1)\Delta<s_{1}\le h\Delta\\s_{1}\equiv u\bmod{d}}}\left(|E(\sqrt{x-(h\Delta)^{2}},\,y;\,d,\,v)|+\frac{h(\Delta)^2}{d\sqrt{x-(h\Delta)^2}}+1\right)\\
	&\ll&\sum_{h\le H}\sum_{d\le Q}\tau(d)\frac{\Delta}{d}\sum_{v\bmod{d}}|E(\sqrt{x-(h\Delta)^{2}},\,y;\,d,\,v)|+\sum_{h\le H}\sum_{d\le Q}\tau(d)\Delta\left(\frac{h(\Delta)^2}{d\sqrt{x-(h\Delta)^2}}+1\right).
\end{eqnarray*}
For the first term, we apply Cauchy's inequality and Lemma 2.2 to estimate it. We can show that the first term is bounded by
\begin{eqnarray*}
	&&\Delta\sum_{h\le H}\left (\sum_{d\le Q}\frac{\tau(d)^{2}}{d}\right )^{\frac{1}{2}}\left (\sum_{d\le Q}\sum_{v\bmod{d}}|E(\sqrt{x-(h\Delta)^{2}},\,y;\,d,\,v)|\right )^{\frac{1}{2}}\\
	&\ll&H\Delta(\log Q)^{2}\sum_{h\le H}\left (Q\sqrt{x-(h\Delta)^2}+\frac{x}{(\log x)^{300}} \right )^{\frac{1}{2}}\\
	&\ll&H\Delta(\log Q)^{2}\sum_{h\le H}\left(Q^{\frac{1}{2}}x^{\frac{1}{4}}+\frac{\sqrt{x}}{(\log x)^{150}}\right)\\
	&\ll&x^{\frac{1}{4}}Q^{\frac{1}{2}}H\Delta(\log Q)^{2}+\frac{H\Delta\sqrt{x}(\log Q)^{2}}{(\log x)^{150}}\\
	&\ll&\frac{x(\log\log x)^{2}}{(\log x)^{150}}\ll x\log\log x.
\end{eqnarray*}

For the second term, we have
\begin{eqnarray*}
	\sum_{h\le H}\sum_{d\le Q}\tau(d)\Delta\left(\frac{h(\Delta)^2}{d\sqrt{x-(h\Delta)^2}}+1\right)&\ll&\sum_{h\le H}\frac{h(\Delta)^{3}}{\sqrt{x-(h\Delta)^{2}}}\sum_{d\le Q}\frac{\tau(d)}{d}+\sum_{h\le H}\sum_{d\le Q}\tau(d)\Delta\\
	&\ll&\Delta\sqrt{x}(\log Q)^{2}+H\Delta Q\log Q\\
	&\ll&\frac{x(\log\log x)^{2}}{(\log x)^{50}}\ll x\log\log x.
\end{eqnarray*}

Hence
\begin{eqnarray}
	M(x)=\sum_{d\le Q}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{s_{1}\le \sqrt{x-\frac{x}{L}}\\s_{1}\equiv u\bmod{d}}}\Xi_{d,v}(\sqrt{x-s_{1}^{2}})+O(x\log\log x).
\end{eqnarray}
Since the inner sum over $s_{1},s_{2}$ is at most $\frac{x}{d^{2}}$, by Lemma 2.7, the contribution of the terms in (2.4) with $(v,d)>L$ dose not exceed $xL^{-\frac{1}{3}}(\log Q)^{4}\ll x\log\log x$. By the symmetry in $u$,\,$v$, we have 
$$M(x)=M_{0}(x)+O(x\log\log x),$$
where $M_{0}(x)$ is defined as the sum in (2.4) but with the addtional constraints $(u,\,d)\le L,\, (v,\,d)\le L$. Therefore
\begin{eqnarray}
	M_{0}(x)=\sum_{d\le Q}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,\,d)\le L,\, (v,\,d)\le L}}\sum_{\substack{s_{1}\le \sqrt{x-\frac{x}{L}}\\s_{1}\equiv u\bmod{d}}}\Xi_{d,v}(\sqrt{x-s_{1}^{2}})+O(x\log\log x).
\end{eqnarray}
Thus the terms involving     $\Xi_{d,v}(\sqrt{x-s_{1}^{2}})$ contain the main term.
In fact, by partial summation and a change of variable,
\begin{eqnarray*}
	\sum_{\substack{s_{1}\le\sqrt{x-\frac{x}{L}}\\s_{1}\equiv u\bmod{d}}}\Xi_{d,\,v}\left(\sqrt{x-s_{1}^{2}}\right)&=&\int_{0}^{\sqrt{x-\frac{x}{L}}}\Xi_{d,v}\left(\sqrt{x-z^{2}}\right)d\sum_{\substack{s_{1}\le z\\s_{1}\equiv u\bmod{d}}}1\\
	&=&\left [\Xi_{d,\,v}\left(\sqrt{x-z^{2}}\right)\sum_{\substack{s_{1}\le z\\s_{1}\equiv u\bmod{d}}}1\right ]_{0}^{\sqrt{x-\frac{x}{L}}}+\int_{0}^{\sqrt{x-\frac{x}{L}}}\frac{z\Xi'_{d,\,v}\left(\sqrt{x-z^{2}}\right)}{\sqrt{x-z^{2}}}\sum_{\substack{s_{1}\le z\\s_{1}\equiv u\bmod{d}}}dz\\
	&=&\Xi_{d,\,v}\left(\sqrt{\frac{x}{L}}\right)\sum_{\substack{s_{1}\le\sqrt{x-\frac{x}{L}}\\s_{1}\equiv u\bmod{d}}}+\int_{\sqrt{\frac{x}{L}}}^{\sqrt{x}}\Xi'_{d,\,v}(z)\sum_{\substack{s_{1}\le\sqrt{x-z^{2}}\\s_{1}\equiv \bmod{d}}}dz.
\end{eqnarray*}
The first summand on the right-hand side is $O\left(\frac{x}{d^{2}\sqrt{L}}\right)$. By Lemma 2.6, the contribubution to (2.5), after summation over $u$, $v$, $d$, does not exceed $\frac{x\log Q}{\sqrt{L}}\ll x\log\log x$, and is therefore negligible. For the second summand, we split the integral into two parts, over $[\sqrt{\frac{x}{L}},\,\sqrt{x-\frac{x}{L}}]$ and $[\sqrt{x-\frac{x}{L}},\,\sqrt{x}]$. Note that 
\begin{eqnarray}
	\Xi'_{d,\,v}(z)=\frac{1}{d}\left(\rho\left(\frac{\log\left(\frac{z}{(d,\,v)}\right)}{\log y}\right)+\rho'\left(\frac{\log\left(\frac{z}{(d,\,v)}\right)}{\log y}\right)\frac{\Pi\left(\frac{d}{(d,\,v)}\right)+\gamma-1}{\log y}\right)+O\left(\frac{1+\Pi\left(\frac{d}{(d,\,v)}\right)}{d(\log x)^{2}}\right).
\end{eqnarray}
Hence $\Xi_{d,\,v}(z)\ll\frac{1}{d}$. Then one has 
$$\sum_{d\le Q}\sqrt{x}\lambda(d)\int_{\sqrt{x-\frac{x}{L}}}^{\sqrt{x}}|\Xi'_{d,\,v}(z)|dz\ll\sum_{d\le Q}\frac{x\lambda (d)}{d}\ll x\log Q\ll x\log\log x.$$
We may summarize the previous deliberations by all estimates into (2.5). This shows that $M_{0}(x)$ equals to 
$$M_{0}(x)=\sum_{d\le Q}\sum_{\substack{u,v\bmod{d}\\u^{2}+v_{2}\equiv-1\bmod{d}\\(u,d)<L,(v,d)<L}}\int_{\sqrt{\frac{x}{L}}}^{\sqrt{x-\frac{x}{L}}}\Xi'_{d,\,v}(z)\sum_{\substack{s_{1}\le\sqrt{x-z^{2}}\\s_{1}\equiv u\bmod{d}}}dz+O(x\log\log x).$$
It is now possible to repeat some aspects of the previous argument. The sum over $s_{1}$ in the above integral equals $\Psi(\sqrt{x-z^{2}},x^{\frac{\theta}{2}};d,v)$ and may be replaced by $\Xi_{d,\,v}(\sqrt{x-z^{2}})$. The bound $\Xi'_{d,v}(z)\ll\frac{1}{d}$ is valid in the range $\sqrt{\frac{x}{L}}<z<\sqrt{x-\frac{x}{L}}$ by (2.6), and as before, we may (2.3) to see that all error terms introducrd into (2.5) does not exceed $O(x\log\log x)$. Therefore we have 
\begin{eqnarray}
	M_{0}(x)=\sum_{d\le Q}\sum_{\substack{u,v\bmod{d}\\u^{2}+v_{2}\equiv-1\bmod{d}\\(u,d)<L,(v,d)<L}}\int_{\sqrt{\frac{x}{L}}}^{\sqrt{x-\frac{x}{L}}}\Xi'_{d,\,v}(z)\Xi_{d,\,v}(\sqrt{x-z^{2}})dz+O(x\log\log x).
\end{eqnarray}
For simplification, let
$$U_{1}=\frac{\log\left(\frac{\sqrt{x-z^{2}}}{(v,\,d)}\right)}{\log y},\quad U_{2}=\frac{\log\frac{z}{(v,\,d)}}{\log y}.$$
Then by (2.3) and (2.6), one has $\Xi'_{d,\,v}(z)\Xi_{d,\,v}(\sqrt{x-z^{2}})$ 
equals to
$$\frac{\sqrt{x-z^{2}}}{d^{2}}\left(\rho(U_{1})\rho(U_{2})+\frac{\rho(U_{1})\rho'(U_{2})\left(\Pi\left(\frac{d}{(v,d)}\right)+\gamma\right)}{\log y}+\frac{\rho'(U_{1})\rho(U_{2})\left(\Pi\left(\frac{d}{(u,d)}\right)+\gamma-1\right)}{\log y}+O\left(\left(\frac{\log\log x}{\log x}\right)\right)^{2}\right)$$
uniformly for $d\le Q$, $\sqrt{\frac{x}{L}}\le z\le\sqrt{x-\frac{x}{L}}$. 

Let $z=\sqrt{x}t$ with $\sqrt{\frac{1}{L}}\le t\le\sqrt{1-\frac{1}{L}}$. And $\eta_{1}=\frac{\log\sqrt{1-t^{2}}-\log(u,\,d)}{\log y}$, $\eta_{2}=\frac{\log t-\log(v,\,d)}{\log y}$, then we have 
$U_{j}=\eta_{j}+\frac{\log x}{2\log y}$.
We have $1\le\frac{\log x}{2\log y}\le K$ since $x^{\frac{1}{K}}\le y\le x^{\frac{1}{2}}$. Observe that $\eta_{j}\to0$ as $x\to\infty$.
By Taylor's theorem, we have
\begin{eqnarray*}
	\rho(U_{j})&=&\rho\left(\frac{\log x}{2\log y}\right)+\eta_{j}\rho'\left(\frac{\log x}{2\log y}\right)+O\left(\left(\frac{\log L}{\log x}\right)^{2}\right),\\
	\rho'(U_{j})&=&\rho'\left(\frac{\log x}{2\log y}\right)+O\left(\frac{\log L}{\log x}\right).
\end{eqnarray*}
Therefore
$$\Xi'_{d,v}(z)\Xi_{d,v}(\sqrt{x-z^{2}})=\frac{\sqrt{x-z^{2}}}{d^{2}}\left(\rho\left(\frac{\log x}{2\log y}\right)^{2}+\frac{\rho\left(\frac{\log x}{2\log y}\right)\rho'\left(\frac{\log x}{2\log y}\right)}{\log 
y}B+O\left(\left(\frac{\log\log x}{\log x}\right)^{2}\right)\right),$$
where
$$B=2\gamma-1+\Pi\left(\frac{d}{(u,\,d)}\right)+\Pi\left(\frac{d}{(v,\,d)}\right)+\log(t\sqrt{1-t^{2}})-\log((u,\,d)(v,\,d)).$$
By using Lemma 2.6, the contribution of the error term $O\left(\left(\frac{\log\log x}{\log x}\right)^{2}\right)$ to $M_{0}(x)$ does not exceed $x\log\log x$. Thus it is acceptable.
And we have $\rho(K)\le\rho(\frac{\log x}{2\log y})\le\rho(1)$, then the term contains $\rho\left(\frac{\log x}{2\log y}\right)$ is the main term.
For the main term, we write
\begin{eqnarray*}
	I_{1}&=&\int_{\sqrt{\frac{1}{L}}}^{\sqrt{1-\frac{1}{L}}}\sqrt{1-t^{2}}dt,\\ I_{2}&=&\int_{\sqrt{\frac{1}{L}}}^{\sqrt{1-\frac{1}{L}}}\sqrt{1-t^{2}}\log(t\sqrt{1-t^{2}})dt,\\
	\mathfrak{s}_{1}&=&\sum_{d\le Q}\frac{\lambda(d)}{d},\\
	\mathfrak{s}_{2}&=&\sum_{d\le Q}\frac{\lambda(d)}{d}\left(\Pi\left(\frac{d}{(v,d)}\right)-\log(v,d)\right).
\end{eqnarray*}
By the symmetry in $u$, $v$, we then find that
$$M_{0}(x)=x\mathfrak{s}_{1}I_{1}\left(\rho\left(\frac{\log x}{2\log y}\right)^{2}+O\left(\frac{1}{\log x}\right)\right)+\rho\left(\frac{\log x}{2\log y}\right)\rho'\left(\frac{\log x}{2\log y}\right)\left(\frac{2x}{\log y}\mathfrak{s}_{2}I_{1}+\frac{x}{\log y}\mathfrak{s}_{1}I_{2}\right)+O(x\log\log x).$$
And one has $I_{1}=\frac{\pi}{4}+O(L^{1-\frac{1}{2}})$, $I_{2}\le\log L$, $\Pi\left(\frac{d}{(v,\,d)}\right)-\log(v,\,d)\ll\log d\ll\log Q$, then the previous formula of $M_{0}(x)$ now equals to
$$\frac{\pi}{4}x\mathfrak{s}_{1}\left(\rho\left(\frac{\log x}{2\log y}\right)^{2}+O\left(\frac{\log\log x}{\log x}\right)\right)+\frac{2\rho\left(\frac{\log x}{2\log y}\right)\rho'\left(\frac{\log x}{2\log y}\right)x}{\log y}\mathfrak{s}_{2}I_{1}+O(x\log\log x).$$
By Lemma 2.6 we have $\mathfrak{s}_{1}=C_{1}\log Q+O(1)$, then we just need to estimate $\mathfrak{s}_{2}.$
Let $L_{1}=(\log x)^{21}$, then by Lemma 2.6 one has 
$$\sum_{d\le Q}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(v,d)>L_{1}}}\frac{1}{d^{2}}\left(\Pi\left(\frac{d}{(v,\,d)}\right)-\log(v,\,d)\right)\ll\log Q\sum_{d\le Q}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(v,d)>L_{1}}}\frac{1}{d^{2}}\ll(\log Q)^{-2}.$$
By Dirichlet's hyperbola method one has
$$\mathfrak{s}_{2}=T_{1}-T_{2}+O((\log Q)^{-2}),$$
where 
$$T_{1}=\sum_{a_{1}< L_{1}}\frac{\lambda(a_{1})}{a_{1}}\sum_{a_{2}<\frac{Q}{a_{1}}}\frac{\lambda(a_{2})\Pi(a_{2})}{a_{2}},$$
$$T_{2}=\sum_{a_{1}< L_{1}}\frac{\lambda(a_{1})\log a_{1}}{a_{1}}\sum_{a_{2}<\frac{Q}{a_{1}}}\frac{\lambda(a_{2})}{a_{2}}.$$
Therefore
$$T_{2}\ll\log L_{1}\sum_{a_{1}< L_{1}}\frac{\lambda(a_{1})}{a_{1}}\sum_{a_{2}<\frac{Q}{a_{1}}}\frac{\lambda(a_{2})}{a_{2}}\ll(\log L_{1})^{2}\log Q.$$
Recall the definition of $\Pi(q)$ and reverse the order of the above summation, one has
$$T_{1}=\sum_{a_{1}< L_{1}}\frac{\lambda(a_{1})}{a_{1}}\sum_{a_{2}<\frac{Q}{a_{1}}}\frac{\lambda(a_{2})}{a_{2}}\sum_{p|a_{2}}\frac{\log p}{p-1}.$$
Let $a_{2}=pa_{3}$, then we have
\begin{eqnarray*}
	T_{1}&=&\sum_{p\le Q}\frac{\lambda(p)\log p}{p(p-1)}\sum_{a_{1}\le L_{1}}\frac{\lambda(a_{1})}{a_{1}}\sum_{a_{3}\le\frac{Q}{pa_{1}}}\frac{\lambda(a_{3})}{a_{3}}\\
	&\le&2\sum_{p\le Q}\frac{\lambda(p)\log p}{p^{2}}\sum_{a_{1}\le L_{1}}\frac{\lambda(a_{1})}{a_{1}}\sum_{a_{3}\le\frac{Q}{pa_{1}}}\frac{\lambda(a_{3})}{a_{3}}\\
	&\le&2\sum_{p\le x}\frac{(1+\frac{1}{p})\log p}{p^{2}}\sum_{a_{1}\le L_{1}}\frac{\lambda(a_{1})}{a_{1}}\sum_{a_{3}\le\frac{Q}{pa_{1}}}\frac{\lambda(a_{3})}{a_{3}}\\
	&\ll&\log L_{1}\log Q.
\end{eqnarray*}
Hence $\mathfrak{s}_{2}\ll (\log L_{1})^{2}\log Q\ll(\log\log x)^{2}\log x$.
Now we can estimate $M_{0}(x)$, that is
\begin{eqnarray*}
	M_{0}(x)&=&\frac{\pi}{4}C_{1}x\rho\left(\frac{\log x}{2\log y}\right)^{2}\log Q+O(x(\log\log x)^{2})\\
	&=&C_{1}\frac{\pi}{8}x\rho\left(\frac{\log x}{2\log y}\right)^{2}\log x+O(x(\log\log x)^{2}).
\end{eqnarray*}
Therefore we have $$\sum_{s_{1}^{2}+s_{2}^{2}\le x}\tau(s_{1}^{2}+s_{2}^{2}+1)=2M_{0}(x)+O(x\log\log x)=C_{1}\frac{\pi}{4}\rho\left(\frac{\log x}{2\log y}\right)^{2}x\log x+O(x(\log\log x)^{2}).$$
	\begin{center}
	\item 
	\section{\normalsize The proof of Theorem 1.2}
\end{center}
In Section 1, we consider the range of $y$: $x^{\frac{1}{K}}\le y<x^{\frac{1}{2}}$. In this section, we let  $(\log x)^{K}\le y\le e^{(\log\log x)^{\frac{31}{15}}}$, where $K>0$ is large enough. 
First of all, we summarize here some lemmas for our results.
\begin{lem}
	Let $(\log x)^{K}\le y< x^{\frac{1}{K}}$. K is large enough. As $x\to\infty$, one has
	$$\Psi(x,\,y)=\frac{x^{\alpha}\zeta(\alpha,\,y)}{\alpha\sqrt{2\pi(1+(\log x)/y)\log x\log y}}\left(1+O\left(\frac{1}{\log (1+(\log x)/\log y)}+\frac{1}{\log y}\right)\right),$$
	where $\zeta(s,\,y):=\sum_{n:\,n\,is\,y-smooth}\frac{1}{n^{s}}=\prod_{p\le y}(1-p^{-s})^{-1}$ for $\Re(s)>0$. And $\alpha=\alpha(x,\,y)>0$ is defined by 
	$$\sum_{p\le y}\frac{\log p}{p^{\alpha}-1}=\log x.$$
\end{lem}
\begin{proof}
	For example, see [6, Smooth Number Result 1] or [7, Theorem 1].
\end{proof}
\begin{remark}
	In fact, [7, Lemma 2] implies, in particular, that when $(\log x)^{K}\le y< x^{\frac{1}{K}}$ one has
	\begin{eqnarray*}
		\alpha(x,\,y)=1-\frac{\log(u\log u)}{\log y}+O\left(\frac{1}{\log y}\right),\quad u=\frac{\log x}{\log y}.
	\end{eqnarray*}
	Let $L=(\log x)^{15}$, $\alpha_{1}=\alpha(\sqrt{x},\,y)$  $\alpha_{2}=\alpha(\sqrt{x-z^{2}})$, $\sqrt{\frac{x}{L}}\le z\le\sqrt{x-\frac{x}{L}}$, $(\log x)^{K}\le y\le e^{(\log\log x)^{\frac{31}{15}}}$ and $K$ be large enough. Particularly, as $x,\,y\to\infty$, we have $\alpha_{1}=\alpha_{2}$. And by the definition of $\alpha_{1}$, we have $\frac{1}{K}\le\alpha_{1}\le1$. Hence $\alpha_{1}$ and $B(\frac{\alpha_{1}}{2},\, \frac{\alpha_{1}}{2}+1)$ are constants, where $B(p,\,q)$ is the Beta function.
\end{remark}
\begin{lem}
	Let $\overline{a}$ be the inverse of $a$ modulo $q$, $H(z)=\exp\left\{\frac{z}{(\log(z+1))^{2}}\right\}$.
	For any $\epsilon>0$, there exists $\delta>0$ such that
	$$\sum_{\substack{q\le x^{\frac{6}{11}-\epsilon}\\(q,a_{1}a_{2})=1}}\max_{z\le x}|E(z,\,y;\,q,\,a_{1}{\overline{a_{2}}})|\ll_{A}\Psi(x,\,y)\left\{H\left(\frac{\log x}{\log y}\right)^{-\delta}(\log x)^{-A}+y^{-\delta}\right\},$$
	where $(\log x)^{K}\le y\le x^{\frac{1}{K}}$, $K$ is large enough, $|a_{1}|\le x^{1-\epsilon}$, $|a_{2}|\le x^{\delta}$ and $A>-1$.
\end{lem}
\begin{proof}
	See [3, Corollaire 1].
\end{proof}
Moreover, let $a_{1}=a$, $|a|\le x^{1-\epsilon}$, $a_{2}=1$, we have
$$\sum_{\substack{q\le x^{\frac{6}{11}-\epsilon}\\(q,a)=1}}\max_{z\le x}|E(z,\,y;\,q,\,a)|\ll_{A}\Psi(x,y)\left\{H\left(\frac{\log x}{\log y}\right)^{-\delta}(\log x)^{-A}+y^{-\delta}\right\}.$$
This lemma is the main tool to estimate $\Psi(x,y;q,a)$.
\begin{lem}
	Let $\delta>0$, $(\log x)^{K}\le y\le e^{(\log\log x)^{\frac{31}{15}}}$, where K is large enough. One has
	$$H\left(\frac{\log\sqrt{x}}{\log y}\right)^{-\delta}\ll x^{-\frac{\delta}{2K(\log\log x)^{3}}}.$$
\end{lem}
\begin{proof}
	By the definition of $H(z)$, we have
	\begin{eqnarray*}
		H\left(\frac{\log \sqrt{x}}{\log y}\right)^{-\delta}&=&\left(H\left(\frac{\log \sqrt{x}}{\log y}\right)^{-1}\right)^{\delta}\\
		&=&\left\{\exp\left\{-\frac{\log \sqrt{x}}{\log y\left(\log\frac{\log x}{\log y}+1\right)^{2}}\right\}\right\}^{\delta}\\
		&\ll&\left\{\exp\left\{-\frac{\log x}{2K(\log\log x)^{3}}\right\}\right\}^{\delta}\\
		&=&x^{-\frac{\delta}{2K(\log\log x)^{3}}}.
	\end{eqnarray*}
\end{proof}
\begin{lem}
	Let $A>0$, $(\log x)^{K}\le y\le e^{(\log\log x)^{\frac{31}{15}}}$, where K is large enough. Then there exists $A_{1}>A>0$, such that
	$$H\left(\frac{\log \sqrt{x}}{\log y}\right)^{-\delta}(\log \sqrt{x})^{-A}\ll(\log x)^{-A_{1}}.$$
\end{lem}
\begin{proof}
	In fact, we only need to prove $x^{-\frac{\delta}{2K(\log\log x)^{3}}}$ is less than any negative powers of $\log x$.
	Let us consider $\log x^{\frac{\delta}{2K(\log\log x)^{3}}}$. Then we have
	$$\log x^{\frac{\delta}{2K(\log\log x)^{3}}}=\frac{\delta\log x}{2K(\log\log x)^{3}}\gg K\log\log x.$$
	Therefore $x^{\frac{\delta}{2K(\log\log x)^{3}}}\gg(\log x)^{K}$.
	Hence we can show that
	\begin{eqnarray*}
		H\left(\frac{\log\sqrt{x}}{\log y}\right)^{-\delta}(\log\sqrt{x})^{-A}&\ll& x^{-\frac{\delta}{2K(\log\log x)^{3}}}(\log x)^{-A}\\
		&\ll&(\log x)^{-K-A}.
	\end{eqnarray*}
	Let $A_{1}=K+A$, then $A_{1}>A>0$.
\end{proof}
\begin{lem}
	Let $(\log x)^{2}\le y\le x$, $P(m)\le y$, $\omega(m)\ll y$ where $\omega(m)$ is the number of distinct prime factors of $m$. One has
	$$\Psi_{m}(x,\,y)=g_{m}(\alpha)\Psi(x,\,y)\left\{1+O\left(\frac{E_{m}(1+E_{m})\log y}{\log x}\right)\right\},$$
	where $g_{1}(\alpha)=1$, $g_{m}(\alpha)=\prod_{p|m}(1-p^{-\alpha})$, $m$ is a positive integer, $0<\alpha\le1$. And $\alpha=\alpha(x,y)$ satisfies that
	$$\sum_{p\le y}\frac{\log p}{p^{\alpha}-1}=\log x.$$
	And $E_{m}=\frac{\exp(2\gamma_{m})-1}{\log\left(1+\frac{\log x}{\log y}\right)}$, $\gamma_{m}=\frac{\left(\log(1+\omega(m))\right)\log\left(1+\frac{\log x}{\log y}\right)}{\log y}$.
\end{lem}
\begin{proof}
	See [3, Lemme 1(ii)].
\end{proof}
\begin{lem}
	One has
	$$E_{m}(E_{m}+1)\ll\frac{\omega(m)}{\left(\log\frac{\log x}{\log y}\right)^{2}}.$$
\end{lem}
\begin{proof}
	By the definition of $E_{m}$, we have
	$$E_{m}(E_{m}+1)\ll\frac{\exp\left\{4\log(\omega(m)+2)\left(\frac{\log\frac{\log x}{\log y}}{\log y}\right)\right\}}{\left(\log \frac{\log x}{\log y}\right)^{2}}\ll\frac{\omega(m)}{\left(\log\frac{\log x}{\log y}\right)^{2}}.$$
\end{proof}
\begin{lem}
	Let $p$ be the odd prime factor of $d$, $l\ge1$, $r_{-1}(d)=\#\{(u,\,v):\,u,\,v\bmod{d}, \,u^{2}+v^{2}\equiv-1\bmod{d}\},$
	where $(uv,\,d)=1$. One has
	\begin{eqnarray*}
		r_{-1}(p^{l})&=&p^{l-1}r_{-1}(p),\\
		r_{-1}(p)&=&p-2-3\left(\frac{-1}{p}\right).
	\end{eqnarray*}
\end{lem}
\begin{proof}
	See [9, Lemma 15].
\end{proof}
\begin{lem}
	Let $\alpha_{1}=\alpha(\sqrt{x},\,y)$, $(\log x)^{K}\le y\le e^{(\log\log x)^{\frac{31}{15}}}$, $K$ is large enough and $$F(d)=\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{g_{\frac{d}{(u,\,d)}}(\alpha_{1})g_{\frac{d}{(v,\,d)}}(\alpha_{2})d}{\varphi\left(\frac{d}{(u,\,d)}\right)(u,\,d)^{\alpha_{1}}\varphi\left(\frac{d}{(v,\,d)}\right)(v,\,d)^{\alpha_{2}}}.$$
	As $x,\,y\to\infty$, one has 
	$$\sum_{d\le x}\frac{F(d)}{d}=\mathfrak{S}(F)\log x+O(1),$$
	where
	\begin{eqnarray*}
		\mathfrak{S}(F)=\frac{2(1-2^{\alpha_{1}})+2^{\alpha_{1}-1}}{2^{\alpha_{1}}}C_{2}
	\end{eqnarray*} 
	is convergent.
	Here
	\begin{eqnarray}
		C_{2}=\left(\prod_{p\ne2}\left(1-\frac{1}{p}\right)\right)\left(\prod_{p\equiv1\bmod{4}}\left(1+\sum_{l\ge1}\frac{F(p^{l})}{p^{l}}\right)\right)\left(\prod_{p\equiv3\bmod{4}}\left(1+\sum_{l\ge1}\frac{F(p^{l})}{p^{l}}\right)\right).
	\end{eqnarray} 
\end{lem}
\begin{proof}
	First of all, since all the functions in the representation of $F(d)$ are multiplicative, by Chinese Reminder Thorem we can show that $F(d)$ is multiplicative. By the definition of $F(d)$, we have $F(d)\le\tau(d)$.
	Now, let us compute $F(p)$. As $x,\,y\to\infty$, by Lemma 2.4 we have
	\begin{eqnarray*}
		F(2)&=&\frac{4(1-2^{-\alpha_{1}})}{2^{\alpha_{1}}},\\
		F(p)&=&\frac{2\left(1+\left(\frac{-1}{p}\right)\right)(1-p^{-\alpha_{1}})p}{p^{\alpha_{1}}(p-1)}+\frac{\left(p-2-3\left(\frac{-1}{p}\right)\right)p}{(p-1)^{2}},\quad p\ne2.
	\end{eqnarray*}
	Hence by Mertens' three estimates[7, Theorem 3.4] we can show that
	\begin{eqnarray*}
		\sum_{p\le x}\frac{F(p)\log p}{p}&=&\frac{2(1-2^{-\alpha_{1}})}{2^{\alpha_{1}}}+\sum_{\substack{p\ne2\\p\le x}}\frac{\log p}{p-1}+\sum_{\substack{p\equiv3\bmod{4}\\p\le x}}\frac{2\log p}{(p-1)^{2}}\\
		&&+\sum_{\substack{p\equiv1\bmod{4}\\p\le x}}\left(\frac{4(1-p^{-\alpha_{1}})\log p}{p^{\alpha_{1}}(p-1)}-\frac{4\log p}{(p-1)^{2}}\right)\\
		&=&\log x+O(1).
	\end{eqnarray*}
	
	Next we will compute $F(p^{l})$ to prove that $\mathfrak{S}(F)$ is convergent.
	Whence $l\ge1$, by using [1, Lemma 2.8], Lemma 5.6, we have
	\begin{eqnarray*}
		F(2^{l+1})&=&0,\\
		F(p^{l})&=&\frac{2(1-p^{-\alpha_{1}})\left(1+\left(\frac{-1}{p}\right)\right)p^{l}}{\varphi(p^{l})p^{l\alpha_{1}}}+\frac{(1-p^{-\alpha_{1}})^{2}p^{l-1}(p-2-3\left(\frac{-1}{p}\right))p^{l}}{\varphi(p^{l})^{2}}\\
		&&+\sum_{a=1}^{l-1}\frac{2(1-p^{-\alpha_{1}})^{2}\left(1+\left(\frac{-1}{p}\right)\right)p^{l}}{\varphi(p^{l})p^{a\alpha_{1}}}.
	\end{eqnarray*}
	We compute the case $p\equiv1\bmod{4}$ firstly.
	When $p\equiv1\bmod{4}$, $\left(\frac{-1}{p}\right)=1$. Then we have
	\begin{eqnarray*}
		\sum_{l\ge1}\frac{F(p^{l})}{p^{l}}&=&\sum_{l\ge1}\frac{4(1-p^{-\alpha_{1}})p}{p^{l(\alpha_{1}+1)}(p-1)}+\sum_{l\ge1}\frac{(1-p^{-\alpha_{1}})^{2}(p-5)}{p^{l-1}(p-1)^{2}}+\sum_{l\ge1}\frac{4(1-p^{-\alpha_{1}})^{2}}{p^{l-1}(p^{\alpha_{1}}-1)(p-1)}\left(1-\frac{1}{p^{\alpha_{1}(l-1)}}\right)\\
		&=&\frac{4(1-p^{-\alpha_{1}})p}{(p^{\alpha_{1}+1}-1)(p-1)}+\frac{(1-p^{-\alpha_{1}})^{2}p(p-5)}{(p-1)^{3}}+\frac{4(1-p^{-\alpha_{1}})^{2}(p^{\alpha_{1}}-p)}{(p^{\alpha_{1}+1}-1)(p^{\alpha_{1}}-1)(p-1)^{2}}\\
		&=&\frac{1}{p}+O\left(\frac{1}{p^{\alpha_{1}+1}}\right).
	\end{eqnarray*}
	Similarly, when $p\equiv3\bmod{4}$, we can write
	$$\sum_{l\ge1}\frac{F(p^{l})}{p^{l}}=\frac{(1-p^{-\alpha_{1}})^{2}p(p+1)}{(p-1)^{3}}=\frac{1}{p}+O\left(\frac{1}{p^{\alpha_{1}+1}}\right).$$
	Therefore we get
	\begin{eqnarray*}
		\mathfrak{S}(F)&=&\prod_{p}\left(1-\frac{1}{p}\right)\left(1+\frac{F(p)}{p}+\frac{F(p^{2})}{p^{2}}+...\right)\\
		&=&\frac{2+F(2)}{2}\left(\prod_{p\ne2}\left(1-\frac{1}{p}\right)\right)\left(\prod_{p\equiv1\bmod{4}}\left(1+\sum_{l\ge1}\frac{F(p^{l})}{p^{l}}\right)\right)\left(\prod_{p\equiv3\bmod{4}}\left(1+\sum_{l\ge1}\frac{F(p^{l})}{p^{l}}\right)\right)\\
		&=&\left(\frac{2(1-2^{\alpha_{1}})+2^{\alpha_{1}-1}}{2^{\alpha_{1}}}\right)\left(\prod_{p\equiv1\bmod{4}}\left(1+\frac{1}{p}+O\left(\frac{1}{p^{\alpha_{1}+1}}\right)\right)\left(1-\frac{1}{p}\right)\right)\\
		&&\times\left(\prod_{p\equiv3\bmod{4}}\left(1+\frac{1}{p}+O\left(\frac{1}{p^{\alpha_{1}+1}}\right)\right)\left(1-\frac{1}{p}\right)\right)
	\end{eqnarray*}
	is convergent.
\end{proof}
By Lemma 2.4, let $k>0$ is a constant, we have
$$\sum_{d\le x}\frac{G(d)2^{k\omega(d)}}{d}\ll(\log x)^{2^{k}}$$
and
$$\sum_{d\le x}\frac{F(d)2^{k\omega(d)}}{d}\ll(\log x)^{2^{k}}.$$
Using above lemmas, we can prove Theorem 1.2. The proof of Theorem 1.2 is same as the proof of Theorem 1.1. Their differences are just how we estimate $\Psi(x,y;q,a)$ and $\Psi(x,y)$.
In fact, $\Psi(x,y;q,a)=\Psi\left(\frac{x}{(q,a)},y;\frac{q}{(q,a)},\frac{a}{(q,a)}\right)$ unless $P((q,a))>y$.

Let $(\log x)^{K}\le y<x^{\frac{1}{K}}$, $K$ is large enough, $\mathfrak{A}=s_{1}^{2}+s_{2}^{2}$, $s_{1}$ and $s_{2}$ are $y$-smooth nummbers,
$S_{1}(x)=\sum_{\mathfrak{A}\le x}\tau(\mathfrak{A})$, $D=\frac{\sqrt{x+1}}{(\log x)^{100}}$.
And by the analogous computation in Section 1, we have
$$S_{1}(x)=2M'(x)+R'(x),$$
where
\begin{eqnarray*}
	M'(x)&=&\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x-s_{1}^{2}}\\s_{2}\equiv v\bmod{d}}}1,\\
	R'(x)&=&\sum_{\frac{\sqrt{x+1}}{(\log x)^{100}}<d<\sqrt{x+1}(\log x)^{100}}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x-s_{1}^{2}}\\s_{2}\equiv v\bmod{d}}}1.
\end{eqnarray*}
And then, by Lemma 3.1, Lemma 3.2, Lemma 3.5 and Lemma 3.8 we can show that
\begin{eqnarray*}
	R'(x)&\ll&\sum_{\frac{\sqrt{x+1}}{(\log x)^{100}}<d<\sqrt{x+1}(\log x)^{100}}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\Psi\left(\frac{\sqrt{x}}{(u,d)},y,\frac{d}{(u,d)},\frac{u}{(u,d)}\right)\Psi\left(\frac{\sqrt{x}}{(v,d)},y,\frac{d}{(v,d)},\frac{v}{(v,d)}\right)\\
	&\ll&\sum_{\frac{\sqrt{x+1}}{(\log x)^{100}}<d<\sqrt{x+1}(\log x)^{100}}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{g_{\frac{d}{(u,d)}}(\alpha_{1})\Psi\left(\frac{\sqrt{x}}{(u,d)},y\right)}{\varphi\left(\frac{d}{(u,d)}\right)}\times\frac{g_{\frac{d}{(v,d)}}(\alpha_{1})\Psi\left(\frac{\sqrt{x}}{(v,d)},y\right)}{\varphi\left(\frac{d}{((u,d))}\right)}\\
	&=&\Psi\left(\sqrt{x},\,y\right)^{2}\sum_{\frac{\sqrt{x+1}}{(\log x)^{100}}<d<\sqrt{x+1}(\log x)^{100}}\frac{1}{d}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{g_{\frac{d}{(u,d)}}(\alpha_{1})g_{\frac{d}{(v,d)}}(\alpha_{1})d}{\varphi\left(\frac{d}{(u,d)}\right)(u,d)^{\alpha_{1}}\varphi\left(\frac{d}{(v,d)}\right)(v,d)^{\alpha_{1}}}\\ 
	&\ll&\Psi(\sqrt{x},\,y)^{2}\log\log x.
\end{eqnarray*}
Therefore $S_{1}(x)=2M'(x)+O\left(\Psi(\sqrt{x},\,y)^{2}\log\log x\right)$.

Next, we consider the case that $(u,\,d)>y$. In fact,
$$\Psi(x,\,y;\,q,\,a)\ll\frac{\Psi(x,\,y)}{q}.$$
Let $L=(\log x)^{15}$, then by Lemma 2.7, we can show that 
$$\sum_{d\le Q}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,d)>L}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x-s_{1}^{2}}\\s_{2}\equiv v\bmod{d}}}1\ll\sum_{d\le Q}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,d)>L}}\frac{\Psi(\sqrt{x},\,y)^{2}}{d^{2}}\ll \Psi(\sqrt{x},\,y)^{2}L^{-\frac{1}{3}}(\log x)^{4}=\frac{\Psi(\sqrt{x},\,y)^{2}}{\log x}.$$
By the symmetry of $u$, $v$, we have
\begin{eqnarray}
	M'(x)=\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,d), (v,d)\le L}}\sum_{\substack{s_{1}\le x\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x-s_{1}^{2}}\\s_{2}\equiv v\bmod{d}}}1+O\left(\frac{\Psi(\sqrt{x},\,y)^{2}}{\log x}\right).
\end{eqnarray}
Observe that
$$\Psi(x,\,y;\,q,\,a)=\frac{\Psi_{q}(x,\,y)}{\varphi(q)}+E(x,\,y;\,q,\,a)$$
whenever $(q,\,a)=1$.
Let 
\begin{eqnarray}
	f(x;\,q,\,a)=\frac{g_{\frac{q}{(q,\,a)}}(\alpha)\Psi(x,\,y)}{\varphi\left(\frac{q}{(q,\,a)}\right)}.
\end{eqnarray}
By Lemma 3.2 and Lemma 3.5, we have
\begin{eqnarray}
	\Psi(x,\,y;\,q,\,a)&=&f(x;\,q,\,a)+E(x,\,y;\,q,\,a)+O\left(\frac{\Psi(x,\,y)\omega(q)\log y}{\varphi(q)\left(\log\frac{\log x}{\log y}\right)^{2}\log x}\right),\\
	f'(x;\,q,\,a)&=&\frac{g_{q}(\alpha)\Psi'(x,\,y)}{\varphi\left(q\right)}\ll\frac{\Psi(x,\,y)}{qx}.
\end{eqnarray}
Let 
$$M''(x)=\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,\,d),\,(v,\,d)\le L}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x-s_{1}^{2}}\\s_{2}\equiv v\bmod{d}}}1,$$
then we have
\begin{eqnarray}
	M''(x)=\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,\,d),\,(v,\,d)\le L}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\Psi\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)},\,y,\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right),
\end{eqnarray}
where
\begin{eqnarray*}
	\Psi\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)},\,y,\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)&=&f\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)};\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)+E\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)},\,y,\,\frac{d}{(v,\,d)},\frac{v}{(v,\,d)}\right)\\\
	&&+O\left(\frac{\Psi(\sqrt{x},\,y)\omega(d)\log y}{\varphi(d)\left(\log\frac{\log x}{\log y}\right)^{2}\log x}\right).
\end{eqnarray*}
Using [7, Theprem 14.3], we  can estimate that the error term does not ecxeed
\begin{eqnarray*}
	\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{\Psi(\sqrt{x},\,y)^{2}\omega(d)\log y}{\varphi(d)^{2}\left(\log\frac{\log x}{2\log y}\right)^{2}\log x}&\ll&\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{\Psi(\sqrt{x},\,y)^{2}2^{\frac{\omega(d)}{2}}\log y}{\varphi(d)^{2}\left(\log\frac{\log x}{2\log y}\right)^{2}\log x}\\
	&\ll&\frac{\Psi(\sqrt{x},\,y)^{2}\log y(\log x)^{\sqrt{2}-1}}{\left(\log\frac{\log x}{2\log y}\right)^{2}}
\end{eqnarray*}
Next, we consider the terms involving $E\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,d)},\,y;\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)$.

By Lemma 3.2 and 3.4, we have $E(x,\,y;\,q,\,a)\ll\frac{\Psi(x,\,y)}{\varphi(q)\log x}$. If not, then we can write that
$$\sum_{q\le\sqrt{x}}E(x,\,y;\,q,\,a)>\sum_{q\le\sqrt{x}}\frac{\Psi(x,\,y)}{\varphi(q)\log x}.$$
The right hand side is $O(\Psi(x,y))$, then there produces a contradiction with Lemma 3.2. 
Therefore the contribution of $E$ to (3.13) does not exceed
$$\sum_{d\le D}\sum_{\substack{u^{2}+v^{2}\equiv-1\bmod{d}\\u,v\bmod{d}}}\frac{\Psi(\sqrt{x},\,y)^{2}}{(\log x)\varphi\left(\frac{d}{(u,\,d)}\right)(u,\,d)^{\alpha_{1}}\varphi\left(\frac{d}{(v,\,d)}\right)(v,\,d)^{\alpha_{1}}}\ll\Psi(\sqrt{x},\,y)^{2}.$$
Now let us consider the inner sum which is involving $f\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,d)};\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)$. Let $L=(\log x)^{15}$,
then we split the range of $s_{1}$ into two parts firstly, that is $s_{1}\le\sqrt{x-\frac{x}{L}}$ and $\sqrt{x-\frac{x}{L}}<s_{1}\le\sqrt{x}$.

For the second part, by (3.10) we have $f\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)};\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)\ll\frac{\Psi(\sqrt{x},\,y)}{\varphi\left(\frac{d}{(v,\,d)}\right)(v,\,d)^{\alpha_{1}}}$. And then by Mean Value Theorem we have
\begin{eqnarray*}
	\sum_{\substack{\sqrt{x-\frac{x}{y}}<s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}1&=&f\left(\frac{\sqrt{x}}{(v,\,d)};\,\frac{d}{(u,\,d)},\,\frac{u}{(u,\,d)}\right)-f\left(\frac{\sqrt{x-\frac{x}{y}}}{(v,\,d)};\,\frac{d}{(u,\,d)},\,\frac{u}{(u,\,d)}\right)\\
	&\ll&\frac{\Psi(\sqrt{x},\,y)-\Psi\left(\sqrt{x-\frac{x}{L}},\,y\right)}{\varphi\left(\frac{d}{(u,\,d)}\right)(u,\,d)^{\alpha_{1}}}\\
	&\ll&\frac{\Psi(\sqrt{x},\,y)}{L\varphi\left(\frac{d}{(u,\,d)}\right)(u,\,d)^{\alpha_{1}}}.
\end{eqnarray*}
Therefore the  second part not exceed
$$\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{\Psi(\sqrt{x},\,y)^{2}}{L\varphi\left(\frac{d}{(u,\,d)}\right)(u,\,d)^{\alpha_{1}}\varphi\left(\frac{d}{(v,\,d)}\right)(v,\,d)^{\alpha_{1}}}\ll\frac{\Psi(\sqrt{x},\,y)^{2}\log x}{L}.$$ 
Next we will estimate the first part.
By using partial summation, we can write
\begin{eqnarray*}
	\sum_{\substack{s_{1}\le\sqrt{x-\frac{x}{L}}\\s_{1}\equiv u\bmod{d}}}f\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)};\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)&=&\int_{0}^{\sqrt{x-\frac{x}{L}}}f\left(\frac{\sqrt{x-z^{2}}}{(v,\,d)};\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)d\sum_{\substack{s_{1}\le z\\s_{1}\equiv u\bmod{d}}}1\\
	&=&f\left(\frac{\sqrt{\frac{x}{L}}}{(v,\,d)};\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)\sum_{\substack{s_{1}\le\sqrt{x-\frac{x}{L}}\\s_{1}\equiv u\bmod{d}}}\\
	&&-\int_{0}^{\sqrt{x-\frac{x}{L}}}\sum_{\substack{s_{1}\le z\\s_{1}\equiv u\bmod{d}}}df\left(\frac{\sqrt{x-z^{2}}}{(v,\,d)};\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right).\\
\end{eqnarray*}	
The first summand on the right hand side is $O\left(\Psi(\sqrt{x},\,y)^{2}L^{-\frac{\alpha_{1}}{2}}\right)$, hence the sum over $u$, $v$ contains it does not exceed $O\left(\Psi(\sqrt{x},\,y)^{2}(\log x)^{1-\frac{15\alpha_{1}}{2}}\right)$.
And then we split the integral into two parts, over $\left[\sqrt{\frac{x}{L}},\,\sqrt{x-\frac{x}{L}}\right]$ and $\left[\sqrt{x-\frac{x}{L}},\,\sqrt{x}\right]$.
In fact, by (3.12) we have $f'\left(\frac{\sqrt{x-z^{2}}}{(v,\,d)};\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)\ll\frac{x^{\frac{\alpha_{1}}{2}-1}}{\varphi\left(\frac{d}{(v,\,d)}\right)(v,\,d)^{\alpha_{1}}}$.
Then for the second summand, we can show that it does not exceed
$$\frac{\Psi(\sqrt{x},\,y)^{2}}{x}\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv0\bmod{d}}}\frac{g_{\frac{d}{(u,\,d)}}(\alpha_{1})g_{\frac{d}{(v,\,d)}}(\alpha_{1})}{\varphi\left(\frac{d}{(u,\,d)}\right)(u,\,d)^{\alpha_{1}}\varphi\left(\frac{d}{(v,\,d)}\right)(v,\,d)^{\alpha_{1}}}
\ll \frac{\Psi(\sqrt{x},\,y)^{2}}{x}\log x=\frac{\Psi(x,\,y)\log x}{x}.$$
Note that $$\sum_{\substack{s_{1}\le z\\s_{1}\equiv u\bmod{d}}}1$$
can be replaced by $\Psi\left(\frac{z}{(u,\,d)},\,y;\,\frac{d}{(u,\,d)},\,\frac{u}{(u,\,d)}\right)$ and may be replaced by $f\left(\frac{z}{(u,d)};\frac{d}{(u,d)},\frac{u}{(u,d)}\right)$ by ysing (3.11) and (3.12).
And we need to estimate $\Psi(\sqrt{x-z^{2}},\,y)$, $\sqrt{\frac{x}{L}}\le z\le\sqrt{x-\frac{x}{L}}$.
By Lemma 3.1, we have
$$\Psi\left(\sqrt{x-z^{2}},\,y\right)=\frac{(x-z^{2})^{\frac{\alpha_{2}}{2}}\zeta(\alpha,\,y)}{\alpha_{2}\sqrt{2\pi(1+(\log \sqrt{x-z^{2}})/y)\log \sqrt{x-z^{2}}\log y}}\left(1+O\left(\frac{1}{\log (1+(\log \sqrt{x-z^{2}})/\log y)}+\frac{1}{\log y}\right)\right).$$
Let $z=\sqrt{x}t$, then $\sqrt{x-z^{2}}=\sqrt{x}\times\sqrt{1-t^{2}}$ and $\sqrt{\frac{1}{L}}\le t\le\sqrt{1-\frac{1}{L}}$. We have 
\begin{eqnarray*}	
	(1+(\log \sqrt{x-z^{2}})/y)\log \sqrt{x-z^{2}}\log y&=&\left(1+\frac{\log x}{2y}+\frac{\log(1-t^{2})}{2y}\right)\left(\frac{\log x}{2}+\frac{\log(1-t^{2})}{2}\right)\log y\\
	&=&\left(1+\frac{\log x}{2y}\right)\frac{\log x}{2}\log y+O\left(\frac{\log L\log x\log y}{y}\right).
\end{eqnarray*}
Let $f=\left(1+\frac{\log x}{2y}\right)\frac{\log x}{2}\log y$, $\Delta_{f}=O\left(\frac{\log L\log x\log y}{y}\right)$. One has
\begin{eqnarray*}
	\frac{1}{\sqrt{f}}-\frac{1}{\sqrt{f+\Delta_{f}}}&=&\frac{\sqrt{f+\Delta_{f}}-\sqrt{f}}{\sqrt{f+\Delta_{f}}\sqrt{f}}\\
	&=&\frac{\Delta_{f}}{\sqrt{f+\Delta_{f}}\sqrt{f}\left(\sqrt{f+{\Delta_{f}}}+\sqrt{f}\right)}\\
	&\ll&\frac{\log L\log x\log y}{yf^{2}}\ll\frac{\log L}{y}.
\end{eqnarray*}
And it is easy to see that  $\lim_{\substack{x\to\infty\\y\to\infty}}\frac{\alpha(\sqrt{x-z^{2}},\,y)}{\alpha(\sqrt{x},\,y)}=1$. 
Therefore we have
$$\Psi(\sqrt{x-z^{2}},\,y)=(1-t^{2})^{\frac{\alpha_{1}}{2}}\Psi(\sqrt{x},\,y)+O\left(\frac{\log L}{y\log\left(1+\frac{\log x}{2\log y}\right)}+\frac{L}{y\log y}\right).$$
By the same way, when $(v,d)\le L$, we have
$$\Psi\left(\frac{\sqrt{x-z^{2}}}{(v,d)},\,y\right)=\frac{(1-t^{2})^{\frac{\alpha_{1}}{2}}}{(v,d)^{\alpha_{1}}}\Psi(\sqrt{x},\,y)+O\left(\frac{\log L}{y\log\left(1+\frac{\log x}{2\log y}\right)}+\frac{L}{y\log y}\right).$$
Then by a change of variable, we have
\begin{eqnarray*}
	M''(x)&=&\frac{\alpha_{1}}{2}\Psi(\sqrt{x},\,y)^{2}\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,\,d),\,(v,\,d)\le L}}\frac{g_{\frac{d}{(u,\,d)}}(\alpha_{1})g_{\frac{d}{(v,\,d)}}(\alpha_{1})}{\varphi\left(\frac{d}{(u,\,d)}\right)(u,\,d)^{\alpha_{1}}\varphi\left(\frac{d}{(v,\,d)}\right)(v,\,d)^{\alpha_{1}}}\int_{\sqrt{\frac{1}{L}}}^{\sqrt{1-\frac{1}{L}}} t^{\frac{\alpha_{1}}{2}}(1-t)^{\frac{\alpha_{1}}{2}-1}dt\\
	&=&\frac{\alpha_{1}}{2}\Psi(x,y)\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{g_{\frac{d}{(u,\,d)}}(\alpha_{1})g_{\frac{d}{(v,\,d)}}(\alpha_{1})}{\varphi\left(\frac{d}{(u,\,d)}\right)(u,\,d)^{\alpha_{1}}\varphi\left(\frac{d}{(v,\,d)}\right)(v,\,d)^{\alpha_{1}}}\int_{\sqrt{\frac{1}{L}}}^{\sqrt{1-\frac{1}{L}}} t^{\frac{\alpha_{1}}{2}}(1-t)^{\frac{\alpha_{1}}{2}-1}dt\\
	&&+O\left(\frac{\Psi(\sqrt{x},\,y)\log y(\log x)^{\sqrt{2}-1}}{\log\frac{\log x}{2\log y}}\right)
\end{eqnarray*}
And the integral equals to 
$$\int_{0}^{1}t^{\frac{\alpha_{1}}{2}}(1-t)^{\frac{\alpha_{1}}{2}-1}dt+O(L^{-\frac{1}{2}})=B\left(\frac{\alpha_{1}}{2},\,\frac{\alpha_{1}}{2}+1\right)+O(L^{-\frac{1}{2}}).$$
The contribution of the term $O\left(L^{-\frac{1}{2}}\right)$ to $M''(x)$ does not exceed $O(\Psi(\sqrt{x},\,y)^{2}L^{-\frac{1}{2}}\log x)$.
Therefore we get
\begin{eqnarray*}
	S(x)&=&2M''(x)+O(\Psi(\sqrt{x},\,y)^{2}\log\log x)+O\left(\frac{\Psi(\sqrt{x},\,y)^{2}}{\log x}\right)\\
	&=&\frac{\alpha_{1}}{2} B\left(\frac{\alpha_{1}}{2},\,\frac{\alpha_{1}}{2}+1\right)\mathfrak{S}(F)\Psi(\sqrt{x},\,y)^{2}\log x+O\left(\frac{\Psi(\sqrt{x},\,y)^{2}\log y(\log x)^{\sqrt{2}-1}}{\left(\log\frac{\log x}{2\log y}\right)}\right).
\end{eqnarray*}
\begin{center}
	\section{\normalsize The proof of Theorem 1.3}
\end{center}
In this section, we sort $y$ in the range: $e^{(\log\log x)^{\frac{31}{15}}}\le y\le x^{\frac{1}{K}}$ where $K>0$ is large enough. As before, we summarize here some lemmas for our proof.
\begin{lem}
	When $e^{(\log\log x)^{\frac{31}{15}}}\le y\le x^{\frac{1}{K}}$, $K$ is large enough, one has
	$$\Psi(x,\,y)=x\rho\left(\frac{\log x}{\log y}\right)\left(1+O\left(\frac{\log\left(\frac{\log x}{\log y}+1\right)}{\log y}\right)\right).$$
\end{lem}
\begin{proof}
	For example, see [8, Theorem 1].
\end{proof}
\begin{lem}
	For $q\le\sqrt{x}$ and $e^{(\log\log x)^{\frac{31}{15}}}\le y\le x^{\frac{1}{K}}$, $K$ is large enough, one has
	$$\Psi_{q}(x,\,y)=\frac{\varphi(q)}{q}\Psi(x,\,y)\left\{1+O\left(\frac{(\log\log x)^{2}}{\log y}\right)\right\}.$$
\end{lem}
\begin{proof}
	See [5, Theorem 1].
\end{proof}
\begin{remark}
	Indeed, we have
	\begin{eqnarray*}
		\frac{\Psi_{\frac{q}{(a,q)}}\left(\frac{x}{(a,q),\,y}\right)}{\varphi\left(\frac{q}{(a,q)}\right)}=\frac{\Psi\left(\frac{x}{(a,q)},\,y\right)(a,q)}{q}\left\{1+O\left(\frac{(\log\log x)^{2}}{\log y}\right)\right\}
		=\frac{x}{q}\rho\left(\frac{\log\frac{x}{(a,q)}}{\log y}\right)\left\{1+O\left(\frac{(\log\log x)^{2}}{\log y}\right)\right\}.
	\end{eqnarray*}
\end{remark}
\begin{lem}
	For $q\le\sqrt{x}$ and $e^{(\log\log x)^{\frac{31}{15}}}\le y\le x^{\frac{1}{K}}$, $K$ is large enough, one has
	\begin{eqnarray*}
		\Psi\left(\frac{x}{(a,q)},y;\frac{q}{(a,q)},\frac{a}{(a,q)}\right)=\frac{x}{q}\rho\left(\frac{\log\frac{x}{(a,q)}}{\log y}\right)\left\{1+O\left(\frac{\log\log qy\log\log x}{\log y}\right)\right\}
		+E\left(\frac{x}{(a,q)},y;\frac{q}{(a,q)},\frac{a}{(a,q)}\right).
	\end{eqnarray*}
\end{lem}
\begin{proof}
	It follows Lemma 5.2 and the definition of $E(x,y;q,a)$.
\end{proof}
\begin{lem}
	Let $e^{(\log\log x)^{\frac{31}{15}}}\le y\le x^{\frac{1}{K}}$, where $K$ is large enough. One has
	$$H\left(\frac{\log\sqrt{x}}{\log y}\right)^{-\delta}\ll x^{-\frac{\delta}{2(\log\log x)^{61/15}}}.$$
\end{lem}
\begin{proof}
	By the definition of $H(z)$, we have
	\begin{eqnarray*}
		H\left(\frac{\log \sqrt{x}}{\log y}\right)^{-\delta}&=&\left(H\left(\frac{\log \sqrt{x}}{\log y}\right)^{-1}\right)^{\delta}\\
		&=&\left\{\exp\left\{-\frac{\log \sqrt{x}}{\log y\left(\log\frac{\log x}{\log y}+1\right)^{2}}\right\}\right\}^{\delta}\\
		&\ll&\left\{\exp\left\{-\frac{\log x}{2(\log\log x)^{\frac{61}{15}}}\right\}\right\}^{\delta}\\
		&=&x^{-\frac{\delta}{2(\log\log x)^{61/15}}}.
	\end{eqnarray*}
\end{proof}
\begin{lem}
	Let $A>0$, $e^{(\log\log x)^{\frac{31}{15}}}\le y\le x^{\frac{1}{K}}$, where K is large enough. Then there exists $A_{2}>A>0$, such that
	$$H\left(\frac{\log \sqrt{x}}{\log y}\right)^{-\delta}(\log \sqrt{x})^{-A}\ll(\log x)^{-A_{2}}.$$
\end{lem}
\begin{proof}
	In fact, we only need to prove that $x^{-\frac{\delta}{(\log\log x)^{61/15}}}$ is less than any negative powers of $\log x$.
	Let us consider $\log x^{\frac{\delta}{2(\log\log x)^{61/15}}}$. Then we have
	$$\log x^{\frac{\delta}{2(\log\log x)^{61/15}}=\frac{\delta\log x}{2(\log\log x)^{61/15}}}\gg K\log\log x.$$
	Therefore $x^{\frac{\delta}{2(\log\log x)^{61/15}}}\gg(\log x)^{K}$.
	Hence we can show that
	\begin{eqnarray*}
		H\left(\frac{\log\sqrt{x}}{\log y}\right)^{-\delta}(\log\sqrt{x})^{-A}&\ll& x^{-\frac{\delta}{2(\log\log x)^{61/15}}}(\log x)^{-A}\\
		&\ll&(\log x)^{-K-A}.
	\end{eqnarray*}
	Let $A_{2}=K+A$, then $A_{2}>A>0$.
\end{proof}
Now we can start to prove Theorem 1.3. In fact, the techniques are same as Section 2 and Section 3, their differences are just the estimate of error term. 
Let $D=\frac{\sqrt{x}}{(\log x)^{100}}$ and $e^{(\log\log x)^{\frac{31}{15}}}\le y\le x^{\frac{1}{K}}$, where $K$ is large enough. And let $S_{1}(x)=\sum_{s_{1}^{2}+s_{2}^{2}\le x}\tau(s_{1}^{2}+s_{2}^{2})$, where $s_{1}$ and $s_{2}$ are $y$-smooth numbers. 
By the same method in above sections, one has
$$S_{1}(x)=2M_{1}(x)+W_{1}(x),$$
where
\begin{eqnarray*}
	M_{1}(x)&=&\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x-s_{1}^{2}}\\s_{2}\equiv v\bmod{d}}}1,\\
	W_{1}(x)&=&\sum_{\frac{\sqrt{x}}{(\log x)^{100}}<d<\sqrt{x}(\log x)^{100}}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x-s_{1}^{2}}\\s_{2}\equiv v\bmod{d}}}1.
\end{eqnarray*}
By Lemma 2.6, we have
\begin{eqnarray*}
	W_{1}(x)&\ll&\sum_{\frac{\sqrt{x}}{(\log x)^{100}}<d<\sqrt{x}(\log x)^{100}}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\Psi\left(\frac{\sqrt{x}}{(u,d)},y,\frac{d}{(u,d)},\frac{u}{(u,d)}\right)\Psi\left(\frac{\sqrt{x}}{(v,d)},y,\frac{d}{(v,d)},\frac{v}{(v,d)}\right)\\
	&\ll&\sum_{\frac{\sqrt{x}}{(\log x)^{100}}<d<\sqrt{x}(\log x)^{100}}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{x}{d^{2}}\rho\left(\frac{\log x}{2\log y}\right)^{2}\\
	&\ll&x\rho\left(\frac{\log x}{2\log y}\right)^{2}\log\log x.
\end{eqnarray*}
Now we move on to compute $M_{1}(x)$, first we will use Lemma 2.7 and 4.3 to bound $(u,\,d),\,(v,\,d)>L=(\log x)^{15}$. Then one has
\begin{eqnarray*}
	\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,\,d),\,(v,\,d)>L}}\sum_{\substack{s_{1}\le\sqrt{x}\\s_{1}\equiv u\bmod{d}}}\sum_{\substack{s_{2}\le\sqrt{x-s_{1}^{2}}\\s_{2}\equiv v\bmod{d}}}1&=&\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,\,d),\,(v,\,d)>L}}\frac{x}{d^{2}}\rho\left(\frac{\log x}{2\log y}\right)^{2}\\
	&\ll&x\rho\left(\frac{\log x}{2\log y}\right)^{2}(\log D)^{4}L^{-\frac{1}{3}}\\
	&\ll&\frac{x}{\log x}\rho\left(\frac{\log x}{2\log y}\right)^{2}.
\end{eqnarray*}
Hence the ranges $(u,\,d),\,(v,\,d)>L$ contain the error term. Let $M_{2}(x)$ be defined as $M_{1}(x)$ but with the addtional constraints $(u,\,d),\,(v,\,d)\le L$, then $M_{1}(x)=M_{2}(x)+O\left(\frac{x}{\log x}\rho\left(\frac{\log x}{2\log y}\right)^{2}\right)$.
Next, we will use the partial summation to estimate $M_{2}(x)$, but the range $s_{1}\le\sqrt{x}$ is too large, wo we split it into two parts, over $s_{1}\le\sqrt{x-\frac{x}{L}}$ and $\sqrt{x-\frac{x}{L}}\le s_{1}\le\sqrt{x}$.
The term contains the second part does not exceed
\begin{eqnarray*}
	\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\sum_{\substack{\sqrt{x-\frac{x}{L}}\le s_{1}\le \sqrt{x}\\s_{1}\equiv u\bmod{d}}}\Psi\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)},\,y;\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)&\ll&\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,\,d),\,(v,\,d)\le L}}\sum_{\substack{\sqrt{x-\frac{x}{L}}\le s_{1}\le \sqrt{x}\\s_{1}\equiv u\bmod{d}}}\frac{\sqrt{x}}{d}\rho\left(\frac{\log x}{2\log y}\right)\\
	&\ll&\frac{x}{L}\rho\left(\frac{\log x}{2\log y}\right)^{2}\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{1}{d^{2}}\\
	&\ll&\frac{x}{(\log x)^{14}}\rho\left(\frac{\log x}{2\log y}\right)^{2}.
\end{eqnarray*}
Then we estimate the first part. Let
\begin{eqnarray}
	M_{3}(x)&=&\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}\\(u,\,d),\,(v,\,d)\le L}}\sum_{\substack{s_{1}\le \sqrt{x-\frac{x}{L}}\\s_{1}\equiv u\bmod{d}}}\Psi\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)},\,y;\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right),
\end{eqnarray}
where
\begin{eqnarray*}
	\Psi\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)},\,y;\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)&=&\frac{\sqrt{x-s_{1}^{2}}}{d}\rho\left(\frac{\log\left(\sqrt{x-s_{1}^{2}}/(v,\,d)\right)}{\log y}\right)+E\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)},\,y;\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)\\
	&&+O\left(\frac{\sqrt{x}}{d}\rho\left(\frac{\log x}{2\log y}\right)\frac{(\log\log x)^{2}}{\log y}\right).
\end{eqnarray*}
Then we have
$$M_{2}(x)=M_{3}(x)+O\left(\frac{x}{(\log x)^{14}}\rho\left(\frac{\log x}{2\log y}\right)^{2}\right).$$
The sum contains $O\left(\sqrt{x}\rho\left(\frac{\log x}{2\log y}\right)\frac{(\log\log x)^{2}}{\log y}\right)$ dose not exceed 
$$x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)^{2}}{\log y}\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{1}{d^{2}}\ll x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)^{2}\log x}{\log y}.$$
Next, we consider the terms involving $E\left(\frac{\sqrt{x-s_{1}^{2}}}{(v,\,d)},\,y;\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)$. Using Lemma 3.2 and 4.4, we have $E\left(x,\,y;\,q,\,a\right)\ll\frac{\Psi(x,\,y)}{\varphi(q)\log x}$. Then it does not exceed
$$\frac{x}{\log x}\rho\left(\frac{\log x}{2\log y}\right)^{2}\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv0\bmod{d}}}\frac{1}{d^{2}}\ll x\rho\left(\frac{\log x}{2\log y}\right)^{2}.$$
Let 
\begin{eqnarray}
	f_{(v,\,d)}(x)=\frac{x}{d}\rho\left(\frac{\log\frac{x}{(v,\,d)}}{\log y}\right),\quad 	f_{(u,\,d)}(x)=\frac{x}{d}\rho\left(\frac{\log\frac{x}{(u,\,d)}}{\log y}\right).
\end{eqnarray} 
Now we move on to consider the inner sum in (4.15). In fact, by partial summation and a change of variable,
$$\sum_{\substack{s_{1}\le\sqrt{x-\frac{x}{L}}\\s_{1}\equiv u\bmod{d}}}f_{(v,\,d)}\left(\sqrt{x-s_{1}^{2}}\right)=f_{(v,\,d)}\left(\sqrt{\frac{x}{L}}\right)\sum_{\substack{s_{1}\le\sqrt{x-\frac{x}{L}}\\s_{1}\equiv u\bmod{d}}}1+\int_{\sqrt{\frac{x}{L}}}^{\sqrt{x-\frac{x}{L}}}f'_{(v,\,d)}(t)\sum_{\substack{s_{1}\le\sqrt{x-t^{2}}\\s_{1}\equiv u\bmod{d}}}dt.$$
The first summand on the right-hand-side is $O\left(\frac{x}{d^{2}\sqrt{L}}\rho\left(\frac{\log x}{2\log y}\right)^{2}\right)$, whence by Lemma 2.6, its contribution to (4.15), after summation over $u,\,v$ is $O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}(\log x)^{-\frac{13}{2}}\right)$, and is therefore negligible. For the second summand, we split the integral into two parts, over $\left[\sqrt{\frac{x}{L}},\,\sqrt{x-\frac{x}{L}}\right]$ and $\left[\sqrt{x-\frac{x}{L}},\,\sqrt{x}\right]$. 
Observe that 
\begin{eqnarray}
	f'_{(v,\,d)}(t)=\frac{1}{d}\left(\rho\left(\frac{\log\frac{t}{(v,\,d)}}{\log y}\right)+\frac{\rho'\left(\frac{\log\frac{t}{(v,\,d)}}{\log y}\right)}{\log y}\right).
\end{eqnarray}
By [15, Part II, Theorem 5.7] and [15, Part II, Corollary 5.14], we have $|\rho'\left(\frac{\log x}{2\log y}\right)|\ll\rho\left(\frac{\log x}{2\log y}\right)\log\log x$ and $|\rho^{(k)}(u)|\ll\rho(u)(\log u)^{k}$, then $f'(t)\ll\rho\left(\frac{\log x}{2\log y}\right)$. Hence the contribution of the second part to (4.15) does not exceed
$$\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{\sqrt{x}}{d^{2}}\rho\left(\frac{\log x}{2\log y}\right)^{2}\int_{\sqrt{x-\frac{x}{L}}}^{\sqrt{x}}\sqrt{x-t^{2}}dt\ll\frac{x}{L}\rho\left(\frac{\log x}{2\log y}\right)^{2}\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{1}{d^{2}}\ll\frac{x}{(\log x)^{14}}\rho\left(\frac{\log x}{2\log y}\right)^{2}.$$
We now evaluate the first part, over $\left[\sqrt{\frac{x}{L}},\,\sqrt{x-\frac{x}{L}}\right]$. To simplify the notations, let $z=\sqrt{x}t$, 
$$U_{3}=\frac{\log\left(\sqrt{x-t^{2}}/(v,\,d)\right)}{\log y},\quad U_{4}=\frac{\log\left(t/(v,\,d)\right)}{\log y},\quad \eta_{3}=\frac{\log\sqrt{1-z^{2}}-\log(v,\,d)}{\log y},\quad \eta_{4}=\frac{\log z}{\log y},$$
then we have $U_{j}=\frac{\log x}{2\log y}+\eta_{j}$, $\eta_{j}<0$ and $|\eta_{j}|\ll\frac{\log L}{\log y}\ll\frac{1}{(\log\log x)^{\frac{16}{15}}}$. By Mean Value Theorem, we have
\begin{eqnarray*}
	\rho(U_{j})&=&\rho\left(\frac{\log x}{2\log y}\right)+\eta_{j}\rho'\left(\xi_{1}\right),\\
	\rho'(U_{j})&=&\rho'\left(\frac{\log x}{2\log y}\right)+\eta_{j}\rho''(\xi_{2}),
\end{eqnarray*}
where $U_{j}\le\xi_{j}\le\frac{\log x}{2\log y}$.
Hence we have
\begin{eqnarray}
	\rho(U_{j})&=&\rho\left(\frac{\log x}{2\log y}\right)+O\left(\frac{(\log\log x)^{2}}{\log y}\rho\left(\frac{\log x}{2\log y}\right)\right),\\
	\rho'(U_{j})&=&\rho'\left(\frac{\log x}{2\log y}\right)+O\left(\frac{(\log\log x)^{3}}{\log y}\rho\left(\frac{\log x}{2\log y}\right)\right).
\end{eqnarray}
The sum over $s_{1}$ in the above integral equals to $\Psi\left(\frac{\sqrt{x-t^{2}}}{(v,\,d)},\,y;\,\frac{d}{(v,\,d)},\,\frac{v}{(v,\,d)}\right)$ and may be replaced by $f_{(u,\,d)}\left(\sqrt{x-t^{2}}\right)$ with (4.16). By Lemma 2.6, the contribution of the error term in (5.15) does not exceed $O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)^{2}\log x}{\log y}\right)$. Therefore
$$M_{3}(x)=\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\int_{\sqrt{\frac{x}{L}}}^{\sqrt{x-\frac{x}{L}}}f'_{(v,\,d)}(t)f_{(u,\,d)}\left(\sqrt{x-t^{2}}\right)dt+O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)^{2}\log x}{\log y}\right).$$
And by (4.16), (4.17), (4.18) and (4.19), we have
\begin{eqnarray*}
	f_{(v,\,d)}'(t)f_{(u,\,d)}(\sqrt{x-t^{2}})&=&\frac{\sqrt{x-t^{2}}}{d^{2}}\left(\rho(U_{3})\rho(U_{4})+\frac{\rho(U_{3})\rho'(U_{4})}{\log y}\right)\\
	&=&\frac{\sqrt{x-t^{2}}}{d^{2}}\left(\rho\left(\frac{\log x}{2\log y}\right)^{2}+O\left(\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{\log\log x}{\log y}\right)\right).
\end{eqnarray*}
The contribution of the error term does not exceed $O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)\log x}{\log y}\right)$.
Observe that $\int_{\sqrt{\frac{x}{L}}}^{\sqrt{x-\frac{x}{L}}}\sqrt{x-t^{2}}dt=x\int_{0}^{1}\sqrt{1-t^{2}}dt+O\left(\frac{x}{\sqrt{L}}\right)$.
Hence 
\begin{eqnarray*}
	M_{3}(x)&=&\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{1}{d^{2}}\int_{\sqrt{x-\frac{x}{L}}}^{\sqrt{x}}\sqrt{x-t^{2}}\rho\left(\frac{\log x}{2\log y}\right)^{2}dt+O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)^{2}\log x}{\log y}\right)\\
	&=&x\rho\left(\frac{\log x}{2\log y}\right)^{2}\sum_{d\le D}\sum_{\substack{u,v\bmod{d}\\u^{2}+v^{2}\equiv-1\bmod{d}}}\frac{1}{d^{2}}\int_{0}^{1}\sqrt{x-t^{2}}dt+O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)^{2}\log x}{\log y}\right)\\
	&=&\frac{\pi}{8}xC_{1}\rho\left(\frac{\log x}{2\log y}\right)^{2}\log x+O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)^{2}\log x}{\log y}\right).
\end{eqnarray*}
Therefore
\begin{eqnarray*}
	S_{1}(x)&=&2M_{1}(x)+O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\log\log x\right)\\
	&=&2M_{2}(x)+O\left(\frac{x}{\log x}\rho\left(\frac{\log x}{2\log y}\right)^{2}\right)+O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\log\log x\right)\\
	&=&\frac{\pi}{4}C_{1}x\rho\left(\frac{\log x}{2\log y}\right)^{2}\log x+O\left(x\rho\left(\frac{\log x}{2\log y}\right)^{2}\frac{(\log\log x)^{2}\log x}{\log y}\right).
\end{eqnarray*}
\begin{thebibliography}{99}
	\small \setlength{\itemsep}{-.8mm}
	\bibitem{V-J-R} V. Blomer, J. Br\"{u}den and R. Dietmann. Sums of smooth squares. Composition Math., 145: 1401--1441, 2009.  DOI 10.1112/S0010437X09004254
	\bibitem{E} E. Bombieri, J. B. Friedlander and H. Iwaniec. Primes in arithmetic progressions to large moduli.
	Acta Math., 156(3--4):203--251, 1986.  DOI 10.1007/BF02399204
	\bibitem{D} Sary Drappeau. Th$\mathrm{\acute{e}}$or$\mathrm{\grave{e}}$mes de type Fouvry-Iwaniec pour les entiers fraibles. Composition Math., 151: 828--862, 2015. DOI 10.1112/S0010437X14007933
	\bibitem{F} $\mathrm{\acute{E}}$. Fouvry. Sur le probl$\mathrm{\grave{e}}$me des diviseurs de Titchmarsh. J. Reine Angew. Math., 357:51--76, 1985. DOI 10.1515/crll.1985.357.51
	\bibitem{F-T} $\mathrm{\acute{E}}$. Fouvry, Grald Tenenbaum. Entiers sans grand facteur premier en progressions arithmetiques. Proceedings of the London Mathematical Society, 63(3): 449-494, 1991. DOI abs/10.1112/plms/s3-63.3.449
	\bibitem{G-E} G. H. Hardy and E. M. Wright. An introduction to the theory of numbers. Oxford University Press, New York, Fifth edition, 1979.
	\bibitem{H} A. J. Harper, Bombieri-Vinogradov and Barban-Davenport-Halberstam type theorems for smooth
	numbers, Preprint (2012), arXiv:1208.5992.
	\bibitem{H} A. Hilderbran. On the number of positive integers $\le x$ and free of prime factors $>y$. J. Number. Theory, 22(3): 289--307, 1986. DOI 10.1016/0022-314X(86)90013-2
	\bibitem{H-G} A. Hildebrand, G. Tenenbaum. On integers free of large prime factors. Trans. Amer. Math. Soc., 5(2): 411--484. 1993.  DOI 10.2307/2000573
	\bibitem{D} Dimitris Koukoulopoulos. The Distribution of Prime Numbers, volume 203 of Graduate Studies in Mathematics. American Mathematical Society, Province, Rhode Island, 2020.
	\bibitem{L} Junxian Li. A binary quadratic Titchmarsh divisor problem. Acta Arithmetica, 192(4): 341--361, 2020. DOI 10.48550/arXiv.1808.00837
	\bibitem{V} V. A. Plaksin. Asymptotic formula for the number of solutions of an equation with primes. Izv.
	Akad. Nauk SSSR Ser. Mat. 15: 321--397, 1981. DOI 10.1070/IM1982v018n02ABEH001389
	\bibitem{V} V. A. Plaksin. Asymptotic formula for the number of representations of a natural number by a
	pair of quadratic forms, the arguments of one of which are primes. Izv. Akad. Nauk SSSR Ser.
	Mat. 48 1245-1265, 1984. DOI 10.1070/IM1985v025n03ABEH001306
	\bibitem{A} Alisa Sedunova. Intersections of binary quadratic forms in primes and the paucity phenomenon. Journal of Number Theory, 235: 305--327, 2022. DOI 10.48550/arXiv.2107.05525 	
	\bibitem{T} Grald Tenenbaum. Introduction to Analytic and Probabilistic Number Theory, volume 163 of Graduate Studies in Mathematics. American Mathematical Society, Province, Rhode Island, Third edition, 2015.
	\bibitem{E} E. C. Titchmarsh. A divisor problem. Rendiconti del Circolo Matematico di Palermo (1884--1940),
	54(1):414--429, 1930. DOI 10.1007/BF03021203
\end{thebibliography}
\end{document}