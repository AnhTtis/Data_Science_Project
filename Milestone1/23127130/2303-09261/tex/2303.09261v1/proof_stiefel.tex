\subsection{Proof of Theorem~\ref{th:stief_rates}}\label{app:geometric}

\begin{lemma}\label{lem:riemannian_gradient_by_projection}
    Let $(\cM, g)$ be a Riemannian manifold with a Riemannian metric $g_x(\xi, \eta) = \langle \xi, G_x \eta \rangle$ and let $f:\bbR^n \rightarrow \bbR$ be continuously differentiable. Then for any $x \in \cM$ we have
    \begin{equation}\label{eq:riem_gradient_opt_problem}
        \Grad_{\cM} f(x) = \argmin_{v \in \cT_x(\cM)} \frac{1}{2} \norm{v - G^{-1}_x \nabla f(x)}^2_{g_x}.
    \end{equation}
\end{lemma}
\begin{proof}
    Let $v^\star$ be a solution to \eqref{eq:riem_gradient_opt_problem}. Then it could be written as a solution to the following variational inequality
    \[
        \forall v \in \cT_x(\cM): \langle \nabla F(v^\star) , v - v^\star \rangle \geq 0,
    \]
    where $F(v) = \frac{1}{2} \norm{v - G^{-1}_x \nabla f(x)}^2_{g_x}$. By a direct computation we have
    \[
            \forall v \in \cT_x(\cM): \langle G_x v^\star - \nabla f(x) , v - v^\star \rangle \geq 0.
    \]
    Fix an arbitrary $\xi \in \cT_x(\cM)$. Since $\cT_x(\cM)$, we have that $v_1 = \xi + v^\star$ and $v_2 = -\xi + v^\star$ lies in $\cT_x(\cM)$. Thus
    \[
         \langle G_x v^\star - \nabla f(x) , \xi \rangle \geq 0, \quad \langle G_x v^\star - \nabla f(x) , -\xi \rangle \geq 0.
    \]
    Therefore, by arbitrary choice of $\xi$ we have
    \[
        \forall \xi \in \cT_x(\cM): \langle G_x v^\star - \nabla f(x) , \xi \rangle = 0.
    \]
\end{proof}

%\dan{Probably we can use the definition of Riemannian gradients with respect to $Q$-norm, and formulate all the results in terms of $q$-norm. In this case we don't need to write down the monstrous preposition below (I'm not sure).}

\begin{proposition}\label{prop:gof_expression}
  Let $x \in \bbR^n$ be such that $\nabla h(x)$ is of full rank. It holds that:
  \begin{equation*}
    \GOF(x) =  -\nabla h Ah -Q^{-1} \nabla f + Q^{-1} \nabla hB \nabla f \, ,
  \end{equation*}
  with $B(x) \in \bbR^{n_h \times n}$ defined as:
  \begin{equation*}
    B(x)= (\nabla h(x)^{\top} Q^{-1}(x) \nabla h(x))^{-1} \nabla h(x)^{\top} Q^{-1}(x)\, .
  \end{equation*}
\end{proposition}
\begin{proof}
It holds that:
  \begin{equation}
      \argmin_{v \in V} \norm{v + Q^{-1}\nabla f}_{q}^2 = \argmin_{v \in V}\norm{Q^{1/2} v + Q^{-1/2} \nabla f}^2 = Q^{-1/2}\argmin_{v \in Q^{1/2}V} \norm{ v + Q^{-1/2} \nabla f}^2 \, .
  \end{equation}
  Noticing that $Q^{1/2} V := \{v \in \bbR^n : (Q^{-1/2} \nabla h)^{\top}v = 0 \}$, we obtain our claim by applying Lemma~\ref{lm:aff_proj} with $W = Q^{-1/2} \nabla h$, $y = Q^{-1/2} \nabla f$ and $b= 0$.
\end{proof}

Denote $M_q$ the following constant:
  \begin{equation}
      M_q := \sup_{x \in K} \norm{(\nabla h A h)^{\top} Q \nabla h A + \nabla f^{\top} \nabla h A - 2(\nabla h B \nabla f)^{\top} \nabla h A }\, .
  \end{equation}
It will play the same role as $M_1$ (notice that $M_q = M_1$, if $Q = \cI_n$) in the proof of Theorem~\ref{th:gen_rates}.
\begin{lemma}\label{lm:f+v_riem}
  Let \Cref{hyp:cont_model}-\Cref{hyp:riem_proj}. Denoting $v = \GOF(x)$, it holds that
  \begin{equation*}
  \norm{ (Q^{-1}\nabla f + v)^{\top} Q v} \leq M_q \norm{h} \, .
  \end{equation*}
\end{lemma}
\begin{proof}
Note that, as previously, $\nabla h^{\top} v = - \nabla h^{\top} \nabla h A h$. Thus, using Proposition~\ref{prop:gof_expression}, we obtain:
\begin{equation*}
  \begin{split}
    (Q^{-1}\nabla f + v)^{\top} Qv &= -(\nabla h A h)^{\top} Q v + (B\nabla f)^{\top} \nabla h^{\top} v \\
&=-(\nabla h A h)^{\top} Q v  - (B \nabla f)^{\top} \nabla h^{\top}\nabla h A h \\
&= (\nabla h A h)^{\top} Q (\nabla h A h) + (\nabla h A h)^{\top} \nabla f - 2  (\nabla h B \nabla f)^{\top}(\nabla h A h) \\
&= \left( (\nabla h A h)^{\top} Q \nabla h A + \nabla f^{\top} \nabla h A - 2(\nabla h B \nabla f)^{\top} \nabla h A \right) h \, .
  \end{split}
\end{equation*}
This completes the proof by the definition of $M_q$.
\end{proof}

Denote $\overline{M_q}:= M_q/\alpha_m$. The following is an extension of Proposition~\ref{prop:lyap_stoch} to the present case.
\begin{proposition}[Geometry aware discrete Lyapunov function]\label{prop:lyap_sto_geom}
    Let \Cref{hyp:cont_model}--\Cref{hyp:riem_proj} hold. If for all $k$, $\gamma_k \leq \alpha_m^{-1}$, then for all $M \geq \overline{M}_q$, it holds:
\begin{equation}\label{eq:lyap_sto_riem}
    \bbE_k [\Lambda_M(x_{k+1})]- \Lambda_M(x_k) \leq - \gamma_k \norm{ v_k}^2 \left( \frac{1}{C_q} - \frac{L_f + M L_h}{2} \gamma_k\right) + \frac{L_f + ML_h}{2}\sigma^2 \gamma_k^2 \, .
\end{equation}
\end{proposition}
\begin{proof}
    Following the same path as in the proof of Proposition~\ref{prop:lyap_stoch}, we obtain a generalization of Equation~\eqref{eq:f_disc_decr}:
      \begin{equation*}
    \begin{split}
          \bbE_k[f(x_{k+1})] - f(x_k) &\leq \gamma_k \nabla f(x_k)^{\top} v_k + \frac{L_f}{2} \gamma_k^2 \bbE_k[\norm{v_k + \eta_{k+1}}]^2  \\
          &\leq \gamma_k  (Q^{-1}(x_k) \nabla f(x_k))^{\top} Q(x_k) v_k  + \frac{L_f}{2} \gamma_k^2 (\norm{v_k}^2 +\sigma^2)\\
          &\leq - \gamma_k v_k^{\top} Q(x_k) v_k+ (Q^{-1} (x_k) \nabla f(x_k) + v_k)^{\top}Q(x_k) v_k + \frac{L_f}{2} \gamma_k^2 (\norm{v_k}^2 +\sigma^2) \\
          &\leq - \gamma_k \norm{v_k}^2 \left( \frac{1}{C_q} - \frac{L_f}{2} \gamma_k \right) + M_q \norm{h(x_k)}  + \frac{L_f}{2}\gamma_k^2 \sigma^2 \, ,
    \end{split}
  \end{equation*}
  where we have used Lemma~\ref{lm:f+v_riem} for the third and \Cref{hyp:riem_proj} for the fourth inequality.
Since Equation~\eqref{eq:h_disc_decr} remains unchanged, we obtain the claimed inequality.
\end{proof}

The end of the proof of Theorem~\ref{th:stief_rates} then follows, \emph{mutatis mutatis}, the one of Theorem~\ref{th:gen_rates}, upon replacing Proposition~\ref{prop:lyap_stoch} with Proposition~\ref{prop:lyap_sto_geom}.
