\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[backend=bibtex,giveninits=true]{biblatex}
\usepackage{biblatex}
\usepackage{subfig}
\usepackage[normalem]{ulem}
\usepackage{float}
\usepackage{enumitem}





\bibliography{main}


\usepackage{setspace}
\usepackage{xcolor}

\usepackage[margin=1in]{geometry}
\usepackage{comment}

\usepackage{mathtools}

\usepackage{amsmath,amsthm,amssymb,latexsym,amsfonts, dsfont}
\usepackage{graphicx} 
\graphicspath{ {\string~/Desktop/} }
\usepackage[font=footnotesize,labelfont=bf]{caption}
\usepackage{mathabx}
\usepackage{hyperref}
\usepackage{lineno}
\usepackage{amsthm}
\usepackage{bm}
\usepackage{listings}
\usepackage[nottoc,numbib]{tocbibind}
\usepackage{xcolor,colortbl}

\usepackage{thmtools} 
\usepackage{thm-restate}
\usepackage{lipsum}

\newtheorem{theorem}{Theorem}
\newtheorem{algorithm}{Algorithm}
\newtheorem{case}{Case}
\newtheorem{claim}{Claim}
\newtheorem{conclusion}{Conclusion}
\newtheorem{condition}{Condition}
\newtheorem{conjecture}{Conjecture}
\newtheorem{corollary}{Corollary}
\newtheorem{criterion}{Criterion}
\newtheorem{definition}{Definition}
\newtheorem{example}{Example}
\newtheorem{counterexample}{Counterexample}
\newtheorem{exercise}{Exercise}
\newtheorem{lemma}{Lemma}
\newtheorem{notation}{Notation}
\newtheorem{problem}{Problem}
\newtheorem{proposition}{Proposition}
\newtheorem{remark}{Remark}
\newtheorem{solution}{Solution}
\newtheorem{summary}{Summary}
\newtheorem{observation}{Observation}
\newtheorem{fact}{Fact}


\newcommand{\red}{\textcolor{red}}

\newcommand{\ben}[1]{ \textcolor{blue}{Ben: #1}}
\newcommand{\heather}[1]{ \textcolor{purple}{Heather: #1}}
\newcommand{\kirk}[1]{ \textcolor{green}{Kirk: #1}}
\newcommand{\eps}{\varepsilon}


\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}
\def\polylog{\operatorname{polylog}}

\allowdisplaybreaks

\DeclareCiteCommand{\citeyearpar}
    {}
    {\mkbibparens{\bibhyperref{\printdate}}}
    {\multicitedelim}
    {}



\title{Online $k$-Median with Consistent Clusters\footnote{Moseley and Newman are supported in part by  a Google Research Award, an Inform Research Award, a Carnegie Bosch Junior Faculty Chair, and NSF grants CCF-2121744 and  CCF-1845146. Pruhs is supported in part by NSF grants  CCF-1907673,  CCF-2036077, CCF-2209654 and an IBM Faculty Award.}}

\author{Benjamin Moseley\thanks{Tepper School of Business. Carnegie Mellon University.} \and Heather Newman\thanks{Department of Mathematical Sciences. Carnegie Mellon University.} \and Kirk Pruhs\thanks{Computer Science Department. University of Pittsburgh.}}

\begin{document}
\maketitle

\abstract{\input{abstract.tex}}

\input{intro.tex}

\input{technical_overview.tex}

\section{Preliminaries}
First we establish a lower bound depending on $k$ for the competitive ratio of our algorithm. 

\begin{theorem} \label{thm: lower_bd}
The competitiveness versus the budget of any deterministic algorithm
for cluster-centric consistent clustering is $\Omega(k)$. 
\end{theorem}
The proof of Theorem \ref{thm: lower_bd} is in Appendix \ref{appendix: lower_bd}. 

\textbf{Assumptions.} We only assume that the online stream $X$ lies in a metric space. We allow multiple points to arrive at the same location; each duplicated point still has to pay the cost to its nearest center. Whenever we refer to centers, we enforce these come from $X$ itself. (This will be used to ensure our algorithm is well-defined.)

We state our results assuming $B = \textsf{OPT}$, but all results still hold by replacing $\textsf{OPT}$ with $B$, as long as $\textsf{OPT} \leq B$. 
Our algorithm will need to compute offline $k$-median clusterings; to do this in poly-time, use any $c$-approximation algorithm. Thus, replace $B$ with $c \cdot B$ to run our online algorithm in poly-time. 

\textbf{Terminology.} Recall the term \textit{natural weight} from Section \ref{sect:overview}. We will always take $S$ to be some prefix of $X$. As such, we may refer to the natural weights at a particular point in time to mean the natural weights in $S$, where $S$ is the prefix at that time.

Note that for $p \in S$, $w_S(p) \geq 1$, since $d(p,p) = 0$, and that $w_S(p)$ can only increase over time as $S$ enlarges. 

Recall the term \textit{$\beta$-well-separated} from Section \ref{sect:overview}. Related terms we will use are the following: We will say $p$ is $\beta$-\textbf{well-separated from} a set of points $\{x_{\alpha(1)}, \dots, x_{\alpha(m)} \}$ w.r.t. $w$ if $\min\{w(p), w(x_{\alpha(i)})\}\cdot d(p,x_{\alpha(i)}) \geq \beta \cdot \textsf{OPT}$ for all $i \in [m]$. If $m=2$ and the well-separated condition (\ref{eq: well-sep-def}) is not satisfied, we say the pair of points is $\beta$-\textbf{attached}, or that one is $\beta$-attached to the other, w.r.t. $w$.

\section{Algorithm Description} \label{sec: algo}
The algorithm sees an online sequence $X= \{x_1, x_2, \ldots x_n\}$ of points.
Let $X_i =  \{x_1, x_2, \ldots x_i\}$ and $w_i$ be shorthand for $w_{X_i}$. 
The algorithm maintains the following:
\begin{itemize}
    \item a collection of previously arriving points  $p_1, \dots, p_t$ that  have been designated as \textit{pivots},
where $t$ is the number of labels used by the algorithm to date and pivot $p_j$ is associated with label $j$, 
\item
a separation parameter $\beta_t = 8 \cdot 3^{k-t+2}$, and
\item
a collection of previously arriving points $c_1, \ldots, c_T$ that have been designated as estimated centers, where $T \le t$.
\end{itemize}
Initially the first point $x_1$ is given the label 1, the first pivot $p_1$ is set to $x_1$,
and the collection of estimated centers is empty.
The algorithm handles the arrival of each subsequent point $x_i$ in the following manner. The subroutines are described in Sections \ref{sec: est_center_subroutine}, \ref{sec: add_op}, \ref{sec: exchange_op}. 
\begin{enumerate}[label={(\arabic*)}]
    \item \textbf{If} there is an applicable Add or Exchange Operation \textbf{then} compute new Estimated Centers
\begin{enumerate} [label=(\alph*)]
        \item \textbf{Repeat} \text{ while there is an applicable Add Operation or Exchange Operation} 
        \begin{enumerate}
            \item \textbf{If} \text{ there is an applicable Add Operation}
            \textbf{ then} \text{ apply an arbitrary applicable one} 
            \item \textbf{Else} \text{ apply an arbitrary applicable Exchange Operation } 
        \end{enumerate} 
    \end{enumerate}
    \item Give $x_i$ the label $j$, where $p_j$ is the nearest pivot to $x_i$
\end{enumerate} 



Let $T$ be the number of pivots during an execution of the outer loop (1). The Estimated Centers subroutine computes $T$ new estimated centers
$c_1, \ldots, c_T$ from the current pivots $p_1, \ldots p_T$, 
the points $X_{i-1}$, and the current estimated centers $c_1, \ldots c_s$ ($s<T$). 

Let $t \geq T$ be the number of pivots during an execution of the inner loop (a). The Add Operation subroutine is applicable if there is a point $x_\alpha \in X_i$ such that $x_\alpha$ is $\beta_{t+1}$-well-separated from 
the current pivots $p_1, \dots, p_t$ with respect to the weight function $w_i$.
The execution of the Add Operation subroutine depends on $x_\alpha$, $X_i$, the current pivots $p_1, \ldots, p_t$,
and the current estimated centers $c_1, \ldots, c_T$. The Add Operation subroutine adds one or two new pivots, and possibly changes the location of up to two previous pivots.

The Exchange Operation subroutine is applicable  if there
there exists two points $x_\alpha$ and $x_\gamma$ in $X_i$, and a pivot $p_j$ such that:
\begin{itemize}
    \item $x_\alpha$ and $x_\gamma$ are each $\beta_{t+1}$-attached to $p_{j}$ w.r.t. $w_{i}$,
    \item $w_i(p_{j}) \leq w_i(x_\alpha)$,
        \item $w_i(p_{j}) \leq w_i(x_\gamma)$, and
\item The collection of the $t+1$ points, consisting of $x_\alpha$, $x_\gamma$, and the pivots other than $p_j$, are
 $\beta_{t+1}$-well-separated w.r.t. $w_i$.
\end{itemize}
The execution of the Exchange Operation subroutine depends on $x_\alpha$, $x_\gamma$, $X_i$, the current pivots $p_1, \ldots, p_t$,
and the current estimated centers $c_1, \ldots, c_T$. 
The Exchange Operation adds one or two new pivots, and possibly changes the location of one previous pivot.

\subsection{The Estimated Center  Subroutine} \label{sec: est_center_subroutine}


Choose $y_1, \ldots, y_k \in X_{i-1}$ to be an optimal collection of $k$ centers for the points in $X_{i-1}$. (By Fact \ref{fact: Meyerson}, there exists a collection that gives a clustering of cost at most $2\textsf{OPT}$.) Define $p(y_h)$ to be the pivot with the minimum weighted distance to $y_h$, that is, 
\begin{equation} \label{eq: p_arc}
p(y_h) = \argmin_{p_j}  \left(\min\{w_{i-1}(p_j), w_{i-1}(y_h)\} \cdot d(p_j, y_h)\right) \tag{$\dagger$}
\end{equation}
For a pivot $p_j$, let $\delta(p_j)$ be a collection of optimal centers and estimated centers defined 
as follows: the current estimated center $c_j$ (when it exists) is in $\delta(p_j)$ if $w_{i-1}(c_j) > w_{i-1}(p_j)$ and $c_j$ is $\beta_{t+1}$-attached to $p_j$ w.r.t. $w_{i-1}$, and $\delta(p_j)$ contains an optimal center $y_h$ if $w_{i-1}(y_h) > w_{i-1}(p(y_h))$ for $p(y_h) = p_j$.
For each $j \in [T]$  we define the  new \textbf{estimated center} $c_j$ as follows:
If $w_{i-1}(p_j) \ge  \max_{p \in \delta(p_j) } w_{i-1}(p)$ then $c_j = p_j$, else
\begin{equation} \label{eq: good_center}
\centering
c_j = \argmax_{p \in \delta(p_j) } w_{i-1}(p) \tag{$\ddagger$}
\end{equation}

\begin{figure}[ht]
\centering
\includegraphics[width=.9\textwidth]{figures/estimates_add1.png}
\captionsetup{width=.9\linewidth}
\caption{\textbf{Left:} The Estimated Center subroutine. Arrows point from smaller to larger natural weights, and the small points around the larger points are the the set attaining the weight of the larger point. \textbf{Right:} Case (1) of the Add Operation. Dashed lines represent well-separation. Colors except black represent labels. The pivot for label 2 (red) moves to location $c_2$, while the old location for red's pivot becomes the pivot of the new label (5, brown).}
\label{fig: estimates_add1}
\end{figure}



\subsection{The Add Operation Subroutine} \label{sec: add_op}



For shorthand, let $w_t = w_{i-1}$ when $t=T$ and $w_t = w_i$ when $t > T$.\footnote{We are overloading subscripts here for ease. We could instead write $v_t$, but we retain $w$ to recall weights.}
 The description of the Add Operation subroutine is then: 
 
\begin{enumerate} [label={(\arabic*)}]
        \item \textbf{If}  there is an estimated center  $c_{j}$ that is  $\beta_{t+1}$-well-separated from $p_1, \dots, p_t$ w.r.t. $w_i$ then set $p_{t+1} = p_{j}$ and  set $p_{j} = c_{j}$.
        \item \textbf{Else if} it is the case that for every estimated center $c_j$ that is $\beta_{t+2}$-attached to $x_\alpha$ w.r.t. $w_i$ it is also the case that $w_t(c_j) < w_t(p_j)$, then set $p_{t+1} = x_\alpha$.
        \item \textbf{Else if} there exists a unique estimated center $c_{j}$ that both is $\beta_{t+2}$-attached to $x_\alpha$ w.r.t. $w_i$ and satisfies $w_t(c_{j}) \geq w_t(p_{j})$, then set $p_{t+1} = p_{j}$ and $p_{j} = x_\alpha$.
        \item \textbf{Else}  Let $c_{f}$  and  $c_{g}$ be estimated centers such that each is $\beta_{t+2}$-attached to $x_\alpha$ w.r.t. $w_i$,  $w_t(c_{f}) \geq w_t(p_{f})$, and $w_t(c_{g}) \geq w_t(p_{g})$. Then set $p_{t+1} = p_{f}$, $p_{t+2} = p_{g}$, $p_{f} = c_{f}$, and $p_{g} = c_{g}$. 
\end{enumerate}

\begin{figure}[H]
\centering
\includegraphics[width=.9\textwidth]{figures/add4-arxiv.png}
\captionsetup{width=.9\linewidth}
\caption{Case (4) of the Add Operation. Dashed lines represent well-separation while solid lines represent attachment, both w.r.t. $w_i$ (labelled with the appropriate $\beta$). The pivots for labels 2 (red) and 3 (green) move to $c_2, c_3$, resp., while the old locations for these pivots are where the new pivots 5 and 6 (brown and blue) are located.}
\label{fig: add4}
\end{figure}

\subsection{The Exchange Operation Subroutine} \label{sec: exchange_op}


 The description of the Exchange Operation subroutine is: 
    \begin{enumerate} [label={(\arabic*)}]
        \item \textbf{If} $j > T$ then set $p_{j} = x_\alpha$ and $p_{t+1} = x_\gamma$.
            \item \textbf{Else if} $w_i(c_{j}) < w_i(p_{j})$ then set $p_{j} = x_\alpha$ and $p_{t+1} = x_\gamma$. 
            \item \textbf{Else if} $c_{j}$ is $\beta_{t+2}$-attached to $x_\alpha$ w.r.t. $w_i$ then  set $p_{j} = x_\alpha$ and $p_{t+1} = x_\gamma$.
            \item \textbf{Else if} $c_{j}$ is $\beta_{t+2}$-attached to $x_\gamma$ w.r.t. $w_i$ then set $p_{j} = x_\gamma$ and $p_{t+1} = x_\alpha$.
            \item \textbf{Else} set $p_{t+1} = x_\alpha$, $p_{t+2} = x_\gamma$, and $p_{j} = c_{j}$.
    \end{enumerate}

\begin{figure}[ht]
\centering
\includegraphics[width=.9\textwidth]{figures/exchange.png}
\captionsetup{width=.9\linewidth}
\caption{Dashed and solid lines and arrows are as in Figures \ref{fig: estimates_add1} and \ref{fig: add4}. Colors except black represent labels. \textbf{Left:} The configuration triggering the Exchange Operation; dashed lines between $p_1,\dots,p_4$ suppressed. \textbf{Right:} Case (2) of the Exchange Operation. The old location for label 3's (green's) pivot is no longer a pivot location, and label 3's pivot is now $x_{\alpha}$. The new label, label 5 (brown), has its pivot at $x_{\gamma}$.}
\label{fig: exchange}
\end{figure}




\input{main_analysis_arxiv.tex}



\printbibliography

\appendix

\section{Helper Propositions} \label{appendix: helper_props}

\begin{fact}[Fact 2.1 in \cite{meyerson2004k}] \label{fact: Meyerson}
Let $N$ be a set of points, with $S \subseteq N$. Let $k$ be an integer with $0 \leq k \leq n$. Let $K \subseteq S$ be the $k$-element subset of $S$ minimizing $\sum_{x \in S} d(x,K)$ where $d(\cdot, \cdot)$ is the distance function on $N$, and $d(x,K)$ denotes $\min_{m \in K} d(x,m)$. Then if $K'$ is a $k$-element subset of $N$, $\sum_{x \in S} d(x,K) \leq 2 \sum_{x \in S} d(x,K')$. 
\end{fact}


\begin{proposition} \label{prop: meta-prop}
Let $x,y,p$ be three points, and let $w$ denote some associated weights. Assume that $\beta, \beta_x, \beta_y, \textsf{OPT} > 0$. Suppose that $w(x) \leq w(p)$ and that $x$ and $y$ are $(\beta, \textsf{OPT})$-well-separated w.r.t. $w$. If $x$ and $p$ are $(\beta_x, \textsf{OPT})$-attached w.r.t. $w$, and $y$ and $p$ are $(\beta_y, \textsf{OPT})$-attached w.r.t. $w$, then $\beta < \beta_x + \beta_y$. 
\end{proposition}

\begin{proof}[Proof of Proposition \ref{prop: meta-prop}]
We consider two cases. First, suppose that $w(p) \leq w(y)$. Then 
\begin{align*}
\beta \cdot \textsf{OPT} & \leq w(x) \cdot d(x,y) \\
& \leq w(x) \cdot d(x,p) + w(x) \cdot d(p,y) \\
&\leq w(x) \cdot d(x,p) + w(p) \cdot d(p,y) \\
&< \beta_x \cdot \textsf{OPT} + \beta_y \cdot \textsf{OPT}.
\end{align*}
For the second case, $w(y) \leq w(p)$. Then 
\begin{align*}
\beta \cdot \textsf{OPT} &\leq \min\{w(x), w(y)\} \cdot d(x,y) \\
&\leq \min\{w(x), w(y)\} \cdot d(x,p) + \min\{w(x), w(y)\} \cdot d(y,p) \\
&\leq w(x) \cdot d(x,p) + w(y) \cdot d(y,p) \\
&< \beta_x \cdot \textsf{OPT} + \beta_y \cdot \textsf{OPT}.
\end{align*}
\end{proof}

\section{Lower Bound} \label{appendix: lower_bd}

\input{lower_bound.tex}


\section{Omitted Proofs from Section \ref{sec:invariant}} \label{appendix: omitted_proofs_invariant}







\begin{proof}[Proof of Proposition \ref{prop: attached_estimated_center}]
By the definition (\ref{eq: good_center}) of $c_j^T$, we know that $c_j^T \in \delta^+(p_j^T) \cup p_j^T \subseteq \\ \{y_1, \dots, y_l, p_j^T, c_j^{T^-}\}$. By Proposition \ref{prop: digraph_attachment} and the fact that $c_j^{T^-} \in \delta^+(p_j^T)$ only if $c_j^{T^-}$ is $\beta_{T+1}$-attached to $p_j^T$ w.r.t. $w^T$, $c_j^T$ is $\beta_{T+1}$-attached to $p_j^T$ w.r.t. $w^T$. That $w^T(c_j^T) \geq w^T(p_j^T)$ follows directly from $c_j^T$ maximizing $w^T$ over a set that includes $p_j^T$, and this is with equality if and only if $c_j^T = p_j^T$ due to the tiebraking rule in the definition (\ref{eq: good_center}) of estimated center. 
\end{proof}

\begin{proof}[Proof of Lemma \ref{lem: well-sep-invariant}]
The proof will consist of an inner induction nested in an outer induction. Let $1 = T_1 < T_2 < \cdots < T_L \leq k$ denote the non-intermediate phases (i.e., phases during which at least one point receives a label). 
Take $T = T_i$, so that $T^+ = T_{i+1}$. In the \textit{outer induction}, we will prove Lemma \ref{lem: well-sep-invariant} for the non-intermediate phases: i.e., if $p_1^T, \dots, p_T^T$ are $\beta_{T}$-well-separated w.r.t. the natural weights at the start of phase $T$, then $p_1^{T^+}, \dots, p_{T^+}^{T^+}$ are $\beta_{T^+}$-well-separated w.r.t. the natural weights at the start of phase $T^+$. Note the base case is satisfied, since $\{p_1^1\}$ is trivially a $\beta_1$-well-separated set w.r.t. the natural weights at the start of phase 1, thus also w.r.t. the natural weights at the end of phase 1. Given the inductive assumption that $p_1^T, \cdots, p_T^T$ are $\beta_T$-well-separated w.r.t. the natural weights at the start of phase $T$, we prove the following claim. Taking $t=T^+$ in the claim completes the proof. 



\innerinduct*

 Note that if (a) holds, another Add Operation is available, so $t < T^+$.
 
 The proof of Proposition \ref{prop: intermediate_attachment} will be the \textit{inner induction}. The first part (\ref{eq: well-sep-inner-induction}) of the claim establishes that Lemma \ref{lem: well-sep-invariant} holds for the intermediate phases. Note that while we only need to prove (\ref{eq: well-sep-inner-induction}) to establish Lemma \ref{lem: well-sep-invariant}, we will need to couple the inner induction with the second part of the claim to actually prove (\ref{eq: well-sep-inner-induction}). The second part of the claim states that, upon the arrival of the single point $x_i$, as we consecutively reset the pivots until no Add Operation or Exchange Operation is available, the (fixed) estimated center $c_j^T$ for cluster $j$ at the end of phase $T$ remains attached to the pivot for label $j$ --- even though the well-separation parameter $\beta_t$ decreases and the pivot for label $j$ may change position.


\begin{proof}[Proof of Proposition \ref{prop: intermediate_attachment}]
The proof is by induction. First we prove the base case $t = T$. We know that $p_1^T, \dots, p_T^T$ are $\beta_{T}$-well-separated w.r.t. the weights at the start of phase $T$ by the inductive assumption of the outer induction, thus also w.r.t. $w_{i-1}$. So (\ref{eq: well-sep-inner-induction}) is satisfied. Also, we know that $c_j^T$ is $\beta_{T+1}$-attached to $p_j^T$ w.r.t. $w_{i-1}$ by Proposition \ref{prop: attached_estimated_center}, so (b) is satisfied. This concludes the base case.  

Next we assume the claim holds for $t \in [T, T^+)$. The inductive step is to prove that the claim holds for $t+1$, or when this phase is skipped as in Case 4 of the Add Operation and Case 5 of the Exchange Operation, holds for $t+2$.

\paragraph*{Inductive step for (\ref{eq: well-sep-inner-induction}).} We start by proving the inductive step for the first part (\ref{eq: well-sep-inner-induction}) of the claim for $t+1$ or $t+2$. If one of Cases 1 through 3 of the Add Operation is executed, then (\ref{eq: well-sep-inner-induction}) holds by construction for $t+1$. This is because in these cases the new pivot location ($x_{\alpha}$ or some $c_j^T$, $j \in [T]$) is $\beta_{t+1}$-well-separated from $p_1^t, \cdots, p_t^t$ w.r.t. $w_i = w_{t+1}$. Likewise, if one of Cases 1 through 4 of the Exchange Operation is executed, then (\ref{eq: well-sep-inner-induction}) holds by construction for $t+1$. This is because in these cases the new set of pivots is $\{p_1^t, \cdots, p_t^t\} \cup \{x_{\alpha},x_{\gamma}\} \setminus \{p_{j}^t\}$, which is $\beta_{t+1}$-well-separated w.r.t. $w_i = w_{t+1}$. So it remains to show that (\ref{eq: well-sep-inner-induction}) holds for $t+2$ in Case 4 of the Add Operation and Case 5 of the Exchange Operation. 


\setcounter{case}{0}

\begin{case} \label{cs: well-sep-invariant-3b}
Case 4 of the Add Operation is executed.
\end{case}
 In particular, we need to show that (A) $c_{f}^T$ and $c_{g}^T$ are $\beta_{t+2}$-well-separated w.r.t. $w_{t+2} = w_i$, and (B) $c_{f}^T$ and $c_{g}^T$ are each $\beta_{t+2}$-well-separated from $p_1^t, \dots, p_t^t$ w.r.t. $w_{t+2} = w_i$. \\
 
First we prove (A). Suppose to the contrary that $c_{f}^T$ and $c_{g}^T$ are $\beta_{t+2}$-attached w.r.t. $w_i$. Then $c_{f}^T$ and $c_{g}^T$ are $\beta_{t+2}$-attached w.r.t. $w_{i-1}$, since $w_{i-1} \leq w_i$ holds pointwise. Also, by Proposition \ref{prop: attached_estimated_center}, $c_{f}^T$ is $\beta_{T+1}$-attached to $p_{f}^T$ w.r.t. $w_{i-1}$ and $w_{i-1}(c_{f}^T) \geq w_{i-1}(p_{f}^T)$ (and likewise for $c_g^T, p_g^T$). Since by the base case $p_1^T, \cdots, p_T^T$ are $\beta_{T}$-well-separated w.r.t. $w_{i-1}$, and $\beta_{t+2} + \beta_{T+1} + \beta_{T+1} < \beta_T$, we reach a contradiction through two applications of Proposition \ref{prop: meta-prop}. We conclude that $c_{f}^T$ and $c_{g}^T$ are $\beta_{t+2}$-well-separated w.r.t. $w_{t+2} = w_i$. \\

Next we prove (B). WLOG, we will first show that $c_f^T$ is $\beta_{t+2}$-well-separated from $p_f^t$ w.r.t. $w_{t+2} = w_i$. First, we show that $w_i(c_f^T) \geq w_i(p_f^t)$. This is clearly true for $t>T$, by assumption of Case 4 of the Add Operation and the fact that $w_t = w_i$. When $t=T$, the argument is more subtle. Note that $c_f^T \neq p_f^t$, since $c_f^T$ is $\beta_{t+2}$-attached to $x_{\alpha}$ w.r.t. $w_i$, while $x_{\alpha}$ is $\beta_{t+1}$-well-separated from $p_f^t$ w.r.t. $w_i$. In turn, since $c_f^T \neq p_f^t$ if $t = T$, by Proposition \ref{prop: attached_estimated_center} we have $w_{i-1}(c_f^T) > w_{i-1}(p_f^t)$. Since the natural weights can only go up by 1 on the arrival of $x_i$, this means that $w_i(c_f^T) \geq w_i(p_f^t)$ if $t=T$. So we conclude $w_i(c_f^T) \geq w_i(p_f^t)$ for all $t \in [T, T^+)$ as desired. Thus, by Proposition \ref{prop: meta-prop}, it is not possible for $c_{f}^T$ to be $\beta_{t+2}$-attached to $p_f^t$ w.r.t. $w_i$, since $w_i(c_f^T) \geq w_i(p_f^t)$, $c_f^T$ is $\beta_{t+2}$-attached to $x_{\alpha}$ w.r.t. $w_i$ (by definition of Case 4 of the Add Operation), and $p_f^t$ and $x_{\alpha}$ are $\beta_{t+1}$-well-separated w.rt. $w_i$ (by definition of the Add Operation). 

To finish the proof of (B), we need to show that $c_f^T$ is $\beta_{t+2}$-well-separated from $p_l^t$ w.r.t. $w_{t+2}$, $l \in [t] \setminus f$. By the inductive assumption, at least one of statements (a)---(c) in the statement of the proposition holds. Note that (a) in the statement of the proposition does not hold, for else Case 1 of the Add Operation would have been executed. Also (c) in the statement of the proposition does not hold, since by assumption of Case 4 of the Add Operation, $w_t(c_f^T) \geq w_t(p_f^t)$. So (b) in the statement of the claim holds, i.e., $c_f^T$ is $\beta_{t+1}$-attached to $p_f^t$ w.r.t. $w_t$. Also by the inductive assumption, $p_f^t$ and $p_l^t$ are $\beta_t$-well-separated w.r.t. $w_t$. Since $\beta_{t+1} + \beta_{t+2} < \beta_t$, it must be the case by Proposition \ref{prop: meta-prop} that $c_f^T$ and $p_l^t$ are $\beta_{t+2}$-well-separated w.r.t. $w_t$ for $l \neq f$. Thus $c_f^T$ and $p_l^t$ are $\beta_{t+2}$-well-separated w.r.t. $w_{t+2}$ as well, concluding the proof of (B) and of Case \ref{cs: well-sep-invariant-3b}. 
 


\begin{case}
Case 5 of the Exchange Operation is executed.
\end{case}
First note that $\{x_{\alpha},x_{\gamma}\} \cup \{p_l^t \mid l \in [t] \setminus j\}$ is $\beta_{t+1}$-well-separated w.r.t. $w_{t+2} = w_i$ by assumption of the Exchange Operation, thus this set is also $\beta_{t+2}$-well-separated w.r.t. $w_i$. 

Next, we need to show that $c_{j}^T$ is $\beta_{t+2}$-well-separated from $\{p_l^t \mid l \in [t] \setminus j\} \cup \{x_{\alpha},x_{\gamma}\}$ w.r.t. $w_i$. Since Cases 3 and 4 of the Exchange Operation were not executed, $c_{j}^T$ is $\beta_{t+2}$-well-separated from $x_{\alpha}$ and from $x_{\gamma}$ w.r.t. $w_i$. 

Next, note that since an Add Operation, which takes precedence over an Exchange Operation, was not executed, (a) in the statement of the proposition cannot hold in the inductive assumption for $j$. Moreover, since Case 2 of the Exchange Operation is not executed and (c) in the statement of the proposition cannot hold when $t=T$ (by Proposition \ref{prop: attached_estimated_center}), (c) in the statement of the proposition cannot hold in the inductive assumption for $j$. We conclude $c_j^T$ is $\beta_{t+1}$-attached to $p_{j}^t$ w.r.t. $w_t$ and $w_t(c_{j}^T) \geq w_t(p_{j}^t)$. This implies by Proposition \ref{prop: meta-prop} that $c_{j}^T$ is $\beta_{t+2}$-well-separated from $p_l^t$ w.r.t. $w_t$ for $l \neq j$, since $p_{j}^t$ and $p_l^t$ are $\beta_{t}$-well-separated w.r.t. $w_t$ by the inductive assumption. Hence $c_{j}^T$ is $\beta_{t+2}$-well-separated from $p_l^t$ w.r.t. $w_{t+1} = w_i$ for $l \in [t] \setminus j$. 


\paragraph*{Inductive step for (a)---(c).}  Next we prove the inductive step holding for the second part of the proposition. We first introduce the following fact which we will use repeatedly in the rest of the proof. 


 \begin{fact} \label{fact: centers-well-sep}
Let $j, j' \in [T]$, $j \neq j'$. Then $c_j^T$ and $c_{j'}^T$ are $\beta_{T+1}$-well-separated w.r.t. $w_{i-1}$.
\end{fact}

\begin{proof}[Proof of Fact \ref{fact: centers-well-sep}]
Suppose to the contrary that $c_j^T$ and $c_{j'}^T$ are $\beta_{T+1}$-attached w.r.t. $w_{i-1}$. We also know by Proposition \ref{prop: attached_estimated_center} that $c_j^T, c_{j'}^{T}$ are $\beta_{T+1}$-attached to $p_j^T, p_{j'}^T$, respectively, w.r.t. $w_{i-1}$, and that $w_{i-1}(c_j^T) \geq w_{i-1}(p_j^T)$ and $w_{i-1}(c_{j'}^T) \geq w_{i-1}(p_{j'}^T)$. By the base case of the inner induction, $p_1^T, \cdots, p_T^T$ are $\beta_T$-well-separated w.r.t. $w_{i-1}$, so applying Proposition \ref{prop: meta-prop} gives a contradiction. 
\end{proof}

In the remainder of the proof, we need to show that, given the inductive assumption that Proposition \ref{prop: intermediate_attachment} holds for $t$, we have that at least one of statements (a)--(c) holds for $t+1$ (or when this phase is skipped, $t+2$). (Recall we already proved the first part of the inductive step, i.e.,  (\ref{eq: well-sep-inner-induction}) holds for $t+1$.) 

We case on which operation is executed to generate the new set of $t+1$ (or $t+2$) pivots from $p_1^t, \dots, p_t^t$, and on which of statements (a)--(c) holds in the inductive assumption for $t$. 


\setcounter{case}{0}

\begin{case} \label{cs1addmove}
Case 1 of the Add Operation is executed.
\end{case}
Let $j^*$ be the specific $j$ chosen in Case 1 of the Add Operation. We need to show that for every $j \in [T]$, at least one of statements (a)--(c) holds for $t+1$. \\
If $j = j^*$, then $p_j^{t+1} = c_j^T$, so certainly $c_j^T$ is $\beta_{t+2}$-attached to $p_j^{t+1}$ w.r.t. $w_{t+1}$, so statement (b) is satisfied for $t+1$. \\
Now we consider $j \neq j^*$. We case on which of statements (a)--(c) holds for $j \in [T]$ in the inductive assumption for $t$. \\

\noindent \underline{If statement (a) holds in the inductive assumption for $t$.} 
Then by definition, $c_j^T$ is $\beta_{t+1}$-well-separated from $p_1^t, \dots, p_t^t$ w.r.t. $w_i$, so it must also be $\beta_{t+2}$-well-separated from $p_1^t, \dots, p_t^t$ w.r.t. $w_i$. Moreover, by Fact \ref{fact: centers-well-sep}, $c_j^T$ is $\beta_{T+1}$-well-separated (thus $\beta_{t+2}$-well-separated) from $p_{j^*}^{t+1} = c_{j^*}^T$ w.r.t. $w_{i-1}$, thus also w.r.t. $w_i$. Since $\{p_1^{t+1}, \dots, p_{t+1}^{t+1}\} = \{p_1^t, \dots, p_t^t, c_{j^*}^T\}$, statement (a) holds for $c_j^T$ and the inductive step $t+1$ is satisfied. 
\\


\noindent \underline{Else if statement (c) holds in the inductive assumption for $t$.} 
Note that $p_j^t = p_j^{t+1}$ for $j \neq j^*$ when Case 1 is executed. Moreover, if statement (c) holds, it must be the case that $t > T$, since $w_{i-1}(c_j^T) \geq w_{i-1}(p_j^T)$ by construction. But if $t > T$, then $w_{t+1} = w_{t} = w_i$. Also, $f(t+1, T) > f(t,T)$. So statement (c) still holds for $t+1$. 
\\

\noindent \underline{Else statement (b) holds in the inductive assumption for $t$.} 
In this case, since statement (c) does not hold, then $c_j^T$ is $\beta_{t+1}$-attached to $p_j^t$ w.r.t. $w_t$, and $w_t(c_j^T) \geq w_t(p_j^t)$ (the latter inequality holds because if $t=T$, this is true by definition, and if $t >T$, then $f(t,T) = \beta_T(t-T) > \beta_{t+1}$.) It is not possible for $c_j^T$ to be $\beta_{t+2}$-attached to $p_{j'}^t$ w.r.t. $w_{t+1}$ for $j'\in [t] \setminus j$ , since this would mean $c_j^T$ is $\beta_{t+2}$-attached to $p_{j'}^t$ w.r.t. $w_t$ as well. But if this were true, then we get a contradiction by Proposition \ref{prop: meta-prop}, because $p_j^t$ and $p_{j'}^t$ are $\beta_t$-well-separated w.r.t. $w_t$ by the inductive assumption. Also, it is not possible for $c_j^T$ to be $\beta_{t+2}$-attached to $p_{j^*}^{t+1} = c_{j^*}^T$ w.r.t. $w_{t+1}$, thus also w.r.t. $w_{i-1}$, by Fact \ref{fact: centers-well-sep}. So either $c_j^T$ is $\beta_{t+2}$-well-separated from $\{p_1^t, \dots, p_t^t, c_{j^*}^T\} = \{p_1^{t+1}, \dots, p_{t+1}^{t+1} \}$ w.r.t. $w_{t+1} = w_i$; or, $c_j^T$ is $\beta_{t+2}$-attached to $p_j^t = p_j^{t+1}$ w.r.t. $w_{t+1}$. So statement (a) or statement (b) must hold for $t+1$. 
\\

 In the remaining cases of the Add Operation, it is not possible that statement (a) holds in the inductive assumption for $t$, for then Case 1 of the Add Operation would have been executed. Thus we can omit statement (a) from the casework. 


\begin{case} \label{cs2addmove}
Case 2 of the Add Operation is executed. 
\end{case}

\noindent \underline{If statement (c) holds in the inductive assumption for $t$.} The reasoning is the same as in Case \ref{cs1addmove} (except there is no distinguished $j^*$). \\

\noindent \underline{Else statement (b) holds in the inductive assumption for $t$.} Since statement (c) does not hold, we have $w_t(c_j^T) \geq w_t(p_j^t)$ (the reasoning is the same as in Case \ref{cs1addmove}). But by the assumptions of Case 2 of the Add Operation, this means that $c_j^T$ is $\beta_{t+2}$-well-separated from $x_{\alpha}$ w.r.t. $w_i$.  So either $c_j^T$ is $\beta_{t+2}$-well-separated from $\{p_1^t, \dots, p_t^t, x_{\alpha}\} = \{p_1^{t+1}, \dots, p_{t+1}^{t+1}\}$ w.r.t. $w_i$, or $c_j^T$ is $\beta_{t+2}$-attached to $p_j^t = p_j^{t+1}$ w.r.t. $w_i = w_{t+1}$, by the same reasoning as in Case \ref{cs1addmove} (except there is no distinguished $j^*$). So statement (a) or statement (b) must hold for $t+1$. 


\begin{case} \label{cs3a_addmove}
Case 3 of the Add Operation is executed. 
\end{case}

Let $j^*$ be as in $j$ chosen in Case 3 of the Add Operation. We need to show that for every $j \in [T]$, at least one of statements (a)---(c) holds for $t+1$. \\
If $j=j^*$, then $p_j^{t+1} = x_{\alpha}$, and by definition of $j^*$, $c_j^T$ is $\beta_{t+2}$-attached to $p_j^{t+1}$ w.r.t. $w_i = w_{t+1}$, so statement (b) is satisfied for $t+1$.\\
Now we consider $j \neq j^*$. We case on which of statements (a)---(c) holds for $j \in [T]$ in the inductive assumption for $t$.  \\

\noindent \underline{If statement (c) holds in the inductive assumption for $t$.} The reasoning is the same as in Case \ref{cs1addmove}. \\

\noindent \underline{Else statement (b) holds in the inductive assumption for $t$.} Note that since $w_t(c_j^t) \geq w_t(p_j^t)$ and $j \neq j^*$  (for the same reasoning as in Case \ref{cs1addmove}),  $c_j^T$ is $\beta_{t+2}$-well-separated from $p_{j^*}^{t+1} = x_{\alpha}$ w.r.t. $w_i$ (by the assumptions of Case 3 of the Add Operation and the uniqueness of $j^*$). Now the reasoning is the same as in Case \ref{cs1addmove}.



\begin{case} \label{cs3b_addmove}
Case 4 of the Add Operation is executed. 
\end{case}

Let $f$ or $g$ be as in Case 4 of the Add Operation. We need to show that for every $j \in [T]$, at least one of the statements (a)---(c) holds for $t+2$. (Note phase $t+1$ is skipped.)
If $j = f$ or $g$, then $p_j^{t+2} = c_j^T$, so certainly $c_j^T$ is $\beta_{t+3}$-attached to $p_j^{t+2}$ w.r.t. $w_{t+2}$, so statement (b) is satisfied for $t+2$. 
Now we consider $j \neq f,g$. We case on which of statements (a)---(c) held for $j \in [T]$ in the inductive assumption for $t$. \\

\noindent \underline{If statement (c) holds in the inductive assumption for $t$.} The reasoning is nearly the same as in Case \ref{cs1addmove}, except now there are two distinguished $f,g$ (instead of just $j^*$), and we use that $f(t+2, T) > f(t,T)$ (instead of that  $f(t+1, T) > f(t,T)$).  \\

\noindent \underline{Else statement (b) holds in the inductive assumption for $t$.} Note that since $j \neq f,g$,  $c_j^T$ is $\beta_{t+3}$-well-separated from $p_{f}^{t+2} = c_{f}^T$ w.r.t. $w_i$ and from $p_{g}^{t+2} = c_{g}^T$ w.r.t. $w_i$, by Fact \ref{fact: centers-well-sep}. By the same reasoning as in Case \ref{cs1addmove}, either $c_j^T$ is $\beta_{t+3}$-attached to $p_j^{t+2} = p_j^t$ w.r.t. $w_i$, or $c_j^T$ is $\beta_{t+3}$-well-separated from $\{p_1^t, \dots, p_t^t, c_{f}^T, c_{g}^T\} = \{p_1^{t+2}, \dots, p_{t+2}^{t+2}\}$ w.r.t. $w_{i}$. So statement (a) or statement (b) must hold for $t+2$. \\


In all cases of the Exchange Operation, it is not possible that statement (a) holds in the inductive assumption for $t$, for then an Add Operation (specifically Case 1) would have been executed instead, as the Add Operation takes precedence over the Exchange Operation. Thus we can omit statement (a) from the casework. Let $j^*$ be the specific $j$ in the description of the Exchange Operation in the algorithm description. 


\begin{case} \label{cs1_exchange_move}
Case 1 of the Exchange Operation is executed. 
\end{case}

We need to show that for every $j \in [T]$, at least one of statements (a)---(c) holds for $t+1$. \\
If $j=j^*$, there is nothing to prove because in Case 1 of the Exchange Operation, $j^* > T$, meaning $c_{j^*}^T$ is not defined.\\
Now we consider $j \neq j^*$. We case on which of statements (a)---(c) holds for $j \in [T]$ in the inductive assumption for $t$.  \\

\noindent \underline{If statement (c) holds in the inductive assumption for $t$.} The reasoning is the same as in Case \ref{cs1addmove}.  \\

\noindent \underline{Else statement (b) holds in the inductive assumption for $t$.} We first claim $c_j^T$ is $\beta_{t+1}$-attached to $p_j^t = p_j^{t+1}$ w.r.t. $w_{t+1}$ (note (b) states this w.r.t. $w_t$ only). For, given that $c_j^T$ is $\beta_{t+1}$-attached to $p_j^t$ w.r.t. $w_t$ and $w_t(c_j^T) \geq w_t(p_j^t)$, it must be the case that $c_j^T$ is $\beta_{t+1}$-well-separated from $p_{j'}^t$ w.r.t. $w_{t}$, for any $j' \neq j$ (by Proposition \ref{prop: meta-prop} and the fact that $p_j^t$ and $p_{j'}^t$ are $\beta_t$-well-separated w.r.t. $w_t$). But this means that $c_j^T$ is $\beta_{t+1}$-well-separated from $p_{j'}^t$ w.r.t. $w_{t+1}$ as well. Thus, if $c_j^T$ were not $\beta_{t+1}$-attached to $p_j^t$ w.r.t. $w_{t+1}$, then it would be $\beta_{t+1}$-well-separated from $\{p_1^t, \dots, p_t^t\}$ w.r.t. $w_{t+1} = w_i$, hence an Add Operation would have been executed instead as the Add Operation  takes precedence over the Exchange Operation. So we conclude that $c_j^T$ is $\beta_{t+1}$-attached to $p_j^t = p_j^{t+1}$ w.r.t. $w_{t+1}$.
\\
If $w_{t+1}(c_j^T) < w_{t+1}(p_j^t)$, then since $t+1 > T$,  statement (c) holds for $t+1$. Otherwise, $w_{t+1}(c_j^T) \geq w_{t+1}(p_j^t)$. Also, $w_{t+1}(x_{\alpha}) \geq w_{t+1}(p_{j^*}^t)$ and $x_{\alpha}$ is $\beta_{t+1}$-attached to $p_{j^*}^t$ w.r.t. $w_{t+1} = w_i$, by definition of the Exchange Operation. So noting that $p_j^t$ and $p_{j^*}^t$ are $\beta_t$-well-separated w.r.t. $w_{t+1}$ and applying Proposition \ref{prop: meta-prop} twice gives that $c_j^T$ is $\beta_{t+2}$-well-separated from $x_{\alpha}$ w.r.t. $w_{t+1}$ (and likewise for $x_{\gamma}$). We also know that $c_j^T$ is $\beta_{t+2}$-well-separated from $p_{j'}^t$ w.r.t. $w_{t+1}$, $j' \neq j$, by the previous paragraph. So either $c_j^T$ is $\beta_{t+2}$-attached to $p_j^t = p_j^{t+1}$ w.r.t. $w_{t+1}$, or $c_j^T$ is $\beta_{t+2}$-well-separated from $\{p_1^t, \cdots, p_t^t, x_{\alpha}, x_{\gamma}\} \setminus \{p_{j^*}^t\} = \{p_1^{t+1}, \dots, p_{t+1}^{t+1}\}$. Thus statement (a) or (b) holds for $t+1$.




\begin{case} \label{cs2a_exchange_move}
Case 2 of the Exchange Operation is executed.
\end{case}

We need to show that for every $j \in [T]$, at least one of statements (a)---(c) holds for $t+1$. \\
First consider $j=j^*$. Since as noted above statement (a) cannot hold for the inductive assumption for $t$, statement (b) or statement (c) must hold for the inductive assumption for $t$. Also, since $w_{t+1} = w_i$, it must be the case that $w_{t+1}(c_j^T) < w_{t+1}(p_j^t)$ by the assumptions of Case 2 of the Exchange Operation. Thus $w_t(c_j^T) \leq w_t(p_j^t)$. 

If $t = T$, then it must be the case that $w_t(c_j^T) = w_t(p_j^t)$ hence $c_j^T = p_j^t$ by the tiebreaking rule in the definition (\ref{eq: good_center}) of estimated center. If $t > T$, then since $w_t = w_{t+1} = w_p$, statement (c) holds for $t$. So in both cases, $w_i(c_j^T) \cdot d(c_j^T, p_j^t) \leq \beta_T(t-T)$. Moreover, by the definition of the Exchange Operation, $w_i(p_j^t) \cdot d(p_j^t, p_j^{t+1}) = w_i(p_j^t) \cdot d(p_j^t, x_{\alpha}) \leq \beta_{t+1} \cdot \textsf{OPT}$. So by Proposition \ref{prop: meta-prop}, $w_i(c_j^T) \cdot d(c_j^T, x_{\alpha}) \leq (\beta_{t+1} + f(t,T)) \textsf{OPT} \leq f(t+1, T) \textsf{OPT}$. Hence statement (c) holds for $t+1$.  

 For $j \neq j^*$, the reasoning is the same as in Case \ref{cs1_exchange_move}.


\begin{case} \label{cs2b_exchange_move}
Case 3 of the Exchange Operation is executed. 
\end{case}

We need to show that for every $j \in [T]$, at least one of statements (a)---(c) holds for $t+1$. \\
First consider $j=j^*$. By the assumptions of of Case 3 of the Exchange Operation, statement (b) holds for $t+1$.  

For $j \neq j^*$, the reasoning is the same as in Case \ref{cs1_exchange_move}.


\begin{case} \label{cs2c_exchange_move}
Case 4 of the Exchange Operation is executed. 
\end{case}

The reasoning is the same as in Case \ref{cs2b_exchange_move}, only now the roles of $x_{\alpha},x_{\gamma}$ are reversed. 


\begin{case} \label{cs2d_exchange_move}
Case 5 of the Exchange Operation is executed. 
\end{case}

We need to show that for every $j \in [T]$, at least one of statements (1)--(3) holds for $t+2$. (Note step $t+1$ is skipped.) \\
First consider $j = j^*$. $c_{j^*}^T$ is $\beta_{t+3}$-attached to $p_{j^*}^{t+2}= c_{j^*}^T$ w.r.t. $w_{t+2}$, so statement (b) holds for for $t+2$. \\
For $j \neq j^*$, $c_j^T$ is $\beta_{t+3}$-well-separated from $c_{j^*}^T$ w.r.t. $w_i$ (Fact \ref{fact: centers-well-sep}). The reasoning is now the same as in Case \ref{cs1_exchange_move} once we note that $\beta_{t+2} > \beta_{t+3}$. 
\end{proof}
Having proven Proposition \ref{prop: intermediate_attachment}, the proof of Lemma \ref{lem: well-sep-invariant} is now complete.  
\end{proof}




\section{Omitted Proofs from Section \ref{sec: proofs_bounded_cost}} \label{appendix: proofs_bounded_cost}



\begin{proof}[Proof of Lemma \ref{lem: sufficiently_weighted_centers}]
 As in Lemma \ref{lem: far_points}, let $C_j = C_j^T \setminus C_j^{T^-}$ and let $S_{ji}$ be the set of elements in $C_j$ assigned to $y_i$ in the clustering of $X(T) \setminus X(T^-)$ induced by $P_T$. Let $S_{far, j} = \bigcup_{i : p(y_i) \neq p_j^T} S_{ji}$, $S_{near, j} = \bigcup_{i : p(y_i) = p_j^T} S_{ji}$, and $S_j$ be the elements in $C_j$ that are assigned to $p_j^T$ in the clustering of $X(T) \setminus X(T^-)$ induced by $P_T$. 

The proof is by induction. We have that 
\begin{equation} \label{eq: set_szs}
|C_j^T| = |C_j^{T^-}| + |C_j| = |C_j^{T^-}| + |S_{far,j}| + |S_{near, j}| + |S_j|
\end{equation}
(Note we use that there are no points in $C_j$ that are assigned to $p_{j'}^T$, $j' \neq j$, in the offline clustering induced by $P_T$, due to the greedy labelling rule. This is true as long as in the offline clustering induced by $P_T$ we break ties consistent with how the online algorithm breaks ties.) 

 First, we bound the last three terms. Let $w^t$ denote the natural weights at the end of phase $t$. 
\begin{equation} \label{eq: size_far}
|S_{far, j}| \leq k \cdot w^T(p_j^T) \leq k \cdot w^T(c_j^T)
\end{equation}
where the first inequality follows from Lemma \ref{lem: far_points} and the second inequality follows from the definition (\ref{eq: good_center}) of estimated center. Next, 
\begin{equation} \label{eq: sz_near}
|S_{near, j}| = \sum_{i:p(y_i) = p_j^T} |S_{ji}| \leq \sum_{i:p(y_i) = p_j^T} w^T(y_i) \leq k \cdot w^T(c_j^T)
\end{equation}
where the second inequality follows from the definition of $w^T$. The third inequality follows from the definitions of attachment digraph and estimated center: If $y_i \in \delta^-(p_j^T)$, then $w^T(y_i) \leq w^T(p_j^T)$ by construction of the attachment digraph $D(T)$. Otherwise, $y_i \in \delta^+(p_j^T)$, so by (\ref{eq: good_center}), $w^T(c_j^T) \geq w^T(y_i)$. Finally, 
\begin{equation} \label{eq: size_j}
|S_j| \leq w^T(p_j^T) \leq w^T(c_j^T)
\end{equation}
where the first inequality is by the definition of $w^T$ and the second inequality from (\ref{eq: good_center}).

For simplicity, let $h(t,k) = (2k+1)t$. 
Now we need to bound $|C_j^{T-}|$ in terms of $w^T(c_j^T)$. If $j \not \in [T^-]$, then $|C_j^{T^-}| = 0$. So assume $j \in [T^-]$. Inductively, we have that 
$$|C_j^{T^-}| \leq h(T^-,k) \cdot w^{T^-}(c_j^{T^-}).$$
We will prove that 
\begin{equation} \label{eq: sz_prev}
|C_j^{T^-}| \leq h(T^-, k) \cdot w^T(c_j^T).
\end{equation}

There are two cases to consider. 

\setcounter{case}{0}

\begin{case}
(a) holds in Lemma \ref{lem: well_attached_centers}.
\end{case}
$$|C_j^{T^-}| \leq h(T^-,k) \cdot w^{T^-}(c_j^{T^-}) \leq h(T^-,k) \cdot w^T(p_j^T) \leq h(T^-,k) \cdot w^T(c_j^T).$$

\begin{case}
(b) holds in Lemma \ref{lem: well_attached_centers}.
\end{case}

This means that $c_j^{T^-}$ is $\beta_{T+1}$-attached to $p_j^T$ w.r.t. $w^T$. If $w^T(c_j^{T^-}) 
 \leq w^T(p_j^T)$, then $w^T(c_j^{T^-}) \leq w^T(c_j^T)$. Otherwise, $w^T(c_j^{T^-}) > w^T(p_j^T)$, so $c_j^{T^-} \in \delta^+(p_j^T)$. By (\ref{eq: good_center}), $w^T(c_j^{T^-}) \leq w^T(c_j^{T})$. In both cases we have $w^T(c_j^{T^-}) \leq w^T(c_j^T)$, so building from the inductive assumption,
 $$|C_j^{T^-}| \leq h(T^-,k) \cdot w^{T^-}(c_j^{T^-}) \leq h(T^-, k) \cdot w^T(c_j^{T^-}) \leq h(T^-, k) \cdot w^T(c_j^T)$$
 which concludes the case. Putting equations (\ref{eq: set_szs}), (\ref{eq: size_far}), (\ref{eq: sz_near}), (\ref{eq: size_j}), (\ref{eq: sz_prev}) together gives
 $$|C_j^T| \leq \left(h(T^-,k) + 2k+1 \right) \cdot w^T(c_j^T) \leq h(T,k) \cdot w^T(c_j^T) = (2k+1)\cdot T \cdot w^T(c_j^T)$$
as desired. 

\end{proof}

\section{Decreasing the well-separation parameter is necessary.} \label{appendix: decreasing_well_sep}
Due to the relatively static nature of our algorithm (we only reset the pivots at most $k$ times), it is perhaps not surprising that we will have to initialize the well-separation parameter $\beta_1$ to be large, and then decrease it as we create more pivots. As a result, our algorithm will accumulate $\Omega(poly(k) 2^k)$ cost. Next, we show decreasing $\beta$ is necessary to avoid accumulating infinite cost.  

In fact, we require $\beta_{t+1} \leq \beta_t/2$. See Figure \ref{fig: halving_beta_ex}. Let the phase be $t=2$ and $p_1^2$ and $p_2^2$ denote the pivots in phase 2, associated with labels 1 and 2, respectively. Let $\beta = \beta_2$ and $\eps >0$. 

By the time phase 2 starts, the only points that have arrived are one point each at $p_1^2$ and $p_2^2$. Note that since $p_1^2$ and $p_2^2$ are distance $\beta$ apart, they satisfy the invariant that the pivots at the start of phase 2 should be $\beta = \beta_2$-well-separated w.r.t. the natural weights at the start of phase 2. Suppose we do not require $\beta_3 \leq \beta_2/2$. If this is the case, we may have infinitely many points arrive at $x$ and $y$, without ever being able to make three pivots. Moreover, since we assign points to pivots greedily, the infinitely many points at $x$ and $y$ would be assigned the same label, yielding a cluster with unbounded cost. To see that three pivots could never be made, note that $p_1^2$ prevents us from adding $x$ as a pivot, since $p_1^2$ and $x$ are $(\beta/2 + \eps)$-attached at any point in time (even though there are infinitely many points at $x$). Likewise, $p_2^2$ prevents us from adding $y$ as a pivot. So as long as at least one of $p_1^2$ or $p_2^2$ must remain a pivot (which must be the case if we are to increase the number of pivots to three, as there are only four locations in this example), it is impossible to have $\beta_3 > \beta_2/2$ without accumulating infinite cost. 

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{figures/halving_beta_ex_small.png}
\captionsetup{width=.9\linewidth}
\caption{The case discussed in Appendix \ref{appendix: decreasing_well_sep} showing that the well-separation parameter $\beta_t$ for phase $t$ must decrease by a factor of at least 2 with $t$.}
\label{fig: halving_beta_ex}
\end{figure}




\section{Avoiding label conflicts.} \label{appendix: label_conflicts}
Each pivot must be associated with a distinct label. The situation we have to handle delicately is when we are resetting pivots and two center estimates for two different online clusters are each close to the candidate new pivot; however, the candidate new pivot can only be associated with one label. See Figure \ref{fig: avoiding_label_conflicts_ex}. There are three present pivots, $p_1^2, p_2^3, p_3^3$, and the candidate new pivot is $x$, which is $\beta_4$-well-separated from the pivots $p_1^3$ and $p_2^3$ for labels 1 (blue) and 2 (green), respectively. However, $x$ is also ``close'' ($\beta/5$-attached, specifically) to the estimated centers $c_1^3$ and $c_2^3$ for clusters 1 and 2, respectively, so if we were to add $x$ as a pivot, it would be unclear as to whether we should give it the label 1 or 2. Instead, we will not actually add the candidate new pivot; we can show that the two center estimates $c_1^3$ and $c_2^3$ can be added as the pivots for the labels 1 and 2, respectively, while ensuring that all five pivots are $\beta/5$-well-separated. The old locations for pivots $p_1^3$ and $p_2^3$ are now the locations for the pivots of the new labels 4 (red) and 5 (purple). This situation is encoded in Case 4 of the Add Operation in Section \ref{sec: add_op}. 

 \begin{figure}[H]
\centering
\includegraphics[width=.9\textwidth]{figures/avoiding_label_conflicts_ex.png}
\captionsetup{width=.9\linewidth}
\caption{The situation described in Appendix \ref{appendix: label_conflicts} in which we must add two pivots in one shot in order to avoid label conflicts. Dashed lines indicate well-separation and solid lines indicate attachment, labelled with the appropriate parameters. Arrows go from smaller to larger natural weights.}
\label{fig: avoiding_label_conflicts_ex}
\end{figure}



\end{document}