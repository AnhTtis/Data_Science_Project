\definecolor{myblue}{rgb}{0.20, 0.6, 0.78}
\definecolor{mygreen}{rgb}{0.2,0.8,0.2}
\definecolor{myred}{rgb}{0.5,0,0}
\definecolor{myorange}{rgb}{1,0.6,0.07}
\definecolor{mygrey}{rgb}{0.5,0.5,0.5}

 \begin{figure*}[htb!]
    \centering
    \begin{tikzpicture}
    \begin{groupplot}[
        legend columns=3,
        legend style={
    	font=\tiny},
        group style=
            {columns=4, horizontal sep=0.7cm}
        ]
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% ----------------------- 1
    \nextgroupplot[
    title style={yshift=-3.2cm},
    title=(a),
    xmin= 0, xmax = 18,
    ymin= 14.5, ymax = 23,
    ytick distance = 4,
    enlargelimits=false,
    clip=true,
    grid=major,
    mark size=0.5pt,
    width=.28\linewidth,
    height=0.2\linewidth,
    ylabel = {Indoor temperature},
    xlabel={Time step $t$},
    ylabel style={at={(axis description cs:-0.1,0.5)}},
    xlabel style={at={(axis description cs:0.5,-0.1)}},
    legend columns=4,
    label style={font=\scriptsize}, %\tiny
    ticklabel style = {font=\tiny},
    legend to name=grouplegend,
    legend style={
    	font=\footnotesize, %\tiny,
    	draw=none,
		at={(0.5,1.03)},
        anchor=south
    }    
    ]
    \pgfplotstableread[col sep = comma]{figs/MPC_open_loop_2.dat}{\dat}
    % Indoor temperature
    \addplot+ [thick,mark=*,myred,mark options={solid, myred, scale=1},forget plot] table [x={t}, y={y1}] {\dat}; 
    \addlegendimage{thick,mark=*,myred,mark options={solid, myred, scale=0.5}}   
    \addlegendentry{Output: indoor temperature}
    % legend: input
    \addlegendimage{thick,mark=*,myblue,mark options={solid, myblue, scale=0.5}}
    \addlegendentry{Input: electrical power}  
     % Reference
    \addplot+ [thick,mark=none,myorange, line width=1.5pt,mark options={solid, scale=1}] table [x={t}, y expr= 22] {\dat}; 
    \addlegendentry{Output reference}   
    % legend: u max
    \addlegendimage{thick,mark=none,mygreen, line width=1.5pt,mark options={solid, myblue, scale=1}}
    \addlegendentry{Maximal input}    
    
    %%% ----------------------- 2
    \nextgroupplot[
    title style={yshift=-3.2cm},
    title=(b),
    xmin= 0, xmax = 18,
    ymin= 14.5, ymax = 23,
    ytick distance = 4,
    enlargelimits=false,
    clip=true,
    grid=major,
    mark size=0.5pt,
    width=.28\linewidth,
    height=0.2\linewidth,
    ylabel = {},
    xlabel={Time step $t$},
    ylabel style={at={(axis description cs:-0.1,0.5)}},
    xlabel style={at={(axis description cs:0.5,-0.1)}},
    legend columns=2,
    label style={font=\scriptsize}, %\tiny
    ticklabel style = {font=\tiny},
    legend style={
    	font=\tiny, %\tiny,
    	draw=none,
		at={(0.5,1.03)},
        anchor=south
    }    
    ]
    \pgfplotstableread[col sep = comma]{figs/MPC_open_loop_2.dat}{\dat}
    % Indoor temperature
    \addplot+ [thick,mark=*,myred,mark options={solid, myred, scale=1}] table [x={t}, y={y2}] {\dat}; 

     % Reference 
    \addplot+ [thick,mark=none,myorange, line width=1.5pt,mark options={solid, myred, scale=1}] table [x={t}, y expr= 22] {\dat}; 

    %%% ----------------------- 3
    \nextgroupplot[
    title style={yshift=-3.2cm},
    title=(c),
    xmin= 0, xmax = 18,
    ymin= 14.5, ymax = 23,
    ytick distance = 4,
    enlargelimits=false,
    clip=true,
    grid=major,
    mark size=0.5pt,
    width=.28\linewidth,
    height=0.2\linewidth,
    ylabel = {},
    xlabel={Time step $t$},
    ylabel style={at={(axis description cs:-0.1,0.5)}},
    xlabel style={at={(axis description cs:0.5,-0.1)}},
    legend columns=2,
    label style={font=\scriptsize}, %\tiny
    ticklabel style = {font=\tiny},
    legend style={
    	font=\tiny, %\tiny,
    	draw=none,
		at={(0.5,1.03)},
        anchor=south
    }    
    ]
    \pgfplotstableread[col sep = comma]{figs/MPC_open_loop_2.dat}{\dat}
    % Indoor temperature
    \addplot+ [thick,mark=*,myred,mark options={solid, myred, scale=1}] table [x={t}, y={y3}] {\dat}; 
     % Reference
    \addplot+ [thick,mark=none,myorange, line width=1.5pt,mark options={solid, myred, scale=1}] table [x={t}, y expr= 22] {\dat};  

    %%% ----------------------- 4
    \nextgroupplot[
    title style={yshift=-3.2cm},
    title=(d),
    xmin= 0, xmax = 18,
    ymin= 14.5, ymax = 23,
    ytick distance = 4,
    enlargelimits=false,
    clip=true,
    grid=major,
    mark size=0.5pt,
    width=.28\linewidth,
    height=0.2\linewidth,
    ylabel = {},
    xlabel={Time step $t$},
    ylabel style={at={(axis description cs:-0.1,0.5)}},
    xlabel style={at={(axis description cs:0.5,-0.1)}},
    legend columns=2,
    label style={font=\scriptsize}, %\tiny
    ticklabel style = {font=\tiny},
    legend style={
    	font=\tiny, %\tiny,
    	draw=none,
		at={(0.5,1.03)},
        anchor=south
    }    
    ]
    \pgfplotstableread[col sep = comma]{figs/MPC_open_loop_2.dat}{\dat}
    % Indoor temperature
    \addplot+ [thick,mark=*,myred,mark options={solid, myred, scale=1}] table [x={t}, y={y4}] {\dat}; 
     % Reference
    \addplot+ [thick,mark=none,myorange,line width=1.5pt,mark options={solid, myred, scale=1}] table [x={t}, y expr= 22] {\dat}; 

    
    \end{groupplot}
    
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 % right y axis
 %%% ----------------------- 1
    \begin{groupplot}[  
        legend columns=3,
        legend style={
    	font=\tiny},
        group style=
            {columns=4, horizontal sep=0.7cm}]
    \nextgroupplot[
    axis y line*=right,
    axis x line=none,
    xmin= 0, xmax = 18,
    ymin= -1, ymax = 16,  
    ytick distance = 6,
    ylabel = {},
    ylabel style={at={(axis description cs:1.1,0.5)}},      
    enlargelimits=false,
    clip=true,
    mark size=0.5pt,
    width=.28\linewidth,
    height=0.2\linewidth,
    legend columns=2,
    label style={font=\scriptsize}, %\tiny
    ticklabel style = {font=\tiny},
    legend style={
    	font=\tiny, %\tiny,
    	draw=none,
		at={(0.5,1.03)},
        anchor=south
    }    
    ]  
    \pgfplotstableread[col sep = comma]{figs/MPC_open_loop_2.dat}{\dat}
    
    \addplot+ [thick,mark=none,mygreen,line width=1.5pt,mark options={solid, myblue, scale=1}] table [x={t}, y expr= 6 ] {\dat}; 
    
    % Input
    \addplot+ [thick,mark=*,myblue,mark options={solid, myblue, scale=1}] table [x={t}, y={u1}] {\dat};   

        
    %%% ----------------------- 2
    \nextgroupplot[
    axis y line*=right,
    axis x line=none,
    xmin= 0, xmax = 18,
    ymin= -1, ymax = 16,  
    ytick distance = 6, 
    ylabel = {},
    ylabel style={at={(axis description cs:1.1,0.5)}},      
    enlargelimits=false,
    clip=true,
    mark size=0.5pt,
    width=.28\linewidth,
    height=0.2\linewidth,
    legend columns=2,
    label style={font=\scriptsize}, %\tiny
    ticklabel style = {font=\tiny},
    legend style={
    	font=\tiny, %\tiny,
    	draw=none,
		at={(0.5,1.03)},
        anchor=south
    }    
    ]  
    \pgfplotstableread[col sep = comma]{figs/MPC_open_loop_2.dat}{\dat}
    \addplot+ [thick,mark=none,mygreen,line width=1.5pt,mark options={solid, myblue, scale=1}] table [x={t}, y expr= 6 ] {\dat};    
    % Input
    \addplot+ [thick,mark=*,myblue,mark options={solid, myblue, scale=1}] table [x={t}, y={u2}] {\dat};        
    
     %%% ----------------------- 3
    \nextgroupplot[
    axis y line*=right,
    axis x line=none,
    xmin= 0, xmax = 18,
    ymin= -1, ymax = 16,  
    ytick distance = 6,  
    ylabel = {},
    ylabel style={at={(axis description cs:1.1,0.5)}},      
    enlargelimits=false,
    clip=true,
    mark size=0.5pt,
    width=.28\linewidth,
    height=0.2\linewidth,
    legend columns=2,
    label style={font=\scriptsize}, %\tiny
    ticklabel style = {font=\tiny},
    legend style={
    	font=\tiny, %\tiny,
    	draw=none,
		at={(0.5,1.03)},
        anchor=south
    }    
    ]  
    \pgfplotstableread[col sep = comma]{figs/MPC_open_loop_2.dat}{\dat}
     \addplot+ [thick,mark=none,mygreen,line width=1.5pt,mark options={solid, myblue, scale=1}] table [x={t}, y expr= 6 ] {\dat};   
    % Input
    \addplot+ [thick,mark=*,myblue,mark options={solid, myblue, scale=1}] table [x={t}, y={u3}] {\dat};   

    %%% ----------------------- 4
    \nextgroupplot[
    axis y line*=right,
    axis x line=none,
    xmin= 0, xmax = 18,
    ymin= -1, ymax = 16,  
    ytick distance = 6,  
    ylabel = {Electrical power },
    ylabel style={at={(axis description cs:1.1,0.5)}},      
    enlargelimits=false,
    clip=true,
    mark size=0.5pt,
    width=.28\linewidth,
    height=0.2\linewidth,
    legend columns=2,
    label style={font=\scriptsize}, %\tiny
    ticklabel style = {font=\tiny},
    legend style={
    	font=\tiny, %\tiny,
    	draw=none,
		at={(0.5,1.03)},
        anchor=south
    }    
    ]  
    \pgfplotstableread[col sep = comma]{figs/MPC_open_loop_2.dat}{\dat}
    \addplot+ [thick,mark=none,mygreen,line width=1.5pt,mark options={solid, myblue, scale=1}] table [x={t}, y expr= 6 ] {\dat};    
    % Input
    \addplot+ [thick,mark=*,myblue,mark options={solid, myblue, scale=1}] table [x={t}, y={u4}] {\dat};   
    
    
    \end{groupplot}
    \path (group c2r1.north east) -- node[above]{\ref{grouplegend}} (group c3r1.north west);    
    \end{tikzpicture}
    \caption{Open-loop solution of MPC. (a)  Filtered data, no split; (b) Raw data, split ; (c) Raw data, no split; \change{(d)} Positive ARX model} %$du_i := u_i - \hat{u}_i$
    \label{fig:MPC_open_loop}  
    \vspace{-.61em}
 \end{figure*}
 