%
%
\documentclass[preprint,nopreprintline]{elsarticle}


%
\usepackage{etex}               %

%
\usepackage[bookmarks=true,colorlinks=true,linkcolor=blue]{hyperref}

%
\usepackage{xcolor}

%
\usepackage{amsmath}          %
\usepackage{amssymb}          %
\usepackage{mathrsfs}         %
\usepackage{mathtools}        %

%
\usepackage{soul}             %
%
\usepackage[margin=1in]{geometry}

%
\usepackage{caption}          %
\usepackage{makecell,multirow,multicol,booktabs} %
\renewcommand\theadfont{\bfseries}

%
\usepackage[group-separator={,}]{siunitx}

%
\usepackage{tikz}
  \usetikzlibrary{calc,positioning}
\usepackage{pgfplots}
  \pgfplotsset{compat=newest}

%
%
%
%

%
\usepackage{hyperref}

%
\usepackage{amsthm}
\theoremstyle{plain}
\newtheorem{lemma}{Lemma}[section]
\newtheorem{theorem}[lemma]{Theorem}
\newtheorem{corollary}[lemma]{Corollary}
\newtheorem{proposition}[lemma]{Proposition}
\theoremstyle{definition}
\newtheorem{definition}[lemma]{Definition}
\newtheorem{example}[lemma]{Example}
\theoremstyle{remark}
\newtheorem{remark}[lemma]{Remark}

%
\usepackage[section]{algorithm} %
\usepackage{algpseudocode}  %

%
\makeatletter%
\newcounter{algorithmicH} %
\let\oldalgorithmic\algorithmic
\renewcommand{\algorithmic}{%
  \stepcounter{algorithmicH} %
  \oldalgorithmic} %
\renewcommand{\theHALG@line}{ALG@line.\thealgorithmicH.\arabic{ALG@line}}
\makeatother%

%
\input{inc/trimFig}

%
\renewcommand{\num}[2]{#1e#2} %

%
%
%

%
%
%
%
%
%

%
%

%
%

%
%

%
%

%
%

%
%

%
%

%
\bibliographystyle{elsarticle-num}
%

%
\input{setup_math_jr}
\input{setup_math_notation}

%
\newcommand{\indfn}{{\chi\smash[t]{\mathstrut}}}
\newcommand{\indfnAniso}{\boldsymbol{\indfn}}
\newcommand{\indmin}{\indfn_\mathrm{min}}
\newcommand{\indmax}{\indfn_\mathrm{max}}

%
\newcommand{\textcomment}[2]{\emph{\textcolor{#1}{[#2]}}}
\newcommand{\jr}[1]{\textcomment{red}{JR: #1}}
\newcommand{\QT}[1]{{\textcomment{teal}{QT: #1}}}
\newcommand{\EC}[1]{\textcomment{red}{EC: #1}}

%
\newif\ifshowstatus
\showstatustrue %

%
%
%

\begin{document}

\begin{frontmatter}

\title{%
  Scalable Implicit %
  Solvers with Dynamic Mesh Adaptation for a
  Relativistic Drift-Kinetic Fokker--Planck--Boltzmann Model%
  \tnoteref{mytitlenote}}
\tnotetext[mytitlenote]{This work was jointly supported by the
  U.S. Department of Energy through the Fusion Theory Program of the
  Office of Fusion Energy Sciences and the SciDAC partnership on
  Tokamak Disruption Simulation between the Office of Fusion Energy
  Sciences and the Office of Advanced Scientific Computing; and
  through the FASTMath Institute. Los Alamos
  National Laboratory is operated by Triad National Security, LLC, for
  the National Nuclear Security Administration of U.S. Department of
  Energy (Contract No.~89233218CNA000001). Argonne National Laboratory
  is operated under contract DE-AC02-06CH11357.
}

%
\author[anl,vt]{Johann Rudi\corref{cor1}}
\ead{jrudi@vt.edu}
%

\author[anl,vt,bu]{Max Heldman}
\ead{maxh@vt.edu}
%

\author[anl]{Emil M. Constantinescu}
\ead{emconsta@mcs.anl.gov}
%

\author[lanl]{Qi Tang\corref{cor1}}
\ead{qtang@lanl.gov}
%

\author[lanl]{Xian-Zhu Tang}
\ead{xtang@lanl.gov}
%

\address[anl]{Mathematics and Computer Science Division, Argonne National Laboratory, Lemont, IL 60439.}
\address[vt]{Department of Mathematics, Virginia Tech, Blacksburg, VA 24061.}
\address[bu]{Department of Mathematics and Statistics, Boston University, Boston, MA 02215.}
\address[lanl]{Theoretical Division, Los Alamos National Laboratory, Los Alamos, NM 87545.}

\cortext[cor1]{Corresponding author}


\begin{abstract}
In this work we consider a relativistic drift-kinetic model for
runaway electrons along with a Fokker--Planck operator for small-angle
Coulomb collisions, a radiation damping operator, and a secondary
knock-on (Boltzmann) collision source.  We develop a new scalable fully
implicit solver utilizing finite volume and conservative finite
difference schemes and dynamic mesh adaptivity. A new data management
framework in the PETSc library based on the p4est library is
developed to enable simulations with dynamic adaptive mesh
refinement (AMR), parallel computation, and load balancing.  This
framework is tested through the development of the runaway electron
solver that is able to dynamically capture both bulk Maxwellian at the
low-energy region and a runaway tail at the high-energy region.
To effectively capture features via the AMR algorithm, a new AMR
indicator prediction strategy is proposed that is performed alongside the
implicit time evolution of the solution.  This strategy is complemented by the
introduction of computationally cheap feature-based AMR indicators that are
analyzed theoretically.  Numerical results quantify the advantages of the
prediction strategy in better capturing features compared with nonpredictive
strategies; and we demonstrate trade-offs regarding computational costs.  The
full solver is further verified through several benchmark problems including
manufactured solutions and solutions of physics models.  We particularly focus
on demonstrating the advantages of using implicit time stepping and AMR for
runaway electron simulations.
\end{abstract}

\begin{keyword}
Relativistic Fokker--Planck--Boltzmann\sep Adaptive mesh refinement\sep Fully implicit time stepping\sep Runaway electrons
\end{keyword}
\end{frontmatter}

%
%

%
%

%
%
%

\input{inc/introduction}

%
%
%

\input{inc/equations}
%

%
%
%

\input{inc/amr}

%
%
%

\input{inc/solver}

%
%
%

\input{inc/setup}

%
%
%

\input{inc/results}

%
%
%

\def\secstatus{draft}

\section{Conclusion}
\label{sec:conclusion}

In this work we designed and developed adaptive, scalable, fully implicit solvers for the relativistic Fokker--Planck equation in phase space.
One key goal of the work is to develop a scalable and efficient dynamic AMR.
In practice, one needs to determine the requirements on scalability and then
adjust the parameters of the AMR algorithms in terms of refinement frequencies
and the AMR prediction horizon.  The present work proposes a new prediction strategy for refinement indicators,
giving a potential tool to exert control
over accuracy at computational overheads that were demonstrated to be low.
Numerical experiments quantify the predictive approach behaving better than conventional indicators, which lack prediction, in terms of resolving features in the solutions.
When the need for scalability is of higher importance to the application, one can use the
proposed AMR prediction at the expense of further increases of computational
overheads from finer meshes.

%
%
%

We contribute a new scalable implementation of the proposed algorithm using the p4est and PETSc frameworks.
Although the focus of the current work is to develop a solver aiming specifically at runaway electrons during tokamak disruptions,
a large portion of our proposed algorithm is general and thus can be potentially applied to solving many other time-dependent PDEs with dynamic mesh adaptivity.
Several numerical examples are presented in order to verify the solver's accuracy, scalability, and efficiency in adaptivity.
These numerical results confirm the parallel and algorithmic scalabilities and accuracy of the schemes.
A significant improvement of computational cost owing to the AMR algorithm was demonstrated using a practical disruption study.

Future work includes generalizing the fixed external field in the current model to a self-consistent model that evolves the electric field through involving the runaway current.
Another direction to pursue is to extend the computational domain to the low-energy region, which needs a careful treatment of the boundary condition at $p=0$.

%
%
%

\section*{Acknowledgment}
This research used resources provided by the Los Alamos National Laboratory Institutional Computing Program, which is supported by the U.S. Department of Energy National Nuclear Security Administration under Contract No.~89233218CNA000001,
and the National Energy Research Scientific Computing Center
(NERSC), a U.S. Department of Energy Office of Science User Facility located at Lawrence Berkeley National Laboratory, operated under Contract No. DE-AC02-05CH11231 using NERSC award FES-ERCAP0021219.

This research was funded in part and used resources of the Argonne Leadership Computing Facility, which is a DOE Office of Science User Facility supported under Contract No. DE-AC02â€“06CH11357.

The Texas Advanced Computing Center (TACC) at The University of Texas at Austin
provided HPC resources that have contributed to the research results reported
within this paper.

%
%
%

\clearpage
\appendix

\section{Guiding center coordinate transformation}
\label{sec:coordinate}

The coordinate transformation from
$(\vec{X}, p_\parallel, \vec{p}_\perp)$ to $(\vec{X}, p, \xi)$ is described in this section. The discussion focuses on the phase space.
The differential element for momentum space integration is
\begin{align}
d^3{\vec{p}} = dp_\parallel d^2{\vec{p}_\perp} = dp_\parallel (p_\perp dp_\perp d\theta).
\end{align}
The guiding center model assumes azimuthal symmetry. Thus one can integrate over $\theta\in (0,2\pi)$ (here $p_\perp$ is positive), giving
\begin{align}
\int_\theta d^3\vec{p} = 2\pi p_\perp d p_\parallel d p_\perp.
\end{align}
The transformation from $(p_\parallel, p_\perp)$ to $(p,\xi)$ coordinate is given by
\begin{align}
p & = \sqrt{p_\parallel^2 + p_\perp^2} \\
\xi & = \frac{p_\parallel}{p} = \frac{p_\parallel}{\sqrt{p_\parallel^2+p_\perp^2}}.
\end{align}
The Jacobian of this transformation is
\begin{align}
\frac{\partial (p_\parallel, p_\perp)}{\partial (p,\xi)}
=
\left|\frac{\partial p_\parallel}{\partial p} \frac{\partial p_\perp}{\partial\xi}
- \frac{\partial p_\parallel}{\partial\xi} \frac{\partial p_\perp}{\partial p}\right|
= \left|- \xi \frac{p\xi}{\sqrt{1-\xi^2}} - p\sqrt{1-\xi^2}\right|
= \frac{p}{\sqrt{1-\xi^2}}.
\end{align}
One then has
\begin{align}
\int_\theta d^3\vec{p} = 2\pi p_\perp d p_\parallel d p_\perp
= 2\pi p\sqrt{1-\xi^2} \frac{p}{\sqrt{1-\xi^2}} dp d\xi
= 2\pi p^2 dp d\xi .
\end{align}
Noting that $\xi\in (-1,1),$ the integration over the entire momentum space is simply
$(4\pi/3) p^3,$ as expected.
This also indicates  that the overall Jacobian of $(p,\xi,\theta)$ coordinates is $p^2,$
for gyro-angle independent problems, and the overall Jacobian for the $(p,\xi)$ coordinate
is $2\pi p^2.$ For convenience, we will be using $J=p^2$ for the $(p,\xi)$ coordinates.

%
%
%

\section{Summary of physical quantities in RFP}
\label{sec:quantities}
Table~\ref{table:notation} summarizes some physical quantities and the corresponding notations  in this paper.

\begin{table}
\caption{Physical quantities in the RFP model and the notations used in the current work.\label{table:notation}}
\centering
\vskip 1ex
\footnotesize
\begin{tabular}{lc|lc}
\toprule
  \thead{Description} & \thead{Symbol} &  \thead{Description} & \thead{Symbol} \\
\midrule
  time     & $t$   & electron  charge        & $e$\\
  configuration space    & $\xv$ & electron mass & $m_e$  \\
  phase space & $\pv$  &  speed of light         & $c$ \\
  phase space parallel to $\Bv$      & $p_\parallel$     &  Lorentz factor        & $\gamma$      \\
  phase space perpendicular to $\Bv$ & $p_\bot$      &  electrical permittivity & $\epsilon_0$           \\
  magnitude of the momentum       & $p=\norm{\pv}$       & Coulomb logarithm & $\ln \Lambda$      \\
  pitch angle                     & $\xi=p_\parallel/p$       &   thermal velocity  & $v_t$       \\
%
%
  runaway election density        & $f$        & effective charge number & $Z$               \\
  %
  energy flux                     & $\Gamma_p$         & collision time scale                     & $\tau_c$      \\
  pitch angle flux                & $\Gamma_\xi$     & synchrotron  time scale                 & $\tau_s$        \\
  magnetic field                  & $\Bv$       &      intensity of damping    & $\alpha=\tau_c/\tau_s$             \\
%
%
%
  induced electric field  parallel to $\Bv$        & $E_\parallel$      &     M{\o}ller cross section & ${d\sigma}/{dp}$    \\
\bottomrule
\end{tabular}
\end{table}

%
%
%

%
%
%
%

%
%
%

\clearpage
\bibliography{references}

%
 \begin{center}
	\scriptsize \framebox{\parbox{4in}{Government License (will be removed at publication):
			The submitted manuscript has been created by UChicago Argonne, LLC,
			Operator of Argonne National Laboratory (``Argonne").  Argonne, a
			U.S. Department of Energy Office of Science laboratory, is operated
			under Contract No. DE-AC02-06CH11357.  The U.S. Government retains for
			itself, and others acting on its behalf, a paid-up nonexclusive,
			irrevocable worldwide license in said article to reproduce, prepare
			derivative works, distribute copies to the public, and perform
			publicly and display publicly, by or on behalf of the Government. The Department of Energy will provide public access to these results of federally sponsored research in accordance with the DOE Public Access Plan. http://energy.gov/downloads/doe-public-access-plan.
}}
	\normalsize
\end{center}
%

\end{document}
