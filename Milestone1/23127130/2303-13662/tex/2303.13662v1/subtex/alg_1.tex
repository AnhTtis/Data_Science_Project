\begin{algorithm}[t]
\begin{algorithmic}\State Initialize $\phi, \beta_{e^{(1)}}, ... , \beta_{e^{(E)}}$, learning rate $\gamma$, alignment parameter $\alpha$, alignment starting epoch $T_a$.
\For{$\text{t in 0, 1, ..., }$}
\State Run forward pass and calculate the gradient.
\For{$e \in \mathcal{E}$}
    
    \State $\tilde{\beta}^{t+1}_e = \beta^{t}_e - \gamma \nabla_{\beta^{t}_e} \mathcal{L}_{\textit{PG-IRM}}$
    \State $\alpha' := 1 - \mathbf{1}_{t > T_a} (1 - \alpha)$ 
    \State select $\beta^{t}_{\bar{e}}$ with $\bar{e}  = \underset{e' \in \mathcal{E}  \backslash e }{\text{argmax}} \|\tilde{\beta}^{t+1}_e - \beta^{t}_{e'}\|_2$
    \State $\beta^{t+1}_e = \alpha'
    \tilde{\beta}^{t+1}_e + (1 - \alpha')  \beta^t_{\bar{e}}$
\EndFor
\State Update $\phi^{t+1} = \phi^{t} - \gamma \nabla_{\phi^t} \mathcal{L}_{\textit{PG-IRM}}$.
\EndFor
\end{algorithmic}
\caption{\small PG-IRM}
\label{alg:proj_grad_appendix}
\end{algorithm}