%!TEX root = ../../main.tex

\definecolor{DNScolor}{HTML}{c80000}
\definecolor{dark_gray}{HTML}{bfbfbf}
\definecolor{middle_gray}{HTML}{e5e5e5}
%\begin{figure} \centering
\noindent\begin{minipage}{\linewidth}
    \hspace{-2.0mm}\begin{tikzpicture}[remember picture,
    full_width/.style={rectangle, draw, line width=.5pt, inner sep=5pt, minimum width=8.8cm, minimum height=3cm, align=center, fill=white, rounded corners},
    rounded_rectangle/.style={rectangle, draw, line width=.5pt, inner sep=3pt, align=center, fill=white, rounded corners}
    ]

    \begin{scope}[on background layer]
        % DNSSEC Recursive Resolver
        \node[full_width] (dns_resolver) [minimum height=4.45cm] {};
        %\node[below=1.0mm of dns_resolver.north, xshift=-3.23cm] {SVCB record};
        \node[coordinate] (dns_resolver_start) [below left=0.5cm and 4.4cm of dns_resolver.north] {};
        \draw (dns_resolver_start) -- ++(4.5,0) -- ++(0.2,0.2) -- ++(0,0.3);
        \node[above right=0.0mm and 0.0cm of dns_resolver_start.south] {\textbf{DNSSEC Recursive Resolver}};

        \node (records) [below right=0.5mm and -2.5mm of dns_resolver_start] {
        \setlength{\tabcolsep}{2pt}
        \renewcommand{\arraystretch}{0.85}
        \begin{tabularx}{0.966\linewidth}{ll} \toprule
        QNAME & RDATA (SVCB) \\
        \midrule
        \_someip.minor.major.instance.id.service.& \multirow{8}{\linewidth}{\parbox{3.0cm}{
                                                                        port=30509\\
                                                                        ipv4hint=10.0.0.5\\
                                                                        key65280=2\\
                                                                        key65281=1\\
                                                                        key65282=0}}\\
        \_someip.major.instance.id.service.&\\
        \_someip.minor.instance.id.service.&\\
        \_someip.minor.major.id.service.&\\
        \_someip.instance.id.service.&\\
        \_someip.major.id.service.&\\
        \_someip.minor.id.service.&\\
        \_someip.id.service.&\\
        \bottomrule
        \end{tabularx}
        };

        % Service Discovery
        % Server
        \node[full_width] (server) [below left=2.0mm and 7.0mm of dns_resolver.south, minimum height=4.44cm, minimum width=3.7cm, fill=dark_gray] {};
        \node[coordinate] (server_start) [below left=0.5cm and 1.85cm of server.north] {};
        \draw (server_start) -- ++(1.05,0) -- ++(0.2,0.2) -- ++(0,0.3);
        \node[above right=0.1mm and 0.0mm of server_start] {\textbf{Server}};
        \node[rounded_rectangle] (pub_app) [below=6.0mm of server.north, minimum width=3.5cm, fill=middle_gray] {Publisher Application};
        \node[rounded_rectangle] (routing_manager_pub) [below=1.0mm of pub_app, minimum width=3.5cm, fill=middle_gray] {Routing Manager};
        \node[rounded_rectangle] (sd_pub) [below=1.0mm of routing_manager_pub, minimum height=2.45cm, minimum width=3.5cm, fill=middle_gray] {};
        \node(sd_pub_text) [below left=0.0mm and -1.1cm of sd_pub.north] {Service Discovery};
        \node[rounded_rectangle] (offer_find_pub) [below left=5.0mm and 0.5mm of sd_pub.north, align=center, minimum width=1.6cm, draw=darkgray, text=darkgray] {OFFER/\\FIND};
        \node[rounded_rectangle] (pub_sub_pub) [right=1.0mm of offer_find_pub, minimum width=1.6cm, minimum height=0.87cm] {PubSub};
        \node[rounded_rectangle] (dnssec_pub) [below=1.0mm of offer_find_pub, minimum width=1.6cm, minimum height=0.87cm, line width=1pt, draw=DNScolor] {DNSSEC};

        % Client
        \node[full_width] (client) [right=1.4cm of server, minimum height=4.44cm, minimum width=3.7cm, fill=dark_gray] {};
        \node[coordinate] (client_start) [below left=0.5cm and 1.85cm of client.north] {};
        \draw (client_start) -- ++(1.05,0) -- ++(0.2,0.2) -- ++(0,0.3);
        \node[above right=0.1mm and 0.0mm of client_start] {\textbf{Client}};
        \node[rounded_rectangle] (sub_app) [below=6.0mm of client.north, fill=middle_gray] {Subscriber Application};
        \node[rounded_rectangle] (routing_manager_sub) [below=1.0mm of sub_app, minimum width=3.5cm, fill=middle_gray] {Routing Manager};
        \node[rounded_rectangle, fill=middle_gray] (sd_sub) [below=1.0mm of routing_manager_sub, minimum height=2.45cm, minimum width=3.5cm] {};
        \node (sd_sub_text) [below left=0.0mm and -1.1cm of sd_sub.north] {Service Discovery};
        \node[rounded_rectangle] (offer_find_sub) [below left=5.0mm and 0.5mm of sd_sub.north, align=center, minimum width=1.6cm, draw=darkgray, text=darkgray] {OFFER/\\FIND};
        \node[rounded_rectangle] (pub_sub_sub) [right=1.0mm of offer_find_sub, minimum width=1.6cm, minimum height=0.87cm] {PubSub};
        \node[rounded_rectangle] (dnssec_sub) [below=1.0mm of offer_find_sub, minimum width=1.6cm, minimum height=0.87cm, line width=1pt, draw=DNScolor] {DNSSEC};

        % Arrows and Lines
        \draw[latex-latex] (pub_sub_pub.south) -- ++(0,-1.7) -- node[pos=0.5, align=center] {2. SUBSCRIBE\\SUBSCRIBEACK} ($(pub_sub_sub.south)+(0,-1.7)$) -- (pub_sub_sub.south);
        %\draw[-latex] (pub_app.349) -- ++(0,-0.5) -- node(pub_data_text)[pos=0.5, align=center] {3.Publish\\Data} ($(sub_app.191)+(0,-0.5)$) -- (sub_app.191);
        \draw[-latex] (pub_app.east) -- node(pub_data_text)[pos=0.5, align=center] {3.Publish\\Data} (sub_app.west);
        %\draw[-, line width=1pt, draw=DNScolor, text=DNScolor] (dnssec_sub.west) -- ++(-0.7,0) -- node(dnssec_intermediate) [rotate=90, above, align=center] {1. resolve} ++(0.0,1.7);
        \draw[-, line width=1pt, draw=DNScolor, text=DNScolor] (dnssec_sub.west) -- ++(-0.7,0) -- node(dnssec_intermediate) [rotate=90, above, align=center] {1. resolve} ++(0.0,2.5);
        \draw[-latex, line width=1pt, draw=DNScolor] ($(dnssec_intermediate)+(0.247,2.2)$) -- ++(0.0,0.6);
        \draw[-, draw=darkgray] ($(offer_find_pub.north)+(-8.0mm,0.0)$) -- ($(offer_find_pub.south)+(8.0mm,0.0)$);
        \draw[-, draw=darkgray] ($(offer_find_pub.north)+(8.0mm,0.0)$) -- ($(offer_find_pub.south)+(-8.0mm,0.0)$);
        \draw[-, draw=darkgray] ($(offer_find_sub.north)+(-8.0mm,0.0)$) -- ($(offer_find_sub.south)+(8.0mm,0.0)$);
        \draw[-, draw=darkgray] ($(offer_find_sub.north)+(8.0mm,0.0)$) -- ($(offer_find_sub.south)+(-8.0mm,0.0)$);
    \end{scope}

    %main layer
    
    \begin{scope}[on behind layer]
    \end{scope}

    \begin{scope}[on above layer]
    \end{scope}

    \begin{scope}[on glass layer]
    \end{scope}

\end{tikzpicture}
\captionof{figure}{\acs{SOME/IP} \acs{SD} modification for using \acs{DNS}}
\label{fig:someipsddnsmod}
\end{minipage}