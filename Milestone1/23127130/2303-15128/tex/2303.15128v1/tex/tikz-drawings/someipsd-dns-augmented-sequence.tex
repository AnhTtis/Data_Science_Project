%!TEX root = ../../main.tex

\begin{figure}
    \centering
\begin{tikzpicture}[remember picture,
    participant/.style={rectangle, draw, line width=.5pt, inner sep=5pt, minimum width=0.0cm, minimum height=0.0cm, align=center, fill=CoreGray, rounded corners},
    group/.style={rectangle, draw, line width=.5pt, inner sep=5pt, minimum width=\fullWidth, minimum height=3cm, align=center, rounded corners, fill=LightCoreGray},
    activation/.style={rectangle, draw, line width=.5pt, minimum width=.3cm, minimum height=0.9cm, align=center, fill=white}
    ]
    \begin{scope}[on background layer]
        % Publisher
        \node[participant, minimum width=1.8cm, minimum height=0.7cm] (publisher) {Publisher};
        % Subscriber
        \node[participant, minimum width=1.8cm, minimum height=0.7cm] (subscriber) [right=1.655cm of publisher] {Subscriber};
        % DNS
        \node[participant, minimum width=1.8cm, minimum height=0.7cm] (dns) [right=1.655cm of subscriber] {DNS};
    \end{scope}

    % Publisher lifeline
    \draw[line width=1.0pt, rounded corners, cap=round, dashed, color=lifeline_color] (publisher.south) -- ++(0,-7.0);
    % Subscriber liefeline
    \draw[line width=1.0pt, rounded corners, cap=round, dashed, color=lifeline_color] (subscriber.south) -- ++(0,-7.0);
    % DNS liefeline
    \draw[line width=1.0pt, rounded corners, cap=round, dashed, color=lifeline_color] (dns.south) -- ++(0,-7.0);
    
    \begin{scope}[on behind layer]
        \node[coordinate] (group_anchor) [] at (publisher.west) {};
        \node[group] (consumer_triggered) [minimum height=2.4cm, below right=6.5mm and 0.0mm of group_anchor] {};
        \node[group] (publish_subscribe) [minimum height=3.7cm, below=4mm of consumer_triggered] {};
    \end{scope}

    \begin{scope}[on above layer]
        \newcommand{\selfMessageOffset}{-0.2cm}
        \newcommand{\selfMessageSpacing}{0.2cm}
        \newcommand{\selfMessageDuration}{-0.8cm}
        %Calls
        %SVCB request
        \node[coordinate] (request_start) [] at ($(consumer_triggered.north -| subscriber)+(0,-1.1cm)$) {};
        \node[activation] (request_process) [below] at (request_start -| dns) {};
        \node[coordinate] (request_process_nw) at (request_process.north west) {};
        \draw[-{Straight Barb[length=1.5mm,angle'=40]}] (request_process_nw -| request_start) -- node[pos=0.5, align=center, above] {\codeword{query(}SVCB\codeword{)}} (request_process_nw);
        %SVCB response
        \node[coordinate] (request_process_sw) at (request_process.south west) {};
        \node[coordinate] (response_process_ne) [] at (request_process_sw -| subscriber) {};
        \draw[-{Straight Barb[length=1.5mm,angle'=40]}, dashed] (request_process_sw) -- node[pos=0.5, align=center, above]{\codeword{response()}} (response_process_ne);
        
        %TLSA request
        \node[activation] (response_process) [below] at ($(publish_subscribe.north -| subscriber)+(0,-0.7cm)$) {};
        \node[coordinate] (response_process_se) at (response_process.south east) {};
        \node[activation] (request_tlsa_process) [below] at (response_process_se -| dns) {};
        \draw[-{Straight Barb[length=1.5mm,angle'=40]}] (response_process_se) -- node[pos=0.5, align=center, above] {\codeword{query(}TLSA\codeword{)}} (request_tlsa_process.north west);
        %\codeword{subscribe}
        \node[coordinate] (subscribe_start) at (response_process.west) {};
        \node[coordinate] (subscribe_process_nw) at (subscribe_start -| publisher) {};
        \node[coordinate] (subscribe_process_se) at (request_tlsa_process.south -| publisher) {};
        \node[activation, inner sep=0pt, fit=(subscribe_process_nw)(subscribe_process_se)] (subscribe_process) {};
        % \node[activation, minimum height=1.5cm] (subscribe_process) [below] at (subscribe_process_nw) {};
        \node[coordinate] (subscribe_process_ne) at (subscribe_process.north east) {};
        \draw[-{Straight Barb[length=1.5mm,angle'=40]}] (subscribe_start) -- node[pos=0.5, align=center, above] {\codeword{subscribe(}nonce\codeword{)}} (subscribe_process_ne);
        %Signing
        \node[coordinate] (pub_sign_upper_right_arrow) at ($(subscribe_process.north east)+(\selfMessageSpacing,\selfMessageOffset)$) {};
        \node[coordinate] (pub_sign_lower_right_arrow) at ($(subscribe_process.north east)+(\selfMessageSpacing, \selfMessageDuration)$) {};
        \draw[-latex] ($(subscribe_process.north east)+(0.0cm,\selfMessageOffset)$) -- (pub_sign_upper_right_arrow) -- (pub_sign_lower_right_arrow) -- ($(subscribe_process.north east)+(0.0cm,\selfMessageDuration)$);
        \node[below right=0.5mm and 0mm of pub_sign_upper_right_arrow, align=left]{Sign\codeword{()}};
        %\codeword{subscribe} ACK and TLSA response
        \node[activation] (sub_tlsa_process) [below] at (request_tlsa_process.south -| subscriber) {};
        \draw[-{Straight Barb[length=1.5mm,angle'=40]}, dashed] (request_tlsa_process.south west) -- node[pos=0.5, align=center, above]{\codeword{response(})} (sub_tlsa_process.north east);
        \draw[-{Straight Barb[length=1.5mm,angle'=40]}, dashed] (subscribe_process.south east) -- node[pos=0.5, align=center, above]{~\codeword{subscribeAck(}sig\codeword{)}} ($(subscribe_process.south -| subscriber)+(-1.5mm,0.0mm)$);
        %TLSA validation
        \node[coordinate] (sub_tlsa_upper_right_arrow) at ($(subscribe_process.south -| subscriber)+(1.5mm,0.0mm)+(\selfMessageSpacing,\selfMessageOffset)$) {};
        \node[coordinate] (sub_tlsa_lower_right_arrow) at ($(subscribe_process.south -| subscriber)+(1.5mm,0.0mm)+(\selfMessageSpacing, \selfMessageDuration)$) {};
        \draw[-latex] ($(subscribe_process.south -| subscriber)+(1.5mm,0.0mm)+(0.0cm,\selfMessageOffset)$) -- (sub_tlsa_upper_right_arrow) -- (sub_tlsa_lower_right_arrow) -- ($(subscribe_process.south -| subscriber)+(1.5mm,0.0mm)+(0.0cm,\selfMessageDuration)$);
        \node[below right=0.5mm and 0mm of sub_tlsa_upper_right_arrow, align=left]{VerfiySignature\codeword{()}};
    \end{scope}

    \begin{scope}[on glass layer]
        \newcommand{\slant}{0.2,0.2}
        \newcommand{\nLineCoverOffset}{-0.2mm}
        \newcommand{\pLineCoverOffsetPub}{0.1mm}
        \newcommand{\pLineCoverOffsetSub}{1.5mm}
        \newcommand{\groupLabelWidth}{4.25}
        \newcommand{\aboveGroupLabel}{-0.9mm}
        %consumer triggered
        \node[coordinate] (g1_start) [] at ($(consumer_triggered.north -| consumer_triggered.west)+(0,-4.0mm)$) {};
        \draw[line width=2.0pt, color=LightCoreGray] ($(consumer_triggered.north -| publisher)+(0,\nLineCoverOffset)$) -- ($(g1_start -| publisher)+(0,\pLineCoverOffsetPub)$);
        \draw[line width=2.0pt, color=LightCoreGray] ($(consumer_triggered.north -| subscriber)+(0,\nLineCoverOffset)$) -- ($(g1_start -| subscriber)+(0,\pLineCoverOffsetSub)$);
        \draw(g1_start) -- ++(\groupLabelWidth,0) -- ++(\slant) -- node(g1_intermediate) [] {} ++(0,0) -- (consumer_triggered.north -| g1_intermediate);
        \node[above right=\aboveGroupLabel and 0.0cm of g1_start] {consumer-triggered discovery};

        %pubsub
        \node[coordinate] (g2_start) [] at ($(publish_subscribe.north -| publish_subscribe.west)+(0,-4.0mm)$) {};
        \draw[line width=2.0pt, color=LightCoreGray] ($(publish_subscribe.north -| publisher)+(0,\nLineCoverOffset)$) -- ($(g2_start -| publisher)+(0,\pLineCoverOffsetPub)$);
        \draw[line width=2.0pt, color=LightCoreGray] ($(publish_subscribe.north -| subscriber)+(0,\nLineCoverOffset)$) -- ($(g2_start -| subscriber)+(0,\pLineCoverOffsetSub)$);
        \draw(g2_start) -- ++(\groupLabelWidth,0) -- ++(\slant) -- node(g2_intermediate) [] {} ++(0,0) -- (publish_subscribe.north -| g2_intermediate);
        \node[above right=\aboveGroupLabel and 0.0cm of g2_start] {publish-subscribe};

    \end{scope}

\end{tikzpicture}
\caption{Augmented SOME/IP SD with DNSSEC and DANE for secure publisher service discovery and authentication.}\label{fig:someipsdaugdns}
\end{figure}
