%!TEX root = ../../main.tex

% \definecolor{DNScolor}{HTML}{c80000}
% \definecolor{dark_gray}{HTML}{bfbfbf}
% \definecolor{middle_gray}{HTML}{e5e5e5}
\begin{figure} 
    \centering
    \begin{tikzpicture}[remember picture,
    full_width/.style={rectangle, draw, line width=.5pt, inner sep=5pt, minimum width=8.8cm, minimum height=3cm, align=center, fill=white, rounded corners},
    rounded_rectangle/.style={rectangle, line width=.5pt, inner sep=3pt, align=center, fill=white, rounded corners}
    ]

    \begin{scope}[on background layer]
        % Service Discovery
        % Server
        \node[full_width] (server) [minimum height=4.44cm, minimum width=3.7cm, fill=CoreGray] {};
        \node[coordinate] (server_start) [below left=0.5cm and 1.85cm of server.north] {};
        \draw (server_start) -- ++(1.05,0) -- ++(0.2,0.2) -- ++(0,0.3);
        \node[above right=0.1mm and 0.0mm of server_start] {\textbf{Server}};
        \node[rounded_rectangle] (pub_app) [below=6.0mm of server.north, minimum width=3.5cm, fill=CoreMiddleGray] {Publisher Application};
        \node[rounded_rectangle] (routing_manager_pub) [below=1.0mm of pub_app, minimum width=3.5cm, fill=CoreMiddleGray] {Routing Manager};
        \node[rounded_rectangle] (sd_pub) [below=1.0mm of routing_manager_pub, minimum height=2.45cm, minimum width=3.5cm, fill=CoreMiddleGray] {};
        \node(sd_pub_text) [below left=0.0mm and -1.1cm of sd_pub.north] {Service Discovery};
        \node[rounded_rectangle] (offer_find_pub) [below left=5.0mm and 0.5mm of sd_pub.north, align=center, minimum width=1.6cm, draw=none, text=gray] {Offer/\\Find};
        \node[rounded_rectangle] (pub_sub_pub) [right=1.0mm of offer_find_pub, minimum width=1.6cm, minimum height=0.87cm] {PubSub};
        \node[rounded_rectangle] (dnssec_pub) [below=1.0mm of offer_find_pub, minimum width=1.6cm, minimum height=0.87cm, line width=1pt, draw=CoreRed] {DNSSEC};

        % Client
        \node[full_width] (client) [right=1.4cm of server, minimum height=4.44cm, minimum width=3.7cm, fill=CoreGray] {};
        \node[coordinate] (client_start) [below left=0.5cm and 1.85cm of client.north] {};
        \draw (client_start) -- ++(1.05,0) -- ++(0.2,0.2) -- ++(0,0.3);
        \node[above right=0.1mm and 0.0mm of client_start] {\textbf{Client}};
        \node[rounded_rectangle] (sub_app) [below=6.0mm of client.north, fill=CoreMiddleGray] {Subscriber Application};
        \node[rounded_rectangle] (routing_manager_sub) [below=1.0mm of sub_app, minimum width=3.5cm, fill=CoreMiddleGray] {Routing Manager};
        \node[rounded_rectangle, fill=CoreMiddleGray] (sd_sub) [below=1.0mm of routing_manager_sub, minimum height=2.45cm, minimum width=3.5cm] {};
        \node (sd_sub_text) [below left=0.0mm and -1.1cm of sd_sub.north] {Service Discovery};
        \node[rounded_rectangle] (pub_sub_sub) [below left=5.0mm and 0.5mm of sd_sub.north, minimum width=1.6cm, minimum height=0.87cm] {PubSub};
        \node[rounded_rectangle] (offer_find_sub) [right=1.0mm of pub_sub_sub, align=center, minimum width=1.6cm, draw=none, text=gray] {Offer/\\Find};
        \node[rounded_rectangle] (dnssec_sub) [below=1.0mm of offer_find_sub, minimum width=1.6cm, minimum height=0.87cm, line width=1pt, draw=CoreRed] {DNSSEC};

        % DNSSEC Recursive Resolver
        \node[full_width] (dns_resolver) [below right=2.0mm and 0.0mm of server.south, minimum height=11.5mm, minimum width=4.4cm, fill=CoreGray] {};
        \node[coordinate] (dns_resolver_start) [below left=0.5cm and 2.2cm of dns_resolver.north] {};
        \draw (dns_resolver_start) -- ++(2.9,0) -- ++(0.2,0.2) -- ++(0,0.3);
        \node[above right=0.0mm and 0.0cm of dns_resolver_start.south] {\textbf{DNSSEC Resolver}};
        \node[rounded_rectangle] (svcb_records) [below=6.0mm of dns_resolver.north, minimum width=4.2cm, fill=CoreMiddleGray] {Service and DANE Records};

        % Arrows and Lines
        \draw[latex-latex] (pub_sub_pub.south) -- ++(0,-0.5) -- node[pos=0.5, align=center] {2. Sub\\SubAck} ($(pub_sub_sub.south)+(0,-0.5)$) -- (pub_sub_sub.south);
        \draw[-latex] (pub_app.east) -- node(pub_data_text)[pos=0.5, align=center] {3.Publish\\Data} (sub_app.west);
        \draw[-latex, line width=1pt, draw=CoreRed, text=CoreRed] (dnssec_sub.south) -- (dnssec_sub.south |- dns_resolver.east)-- node(dnssec_intermediate) [above, align=center] {1. resolve} (dns_resolver.east);
        \draw[-, draw=darkgray] (offer_find_pub.north -| offer_find_pub.west) -- (offer_find_pub.south -| offer_find_pub.east);
        \draw[-, draw=darkgray] (offer_find_pub.south -| offer_find_pub.west) -- (offer_find_pub.north -| offer_find_pub.east);
        \draw[-, draw=darkgray] (offer_find_sub.north -| offer_find_sub.west) -- (offer_find_sub.south -| offer_find_sub.east);
        \draw[-, draw=darkgray] (offer_find_sub.south -| offer_find_sub.west) -- (offer_find_sub.north -| offer_find_sub.east);
    \end{scope}

    %main layer
    
    \begin{scope}[on behind layer]
    \end{scope}

    \begin{scope}[on above layer]
    \end{scope}

    \begin{scope}[on glass layer]
    \end{scope}

\end{tikzpicture}
\caption{\acs{SOME/IP} \acs{SD} modification for using \acs{DNSSEC}.}
\label{fig:someipsddnsmod}
\end{figure}