%!TEX root = ../../main.tex

Sequence diagram with self call
\begin{figure}
    \centering
\begin{tikzpicture}[remember picture,
    participant/.style={rectangle, draw, line width=.5pt, inner sep=5pt, minimum width=3cm, minimum height=11.2cm, align=center, fill=white, rounded corners},
    group/.style={rectangle, draw, line width=.5pt, inner sep=5pt, minimum width=8.8cm, minimum height=3cm, align=center, fill=white, rounded corners},
    group_label/.style={chamfered rectangle, draw, chamfered rectangle angle=45, chamfered rectangle corners=south east, line width=.5pt, inner sep=5pt, minimum width=2.2cm, minimum height=0.9cm, align=center, fill=white},
    activation/.style={rectangle, draw, line width=.5pt, minimum width=.3cm, minimum height=1cm, align=center, fill=white}
    ]

    \begin{scope}[on background layer]
        % Publisher
        \node[participant] (publisher) [fill=gray!30]{};
        \node[below=2mm] at (publisher.north) {Publisher};
        % Publisher SD Top
        \node[participant] (publisher_sd_top) [below=0.9cm, minimum width=2.2cm, minimum height=0.9cm] at (publisher.north) {};
        \node[below=2mm] at (publisher_sd_top.north) {SOME/IP SD};
        % Publisher SD Bottom
        \node[participant] (publisher_sd_bottom) [above=1.5mm, minimum width=2.2cm, minimum height=0.9cm] at (publisher.south) {};
        \node[above=2mm] at (publisher_sd_bottom.south) {SOME/IP SD};

        % Subscriber
        \node[participant] (subscriber) [right=2.55cm of publisher, fill=cyan!30] {};
        \node[below=2mm] at (subscriber.north) {Subscriber};
        % Subscriber SD Top
        \node[participant] (subscriber_sd_top) [below=0.9cm, minimum width=2.2cm, minimum height=0.9cm] at (subscriber.north) {};
        \node[below=2mm] at (subscriber_sd_top.north) {SOME/IP SD};
        % Subscriber SD Bottom
        \node[participant] (subscriber_sd_bottom) [above=1.5mm, minimum width=2.2cm, minimum height=0.9cm] at (subscriber.south) {};
        \node[above=2mm] at (subscriber_sd_bottom.south) {SOME/IP SD};
    \end{scope}

    % Publisher lifeline
    \draw[line width=1.0pt, rounded corners, cap=round, dashed, color=lifeline_color] (publisher_sd_top.270) -- (publisher_sd_bottom.90);
    % Subscriber liefeline
    \draw[line width=1.0pt, rounded corners, cap=round, dashed, color=lifeline_color] (subscriber_sd_top.270) -- (subscriber_sd_bottom.90);
    
    \begin{scope}[on behind layer]
        % Group consumer triggered
        \node[group] (consumer_triggered) [minimum height=3.6cm, below left=21mm and -7.2 cm of publisher.north] {};
        \node[group] (publish_subscribe) [minimum height=3.6cm, below=5mm of consumer_triggered] {};
    \end{scope}

    \begin{scope}[on above layer]
        %Group labels
        %consumer triggered
        \node[coordinate] (g1start) [below left=0.9cm and 4.4cm of consumer_triggered.north] {};
        \draw (g1start) -- ++(4.25,0) -- ++(0.2,0.2) -- ++(0,0.7);
        \node[coordinate] (g1linecover) [below=3.04mm of publisher_sd_top] {};
        \draw[line width=2.0pt, color=white] (g1linecover) -- ++(0,-0.87);
        \node[above right=1.8mm and 0.0cm of g1start.south] {consumer-triggered discovery};
        %publish subscribe
        \node[coordinate] (g2start) [below left=0.9cm and 4.4cm of publish_subscribe.north] {};
        \draw (g2start) -- ++(4.25,0) -- ++(0.2,0.2) -- ++(0,0.7);
        \node[coordinate] (g2linecover) [below=4.421cm of publisher_sd_top] {};
        \draw[line width=2.0pt, color=white] (g2linecover) -- ++(0,-0.87);
        \node[above right=1.8mm and 0.9cm of g2start.south] {publish-subscribe};
        %\node[group_label] (activation_cyclic_label) [below left=0mm and 4.635cm of activation_cyclic.north] {activation/cyclic-refresh};
    \end{scope}

    \begin{scope}[on glass layer]
        %Calls
        %consumer triggered
        \node[activation] (dns_process) [minimum height=2.2cm, below=1.4cm of subscriber_sd_top] {};
        \draw[-latex] ($(dns_process.north)+(1.5mm,0)$) -- ++(4mm,0) -- node[pos=0.5, right, align=center, xshift=-4.9cm]
            {dns request(\_someip.minor.\\major.instance.id.service.) \\\\ dns response(port, ip,\\instance, major, minor)}
            ($(dns_process.south)+(5.5mm,0)$) -- ++(-4mm,0);
        %publish subscribe
        \node[activation] (subscribe_process) [minimum height=1.4cm, below=6cm of publisher_sd_top] {};
        \draw[latex-] (subscribe_process.78) -- node[pos=0.5, align=center]{subscribe(service, instance,\\major, eventgroup)} ++(5.39,0);
        \draw[-latex, dashed] (subscribe_process.south) -- node[pos=0.5, align=center]{subscribe ack(service, instance,\\major, eventgroup)} ++(5.54,0);
    \end{scope}

\end{tikzpicture}
\caption{\acs{SOME/IP} \acs{SD} using \acs{DNS} for service discovery}\label{fig:someipsddns}
\end{figure}