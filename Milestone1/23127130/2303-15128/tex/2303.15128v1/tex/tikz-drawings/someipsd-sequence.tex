%!TEX root = ../../main.tex

\newcommand{\participantWidth}{2.9cm}
\newcommand{\participantHeight}{9.5cm}%{10.8cm}
\newcommand{\fullWidth}{8.8cm}

\colorlet{lifeline_color}{black!60}
\begin{figure}
    \centering
\begin{tikzpicture}[remember picture,
    participant/.style={rectangle, draw, line width=.5pt, inner sep=5pt, minimum width=\participantWidth, minimum height=\participantHeight, align=center, fill=CoreGray, rounded corners},
    group/.style={rectangle, draw, line width=.5pt, inner sep=5pt, minimum width=\fullWidth, minimum height=3cm, align=center, fill=LightCoreGray, rounded corners},
    %group_label/.style={chamfered rectangle, draw, chamfered rectangle angle=45, chamfered rectangle corners=south east, line width=.5pt, inner sep=5pt, minimum width=2.2cm, minimum height=0.9cm, align=center, fill=white},
    activation/.style={rectangle, draw, line width=.5pt, minimum width=.3cm, minimum height=1cm, align=center, fill=white}
    ]
    \begin{scope}[on background layer]
        % Publisher
        % \node[participant] (publisher) [fill=gray!30]{};
        \node[rectangle,minimum width=\participantWidth, minimum height=\participantHeight, align=center] (publisher) []{};
        % \node[below=2mm] at (publisher.north) {Publisher};
        % Publisher SD Top
        \node[participant] (publisher_sd_top) [%below=0.9cm, 
        below=0cm, minimum width=1.8cm, minimum height=0.7cm] at (publisher.north) {};
        \node[below=1mm] at (publisher_sd_top.north) {Publisher};

        % Subscriber
        % \fullwidth-2.0*\participantWidth-4.0mm
        % \node[participant] (subscriber) [right=2.6cm of publisher, fill=cyan!30] {};
        \node[rectangle,minimum width=\participantWidth, minimum height=\participantHeight, align=center] (subscriber) [right=2.6cm of publisher]{};
        % \node[below=2mm] at (subscriber.north) {Subscriber};
        % Subscriber SD Top
        \node[participant] (subscriber_sd_top) [%below=0.9cm,
            below=0cm, minimum width=1.8cm, minimum height=0.7cm] at (subscriber.north) {};
        \node[below=1mm] at (subscriber_sd_top.north) {Subscriber};
    \end{scope}

    % Publisher lifeline
    \draw[line width=1.0pt, rounded corners, cap=round, dashed, color=lifeline_color] (publisher_sd_top.south) -- (publisher.south);
    % Subscriber liefeline
    \draw[line width=1.0pt, rounded corners, cap=round, dashed, color=lifeline_color] (subscriber_sd_top.south) -- (subscriber.south);
    
    \begin{scope}[on behind layer]
        % Group consumer triggered
        \node[coordinate] (group_anchor) [] at (publisher_sd_top.south -| publisher.west) {};
        \node[group] (activation_cyclic) [minimum height=1.8cm, below right=3.0mm and -2.0mm of group_anchor] {};
        \node[group] (consumer_triggered) [minimum height=2.8cm, below=4mm of activation_cyclic] {};
        \node[group] (publish_subscribe) [minimum height=2.8cm, below=4mm of consumer_triggered] {};
    \end{scope}

    \begin{scope}[on above layer]
        %Group labels
        %activation/cyclic-refresh
        \newcommand{\slant}{0.2,0.2}
        \newcommand{\nLineCoverOffset}{-0.2mm}
        \newcommand{\pLineCoverOffset}{0.1mm}
        \newcommand{\groupLabelWidth}{4.25}
        \newcommand{\aboveGroupLabel}{-0.9mm}
        \node[coordinate] (g1_start) [] at ($(activation_cyclic.north -| activation_cyclic.west)+(0,-4.0mm)$) {};
        \draw (g1_start) -- ++(\groupLabelWidth,0) -- ++(\slant) -- node(g1_intermediate) [] {} ++(0,0) -- (activation_cyclic.north -| g1_intermediate);
        \draw[line width=2.0pt, color=LightCoreGray] ($(activation_cyclic.north -| publisher)+(0,\nLineCoverOffset)$) -- ($(g1_start -| publisher)+(0,\pLineCoverOffset)$);
        \node[above right=\aboveGroupLabel and 0.0cm of g1_start] {announcment/cyclic refresh};
        %consumer triggered
        \node[coordinate] (g2_start) [] at ($(consumer_triggered.north -| consumer_triggered.west)+(0,-4.0mm)$) {};
        \draw (g2_start) -- ++(\groupLabelWidth,0) -- ++(\slant) -- node(g2_intermediate) [] {} ++(0,0) -- (consumer_triggered.north -| g2_intermediate);
        \draw[line width=2.0pt, color=LightCoreGray] ($(consumer_triggered.north -| publisher)+(0,\nLineCoverOffset)$) -- ($(g2_start -| publisher)+(0,\pLineCoverOffset)$);
        \node[above right=\aboveGroupLabel and 0.0cm of g2_start] {consumer-triggered discovery};
        %publish subscribe
        \node[coordinate] (g3_start) [] at ($(publish_subscribe.north -| publish_subscribe.west)+(0,-4.0mm)$) {};
        \draw (g3_start) -- ++(\groupLabelWidth,0) -- ++(\slant) -- node(g3_intermediate) [] {} ++(0,0) -- (publish_subscribe.north -| g3_intermediate);
        \draw[line width=2.0pt, color=LightCoreGray] ($(publish_subscribe.north -| publisher)+(0,\nLineCoverOffset)$) -- ($(g3_start -| publisher)+(0,\pLineCoverOffset)$);
        \node[above right=\aboveGroupLabel and 0.0cm of g3_start] {publish-subscribe};
    \end{scope}

    \begin{scope}[on glass layer]
        %Calls
        %activation/cyclic-refresh
        \node[coordinate] (offer_start) [] at ($(activation_cyclic.north -| publisher_sd_top)+(0,-1.1cm)$) {};
        \draw[-{Straight Barb[length=1.5mm,angle'=40]}] (offer_start) -- node[pos=0.5, align=center]{\codeword{offer(}service, instance,\\major, minor, endpoint options\codeword{)}} (offer_start -| subscriber_sd_top);
        %consumer triggered
        \node[activation] (find_process) [] at ($(consumer_triggered.north -| publisher_sd_top)+(0,-1.6cm)$) {};
        \draw[{Straight Barb[length=1.5mm,angle'=40]}-] (find_process.73) -- node[pos=0.5, align=center]{\codeword{find(}service, instance,\\major, minor\codeword{)}} (find_process.73 -| subscriber_sd_top);
        \draw[-{Straight Barb[length=1.5mm,angle'=40]}, dashed] (find_process.south) -- node[pos=0.5, align=center]{\codeword{offer(}service, instance, major,\\minor, endpoint options\codeword{)}} (find_process.south -| subscriber_sd_top);
        %publish-subscribe
        \node[activation] (subscriber_process) [] at ($(publish_subscribe.north -| publisher_sd_top)+(0,-1.6cm)$) {};
        \draw[{Straight Barb[length=1.5mm,angle'=40]}-] (subscriber_process.78) -- node[pos=0.5, align=center]{\codeword{subscribe(}service, instance,\\~major, eventgroup, endpoint options\codeword{)}} (subscriber_process.78 -| subscriber_sd_top);
        \draw[-{Straight Barb[length=1.5mm,angle'=40]}, dashed] (subscriber_process.south) -- node[pos=0.5, align=center]{\codeword{subscribeAck(}service,\\instance, major, eventgroup\codeword{)}} (subscriber_process.south -| subscriber_sd_top);
    \end{scope}

\end{tikzpicture}
\caption{Service announcement, discovery, and subscription according to the SOME/IP service discovery protocol.}\label{fig:someipsd}
\end{figure}