\documentclass[journal]{IEEEtran}

\usepackage{amsmath, amsfonts, bbm, breqn, mathtools, mathrsfs, bm, amsthm}
\usepackage{algorithm, algpseudocode}
\usepackage{multirow, diagbox, makecell}
\usepackage[table, xcdraw, dvipsnames]{xcolor}
\usepackage[export]{adjustbox}
\usepackage{subcaption}
\usepackage{nameref}
\usepackage{float}
\usepackage{array}
\usepackage{stfloats}
\usepackage{graphics}
\usepackage{graphicx, adjustbox}
\usepackage{soul}
\usepackage{cite}
\usepackage[colorlinks, 
            linkcolor=red,      
            anchorcolor=red,  
            citecolor=blue,       
            ]{hyperref}
\usepackage{changes}
\usepackage{diagbox, booktabs}
\usepackage{placeins, afterpage}

\usepackage[numbers]{natbib}
\usepackage{xr}

\newtheorem{theorem}{Theorem}

\algnewcommand\algorithmicinput{\textbf{Input:}}
\algnewcommand\Input{\item[\algorithmicinput]}
\algnewcommand\algorithmicoutput{\textbf{Output:}}
\algnewcommand\Output{\item[\algorithmicoutput]}
\newcommand{\algorithmicbreak}{\textbf{break}}
\newcommand{\BREAK}{\algorithmicbreak}
\usepackage{lipsum}
\usepackage{mathtools}
\usepackage{cuted}
\usepackage{flushend}


\definechangesauthor[name=liwen, color=blue]{liwen}
\definechangesauthor[name=ye, color=red]{ye}

%%%%%% Define end.

\begin{document}
	
	\title{Optimal Coded Diffraction Patterns for Practical Phase Retrieval }
	
	\author{\IEEEauthorblockN{Qiuliang Ye\IEEEauthorrefmark{1},~\IEEEmembership{Student Member,~IEEE,}
	Bingo Wing-Kuen Ling,~\IEEEmembership{Senior Member,~IEEE,}
 	 Li-Wen Wang,~\IEEEmembership{ Member,~IEEE,} and Daniel Pak-Kong Lun\IEEEauthorrefmark{1},~\IEEEmembership{Senior Member,~IEEE}}
    
    \thanks{Qiuliang Ye, Daniel Pak-Kong Lun, and  Li-Wen Wang are with the Department of Electronic and Information Engineering,
    The Hong Kong Polytechnic University,Kowloon, Hong Kong SAR, China. Bingo Wing-Kuen Ling is with the School of Information Engineering, Guangdong University of Technology, Guangdong Province, China. 
    % (email: \href{mailto:qiu-liang.ye@connect.polyu.hk}{qiu-liang.ye@connect.polyu.hk}; \href{mailto:liwen.wang@connect.polyu.hk}{liwen.wang@connect.polyu.hk}; \href{mailto:pak.kong.lun@polyu.edu.hk}{pak.kong.lun@polyu.edu.hk}).
    }% <-this % stops a space
    \thanks{ \IEEEauthorrefmark{1} Corresponding author: Qiuliang Ye (\href{mailto:qiu-liang.ye@connect.polyu.hk}{qiu-liang.ye@connect.polyu.hk}; \href{mailto:qiustander@gmail.com}{qiustander@gmail.com}) and Daniel Pak-Kong Lun (\href{mailto:enpklun@polyu.edu.hk}{enpklun@polyu.edu.hk}). }
 	 }
    \maketitle

	\begin{abstract}
		Phase retrieval, a long-established challenge for recovering a complex-valued signal from its Fourier intensity measurements, has attracted significant interest because of its far-flung applications in optical imaging. To enhance accuracy, researchers introduce extra constraints to the measuring procedure by including a random aperture mask in the optical path that randomly modulates the light projected on the target object and gives the coded diffraction patterns (CDP). It is known that random masks are non-bandlimited and can lead to considerable high-frequency components in the Fourier intensity measurements. These high-frequency components can be beyond the Nyquist frequency of the optical system and are thus ignored by the phase retrieval optimization algorithms, resulting in degraded reconstruction performances. Recently, our team developed a binary green noise masking scheme that can significantly reduce the high-frequency components in the measurement. However, the scheme cannot be extended to generate multiple-level aperture masks. This paper proposes a two-stage optimization algorithm to generate multi-level random masks named \textit{OptMask} that can also significantly reduce high-frequency components in the measurements but achieve higher accuracy  than the binary masking scheme. Extensive experiments on a practical optical platform were conducted. The results demonstrate the superiority and practicality of the proposed \textit{OptMask} over the existing masking schemes for CDP phase retrieval.
	\end{abstract}
	
	\begin{IEEEkeywords}
		Phase Retrieval, coded diffraction patterns, coded apertures, masking schemes
	\end{IEEEkeywords}
	
    % The paper headers
    \markboth{IEEE Transactions on Signal Processing}%
    {Shell \MakeLowercase{\textit{et al.}}: A Sample Article Using IEEEtran.cls for IEEE Journals}
	

	% Background
	
		\section{Introduction} \label{Sec:introduction}
	\IEEEPARstart{P}{hase} retrieval aims to reconstruct a complex-valued optical wavefield from intensity-only measurements. It is known that, in 
	coherent optical systems, the phase changes of the receiving light carry a lot of information about the measuring object that cannot be found in the intensity of the light. However, traditional imaging devices (Charge-coupled Device (CCD) or Complementary Metal-oxide-semiconductor (CMOS) sensors) can only detect the intensity of optical waves but not the phase information \cite{Shechtman2015PhaseRW}. The need for phase retrieval algorithms thus naturally arises. Phase retrieval is a key problem in crystallography, optical imaging, astronomy, X-ray, electronic imaging \cite{Gerchberg1972APA, Fienup:82, Miao1999ExtendingTM, rodenburg2008ptychography, XU201996, SHEN201854, GUO201816}, etc. Recently, substantial progress was made in the development of phase retrieval algorithms due to the advance in optimization theories \cite{Shechtman2015PhaseRW}. Specifically, optical masks (also named coded apertures), acting as an extra constraint to the optimization process, are adopted in optical phase retrieval systems to improve reconstruction performance. It is shown in \cite{candes2015code, candes2015phase} that the introduction of the random masks significantly improves the accuracy of the reconstructed signals.
	
	The most representative approach in this category is called the coded diffraction pattern (CDP) \cite{candes2015code, candes2015phase} schme which aims to reconstruct a complex-valued signal $\mathbf{x}\in \mathbb{C}^n$ from its modulated Fourier intensity measurements $\bm{\mathcal{X}}_{l}=\left|\mathcal{F}\left(\mathbf{T}_{l} \circ \mathbf{x}\right)\right|^{2}, l=1, \ldots, L$, where $L$, $\mathbf{T}$ and $\circ$ denote the number of measurements, optical masks and elementwise multiplication, respectively. $ \mathcal{F}  $ represents the Fourier transform operator. In practice,  the Fourier transform is implemented by optical devices. In \cite{candes2015code, candes2015phase}, it is approximated by the discrete Fourier transform (DFT). The optical masks can be realized through  optoelectronic devices like spatial light modulators (SLM) or digital micromirror devices (DMD) \cite{Falldorf2010PhaseRB, Horisaki2014SingleshotPI, Horisaki2015ExperimentalDO, Zheng2017DigitalMD}, or by fabrication \cite{PhlatCam2020}. 
	
	\begin{figure}[htb]		
		\centering\includegraphics[width=\linewidth]{Figure/Fig_Opticalpath.pdf}
		\caption{The optical path of the SLM-based CDP phase retrieval system.}
		\label{fig:Opticalpath}
	\end{figure}
	
	An example of the SLM-based CDP phase retrieval system (optical path) is shown in Fig. \ref{fig:Opticalpath}. The SLM, which realizes the random mask $\mathbf{T}$, is used to modulate the phase or amplitude of the incident light beam that is projected onto the target object $\mathbf{x}$. The light then passes through a lens that performs the Fourier transform F optically and is captured by the imaging sensor to become the Fourier intensity measurement $X_l$ of the object. For CDP phase retrieval, the significance of coded apertures' randomness is highlighted in many research articles to guarantee reconstruction performance \cite{candes2015code, Guerrero_PRCDP, Bacca_SRCDP}. Multiple-level random masks are widely employed to ensure randomness. On the other hand, random masks are non-bandlimited in principle \cite{YE2022106808}. The resulting modulated Fourier intensity measurements will contain a large number of significant high-frequency components. Fig. \ref{fig:Fourierintensity} shows an example of Fourier intensity measurements of an object when a white noise mask \cite{candes2015code} is used. The image on the left was generated by computer simulation and the image on the right was collected from a practical CDP-based phase retrieval system. The red square shows the boundary of the $0$-th diffraction order,  which is also the Nyquist frequency of the masked signal $\mathbf{T}_l \circ \mathbf{x}$. It can be seen that there are many data of significant values outside the red square. Note that all phase retrieval optimization methods are discrete algorithms. They assume that the masked signal $\mathbf{T}_l \circ \mathbf{x}$ is discrete with the sampling rate defined by the pixel pitch of the SLM. Since it is discrete, its spectrum will have a Nyquist frequency, which is the red square in Fig. \ref{fig:Fourierintensity}. All discrete systems can only handle the data up to the Nyquist frequency. Thus, the data outside the red square in Fig. \ref{fig:Fourierintensity} will be ignored. It is equivalent to lowpass filtering the Fourier intensity measurements, and it would bring errors and thus inevitably degrade the reconstruction performance. We will demonstrate the effect in Section \ref{Sec:Experiment}.
	
	In recent years, various masking schemes have been proposed for CDP-based phase retrieval systems \cite{candes2015code, Bacca_SRCDP, Guerrero_PRCDP}. However, they only focused on recovery guarantees and verifying the approaches in simulated environments. They ignored the non-bandlimited property of random masks that can result in severe degradation of the reconstructed signal. Recently, our team proposed a green noise masking scheme to mitigate the problem \cite{YE2022106808}. By using a half-toning technique \cite{fung2010green}, we designed binary masks with energy concentrated in the mid-frequency band and applied them to CDP phase retrieval systems. Since the high-frequency components of the mask are reduced, the performance of the reconstruction is also improved. However, since the masks have only binary values, there can be many sharp changes between adjacent pixels which inevitably introduce high-frequency components to the mask. In fact, these sharp changes can be smoothed out if the pixel values of the mask have multiple levels. In this paper, we proposea novel multi-level random phase mask named \textit{OptMask} for CDP phase retrievial. Besides, we also propose a  new optimization-based method for designing \textit{OptMask}. Compared to the previous binary amplitude masking scheme, the proposed design method allows the flexibility for the user to design \textit{OptMask} to have the energy concentrated in the low to mid-frequency band while maximizing its randomness. It is achieved by fully making use of the masks’ multiple level pixel values. \textit{OptMask} is a phase mask. It is different from the binary amplitude masks that will block the light when the mask value is $0$. Hence, \textit{OptMask} allows the maximal amount of light to project on the object. \textit{OptMask} can be implemented with commercial SLM devices or by fabrication, hence they are readily available for practical applications. To summarize, the contributions of this work are as follows:
	
	\textbf{1.} We analyze the non-bandlimited property of the random mask and show its importance in the CDP phase retrieval systems.
	
	\textbf{2.} We propose a novel multi-level random phase mask named \textit{OptMask} and an optimization-based method for its design. The method fully utilizes the multiple-level pixel values of \textit{OptMask} to minimize its high-frequency components and maximize its randomness. A comprehensive analysis is provided for verifying the optimality of \textit{OptMask}.
	
	\textbf{3.} We verify \textit{OptMask} with a practical CDP Fourier phase retrieval platform to demonstrate its practicality and show the effectiveness of the \textit{OptMask} over the existing methods.
	
	The rest of this paper is organized as follows. Section \ref{Sec:relatework} reviews the CDP framework and related mask design methods.  We propose a two-stage optimization algorithm for designing \textit{OptMask} in Section \ref{Sec:Method} and provide a comprehensive analysis of the parameters for \textit{OptMask} in Section \ref{Sec:analysispara}. In Section \ref{Sec:recalgorithm}, we briefly describe the reconstruction algorithm we used for the phase retrieval task.  In Section \ref{Sec:Experiment}, we provide extensive experimental results on an optical system for validating the performance of the proposed masking scheme. 
	
	\begin{figure}[ht]		
		\centering
		\includegraphics[width=\linewidth]{Figure/Fig_Fourierintensity.pdf}
		\caption{ Fourier intensity measurements (\textit{left}: simulation; \textit{right}: experiment) of a USAF chart multiplied with the same white noise (normal distribution) mask. The contrast of the images is adjusted to visualize the small coefficients. The red square denotes the $ 0 $-th diffraction order. The blue circles are the central regions of the $ 1 $-st diffraction order. }
		\label{fig:Fourierintensity}
	\end{figure}	

	%%
	% Related works: 1. Phase retrieval system with mask 2. mask design amp & phase 
	
	\section{Review of CDP Framework and Mask Design Methods} \label{Sec:relatework}
	
	\subsection{Coded Diffraction Pattern}
	
	The CDP phase retrieval framework recovers an unknown complex-valued signal $\mathbf{x}$ from its randomly modulated Fourier intensities \cite{candes2015code}. Since it is mainly studied in a discrete configuration, the Fourier intensities are approximated by the intensities of DFT. To be specific, in the $2$D phase retrieval problem, which is the main interest of this paper, the value at $\left[k_{1}, k_{2}\right]$ of the $l$th intensity measurement $\bm{\mathcal{X}}_l$ is given by:
	\begin{equation}
		\label{Eq:CDP}
		\left|\frac{1}{\sqrt{M_{1} M_{2}}} \sum_{n_{1}, n_{2}=0}^{N_{1}, N_{2}} x\left[n_{1}, n_{2}\right]  T_l\left[n_{1}, n_{2}\right] e^{-i 2 \pi\left(\frac{k_{1} n_{1}}{M_{1}}+\frac{k_{2} n_{2}}{M_{2}}\right)}\right|^2,
	\end{equation}
	where $M_i \geq N_i$ for $i = 1, 2$ and $ 0 \leq k_i \leq M_i - 1$. $\mathbf{T}_l$ denotes the masks (coded apertures) and $l = 1, \dots, L$ where $L$ refers to the number of masks. $\bm{\mathcal{X}}$ is called \textit{coded diffraction pattern} since it provides information about the spectrum of $\mathbf{x}$ modulated by the mask  $\mathbf{T}$. The CDP framework provides the uniqueness guarantee (up to a unimodular constant) with a sufficient number of measurements (empirically larger than $4$) and \textit{random} masks that obey the \textit{``admissible"} property \cite{candes2015code}.
	
	In practice, $\mathbf{T}$ can be realized through diffractive optical elements like spatial light modulators (SLMs) or digital micromirror devices (DMDs), which contain millions of independent cells (pixels); each of them can modulate the amplitude or phase of the light got through (or projected to) it. Specifically, DMD can only realize the binary amplitude modulation ($0$ and $1$) while SLM can create multiple-level phase shifts (usually $256$ levels). An example of the CDP phase retrieval system is shown in Fig. \ref{fig:Opticalpath}. 
	
	\subsection{Non-bandlimited Random Mask} \label{sec:nonbandlimited}
	
	The CDP phase retrieval deals with the Fourier intensity measurements which are also named Fraunhofer diffraction patterns in optics. According to the optical diffraction theory \cite{goodman2017introduction}, the complex-valued wave field $\mathbf{O}$ through wavefront propagation from an object $\mathbf{o}$ at the Fourier plane is given by the Fraunhofer transform:
	\begin{equation}
		\label{Eq:diffraction}
		O\left(k_{u}, k_{v}\right) \approx C_{f}^{\lambda} \iint o(u, v) e^{j 2\pi\left[\frac{p\left(uk_{u}+vk_{v} \right)}{\lambda f}\right]} d u d v,
	\end{equation}
	where $f$ is usually denoted as the distance between the imaging sensor and the object or the focal length of the lens, and $p$ is the pixel pitch of the SLM or DMD. $(u, v)$ and $(k_u , k_v)$ represent the spatial and spectral coordinates, respectively, and $C_{f}^{\lambda}$ is a constant related to the wavelength $\lambda$ and distance $f$. Considering the object $\mathbf{o} = \mathbf{x}\circ \mathbf{T}_l, l =  1, \dots, L$ in this research, \eqref{Eq:diffraction} can be reformulated as:
	\begin{equation}
		\label{Eq:CDPdiffraction}
		\begin{aligned}
			O\left(k_{u}, k_{v}\right) &\approx C_{f}^{\lambda} \iint o(u, v) e^{j 2\pi\left[\frac{p\left(uk_{u}+vk_{v} \right)}{\lambda f}\right]} d u d v\\
			&= C_{f}^{\lambda} \iint x(u, v)T(u,v) e^{j 2\pi\left[\frac{p\left(uk_{u}+vk_{v} \right)}{\lambda f}\right]} d u d v\\
			& = \bar{C_{f}^{\lambda}}\ \mathcal{F}\left\{x\left(\frac{pu}{\lambda f}, \frac{pv}{\lambda f}\right)\right\} \ast  \mathcal{F}\left\{T\left(\frac{pu}{\lambda f}, \frac{pv}{\lambda f}\right)\right\},
		\end{aligned}
	\end{equation}
	where $\ast$ denotes the convolution integral. As can be seen, the wave field $\mathbf{O}$ is the convolution of the Fourier transform of $\mathbf{x}$ and $\mathbf{T}$ with the scaling factor $\frac{\lambda f}{p}$. The central $\left(-\frac{\lambda f}{2p}, \frac{\lambda f}{2p}\right)$ of the Fourier plane is called the $0$-th diffraction order, which is indicated by the red square in Fig. \ref{fig:Fourierintensity}. The pattern will repeat itself to form the higher-order diffractions although with lower amplitude.  Note that $\mathcal{F}\left\{\mathbf{T}\right\}$ is non-bandlimited if $\mathbf{T}$ is random. Therefore, the convolution of $\mathcal{F}\left\{\mathbf{x}\right\}$ and $\mathcal{F}\left\{\mathbf{T}\right\}$ is also non-bandlimited \cite{oppenheim1997signals}. As is shown in Fig. \ref{fig:Fourierintensity}, there are many high-frequency data outside the $0$-th diffraction order.
	
	The objective of the CDP phase retrieval algorithm is to reconstruct the target images from their corresponding intensities \cite{candes2015code,candes2015phase}:
	\begin{equation}
		\label{CDP-Algorithm}
		\begin{aligned}
			& \text { Find } \mathbf{x} \in \mathbb{C}^{N_1\times N_2} \\ & \text { s.t. } ~ \bm{\mathcal{X}}_l = \left|\mathcal{F}\left(\mathbf{T}_{l} \circ \mathbf{x}\right)\right|^{2},\quad l=1, \ldots, L.
		\end{aligned}
	\end{equation}
	As mentioned in Section \ref{Sec:introduction}, the CDP framework assumes $\mathbf{T}_{l} \circ \mathbf{x}$ is discrete, so the Fourier transform is approximated by DFT. Based on the sampling theory, $\bm{\mathcal{X}}_l$ is periodic and has a Nyquist frequency defined by the sampling rate of $\mathbf{T}_{l} \circ \mathbf{x}$, which is determined by the pixel pitch of the mask $\mathbf{T}_{l}$. The Nyquist frequency thus coincides with the $0$-th diffraction order boundary, as shown by the red square in Fig. \ref{fig:Fourierintensity}. Since the CDP phase retrieval algorithm is a discrete algorithm, it can only handle the data up to the Nyquist frequency. Therefore, the high-frequency components of the diffraction patterns that are beyond the red square in Fig. \ref{fig:Fourierintensity} will not be considered in the optimization algorithm. It is equivalent to filtering out these high-frequency components and thus leads to degraded reconstruction performances.
	
	\subsection{Masking Schemes for CDP Phase Retrieval}
	
	In recent years, different masking schemes for CDP phase retrieval were proposed to provide theoretical recovery guaranteed and improve the reconstruction performance under noisy situations. The masking schemes can be broadly categorized into amplitude masks, amplitude-phase masks and phase masks \cite{candes2015code, Guerrero_PRCDP, Bacca_SRCDP, YE2022106808}.
	
	An amplitude mask modulates the amplitude of the incident beam through passing, blocking, or attenuating photons. Binary masks are commonly used because of practicality. They can be implemented with the DMD or by fabrication. Several binary masking schemes were proposed for phase retrieval, e.g.,  white-noise masks  \cite{candes2015code}, blue-noise masks \cite{pinilla2017stochastic}, and green-noise masks \cite{YE2022106808} (all $\mathbf{T}  \in\left\{0, 1\right\}$). However, a signiﬁcant amount of photons are lost when using the amplitude masks, thus leading to lower signal-to-noise-ratio (SNR) measurements \cite{PhlatCam2020}. It is undesirable for photon-limited imaging systems like fluorescence imaging. This greatly limits the applicability of the amplitude masks.
	
	An amplitude-phase mask adjusts the amplitude and phase of the incident beam. However, it cannot modulate the amplitude and phase simultaneously.  Therefore, two devices and two $4F$ (4 focal-length)  systems are needed to achieve amplitude-phase modulation. This inevitably increases the difficulty of the optical alignment and the cost of the whole system. Besides, the state-of-the-art amplitude-phase masking schemes allow the elements to give a magnitude larger than $1$ \cite{candes2015code,GROSS201737}, which is violates the energy preservation condition and further complicates the system implementation.
	
	A phase mask changes the phase of the incident light. It can be implemented by the phase-only SLM. The phase mask provides high SNR since it allows the light to get through it without blocking. Phase masks were popularly adopted in the CDP phase retrieval problem. In \cite{candes2015code}, the discrete uniformly distributed random variables $\mathbf{T}  \in\left\{1, -1, -i, i\right\}$ were used to form the coded apertures. They have a flat frequency response (white noise). Taking temporal correlation and spatial separation into consideration, \cite{Guerrero_PRCDP} developed the uniform random masks $\mathbf{T}  \in \left\{1, -1, -i, i\right\}$ that satisfy the ``admissible" condition. Aiming to minimize the upper bounds of the Gershgorin theorem, \cite{Bacca_SRCDP} developed the uniform random masks $\mathbf{T}  \in \left\{1, -1, -i, i\right\}$ based on an unconstrained optimization algorithm. However, these masking schemes did not consider the non-bandlimited property of the random masks and their adverse effect on practical CDP phase retrieval systems, as described in Section \ref{sec:nonbandlimited}. Recently, our team proposed using the binary phase-only green-noise mask $\mathbf{T} \in \{ 1, -1\}$  with energy concentrated in the mid-frequency band to mitigate the lost high-frequency components problem \cite{YE2022106808}. However, the error diffusion algorithm for generating the green-noise masks was originally developed for half-toning, it was not optimally designed for the phase retrieval task. Besides, since it is a binary mask, there can be many sharp changes between adjacent pixels. Such sharp changes will introduce high-frequency components to the mask, which in turn degrades the phase retrieval performance. In this paper, we propose a multiple-level random phase mask called \textit{OptMask} that can get around the above-mentioned problems. The details are discussed in the following sections.

		\section{Multi-Level Random Masks with Two-Stage Optimization} \label{Sec:Method}
	
	\subsection{Design Considerations}\label{sec:Specfication}
	In this Section, the design considerations of \textit{OptMask} are explained. From \cite{candes2015code}, it is known that the randomness of the mask is the key to the performance of phase retrieval when using the CDP method. The randomness ensures the statistical independence of each measurement thus leading to better reconstruction performance. Therefore, we expect that \textit{OptMask} is sampled from a probability distribution. On the other hand, the non-bandlimited nature of random masks explained in Section \ref{sec:nonbandlimited} can lead to degradation in performance. \textit{OptMask} should have as less high-frequency components as possible while maintaining randomness. 
	
	Common imaging devices have a precision limited to $12$ to $16$ bits. When they are used to record the Fourier intensity, we need to ensure the Fourier coefficients are within the dynamic range of the imaging devices. It is known in \eqref{Eq:CDPdiffraction} that the Fourier intensity measurement is the convolution between the Fourier transforms of the object and the mask. While we cannot control the magnitude of the object’s Fourier coefficients, we should minimize the magnitude of the mask’s Fourier coefficients. In particular, we need to ensure that \textit{OptMask} will not have a bias in the spatial domain or that its Fourier transform will have a strong peak around the DC term. It will saturate the imaging device and lead to distortion. Besides, we also need to control the number of quantization levels of \textit{OptMask} so that it will not generate very fine data variations that cannot be implemented or detected by the optical devices. To summarize, \textit{OptMask} should have the following characteristics:
	
	\textbf{1.} Should be as random as possible. 
	
	\textbf{2.} Bandpass property to reduce the high-frequency components and remove the DC term.
	
	\textbf{3.} Appropriate number of quantization levels to reduce the quantization error. 
	
	\subsection{Problem Formulation} \label{sec:ProbFormulation}
	
	Our goal is to design an optimized mask, namely \textit{OptMask}, that possesses the above-mentioned characteristics.  Denote the desired random masks as $\mathbf{T}^{opt}\in \mathbb{C}^{N \times N \times L}$ with $|\mathbf{T}^{opt}| = 1$ for all pixels. Without loss of generality, we use the $l$-th mask $\mathbf{T}^{opt}_l\in \mathbb{C}^{N \times N}$ to represent $\mathbf{T}^{opt}$. Note that $\mathbf{T}^{opt}$ is a phase mask. Thus, it has a constant magnitude but varying phase angles. For simplicity, we define $\mathbf{T}^{opt}_l \coloneqq e^{i \breve{\bm{\psi}}}$.
	
	To begin with, we generate a phase-only random mask in the spectral domain $\bm{\mathcal{T}} = e^{ i \mathbf{\mathcal{Z}}}$, where $\mathbf{\mathcal{Z}} \sim U[0, 2\pi]$ represents that the phase angles are uniformly distributed over one trigonometric period. Note that $\bm{\mathcal{T}}$ has the all-pass property. Then, we create a spectral filter $\bm{\Phi}$ to filter the unwanted frequency components. We then acquire the filtered masks $\bar{\bm{\mathcal{T}}} = \mathcal{F}^{-1}\left\{\bm{\mathcal{T}} \circ \bm{\Phi}\right\}$ in the spatial domain which is the ground-truth for $\mathbf{T}^{opt}$. $\mathcal{F}^{-1}\left\{\cdot\right\}$ represents the inverse Fourier transform. We hope the optimal solution is as close to the ground-truth as possible. Therefore, we propose to minimize the mean square error (MSE) between the ground-truth $\bar{\bm{\mathcal{T}}}$ and $\mathbf{T}^{opt}$ ($\breve{\bm{\psi}}$):
	\begin{equation}
		\breve{\bm{\psi}} = \mathop{argmin}\limits_{\bm{\psi} \in \mathbb{R}^{N\times N}} \|e^{i \bm{\psi}} - \bar{\bm{\mathcal{T}}}\|_2^2.
	\end{equation}
	Rather than minimizing the difference between the estimated $\breve{\bm{\psi}}$ and ground truth $\bm{\psi}$, we minimize the MSE between $e^{i \bm{\psi}}$ and $\bar{\bm{\mathcal{T}}}$ because it can fully make use of the constant amplitude constraint of the mask at each iteration. As to the design of the spectral filter $\bm{\Phi}$, it is closely related to the frequency response of the desired masks. We will provide a detailed analysis in Section \ref{sec:Filtertype}.
	
	Most structured images (i.e. natural images and optical images) have energy concentrated in the low-frequency bands, in particular the DC term. The saturation problem thus exists because of the finite charge capacity of scientific cameras' photodiodes. Even worse, the imperfection of the optical devices (such as the light leaked from the ``dead zone areas" between consecutive cell units of SLM) will also lead to a large DC term. While the above cannot be controlled, we should ensure the mask does not have a strong DC component that further worsens the saturation problem. We propose to have an additional constraint in the optimization function to satisfy $\mathcal{F}\{e^{i \bm{\psi}}\}(0) = \sum_{j,k} e^{i \psi_{j,k}} \approx \mathbbm{E}[e^{i \bm{\psi}}] = 0$. The optimization problem then becomes:
	\begin{equation}
		\label{Eq:Optimization-formula}
		\breve{\bm{\psi}} = \mathop{argmin} \limits_{\bm{\psi} \in \mathbb{R}^{N\times N}}~ \frac{1}{2}\|e^{i \bm{\psi}} - \bar{\bm{\mathcal{T}}}\|_2^2 \quad s.t.\ \mathbf{1}^T vec\left(e^{i \bm{\psi}}\right) = 0,
	\end{equation}
	where $\mathbf{1} \in \mathbb{R}^{N^2\times 1}$ and $vec(\cdot)$ denotes the all-one vector and vectorization operation, respectively.
	
	The augmented Lagrangian function of \eqref{Eq:Optimization-formula} can be formulated as:
	\begin{equation}
		\begin{aligned}
			\label{Eq:Lagrangian-Original}
			\mathcal{L}(\bm{\psi}, \gamma ) = \min\limits_{\bm{\psi} \in \mathbb{R}^{N\times N}, \gamma \in \mathbb{C}} & \frac{1}{2} \|e^{i \bm{\psi}} - \bar{\bm{\mathcal{T}}}\|_2^2~+~\frac{\alpha}{2} |\mathbf{1}^T vec\left(e^{i \bm{\psi}}\right) |^2 \\
			& + Re <\mathbf{1}^T vec\left(e^{i \bm{\psi}}\right), \gamma>,
		\end{aligned}
	\end{equation}
	where $\gamma$ is the Lagrangian multiplier for the equality constraint and $\alpha$ is a fixed constant for the penalty term.
	
	\subsection{Two-Stage Optimization Algorithm} \label{sec:Optimizationmask}
	
	For the optimization problem proposed Section \ref{sec:Specfication}, we develop a novel two-stage optimization algorithm to generate the arbitrary multi-level random masks \textit{OptMask}. The procedure of the two-stage optimization algorithm is illustrated in Algorithm \ref{Algorithm-Twostep}.
	
	\vspace{1em}
	\subsubsection{Stage 1} \textit{Gradient Descent-Based Optimization}
	
	Note that it is possible to derive a closed-form solution of $\bm{\psi}^{(n)}$ at each iteration from \eqref{Eq:Lagrangian-Original}. However, the optimization algorithm can empirically  fail to converge to a local minimum if an inappropriate step size is selected. Considering that \eqref{Eq:Lagrangian-Original} is differentiable with respect to the decision variable $\bm{\psi}$, we propose an efficient gradient descent-based algorithm for each pixel with an appropriately chosen step size.  We thus separate the Lagrangian function $\mathcal{L}(\bm{\psi}, \gamma )$ into two parts: MSE and constraint.
	
	\textit{\textbf{a. MSE:}} The derivative of the MSE term $\frac{1}{2}\|e^{i \bm{\psi}} - \bar{\bm{\mathcal{T}}}\|_2^2$ w.r.t. individual pixel $\psi_{j,k}^{(n)}$ at the $n$-th iteration is:
	\begin{equation}
		\label{Eq:MSEpart}
		\begin{aligned}
			& \frac{\partial \frac{1}{2}\left\|e^{i \bm{\psi}^{(n)}} - \bar{\bm{\mathcal{T}}}\right\|_2^2}{\partial \psi_{j, k }^{(n)}}\\
			&= -\frac{\partial   \left( \bar{\bm{\mathcal{T}}}^H e^{i \bm{\psi}^{(n)}} + \bar{\bm{\mathcal{T}}}^T e^{-i \bm{\psi}^{(n)}}\right)}{\partial \psi_{j, k }^{(n)}}\\
			& = -\frac{\partial i\left(i Im\left( \bar{\bm{\mathcal{T}}}^H e^{i \bm{\psi}^{(n)}} \right)\right)}{\partial \psi_{j, k }^{(n)}}\\
			& = Re(\bar{\mathcal{T}}_{j, k})\sin(\psi_{j, k}^{(n)}) - Im(\bar{\mathcal{T}}_{j, k})\cos(\psi_{j, k}^{(n)})\\
			& \coloneqq \partial_{\bm{\psi}} MSE_{\mathcal{L}}(\bm{\psi}^{(n)}, \gamma^{(n)}).
		\end{aligned}
	\end{equation}
	
	\textit{\textbf{b. Constraint:}} The constraint term $\frac{\alpha}{2} |\mathbf{1}^T vec\left(e^{i \bm{\psi}}\right) |^2 + Re <\mathbf{1}^T vec\left(e^{i \bm{\psi}}\right), \gamma> $ in  \eqref{Eq:Lagrangian-Original} is equivalent to  $ \frac{\alpha}{2}| \mathbf{1}^T vec\left(e^{i \bm{\psi}}\right) + \frac{\gamma^{n}}{\alpha}|^2 ~+ ~C$, where $C$ is a constant unrelated to the derivative w.r.t. $\psi_{j,k}$. Hence, 
	\begin{equation}
		\label{Eq: constraintpart}
		\begin{aligned}
			&\frac{\frac{\alpha}{2}|\mathbf{1}^Tvec\left( e^{i\bm{\psi }^{(n)}} \right) +\frac{\gamma ^{(n)}}{\alpha}|^2+C}{\psi_{j,k}^{(n)}}\\
			&  =\frac{\alpha \partial {\scriptstyle\left(
					\begin{aligned}
						&\sum_{j,k}{e^{i \psi_{j,k}^{(n)}}} \sum_{j,k}{e^{-i\psi_{j,k}^{(n)}}} \\ 
						&+ \frac{(\gamma ^{(n)})^*}{\alpha}\sum_{j,k}{e^{i\psi_{j,k}^{(n)}}} + \frac{\gamma ^{(n)}}{\alpha}\sum_{j,k}{e^{-i\psi_{j,k}^{(n)}}} \end{aligned} 
					\right)  }}{\partial \psi_{j,k}^{(n)}} \\
			& = \frac{\alpha \partial {\scriptstyle \left( 
					\begin{aligned}
						&e^{i\psi_{j,k}^{(n)}} \sum_{[p,q]\ne [j,k]}{e^{-i\psi_{p,q}^{(n)}}} + e^{-i\psi_{j,k}^{(n)}}\sum_{[p,q]\ne [j,k]}{e^{i\psi_{p,q}^{(n)}}}\\ 
						&+ \frac{(\gamma ^{(n)})^*}{\alpha}e^{i\psi_{j,k}^{(n)}} + \frac{\gamma ^{(n)}}{\alpha}e^{-i\psi_{j,k}^{(n)}} \end{aligned} \right)}}{\partial \psi_{j,k}^{(n)}} \\
			& = \begin{aligned} 
				&-{\scriptstyle \left( 
					Re\left( \gamma ^{(n)} \right) \sin \psi_{j,k}^{(n)} - Im\left( \gamma ^{(n)} \right) \cos \psi_{j,k}^{(n)} \right)}\\
				&-{\scriptstyle\left( \sin \psi_{j,k}^{(n)} \alpha\sum_{[p,q]\ne [j,k]}{\cos}\psi_{p,q}^{(n)} - \cos \psi_{j,k}^{(n)}\alpha\sum_{[p,q]\ne [j,k]}{\sin}\psi_{p,q}^{(n)}  \right)} \end{aligned}\\
			&\coloneqq \partial _{\bm{\psi}}ConLoss_{\mathcal{L}}(\bm{\psi }^{(n)},\gamma ^{(n)})\\
		\end{aligned}
	\end{equation}
	Combining \eqref{Eq:MSEpart} and \eqref{Eq: constraintpart}, the estimation at the $(n+1)$th iteration is updated via the gradient descent formula:
	\begin{equation}
		\label{Eq:gradupdate}
		\resizebox{\hsize}{!}{$\bm{\psi}^{(n+1)} =  \bm{\psi}^{(n)} - \beta\partial_{\bm{\psi}}\left(  MSE_{\mathcal{L}}(\bm{\psi}^{(n)}, \gamma^{(n)})
			+ ConLoss_{\mathcal{L}}(\bm{\psi }^{(n)},\gamma ^{(n)})\right),$}
	\end{equation}
	where $\beta$ denotes the step size of the gradient descent algorithm. 
	
	After acquiring $\bm{\psi}^{(n+1)}$ with \eqref{Eq:gradupdate}, the Lagrangian multiplier can be updated via 
	\begin{equation}
		\label{Eq:multiplerupdate}
		\gamma^{(n+1)} = \gamma^{(n)} \linebreak + \alpha \mathbf{1}^Tvec\left( e^{i\bm{\psi }^{(n+1)}} \right).
	\end{equation}
	
	\vspace{1em}
	\subsubsection{Stage 2} \textit{Quick Search Pixel-Based Quantization}
	
	After executing \textit{Stage 1}, we acquire the optimal solution $\breve{\bm{\psi}}$ which is a continuous variable with infinite precision. However, the commercial-grade SLMs have only 8-bit precision. We can only implement at most $256$ phase changes with the phase-only SLMs. Therefore, it is necessary to quantize the continuous variable into a discrete one for successful implementation. The goal of the quantization problem is to assign each pixel of  $\Breve{\bm{\psi}}$ to a specific finite value while minimizing the quantization error at the same time. To solve this problem, we propose a novel quick search pixel-based quantization technique. 
	
	Define an $M$-level codebook 
	\begin{equation}
		\label{Eq:codebook}
		\mathcal{C} = \left[ 0, \frac{2\pi}{M},  2\frac{2\pi}{M},\linebreak  \dots,  (M-1)\frac{2\pi}{M}\right]\end{equation}
	with uniform spacing (usually $M$ ranges from $2$ to $16$). We quantize $\breve{\bm{\psi}}$ over $2\pi$ for two reasons: \textit{(1)} usually SLMs are designed to modulate $0-2\pi$ phase shift; \textit{(2)} quantization over one trigonometric period can prevent the phase wrapping problem. We quantize $\breve{\bm{\psi}}$ pixel-by-pixel in numerical sequence from $[1, 1]$ to $[N, N]$. At each iteration, we execute the quantization for one pixel.
	
	When quantizing the $[j, k]$-th pixel of $\breve{\bm{\psi}}$ at the $(jk)$-th iteration, we keep all the pixels except $\breve{\psi}_{j,k}$ to be the same as those at the $\left(j(k-1)\right)$-th iteration. Then we project the $\breve{\psi}_{j,k}$ onto the codebook $\mathcal{C} $ via $\mathcal{H}\left(\breve{\psi}_{j,k} \mid \breve{\bm{\psi}}_{\neq [j,k]} \right)$. The updated mask is denoted as:
	\begin{equation}
		\breve{\bm{\psi}}^{(jk)} = 
		\left\{ \begin{array}{l}
			\breve{\psi}_{p, q}^{\left(j(k-1)\right)},\quad p\neq j, q \neq k,\\
			c \in \mathcal{C}, \quad p= j, q = k.
		\end{array} \right.
	\end{equation}
	To acquire the quantized masks that still satisfy the conditions in  \eqref{Eq:Optimization-formula}, we find the best $\hat{\psi}_{j,k} \in \mathcal{C}$ with the following objective function:
	\begin{equation}
		\label{Eq:quantizecode}
		\begin{aligned} 
			& \resizebox{\hsize}{!}{$\min\limits_{\breve{\psi}_{j,k}  \in \mathcal{C}} \mathcal{H}\left( \breve{\psi}_{1,1}^{\left(j(k-1)\right)}, \breve{\psi}_{1,2}^{\left(j(k-1)\right)},  \dots, \breve{\psi}_{j,k-1}^{\left(j(k-1)\right)}, \breve{\psi}_{j,k}, \breve{\psi}_{j,k+1}^{\left(j(k-1)\right)}, \dots, \breve{\psi}_{N,N}^{\left(j(k-1)\right)} \right)$} \\
			& \coloneqq \resizebox{0.9\hsize}{!}{$ \min\limits_{\breve{\psi}_{j,k}  \in \mathcal{C}} \frac{1}{2}\left\|e^{i \breve{\bm{\psi}}^{(jk)} } - \bar{\bm{\mathcal{T}}}\right\|_2^2 + \frac{\alpha}{2}\left|\mathbf{1}^T vec\left( e^{i \breve{\bm{\psi}}^{(jk)}} \right) +\frac{\breve{\gamma} }{\alpha}\right|^2$},
		\end{aligned}
	\end{equation}
	where $\breve{\gamma}$ denotes the optimal Lagrangian multiplier obtained from \textit{Stage 1}. As can be seen, the optimization-based quantization method can quickly search for the optimal direction at each iteration and thus minimize the objective function. Besides, the proposed quantization method can satisfy the symmetric property (zero DC component) and bandpass attribute developed in Section \ref{sec:ProbFormulation}. In each loop, all pixels of the mask are processed. Empirically, we only need $2$ loops to get a satisfactory performance. 
	
	
	% 	\textbf{Theorem $1$}: The Algorithm \ref{Algorithm-Twostep} is convergent given any filtered random mask $\bar{Y}$.
	
	% 	\textbf{Proof:} The proof of Theorem $1$ is in Appendix \ref{ProofTheorem1}.
	
	\begin{algorithm}[ht]
		\begin{algorithmic}[1] 
			\caption{Two-Stage Optimal Random Masks Design}
			\label{Algorithm-Twostep}
			\Input Lagrangian multipler $\gamma = 0 $, filtered masks $\bar{\bm{\mathcal{T}}} \in \mathbb{C}^{N\times N}$, stopping threshold $\delta$, penalty constant $\alpha$, step size $\beta$, quantization loop numbers $G$, number of shots $L$.
			\For{$l \gets 1$ to $L$}
			\State \textbf{Stage $1$:} \textit{Gradient Descent-Based Optimization}:
			\While{$\frac{\|\bm{\psi}^{(n+1)} - \bm{\psi}^{(n)}\|_2^2}{N^2} \geq \delta$}
			\State Update $\bm{\psi}^{(n+1)}$ \Comment Eq. \eqref{Eq:gradupdate}
			\State $ \gamma^{(n+1)} = \gamma^{(n)} + \alpha \mathbf{1}^Tvec\left( e^{i\bm{\psi }^{(n+1)}} \right)$
			\EndWhile
			\State \textbf{Stage $2$:} \textit{Quick Search Pixel-Based Quantization}:
			\State Create an $M$-level codebook $\mathcal{C}$
			\Comment Eq. \eqref{Eq:codebook} 
			\For{$g \gets 1$ to $G$}
			\For{$[j,k] \gets [1,1]$ to $[N,N]$}
			\State $\breve{\psi}_{j,k}^{(jk)} = \mathop{argmin} \limits_{\breve{\psi}_{j,k}  \in \mathcal{C}} \mathcal{H}\left(\breve{\psi}_{j,k} \mid \breve{\bm{\psi}}_{\neq [j,k]} \right)$ \hspace{-1cm}
			\Comment Eq. \eqref{Eq:quantizecode}
			\EndFor
			\EndFor
			\State $\mathbf{T}^{opt}_l = e^{i \breve{\bm{\psi}}}$
			\EndFor
			\Output \textit{OptMask}: $\mathbf{T}^{opt}$
		\end{algorithmic}
	\end{algorithm}
	
	    \section{Analysis of the proposed Masking Scheme} \label{Sec:analysispara}
	
	In this section, we analyze some crucial factors and determine the appropriate parameters of the proposed \textit{OptMask} in the simulation environment. To quantitatively measure the effects brought by different factors, we define a parameter $ \eta $ to indicate the energy of the masks in the high-frequency areas:
	\begin{equation}
		\label{Eq:etadefine}
		\eta(\bm{\Psi})=\frac{\sum_{j, k} \bm{\Psi}_{[j, k\geq 0.8 N]}}{\sum_{j, k} \bm{\Psi}_{j,k}},
	\end{equation}
	where $  \bm{\Psi} = \left|DFT\left( \mathbf{T}^{opt} \right)\right|^2 $. Basically, if a mask has a large $\eta$, the resulting Fourier intensity measurements will have more high-frequency data beyond the Nyquist rate of the system. Then, there will be more high-frequency data removed in the phase retrieval computation. 
	
	As to the other parameters, the size of the masks was $256\times256$. The size of the oversampling Fourier intensity measurements was $762\times 762$ (the same size in the physical experiment environment). We set the pixel size as $8 \mu m$ and the wavelength $\lambda$ as $632.8 nm$ (HeNe laser). In addition, we simulated the ``dead zone areas" (small gaps) between consecutive cell units  of the SLM device \cite{Pan_2018}. There is no phase modulation in these areas. It introduces a small bias to the mask in the spatial domain. The penalty constant $\alpha$ in \eqref{Eq:Lagrangian-Original} and step size $\beta$ in \eqref{Eq:gradupdate} were empirically set as $10^{-4}$ and $0.2$, respectively. The maximum number of iterations for \textit{Stage 1} is $300$ and the stopping threshold was $10^{-7}$.
	
	\subsection{Spectral Filter} \label{sec:Filtertype}
	As mentioned in Section \ref{sec:ProbFormulation}, we generated the desired frequency response with a spectral filter $\bm{\Phi}$. We designed $\bm{\Phi}$ to satisfy the bandpass property to minimize the high-frequency components and remove the DC component. The main design parameters of $\bm{\Phi}$ are its passband frequencies. We will show that they have important consequences on the randomness and high-frequency components of the mask. The other design parameters of the filter, such as passband/stopband ripples, roll-off rate, etc., are beyond the scope of this study. To let us focus on the passband frequencies, we designed $\bm{\Phi}$ using an idea filter \cite{oppenheim1997signals}, which is flat within the passband and has a sharp transition band, making it a good candidate in spectral filtering. An example of the process to acquire the desired OptMask $\bar{\mathbf{\mathcal{T}}}$ through an ideal filter $\bm{\Phi}$ is shown in Fig. \ref{fig:SpectralFilter}.
	
	\begin{figure}[htb]		
		\centering\includegraphics[width=\linewidth]{Figure/Fig_Spectral_Filter.pdf}
		\caption{Illustration of generating the desired mask $\bar{\mathbf{\mathcal{T}}}$ via an ideal bandpass filter.}
		\label{fig:SpectralFilter}
	\end{figure}
	
	\subsection{Passband Frequency Analysis} \label{sec:PassBandFreq}
	
	In this section, we investigated the effect of the passband frequency of $\bm{\Phi}$ on \textit{OptMask}. Note that the true intensity image is the convolution integral of the mask’s Fourier spectrum and the target image’s Fourier spectrum. If the spectrum of the mask has a broader passband, the convolution kernel will cover a larger area in the Fourier plane but have a lower gain. For most natural images, in high-frequency regions, significant Fourier coefficients are often clustered along the horizontal and vertical axes. The convolution of such a spectrum with a large but low gain kernel will not generate much significant data in high-frequency regions. On contrary, for a mask with a narrower passband, the convolution kernel will cover a smaller area in the Fourier plane but have a larger gain. It can generate significant high-frequency data when the kernel, with a higher gain, convolves with the large Fourier coefficients of the image in the high-frequency regions (although not many). To illustrate this, we generated $L = 10$ masks for each kind of random mask and multiplied them with an image. We then computed the Fourier intensity of the masked images using the DFT. The resulting Fourier intensities using different masks are shown in Fig. \ref{fig:Passband}. Here, we borrow the operator $\eta$ defined in \eqref{Eq:etadefine} to compute the high-frequency contents of these Fourier intensities. Note that these Fourier intensities are not the same as those we measured in the experiment since they are computed using the DFT (the real ones are obtained via the Fourier transform optically). They do not have data outside the Nyquist frequency. However, their high-frequency energy close to the Nyquist frequency can be a good indicator of the high-frequency energy of the real measurements. So we computed the average high-frequency energy $\bar{\eta} = \frac{1}{L}\sum_{l = 1}^L \eta_l(\bm{\Psi}_l)$ of these intensity measurements. It is also shown in Fig. \ref{fig:Passband}. For all optimal masks, the first value refers to the lower cut-off frequency and the second value denotes the upper cut-off frequency.  As can be seen in the first column, two bandpass random masks have different lower cut-off frequencies ($\frac{\pi}{4}$ and $\frac{\pi}{5}$) but the same upper cut-off frequency $\frac{\pi}{2}$. TThe result shows that the Fourier intensity of using the optimal mask with a lower cut-off frequency $\frac{\pi}{5}$ (thus broader passband) has a smaller $\eta$, i.e., less significant high-frequency data. It is the same for the intensity images in the second column. The Fourier intensity using the bandpass mask with a lower cut-off frequency $\frac{\pi}{5}$ (thus broader passband) again has a smaller $\eta$. These results verify our argument above. As explained above, the parameter $\eta$ of the computed Fourier intensity is a good indicator of the high-frequency contents of the true intensity measurement. The higher $\eta$ is, the more high-frequency data will be in the true intensity measurement. They will be ignored during the computation and leads to performance degradation. Thus, if we just consider the high-frequency energy of the intensity measurement, the filter $\bm{\Phi}$ should be designed with a broader passband. However, we will show in Section \ref{sec:randomness} that we also need to consider the randomness of the mask. It demands an optimal design of $\bm{\Phi}$ that balances the two requirements.
	
	\begin{figure}[htb]
		\centering\includegraphics[width=\linewidth]{Figure/Fig_PassBand.pdf}
		\caption{Visualization of computed Fourier intensities using optimal masks of different bandwidths and passband frequencies in the spatial and spectral domains.}
		\label{fig:Passband}
	\end{figure}
	
	\subsection{Quantization Level}
	As derived in Section \ref{sec:Optimizationmask}, the acquired random masks after \textit{Stage 1} are continuous variables. It is necessary to quantize the random masks for loading into hardware devices, such as SLM. We, therefore, developed the \textit{quick-search pixel-based quantization} method in \textit{Stage 2} for efficient quantization. In this section, we analyze the effect of the number of quantization levels on the high-frequency content of the mask. Although we design the optimal mask with no high-frequency contents, the high-frequency data are re-introduced after the mask is quantized. To illustrate this, an experiment was carried out to evaluate the high-frequency content of \textit{OptMask} when it is quantized with different numbers of levels.  The results are presented in Fig. \ref{fig:quantization}. As can be seen in Fig. \ref{fig:quantization}(a), the high-frequency energy parameter $\eta$ (defined in \eqref{Eq:etadefine}) of the $2$-level (binary) and $4$-level masks are much higher than the unquantized mask. It is because the quantization introduces many sharp changes between adjacent pixels if there are not enough quantization levels. These sharp changes re-introduce high-frequency components to the mask. On the other hand, $\eta$ decreases with the growth of the quantization levels. As can be seen, the $16$-level and $32$-level masks have $\eta$ comparable to the unquantized mask. In practice, the gray-scale phase mismatch due to the imperfections of the SLM devices can bring quantization errors. Some pixel values cannot be correctly implemented because of the non-linear input-output mappings of the devices (more details are shown in the supplementary document). Therefore, as 16-level masks and 32-level masks have similar $\eta$, we adopted the $16$-level masks to reduce our reliance on the accuracy of the SLM. Fig. \ref{fig:quantization}(b) shows a comparison of the power spectrums (along the x-axis) of different masks. The difference in high-frequency power between the binary mask and the 16-level mask can be up to 10 dB.
	
	\begin{figure}[htb]
		
		\begin{subfigure}{\linewidth}	
			\centering
			\begin{adjustbox}{width=\linewidth,center}
				\centering\includegraphics[width=\linewidth]{Figure/Fig_Quantization.pdf}
			\end{adjustbox}
			\vspace*{-4mm}
			\caption{}
		\end{subfigure}
		
		\begin{subfigure}{\linewidth}	
			\centering
			\begin{adjustbox}{width=0.9\linewidth,center}
				\centering\includegraphics[width=\linewidth]{Figure/Fig_Quantization_Error.pdf}
			\end{adjustbox}
			\vspace*{-4mm}
			\caption{}
		\end{subfigure}
		
		\vspace{-0.2cm}
		\caption{(a) Spatial and spectral domains of the bandpass optimal mask $(\frac{\pi}{3}, \frac{\pi}{2})$ at different quantization levels. (b) Mean power Spectra (in log scale) of the optimal masks in (a) over x-coordinate. }    
		\label{fig:quantization}
	\end{figure}
	
	\subsection{Randomness} \label{sec:randomness}
	
	The randomness of a random mask plays an important role in the reconstruction performance. Intuitively, more random the mask, the better the reconstruction performance of the images. It is because, higher randomness brings more information into the measurement process that can reduce the ill-posedness of the phase retrieval problem  \cite{candes2015code}. In the last decade, various randomness measurement methods based on the statistical information of digital images were proposed and applied to image encryption and chaotic systems \cite{WU2013323,BEHNIA2008408}. Shannon entropy measure \cite{shannon1948}, defined as $H(X) = \mathbb{E}\left[-\log p(X)\right]$ for a discrete random variable $X$, is widely used for measuring randomness, since it provides the quantitative description of uncertainty. The larger the entropy $H(X)$, the more uncertain the signal $X$ is, thus meaning higher randomness. 
	
	To investigate the randomness of \textit{OptMask} under different settings, we adopted the local Shannon entropy measure, a generalization of the  Shannon entropy, to quantify randomness \cite{WU2013323}. The local Shannon entropy splits an image $X$ into $k$ non-overlapping blocks and computes the average Shannon entropy $\bar{H_k}(X) = \frac{1}{k}\sum_{i = 1}^k H(X_i)$ over $k$ blocks, where $X_i$ denotes the $i$-th block. We generated $L = 10$ masks for each kind of random mask and calculated $\bar{H}$. We used $16$-level optimal random masks and $32 \times 32$ image blocks. For the green noise mask, we used $16 \times 16$ image blocks. The visualization of different masks is shown in Fig. \ref{fig:Entropy}.  As can be seen, the entropy of the green noise mask is much smaller than the optimal masks. It is because the theoretical maximum entropy of a signal is closely related to the number of intensity levels. The binary green noise masks can only have uncertainty at most $H = log_2 2 = 1$ while multiple-level optimal masks ($16$-bit in the figure) have $H = log_2 16 = 4$. The multi-level representation of the mask thus increases the randomness and helps improve the reconstruction performance. On the other hand, the uncertainty decreases with the decrease in the lower cut-off frequency. It is because pixels need to be clustered to achieve the low-frequency response of the mask. The lower the frequency, the larger the clusters is, which in turn lowers the randomness of the mask. Although using the optimal masks with lower cut-off frequencies (or broader passband)  will incur less high-frequency data in the intensity measurements (as shown in the analysis in Section \ref{sec:PassBandFreq}), we choose the optimal mask with cut-off frequencies  $\left( \frac{\pi}{5}, \frac{\pi}{3}\right)$ as the final design. It is based on a holistic consideration of both the randomness and high-frequency energy of the mask. The experimental comparisons between different masks are shown in Section \ref{sec:DifferentCutoff}.
	
	\begin{figure}[htb]
		\centering\includegraphics[width=\linewidth]{Figure/Fig_Entropy.pdf}
		\caption{Randomness (quantified by average entropy) of different kinds of random masks.}
		\label{fig:Entropy}
	\end{figure}
	
	\section{Reconstruction Algorithm} 
	
	Recovering the complex-valued images from the phaseless intensity measurements can be posed as a nonconvex optimization problem, where the forward model is the magnitude square of the masked image's Fourier transform. Regularization terms subjective to the image prior should be added to the optimization process to reduce the measurement noise while preserving important details such as edges and textures. In this study, we adopted an Alternating Direction Method of Multipliers (ADMM) reconstruction algorithm \cite{Boyd2011DistributedOA, parikh2014proximal} with separate magnitude and phase regularization. Since the reconstruction algorithm is not the focus of this paper, the related discussion is put in the Appendix.
	
	\section{Experiment} \label{Sec:Experiment}

\subsection{Experimental Setup} \label{sec:expsetup}

\textbf{Optical Setup:} We evaluated the proposed \textit{OptMask} on a practical optical system which is shown in Fig. \ref{fig:SLMsetup}. It contains a Thorlabs $ 10 mW$ HeNe laser with wavelength $ \lambda = 632.8 nm$; and a $ 12 $-bit $ 1920\times1200 $ Thorlabs Kiralux CMOS camera with pixel pitch $ 5.86 \mu m$. We used a $ 1920\times1080 $ Holoeye Pluto phase-only SLM with pixel pitch $ \delta_{SLM}=8\mu m $ to generate the phase-only random masks in the experiments. We only utilized the central $ 256\times256$ SLM pixels in all experiments. The resulting Fourier intensity measurements were captured by the imaging sensors. The size of the acquired measurement is $\frac{\lambda f}{d\delta_{SLM}} = 762 \times 762$, where $d$ and $f$ denote the pixel pitch of the camera and the focal length of the lens before the camera, respectively. 

\textbf{Target images:} We used two kinds of target images for experimental evaluation: complex-valued images (phase-only) and real-valued images. For complex-valued phase-only images, we pre-multiplied the phase-only images with the masks and loaded them into the SLM. In this case, the SLM was not only for implementing the phase mask but also for the phase-only images. For the real-valued images, we adopted a USAF chart (Newport Inc.) as the testing object.

% 		We evaluated the proposed \textit{OptMask} on a practical optical system which is shown in Fig. \ref{fig:SLMsetup}. It contains a Thorlabs $ 10 mW$ HeNe laser with wavelength $ \lambda = 632.8 nm$; and a $ 12 $-bit $ 1920\times1200 $ Thorlabs Kiralux CMOS camera with pixel pitch $ 5.86 \mu m$. We used a $ 1920\times1080 $ Holoeye Pluto phase-only SLM with pixel pitch $ \delta_{SLM}=8\mu m $ to generate the phase-only random masks and target images in the experiments. Specifically, the target images were modularly added with the random masks (phase multiplication). Then resulting images were loaded to the SLM to generate the phase-only images with multiple-level phase shifts. We only utilized the central $ 256\times256$ SLM pixels in all experiments. The resulting Fourier intensity measurements were captured by the imaging sensors. The size of the acquired measurement is $\frac{\lambda f}{d\delta_{SLM}} = 762 \times 762$ where $d$ and $f$ denotes the pixel pitch of the camera and the focal length of the lens before the camera, respectively. For each target images, we collected three Fourier intensity measurements for each kind of random mask ($L = 3$). 

\begin{figure}[htb]		
	\centering\includegraphics[width=\linewidth]{Figure/Fig_Setup.pdf}
	\caption{The hardware setup of the SLM-based CDP phase retrieval system.}
	\label{fig:SLMsetup}
\end{figure}


\textbf{Error Criteria:} We used two criteria to evaluate the reconstruction performance of the phase parts: peak signal-to-noise ratio  (PSNR) and structural similarity index (SSIM). They are defined as follows:

\begin{equation}
	\begin{aligned}
		PSNR_{\text {phase}}(\mathbf{x}, \tilde{\mathbf{x}}) &= 10 \log_{10} \sum_{j=0}^{M-1}\frac{2\pi}{M S E_{\text {phase}}},\\
		SSIM_{\text {phase}}(\mathbf{x}, \tilde{\mathbf{x}}) &= SSIM(\angle\mathbf{x}, \angle \tilde{\mathbf{x}}- \theta),\\
	\end{aligned}
\end{equation}
where $M S E_{\text {phase}} = \frac{1}{MN} \sum_{i=0}^{N-1} \sum_{j=0}^{M-1}\left(\angle x_{i, j}-\angle \tilde{x}_{i, j} - \theta \right)^{2} $.
$ \mathbf{x} $ and $ \tilde{\mathbf{x}} $ represent the original and reconstructed phase images, respectively. Both $ \angle \mathbf{x} $ and $ \angle \tilde{\mathbf{x}} $ are unwrapped to compare the true phase difference. Besides, $\pi$ phase shift is added to $ \angle \mathbf{x} $ and $ \angle \tilde{\mathbf{x}} $ to ensure non-negative values when computing  $PSNR_{\text {phase}}$. A global phase shift term $ \theta $ due to ambiguity is removed to avoid the $ MSE_{phase} $ value being amplified.

\textbf{Calibration:}
Since the phase objects and the coded apertures in our experiments are generated by an SLM, we need to carefully calibrate the SLM such that we can generate the masked target images and quantitatively evaluate the fidelity of our reconstructed images. We demonstrated the detailed calibration procedure in the supplementary document.

\subsection{Experimental Results}

\subsubsection{Number of Measurements} \hfill

Intuitively, better reconstruction performance can be achieved by using a larger number of measurements for reconstruction since more information is introduced. However, using a large number of measurements would lengthen the image acquisition time and require the testing object to be static for a long period. It affects the reconstruction performance of dynamic objects. To investigate the appropriate numbers of measurements, we used a natural image named ``crowd" as the ground truth to investigate the effects of the number of measurements. We collected $4$ masked Fourier intensity measurements via \textit{OptMask} and reconstructed the images with different numbers of measurements with the same hyperparameters. The results are shown in Fig. \ref{fig:NumofMeasurement}. As can be seen, although it is possible to reconstruct the global profile of the ground-truth with only one measurement, the details of the images are nearly lost. While the PSNR and SSIM increase with the growth of the numbers of the measurements, there is no substantial difference between $3$ Mask and $4$ Mask cases because of sufficient information. Therefore, we adopted $3$ measurements for the following experiments to balance performance and efficiency. 

\begin{figure}[htb]		
	\centering\includegraphics[width=\linewidth]{Figure/Fig_Num_Mask.pdf}
	\caption{The reconstruction images (phase parts) with different numbers of Fourier intensity measurements. The target image is masked via \textit{OptMask}.}
	\label{fig:NumofMeasurement}
\end{figure}

\subsubsection{Comparison of Masks with Different Cut-off Frequencies} \label{sec:DifferentCutoff}\hfill  

As analyzed in Section \ref{sec:randomness}, the cut-off frequencies of the optimal masks can affect their high-frequency contents and randomness. They thus have an impact on the reconstruction performance. To verify this, we conducted experiments with masks of different cut-off frequencies. Two natural images namely ``crowd" and ``Triumphal Arch" were used as the ground truth. The compared masks include the binary green noise masks and three $16$-level optimal masks of different cut-off frequencies. We collected $3$ Fourier intensity measurements for each kind of mask and reconstructed the images with the same hyperparameters. The results are shown in Fig. \ref{fig:DifferentCutoff}. As can be seen, although the \textit{OptMask} with cut-off frequencies $\left(4\pi/5,\pi/2\right)$ and the green noise mask have a similar amount of high-frequency information $\eta$, (see Fig. \ref{fig:CompMask}), the reconstruction performance with the multiple-level optimal mask is much better than that of the binary green noise mask. It is due to the large difference in their entropy (and hence the randomness). Comparing the multiple-level \textit{OptMasks}, the one with the cut-off frequencies $\left(\pi/5,\pi/3\right)$ gives the best performance, as shown in Fig. \ref{fig:USAFresult}. Its entropy and the $\eta$ value are in the middle of the rank. The above result verifies our choice of using that mask as our final design. 

\begin{figure}[htb]		
	\centering\includegraphics[width=\linewidth]{Figure/Fig_DifferentCutoffFreq.pdf}
	\caption{The reconstruction images (phase parts) with different cut-off frequencies. }
	\label{fig:DifferentCutoff}
\end{figure}

\subsubsection{Comparison with Other Masking Schemes} \hfill

We compared the proposed \textit{OptMask} with four masking schemes: \textit{(1)} $4$-level white noise masks (denoted as White-4) \cite{candes2015code}; \textit{(2)} $16$-level white noise masks (denoted as White-16) \cite{candes2015code}; \textit{(3)} binary green noise masks (denoted as Green) \cite{YE2022106808}; \textit{(4)} correlation-based coded apertures (denoted as SR-CDP) \cite{Bacca_SRCDP}; and \textit{(5)} admissible coded apertures (denoted as PR-CDP) \cite{Guerrero_PRCDP}. For \textit{OptMask}, we adopted the one with cut-off frequency $(\frac{\pi}{5}, \frac{\pi}{3})$  (as mentioned in Section \ref{sec:randomness}) in this paper. We used the original settings of the compared masks: For White-16, $16$-level masks with a discrete uniform distribution $d \in \left[ -\pi, \pi  \right]$ (same codebook of \textit{OptMask}) were used. For White-4, PR-CDP, and SR-CDP, $4$-level masks with a discrete uniform distribution $d \in \left\{ -1, 1, -j, j  \right\}$ were used. For Green, $2$-level masks with a discrete uniform distribution $d \in \left\{ -1, 1 \right\}$ were used. Specifically, we used the set size $C_d =16$ for PR-CDP because it provides stable reconstruction in practice. It is worth noting that these compared masks are designed with discrete random variables and no quantization process is involved. Some examples of different kinds of masks and their corresponding Fourier intensities are shown in Fig. \ref{fig:CompMask}. It can be seen that the proposed \textit{OptMask} has the smallest $\eta$. It is one of the key factors that lead to improved performance, as we will demonstrate in the following sections.

\begin{figure}[htb]		
	\centering\includegraphics[width=\linewidth]{Figure/Fig_Comp_Mask.pdf}
	\caption{The spatial domain (phase parts) of different kinds of masks and their corresponding Fourier intensity measurements. The $\eta$ is computed through the average of $4$ measurements.}
	\label{fig:CompMask}
\end{figure}

$\bullet$ \textbf{\textit{Real-Valued Images:}} As mentioned above, we placed a USAF chart on the object plane as the target object. A picture of the target image is shown in Fig. \ref{fig:USAFresult}. The chart only allows the projected light to go through its chart's holes (dark areas in the figure). Thus, the resulting target images have sharp amplitude changes along the boundaries of the holes. The regions that the light can pass through should have the same phase thus we treat the target image as a real-valued binary image. Note that for each masking scheme, we fine-tuned the parameters of the reconstruction algorithm to obtain the best visual effect. The detailed parameter setting of the reconstruction algorithm can be found in the appendix. We ran $100$ iterations of the reconstruction algorithm and three trials for all situations. For the experiment, we captured three measurements via the imaging sensor for each kind of mask.

The qualitative results are shown in Fig. \ref{fig:USAFresult}. Since the USAF chart is a binary testing object, we demonstrated the visual comparisons in grayscale images.  It can be seen that the estimated images through different kinds of binary masks have clear differences. Even though the general profile of the target image can be identified by all masking schemes, the  quality of the reconstructed image has a considerable difference. The reconstructed image resulting from using \textit{OptMask} remains sharp at the edge regions and relatively smooth in the background areas. The reconstructed image via Green masks is a bit blurry although it has a relatively smooth background. For other kinds of masks, it is difficult to recognize the detailed contents of the images. The above experimental results show that the proposed \textit{OptMask} outperforms all state-of-the-art masking schemes qualitatively when applied to practical phase retrieval system testing with a real object.

\begin{figure*}[!htb]		
	\centering\includegraphics[width=0.8\linewidth]{Figure/Fig_USAFresult.pdf}
	\caption{Experimental results of different phase retrieval masking schemes on a USAF chart. The first \textbf{row} shows the whole USAF chart image and the target image captured by the imaging sensor (zoom-in red-rectangle regions). The second \textbf{row} presents the reconstructed images through different masking schemes.}
	\label{fig:USAFresult}
\end{figure*}

$\bullet$ \textbf{\textit{Complex-Valued Images:}} We used the phase-only images as the testing objects as described in Section \ref{sec:expsetup}. We chose $4$ natural images and $4$ standard testing images. Specifically, the standard testing images include an optical vortex image and a checkerboard pattern image from the SLM built-in software, and $2$ cell images from Wikipedia that follow public domain licenses. The detailed parameter setting of the reconstruction algorithm can be found in the appendix. We ran $200$ iterations of the reconstruction algorithm and three trials for all situations. We chose the results with the highest PSNR value.  

The quantitative and qualitative results are shown in TABLE \ref{table:expresult} and Fig. \ref{fig:comp_phaseonly}, respectively. As presented in Table \ref{table:expresult}, the reconstruction performances of the proposed \textit{OptMask} consistently outperform  all compared masking schemes in PSNR and SSIM. For the natural images, \textit{OptMask} has PSNR and SSIM gains of at least $2.605dB$ and $0.0.073$, respectively. As can be seen in Fig. \ref{fig:comp_phaseonly}, the proposed \textit{OptMask} can reconstruct images with the most similar contours as the ground-truths and preserve more details compared with using other masking schemes. Specifically, the results via \textit{OptMask} can successfully reconstruct the complex details and textures of the ``tree" and ``crowd" images, which proves the capability of \textit{OptMask} in preserving the high-frequency components. As for the reconstruction images via other masking schemes, the textures are nearly lost. Besides, the phase jumping errors appear in regions near $0$ (dark blue) or $2\pi$ (light yellow). For the standard testing images, the proposed \textit{OptMask} can achieve PSNR and SSIM gains of at least $2.105dB$ and $0.082$, respectively, compared with other state-of-the-art masking schemes. It can be seen in Fig. \ref{fig:comp_phaseonly} that the reconstructed images via \textit{OptMask} have better quality than those using other methods. \textit{OptMask} cannot only recover the contours and detailed textures of the ground-truth but also avoids the phase jumping error compared with other masking schemes. The above experimental results show that the proposed \textit{OptMask} outperforms all state-of-the-art masking schemes quantitatively and qualitatively when used in a practical phase retrieval system.

\begin{table*}[htb]
	\centering
	\caption{Quantitative comparison (PSNR/SSIM)  with the state-of-the-art masking schemes for phase retrieval on natural and standard testing images. The corresponding qualitative results are shown in Fig. \ref{fig:comp_phaseonly}. Best performances are marked in \textbf{bold} and the second best performances are colored in {\color{Green} green}. The Fourier intensity measurements are collected with the optical system presented in Fig. \ref{fig:SLMsetup}. } 
	\setlength\tabcolsep{11pt}
	\begin{adjustbox}{width=\textwidth,center}
		\begin{tabular}{ccc|cc|cc|cc|cc|cc}
			\hline \multicolumn{1}{c}{\multirow{2}{*}{ \diagbox{Images}{Masks} }}  & \multicolumn{2}{c|}{ \textit{OptMask} (\textbf{Ours})} & \multicolumn{2}{c|}{ Green } & \multicolumn{2}{c|}{ PR-CDP } & \multicolumn{2}{c|}{ White-4 } & \multicolumn{2}{c|}{ White-16 } & \multicolumn{2}{c}{ SR-CDP }\\
			& PSNR $\uparrow$ & SSIM $\uparrow$ & PSNR $\uparrow$ & SSIM $\uparrow$ & PSNR $\uparrow$ & SSIM $\uparrow$ & PSNR $\uparrow$ & SSIM $\uparrow$ & PSNR $\uparrow$ & SSIM $\uparrow$ & PSNR $\uparrow$ & SSIM $\uparrow$\\
			\hline
			\multicolumn{11}{c}{Natural Images}\\ 
			\hline Triumphal Arch & \cellcolor{pink!50} $\mathbf{22.982}$ &  \cellcolor{pink!50} $\mathbf{0.648}$ & {\color{Green}$20.377$} & {\color{Green}$0.521$} & $15.328$ & $0.436$ & $16.691$ & $0.444$ & $16.338$ &  $0.431$ & $14.214$ &  $0.301$ \\
			\hline Tree & \cellcolor{pink!50} $\mathbf{19.046}$ &  \cellcolor{pink!50} $\mathbf{0.628}$ & {\color{Green}$16.332$} & {\color{Green}$0.475$} & $12.936$ & $0.344$ & $13.268$ & $0.304$ & $12.291$ &  $0.256$ & $11.915$ &  $0.212$\\				
			\hline Crowd & \cellcolor{pink!50} $\mathbf{23.582}$ &  \cellcolor{pink!50} $\mathbf{0.757}$ & {\color{Green}$19.476$} & {\color{Green}$0.653$} & $13.352$ & $0.532$ & $17.368$ & $0.559$ & $14.132$ &  $0.530$ & $12.169$ &  $0.341$\\							
			\hline Sculpture & \cellcolor{pink!50} $\mathbf{22.027}$ &  \cellcolor{pink!50} $\mathbf{0.721}$ & {\color{Green}$18.678$} & {\color{Green}$0.507$} & $14.364$ & $0.438$ & $15.220$ & $0.460$ & $16.101$ &  $0.492$ & $13.025$ &  $0.388$\\							
			\hline \multicolumn{11}{c}{Standard Testing Images}\\ 
			\hline Vortex & \cellcolor{pink!50} $\mathbf{17.783}$ &  \cellcolor{pink!50} $\mathbf{0.816}$ & {\color{Green}$15.584$} & {\color{Green}$0.730$} & $14.471$ & $0.653$ & $15.526$ & $0.680$ & $13.493$ &  $0.581$ & $12.601$ &  $0.506$\\							
			\hline Cell & \cellcolor{pink!50} $\mathbf{22.209}$ &  \cellcolor{pink!50} $\mathbf{0.756}$ & {\color{Green}$19.727$} & {\color{Green}$0.653$} & $16.645$ & $0.517$ & $18.544$ & $0.583$ & $17.339$ &  $0.524$ & $15.222$ &  $0.372$\\							
			\hline Cell Cluster & \cellcolor{pink!50} $\mathbf{22.953}$ &  \cellcolor{pink!50} $\mathbf{0.794}$ & {\color{Green}$17.260$} & {\color{Green}$0.712$} & $11.826$ & $0.536$ & $14.206$ & $0.606$ & $12.104$ &  $0.542$ & $10.750$ &  $0.453$\\							
			\hline Checkerboard & \cellcolor{pink!50} $\mathbf{24.191}$ &  \cellcolor{pink!50} $\mathbf{0.895}$ & {\color{Green}$22.086$} & {\color{Green}$0.781$} & $12.154$ & $0.524$ & $13.803$ & $0.590$ & $11.487$ &  $0.487$ & $10.589$ &  $0.287$\\			
			\hline
		\end{tabular}
	\end{adjustbox}
	\label{table:expresult}
\end{table*}

\begin{figure*}[htb]
	
	\centering
	%%%%%%%%%% Natural %%%%%%%%%%%%%%%%%
	\begin{subfigure}{\textwidth}	
		\centering
		\begin{adjustbox}{width=\textwidth,center}       
			\begin{tabular}{*{7}{c@{\extracolsep{0.3em}}} }
				\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Target_12.png}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_12_Opt.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_12_Green.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_12_PR.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_12_White.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_12_White16.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_12_SR.jpg}\\ \addlinespace[0.2em]
				
				\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Target_32.png}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_32_Opt.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_32_Green.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_32_PR.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_32_White.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_32_White16.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_32_SR.jpg}\\ \addlinespace[0.2em]
				
				\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Target_36.png}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_36_Opt.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_36_Green.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_36_PR.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_36_White.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_36_White16.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_36_SR.jpg}\\ \addlinespace[0.2em]
				
				\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Target_4.png}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_04_Opt.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_04_Green.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_04_PR.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_04_White.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_04_White16.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_04_SR.jpg}\\
			\end{tabular}
		\end{adjustbox}
		
		\caption{}
	\end{subfigure}
	
	
	%%%%%%%%%% Standard Testing %%%%%%%%%%%%%%%%%
	\begin{subfigure}{\textwidth}	
		\centering
		\begin{adjustbox}{width=\textwidth,center}       
			
			\begin{tabular}{*{7}{c@{\extracolsep{0.3em}}} }
				
				\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Target_38.png}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_38_Opt.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_38_Green.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_38_PR.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_38_White.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_38_White16.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_38_SR.jpg}\\ \addlinespace[0.2em]
				
				\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Target_39.png}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_39_Opt.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_39_Green.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_39_PR.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_39_White.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_39_White16.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_39_SR.jpg}\\\addlinespace[0.2em]
				
				\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Target_37.png}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_37_Opt.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_37_Green.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_37_PR.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_37_White.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_37_White16.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_37_SR.jpg}\\\addlinespace[0.2em]
				
				\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Target_41.png}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_41_Opt.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_41_Green.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_41_PR.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_41_White.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_41_White16.jpg}
				&\includegraphics[height=0.16\textwidth, width=0.18\textwidth,valign=t]{Figure/PhaseOnly_Exp_Result/Result_41_SR.jpg}\\
				
				Ground-truth & \textit{OptMask} (\textbf{Ours}) & Green & PR-CDP & White-4 & White-16  & SR-CDP
				\\
			\end{tabular}
		\end{adjustbox}
		\vspace*{-2mm}
		\caption{}
	\end{subfigure}
	\vspace{-0.2cm}
	\caption{Experimental results of different phase retrieval masking schemes on (a) natural images, and (b) standard testing images. The first \textbf{column} shows the phase parts of the ground-truth images with colorbars. The other \textbf{columns} denote the reconstruction images through different masking schemes. The colormap of the all columns ranges from $0$ to $2\pi$. The  regions inside the  {\color{red} red} rectangular boxes represent the most obvious visual differences between different masking schemes. The quantitative results (PSNR/SSIM) of each reconstructed images are shown in TABLE \ref{table:expresult}.} 
	\label{fig:comp_phaseonly}
	
\end{figure*}

	\section{Conclusion}

This paper proposed an optimization-based masking scheme for practical coded diffraction pattern (CDP) phase retrieval systems. In particular, an optimal multiple-level phase-only random mask named \textit{OptMask} was proposed which has significantly reduced high-frequency components while maintaining the randomness. They are important to the performance of the CDP phase retrieval. \textit{OptMask} is designed based on a two-stage optimization algorithm that allows the flexibility to adjust the cut-off frequencies and quantization levels. We have demonstrated how we optimally select the cut-off frequencies and quantization levels of \textit{OptMask} to minimize its high-frequency content and maximize its randomness. We demonstrated the performance of \textit{OptMask} by applying it to a practical CDP phase retrieval system. The results showed that the quality of the amplitude and phase images retrieved using the proposed \textit{OptMask} significantly outperformed the traditional CDP masking schemes both qualitatively and quantitatively.

\section*{Appendix A\\ Reconstruction Algorithm} \label{Sec:recalgorithm}

Let us consider the modified version of  \eqref{Eq:CDP}:
\begin{equation}
	\begin{aligned}
		\label{Eq:Opt_Framework}
		\min\limits_{\mathbf{x} \in \mathbb{C}^{n}} \frac{1}{2} \mathcal{D}(\mathbf{x}, \bm{\mathcal{X}})+\frac{\alpha}{2} \mathcal{R}(\mathbf{x}), \quad \text { s.t. }  \bm{\mathcal{X}} = \left|\mathcal{F}(\mathbf{T} \circ \mathbf{x})\right|^2,
	\end{aligned}
\end{equation}
where $\mathcal{D}$ denotes the data loss function, and $\mathcal{R}$ represents the regularization term. $\alpha$ is a fixed constant to balance the weight between regularization and the data loss. Adding physical constraints to the above equation, the optimization \eqref{Eq:Opt_Framework} becomes:
\begin{equation}
	\begin{aligned}
		& \min _{\mathbf{x} \in \mathcal{C}^{n}} \frac{1}{2} \mathcal{D}\left(|\mathbf{z}|^{2}, \bm{\mathcal{X}}\right) + \frac{\alpha}{2} \mathcal{R}_1(\mathbf{d}) + \frac{\beta}{2} \mathcal{R}_2(\mathbf{\Phi}), \\
		\text { s.t. } & \mathbf{z} = \mathcal{A}(\mathbf{x}) =  \mathcal{F}(\mathbf{T} \circ \mathbf{x}),\ \mathbf{x} = \mathbf{d}\circ \mathbf{\Phi}, \ |\mathbf{\Phi}| = 1,
	\end{aligned}
\end{equation}
where $d$ denotes the magnitude part of the $\mathbf{x}$ and $\mathbf{\Phi} = e^{i \phi}$ represents the phase part, respectively. In order to deal with the above ill-posed and highly nonlinear optimization problem, we propose to reconstruct the original images based on Alternating Direction Method of Multipliers (ADMM) framework \cite{Boyd2011DistributedOA, parikh2014proximal}. Here, we apply the ADMM framework to split the whole problem into several simple sub-problems with respect to $\mathbf{x}$, $\mathbf{z}$, $\mathbf{d}$ and $\mathbf{\Phi}$, , where $\mathbf{x}$ is the unknown complex-valued signal; $\mathbf{z}$ is the forward Fourier domain; $\mathbf{d}$ is the amplitude part; and $\mathbf{\Phi}$ is the phase part.  The corresponding augmented Lagrangian function of the optimization algorithm is formulated as:
\begin{equation}
	\begin{aligned}
		\label{Eq:PRLagrangian}
		\min\limits_{\mathbf{x}, \mathbf{d}, \mathbf{\Phi}, \mathbf{z}, \xi , \zeta } \mathcal{L} & (\mathbf{x}, \mathbf{z}, \mathbf{d}, \mathbf{\Phi}, \xi, \zeta) =    \frac{1}{2} \mathcal{D}\left(|\mathbf{z}|.^{2}, \mathbf{y}\right) + \frac{\alpha}{2} \mathcal{R}_1(\mathbf{d}) \\ &+ \frac{\beta}{2} \mathcal{R}_2(\mathbf{\Phi}) + \frac{r_{1}}{2} \left\| \mathbf{z} - 
		\mathcal{A}(\mathbf{x}) +  \frac{\xi}{r_1}\right\|_{2}^{2} \\ &  +\frac{r_{2}}{2}\left\|  \mathbf{d}\circ \mathbf{\Phi} - \mathbf{x}  + \frac{\zeta}{r_2} \right\|_{2}^{2},
	\end{aligned}
\end{equation}

where $\xi$, $\zeta$, $r_1$, and $r_2$ represent the Lagrangian multipliers corresponding to $\mathbf{z}$ and $\mathbf{d}\circ \mathbf{\Phi}$, fixed penalty parameters for $\mathbf{z}$ and $\mathbf{d}\circ \mathbf{\Phi}$, respectively. The detailed derivations of the Lagrangian function are shown in the supplementary document. 

\subsection{Update for $\mathbf{x}$ and $\mathbf{z}$}

The update formula of $\mathbf{x}$ and $\mathbf{z}$ at the $(n+1)$-th iteration are given as:
% \resizebox{\linewidth}{!}{
	\begin{equation}
		\label{Eq:updateformula}
		\begin{aligned}
			&\resizebox{0.9\linewidth}{!}{$\mathbf{x}^{(n+1)} \leftarrow  \left(r_1\mathcal{A}^H\mathcal{A} + r_2 \mathbf{I}\right)^{-1}\left[r_1\mathcal{A}^H\left( \frac{\zeta^{(n)}}{r_{1}} + \mathbf{z}^{(n)}\right) + r_2 \left( \mathbf{d}^{(n)}\circ \mathbf{\Phi}^{(n)} - \frac{\xi^{(n)}}{r_{2}}\right)\right],$}\\
			&\resizebox{\linewidth}{!}{$\mathbf{z}^{(n+1)} \leftarrow \frac{1}{r_1 + 1}\left( r_1 \left|\mathcal{A}(\mathbf{x}^{(n+1)}) + \frac{\zeta^{(n)}}{r_{1}}\right| + \sqrt{\bm{\mathcal{X}}}\right)\angle \left(\mathcal{A}(\mathbf{x}^{(n+1)}) + \frac{\zeta^{(n)}_i}{r_{1}}\right),$}
		\end{aligned}
	\end{equation}
	where $\mathbf{I}$ is the identity matrix and $\mathcal{A}^H\mathcal{A} = diag\left(\sum_l \mathbf{I}_l^H\mathbf{I}_l\right) $. $\angle (\mathbf{x}) = \frac{\mathbf{x}}{|\mathbf{x}|}$ extracts the angle of $\mathbf{x}$. Due to limited space, the detailed explanation and derivation can be seen in the supplementary document.
	
	\subsection{Update for $\mathbf{d}$ and $\mathbf{\Phi}$}
	
	The updates of $\mathbf{d}$ and $\mathbf{\Phi}$ at the $(n+1)$-th iteration are formulated as:
	\begin{equation}
		\label{Eq:regularizeupdateformula}
		\begin{aligned}
			&\resizebox{\linewidth}{!}{$\mathbf{d}^{(n+1)} \leftarrow  \frac{\alpha}{2} \mathcal{R}_1(\mathbf{d})  + \frac{r_{2}}{2}\left\| \mathbf{d}\circ \mathbf{\Phi}^{(n)} - \mathbf{x}^{(n+1)} + \frac{\zeta^{(n)}}{r_2} \right\|_{2}^{2},$}\\
			&\resizebox{\linewidth}{!}{$\mathbf{\Phi}^{(n+1)} \leftarrow \frac{\beta}{2} \mathcal{R}_2(\mathbf{\Phi})  + \frac{r_{2}}{2}\left\| \mathbf{d}^{(n+1)}\circ \mathbf{\Phi} - \mathbf{x}^{(n+1)} + \frac{\zeta^{(n)}}{r_2} \right\|_{2}^{2} + \mathscr{C}(\mathcal{S}),$}
		\end{aligned}
	\end{equation}
	where $\mathcal{S} \equiv \left\{ \mathbf{\Phi} \in \mathcal{C}^N : |\Phi_i| = 1, i = 1, \dots, N\right\}$ and $\mathscr{C}(\mathcal{S}) \equiv             \left\{\begin{array}{l}
		0,\quad \Phi_i \in \mathcal{S}, \\
		\infty,\quad otherwise.
	\end{array}\right. $ is the indicator function for penalizing non-unit magnitude $\Phi_i$. In this research, we adopt the total variation (TV) regularization function for $\mathbf{d}$ and $\mathbf{\Phi}$ which is widely used in the image reconstruction task to preserve the edges, shapes and discontinuities in the ill-posed inverse problems \cite{RUDIN1992259}. Thus, the TV norms of two variables are defined as $\mathcal{R}_1(\mathbf{d})\coloneqq \|\nabla \mathbf{d}\|_1$ and $\mathcal{R}_2(\mathbf{\Phi})\coloneqq \|\nabla \mathbf{\Phi}\|_1$, where $\nabla$ is the gradient operator. The above $TV-\ell_2$ problems can be solved via the primal-dual algorithm \cite{Vogel1996TV}. In fact, the $\mathbf{d}$ and $\mathbf{\Phi}$ problems can be regarded as the plug-and-play prior with arbitrary denoising algorithms \cite{Chan2017Plug}. But this is out of the scope of our research.
	
	\subsection{Whole Algorithm}
	
	Overall, the whole phase retrieval algorithm is summarized in Algorithm \ref{Algorithm-ADMMPR}.
	
	\begin{algorithm}[htb]
		\begin{algorithmic}[1] 
			\caption{ADMM Phase Retrieval with Separate Magnitude and Phase Regularization}
			\label{Algorithm-ADMMPR}
			\Input Fourier intensity measurements $\bm{\mathcal{X}}$, regularization weights $\alpha$ and $\beta$, penalty constants $r_1$ and $r_2$, maximum iteration $itmax$, $\xi = \mathbf{0}$, $\zeta = \mathbf{0}$, stop threshold $\delta$.
			\State \textit{Initialization:} acquire $\mathbf{x}^{(1)}$ via the spectral initialization method \cite{candes2015phase}, and $\mathbf{d}^{(1)} = |\mathbf{x}^{(1)}|$, $\mathbf{\Phi}^{(1)} = \angle\mathbf{x}^{(1)}$, $\mathbf{z}^{(1)} = \mathcal{A}(\mathbf{x}^{(1)})$.
			\For{$n \gets 1$ to $itmax$}
			\State  Update $\mathbf{x}^{(n+1)}$ and $\mathbf{z}^{(n+1)}$ according to \eqref{Eq:updateformula}
			\State Update $\mathbf{d}^{(n+1)}$ and $\mathbf{\Phi}^{(n+1)}$ via the primal-dual algorithm \cite{Vogel1996TV} according to \eqref{Eq:regularizeupdateformula}
			\State Update Lagrangian multipliers:
			\begin{equation*}
				\begin{aligned}	&\resizebox{0.7\linewidth}{!}{$\xi^{(n+1)} \leftarrow  \xi^{(n)} - r_1 \left(\mathcal{A}\left(\mathbf{x}^{(n+1)}\right) - \mathbf{z}^{(n+1)}\right),$} \\ &\resizebox{0.7\linewidth}{!}{$\zeta^{(n+1)} \leftarrow  \zeta^{(n)} - r_2 \left(\mathbf{d}^{(n+1)}\circ \mathbf{\Phi}^{(n+1)} - \mathbf{x}^{(n+1)}\right)$}
				\end{aligned}	
			\end{equation*}
			\If {$\|\mathbf{x}^{(n+1)} - \mathbf{x}^{(n)}\| \leq \delta$}   
			\State \BREAK
			\EndIf
			\EndFor
			\Output estimated image $\mathbf{x}$
		\end{algorithmic}
	\end{algorithm}
	
	
	\subsection{Parameter Settings}
	
	Real-valued images:	the parameters $r_1$, $r_2$, and $\alpha$ were set as $1$, $1$, and $0.01$ respectively. For each masking scheme, we fine-tuned the $\beta$ near $0.01$ to find out the optimal visualization.
	
	Complex-valued images: the parameters $r_1$, $r_2$, $beta$, and $\alpha$ were set as $0.5$, $0.5$, $2$, and $0.3$ respectively.
	


	\bibliographystyle{IEEEtran}
	\bibliography{Reference_All}
	

	
\end{document}


