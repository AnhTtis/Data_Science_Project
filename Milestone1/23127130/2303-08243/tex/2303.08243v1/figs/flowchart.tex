

\tikzstyle{block} = [draw, rectangle, text centered, thick,rounded corners=2pt,
                     minimum height=1.5em, minimum width=5em, inner sep=4pt]
\tikzstyle{typical} = [fill=white!95!black]
\tikzstyle{reddish} = [draw=red,fill=white!95!red]
\tikzstyle{blueish} = [draw=blue,fill=white!95!blue]
\tikzstyle{greenish} = [draw=green!40!gray,fill=white!95!green]
\tikzstyle{longblock} = [draw,rectangle,text centered,thick,rounded corners=2pt,
                     minimum height=1.5em, minimum width=8em, inner sep=4pt]
\tikzstyle{largeBlock} = [draw, rectangle, very thick,
                     minimum height=19em, minimum width=43em, inner sep=4pt]
\tikzstyle{smallBlock} = [draw, rectangle, text centered, thick, dashed,
                     minimum height=14.3em, minimum width=35em, inner sep=4pt]
\tikzstyle{dashedBlock} = [draw, dashed, rectangle,
                     minimum height=2em, minimum width=4em, inner sep=4pt]
\tikzstyle{dottedBlock} = [draw, rectangle, text centered, ultra thick,
					 minimum height=1.5em, 
					 minimum width=8em, inner sep=4pt,
					 dash pattern=on 1pt off 2pt on 4pt off 2pt] 
\tikzstyle{newtip} = [->, very thick]
\tikzstyle{bidir} = [<->, very thick]
\tikzstyle{newtip_dashed} = [->, very thick, dashed]
\begin{tikzpicture}[auto, inner sep=0pt, outer sep=0pt, >=latex]

  % Column 1 - relative to laserscan block and then north.
  % This block defines the origin of the tikzpicture.
  \node[block, reddish] (laserscan) {Laserscan};

  \node[anchor=south] (goal) at ($(laserscan.north) + (0, 1.0)$) {Goal};
    
  % Column 2
  \node[block,reddish,anchor=west] (egocircle) 
    at ($(laserscan.east) + (0.80, 0)$) 
    {\centering Egocircle};
  \node[block, typical, anchor=south] (worldmap)  
    at ($(egocircle.north)+(0, 1)$)
    {\centering World Map};

  % Column 3: Global Planner down.
  \node[longblock, typical, anchor=west] (global) 
    at ($(worldmap.east) + (1., 0)$)  
    {\centering Global Planner};

  \node[longblock, blueish, anchor=west, text width=8em] 
    (gap) at (egocircle-|global.west)
    {\centering Gap \\ Generation};

  \node[dottedBlock,blueish,anchor=west, text width=8em] (traj) 
    at ($(gap.east) + (0.5, 0)$) 
    {\centering Joined B\'{e}zier \\ Path Planning};

  \node[dottedBlock,blueish,anchor=west, text width=8em] (keyhole) 
    at ($(traj.east) + (0.5, 0)$) 
    {\centering {\keyhole} \\ Synthesis};
  
  \node[dottedBlock,blueish,anchor=north, text width=9em] (mpc) 
    at ($(traj.south) - (0, 0.8)$) {\centering NMPC \\ Trajectory Tracking};
    
  \node[dottedBlock,greenish,anchor=north, text width=8em] (controller) 
    at ($(mpc.south) - (0, 0.8)$) {\centering Keyhole CBF};
    
  % Surrounding block: Local Planner
  \node[smallBlock, draw=blue!90!black,anchor=north] (local) 
    at ($(traj)!0.09!(traj) + (1em, 1.1)$){};
  \node[anchor=north,xshift=-1em,yshift=-4pt] (localtext) at (local.north) 
      {\sc Safer Gap Local Planner};

  % Big surrounding block: Navigation System.
  \node[largeBlock, draw=blue!90!black,anchor=north] (planning) 
    at ($(global)!0.09!(worldmap) + (9em, 0.9)$){};
  \node[anchor=north,xshift=0em,yshift=-4pt] (planningtext) at (planning.north) 
      {\sc Hierarchical Navigation System};

  % Arrows - Columns 1 and 2.
  \draw[newtip] (laserscan.east) -- (egocircle.west);
  % \draw[newtip] (egocircle.north) -- node[midway,right,xshift=2pt]{sensor info} 
  %   (worldmap.south);
  \draw[newtip] (egocircle.north) -- (worldmap.south);

  % Arrows - Column 2 to 3.
  \draw[newtip] (worldmap.east) -- (global.west);
  \draw[newtip] (egocircle.east) -- (gap.west);

  \draw[bidir] (global.east) -- (global.east-|traj.north) -- ($(traj.north)+(0,0.55)$);

  % Arrows - Column 3 down.
  \draw[newtip] (gap.east) -- (traj.west);
  \draw[newtip] (traj.south) -- node[midway,left,anchor=east,xshift=0pt,yshift=0pt,text width=2cm,text centered]{Reference}(mpc.north);

  \draw[newtip] (traj.east) -- (keyhole.west);
  \draw[newtip] (keyhole.south) -- node[midway,right,anchor=west,xshift=15pt,yshift=-5pt,text width=2cm,text centered]{Safety Constraint}(mpc.north);

  % \draw[newtip] (score.south) -- node [midway,left,xshift=-3pt]{Recent Best Trajectory}(controller.north);
  \draw[newtip] (mpc.south) -- node[midway,left,anchor=east,xshift=0pt,yshift=0pt,text width=3cm,text centered]{Tracking Control}(controller.north);
  
  \draw[newtip,<-] ($(keyhole.east)+(5pt,0)$) -- node[midway,above,anchor=south,xshift=2pt,yshift=5pt]{Replan}($(keyhole.east)+(30pt,0pt)$) |- (mpc.east);

%  % Arrows - new parts.
%  \draw[newtip,<->](cc.east) --node[midway,yshift=2pt]{precheck} (NI.west); 
  \draw[newtip] ($(goal.east)+(3pt,0pt)$) -- (goal.east-|planning.west);
%
%  \draw[newtip] ($(local.south) - (0, 0)$) -- (NI.north);
%  \draw[newtip] (NI.east) -- (following.west);
%
%  \draw[newtip](following.north) -- (replan.south); 
%  \draw[newtip](NI.north east) to[in=250] ([xshift=-5pt]replan.south);
%  \draw[newtip](replan.south west) -- (local.east);
%  \draw[newtip](replan.north west) -- (global.east);

  % Level text.
  \node[anchor=north west, xshift=5pt] (LT) at (planning.north east)
   {\sc Level};
  \node[anchor=center] at (LT|-global) {High};
  \node[anchor=center] at (LT|-local) {Mid};
  \node[anchor=center] at (LT|-controller) {Low};
  
  % Legend on the bottom left
  \node[dottedBlock,anchor=north,minimum width=1em,text width=1em] (legend) at ($(laserscan.south) + (0, -3)$) {};
  \node[anchor=north] (legend_name) at ($(legend.south) + (0, -0.2)$) {Contributions};
\end{tikzpicture}