% \subsection{\toedit{Keyhole Barrier Function Synthsis} \label{sec:keyhole}}
% \TODO{Ahmad}
\subsection{{\keyhole} Synthesis \label{sec:keyhole}}

% This section describes the approach to model the safety function $\safeFunc$ in NMPC.
The inflated collision-free space $\infFreeSpace$ is captured by the zero level-set of the {\keyhole}. We will use a shallow, two-layer neural network with rectified linear units (ReLU) to model the barrier function. In order to keep the network shallow and minimal, we need to leverage the geometry of keyhole shape, i.e., the straight lines and the circle. The complete expression of the {\keyhole} is 
\begin{equation} \eqlabel{nn}
 \begin{split}
%\begin{align}
    h(x) =\  & \alpha_1 R_1 + \alpha_2 R_2 + \alpha_3 R_3  + \alpha_4 R_c  + \alpha_5 R_1R_2 \\
         & + \alpha_6 R_cR_1 + \alpha_7 R_cR_2  + \alpha_8 R_cR_3  \\
         & + \alpha_9 R_1R_2R_3 + \alpha_{10} R_1R_4R_5  + \alpha_{11} R_2R_4R_5  \\
         & + \alpha_{12} R_cR_1R_4 + \alpha_{13} R_cR_2R_4  + \alpha_{14} R_cR_1R_2 \\
         & + \alpha_{15} R_cR_1R_2R_3  + b
%\end{align}
 \end{split}
\end{equation}
Effectively, all points in the domain are mapped onto the level-sets of the line and circle equations (layer 1) and their polynomial combinations (layer 2). Any point that maps onto a negative level-set is set to zero by the ReLU. As shown in \eqref{nn} by the subscripts of $R$, three additional straight lines are added, line 3, 4, and 5. Fig.~\figref{keyhole-lines}-a shows an illustrative example of the keyhole shape with line 3, which connects points $\inflate{\point_l}$ and $\inflate{\point_r}$. Lines 4 and 5 were added to cope with a special keyhole configuration shown in Fig.~\figref{keyhole-lines}-b.
% \begin{align}
%     h(x)=&\alpha_1 ReLU_1 + \alpha_2 ReLU_2 + \alpha_3 ReLU_3 +\nonumber \\
%          &\alpha_4 ReLU_1ReLU_2 + \alpha_5 ReLU_1ReLU_2ReLU_3 + \nonumber \\
%          &\alpha_6 ReLU_1ReLU_4ReLU_5 + \alpha_7 ReLU_2ReLU_4ReLU_5 + \nonumber \\
%          &\alpha_8 ReLU_cReLU_1ReLU_4 + \alpha_9 ReLU_cReLU_2ReLU_4 + \nonumber \\
%          &\alpha_{10} ReLU_cReLU_1 + \alpha_{11} ReLU_cReLU_2 + \alpha_{12} ReLU_cReLU_3 + \nonumber \\
%          &\alpha_{13} ReLU_cReLU_1ReLU_2 + \alpha_{14} ReLU_cReLU_1ReLU_2ReLU_3 + \nonumber \\
%          &\alpha_{15} ReLU_c + \alpha_{16}
% \end{align}
where, $x=[\text{x}_1,\text{x}_2]^T$, $R_i=ReLU(c_i^Tx+d_i)$, $R_c=ReLU(r^2-(x-x_c)^T(x-x_c))$, $ReLU(z)=max(0,z)$, $c_i$ and $d_i$ are the coefficients for the straight lines, and $x_c$ and $r$ are the center and radius of $\infGapCirc$, respectively.

\begin{figure}[t]
  \vspace*{0.06in}
  \centering
  \scalebox{0.75}{
  \begin{tikzpicture}[inner sep=0pt,outer sep=0pt]
    \node[anchor=south west] at ($(0, 0)$)
    	{{\input{figs/keyhole-fig1}}};
  \end{tikzpicture}%
  }
  \caption{Keyhole diagram with additional virtual lines.\figlabel{keyhole-lines}}
  \vspace*{-1.5em}
\end{figure}

The synthesis process for the ZBF (i.e., training of the neural network) follows the technique presented in \cite{AA22PV}, which is a linear program (LP). The LP needs sampled sets, $\sampSet^u$ and $\sampSet^s$,
from the unsafe and safe regions, respectively. The unsafe points are sampled along the gap lines and circle edge, excluding the arc between the gap lines. The safe points are generated from the unsafe point by pushing them along the gradient inwards an $\epsilon$ distance. $\epsilon$ then should be set to a small value, e.g., 3$\%$ of the circle radius. 
The linear program for learning $\alpha_i$ and $b$ coefficients is 
\begin{equation}  \eqlabel{lp}
\begin{aligned}
    \min_{u} \quad & \vec{1}^T\alpha\\
    \text{s.t.} \quad & h(x_i)\leq -1,\, \forall i\in\set{l:x_l\in\sampSet^u}\\
                \quad & h(x_j)\geq +1,\, \forall j\in\set{l:x_l\in\sampSet^s}\\
                \quad & b\leq0,\ \alpha_k\geq 0,\, \forall k=1,\cdots,15
\end{aligned}
\end{equation}
where $\vec{1}=[1,\cdots,1]^T$ and $\alpha=[\alpha_1,\cdots,\alpha_{15}]$.
The coefficients $\alpha_i$ have a positivity constraint while the $b$ has a negativity constraint. Those constraints are needed so that the cost function acts as $L_1$ regulation, which promotes sparsity in the solution. Also, the value constant $\pm 1$ affects the scaling of the ZBF, much like for support vector machines. The synthesized {\keyhole} for the examples given in Fig.~\figref{keyhole-lines} are shown in Fig.~\figref{keyhole-levelset}.

The linear program was solved using Google OR-Tools \cite{ortools} in C++. For 2000 runs on the development  machine (Ubuntu 20.04, Intel i7-8750H CPU), the maximum, minimum, and average execution times were 1.6 ms, 0.71 ms, and 0.75 ms, respectively.

\subsubsection{{\keyhole} suitability as a CBF}
The {\keyhole} meets the requirements to be used as a CBF. It is monotonic across the boundary and differentiable everywhere in the positive region. The neural network in \eqref{nn} has no dead gradient, given that the terms are multiplicative combinations of the line and circle equations. Although due to the ReLU, the gradient may be non-smooth, it is not a problem for optimization, as subgradients can be used.

\begin{figure}[t]
    \vspace*{0.1in}
    \centering
    \begin{tikzpicture}[inner sep=0pt, outer sep=0pt]
        \node (fig_a) at (0in,0in)
        {\includegraphics[width=0.5\linewidth]{figs/keyhole_levelset2.jpg}};
        \node[anchor=west, xshift=70pt] (fig_b) at (fig_a)
        {\includegraphics[width=0.5\linewidth]{figs/keyhole_levelset5.jpg}};

        \node[anchor=north, xshift=-15pt, yshift=-80pt] at (fig_a){(a)};
        \node[anchor=north, xshift=-15pt, yshift=-80pt] at (fig_b){(b)};
    \end{tikzpicture}
    
    \caption{{\keyhole} for configurations in Fig.~\figref{keyhole-lines}. The value of the ZBF is represented by the color map, and the zero level-set of the ZBF is depicted by the yellow dashed line. The unsafe region outside the ZBF boundary has a negative value.}
    \figlabel{keyhole-levelset}
    \vspace*{-1.5em}
\end{figure}

