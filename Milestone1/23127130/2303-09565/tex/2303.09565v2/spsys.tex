% !TEX encoding = utf8
% !TeX spellcheck = en_GB
% !TeX program = pdflatex

% \documentclass[letterpaper, 10 pt, conference]{ieeeconf}


\documentclass[10pt,journal,compsoc]{IEEEtran}
% ATTENTION !
% 
% IF the print_comments toggle is true, LaTeX prints comments to the article as red text.
% If you comment with an Overleaf review, please use \comment{} command. This way, the comments will not affect the PDF unintentionally.
%
\usepackage{etoolbox}
\providetoggle{print_comments}
\settoggle{print_comments}{true}
\newcommand{\comment}[1]{\iftoggle{print_comments}{\textcolor{red}{#1 }}}
%   
%   
%\IEEEoverridecommandlockouts                              % This command is only needed if 
% you want to use the \thanks command

%\overrideIEEEmargins                                      % Needed to meet printer requirements.

\usepackage{lineno,hyperref}
\modulolinenumbers[5]

\oddsidemargin -40pt

\marginparwidth 170pt
\usepackage[]{subcaption}
\usepackage{color}
\usepackage{pdfcomment}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
%\usepackage{amsmath}
\usepackage{float}
\usepackage{multirow}
\usepackage{makecell}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{makecell}
\usepackage{rotating}
\usepackage{footmisc }
\usepackage{enumerate}

%\usepackage[shortlabels]{enumitem}
%\usepackage[english,polish]{babel}

%\usepackage{amsthm}
%
%\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]

\usepackage{xargs}
\usepackage[table,xcdraw]{xcolor}
\usepackage[colorinlistoftodos,prependcaption,textsize=tiny]{todonotes}
\usepackage{textgreek}
\newcommand{\Fig}[1]{Fig.~\ref{#1}}
\newcommand{\App}[1]{Appendix~\ref{#1}}
\input{earl-1_3-commands}
\input{spsys-stereotypes}


\def\checkmark{\tikz\fill[scale=0.4](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- cycle;} 

\usepackage{mathtools, bigstrut}
\DeclarePairedDelimiter{\set}{\{}{\}}
\DeclareMathOperator{\GL}{GL}

\newcommand{\Sec}[1]{Sec.~\ref{#1}}
\newcommand{\wdci}[1]{\textcolor{magenta}{WD: {#1}}}

\bibliographystyle{ieeetran}

%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
	\title{SPSysML: A meta-model for quantitative evaluation of Simulation-Physical Systems
	}
	%		\title{Dual-Embodied System Modeling Language for simulation-physical robot system}
	%	\title{The system model for methodical extending and modifying a~physical and simulated service robot system -- case study on TIAGo robot\\or\\the model towards comparability and integrity of customisations of robot systems with simulation
	%	 \\or\\The model for consistency maintenance between the physical and simulated controller in agent-based systems customisation.\\or\\The agent-based model for consistent development of a~robot system with simulator -- the TIAGo robot case study\\or\\A~Consistent specification and modification of a~dual-embodied robot system -- the real and simulated TIAGo robot system.
	% }
	
	%% Group authors per affiliation:
	\author{Wojciech Dudek$^{1}$, Member, IEEE, Narcis Miguel$^{2}$, Member, IEEE, Tomasz Winiarski$^{1}$, Member, IEEE
	\thanks{$^{1}$Warsaw University of Technology, Institute of Control and Computation Engineering, Poland
        {\tt\small wojciech.dudek@pw.edu.pl},\\
        {\tt\small tomasz.winiarski@pw.edu.pl}
        }
    \thanks{$^{2}$PAL Robotics, Barcelona, Spain\\
    {\tt\small narcis.miguel@pal-robotics.com}}}
	
	\maketitle
	
	\begin{abstract}

 Robotic systems are cyber-physical systems (CPS) commonly equipped with multiple sensors and effectors, making them aware of dynamic environments, e.g. surrounding humans. A multi-component structure and potential environment harming make the development of a~robotic system challenging. Recently, the simulation of CPS components has become accurate enough to enable the Digital Twin (DT) concept realisation. However, it is unclear how to employ DT in robotic system development, e.g. in-development testing. 

\textit{Goal}: We aim to improve the integration between simulated
and physical parts of CPS in various setups. The setups may include multiple DTs. As a~result, the CPS has fewer components, requiring less testing. Furthermore, the better integration, the better simulation-based testing coverage of the physical part (hardware and software). Maximising the integration between simulation and the physical system allows using simulation for, e.g. parallel and safer development, faster and safer machine learning, and swift testing of CPS.

\textit{Method}: In this work, we study the relationship between the simulated and physical parts of CPS. We propose a~Domain-Specific Language (DSL) called SPSysML (Simulation-Physical System Modeling Language). It is based on Systems Modeling Language (SysML). SPSysML defines the taxonomy of a~Simulation-Physical System (SPSys), being a~CPS consisting of at least a~physical or simulated part. In particular, the simulated ones can be DTs. We propose a~SPSys Development Procedure (SPSysDP) that enables the maximisation of the simulation-physical integrity of SPSys by evaluating the proposed quantitative factors based on SPSysML.

\textit{Result}: SPSysDP is used to develop a~complex robotic system for the INCARE project. In subsequent iterations of SPSysDP, the simulation-physical integrity of the system is improved. As a~result, the system model consists of fewer components and a~more significant fraction of the system components is shared between various system setups. We use the popular Robot Operating System (ROS) and Gazebo simulator for the implementation and testing.

\textit{Conclusion}: SPSysML with SPSysDP enables the design of SPSys (including DT and CPS), multi-setup system development featuring improved integrity between simulation and physical parts in its setups.

		% Robot systems are complex cyber-physical systems (CPS) not only in structure and behaviour, but also in development. State-of-the-art robot development procedures utilise simulation mainly for in-development testing. Thus, parts of the system migrate from a~simulated to a~physical embodiment during development. The popular digital twin (DT) concept confronts the simulated and the physical embodiments of a~system for their behaviour analysis. We present a~concept of a dual-embodied system (DES) interacting with simulated and physical worlds. The concept concerns CPS involving simulation either during development or exploitation. In this work we study the relationship between the embodiments in robot systems and propose a Domain Specification Language that we refer to as DEMoL and its application procedure constituting the DES development procedure. Both language and application procedure allow the optimisation of inter-embodiment integrity of DES. The resulted structure is used in the implementation and testing phases, thus, enabling i.a. formal test cases specification. We propose three DEMoL-based criteria for DES structure integrity optimisation. DEMoL and its application procedure are verified on a~complex robot system developed for a European Commission-funded project. 
	\end{abstract}
	

	\section{Introduction}
	\label{sec:intro}
	%
	% Poniżej propozycja rozszerzenia litaratury
	%
	%\wdci{Ewentualnie dodatkowo można się odwołać do: \url{https://ieeexplore.ieee.org/abstract/document/9186155} oraz \cite{doi:10.1504/IJPD.2013.052166}}
	
Simulation is widely used in state-of-the-art development procedures for cyber-physical systems (CPS). Recent papers refer to Model-in-the-loop (MIL) \cite{10.1243/09596518JSCE207}, Software-in-the-loop (SIL) \cite{4455268}, Hardware-in-the-loop (HIL) \cite{10.1007/978-3-319-74793-4_10} and Rapid Control Prototyping (RCP) \cite{Abel2006} techniques. They are used selectively or are composed in sequence, e.g. verification steps in various development procedures. Each of the techniques requires a simulation of the system parts. Some systems utilise the Digital Twin (DT) \cite{9529662, PYLIANIDIS2021105942} concept. They employ an accurate simulation of a system part for, e.g.:
	\begin{itemize}
		\item Swapping a malfunctioned system part with the simulated one DT that mirrors the part's functionality in the simulated world,
		\item Energy consumption analysis,
		\item System failure analysis and prediction,
		\item Technology integration,
		\item Real-time monitoring.
	\end{itemize}
Some parts (software and hardware) of such a system interact with the real world while other parts with the simulated world. The set of the parts used in the real world we call physical embodiment, and the set of the parts used in the simulated world we call simulated embodiment. The Digital Twin is a~part of the simulated embodiment mirroring a~part of the physical embodiment. DT concept is used in numerous domains and applications~\cite{NEGRI2017939}. They are systematically analysed by the authors of~\cite{dalibor2022cross}.

	Robots comprise multiple devices and their controllers. In particular, autonomous mobile robots require a~complex navigation system that features multiple closed control loops, e.g. drive controllers, trajectory controllers, and Simultaneous Localisation and Mapping (SLAM). Furthermore, the navigation system and the rest of the robot's functionality are used to execute the user request (like object transportation). In some cases, only a~fraction of such a~complex system must have DTs. In other cases, if the robot system has only the simulated embodiment, it is a~demonstrator of the future product. 
 
 To clear up the taxonomy of systems featuring simulated and physical parts, we introduce the Simulation-Physical System (SPSys) concept~(\Fig{fig:concept}). This kind of system consists of at least one physical/simulated embodiment and a~shared controller. If it has both embodiments, a~simulated part can be a~DT of a~physical part. If it has only the physical embodiment, it is a~CPS, and if it has only the simulated embodiment, it is a~simulator. 
	\begin{figure}[t]
    	\centering
		\includegraphics[width=0.8\linewidth]{./figures/concept-2}
		\caption{The idea of Simulation-Physical System}
		\label{fig:concept}
	\end{figure}
 
In the development process, the system parts evolve from simulated mockups to the physical parts and the software deployed on the hardware. The system development procedure must guide the project team through the process. The system design created as a~milestone in the procedure must specify all required parts in all development stages and compose them in the testing and deployment setups. Developing reliable systems, especially complex ones like robot systems, requires comprehensive unit and integration testing. Some CPS parts can be tested with simulated hardware only; therefore, additional parts that do not comprise the operational system are required (e.g. human simulator in a~social robot case). Comprehensive testing is complex in test case specification and time-consuming in test implementation and execution. From this perspective, software reusability is a~key to fast development of complex, reliable systems.

We aim to:
\begin{itemize}
    \item Specify profiled-based requirements of Simulation-Physical Systems including multiple Digital Twins,
    \item Re-use of software between DT and its Physical Twin (PT) and between different system setups, improving system's reliability and resulting in more accessible and faster testing, 
    \item The integrity boost between simulation and physical embodiments of SPSys enabling a~comprehensive and parallel simulation-based testing of the system parts,
    \item Reflection of the dynamic environment in simulation to enable Digital Twins to observe exogenous actions.
\end{itemize}
To reach these goals, we propose a~Domain-Specific Language (DSL) named Simulation-Physical System Modeling Language (SPSysML). SPSysML models the requirements and the SPSys, in particular, SPSys consisting of simulated parts (used either in the system development or in the operational setup as DT/simulator). Based on SPSysML, we propose a~requirement-based SPSys composition method. To measure the inter-embodiment integrity of the system, we propose quantitative optimisation factors for SPSys designs. The factors are used in the proposed SPSys Development Procedure (SPSysDP)~(\Fig{fig:concept-procedure}) to maximise the shared controller, minimise the system parts number and improve simulation-physical integrity.
% \wdci{Dodać tezy/pytania badawcze, które potwierdzimy w podsumowaniu: 
% \begin{itemize}
%     \item SPSysML definiuje koncepty opisujące systemy posiagające części symulowane, fizyczne oraz relacje między nimi, w szczególności relacja mirror między Digital Twin i jego Fizycznym odpowiednikiem.
%     \item Należy opracować model system, który zawieraja DT i działa w dynamicznym środowisku, które jest zmieniane nie tylko przez sam system, ale też przez niesterowalne przez system agenty.
%     \item Można zdefiniować ilościowe współczynniki oceny projektu SPSys i na ich podstawie optymalizować ten projekt. 
% \end{itemize}}
Our goal originates from the conclusion of \cite{LO2021101297}: \textit{The digital models are mainly used to examine product performance(...). However, how to optimise the use of those models to enhance the design process and design collaboration is still needed to be investigated.}

 	\begin{figure}[htb]\centering
		\includegraphics[width=\linewidth]{./figures/concept-procedure-2}
		\caption{The concept of DES development procedure}
		\label{fig:concept-procedure}
	\end{figure}

SPSysML comprises a~componet-based Platform Independent Model (PIM), thus, can be applied to any SPSys. The result of SPSysDP is an implemented and tested Platform Specific Model (PSM) that can be launched in the specified setups. PSM implementation utilises platform-specific tools and software libraries. Therefore, to verify our approach, we design, implement, test and deploy a~specific SPSys, including the TIAGo service robot~\cite{PMF16} for the INCARE (Integrated Solution for Innovative Elderly Care) project. The robot features an extended voice interface and additional devices to~serve the elderly, e.g. in object transportation (\Fig{fig:tiago-transport}) and fall assistance (\Fig{fig:tiago-fall}). The resulting system utilises component-based frameworks like \emph{ROS}~\cite{quigley2009ros,doi:10.1126/scirobotics.abm6074}, \emph{OROCOS}~\cite{bruyninckx2001open}, \emph{Gazebo}~\cite{koenig2004design} (in particular \emph{gazebo\_ros\_control} package~\cite{gazebo-ros-control}) that are a~standard in robotics. Thanks to the description of the SPSysDP execution in the robotics domain, we present an example of DT implementation in robotic systems. To make the SPSys development easier for the community, we share the SysML profiles, the SPSysML meta-model and the example INCARE system model\footnote{\url{https://github.com/RCPRG-ros-pkg/spsysml}}.

 In this article, we describe related work concerning mixing simulation-physical setups and meta-models for CPS (\Sec{sec:related-work}) and state our work's novelty and its result regarding the related works (\Sec{sec:novelty}). Subsequently, we define SPSys requirements model in~\Sec{sec:requirement-model}, the meta-model in \Sec{sec:pl-structure} and its application procedure in \Sec{sec:customisation-procedure}. Next, we analyse the proposed evaluation factors of SPSys design and describe features of the systems that evaluation ends with edge case values of the factors in \Sec{sec:evaluation-factors-analysis}. Finally, we verify our method in complex SPSys development for the INCARE project (Sec.~\ref{sec:example-system}). 
 % Although the example specifies the system, including the TIAGo robot, the presented meta-model and procedure apply to any Simulation-Physical System. SPSysML is a platform-independent model (PIM) that, in contrast to platform-specific models (PSM), abstracts from a specific hardware or software implementation. However, the proposed development procedure results in a model transformable to PSM with ease. We demonstrate the SPSysML application and procedure on INCARE project use cases and transform the result (PIM) into a system employing the TIAGo robot. 
This work is concluded in~\ref{sec:summary}.
	
	\begin{figure}\centering
		\begin{subfigure}{0.3\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./figures/tiago-transport}
			\caption{Transport task}
			\label{fig:tiago-transport}
		\end{subfigure}
		\begin{subfigure}{0.54\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./figures/tiago-fall}
			\caption{Fall assistance task}
			\label{fig:tiago-fall}
		\end{subfigure}
		\caption{TIAGo robot in INCARE tasks execution}
		\label{fig:tiago-tasks}
	\end{figure}

 
 \begin{table*}[h!]{
			\begin{center}
				
			\caption{Related works comparison with this work}\label{tab:related-work}\footnotesize
			\begin{tabular}{|l|c|c|c|c|c|c|c|c|c|c|c|}
				\hline
				\makecell{System \\development\\ method}&\makecell{EM}&\makecell{EIV}&\makecell{Formal \\meta-model}&\makecell{SCP}&\makecell{SO}&\makecell{Execution\\setups}&\makecell
				{DE}&\makecell{E}&\makecell{QE}&\makecell{MDT}&\makecell{Purpose}\\ \hline
				%CPS
				%\multicolumn{7}{c}{A survey on cyber-physical system development}\\\hline
				\makecell[l]{Digital\\Mockup \cite{5952295}}&I&-&-&ES&-&\makecell{Static\\structure}&\checkmark&-&-&-&\makecell{RT simulation\\for HIL  testing}\\\hline
				%DT
				%\multicolumn{7}{c}{A survey on digital twin development\cite{LO2021101297}}\\\hline \makecell[l]{ DT for\\ind. 4.0\\\cite{9247401}}&M&-&\makecell{SysML}&General&-&n/d&\checkmark&-&\makecell{Generic\\model\\of DT}\\\hline
				\makecell[l]{C2PS\cite{7829368}}&M&-&\makecell{Own\\meta-model}&\makecell{Formal \\and detailed}&\makecell{BS}&\makecell{Adaptive}&\checkmark&-&-&N/D&\makecell{Digital Twin\\in the cloud}\\\hline
				%\cite{9529662}&&&&&&&&\\\hline
				%\cite{PYLIANIDIS2021105942}&&&&&&&&\\\hline
				\cite{8822494}&M&\checkmark&\makecell{Dolev-Yao \\\cite{1056650}}&\makecell{Formal \\and detailed}&-&\makecell{Static\\structure}&\checkmark&-&-&\checkmark&\makecell{Cyber-security,\\physical-digital twin\\ synchronisation}\\\hline
				% ROBOT
				%\multicolumn{7}{c}{Robotics}\\\hline
				\makecell{DEVSRT \cite{MOALLEMI2013115}}&I&-&\makecell{DEVS \cite{zeigler2000theory}}&General&-&\makecell{Static\\structure}&-&-&-&-&\makecell{Simulation to embedded \\continuous development}\\\hline
				aRD\cite{4058987}&M&-&-&General&-&\checkmark&\checkmark&-&-&-&\makecell{RT \& NonRT \\parts integration}\\\hline
				\makecell[l]{HMLF \cite{ElShamoutyKleebergerLammleHuber}}&I&-&-&ES&-&\makecell{Static\\structure}&-&-&-&-&\makecell{Simulation-driven ML} \\\hline
    
				\makecell{RSHPN \cite{FigatZielinski-HPNmetamodel:2022}}&M&-&\makecell{RSHPN}&\makecell{ES}&-&\makecell{Single\\structure}&\checkmark&-&-&-&\makecell{Deadlocks verification,\\automated code generation}\\\hline
				
    SPSysML&M&\checkmark&SysML&\makecell{Formal \\and detailed}&\makecell{SPO}&\checkmark&\checkmark&\checkmark&\checkmark&\checkmark&\makecell{Structure optimisation for\\Simulation-Physical Systems}\\\hline
				
			\end{tabular}
		\end{center}
		}{\vskip 0.1cm\footnotesize \raggedright
			EM -- {Embodiment modularity},
			EIV -- {Embodiment integrity verification},
			SCP -- {System creation procedure},
			SO -- {Structure optimisation},
			DE -- {If the system execution configuration can contain parts of both embodiments},
			E -- {If uncontrolled agents of the physical environment can be modelled in simulation},
			QE -- {If quantitative evaluation factors for system design are proposed},
			MDT -- {If a~multi Digital Twin system model is presented}, 
			I~-- {Integrated system},
			ES -- {Example system as the method application procedure},
			M -- {System decomposable to multiple simulation/physical parts},
			n/d -- {No data},
			BS -- The best selection from the previously designed,
			SPO -- Simulated-Physical design optimisation,
   N/D -- Possible, however, not defined,
			%\twci{Może pierwszy wiersz tabeli w pionie i tam dłuższe opisy?}
		}
	\end{table*}
	\section{Related work}
	\label{sec:related-work}

 \subsection{Mixing simulation-physical setups}
 In \cite{4058987}, the authors note the complexity of robotic systems and that the system components are often developed simultaneously by heterogeneous teams of researchers and developers. The authors suggest a demand for system simulation enabling rapid prototyping and an iterative development process. They propose the so-called agile Robot Development (aRD) concept that facilitates the integration of the hard real-time part and the non-real-time part of the system utilising a~Matlab/Simulink toolchain. 
	% They present different HIL setups organised with the aRD concept for testing robot system parts. 
    The sim2real problem is known and mentioned in the recent research results, e.g. in the domain of self-driving cars \cite{9869302}. However, to our knowledge, none of the existing works specifies a flexible robotic system meta-model that defines mixed simulation-physical setups of CPS under development.
	
	Agile development implements the idea of rapid prototyping via, e.g. unit testing~\cite{10.1007/978-3-319-11900-7_22, 10.1007/978-3-540-70945-9_10}. These development strategies are often used in the domain of robotics. However, the tests evaluate just one specified simulation-physical setup of the system. Still, during development, almost every part of the system evolves from mockup (realised in simulation) to deployable software or hardware. Continuous integration is a~valuable tool to manage the system implementation \cite{MOSSIGE2015169}.

There are reviews on CPS \cite{6853346} and DT \cite{LO2021101297} development. The CPS-related works focus on controlling a~physical object and its model in a~simulation environment with partially or fully simulated hardware. For example, the authors of \cite{8822494} use the DT approach to run the digital embodiment in a~safe virtual machine and confront the physical and digital embodiments to spot anomalies caused by a~cyber-attack. Another work \cite{ElShamoutyKleebergerLammleHuber} employs simulation-driven machine learning for robots. 


 
\subsection{Meta-models for CPS}
In the development process, a~language is required to plan, conceptualise, and specify the system. Currently, the state-of-the-art approach is a model-based approach utilising a DSL. Unified Modeling Language (UML) is the most known language; however, System Modeling Language (SysML)~\cite{wolny2020thirteen}  is proposed by the Object Management Group (OMG) to support the design, analysis, and verification of complex systems comprising software and hardware components. There are different Model Driven Engineering approaches in the robotics domain~\cite{de2021survey}. For instance, Embodied Agent-Based cybeR-physical control systems modelling Language (EARL) \cite{earl2020} is SysML specialisation for robotics which allows analysis and specification of the robotic system properties. It is based on the Embodied Agent approach~\cite{Zielinski-KAiR-eng:2021}. The approach shapes the robotic system structure and inter-component communication by defining SPSys-related artefacts, component classes and their constraints. Other DSLs support verification and testing of, e.g. industry 4.0 plants \cite{8369563},  or agent-based computational systems \cite{FORTINO2012608}). Besides, the work \cite{DELAVARA201616} describes the specification of safety compliance needs for critical computer-based and software-intensive systems. 
Confrontation of SPSysML with related models and specification methods is presented in Tab.~\ref{tab:related-work}.
The related models focus on different purposes of Simulation-Physical Systems. Two of the works regard interaction between the DTs and PTs -- C2PS~\cite{7829368}, \cite{8822494}, three focus on simulation-based development of CPS -- Digital Mockup~\cite{5952295}, DEVSRT~\cite{MOALLEMI2013115} and aRD~\cite{4058987}, and the last one -- HMLF~\cite{ElShamoutyKleebergerLammleHuber} utilises DT concept in machine learning. The authors of RSHPN \cite{FigatZielinski-HPNmetamodel:2022} propose a meta-model to verify the lack of deadlocks in multi-component SPSys using Hierarchical Petri Nets. The nets are generated from a~DSL-based specification, and the code associated with the robot controller structure and communication is generated.

\section{The work novelty and result}
\label{sec:novelty}
None of the models presented in \Sec{sec:related-work} specifies SPSys in general, especially including a~physical part without a~Digital Twin, simulated parts without a~PT, or hybrid SPSys including Twins and non-Twin components. The key novel features delivered by SPSysML and SPSysDP are:
\begin{itemize}
    \item Integrity evaluation with quantitative factors,
    \item SysML-based structure model and system development procedure,
    \item System design optimisation considering simulation and physical embodiments of the system,
    \item Multiple system execution and testing setups specification,
    \item Forcing simulation-based testing prior to physical embodiment development, 
    \item Specification of Simulation-Physical System including multiple physical and simulated parts and multiple Digital Twins,
    \item Reflection of the dynamic environment in simulation to enable Digital Twins to observe exogenous actions.
\end{itemize}

Based on our experience in SPSys development (TIAGo robot \cite{Dudek:2021_phd-twiki}, Velma robot \cite{en14206693}, IRP6 robot\footnote{\scriptsize Real: \url{https://youtu.be/wJpFcy99Gh0}, Simulation: \url{https://youtu.be/BjwcbSdouHw}}) and the literature analysis, we propose the SPSys Development Procedure focused on simulation-based testing coverage and software integrity between the system embodiments maximisation. Complex system structuring is a broad topic with solutions utilising various methods and strategies, e.g. top-down and bottom-up. In \cite{en15217983}, we describe a~binary communication-focused top-down approach for robotic systems. In this article, we propose a~requirement-based top-down method customised for SPSys. 
	% \section{The features of the proposed method}
	% \label{sec:requirements}
	
	% Simulation is often the first step of testing a~Robot Control System or a~robot application~\cite{staranowicz2011survey}. However, typically the end goal is to deploy the system to physical machines. Therefore, portability between the simulated and the physical embodiment needs to be easy, as composite as possible, and the behaviour of the simulated and the physical systems needs to be congruent~\cite{michel1998webots}. It is worth noting that congruence, in this case, does not always mean identity because the simulated world may be a~simplified model of the physical one. State-of-the-art works distinguish development phases, including HIL and SIL. As a~result the parts of the system in development are distributed between simulation and physical platforms. Such a~hybrid configuration requires a~careful migration process of the system parts between the embodiments. Therefore, the meta-model for SPSys must be flexible in changing embodiments of the system parts and must constrain the system parts to be congruent between the embodiments. Some parts may be deployed either in physical or simulated embodiments, but some may be deployed in both embodiments. Therefore, based on our experience in SPSys development (TIAGo robot \cite{Dudek:2021_phd-twiki}, Velma robot \cite{en14206693}, IRP6 robot\footnote{\scriptsize Real: \url{https://youtu.be/wJpFcy99Gh0}, Simulation: \url{https://youtu.be/BjwcbSdouHw}}) and the literature review we state that SPSys specification method needs to:
	% \begin{itemize}
	% 	\item be easy for the system components modification and migration between the embodiments,
	% 	\item define types of SPSys parts and their relationships,
	% 	\item define constraints for the deployment of the system and its parts, 
	% 	\item enable quantitative evaluation of the system design,
 %        \item enable multiple setups of the system (including pure simulation, pure physical, and various hybrid),
	% 	\item define a~procedure for SPSys design and development,
	% 	\item enable widely-used simulation-based verification techniques like HIL, SIL, and MIL.
	% \end{itemize}

 %    Various specialists focus on specific problems and contribute to robot control software worldwide. Therefore, it is beneficial for one specialist to use the components already created by others. Reusing software supports the creation of reliable software in a shorter time~{\cite{luckcuck2019formal}}. SPSysML is PIM, thus it applies to component-based frameworks like \emph{ROS}, \emph{OROCOS}, \emph{Gazebo} (in particular \emph{gazebo\_ros\_control} package \cite{gazebo-ros-control}) and has the above features. 


 
	\section{Simulation-Physical System}
 Simulation-Physical System specification is based on SysML and EARL.
	In the following sections, we describe SPSysML and SPSysDP. SPSysML defines stereotype-based meta-models of requirements and structure. Description of a~meta-model requires a~notation for multiple blocks or instances of a~stereotype (e.g. two instances of \stA{}). For this purpose, we append the stereotype with \textit{s}~(e.g. \stA{}\textit{s}). We refer to an instance of a stereotype using the \Part{part-name}{\textit{<<stereotype>>}} symbol.

 \subsection{SPSysML -- requirements meta-model for SPSys}
	\label{sec:requirement-model}
	
	
We define a~stereotype-based model of requirements (\Fig{fig:requirement-model}). The stereotypes explicate SysML requirement diagrams used for designing SPSys with SPSysML.

	\begin{figure}\centering
		\includegraphics[width=\linewidth]{./schemes/profile/requirement_stereotypes_generalisation_cd.png}
		\caption{Model of system requirements defined for SPSys}
		\label{fig:requirement-model}
	\end{figure}

 SPSysML specifies the requirements model as~SysML profile. The requirements can be defined based on various premises. In particular, they can derive from user requirements \cite{dos2008model}. The SPSysML profile defines structural, functional, configurational and environment requirements. Auxiliary sequence diagrams presenting the concept of the system behaviour and use case diagrams are useful for requirements definition. Before SPSys requirements specification, its environment must be analysed. Therefore, in SPSysML, we distinguish Environment requirements. They can be of various stereotypes.  In this article, we focus on \stEAR{} that describe exogenous agents interacting with the world alongside the system. In SPSysML, the system is decomposed into parts based on \stREQ{SysPartReq}\textit{s}. Each \stREQ{SysPartReq} is classified to elementary \stREQ{HardwareReq} or more general \stREQ{PhyPartReq}, \stREQ{SimPartReq} or \stREQ{SimPhyPartReq}. \stREQ{PhyPartReq} determines a~part interacting only with the Physical World (even during the system development, e.g. during parallel development of the dependent parts), and its simulated embodiment is not required (or cannot be created) during the system development. \stREQ{SimPartReq} specifies a~part interacting only with the Simulated World (e.g. mock-ups or demonstrators).  \stREQ{SimPhyPartReq} interacts with both Worlds (e.g. realised with a~pair of DT and PT).
	\stREQ{HardwareReq}\textit{s} are in a~\textit{satisfy} relationship with \stFR{}\textit{s}. This means hardware requirements specified with a~\stREQ{HardwareReq} enable the realisation of the functionality specified with the given \stFR{}. The configurational stereotypes specify if a~system part is obligatory to launch in any of its configurations (\stREQ{ObligatoryReq}) or if it is not (\stREQ{OptionalReq}). 



	\subsection{SPSysML -- structure meta-model for SPSys}
 \label{sec:pl-structure}
	SPSysML derives from EARL \cite{earl2020} version 1.3~\cite{earl-1.3}. We use a~Group of Subsystems (\stGpS{}) to gather Subsystems with a~specific common properties, and a~Group of Agents (\stGpA{}) to organise the Agents (composed of Subsystems) cooperating for a~defined aim in the system. In a~SPSys we differentiate three specific Agent stereotypes that derive from \stA{} defined in EARL (\Fig{fig:dual_embodied_system_bdd}):
	\begin{itemize}
		\item \textit{Physical Agent} (\stPA{}) -- Runs only in the physical embodiment (in particular Agent interacting with or sensing real world),
		\item \textit{Simulation Agent} (\stSA{}) -- Runs only in the simulated embodiment (in particular Agent interacting with or sensing simulated world),
		\item \textit{Hybrid Agent} (\stHA{}) -- Runs in both embodiments with neither interaction nor perception of any world.
	\end{itemize} 
	
	\begin{figure}\centering
		\includegraphics[width=\linewidth]{./schemes/spsys/dual_embodied_system_bdd.png}
		\caption{Simulation-Physical System composition}
		\label{fig:dual_embodied_system_bdd}
	\end{figure}
	
	
	The Groups of Agents called \textit{World Mirror Group of Agents} aggregate \stSA{}\textit{s} that are Digital Twins of the Agents in the Physical World that are not under the control of the system and execute exogenous actions in the Simulated World. Groups of this type exist if the system works in a~dynamic environment (e.g. an environment with human inhabitants). For example, a~\textit{World Mirror Group of Agents} modifies the Simulated World as humans do in the Physical World. 
\subsubsection{Digital Twins in SPSys}
Integrity between SPSys embodiments is crucial. Therefore, the existence of DT of physical parts is advisable and common. We define the \texttt{mirror} relationship between \stPA{} and \stSA{} to model the relationship between DT and its PT. To enable multi-agent DT for a~single \stPA{} or single-agent DT for multi-agent PT, we introduce \stMPGA{} and \stMSGA{}. They aggregate Agents of different stereotypes (\Fig{fig:msga_mpga_bdd}).

	\begin{figure}\centering
		\includegraphics[width=\linewidth]{./schemes/spsys/msga_mpga_bdd.png}
		\caption{SPSys composed of 0...* Digital Twins (+dt) and Physical Twins (+pt) realised with \stMSGA{} and \stMPGA{} accordingly}
		\label{fig:msga_mpga_bdd}
	\end{figure}
	
	The definition of the \texttt{mirror} relationship is as follows:
	
	\begin{definition}[Mirror relationship]
		{\it Two Groups of Agents are said to be in a {\rm mirror relationship} if their input buffers and goals are the same and affect Simulated and Real Worlds congruently. The relationship is an association between Digital and Physical Twins.}
	\end{definition}
It is worth noting that the same stimuli of the mirroring Groups cause corresponding reactions in specific worlds, in the Simulated World for \textit{Mirror Simulation Group of Agents} and in the Physical World for {\textit{Mirror Physical Group of Agents}}. The particular reaction results from the requirements of the specific system and does not need to be identical within the embodiments. The mirror relationship does not propagate automatically to all the Agents aggregated in the mirroring Groups, so agents from \stMSGA{} does not mirror all agents of mirroring \stMPGA{} and vice versa.
	
The amount of mirroring Agents should be maximised to maximise coverage of simulation-based testing and profits of DT. Additionally, the complexity and quantity of mirroring Agent Subsystems should be minimised to boost the modularity and integrity of the system. Otherwise, the system could be composed of just two mirroring agents. If a~computational functionality is required in both embodiments, a~\stHA{} should be designed for this purpose.

	\subsubsection{Subsystem types}\label{sect:subsystem_types}	The Agents are built with Subsystems of different types based on EARL. In EARL the central computational part of an Agent is the Control Subsystem \stCS{}. An Agent communicates with other Agents using communication buffers of its \stCS{}. To percept the environment, an Agent uses Real Receptors (\stRR{}\textit{s}), and to aggregate and preprocess stimuli, it uses Virtual Receptors (\stVR{}\textit{s}). To affect the environment, an Agent uses Real Effectors (\stRE{}\textit{s}). To preprocess \stCS{} commands to signals for \stRE{}\textit{s} it uses Virtual Effectors (\stVE{}\textit{s}). 
	SPSys interacts with both the simulated and physical world; thus, SPSysML differentiates between the types of the above Subsystems--- Simulated, Physical, and Simulated-Physical.
	To achieve maximum integrity between the simulated and physical embodiments, all \stCS{}\textit{s} should be Simulated-Physical (\stDCS{} stereotype) and constitute the general concept of the shared controller, recall~\Fig{fig:concept}. For iterating design purposes, embodiment-specific Control Subsystems concepts (\stPCS{} and \stSCS{}) may be helpful. The other Subsystems can be Simulated or Physical. 
 SPSysML defines \stGpS{}\textit{s} that aggregate receptors and effectors considering their embodiment and the world they interact with (\Fig{fig:hardware_group_bdd},
 \Fig{fig:drivers_group_bdd}).
 As one \stDCS{} can communicate with multiple Simulated/Physical Virtual Receptors and Effectors, we define four\stGpS{}\textit{s} aggregating Physical/Simulated Virtual/Real Subsystems. The data flow and communication links for \stDCS{} interacting with Simulated and Physical Worlds is shown in (\Fig{fig:inter-subsystem-interfaces}).
	
 \begin{figure}
     \centering
     \includegraphics[width=\linewidth]{schemes/spsys/hardware_group_bdd.png}
     \caption{Embodiments of Real Effectors and Receptors}
     \label{fig:hardware_group_bdd}
 \end{figure}
 \begin{figure}
     \centering
     \includegraphics[width=0.8\linewidth]{schemes/spsys/drivers_group_bdd.png}
     \caption{Embodiments of Virtual Effectors and Receptors}
     \label{fig:drivers_group_bdd}
 \end{figure}
 
    \begin{figure}\centering
        \includegraphics[width=.9\linewidth]{./figures/ibd-subsystems.pdf}
        \caption{Interfaces between Subsystem Groups on example, where two agents share \stDCS{}}
        \label{fig:inter-subsystem-interfaces}
    \end{figure}
	
 
 
	% \begin{itemize}
	% 	\item \textit{Physical Drivers} \stGpS{} -- compose all \textit{Physical Virtual Receptor} and \textit{Physical Virtual Effector},
	% 	\item \textit{Physical Hardware} \stGpS{} -- compose all \textit{Physical Real Receptor} and \textit{Physical Real Effector} and affect/sense the Physical World,
	% 	\item \textit{Simulated Drivers} \stGpS{} -- compose all \textit{Simulated Virtual Receptor} and \textit{Simulated Virtual Effector},
	% 	\item \textit{Simulated Hardware} \stGpS{} -- compose all \textit{Simulated Real Receptor} and \textit{Simulated Real Effector} and affect/sense the Simulated World,
	% \end{itemize} 
\subsubsection{Realisation of the Subsystem and Agent types}
 Subsystems in a~\stPHGS{} expose interface realised with a communication interface controller used by the effector or sensor (e.g. Linux kernel driver for Inter-Integrated Circuit (I$^2$C) or network interface card). To these interfaces \stPDGS{}\textit{s} are connected and they expose an embodiment-abstract interface for a~\stCS{} of the Agent. Subsystems in \stSHGS{} expose interfaces realised with objects of an interface class defined for the utilised simulation environment (e.g. gazebo::ModelPlugin for \stSRE{} and gazebo::SensorPlugin for \stSRR{} in Gazebo\footnote{popular simulation environment for robots}). \stSDGS{} connects to these interfaces and exposes embodiment-abstract interface for \stCS{}\textit{s}. The interaction between the groups is shown in \Fig{fig:inter-subsystem-interfaces}.
	
	Each Agent type defined in SPSysML aggregates a~particular number of Subsystems of a~specific type~(\Fig{fig:agent_bdd}).
	
	\begin{figure}\centering
		\begin{subfigure}[]{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/spsys/physical_agent_bdd.png}
			\caption{Physical Agent}
			\label{fig:physical_agent_bdd}
		\end{subfigure}
		\begin{subfigure}[]{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/spsys/simulation_agent_bdd.png}
			\caption{Simulation Agent}
			\label{fig:simulation_agent_bdd}
		\end{subfigure}
		\begin{subfigure}[]{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/spsys/hybrid_agent_bdd.png}
			\caption{Hybrid Agent}
			\label{fig:hybrid_agent_bdd}
		\end{subfigure}
		\caption{Subsystems aggregated by Agent classes}
		\label{fig:agent_bdd}
	\end{figure}
	
	It should be noted that the Basic EARL meta-model defines only one \stCS{} in an Agent, and inter-agent communication is handled only by the \stCS{}. In SPSysML, we differentiate between specific types of \stCS{} for the embodiments; still, an Agent can aggregate just one specialisation of \stCS{}. 
 % Communication between the Subsystems of different Agent instances is separated, e.g. by the Agent's individual namespace prefix.
 SPSys can be deployed in various setups (e.g. testing setups). The setups are a~Group of Agents fulfilling the system's functionality in the setup. For the system setup definition, we use \stSSGA{} to specify the Group of Agents working in the setup. The specific \stSSGA{} is derived from the system's requirements and test scenarios. This problem is considered in the SPSysDP section~(\Sec{sec:customisation-procedure}).
	
	
	\subsection{Simulation-Physical System Development Procedure (SPSysDP)}
	\label{sec:customisation-procedure}
	SPSysML defines system parts and the relations between them to enable  SPSys specification. Various agent-based system development procedures can be used for SPSysML-based systems; however, we define one that enables inter-embodiment integrity optimisation for SPSys (\Fig{fig:demol-procedure}). The main activities of the procedure can be executed in different development approaches, traditional, agile, or hybrid. In agile and hybrid approaches, the system is specified and implemented partially in an iterative manner. In the procedure shown in \Fig{fig:demol-procedure}, there are four decision nodes D1, D2, D3, and D4. The exact development procedure results from the logic predicates set to these nodes. D1 checks if the requirements of the considered system part are comprehensive and if the system parts and functions, considering the system's test scenarios, are expressed in the requirement diagrams. D2 checks if the structure evaluation is satisfactory. D3 checks whether any detailed analysis or requirements modification is required based on the design iteration, and D4 checks if the required \stSSGA{}\textit{s} are implemented and tested successfully. If needed, the procedure enables complete reiteration from the design stage. 

\def\szer1{0.79\linewidth}
 
	\begin{figure}\centering
		\begin{subfigure}{\szer1}\centering
			\includegraphics[width=\linewidth]{./schemes/spsys/development_procedure_general_act}
			%			\includegraphics[width=\linewidth]{./figures/main-procedure-scheme}
		\end{subfigure}
		
		\begin{subfigure}{\szer1}\centering
			\includegraphics[width=\linewidth]{./schemes/spsys/planning_act}
			%	\includegraphics[width=\linewidth]{./figures/procedure-planning-scheme}
		\end{subfigure}
		
		\begin{subfigure}{\szer1}\centering
			\includegraphics[width=\linewidth]{./schemes/spsys/design_act}
			%	\includegraphics[width=\linewidth]{./figures/procedure-design-scheme}
		\end{subfigure}
		
		\begin{subfigure}{\szer1}\centering
			\includegraphics[width=\linewidth]{./schemes/spsys/implementing_act}
			%\includegraphics[width=1.2\linewidth]{./figures/procedure-implementing-scheme}
		\end{subfigure}
		
		\caption{SPSys Development Procedure for Simulation-Physical Systems}
		\label{fig:demol-procedure}
	\end{figure}
  $\,$\\ %This is just a line change
  
	\noindent\textbf{System planning and analysis}
	\begin{itemize}
		\item \textbf{Step 1} (Requirement specification): The requirements are specified following the model defined in \Sec{sec:requirement-model}. It is recommended to define system use cases and typical interactions between system parts on sequence diagrams while specifying the requirements.
		\item \textbf{Step 2} (Requirement analysis): Analysis of the requirements considering the project stakeholders' demands and the system's test scenarios. In case it is needed, modifications to these requirements are made.
	\end{itemize}
	\noindent\textbf{System design}
	\begin{itemize}
		
		\item \textbf{Step 3} (World Synchronization): This step is not applicable if the system works in a~static environment (there are no exogenous actions of any non-system agent executed on the system's environment). In other cases, simulation of external agents (e.g. humans) is required, and it is done by \Part{WorldSync}{\stWMGA{}}. Each \stSA{} composed in \stWMGA{} manages one \stEAR{} specified in Steps 1-2. The key design aspects for the \stSA{}s are the Simulated World model perceived by the SPSys' receptors and the actions affecting this World. To model humans as \stSA{}, we propose our framework Human Behaviour in Robotics Research (HuBeRo)~\cite{hubero}. It specifies and implements agents mirroring human behaviours and their physical models in simulation~(\Fig{fig:hubero-model}).
  \begin{figure}
      \centering
      \includegraphics[width=\columnwidth]{schemes/incare/human_and_robot_system_bdd.png}
      \caption{Agent types of HuBeRo framework~\cite{hubero} used in SPSys as \stWMGA{} that mirrors humans in Simulated World.}
      \label{fig:hubero-model}
  \end{figure}
		\item \textbf{Step 4} (System decomposition): The system is decomposed into Agents systematically, based on the parts in the requirements. For each \stREQ{PhyPartReq} and \stREQ{SimPartReq} a~\Part{\texttt{part}}{\stPA{}} or \Part{\texttt{part}}{\stSA{}} are created. Each \stREQ{SimPhyPartReq} that has only \stREQ{ComputationalFunReq} becomes \Part{\texttt{part}}{\stHA{}}. The other \stREQ{SimPhyPartReq}\textit{s} become pairs of DT/PT, thus, are realised with a~pair of mirroring \Part{\texttt{part}}{\stMPGA{}} and \Part{\texttt{part}}{\stMSGA{}} (\Fig{fig:decomposition-concept}),
		
		
		\item \textbf{Step 5} (DT/PT decomposition -- Mirroring Agent Groups specification): Each mirroring \Part{\texttt{part}}{\stMPGA{}} and \Part{\texttt{part}}{\stMSGA{}} is iteratively decomposed to more groups to finally reach mirroring groups that each can be realised with a~single \stPA{} or \stSA{}. Each result of the decomposition iteration represents a~layer of the initial Group. The \texttt{mirror} relationship is set between \stMSGA{} and \textit{\stMPGA{}} and is specified in each layer of the decomposition. The decomposition scheme is shown in \Fig{fig:decomposition-concept}.
  \begin{figure}
      \centering
      \includegraphics[width=\linewidth]{figures/decomposition-scheme.pdf}
      \caption{Requirement-based SPSys decomposition, where \texttt{mirror} relationship constituting Physical and Digital Twins is obligatory for \stREQ{SimPhyPartReq}. As a~result of the decomposition, DT/PT may share \stHA{}s.}
      \label{fig:decomposition-concept}
  \end{figure}
		\item \textbf{Step 6} (Agent decomposition): Each \stA{} is decomposed to Subsystems. Various approaches can be used depending on the requirements formulation; however, we advise a~layered bottom-up one with a~definition of each layer interface. First, the hardware assigned to each \stA{} is expressed as \stPRR{}\textit{s}, \stPRE{}\textit{s}, \stSRE{}\textit{s} and \stSRR{}\textit{s} (constituting Agent hardware layer). Next, the interfaces of  \stPVR{}\textit{s}, \stPVE{}\textit{s}, \stSVE{}\textit{s} and \stSVR{}\textit{s} are defined based on \Sec{sect:subsystem_types} (constituting Agent driver layer). The target is to develop a~\stDCS{} (constituting Agent control layer) that manages mirroring Agents' behaviour, uses an embodiment-common interface and exposes an inter-agent interface. However, during the design process and testing, a~temporary \stSCS{} and \stPCS{} are helpful. Mirroring Agents consist of identical control layers; however, the Agents differ in drivers and hardware layers. To enable embodiment abstraction for the control layer in mirroring Agents, the driver layer must fill the gap between the hardware and controller layers in the specific embodiments.
		
		\item \textbf{Step 7} (Structure evaluation): In each design iteration, the structure is evaluated. We propose the following evaluation factors for a two-scope analysis:
		
  \begin{itemize}
      \item System-wide:
        \begin{itemize}
			\item \textbf{Controller integrity factor} (\texttt{IIF}=$\frac{c^{dcs}}{c^{All}}$), where $c^{dcs}$ and $c^{All}$ are the cardinalities of \stDCS{}\textit{s} and all \stCS{}\textit{s} accordingly, 
      			\item  \textbf{Driver generalisation factor} (\texttt{GIF}=$\frac{r_u}{r}$), where $r_u$ is the count of Real Subsystems aggregated in an Agent with a~\stDCS{} and $r$ is the count of all Real Subsystems.
   
			\item \textbf{Digital Twin coverage} (\texttt{DIF}=$\frac{a_{P}^{m}}{a_{P}^{All}}$), where $a_{P}^{m}$ is the count of \stPA{} aggregated in \stMPGA{} with a~\texttt{mirror} relationship with a~\stMSGA{}, and $a^{P}_{All}$ is the count of all \stPA{},
     \end{itemize}
     \item DT/PT pair-wide:
     \begin{itemize}
			\item \textbf{Mirror integrity factor} (\texttt{MIF}$_{n}$=$\frac{c_{n}^{dcs}}{c_{n}^{All}}$), where {\textit{n}} is the evaluated pair of mirroring \stMPGA{} and \stMSGA{} composing one DT/PT pair, $c_{n}^{dcs}$ and $c_{n}^{All}$ are the counts of \stDCS{}\textit{s} and all \stCS{}\textit{s} accordingly in {\textit{n}$^{th}$} DT.
     \end{itemize}
  \end{itemize}

The structure optimisation target is the maximisation of the embodiment-common part of the system (\texttt{IIF}, \texttt{MIF}, \texttt{GIF}, \texttt{DIF}  factors) to maximise simulation-based testing coverage. The share of physical parts mirrored with Digital Twins (\texttt{DIF}) additionally boosts the system's robustness, as DT can replace malfunctioned hardware. The detailed analysis of the proposed factors is described in \Sec{sec:evaluation-factors-analysis}. The optimisation target can be defined with the above factors or others that can be defined for a~specific system. If the evaluation result is unsatisfactory, the system should be redesigned (starting from \textbf{Step 5}) following the factors' maximisation advices.
		
		\item \textbf{Step 8} (System setups): Based on the \textit{optional} stereotypes in the requirements, all possible system setups emerge. Each setup (\stSSGA{}) is specified with an Internal Block Diagram. The diagram shows the Agents composing given \stSSGA{}, their communication and interaction with Simulated and Physical Worlds. It should be noted that the system's application setups are just a starting point for \stSSGA{}s specification. For each implementation testing scenario, a~\stSSGA{} should be specified. DTs are broadly used in development optimisation and CPS development safety improvement; therefore, in particular, for testing a \Part{part}{\stMPGA{}}, a~\stSSGA{} consisting of \Part{part}{\stMSGA{}} (DT of the \stMPGA{}) should be defined. The next step of this procedure makes sure that the \stSSGA{} with \Part{part}{\stMSGA{}} is implemented and tested prior to \stSSGA{} including \Part{part}{\stMPGA{}}.
	
	\end{itemize}
	\noindent\textbf{System implementation and testing}
	\begin{itemize}
		\item \textbf{Step 9} (Implementation of the Agents): Starts with a~\stSSGA{}, whose simulation implementation factor is the highest. The simulation implementation factor for example \Part{ex1}{\stSSGA{}} is $\mathtt{SIF}_{ex1}=\frac{s_{ex1}+h_{ex1}}{a_{all}}$, where $s_{ex1}$ and $h_{ex1}$ are cardinalities of the unimplemented \stSA{}\textit{s} and \stHA{}\textit{s} in \Part{ex1}{\stSSGA{}} and ${a_{all}}$ is a~number of Agents in the system. Before implementation, Subsystems must be translated to a PSM. For robotic systems utilising ROS, we propose MeROS DSL~\cite{meros}. Implementation should include unit testing of each Subsystem and Agent.
		\item \textbf{Step 10} (Integration verification): Test scenarios execution for all fully implemented \stSSGA{}.
	\end{itemize}
	
	
 \section{The design evaluation factors analysis}
 \label{sec:evaluation-factors-analysis}
  This section describes the interpretation of the evaluation factors and which system features they evaluate. We describe characteristics of edge case SPSys that scores maximum or minimum values of the design evaluation factors. This gives a basic intuition on the correlation between the factor values and the SPSys features. The interpretation of the evaluation factors is as follows:
 \begin{itemize}
			\item \texttt{IIF} -- is a~share of the software controller common between the embodiments. Virtual Subsystems are not considered, as their count may be related to the Real Subsystem counts in each embodiment. It is maximised by the reduction of the number of \stSCS{}\textit{s} and \stPCS{}\textit{s} in favour of an inter-embodiment \stDCS{}\textit{s}, {The higher} \texttt{IIF} is, the more software components are shared between the simulation and physical embodiments. At maximum (\texttt{IIF}=1), all hardware abstract parts of the system are common. 
 \begin{itemize}
     \item \texttt{IIF} = 0: There are no \stDCS{}, only \stPCS{} or \stSCS{}. The system’s parts in simulated and physical embodiments are disjunctive. Simulation-based testing is not possible. The system’s functions in the simulation may be completely different from those in the physical embodiment.
     \item \texttt{IIF} = 1: All Control Subsystems are \stDCS{}, and there are no \stPCS{} or \stSCS{}. This means all hardware abstract parts of the system are common between its embodiments, and the coverage of simulation-based testing is maximised and allows integration testing in simulation.
     \end{itemize}
			\item \texttt{MIF}$_{n}$ -- is a~share of the system parts common between Physical and Digital Twins composing the \textit{n}$^{th}$ twin pair (managing \stREQ{SimPhyPartReq}). It is similar to~\texttt{IIF} but within the scope of $n^{th}$ pair of Physical and Digital Twin. { Tips for maximisation of the \texttt{MIF}$_{n}$ factor} are: \begin{itemize}
			    \item extraction of common functions as \stHA{}\textit{s} from \stMPGA{} and \stMSGA{} \item and/or redesign of interfaces between a~\stSCS{} and \stSDGS{} and between a~\stPCS{} and \stPDGS{} to emerge a~common \stDCS{} from the  \stSCS{} and \stPCS{},
       
			\end{itemize}
			\item \texttt{GIF} -- is a~share of Real Subsystems (hardware) controlled by \stDCS{}\textit{s} (shared controller). It expresses hardware control integrity between the embodiments.
   
     \begin{itemize}
     \item \texttt{GIF} = 0: All Hardware parts are controlled by embodiment-specific Control Subsystems. The causes of this depend on a specific case:
     \begin{itemize}
     \item For Physical Hardware without a~DT, it means the interface to hardware is embodiment-specific; thus, extending the system with DT of the hardware is complicated,
     \item For Physical Hardware with a~DT, it means the Hardware Drivers interface of Physical and Digital Twins differ, and the software using the interface differs between the embodiments. This means the system part designed as DT of the Physical hardware is not a~proper DT.
 \end{itemize}
     \item \texttt{GIF} = 1: All Hardware parts are controlled by embodiment-abstract Control Subsystems; thus, the Agents managing hardware are interchangeable between the embodiments, or future Digital/Physical Twin integration for Physical/Simulated Hardware is straightforward.
     
     \end{itemize}
			\item \texttt{DIF} -- is a~share of hardware and its controllers mirrored with a~DT. Its increase boosts coverage of simulation-based testing of hardware controllers and system robustness utilising the DT concept. If \texttt{DIF} = 0, there are no DTs in the system; if \texttt{DIF} = 1, all Physical Hardware parts have DTs.
		\end{itemize}
 Based on the factors' values, one can evaluate the system design in terms of the following:
 \begin{itemize}
     \item Safety and hardware independence during software testing -- based on \texttt{IIF} (for system scope), \texttt{MIF}$_n$ (for $n^{th}$ DT),
     \item Simulation-based testing and failure examination/prediction of the system parts  -- based on \texttt{DIF}
     \item Inter-embodiment integrity of hardware controllers and readiness for simulation-based hardware testing  -- based on \texttt{GIF}.
 \end{itemize}
Maximisation of the factors is not always required, and the optimisation goal can be set at a different point in the factors' space. The goal depends on the specific system requirements. However, the factors' values inform the designer about the inter-embodiment integrity of the system design, so her/his decision is conscious.
	\section{Verification}
	\label{sec:example-system}
We execute the SPSysDP to design, implement and test a~complex SPSys utilising a~service robot for the INCARE project. 
	The INCARE system idea and requirements are published in \cite{brenvcivc2020intuitive}. The framework model developed to manage robot tasks is published in \cite{Dudek-multitasking-romoco-2019, tasker2020}.
	Developing a~complex system requires different implementations of its parts in various development phases. In INCARE, we use some commercial products like the TIAGo robot with its control system. We develop and integrate new parts into it (e.g. human fall detector and TIAGo audio interface extension). In such a~case, developing one part requires a~dummy of another part while being developed simultaneously. Developers can simulate the underdeveloped parts while the physical devices are under construction or development. In the case of INCARE, we use a~dummy for the human fall detector while developing a~TIAGo robot application helping the elderly who may fall over. We use and modify the TIAGo robot in this project; thus, we specify its hardware and controller as a~part of the INCARE system specification. 
	
	The result of each step of SPSysDP is as follows:
	\paragraph*{\bfseries Step 1 and 2}
	we specify the structural and functional requirements based on the general requirements of the INCARE project. The general and the robot-specific requirement diagrams are shown in in~\Fig{fig:incare_req}.
 	\begin{figure}
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/incare_main_req.png}
			\caption{INCARE structural requirements}
			\label{fig:main_req}
		\end{subfigure}
		%	\end{figure}
		%	\begin{figure}[h]
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/robot_req.png}
			\caption{The Robot requirements, where TTS and STT are text-to-speech and speech-to-text functions}
			\label{fig:robot_req}
		\end{subfigure}
		\caption{Example part of the INCARE requirements}
		\label{fig:incare_req}
	\end{figure}
 The requirements were accepted after some Step~1$\leftrightarrow$Step~2 iterations. These iterations led, for instance, to the decomposition of the \Part{Communication with humans}{\stSPFR{}}  to \Part{TTS and STT}{\stSPFR{}} and \Part{Dialoge management}{\stCFR{}}.
	
	\paragraph*{\bfseries Step 3} The robot in the INCARE project coexists with humans; thus, we utilise \Part{WorldSync}{\stWMGA{}} to manage humans in the Simulated World. Detailed specification and realisation of \Part{WorldSync}{\stWMGA{}} is available in~\cite{hubero}.
	
	\paragraph*{\bfseries Step 4 and 5} In the final design iteration the system is decomposed to 5 embodiment-specific Agents, one for each system part: \Part{TIAGo}{\stSA{}} mirroring \Part{TIAGo}{\stPA{}}, \Part{FallDetector}{\stSA{}} mirroring \Part{FallDetector}{\stPA{}} and \Part{SmartHome}{\stPA{}}. Additionally, there are 3 Hybrid Agents, one for each computational function of the system: \Part{ComplexTaskExecution}{\stHA{}}, \Part{Talker}{\stHA{}}, \Part{FakeAudio}{\stHA{}}. \Part{TIAGo}{\stSA{}}, \Part{FakeAudio}{\stHA{}} and \Part{Talker}{\stHA{}} compose \Part{Robot}{<<MirrSimGpAgents>>}, and \Part{TIAGo}{\stPA{}} and \Part{Talker}{\stHA{}} compose \Part{Robot}{<<MirrPhyGpAgents>>}.
	
	
	\paragraph*{\bfseries Step 6} To provide an example we describe the final decomposition of \Part{TIAGo}{\stSA{}} and \Part{TIAGo}{\stPA{}} Agents only. Each robot hardware component is specified as either \stPRR{}, \stPRE{}, \stSRR{}, or \stSRE{}. We use Gazebo simulation environment; thus, \stSRR{}\textit{s} and \stSRE{}\textit{s} expose gazebo::SensorPlugin and gazebo::ModelPlugin interfaces accordingly. As the physical robot, we use PAL Robotics' TIAGo; thus, \stPRR{}\textit{s}, \stPRE{}\textit{s} interfaces are adequate Linux Kernel drivers managing communication with the devices. The Simulated Drivers connect to the gazebo::SensorPlugin and gazebo::ModelPlugin interfaces and expose the robot state info and typical ROS topics/services (e.g. \textit{JointStateInterface} and \textit{EffortJointInterface} for \Part{MobileBaseController}{\stSVE{}}\footnote{This \stVE{} is based on \textit{gazebo\_ros\_control} package: \url{https://classic.gazebosim.org/tutorials?tut=ros_control} } and \textit{/scan} ROS topic for \Part{lidar}{\stSVR{}}). If Simulated World is the Gazebo environment, \stSVE{}\textit{s} and \stSVR{}\textit{s} are usually implemented as Gazebo Plugins. \stPDGS{} connects to Linux Kernel drivers and, as a~whole Group, exposes to \stCS{} identical interfaces as \stSDGS{}. \Fig{fig:tiago-ibd} shows IBD of both \Part{TIAGo}{\stSA{}} and \Part{TIAGo}{\stPA{}} and their common \Part{RobotIf}{\stDCS{}}.
		
	\begin{figure}
		\centering
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/incare/tiago_sim_agent_ibd.png}
			\caption{IBD of \Part{TIAGo}{\stSA{}}}
			\label{fig:tiago_sim_agent_ibd}
			
		\end{subfigure}
	
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/incare/tiago_phy_agent_ibd.png}
			\caption{IBD of \Part{TIAGo}{\stPA{}}}
			\label{fig:tiago_phy_agent_ibd}
		\end{subfigure}
		\caption{IBD of mirroring Agents executing \Part{Robot}{\textit{<<SimPhyPartReq>>}} in the Physical and Simulated embodiments}
		\label{fig:tiago-ibd}
	\end{figure}	
		
	\paragraph*{\bfseries Step 7} The final structure evaluation resulted with: \texttt{IIF}=1, \texttt{MIF}$_{Robot}$=1, \texttt{MIF}$_{FallDetector}$=1, \texttt{GIF}=1, and \texttt{DIF}=0.67. The result means the structure consists of no \stSCS{} or \stPCS{}, and one \stPA{} is not mirrored by a DT (\Part{SmartHome}{\stSA{}}). The lack of DT for \Part{SmartHome}{\stSA{}} results from the requirements (\Fig{fig:main_req}), where Smart Home is not \stSPPR{}); thus, this is an informed decision of the designer. \texttt{GIF}=1 means \Part{SmartHome}{\stSA{}} has \stDCS{}, therefore, its DT integration to the system in the future is straightforward. One of the previous design iterations resulted with:  \texttt{IIF}=$\frac{5}{7}=0.71$, \texttt{MIF}$_{Robot}$=1, \texttt{MIF}$_{FallDetector}$=0, \texttt{GIF}=$\frac{20}{22}=0.91$, \texttt{DIF}=0.67. In this iteration the \Part{FallDetector}{\stSA{}} and \Part{FallDetector}{\stPA{}} use embodiment specific control layer (\stSCS{} and \stPCS{}), because \Part{FallDetector}{\stSA{}} consists \stSCS{}\textit{s} only. To increase \texttt{MIF}$_{FallDetector}$ and \texttt{GIF} the common part of \Part{FallDetector}{\stSCS{}} and \Part{FallDetector}{\stPCS{}} was extracted. The common part constitutes \Part{FallDetector}{\stDCS{}} in the final design.
 % \wdci{This is a~tip for developers to increase embodiments integrity. It should be highlighted in the conclusions and the result analysis.}
 The \Part{FallDetector}{\stDCS{}} is a~universal interface between \Part{ComplexTaskExecution}{\stHA{}} and the driver layer of \Part{FallDetector}{\stPA{}}. It forced decomposition of \Part{FallDetector}{\stSA{}} to \Part{FallDetector}{\stDCS{}}, \Part{FallDetector}{\stSVR{}} and \Part{FallDetector}{\stSRR{}}. The latter two simulate fall detector sensing. Thanks to the structure optimisation,  \Part{FallDetector}{\stDCS{}} is used in both embodiments in the final structure and the translation of the Fall Detector perception to the message useful for \Part{ComplexTaskExecution}{\stHA{}} can be tested in simulation.

	\paragraph*{\bfseries Step 8} Based on the \stREQ{OptionalReq}\textit{s} in the requirements we define 12 \stSSGA{}\textit{s} for (\Part{SmartHome}{\stPA{}} existing or not, \Part{FallDetector}{\stPA{}} or \Part{FallDetector}{\stSA{}} or no FallDetecor, \Part{Robot}{\stPA{}} or \Part{Robot}{\stSA{}}). We show \Part{Simulated}{\stSSGA{}} and \Part{Physical}{\stSSGA{}} Internal Block Diagrams (IBDs) (\Fig{fig:sega_ibd}) to exemplify \stSSGA{} specification.

	\begin{figure}
		\centering
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/simulated_sega_ibd.png}
			\caption{\Part{Simulated}{\stSSGA{}} with example requirement allocations}
			\label{fig:simulated_sega_ibd}
			
		\end{subfigure}
		
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/physical_sega_ibd}
			\caption{\Part{Physical}{\stSSGA{}} with example requirement allocations}
			\label{fig:physical_sega_ibd}
		\end{subfigure}
		\caption{IBDs for example \stSSGA{}}
		\label{fig:sega_ibd}
	\end{figure}
  
	\paragraph*{\bfseries Step 9 and 10} In INCARE the \Part{Robot}{\stPA{}} and \Part{Robot}{\stSA{}} are realised with TIAGo robot and its simulation. PAL Robotics mostly implemented these. 
	We mapped the robot hardware and software to our design (as shown in \Fig{fig:tiago-ibd}).  \Part{RosControl}{\stSDGS{}} is a~software package\footnote{\url{http://wiki.ros.org/ros_control}} implementing various common ROS controllers, and \Part{SimTIAGoDrives}{\stSHGS{}} is a~package\footnote{\url{http://wiki.ros.org/pal_hardware_gazebo}} implementing Gazebo plugins controlling TIAGo drives.
	Additionally, we boosted the robot's voice communication ability using the Google Dialogflow service. We equipped \Part{TIAGo}{\stPA{}} with additional USB Microphones \cite{arvix-tiago} to improve its audio perception. The other \stA{}\textit{s} were implemented and tested following the simulation implementation factor. In the result, we got \Part{Simulated}{\stSSGA{}} implemented and tested before \Part{Physical}{\stSSGA{}}, what improved robot system development safety.
    The world synchronisation feature (mirroring humans in the Simulated World) was implemented with HuBeRo framework as \Part{WorldSync}{\stWMGA{}} and tested in a~crowded hospital environment (\Fig{fig:hubero-sim}).
      \begin{figure}
      \centering
      \includegraphics[width=0.8\columnwidth]{figures/human-sim.jpg}
      \caption{A frame from \Part{WorldSync}{\stWMGA{}} testing.}
      \label{fig:hubero-sim}
  \end{figure}

	The INCARE system was deployed in an end-user home, and the videos present its performance in the example tasks--- transportation (\Fig{fig:tiago-transport})\footnote{\url{https://vimeo.com/670252925}} and fall assistance (\Fig{fig:tiago-fall})\footnote{\url{https://vimeo.com/670246589}}.

 
 

	\section{Summary}
	\label{sec:summary}
Numerous Cyber-Physical Systems include simulation parts either as Digital Twins (DT), demonstrators, or mockups utilised during their development. We postulate the Simulation-Physical System (SPSys) concept to describe this kind of system. SPSys includes physical, simulated and hybrid parts. They cooperate to fulfil the system's aim; however, some are used as DTs to boost the system's reliability and analysis possibility. Some parts of the system can be used in the development process only as mockups and prototype simulators to increase the simulation-based testing coverage of the system. This, in turn, improves prototype safety and the resulting system robustness. 

SPSys application is wide; in particular, it can work in a~dynamic environment so that it can observe exogenous actions of the environment's habitants. Such a~situation is problematic because DT must perfectly mirror its PT. To answer the above needs, we propose a Domain-Specific Language named Simulation-Physical System Modeling Language (SPSysML) that models the SPSys artefact and demonstrates SPSys taxonomy and the relationships between the types of SPSys parts. 

One of the crucial aspects of reliable software development is integrity and reusability. Therefore, we propose SPSys Development Procedure (SPSysDP) that, using design evaluation factors, supports quantitative analysis and optimisation targeted to software re-use maximisation between DT and PT and in different system setups. We analyze the evaluation factors and show features of the systems that score edge case values of the factors. 

Finally, we verify SPSysML and SPSysDP in complex robot system development. We demonstrate step-by-step SPSysDP execution. We point out significant system structure changes resulting from the design evaluation and the proposed quantitative factor-based guidelines applications. An example is \Part{FallDetector}{\stSA{}} and \Part{FallDetector}{\stPA{}} integration improvement by common part isolation as \stDCS{}. Moreover, the verification shows that 33\% of the system's Physical Agents do not have DTs, and thanks to the design modification, the whole hardware (physical and simulated) is controlled with \stDCS{} (\texttt{GIF}=1). This has two main advantages. First, all pairs of Digital and Physical Twins share a common control subsystem. Second, if there is a~\stPA{} or \stSA{} without a~twin, it can be easily integrated with its Digital or Physical Twin in the future. 

The conducted verification shows that the requirement profile for SPSys enables critical analysis and may result in requirement decomposition and explication. An example is the decomposition of the \Part{Communication with humans}{\stSPFR{}}  to \Part{TTS and STT}{\stSPFR{}} and \Part{Dialoge management}{\stCFR{}} in the first and second steps of SPSysDP. Thanks to the \Part{Dialoge management}{\stCFR{}} separation, the proposed requirement-based procedure for the system decomposition resulted in the implementation of \Part{Talker}{\stHA{}} managing the requirement. As a consequence of the above, the requirement is managed by a component usable in different setups in cooperation with the simulated or physical embodiment. Otherwise, the requirement would be managed separately in simulation and physical embodiments of the robot.
The presented verification confirms the features distinguishing our method from the others listed in Table~\ref{tab:related-work}:
\begin{itemize}
    \item Integrity evaluation with quantitative factors,
    \item SysML-based structure model and system development procedure,
    \item System design optimisation considering simulation and physical embodiments of the system,
    \item Multiple system execution and testing setups specification,
    \item Forcing simulation-based testing prior physical embodiment development using simulation implementation factor for sequencing \stSSGA{} implementation and testing, 
    \item Specification of Simulation-Physical System including multiple physical and simulated parts and multiple Digital Twins.
    \item \stWMGA{} artefact definition and including its design in SPSysDP to reflect the dynamic environment in simulation, enabling Digital Twins to observe exogenous actions.
\end{itemize}
% \wdci{przejrzeć stare:}

% We propose a Domain Specification Language named DEMoL suited for DES. It satisfies the requirements stated as the result of our analysis and the related works review. DEMoL states constraints for DES structure and specifies relationships between its parts. In particular, we investigate inter-embodiment relationships in robot systems and distinguish physical, simulation, and hybrid class Agents aggregated in various class Groups of Agents boosting system clarity. For example, \stSSGA{}\textit{s} with internal block diagrams advance DES progressive test planning.
% Moreover, this block type can specify the configuration of system deployments for automated test generation methods like AmbieGen \cite{HUMENIUK2022106936}. We define the DEMoL application procedure, which constitutes the DES development procedure improving safety in DES testing. All Control Subsystems specified in the DEMoL-based system should be dual-embodied; however, it is a~goal for the iterative optimisation process. We propose example integrity factors that are optimised during the system design. 

% 	 DES development procedure specifies clearly the decomposition of an {Agent} into the additional embodiment-dependent Subsystems in hardware and driver layers. Thanks to that and the \texttt{mirror} relationship definition, the optimisation target can be specified with the example or other factors, and the DEMoL-based system structure results from the evaluation of the factors. As result, {Agents} mirroring a~system function in different embodiments utilise the same Control Subsystem that is developed once and tested in the Simulated World before testing and deployment in the Physical World. Moreover, we propose a~toolchain for robot system development. The toolchain utilise universal, well-known software to manage DEMoL-based system development (Enterprise Architect to SysML diagrams creation) and to simulate robot system parts during the testing stage (Gazebo).  We share SysML profiles, DEMoL meta-model, and the example of the INCARE system model\footnote{\url{https://github.com/RCPRG-ros-pkg/DEMoL}} to ease  its DES specification. DEMoL boosts system parts' re-usability in both embodiments and lowers the risk of double deployment with the \texttt{mirror} relationship constraints.
% 	As a~verification we apply DEMoL and its application procedure to a~complex robot system equipped with additional devices. We show the results of the procedure's steps and the final system specification modelled with DEMoL. 
	

	In the future, we plan to automate testing SPSysML structure and code generation based on it with known, universal tools like Matlab and Enterprise Architect. Furthermore, this work revealed the need for a taxonomy of CPS structure optimisation indicators. SPSysML and future work leads to optimal structure development automation for complex robot systems.

\section*{Acknowledgment}
The research was funded by the Centre for Priority Research Area Artificial Intelligence and Robotics of Warsaw University of Technology within the Excellence Initiative: Research University (IDUB) programme. The authors also acknowledge TALBOT, from the European Union’s Horizon 2020 research and innovation programme under Marie Skłodowska-Curie grant agreement No. 801342 (Tecniospring INDUSTRY) and the Government of Catalonia’s Agency for Business Competitiveness (ACCIÓ); and SHAPES, from the European Horizon 2020 research and innovation programme under grant agreement No 857159. The Spanish grant PID2021-125535NB-I00 has also supported the work.

	\bibliography{spsys}

% \appendices


%  \section{The INCARE project requirements}
%  \label{appendix-incare-requirements}

\end{document}
