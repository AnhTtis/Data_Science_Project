% !TEX encoding = utf8
% !TeX spellcheck = en_GB
% !TeX program = pdflatex

% \documentclass[letterpaper, 10 pt, conference]{ieeeconf}


\documentclass[10pt,journal,compsoc]{IEEEtran}
% ATTENTION !
% 
% IF the print_comments toggle is true, LaTeX prints comments to the article as red text.
% If you comment with an Overleaf review, please use \comment{} command. This way, the comments will not affect the PDF unintentionally.
%
\usepackage{etoolbox}
\providetoggle{print_comments}
\settoggle{print_comments}{true}
\newcommand{\comment}[1]{\iftoggle{print_comments}{\textcolor{red}{#1 }}}
%   
%   
\IEEEoverridecommandlockouts                              % This command is only needed if 
% you want to use the \thanks command

% LINIA PONIZEJ ZAKOMENTOWANA BO GENEROWALA BLAD W MIKTEX
%\overrideIEEEmargins                                      % Needed to meet printer requirements.

\usepackage{lineno,hyperref}
\modulolinenumbers[5]

\oddsidemargin -40pt

\marginparwidth 170pt
\usepackage[]{subcaption}
\usepackage{color}
\usepackage{pdfcomment}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
% \usepackage{polski}
%\usepackage{amsmath}
\usepackage{float}
\usepackage{multirow}
\usepackage{makecell}
\usepackage{graphicx}
\usepackage{rotating}
\usepackage{footmisc }
\usepackage{enumerate}

%\usepackage[shortlabels]{enumitem}
% \usepackage[english,polish]{babel}

%\usepackage{amsthm}
%
%\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]

\usepackage{xargs}
\usepackage[table,xcdraw]{xcolor}
\usepackage[colorinlistoftodos,prependcaption,textsize=tiny]{todonotes}
\usepackage{textgreek}
\newcommand{\Fig}[1]{Fig.~\ref{#1}}
\newcommand{\App}[1]{Appendix~\ref{#1}}
\input{earl-1_3-commands}
\input{spsys-stereotypes}


\def\checkmark{\tikz\fill[scale=0.4](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- cycle;} 

\usepackage{mathtools, bigstrut}
\DeclarePairedDelimiter{\set}{\{}{\}}
\DeclareMathOperator{\GL}{GL}

\newcommand{\Sec}[1]{Sec.~\ref{#1}}
\newcommand{\wdci}[1]{{\color{magenta} WD: {#1}}}
\newcommand{\twt}[1]{\textcolor{olive}{@TW: {#1}}}

\bibliographystyle{ieeetran}

%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
	\title{Component reusability evaluation and requirement tracing for agent-based simulation-physical systems
	}
	%		\title{Dual-Embodied System Modeling Language for simulation-physical robot system}
	%	\title{The system model for methodical extending and modifying a~physical and simulated service robot system -- case study on TIAGo robot\\or\\the model towards comparability and integrity of customisations of robot systems with simulation
	%	 \\or\\The model for consistency maintenance between the physical and simulated controller in agent-based systems customisation.\\or\\The agent-based model for consistent development of a~robot system with simulator -- the TIAGo robot case study\\or\\A~Consistent specification and modification of a~dual-embodied robot system -- the real and simulated TIAGo robot system.
	% }
	
	%% Group authors per affiliation:
	\author{Wojciech Dudek$^{1}$, Member, IEEE, Narcis Miguel$^{2}$, Member, IEEE, Tomasz Winiarski$^{1}$, Member, IEEE
	\thanks{$^{1}$Warsaw University of Technology, Institute of Control and Computation Engineering, Poland
        {\tt\small wojciech.dudek@pw.edu.pl},\\
        {\tt\small tomasz.winiarski@pw.edu.pl}
        }
    \thanks{$^{2}$PAL Robotics, Barcelona, Spain\\
    {\tt\small narcis.miguel@pal-robotics.com}}}
	
	\maketitle
	
	\begin{abstract}


In the early stages of product development, evaluating design concepts is crucial due to its impact on quality and cost. However, this process is often hindered by vague and uncertain design information. This article introduces the use of domain specification language to improve design analysis and evaluation of systems incorporating simulation and physical parts.


% Robots are cyber-physical systems (CPS) equipped with multiple sensors and effectors, making them aware of dynamic environments, e.g. surrounding humans. A multi-component structure and potential environmental harm make robotic systems development challenging. The Digital Twin (DT) concept has recently been applied to model and test CPS. Thus, DT implementation evaluation in robotic system development becomes a significant task. 

\textit{Goal}: We propose an evaluation method of integrity between the simulated and physical embodiment of the system. The assessment is done in various scopes, e.g. per pair of Digital Twins (DT) and its physical counterpart--- Physical Twin (PT), system-wide, or one of many system setups.
 
% We aim to assess the integration between simulated
% and physical parts of multi-setup CPS. This kind of system may be configured to different system setups, and we want to optimise the system's structure for all its setups. The goal is to control the simulated and real hardware with a shared controller and tighten the integration between simulated and physical embodiment of the system.

\textit{Method}: We propose a~Domain-Specific Language based on Systems Modeling Language (SysML). The Simulation-Physical Systems Modeling Language (SPSysML) defines the taxonomy of considered CPS consisting of at least a~physical or simulated part. Based on SPSysML concepts, we define quantitative factors and a requirement-based system structuring method, which enhances requirement analysis and allows DT to perceive exogenous actions in the simulated world. 

\textit{Result}: SPSysML is used to develop a~robotic system for the INCARE project. In subsequent iterations of the system's design process, the simulation-physical integrity of the system is improved, and a more significant fraction of the system components is shared between its simulated and physical embodiments. The designed system was deployed on the physical robot and two simulators. System setups are based on Robot Operating System (ROS) or ROS2. Therefore, we argue that SPSysML is neither specific for a~control system framework nor a~robot simulator. SPSysML was used by a third-party developer and was assessed by him and other practitioners in a survey. 

\textit{Conclusion}: SPSysML enables the design of SPSys (including DT and CPS), evaluation of the design in them multi-setup system development featuring improved integrity between simulation and physical parts in its setups. The systematic requirement-based system structuring also enhances the traceability of system requirements allocation to simulated and physical system parts.

		% Robot systems are complex cyber-physical systems (CPS) not only in structure and behaviour, but also in development. State-of-the-art robot development procedures utilise simulation mainly for in-development testing. Thus, parts of the system migrate from a~simulated to a~physical embodiment during development. The popular digital twin (DT) concept confronts the simulated and the physical embodiments of a~system for their behaviour analysis. We present a~concept of a dual-embodied system (DES) interacting with simulated and physical worlds. The concept concerns CPS involving simulation either during development or exploitation. In this work we study the relationship between the embodiments in robot systems and propose a Domain Specification Language that we refer to as DEMoL and its application procedure constituting the DES development procedure. Both language and application procedure allow the optimisation of inter-embodiment integrity of DES. The resulted structure is used in the implementation and testing phases, thus, enabling i.a. formal test cases specification. We propose three DEMoL-based criteria for DES structure integrity optimisation. DEMoL and its application procedure are verified on a~complex robot system developed for a European Commission-funded project. 
	\end{abstract}

	\section{Introduction}
	\label{sec:intro}
	%
	% Poniżej propozycja rozszerzenia litaratury
	%
	%\wdci{Ewentualnie dodatkowo można się odwołać do: \url{https://ieeexplore.ieee.org/abstract/document/9186155} oraz \cite{doi:10.1504/IJPD.2013.052166}}
	
Simulation is widely used in state-of-the-art development procedures for cyber-physical systems (CPS). Recent papers refer to Model-in-the-loop (MIL) \cite{10.1243/09596518JSCE207}, Software-in-the-loop (SIL) \cite{4455268}, Hardware-in-the-loop (HIL) \cite{10.1007/978-3-319-74793-4_10} and Rapid Control Prototyping (RCP) \cite{Abel2006} techniques. They are used selectively or are composed in sequence, e.g. verification and validation steps in a systems development approach called \mbox{V-model}~\cite{mathur2010advancements}. Each of the techniques requires a simulation of the system parts. Some systems utilise the Digital Twin (DT)~\cite{9529662, PYLIANIDIS2021105942} concept. They employ an accurate simulation of a system part for, e.g.:
	\begin{itemize}
		\item Swapping a malfunctioned system part with the simulated one DT that mirrors the part's functionality in the simulated world,
		\item Energy consumption analysis,
		\item System failure analysis and prediction,
		\item Technology integration,
		\item Real-time monitoring.
	\end{itemize}
Some parts (software and hardware) of such a system interact with the real world, while others interact with the simulated world. We define the set of the parts used in the real world as the physical embodiment and the set of the parts used in the simulated world as the simulated embodiment. The DT is a~part of the simulated embodiment mirroring a~part of the physical embodiment. DT concept is used in numerous domains and applications~\cite{NEGRI2017939}. They are systematically analysed by the authors of~\cite{dalibor2022cross}.

Robots comprise multiple devices and their controllers. In particular, autonomous mobile robots require a~complex navigation system featuring multiple closed control loops, e.g. drive controllers, trajectory controllers, and Simultaneous Localisation and Mapping (SLAM). Furthermore, in a~complex mobile manipulator system~\cite{9376462}, the navigation system is integrated with manipulation control to execute user requests (like object transportation). In some cases, only a~fraction of such a complex system must have DTs. In other cases, if the robot system only has the simulated embodiment, it is a~demonstrator of a~future product. 

 To clear up the taxonomy of systems featuring simulated and physical parts, we introduce the Simulation-Physical System (SPSys) concept~(\Fig{fig:concept}). This kind of system consists of at least one physical/simulated embodiment and a~shared controller. If it has both embodiments, the simulated part can be a~DT of a~physical part. If it has only the physical embodiment, it is a~CPS; if it has only the simulated embodiment, it is a~simulator. 
	\begin{figure}[t]
    	\centering
		\includegraphics[width=0.7\linewidth]{./figures/concept-2}
		\caption{The idea of Simulation-Physical System}
		\label{fig:concept}
	\end{figure}
 
% In the development process, the system parts evolve from simulated mockups to the physical parts and the software deployed on the hardware. The system development procedure must guide the project team through the process. The system design created as a~milestone in the procedure must specify all required parts in all development stages and compose them in the testing and deployment setups. 
Developing reliable systems, especially complex ones like robot systems, requires comprehensive unit and integration testing. Some CPS parts can be tested with simulated hardware only; therefore, additional parts that do not comprise the operational system are required (e.g. human simulator in a~social robot case). Comprehensive testing is complex in test case specification and time-consuming in test implementation and execution. From this perspective, software reusability is a~key to fast development of complex, reliable systems.

We aim to:
\begin{itemize}
    \item Enhance system requirements traceability for simulated and physical system parts thanks to the introduction of profiled-based requirements of Simulation-Physical Systems, including multiple Digital Twins for procedural system structuring based on the requirement types,
    \item Evaluate the level of component re-use between DT and its Physical Twin (PT) and between different system setups, improving the system's reliability and resulting in more accessible and faster testing, 
    % \item The integrity boost between simulation and physical embodiments of SPSys. This enables a~comprehensive and parallel simulation-based testing of the system parts,
    \item Enable Digital Twins to observe exogenous actions in simulation. The actions can be executed by any agent outside the physical system, e.g.~a human moving objects in a service robot environment. Such an~action must be implemented in the simulated world to make DT operate in the exact environment as its physical counterpart.
\end{itemize}

To reach these goals, we propose a~Domain-Specific Language (DSL) named Simulation-Physical System Modeling Language (SPSysML). SPSysML models the requirements and the SPSys, in particular, SPSys consisting of simulated parts (used either in the system development or in the operational setup as a~DT/simulator). Based on SPSysML, we propose a~requirement-based SPSys structuring method for enhancing requirement readability in simulated and physical system parts. To measure the inter-embodiment integrity of the system, we propose quantitative design evaluation factors for SPSys designs. The factors are used during system development to maximise the shared controller, minimise the variety of the system parts and improve simulation-physical integrity. 
% The Simulation-Physical System Development Procedure (SPSysDP) exploiting SPSysML features is proposed~\cite{SPSysDP}.
% \wdci{Dodać tezy/pytania badawcze, które potwierdzimy w podsumowaniu: 
% \begin{itemize}
%     \item SPSysML definiuje koncepty opisujące systemy posiagające części symulowane, fizyczne oraz relacje między nimi, w szczególności relacja mirror między Digital Twin i jego Fizycznym odpowiednikiem.
%     \item Należy opracować model system, który zawieraja DT i działa w dynamicznym środowisku, które jest zmieniane nie tylko przez sam system, ale też przez niesterowalne przez system agenty.
%     \item Można zdefiniować ilościowe współczynniki oceny projektu SPSys i na ich podstawie optymalizować ten projekt. 
% \end{itemize}}
Our goal originates from the conclusion of \cite{LO2021101297}: \textit{The digital models are mainly used to examine product performance(...). However, how to optimise the use of those models to enhance the design process and design collaboration still needs to be investigated.}

 
 In this article, we describe related work concerning mixing simulation-physical setups and meta-models for CPS (\Sec{sec:related-work}) and state our work's novelty and its result regarding the related works (\Sec{sec:novelty}). Subsequently, we define SPSys requirements model in~\Sec{sec:requirement-model}, the meta-model in \Sec{sec:pl-structure}. In \Sec{sec:evaluation-factors}, we analyse the proposed evaluation factors of SPSys design and describe characteristics of a~system scored edge case values of the factors. Finally, we validate our methodology in complex SPSys development for the INCARE project (Sec.~\ref{sec:example-system}) and by robotics practitioners assessment~\ref{sec:assessment}. 
 % Although the example specifies the system, including the TIAGo robot, the presented meta-model and procedure apply to any Simulation-Physical System. SPSysML is a platform-independent model (PIM) that, in contrast to platform-specific models (PSM), abstracts from a specific hardware or software implementation. However, the proposed development procedure results in a model transformable to PSM with ease. We demonstrate the SPSysML application and procedure on INCARE project use cases and transform the result (PIM) into a system employing the TIAGo robot. 
% This work is concluded in~(Sec.~\ref{sec:summary}).

	
	\begin{figure}\centering
		\begin{subfigure}{0.3\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./figures/tiago-transport}
			\caption{Transport task}
			\label{fig:tiago-transport}
		\end{subfigure}
		\begin{subfigure}{0.54\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./figures/tiago-fall}
			\caption{Fall assistance task}
			\label{fig:tiago-fall}
		\end{subfigure}
		\caption{TIAGo robot in INCARE tasks execution}
		\label{fig:tiago-tasks}
	\end{figure}



 \begin{table*}[h!]{
			\begin{center}
				
			\caption{Related works comparison with this work}\label{tab:related-work}\footnotesize
			\begin{tabular}{|l|c|c|c|c|c|c|c|c|c|c|c|}
				\hline
				\makecell{System \\development\\ method}&\makecell{RTD}&\makecell{EIV}&\makecell{Formal \\meta-model}&\makecell{SCP}&\makecell{SE}&\makecell{System \\structure\\configurability}&\makecell
				{DE}&\makecell{E}&\makecell{QE}&\makecell{MDT}&\makecell{Purpose}\\ \hline
				%CPS
				%\multicolumn{7}{c}{A survey on cyber-physical system development}\\\hline
				\makecell[l]{Digital\\Mockup \cite{5952295}}&-&-&-&ES&-&\makecell{Single\\structure}&\checkmark&-&-&-&\makecell{Real time (RT) simulation\\for HIL  testing}\\\hline
				%DT
				%\multicolumn{7}{c}{A survey on digital twin development\cite{LO2021101297}}\\\hline \makecell[l]{ DT for\\ind. 4.0\\\cite{9247401}}&M&-&\makecell{SysML}&General&-&n/d&\checkmark&-&\makecell{Generic\\model\\of DT}\\\hline
				\makecell[l]{C2PS \cite{7829368}}&-&-&\makecell{Own\\meta-model}&\makecell{Formal \\and detailed}&\makecell{BS}&\makecell{Single\\adaptive}&\checkmark&-&-&N/D&\makecell{Digital Twin\\in the cloud}\\\hline
				%\cite{9529662}&&&&&&&&\\\hline
				%\cite{PYLIANIDIS2021105942}&&&&&&&&\\\hline
			\cite{8822494}&-&\checkmark&\makecell{Dolev-Yao \\\cite{1056650}}&\makecell{Formal \\and detailed}&-&\makecell{Single\\structure}&\checkmark&-&-&\checkmark&\makecell{Cyber-security,\\physical-digital twin\\ synchronisation}\\\hline
				% ROBOT
				%\multicolumn{7}{c}{Robotics}\\\hline
				\makecell{DEVSRT \cite{MOALLEMI2013115}}&-&-&\makecell{DEVS \cite{zeigler2000theory}}&General&-&\makecell{Single\\structure}&-&-&-&-&\makecell{Simulation to embedded \\continuous development}\\\hline
				aRD\cite{4058987}&-&-&-&General&-&\makecell{ Multiple\\setups}&\checkmark&-&-&-&\makecell{RT \& NonRT \\parts integration}\\\hline
				\makecell[l]{HMLF \cite{ElShamoutyKleebergerLammleHuber}}&-&-&-&ES&-&\makecell{Single\\structure}&-&-&-&-&\makecell{Simulation-driven ML} \\\hline
    
				\makecell{RSHPN \cite{FigatZielinski-HPNmetamodel:2022}}&-&-&\makecell{RSHPN\\/Petri net}&\makecell{ES}& DI&\makecell{Single\\structure}&\checkmark&-&-&-&\makecell{Control deadlock \\check, code generation}\\\hline
				
    \makecell{SPSysML}&\checkmark&\checkmark&\makecell{SPSysML\\/SysML}&\makecell{ES / Formal \\and detailed}&\makecell{SPE}&\makecell{ Multiple\\setups}&\checkmark&\checkmark&\checkmark&\checkmark&\makecell{Structure evaluation}\\\hline
				
			\end{tabular}
		\end{center}
		}{\vskip 0.1cm\footnotesize \raggedright
			RTD -- {Requirement tracing definition},EIV -- {Embodiment integrity verification},
                SCP -- {System creation procedure},
			SE -- {Structure evaluation},
			DE -- {supports simulated and physical components},
			DI -- Deadlock identification,
			E -- {If uncontrolled agents of the physical environment (link humans) can be modelled in the simulation},
			QE -- {If quantitative evaluation factors for system design are proposed},
			MDT -- {If a~multi Digital Twin system model is presented}, 
			ES -- {Example system as the method application procedure},
			BS -- The best selection from the previously designed,
			SPE -- Simulated-Physical design evaluation,
   N/D -- Possible, however, not defined,
			%\twci{Może pierwszy wiersz tabeli w pionie i tam dłuższe opisy?}
		}
	\end{table*}

 \section{Related work}
	\label{sec:related-work}
 \subsection{Literature review constraints}
 % The centre of gravity of our work lies in the problem from the systems engineering domain, which is complexity management and design quality measurement for cyber-physical systems consisting of simulated parts. To tackle this, we use a~model-based approach. Therefore, we focus the related work analysis on three topics: development approaches for the target systems (which may include Digital Twins), design evaluation and Domain Specification Languages (DSL), emphasising the robotics domain. 
 The key related works are described in Table~\ref{tab:related-work}, where their crucial features, including goals, are compared with SPSysML. Other works are briefly described in the following sections.

 \subsection{Simulation-physical system development}
 In \cite{4058987}, the authors note the robot development process features parallel tasks conducted by heterogeneous R\&D teams. The authors suggest system simulation enables rapid prototyping and an iterative development process. They propose the agile Robot Development (aRD) concept facilitating the integration of the hard real-time part and the non-real-time part of the system utilising a~Matlab/Simulink toolchain. 
	% They present different HIL setups organised with the aRD concept for testing robot system parts. 
    The sim2real problem is known and mentioned in the recent research results, e.g. in the domain of self-driving cars \cite{9869302}. However, to our knowledge, none of the existing works specifies a~robotic system meta-model with integrity evaluation for mixed simulation-physical setups of CPS.
	
	% Agile development implements the idea of rapid prototyping via, e.g. unit testing~\cite{10.1007/978-3-319-11900-7_22, 10.1007/978-3-540-70945-9_10}. The Robot Unit Testing methodology~\cite{10.1007/978-3-319-11900-7_22} enables covering the whole robot software with unit testing, starting from the components integrating black-boxed vendor drivers. On the other hand,~\cite{10.1007/978-3-540-70945-9_10} presents a framework for test-driven development (TDD) of multi-agent systems. TDD methodology is often used in the robotics domain.  Continuous integration is a~valuable tool for verifying a model-to-reality transformation \cite{MOSSIGE2015169}. In the CPS case, continuous integration may not be limited to software; however, it should include mechanical parts development and their integration with the software. State-of-the-art industry-implemented development operations already employ mechanical parts simulation in Gazebo for continuous integration~\cite{9557476}. None of the works proposes quantitative evaluation factors for the system design assessment before stepping into the testing or development phase.

There are reviews on CPS \cite{6853346} and DT \cite{LO2021101297} development. The CPS-related works focus on controlling a~physical object and its model in a~simulation environment with partially or fully simulated hardware. For example, the authors of \cite{8822494} use the DT approach to run the digital embodiment in a~safe virtual machine and confront the physical and digital embodiments to spot anomalies caused by a~cyber-attack. Another work \cite{ElShamoutyKleebergerLammleHuber} employs simulation-driven machine learning for robots. However, none of the works proposes a~system structure allowing exogenous actions execution in the simulated world.
    
 \subsection{System design evaluation}
Early-stage product development challenges systems engineers in designing accurate structures and architectures. Evaluating design concepts is crucial as it mightily influence both the quality and cost of the final product.

% \wdci{nawiązać do prac o mierzeniu jakości projektów systemów:
% \begin{itemize}
%     \item The authors of \cite{TIWARI201616} focus on a~designer-customer cooperation tool for choosing the best design alternatives based on assigned rough numbers to system attributes. The designer's perceptions and the changing preferences of customers are represented in numbers. Priorities are set and the best design alternative(s) are chosen using the proposed comparison rules. 
% \item 

Tools and models supporting designers in multiattribute utility analysis are the core of this research area. An example Methodology for the Evaluation of Design Alternatives (MEDA)~\cite{meda} was presented already in 1991. It is based on the subjective designer's view of the design alternative attributes, e.g. utility. Nowadays, customers play a~crucial role in the design process. The authors of~\cite{TIWARI201616} tackle the problems that arise in this situation. Priorities are set, and the best design alternative(s) are chosen using the proposed comparison rules. Multi-criteria decision-making is resolved as a~constrained multi-attribute optimisation solution \cite{1176873} or by integrating rough sets in handling vagueness with grey relation analysis~\cite{ZHAI20097072}. The system's integrity investigated in our work is another system attribute; thus, our evaluation factors values can provide unbiased, objective input to the design evaluation methods and make the design decision aware of the component reuse level between the system's simulation and physical embodiments.

\subsection{Meta-models for CPS}
Engineers use a~specific language to plan, conceptualise, and specify the system. Currently, the state-of-the-art approach is a model-based approach utilising a DSL. There are DSLs supporting verification and testing of, e.g. industry 4.0 plants \cite{8369563},  or agent-based computational systems \cite{FORTINO2012608}). Unified Modeling Language (UML) is the most known language; however, System Modeling Language (SysML)~\cite{wolny2020thirteen} is proposed by the Object Management Group (OMG) to support the design, analysis and verification/validation of complex systems comprising software and hardware components. Different Model Driven Engineering approaches exist in the robotics domain~\cite{de2021survey}. For instance, Embodied Agent-Based cybeR-physical control systems modelling Language (EARL) \cite{earl2020} is SysML specialisation for robotics which allows analysis and specification of the robotic system properties. It is based on the Embodied Agent approach~\cite{Zielinski-KAiR-eng:2021}. There are various design analysis tools based on this approach: top-down communication-based system decomposition~\cite{en15217983}, and Petri net-based design~\cite{9984822} for control deadlocks analysis~\cite{FigatZielinski-HPNmetamodel:2022}. 
It was applied to robotic and multi-modal human-machine interface~\cite{electronics9060976} systems. 
This article extends the Embodied Agent approach to the simulation and DT-related components domain. We manage this extra complexity with the proposed requirement-based design method and quantitative system design evaluation.

\section{Contribution and result validation}
\label{sec:novelty}
None of the models presented in \Sec{sec:related-work} specifies SPSys in general, especially including a~physical part without equivalent Digital Twin, simulated parts without equivalent PT, or hybrid SPSys including Twins and non-Twin components. The key novel features delivered by SPSysML are:
\begin{itemize}
    \item Integrity evaluation with quantitative factors based on SysML structure model,
    \item Guidance for the simulation-physical integrity increase measured by the quantitative factors,
    \item Requirement-based system composition method for straightforward requirement satisfaction tracing,
    \item Multiple system execution and testing setups specification,
    \item Specification of Simulation-Physical System including multiple physical and simulated parts and multiple Digital Twins,
    \item Reflection of the dynamic environment in simulation to enable Digital Twins to observe exogenous actions, e.g. human moving objects in the simulated world,
    \item A~Domain-specification Language questionnaire-based assessment by Systems Engineering practitioners,
    \item Validation of a~system design evaluation method in the robotics domain by system implementation in ROS and ROS2.
\end{itemize}

Based on our experience in SPSys development (TIAGo robot \cite{Dudek:2021_phd-twiki,rico-pprai-24-twiki,llm-pprai-24-twiki}, Velma robot \cite{en14206693}, IRP6 robot\footnote{\scriptsize Real: \url{https://youtu.be/wJpFcy99Gh0}, Simulation: \url{https://youtu.be/BjwcbSdouHw}}~\cite{motion-generation,winiarski-wozniak-2013}) and the literature analysis, we propose the SPSysML allowing software integrity evaluation between the system embodiments, and further by iterative system design, maximise the between embodiments integrity.  Complex system structuring is a broad topic, and solutions are utilised using various methods and strategies, e.g., top-down, middle-out, and bottom-up. In \cite{en15217983}, we describe a~binary communication-focused top-down approach for robotic systems. This article proposes a~requirement-based bottom-up system structuring method customised for SPSys. 

 % 	\begin{figure}[t]\centering
	% 	\includegraphics[width=\linewidth]{./figures/concept-procedure-2}
	% 	\caption{The concept of SPSys development procedure}
	% 	\label{fig:concept-procedure}
	% \end{figure}
SPSysML comprises a~componet-based Platform Independent Model (PIM), thus, can be applied to any SPSys. 
 As the system is developed, e.g. with Robot Operating Framework (ROS), it becomes a~Platform Specific Model (PSM) that can be launched in the specified setups. PSM implementation utilises platform-specific tools and software libraries. Therefore, to validate our approach, we design, implement, test and deploy a~specific SPSys. It uses the TIAGo service robot~\cite{PMF16} for the INCARE (Integrated Solution for Innovative Elderly Care) project\footnote{\url{http://aal-incare.eu/}, robot application demonstration (simulation/real) can be found accessing Demo / RAPP Store Demo}. We integrate extended voice interface and additional devices to~serve the elderly, e.g. in object transportation (\Fig{fig:tiago-transport}) and fall assistance (\Fig{fig:tiago-fall}). The system implementation is component-based and uses frameworks like \emph{ROS}~\cite{quigley2009ros,macenski2022robot}, \emph{ROS2}~\cite{maruyama2016exploring}, \emph{OROCOS}~\cite{bruyninckx2001open}, that are a~standard open-source robot control frameworks. We use two open-source simulators \emph{Gazebo}~\cite{koenig2004design} (in particular \emph{Gazebo\_ros\_control} package~\cite{gazebo-ros-control}) and \emph{O3DE}~\cite{o3de} for DT implementation. Besides validation by application, we present results of SPSysML assessment among systems engineering practitioners. To make the SPSys development easier for the community, we share the SysML profiles, the SPSysML meta-model and the example INCARE system model\footnote{\url{https://github.com/RCPRG-ros-pkg/spsysml}}. All diagrams describing SPSysML and the INCARE system are also shared~\cite{spsysml-diagrams}.

	% \section{The features of the proposed method}
	% \label{sec:requirements}
	
	% Simulation is often the first step of testing a~Robot Control System or a~robot application~\cite{staranowicz2011survey}. However, typically the end goal is to deploy the system to physical machines. Therefore, portability between the simulated and the physical embodiment needs to be easy, as composite as possible, and the behaviour of the simulated and the physical systems needs to be congruent~\cite{michel1998webots}. It is worth noting that congruence, in this case, does not always mean identity because the simulated world may be a~simplified model of the physical one. State-of-the-art works distinguish development phases, including HIL and SIL. As a~result the parts of the system in development are distributed between simulation and physical platforms. Such a~hybrid configuration requires a~careful migration process of the system parts between the embodiments. Therefore, the meta-model for SPSys must be flexible in changing embodiments of the system parts and must constrain the system parts to be congruent between the embodiments. Some parts may be deployed either in physical or simulated embodiments, but some may be deployed in both embodiments. Therefore, based on our experience in SPSys development (TIAGo robot \cite{Dudek:2021_phd-twiki}, Velma robot \cite{en14206693}, IRP6 robot\footnote{\scriptsize Real: \url{https://youtu.be/wJpFcy99Gh0}, Simulation: \url{https://youtu.be/BjwcbSdouHw}}) and the literature review we state that SPSys specification method needs to:
	% \begin{itemize}
	% 	\item be easy for the system components modification and migration between the embodiments,
	% 	\item define types of SPSys parts and their relationships,
	% 	\item define constraints for the deployment of the system and its parts, 
	% 	\item enable quantitative evaluation of the system design,
 %        \item enable multiple setups of the system (including pure simulation, pure physical, and various hybrid),
	% 	\item define a~procedure for SPSys design and development,
	% 	\item enable widely-used simulation-based verification techniques like HIL, SIL, and MIL.
	% \end{itemize}

 %    Various specialists focus on specific problems and contribute to robot control software worldwide. Therefore, it is beneficial for one specialist to use the components already created by others. Reusing software supports the creation of reliable software in a shorter time~{\cite{luckcuck2019formal}}. SPSysML is PIM, thus it applies to component-based frameworks like \emph{ROS}, \emph{OROCOS}, \emph{Gazebo} (in particular \emph{gazebo\_ros\_control} package \cite{gazebo-ros-control}) and has the above features. 


 
	\section{Simulation-Physical System}
 Simulation-Physical Systems Modeling Language (SPSysML) is based on SysML and EARL.
	In the following sections, we describe SPSysML, which defines a~stereotype-based meta-model of requirements and system structure. Description of a~DSL requires a~notation for multiple blocks or instances of a~stereotype (e.g. two instances of \stA{}). For this purpose, we append the stereotype with \textit{s}~(e.g. \stA{}\textit{s}). We refer to an instance of a stereotype using the \Part{part-name}{\textit{<<stereotype>>}} symbol.

 \subsection{SPSysML -- requirements meta-model for SPSys}
	\label{sec:requirement-model}
	
	
We define a~stereotype-based model of requirements (\Fig{fig:requirement-model}). The stereotypes explicate SysML requirement diagrams used for designing SPSys with SPSysML.

	\begin{figure}\centering
		\includegraphics[width=\linewidth]{./schemes/profile/requirement_stereotypes_generalisation_cd.png}
		\caption{Model of system requirements defined for SPSys}
		\label{fig:requirement-model}
	\end{figure}

 SPSysML specifies the requirements model as~SysML profile. The requirements can be defined based on various premises. In particular, they can derive from user requirements \cite{dos2008model}. The SPSysML profile defines structural, functional, configurational and environment requirements. Other requirement types can be added; however, these are used in system setups' specification and requirement-based system composition. Auxiliary sequence diagrams presenting the concept of the system behaviour and use case diagrams are useful for defining requirements. Before SPSys requirements specification, its environment must be analysed. In SPSysML, we distinguish \stEAR{} being a part of the environment requirements that specify exogenous agents interacting with the world alongside the system. The system functions given by \stFR{} stereotyped requirements are classified into:
 \begin{itemize}
     \item simulation-physical, which require perceiving or affecting the simulated/physical world--- \stSPFR{}, 
     \item computational, which do not interact directly with any simulated/physical world--- \stCFR{}.
 \end{itemize}
 Each \stFR{} requirement must be performed by a~system part; thus \stREQ{SysPartReq} stereotyped requirements must be specified. As shown in \Fig{fig:requirement-model}, they must satisfy, verify, and derive from their origin--- \stFR{}. In SPSysML, the system structure is based on the requirements of \stREQ{SysPartReq}\textit{s} stereotype. Each \stREQ{SysPartReq} is classified as elementary \stREQ{HardwareReq} or one of more general \stREQ{PhyPartReq}, \stREQ{SimPartReq} or \stREQ{SimPhyPartReq}. 
 \begin{itemize}
     \item \stREQ{PhyPartReq} determines a~part interacting only with the Physical World (even during the system development, e.g. during parallel development of the connected parts), and its simulated embodiment is not required (or cannot be created) during the system development.
     \item \stREQ{SimPartReq} specifies a~part interacting only with the Simulated World (e.g. mock-ups or demonstrators).  \stREQ{SimPhyPartReq} interacts with both Worlds (e.g. realised with a~pair of DT and PT).
     \item \stREQ{HardwareReq}\textit{s} are in a~\textit{satisfy} relationship with \stFR{}\textit{s}. This means hardware requirements specified with a~\stREQ{HardwareReq} enable the realisation of the functionality specified with the given \stFR{}.
 \end{itemize} 
	 The configurational stereotypes specify if a~system part (\stPR{}) or a~system function (\stFR{}) is obligatory to launch the system in all of its setups. Configurational stereotypes are orthogonal to structural and functional stereotypes; thus, functional and structural requirements may be either \stREQ{ObligatoryReq} or \stREQ{OptionalReq}. However, a~\stPR{} realising a~\stFR{} derives its configurational stereotype from the functional requirement. Each \stREQ{OptionalReq,FunctionalReq} gives the system more setups, and the number of the setups equals $2^n$, where $n$ is the number of \stREQ{OptionalReq,FunctionalReq}. As a result, \begin{itemize}
          \item \stREQ{ObligatoryReq,FunctionalReq} requirements define the core system's functions,
	     \item \stREQ{OptionalReq,FunctionalReq} requirements manage the system's versatility by dividing the system into system setups with different functionality,
	     \item \stREQ{ObligatoryReq,SysPartReq} requirements define the system's core components,
          \item \stREQ{OptionalReq,SysPartReq} requirements define the system's components for different functionality setups.
          \end{itemize}


	\subsection{SPSysML -- structure of SPSys}

 \label{sec:pl-structure}
	SPSysML derives from EARL \cite{earl2020} version 1.3~\cite{earl-1.3}. In a~SPSys we differentiate three specialisations of the \stA{} stereotype defined in EARL (\Fig{fig:dual_embodied_system_bdd}):
	\begin{itemize}
		\item \textit{Physical Agent} (\stPA{}) -- Runs only in the physical embodiment (in particular Agent interacting with or sensing real world),
		\item \textit{Simulation Agent} (\stSA{}) -- Runs only in the simulated embodiment (in particular Agent interacting with or sensing simulated world),
		\item \textit{Hybrid Agent} (\stHA{}) -- Runs in both embodiments and computes without interacting or perceiving any world.
	\end{itemize} 
	
	\begin{figure}\centering
		\includegraphics[width=\linewidth]{./schemes/spsys/dual_embodied_system_bdd.png}
		\caption{Simulation-Physical System composition}
		\label{fig:dual_embodied_system_bdd}
	\end{figure}
	
	
	The Groups of Agents called \textit{World Mirror Group of Agents} aggregate \stSA{}\textit{s} that are Digital Twins of the Agents in the Physical World that are not controlled by the physical embodiment of the system. They execute exogenous actions in the Simulated World. Groups of this type exist if the system works in a~dynamic environment (e.g. an environment with human inhabitants). For example, a~\textit{World Mirror Group of Agents} modifies the Simulated World as humans do in the Physical World. 

An agent is composed of Subsystems of different types as specified in EARL. Types of Subsystems are defined in~\ref{sect:subsystem_types}. We use a~Group of Subsystems (\stGpS{}) to gather Subsystems with a~specific common properties, and a~Group of Agents (\stGpA{}) to organise the Agents (composed of Subsystems) cooperating for a~defined aim in the system. 

\subsubsection{Digital Twins in SPSys}
Integrity between SPSys embodiments is crucial. Therefore, creating DT of a~physical parts is advisable and common. We define the \texttt{mirror} relationship between \stPA{} and \stSA{} to model the relationship between DT and its PT. To enable multi-agent DT for a~single \stPA{} and vice versa, we introduce \stMPGA{} and \stMSGA{}. They aggregate Agents of different stereotypes (\Fig{fig:msga_mpga_bdd}).

	\begin{figure}\centering
		\includegraphics[width=\linewidth]{./schemes/spsys/msga_mpga_bdd.png}
		\caption{SPSys composed of 0...* Digital Twins (+dt) and Physical Twins (+pt) realised with \stMSGA{} and \stMPGA{} accordingly}
		\label{fig:msga_mpga_bdd}
	\end{figure}
 
	The definition of the \texttt{mirror} relationship is as follows:
	
	\begin{definition}[Mirror relationship]
		{\it Two Groups of Agents are said to be in a {\rm mirror relationship} if their input buffers and goals are the same and affect Simulated and Real Worlds congruently. The relationship is an association between Digital and Physical Twins.}
	\end{definition}
It is worth noting that the same stimuli of the mirroring Groups cause corresponding reactions in specific worlds, in the Simulated World for \textit{Mirror Simulation Group of Agents} and in the Physical World for {\textit{Mirror Physical Group of Agents}}. The particular reaction results from the requirements of the specific system and does not need to be identical between the Agent Groups that mirror each other. A~stimuli for a~Group of Agents is the input from other Agents or the environment through the interfaces. Agent's reaction to a~stimuli manifests as the Agent state change (including changes in memory or output data).
\paragraph*{\textbf{Example DT-PT pair}}
Considering a~pan-tilt head as an example, \stMSGA{} is the simulated head, and \stMPGA{} is the real one. The stimuli of this DT-PT pair include the light perception from the according world (simulated/physical) and the control for the head joints. The common reaction is data in their output interface. The DT (\stMSGA{}) for a~pan-tilt head development is a convenient tool, e.g. for servovision implementation or joint constraints evaluation. SPSys may consist of multiple such pairs, e.g. manipulator and mobile base in a~service robot case.

\paragraph*{\textbf{Constaints and guides for DT-PT pair}}
The mirror relationship does not propagate automatically to all the Agents aggregated in the mirroring Groups, so agents from \stMSGA{} do not mirror all agents of mirroring \stMPGA{} and vice versa.
	
The number of Agents outside DT/PT pairs should be minimised to maximise coverage of simulation-based testing and analysis. Additionally, the complexity and quantity of mirroring Agent Subsystems should be minimised to boost the modularity and integrity of the system. Otherwise, the system could be composed of just two mirroring agents. If a~computational functionality is required in both embodiments, a~\stHA{} should be designed for this purpose.

	\subsubsection{Subsystem types}\label{sect:subsystem_types}	The Agents are built with Subsystems of different types. In EARL, the central computational part of an Agent is the Control Subsystem \stCS{}. An Agent communicates with other Agents using communication buffers of its \stCS{}. To percept the environment, an Agent uses Real Receptors (\stRR{}\textit{s}), and to aggregate and preprocess stimuli, it uses Virtual Receptors (\stVR{}\textit{s}). To affect the environment, an Agent uses Real Effectors (\stRE{}\textit{s}). To preprocess \stCS{} commands to signals for \stRE{}\textit{s}, it uses Virtual Effectors (\stVE{}\textit{s}). Detailed description and SysML diagrams of Agent structure and behaviour are published in~\cite{earl2020}. 
 
	SPSys interacts with both the simulated and physical world; thus, SPSysML differentiates between the types of the above Subsystems--- Simulated, Physical, and Simulated-Physical.
	To achieve maximum integrity between the simulated and physical embodiments, all \stCS{}\textit{s} should be Simulated-Physical (\stDCS{} stereotype) and constitute the general concept of the shared controller, recall~\Fig{fig:concept}. For iterating design purposes, embodiment-specific Control Subsystems concepts (\stPCS{} and \stSCS{}) may be helpful. Virtual and real effectors/receptors can be Simulated or Physical. In SPSysML we group them in four \stGpS{} that aggregate receptors and effectors for each embodiment--- simulated and physical~(\Fig{fig:hardware_group_bdd},
 \Fig{fig:drivers_group_bdd}). Real effectors/receptors are hardware parts, and Virtual effectors/receptors are their drivers.
 
 In complex systems, one \stDCS{} may communicate with many Simulated/Physical Virtual Receptors and Effectors. In this case, the \stDCS{} is reused in \stSA{} and \stPA{}, and both utilise embodiment-specific hardware and drivers. The data flow and communication links for \stDCS{} interacting with Simulated and Physical Worlds are shown in (\Fig{fig:inter-subsystem-interfaces}).
	
 \begin{figure}
     \centering
     \includegraphics[width=\linewidth]{schemes/spsys/hardware_group_bdd.png}
     \caption{Embodiments of Real Effectors and Receptors}
     \label{fig:hardware_group_bdd}
 \end{figure}
 \begin{figure}
     \centering
     \includegraphics[width=0.8\linewidth]{schemes/spsys/drivers_group_bdd.png}
     \caption{Embodiments of Virtual Effectors and Receptors}
     \label{fig:drivers_group_bdd}
 \end{figure}
 
    \begin{figure}[t]\centering
        \includegraphics[width=.9\linewidth]{./figures/ibd-subsystems.pdf}
        \caption{Interfaces between Subsystem Groups on example, where two agents share \stDCS{}}
        \label{fig:inter-subsystem-interfaces}
    \end{figure}
	
 
 
	% \begin{itemize}
	% 	\item \textit{Physical Drivers} \stGpS{} -- compose all \textit{Physical Virtual Receptor} and \textit{Physical Virtual Effector},
	% 	\item \textit{Physical Hardware} \stGpS{} -- compose all \textit{Physical Real Receptor} and \textit{Physical Real Effector} and affect/sense the Physical World,
	% 	\item \textit{Simulated Drivers} \stGpS{} -- compose all \textit{Simulated Virtual Receptor} and \textit{Simulated Virtual Effector},
	% 	\item \textit{Simulated Hardware} \stGpS{} -- compose all \textit{Simulated Real Receptor} and \textit{Simulated Real Effector} and affect/sense the Simulated World,
	% \end{itemize} 
 \paragraph*{\bfseries Agent composition constraints}
Each Agent type defined in SPSysML aggregates a~particular number of Subsystems of a~specific type~(\Fig{fig:agent_bdd}).
	\begin{figure}\centering
		\begin{subfigure}[]{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/spsys/physical_agent_bdd.png}
			\caption{Physical Agent}
			\label{fig:physical_agent_bdd}
		\end{subfigure}
		\begin{subfigure}[]{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/spsys/simulation_agent_bdd.png}
			\caption{Simulation Agent}
			\label{fig:simulation_agent_bdd}
		\end{subfigure}
		\begin{subfigure}[]{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/spsys/hybrid_agent_bdd.png}
			\caption{Hybrid Agent}
			\label{fig:hybrid_agent_bdd}
		\end{subfigure}
		\caption{Subsystems aggregated by Agent classes}
		\label{fig:agent_bdd}
	\end{figure}
	It should be noted that the Basic EARL meta-model defines only one \stCS{} in an Agent, and inter-agent communication is handled only by the \stCS{}. In SPSysML, we differentiate between specific types of \stCS{} for the embodiments; still, an Agent can aggregate just one specialisation of \stCS{}. 
 
  \paragraph*{\bfseries System setups composition}
   SPSys can be deployed in various setups (e.g. testing setups). The setups are a~Group of Agents fulfilling the system's functionality in the setup. For the system setup definition, we use \stSSGA{} to specify the Group of Agents working in the setup. The set of agents composing \stSSGA{} is derived from the system's requirements and test scenarios.
 
 
\paragraph*{\bfseries Example Physical embodiment realisation} Subsystems in a~\stPHGS{} (sensors/actuators) communicate with their drivers via various interfaces (e.g. Linux kernel driver for Inter-Integrated Circuit (I$^2$C) or network interface). \stPDGS{}\textit{s} take data from these interfaces, aggregate it and expose their interface for a~\stCS{} executing the logic of the Agent. 

\paragraph*{\bfseries Example Simulated embodiment realisation} Subsystems in \stSHGS{} expose Application Programming Interface (API) classes, defined in the simulation environment (e.g. gazebo::ModelPlugin for \stSRE{} and gazebo::SensorPlugin for \stSRR{} in Gazebo\footnote{a~popular simulation environment used in the DARPA Robotics Challenge, in July of 2013}). Subsystems of \stSDGS{} connect to these interfaces using the API, aggregate sensor data, and respond \stCS{}\textit{s} control. 

The connections between the groups are shown in \Fig{fig:inter-subsystem-interfaces}.
	
 % Communication between the Subsystems of different Agent instances is separated, e.g. by the Agent's individual namespace prefix.


 \section{The design evaluation factors}
 \label{sec:evaluation-factors}
 We recognise the following integrity factors classified for design analysis in two scopes:
    \begin{itemize}
      \item System-wide:
        \begin{itemize}
			\item \textbf{Controller integrity factor} (\texttt{IIF}=$\frac{c^{dcs}}{c^{All}}$), where $c^{dcs}$ and $c^{All}$ are the cardinalities of \stDCS{}\textit{s} and all system \stCS{}\textit{s} accordingly, 
      			\item  \textbf{Driver generalisation factor} (\texttt{DGF}=$\frac{r_u}{r}$), where $r_u$ is the count of Real Subsystems aggregated in an Agent controlled by a~\stDCS{} and $r$ is the count of all Real Subsystems in the system,
   
			\item \textbf{Digital Twin coverage} (\texttt{DTC}=$\frac{a_{P}^{m}}{a_{P}^{All}}$), where $a_{P}^{m}$ is the count of \stPA{} aggregated in a~\stMPGA{} being a~PT of a~DT (\stMSGA{}), and $a^{P}_{All}$ is the count of all \stPA{} in the system,
     \end{itemize}
     \item DT/PT pair-wide:
     \begin{itemize}
			\item \textbf{Mirror integrity factor} (\texttt{MIF}$_{n}$=$\frac{c_{n}^{dcs}}{c_{n}^{All}}$), where {\textit{n}} is the considered pair of mirroring \stMPGA{} and \stMSGA{} composing one DT/PT pair, $c_{n}^{dcs}$ and $c_{n}^{All}$ are the counts of \stDCS{}\textit{s} and all \stCS{}\textit{s} accordingly in {\textit{n}$^{th}$} DT.
     \end{itemize}
  \end{itemize}
  
Below, we present the interpretation of the evaluation factors and the correlation between the factor values and the SPSys features. We do it by describing the characteristics of edge case SPSys that scores maximum or minimum values of the design evaluation factors:
 \begin{itemize}
			\item \texttt{IIF} -- is a~share of the software controller common between the embodiments. Virtual Subsystems are not considered, as their count may be related to the Real Subsystem counts in each embodiment. It is maximised by the reduction of the number of \stSCS{}\textit{s} and \stPCS{}\textit{s} in favour of an inter-embodiment \stDCS{}\textit{s}, {The higher} \texttt{IIF} is, the more software components are shared between the simulation and physical embodiments. At maximum (\texttt{IIF}=1), all hardware abstract parts of the system are common. 
 \begin{itemize}
     \item \texttt{IIF} = 0: There are no \stDCS{}, only \stPCS{} or \stSCS{}. The system’s parts in simulated and physical embodiments are disjunctive. Simulation-based testing is not possible. The system’s functions in the simulation may be completely different from those in the physical embodiment.
     \item \texttt{IIF} = 1: All Control Subsystems are \stDCS{}, and there are no \stPCS{} or \stSCS{}. This means all hardware abstract parts of the system are common between its embodiments, and the coverage of simulation-based testing is maximised and allows integration testing in simulation.
     \end{itemize}
			\item \texttt{MIF}$_{n}$ -- is a~share of the system parts common between Physical and Digital Twins composing the \textit{n}$^{th}$ twin pair (managing given \stREQ{SimPhyPartReq}). It is similar to~\texttt{IIF} but within the scope of $n^{th}$ pair of Physical and Digital Twin. { Tips for maximisation of the \texttt{MIF}$_{n}$ factor} are: \begin{itemize}
			    \item extraction of common functions as \stHA{}\textit{s} from \stMPGA{} and \stMSGA{} \item and/or redesign of interfaces between a~\stSCS{} and \stSDGS{} and between a~\stPCS{} and \stPDGS{} to emerge a~common \stDCS{} from the  \stSCS{} and \stPCS{},
       
			\end{itemize}
			\item \texttt{DGF} -- is a~share of Real Subsystems (hardware) controlled by \stDCS{}\textit{s} (shared controller). It expresses hardware control integrity between the embodiments.
   
     \begin{itemize}
     \item \texttt{DGF} = 0: All Hardware parts are controlled by embodiment-specific Control Subsystems. The causes of this depend on a specific case:
     \begin{itemize}
     \item For Physical Hardware without a~DT, it means the interface to hardware is embodiment-specific; thus, extending the system with a~DT of the hardware is complicated and would require adding simulation-specific \stSCS{}.
     \item For Physical Hardware with a~DT, it means the Hardware Drivers interface of Physical and Digital Twins differ, and the software using the interface differs between the embodiments. This means the system part designed as DT of the Physical hardware is not a~proper DT.
 \end{itemize}
     \item \texttt{DGF} = 1: All Hardware parts are controlled by embodiment-abstract Control Subsystems; thus, the Agents managing hardware are interchangeable between the embodiments, or future Digital/Physical Twin integration for Physical/Simulated Hardware is straightforward.
     
     \end{itemize}
			\item \texttt{DTC} -- is a~share of hardware and its controllers mirrored with a~DT. Its increase boosts coverage of simulation-based testing of hardware controllers and system robustness utilising the DT concept. If \texttt{DTC} = 0, there are no DTs in the system; if \texttt{DTC} = 1, all Physical Hardware parts have DTs.
		\end{itemize}
 Based on the factors' values, one can evaluate the system design in terms of:
 \begin{itemize}
     \item Safety and hardware independence during software testing -- based on \texttt{IIF} (for system scope), \texttt{MIF}$_n$ (for $n^{th}$ DT),
     \item Simulation-based testing and failure examination/prediction of the system parts  -- based on \texttt{DTC}
     \item Inter-embodiment integrity of hardware controllers and readiness for simulation-based hardware testing  -- based on \texttt{DGF}.
 \end{itemize}
Maximisation of these factors is not always required, and the optimisation goal can be set at a different point in the factors' space. The goal depends on the specific system requirements. However, the factors' values inform the designer about the inter-embodiment integrity of the system design, so her/his decision is conscious.


	\section{SPSysML Validation}
 First, we describe the SPSysML validation by application. It includes the requirement-based system composition, design evaluation, and applicability in the system development procedure~\ref{sec:example-system}. Next, we share the results of the SPSysML assessment done among systems engineering practitioners, including a third-party SPSysML user~\ref{sec:assessment}.  
 \subsection{ Example system design and analysis}
	\label{sec:example-system}

SPSysML was used in developing complex SPSys utilising a~service robot for the INCARE project. This is the primary validation of SPSysML. The INCARE system idea and requirements are published in \cite{brenvcivc2020intuitive}. The framework model developed to manage robot tasks is published in \cite{Dudek-multitasking-romoco-2019, tasker2020}.
	Developing a~complex system requires different implementations of its parts in various development phases. In INCARE, we use some commercial products like the TIAGo robot with its control system. We develop and integrate new parts into the system (e.g. human fall detector and TIAGo audio interface extension). 
 % In such a~case, developing one part requires a~dummy of another part while being developed simultaneously. Developers can simulate the underdeveloped parts while the physical devices are under construction or development. In the case of INCARE, we use a~dummy for the human fall detector while developing a~TIAGo robot application helping the elderly who may fall over. 
 We use and modify the TIAGo robot in this project; thus, we specify its hardware and controller as a~part of the INCARE system specification. We present the result of the SPSysML application in the following SPSys development tasks. 
	\paragraph*{\bfseries Requirement engineering}
	In these steps, we use the requirement model defined in SPSysML. We specify the structural and functional requirements based on the general requirements of the INCARE project. The general and the robot-specific requirement diagrams are shown in~\Fig{fig:incare_req}.
 	\begin{figure}
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/incare_main_req.png}
			\caption{INCARE structural requirements}
			\label{fig:main_req}
		\end{subfigure}
		%	\end{figure}
		%	\begin{figure}[h]
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/robot_req.png}
			\caption{The Robot requirements, where TTS and STT are text-to-speech and speech-to-text functions}
			\label{fig:robot_req}
		\end{subfigure}
		\caption{Example part of the INCARE requirements}
		\label{fig:incare_req}
	\end{figure}
 The requirements were accepted after some Step~1$\leftrightarrow$Step~2 iterations. These iterations led, for instance, to the decomposition of the \Part{Communication with humans}{\stSPFR{}}  to \Part{TTS and STT}{\stSPFR{}} and \Part{Dialoge management}{\stCFR{}}.
	
	\paragraph*{\bfseries Exogeneity identification}  The robot in the INCARE project coexists with humans being exogenous agents from its perspective; thus, we utilise \Part{WorldSync}{\stWMGA{}} to manage humans in the Simulated World. Detailed specification and realisation of \Part{WorldSync}{\stWMGA{}} is available in~\cite{hubero}.
	
	\paragraph*{\bfseries System composition} System structuring resulted in the system composed of 5 embodiment-specific Agents, one for each system part: 
 \begin{itemize}
     \item \Part{TIAGo}{\stSA{}} mirroring \Part{TIAGo}{\stPA{}}, 
     \item \Part{FallDetector}{\stSA{}} mirroring \Part{FallDetector}{\stPA{}}, 
     \item \Part{SmartHome}{\stPA{}}. 
 \end{itemize}
 Additionally, there are 3 Hybrid Agents, one for each computational function of the system:  \begin{itemize} 
 \item \Part{ComplexTaskExecution}{\stHA{}}, 
 \item \Part{Talker}{\stHA{}}, 
 \item \Part{FakeAudio}{\stHA{}}. 
 \end{itemize}
There are two DT-PT pairs:
\begin{itemize} 
\item one resulting from the requirement \Part{Robot}{\stSPPR{}}:
\begin{itemize}
    \item \Part{Robot}{<<MirrSimGpAgents>>} being a~DT composed of \Part{TIAGo}{\stSA{}}, \Part{FakeAudio}{\stHA{}} and \Part{Talker}{\stHA{}}, 
\item \Part{Robot}{<<MirrPhyGpAgents>>} being PT composed of \Part{TIAGo}{\stPA{}} and \Part{Talker}{\stHA{}}.
\end{itemize}
\item one resulting from the requirement \Part{Fall Detector}{\stREQ{OptionalReq,SimPhyPartReq}}:
\begin{itemize}
\item \Part{FallDetector}{\stSA{}} as DT
\item \Part{FallDetector}{\stPA{}} as PT.
\end{itemize}
\end{itemize}
	
	
	\paragraph*{\bfseries Agent decomposition} To provide an example, we describe the final decomposition of two \Part{TIAGo}{\stSA{}} realisations (\texttt{O3deTIAGo} (\Fig{fig:tiago_sim_o3de_ibd}) being the robot simulator implemented in the O3DE simulator and \texttt{GazeboTIAGo} (\Fig{fig:tiago_sim_gazebo_ibd}) implemented in Gazebo) and \Part{TIAGo}{\stPA{}} (\Fig{fig:tiago_phy_agent_ibd}) which mirrors the previous ones. Each robot hardware component is specified as either \stPRR{}, \stPRE{}, \stSRR{}, or \stSRE{}. \Part{O3deTIAGo: TIAGo}{\stSA{}} integrates the system with O3DE simulation environment; thus, \stSRR{}\textit{s} and \stSRE{}\textit{s} are core O3DE components interacting with the simulated world, called gems. \Part{GazeboTIAGo: TIAGo}{\stSA{}} integrates the system with Gazebo simulation environment; thus, \stSRR{}\textit{s} and \stSRE{}\textit{s} expose gazebo::SensorPlugin and gazebo::ModelPlugin interfaces accordingly. As the physical robot, we use PAL Robotics' TIAGo; thus, \stPRR{}\textit{s}, \stPRE{}\textit{s} interfaces are adequate Linux Kernel drivers managing communication with the devices. In \Part{GazeboTIAGo: TIAGo}{\stSA{}} case, the Simulated Drivers connect to the gazebo::SensorPlugin and gazebo::ModelPlugin interfaces and expose the robot state information and typical ROS topics/services (e.g. \textit{JointStateInterface} and \textit{EffortJointInterface} for \Part{MobileBaseController}{\stSVE{}}\footnote{This \stVE{} is based on \textit{gazebo\_ros\_control} package: \url{https://classic.gazebosim.org/tutorials?tut=ros_control} } and \textit{/scan} ROS topic for \Part{lidar}{\stSVR{}}). If Simulated World is the Gazebo environment, \stSVE{}\textit{s} and \stSVR{}\textit{s} are usually implemented as Gazebo Plugins. \stPDGS{} connects to Linux Kernel drivers and, as a~whole Group, exposes to \stCS{} identical interfaces as \stSDGS{}. The diagrams of the TIAGo robot agents (simulated and physical) show their common \Part{RobotIf}{\stDCS{}}; however, the physical robot and Gazebo simulator run \Part{ROS1: RobotIf}{\stDCS{}}, and O3DE simulator runs \Part{ROS2: RobotIf}{\stDCS{}}. 
		
	\begin{figure}
		\centering
			\centering
			\includegraphics[width=0.9\linewidth]{./schemes/incare/tiago_o3de_ibd.png}
			\caption{IBD of \Part{O3deTIAGo: TIAGo}{\stSA{}}}
			\label{fig:tiago_sim_o3de_ibd}
			
	\end{figure}	
	\begin{figure}[t]
	
			\centering
			\includegraphics[width=0.9\linewidth]{./schemes/incare/tiago_gazebo_ibd.png}
			\caption{IBD of \Part{GazeboTIAGo: TIAGo}{\stSA{}}}
			\label{fig:tiago_sim_gazebo_ibd}
			
	\end{figure}	
	\begin{figure}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/tiago_phy_agent_ibd.png}
			\caption{IBD of \Part{TIAGo}{\stPA{}}}
			\label{fig:tiago_phy_agent_ibd}
	\end{figure}	
		
	\paragraph*{\bfseries Structure evaluation} The final structure evaluation resulted with: \texttt{IIF}=1, \texttt{MIF}$_{Robot}$=1, \texttt{MIF}$_{FallDetector}$=1, \texttt{DGF}=1, and \texttt{DTC}=0.67. The result means the structure consists of no \stSCS{} or \stPCS{}, and one \stPA{} is not mirrored by a~DT--- \Part{SmartHome}{\stSA{}}. The lack of DT for \Part{SmartHome}{\stSA{}} results from the requirements (\Fig{fig:main_req}), where Smart Home is not \stSPPR{}); thus, as the requirement is not modified, this case is the designer's informed decision. \texttt{DGF}=1 means the considered \Part{SmartHome}{\stSA{}} has \stDCS{}; therefore, its control subsystem can be shared with a~DT, if one will be required in the future. One of the previous design iterations resulted with:  \texttt{IIF}=$\frac{5}{7}=0.71$, \texttt{MIF}$_{Robot}$=1, \texttt{MIF}$_{FallDetector}$=0, \texttt{DGF}=$\frac{20}{22}=0.91$, \texttt{DTC}=0.67. In this iteration the \Part{FallDetector}{\stSA{}} and \Part{FallDetector}{\stPA{}} use embodiment specific control layer (\stSCS{} and \stPCS{}), because \Part{FallDetector}{\stSA{}} consists \stSCS{}, which can not be shared with its DT. To increase \texttt{MIF}$_{FallDetector}$ and \texttt{DGF} the common part of \Part{FallDetector}{\stSCS{}} and \Part{FallDetector}{\stPCS{}} was extracted. The common part constitutes \Part{FallDetector}{\stDCS{}} in the final design.
 % \wdci{This is a~tip for developers to increase embodiments integrity. It should be highlighted in the conclusions and the result analysis.}
 The \Part{FallDetector}{\stDCS{}} becomes a~universal interface between \Part{ComplexTaskExecution}{\stHA{}} and the driver layer of \Part{FallDetector}{\stPA{}}. It forced decomposition of \Part{FallDetector}{\stSA{}} to \Part{FallDetector}{\stDCS{}}, \Part{FallDetector}{\stSVR{}} and \Part{FallDetector}{\stSRR{}}. The latter two simulate Fall Detector sensing. Thanks to the design evaluation,  \Part{FallDetector}{\stDCS{}} is used in both embodiments in the final structure, and this part of \texttt{FallDetector} will be tested in simulation because it is common in simulated and physical embodiments of the system.

	\paragraph*{\bfseries Configurability definition} Based on the \stREQ{OptionalReq}\textit{s} in the requirements we define 6 \stSSGA{}\textit{s} composing of:
 \begin{itemize}
     \item \Part{FallDetector}{\stPA{}} or \Part{FallDetector}{\stSA{}} or no FallDetecor, and
     \item \Part{Robot}{\stMPGA{}} or \Part{Robot}{\stMSGA{}}). 
 \end{itemize}
 We show \Part{Simulated}{\stSSGA{}} (\Fig{fig:simulated_sega_ibd}) and \Part{Physical}{\stSSGA{}} (\Fig{fig:physical_sega_ibd}) Internal Block Diagrams (IBDs) to exemplify \stSSGA{} specification. \Part{Simulated}{\stSSGA{}} presents two realisations of \Part{TIAGo}{\stSA{}}--- \texttt{GazeboTIAGo} and \texttt{O3deTIAGo}.  

	\begin{figure}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/simulated_sega_ibd.png}
			\caption{\Part{Simulated}{\stSSGA{}} with example requirement allocations}
			\label{fig:simulated_sega_ibd}
			
	\end{figure}
	\begin{figure}[t]
		
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/physical_sega_ibd}
			\caption{\Part{Physical}{\stSSGA{}} with example requirement allocations}
			\label{fig:physical_sega_ibd}
	\end{figure}
  
	\paragraph*{\bfseries Implementation} In INCARE the \Part{Robot}{\stPA{}} and \Part{Robot}{\stSA{}} are realised with TIAGo robot and its simulations. PAL Robotics mostly implemented these.
	We mapped the robot hardware and software to our design (as shown in \Fig{fig:tiago_sim_o3de_ibd}, \ref{fig:tiago_sim_gazebo_ibd} and \ref{fig:tiago_phy_agent_ibd}).  \Part{RosControl}{\stSDGS{}} is a~software package\footnote{\url{http://wiki.ros.org/ros_control}} implementing various common ROS controllers, and \Part{SimTIAGoDrives}{\stSHGS{}} is a~package\footnote{\url{http://wiki.ros.org/pal_hardware_gazebo}} implementing Gazebo plugins controlling TIAGo drives.
	Additionally, we improved the robot's voice communication by integrating a Large Language Model for user request interpretation~\cite{llm-pprai-24-twiki}. We equipped \Part{TIAGo}{\stPA{}} with additional USB Microphones \cite{arvix-tiago} to improve its audio perception. \Part{Complex Task Execution}{\stHA{}} is realised with TaskER framework~\cite{tasker2020,Dudek:2021_phd-twiki}. 
 % The other \stA{}\textit{s} were implemented and tested following the simulation implementation factor. In the result, we got \Part{Simulated}{\stSSGA{}} implemented and tested before \Part{Physical}{\stSSGA{}}, what improved robot system development safety.
    The simulated and physical worlds' synchronisation feature (mirroring humans in the Simulated World) was implemented with HuBeRo framework as \Part{WorldSync}{\stWMGA{}} and tested in a~crowded hospital environment (\Fig{fig:hubero-sim}).
      \begin{figure}
      \centering
      \includegraphics[width=0.7\columnwidth]{figures/human-sim.jpg}
      \caption{A frame from \Part{WorldSync}{\stWMGA{}} testing.}
      \label{fig:hubero-sim}
  \end{figure}
  
\paragraph*{\bfseries Validation} 
	The INCARE system was deployed and validated in an end-user home, and the videos present its performance in the example tasks--- transportation (\Fig{fig:tiago-transport})\footnote{\url{https://vimeo.com/670252925}} and fall assistance (\Fig{fig:tiago-fall})\footnote{\url{https://vimeo.com/670246589}}. 
 % \wdci{Odwołąć się do walidacji wykonanej przez Stocznię w INCARE-- dokument od TW na mailu}
 
\subsection{SPSysML assessment}
\label{sec:assessment}
Based on the open-source SPSysML documentation, a~third-party developer designed a~system for quantitative evaluation of autonomous vacuum cleaner navigation algorithm~\cite{vacuum-cleaner-github}. This design activity scored the best possible evaluation factor values. The designer is sure the requirement-based system structuring helps in comprehensive analysis and would use it again as it simplifies CPS design. He commented on the SPSysML: {\it SPSysML promotes wider simulation-based V\&V of the system's change, and evaluation factors help validate and point out the system's weak parts. However, I am unsure how to implement hybrid agents in ROS, e.g., the same communication topics and structure. Early decomposition is the hardest part of the SPSysML application.}

To evaluate our methodology wider, we asked systems engineering and robotics practitioners to assess SPSysML from various points of view. The questions regard individual experience~\Fig{fig:attenders-tasks}, SPSysML utility~\Fig{fig:change-analysis-utility}, factor improvement guidance~\Fig{fig:factor-guidance}, drawbacks, difficulties and our methodology coupling possibilities with standard tools like Zachman Framework~\cite{BONDAR201733} and V-model~\cite{grassler2021v}. Finally, the responders assessed our methodology against the qualities of great models~\Fig{fig:qualities-assessment}. The key questionnaire form and all results are published\footnote{\url{https://github.com/RCPRG-ros-pkg/spsysml}}. The example responses include drawbacks:
\begin{itemize}
    \item \textit{Evaluation factors might be abused as the importance of components is not taken into account}
    \item \textit{The proposed design evaluation factors are not clearly understandable without a good grasp of SPSysML.}
    \item \textit{With a large number of requirements that have a complex structure, the diagrams may be unreadable. The solution would be a requirements association table.}
\end{itemize}
and advantages:
\begin{itemize}
    \item \textit{SPSysML certainly gives you the opportunity to evaluate the system architecture and make conscious design decisions.}
    \item \textit{At early stage of system development SPSysML can show some issues regarding  system design }
    \item \textit{Joining simulation and physical models provides numerous benefits. SPSysML allows to clearly depict this in system architecture.}
    \item \textit{SPSysML is a systematic framework for joining simulation and physical systems. This process can be controlled with SPSysML.}
\end{itemize}
All responders would apply the requirement-based composition, and eight of nine would apply SPSysML for system specification and design evaluation.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.6\linewidth]{questionnaires/results/attenders-tasks.png}
    \caption{Tasks in which the responders utilise simulation.}
    \label{fig:attenders-tasks}
\end{figure}
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.7\linewidth]{questionnaires/results/change_analysis.png}
    \caption{How SPSysML would help you in change analysis of a complex CPS?}
    \label{fig:change-analysis-utility}
\end{figure}
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.7\linewidth]{questionnaires/results/clear-rules.png}
    \caption{Clarity of the factor-based rules for integrity improvement.}
    \label{fig:factor-guidance}
\end{figure}
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.8\linewidth]{questionnaires/results/qualities-of-great-models.png}
    \caption{SPSysML assessment against qualities of great models: 1) Linked to Decision Support, 2) Model Credibility, 3) Clear Scope, 4) V\&V With Model, 5) Well-Organized, 6) Analyzable and Traceable, 7) Data Extrapolation, 8) Complete, 9) Internally Consistent, 10) Verifiable, 11) Validation, 12) Model Fidelity, 13) Elegant, 14) Formed for Optimization, 15) Avoid Black Box, 16) Availability of Interfaces, 17) Reusable. The qualities are defined in the questionnaire.}
    \label{fig:qualities-assessment}
\end{figure}

	\section{Summary}
	\label{sec:summary}

Numerous cyber-physical systems include simulation parts such as Digital Twins (DT), demonstrators, or mockups, which are utilised during their development. We postulate the Simulation-Physical System (SPSys) concept to describe this kind of system. SPSys includes physical, simulated and hybrid parts. 
% They cooperate to fulfil the system's aim; however, some are used as DTs to boost the system's reliability and accurate analysis. Some parts of the system can be used in the development process only as mockups and prototype simulators to increase the system's simulation-based testing coverage. This, in turn, improves prototype safety and the resulting system robustness. 

SPSys application is wide; in particular, it can work in a~dynamic environment and observe exogenous actions of the inhabitants in the environment. Such a~situation is problematic because DT must perfectly mirror its PT. To answer the above needs, we propose a Domain-Specific Language named Simulation-Physical System Modeling Language (SPSysML) that defines SPSys taxonomy and the relationships between the types of SPSys parts. 

Integrity and reusability in reliable software development is crucial. Therefore, based on SPSysML terms, we define design evaluation factors that enable quantitative analysis and optimisation targeted to software re-use maximisation between DT and PT in different system setups. We analyze the evaluation factors and show features of the systems that score edge case values of the factors. 

Finally, we validate SPSysML, including the evaluation factors and proposed requirement-based system composition in a~complex robot system development. We demonstrate step-by-step results of SPSysML application. We point out significant system structure changes resulting from the design evaluation and the proposed quantitative factor-based guidelines applications. An example is \Part{FallDetector}{\stSA{}} and \Part{FallDetector}{\stPA{}} integration improvement by a~common function isolation as \stDCS{}. Moreover, the verification shows that 33\% of the system's Physical Agents do not have DTs, and thanks to the design modification, the whole hardware (physical and simulated) is controlled with a~common component (\texttt{DGF}=1). This has two main advantages. First, all Digital and Physical Twins pairs share a common control subsystem. Second, if there is a~\stPA{} or \stSA{} without a~twin, it can be easily integrated using the embodiment-abstract interface. 

The validation shows that the requirement profile for SPSys enables critical analysis and may result in requirement decomposition and explication. An example is the decomposition of the \Part{Communication with humans}{\stSPFR{}}  to \Part{TTS and STT}{\stSPFR{}} and \Part{Dialoge management}{\stCFR{}} during requirement analysis. Thanks to the \Part{Dialoge management}{\stCFR{}} separation, the proposed requirement-based procedure for the system composition resulted in the implementation of \Part{Talker}{\stHA{}} managing the requirement. As a consequence of the above, the requirement is managed by a component usable in different setups in cooperation with the simulated or physical embodiment. Otherwise, the requirement would be managed separately in simulation and physical embodiments of the robot.
The presented validation confirms the features distinguishing our method from the others listed in Table~\ref{tab:related-work}, e.g.:

\begin{itemize}
    % \item Integrity evaluation with quantitative factors,
    % \item  structure model, % and system development procedure,
    \item Quantitative evaluation of integrity between the system's simulation and physical embodiments,
    \item Modeling simulation, physical and hybrid system execution and testing setups,
    % \item Forcing simulation-based testing prior physical embodiment development using simulation implementation factor for sequencing \stSSGA{} implementation and testing, 
    \item SysML-based specification of systems composed of physical and simulated parts and Digital Twins.
    \item Enabling Digital Twins to observe exogenous actions in the simulated world by \stWMGA{} implementation.
    \item Easing requirements tracing using requirement-based system structuring.
\end{itemize}

Based on the conducted validation, we observe the following limitations of our work: 
\begin{itemize}
    \item Requirement-based structuring is a roadmap for SPSys's design, increasing structural connections between system components and requirements.  However, it may not be optimal for any system; therefore, we suggest further iterating the design stage with other system design methods, like those based on the Design Structure Matrix~\cite{eppinger2012design}. 
    % The literature does not specify either a~universal terminal predicate for systems' requirement definition or system designing.
\item The requirement model defines only types used in the requirement-based structuring method; however, the project team should extend the requirement model if other requirement types are necessary.
\item The integrity evaluation accuracy depends on the system structure granularity, which is the resolution of the evaluation. Therefore, the more detailed the system design is, the more accurate the evaluation.
\item The drawbacks pointed out in the questionnaire. Evaluation factors are objective and abstract from the subjective importance of particular components. However, such aspects can be applied by scaling the proposed factors by importance, priority, etc. 
\end{itemize}
% \wdci{przejrzeć stare:}

% We propose a Domain Specification Language named DEMoL suited for DES. It satisfies the requirements stated as the result of our analysis and the related works review. DEMoL states constraints for DES structure and specifies relationships between its parts. In particular, we investigate inter-embodiment relationships in robot systems and distinguish physical, simulation, and hybrid class Agents aggregated in various class Groups of Agents boosting system clarity. For example, \stSSGA{}\textit{s} with internal block diagrams advance DES progressive test planning.
% Moreover, this block type can specify the configuration of system deployments for automated test generation methods like AmbieGen \cite{HUMENIUK2022106936}. We define the DEMoL application procedure, which constitutes the DES development procedure improving safety in DES testing. All Control Subsystems specified in the DEMoL-based system should be dual-embodied; however, it is a~goal for the iterative optimisation process. We propose example integrity factors that are optimised during the system design. 

% 	 DES development procedure specifies clearly the decomposition of an {Agent} into the additional embodiment-dependent Subsystems in hardware and driver layers. Thanks to that and the \texttt{mirror} relationship definition, the optimisation target can be specified with the example or other factors, and the DEMoL-based system structure results from the evaluation of the factors. As result, {Agents} mirroring a~system function in different embodiments utilise the same Control Subsystem that is developed once and tested in the Simulated World before testing and deployment in the Physical World. Moreover, we propose a~toolchain for robot system development. The toolchain utilise universal, well-known software to manage DEMoL-based system development (Enterprise Architect to SysML diagrams creation) and to simulate robot system parts during the testing stage (Gazebo).  We share SysML profiles, DEMoL meta-model, and the example of the INCARE system model\footnote{\url{https://github.com/RCPRG-ros-pkg/DEMoL}} to ease  its DES specification. DEMoL boosts system parts' re-usability in both embodiments and lowers the risk of double deployment with the \texttt{mirror} relationship constraints.
% 	As a~verification we apply DEMoL and its application procedure to a~complex robot system equipped with additional devices. We show the results of the procedure's steps and the final system specification modelled with DEMoL. 
	

In the future, we plan to automate SPSys structure evaluation with known universal tools like Matlab and Enterprise Architect. Furthermore, this work revealed the need for a CPS structure optimisation indicators taxonomy. SPSysML and future work lead to optimal structure development automation for complex robot systems like dual-arm impedance controlled mobile manipulatiors~\cite{9376462}.
 

\section*{Acknowledgment}
The research was funded by the Centre for Priority Research Area Artificial Intelligence and Robotics of Warsaw University of Technology within the Excellence Initiative: Research University (IDUB) programme. The work takes the robot platform and its application from the INCARE project. The authors also acknowledge TALBOT, from the European Union’s Horizon 2020 research and innovation programme under Marie Skłodowska-Curie grant agreement No. 801342 (Tecniospring INDUSTRY) and the Government of Catalonia’s Agency for Business Competitiveness (ACCIÓ); and SHAPES, from the European Horizon 2020 research and innovation programme under grant agreement No 857159. The Spanish grant PID2021-125535NB-I00 has also supported the work.

	\bibliography{spsys}

% \section*{APPENDIX}
% \subsection*{Key results of the validating questionnaire}
% \begin{figure}[ht]
%     \centering
%     \includegraphics[width=0.7\linewidth]{questionnaires/results/attenders-tasks.png}
%     \caption{Tasks in which the responders utilise simulation}
%     \label{fig:enter-label}
% \end{figure}
% \begin{figure}[ht]
%     \centering
%     \includegraphics[width=0.95\linewidth]{questionnaires/results/change analysis.png}
%     \caption{How SPSysML would help you in change analysis of a complex CPS?}
%     \label{fig:enter-label}
% \end{figure}
% \begin{figure}[ht]
%     \centering
%     \includegraphics[width=0.95\linewidth]{questionnaires/results/How clear (1-5) are the rules for improving the system based on the proposed design evaluation factors.png}
%     \caption{Clarity of the factor-based rules for integrity improvement.}
%     \label{fig:enter-label}
% \end{figure}
% \begin{figure}[ht]
%     \centering
%     \includegraphics[width=0.8\linewidth]{questionnaires/results/qualities-of-great-models.png}
%     \caption{SPSysML assessment against qualities of great models: 1) Linked to Decision Support, 2) Model Credibility, 3) Clear Scope, 4) V\&V With Model, 5) Well-Organized, 6) Analyzable and Traceable, 7) Data Extrapolation, 8) Complete, 9) Internally Consistent, 10) Verifiable, 11) Validation, 12) Model Fidelity, 13) Elegant, 14) Formed for Optimization, 15) Avoid Black Box, 16) Availability of Interfaces, 17) Reusable. The qualities are defined in the questionnaire}
%     \label{fig:enter-label}
% \end{figure}
%  \label{appendix-incare-requirements}

\end{document}
