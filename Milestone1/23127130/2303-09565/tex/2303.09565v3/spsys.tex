% !TEX encoding = utf8
% !TeX spellcheck = en_GB
% !TeX program = pdflatex

\documentclass[10pt,journal,compsoc]{IEEEtran}
% ATTENTION !
% 
% IF the print_comments toggle is true, LaTeX prints comments to the article as red text.
% If you comment with an Overleaf review, please use \comment{} command. This way, the comments will not affect the PDF unintentionally.
%
\usepackage{etoolbox}
\providetoggle{print_comments}
\settoggle{print_comments}{true}
\newcommand{\comment}[1]{\iftoggle{print_comments}{\textcolor{red}{#1 }}}
%   
%   
\IEEEoverridecommandlockouts                              % This command is only needed if 

\usepackage{lineno,hyperref}
\modulolinenumbers[5]

\oddsidemargin -40pt

\marginparwidth 170pt
\usepackage[]{subcaption}
\usepackage{color}
\usepackage{pdfcomment}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
%\usepackage{amsmath}
\usepackage{float}
\usepackage{multirow}
\usepackage{makecell}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{makecell}
\usepackage{rotating}
\usepackage{footmisc }
\usepackage{enumerate}

%\usepackage[shortlabels]{enumitem}
%\usepackage[english,polish]{babel}

%\usepackage{amsthm}
%
%\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]

\usepackage{xargs}
\usepackage[table,xcdraw]{xcolor}
\usepackage[colorinlistoftodos,prependcaption,textsize=tiny]{todonotes}
\usepackage{textgreek}
\newcommand{\Fig}[1]{Fig.~\ref{#1}}
\newcommand{\App}[1]{Appendix~\ref{#1}}
\input{earl-1_3-commands}
\input{spsys-stereotypes}


\def\checkmark{\tikz\fill[scale=0.4](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- cycle;} 

\usepackage{mathtools, bigstrut}
\DeclarePairedDelimiter{\set}{\{}{\}}
\DeclareMathOperator{\GL}{GL}

\newcommand{\Sec}[1]{Sec.~\ref{#1}}
\newcommand{\wdci}[1]{\textcolor{magenta}{WD: {#1}}}

\bibliographystyle{ieeetran}

%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
	\title{SPSysML: A meta-model for quantitative evaluation of Simulation-Physical Systems
	}

	%% Group authors per affiliation:
	\author{Wojciech Dudek$^{1}$, Member, IEEE, Narcis Miguel$^{2}$, Member, IEEE, Tomasz Winiarski$^{1}$, Member, IEEE
	\thanks{$^{1}$Warsaw University of Technology, Institute of Control and Computation Engineering, Poland
        {\tt\small wojciech.dudek@pw.edu.pl},\\
        {\tt\small tomasz.winiarski@pw.edu.pl}
        }
    \thanks{$^{2}$PAL Robotics, Barcelona, Spain\\
    {\tt\small narcis.miguel@pal-robotics.com}}}
	
	\maketitle
	
	\begin{abstract}

 Robotic systems are cyber-physical systems (CPS) equipped with multiple sensors and effectors, making them aware of dynamic environments, e.g. surrounding humans. A multi-component structure and potential environmental harm make robotic systems development challenging. The Digital Twin (DT) concept has recently been applied to model and test CPS. However, it is unclear how to employ DT in robotic system development, e.g. in-development testing and how to design systems featuring various simulated and physical parts. 

\textit{Goal}: We aim to improve the integration between simulated
and physical parts of CPS in various system setups, resulting in controlling the simulated and real hardware with a~shared controller. The goal for tightening the integration is to allow parallel and safer system development and faster and safer machine learning using simulation/DTs. We propose integrity evaluation with quantitative factors and requirement-based system structure design, allowing DT to perceive exogenous actions in the simulated world.

\textit{Method}: We propose a Domain-Specific Language based on Systems Modeling Language (SysML) called SPSysML. SPSysML defines the taxonomy of a~CPS consisting of at least a~physical or simulated part. The simulated parts can be DTs. We propose a~development procedure called SPSysDP that manages the considered systems development by evaluating the system designs with the proposed quantitative factors.

\textit{Result}: SPSysDP is used to develop a~robotic system for the INCARE project. In subsequent iterations of SPSysDP, the simulation-physical integrity of the system is improved, and a~more significant fraction of the system components is shared between various system setups. The designed system was deployed on the physical robot and two simulators. System setups are based either on Robot Operating System (ROS) or ROS2. Therefore, we argue that SPSysDP and SPSysML are neither specific for a~control system framework nor a~robot simulator.

\textit{Conclusion}: SPSysML with SPSysDP enables the design of SPSys (including DT and CPS), multi-setup system development featuring improved integrity between simulation and physical parts in its setups.

		\end{abstract}
	

	\section{Introduction}
	\label{sec:intro}
	%
	% Poniżej propozycja rozszerzenia litaratury
	%
	%\wdci{Ewentualnie dodatkowo można się odwołać do: \url{https://ieeexplore.ieee.org/abstract/document/9186155} oraz \cite{doi:10.1504/IJPD.2013.052166}}
	
Simulation is widely used in state-of-the-art development procedures for cyber-physical systems (CPS). Recent papers refer to Model-in-the-loop (MIL) \cite{10.1243/09596518JSCE207}, Software-in-the-loop (SIL) \cite{4455268}, Hardware-in-the-loop (HIL) \cite{10.1007/978-3-319-74793-4_10} and Rapid Control Prototyping (RCP) \cite{Abel2006} techniques. They are used selectively or are composed in sequence, e.g. verification and validation steps in a systems development approach called \mbox{V-model}~\cite{mathur2010advancements}. Each of the techniques requires a simulation of the system parts. Some systems utilise the Digital Twin (DT)~\cite{9529662, PYLIANIDIS2021105942} concept. They employ an accurate simulation of a system part for, e.g.:
	\begin{itemize}
		\item Swapping a malfunctioned system part with the simulated one DT that mirrors the part's functionality in the simulated world,
		\item Energy consumption analysis,
		\item System failure analysis and prediction,
		\item Technology integration,
		\item Real-time monitoring.
	\end{itemize}
Some parts (software and hardware) of such a system interact with the real world, while other parts interact with the simulated world. We call the set of the parts used in the real world the physical embodiment, and we call the set of the parts used in the simulated world the simulated embodiment. The Digital Twin is a~part of the simulated embodiment mirroring a~part of the physical embodiment. DT concept is used in numerous domains and applications~\cite{NEGRI2017939}. They are systematically analysed by the authors of~\cite{dalibor2022cross}.

	Robots comprise multiple devices and their controllers. In particular, autonomous mobile robots require a~complex navigation system that features multiple closed control loops, e.g. drive controllers, trajectory controllers, and Simultaneous Localisation and Mapping (SLAM). Furthermore, the navigation system and the rest of the robot's functionality are used to execute the user request (like object transportation). In some cases, only a~fraction of such a~complex system must have DTs. In other cases, if the robot system has only the simulated embodiment, it is a~demonstrator of the future product. 
 
 To clear up the taxonomy of systems featuring simulated and physical parts, we introduce the Simulation-Physical System (SPSys) concept~(\Fig{fig:concept}). This kind of system consists of at least one physical/simulated embodiment and a~shared controller. If it has both embodiments, the simulated part can be a~DT of a~physical part. If it has only the physical embodiment, it is a~CPS; if it has only the simulated embodiment, it is a~simulator. 
	\begin{figure}[t]
    	\centering
		\includegraphics[width=0.8\linewidth]{./figures/concept-2}
		\caption{The idea of Simulation-Physical System}
		\label{fig:concept}
	\end{figure}
 
In the development process, the system parts evolve from simulated mockups to the physical parts and the software deployed on the hardware. The system development procedure must guide the project team through the process. The system design created as a~milestone in the procedure must specify all required parts in all development stages and compose them in the testing and deployment setups. Developing reliable systems, especially complex ones like robot systems, requires comprehensive unit and integration testing. Some CPS parts can be tested with simulated hardware only; therefore, additional parts that do not comprise the operational system are required (e.g. human simulator in a~social robot case). Comprehensive testing is complex in test case specification and time-consuming in test implementation and execution. From this perspective, software reusability is a~key to fast development of complex, reliable systems.

We aim to:
\begin{itemize}
    \item Specify profiled-based requirements of Simulation-Physical Systems including multiple Digital Twins for procedural system structuring based on the requirement types,
    \item Re-use of software between DT and its Physical Twin (PT) and between different system setups, improving system's reliability and resulting in more accessible and faster testing, 
    \item The integrity boost between simulation and physical embodiments of SPSys. This enables a~comprehensive and parallel simulation-based testing of the system parts,
    \item Enable Digital Twins to observe exogenous actions in simulation. The actions can be executed by any agent outside the physical system, e.g.~a human moving objects in a service robot environment. Such an~action must be implemented in the simulated world because the digital twin must operate in the exact environment as its physical counterpart.
\end{itemize}
To reach these goals, we propose a~Domain-Specific Language (DSL) named Simulation-Physical System Modeling Language (SPSysML). SPSysML models the requirements and the SPSys, in particular, SPSys consisting of simulated parts (used either in the system development or in the operational setup as DT/simulator). Based on SPSysML, we propose a~requirement-based SPSys structuring method. To measure the inter-embodiment integrity of the system, we propose quantitative design evaluation factors for SPSys designs. The factors are used in the proposed SPSys Development Procedure (SPSysDP)~(\Fig{fig:concept-procedure}) to maximise the shared controller, minimise the system parts number and improve simulation-physical integrity.

Our goal originates from the conclusion of \cite{LO2021101297}: \textit{The digital models are mainly used to examine product performance(...). However, how to optimise the use of those models to enhance the design process and design collaboration still needs to be investigated.}

 	\begin{figure}[t]\centering
		\includegraphics[width=\linewidth]{./figures/concept-procedure-2}
		\caption{The concept of DES development procedure}
		\label{fig:concept-procedure}
	\end{figure}

SPSysML comprises a~componet-based Platform Independent Model (PIM), thus, can be applied to any SPSys. The result of SPSysDP is an implemented and tested Platform Specific Model (PSM) that can be launched in the specified setups. PSM implementation utilises platform-specific tools and software libraries. Therefore, to verify our approach, we design, implement, test and deploy a~specific SPSys, including the TIAGo service robot~\cite{PMF16} for the INCARE (Integrated Solution for Innovative Elderly Care) project\footnote{\url{http://aal-incare.eu/}, robot application demonstration (simulation/real) can be found accessing Demo / RAPP Store Demo}. The robot features an extended voice interface and additional devices to~serve the elderly, e.g. in object transportation (\Fig{fig:tiago-transport}) and fall assistance (\Fig{fig:tiago-fall}). The resulting system utilises component-based frameworks like \emph{ROS}~\cite{quigley2009ros,macenski2022robot}, \emph{ROS2}~\cite{maruyama2016exploring}, \emph{OROCOS}~\cite{bruyninckx2001open}, that are a~standard open-source robot control frameworks. We use two open-source simulators \emph{Gazebo}~\cite{koenig2004design} (in particular \emph{Gazebo\_ros\_control} package~\cite{gazebo-ros-control}) and \emph{O3DE}~\cite{o3de} for DT implementation. By the SPSysDP execution for a~real use-case robot system development, we present an example of DT and PT implementation in robotic systems. To make the SPSys development easier for the community, we share the SysML profiles, the SPSysML meta-model and the example INCARE system model\footnote{\url{https://github.com/RCPRG-ros-pkg/spsysml}}. All diagrams describing SPSysDP, SPSysML and the INCARE system are also shared~\cite{spsysml-diagrams}.

 In this article, we describe related work concerning mixing simulation-physical setups and meta-models for CPS (\Sec{sec:related-work}) and state our work's novelty and its result regarding the related works (\Sec{sec:novelty}). Subsequently, we define SPSys requirements model in~\Sec{sec:requirement-model}, the meta-model in \Sec{sec:pl-structure} and its application procedure in \Sec{sec:customisation-procedure}. Next, we analyse the proposed evaluation factors of SPSys design and describe features of the systems scored edge case values of the factors in \Sec{sec:evaluation-factors-analysis}. Finally, we verify our method in complex SPSys development for the INCARE project (Sec.~\ref{sec:example-system}). 
This work is concluded in~(Sec.~\ref{sec:summary}).
	
	\begin{figure}\centering
		\begin{subfigure}{0.3\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./figures/tiago-transport}
			\caption{Transport task}
			\label{fig:tiago-transport}
		\end{subfigure}
		\begin{subfigure}{0.54\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./figures/tiago-fall}
			\caption{Fall assistance task}
			\label{fig:tiago-fall}
		\end{subfigure}
		\caption{TIAGo robot in INCARE tasks execution}
		\label{fig:tiago-tasks}
	\end{figure}

 
 \begin{table*}[h!]{
			\begin{center}
				
			\caption{Related works comparison with this work}\label{tab:related-work}\footnotesize
			\begin{tabular}{|l|c|c|c|c|c|c|c|c|c|c|c|}
				\hline
				\makecell{System \\development\\ method}&\makecell{EM}&\makecell{EIV}&\makecell{Formal \\meta-model}&\makecell{SCP}&\makecell{SO}&\makecell{System \\structure\\configurability}&\makecell
				{DE}&\makecell{E}&\makecell{QE}&\makecell{MDT}&\makecell{Purpose}\\ \hline
				%CPS
				\makecell[l]{Digital\\Mockup \cite{5952295}}&I&-&-&ES&-&\makecell{Single\\structure}&\checkmark&-&-&-&\makecell{RT simulation\\for HIL  testing}\\\hline
				\makecell[l]{C2PS \cite{7829368}}&M&-&\makecell{Own\\meta-model}&\makecell{Formal \\and detailed}&\makecell{BS}&\makecell{Single\\adaptive}&\checkmark&-&-&N/D&\makecell{Digital Twin\\in the cloud}\\\hline
				of work \cite{8822494}&M&\checkmark&\makecell{Dolev-Yao \\\cite{1056650}}&\makecell{Formal \\and detailed}&-&\makecell{Single\\structure}&\checkmark&-&-&\checkmark&\makecell{Cyber-security,\\physical-digital twin\\ synchronisation}\\\hline
				% ROBOT
				\makecell{DEVSRT \cite{MOALLEMI2013115}}&I&-&\makecell{DEVS \cite{zeigler2000theory}}&General&-&\makecell{Single\\structure}&-&-&-&-&\makecell{Simulation to embedded \\continuous development}\\\hline
				aRD\cite{4058987}&M&-&-&General&-&\checkmark&\checkmark&-&-&-&\makecell{RT \& NonRT \\parts integration}\\\hline
				\makecell[l]{HMLF \cite{ElShamoutyKleebergerLammleHuber}}&I&-&-&ES&-&\makecell{Single\\structure}&-&-&-&-&\makecell{Simulation-driven ML} \\\hline
    
				\makecell{RSHPN \cite{FigatZielinski-HPNmetamodel:2022}}&M&-&\makecell{RSHPN}&\makecell{ES}&-&\makecell{Single\\structure}&\checkmark&-&-&-&\makecell{Deadlocks verification,\\automated code generation}\\\hline
				
    SPSysDP&M&\checkmark&\makecell{SPSysML\\/SysML}&\makecell{Formal \\and detailed}&\makecell{SPO}&\makecell{unbounded\\system\\setups}&\checkmark&\checkmark&\checkmark&\checkmark&\makecell{Structure optimisation for\\Simulation-Physical Systems}\\\hline
				
			\end{tabular}
		\end{center}
		}{\vskip 0.1cm\footnotesize \raggedright
			EM -- {Embodiment modularity},
			EIV -- {Embodiment integrity verification},
			SCP -- {System creation procedure},
			SO -- {Structure optimisation},
			DE -- {If the system execution configuration can contain parts of both embodiments},
			E -- {If uncontrolled agents of the physical environment (link humans) can be modelled in the simulation},
			QE -- {If quantitative evaluation factors for system design are proposed},
			MDT -- {If a~multi Digital Twin system model is presented}, 
			I~-- {Integrated system},
			ES -- {Example system as the method application procedure},
			M -- {System decomposable to multiple simulation/physical parts},
			BS -- The best selection from the previously designed,
			SPO -- Simulated-Physical design optimisation,
   N/D -- Possible, however, not defined,
		}
	\end{table*}
	\section{Related work}
	\label{sec:related-work}
Our work intersects two areas of the systems engineering domain: the development of cyber-physical systems consisting of simulated parts and specifying systems following a Model-based approach. Therefore, we focus the related work analysis on development approaches for systems implementing physical parts and their simulated equivalents (sometimes called Digital Twins). The second section describes state-of-the-art Domain Specification Languages (DSL), emphasising the robotics domain. The works regard the development of various kinds of SPSys. Therefore, the purposes of their results differ. The most related works to SPSysML are compared in Table~\ref{tab:related-work}, and their purpose is also shown.
 \subsection{Mixing simulation-physical setups}
 In \cite{4058987}, the authors note the complexity of robotic systems and that heterogeneous teams of researchers and developers often develop the system components simultaneously. The authors suggest a demand for system simulation enabling rapid prototyping and an iterative development process. They propose the so-called agile Robot Development (aRD) concept that facilitates the integration of the hard real-time part and the non-real-time part of the system utilising a~Matlab/Simulink toolchain. 
	% They present different HIL setups organised with the aRD concept for testing robot system parts. 
    The sim2real problem is known and mentioned in the recent research results, e.g. in the domain of self-driving cars \cite{9869302}. However, to our knowledge, none of the existing works specifies a flexible robotic system meta-model that defines mixed simulation-physical setups of CPS under development.
	
	Agile development implements the idea of rapid prototyping via, e.g. unit testing~\cite{10.1007/978-3-319-11900-7_22, 10.1007/978-3-540-70945-9_10}. The Robot Unit Testing methodology~\cite{10.1007/978-3-319-11900-7_22} enables covering the whole robot software with unit testing, starting from the components integrating black-boxed vendor drivers. On the other hand,~\cite{10.1007/978-3-540-70945-9_10} presents a framework for test-driven development (TDD) of multi-agent systems. TDD methodology is often used in the robotics domain. However, the tests evaluate just one specified simulation-physical setup of the system. Still, during development, almost every part of the system evolves from mockup (realised in simulation) to deployable software or hardware.  Continuous integration is a~valuable tool for verifying a model-to-reality transformation \cite{MOSSIGE2015169}. In the CPS case, continuous integration may not be limited to software; however, it should include mechanical parts development and their integration with the software. State-of-the-art industry-implemented development operations already employ mechanical parts simulation in Gazebo for continuous integration~\cite{9557476}. None of the works proposes a~quantitative evaluation factors for the system design assessment.

There are reviews on CPS \cite{6853346} and DT \cite{LO2021101297} development. The CPS-related works focus on controlling a~physical object and its model in a~simulation environment with partially or fully simulated hardware. For example, the authors of \cite{8822494} use the DT approach to run the digital embodiment in a~safe virtual machine and confront the physical and digital embodiments to spot anomalies caused by a~cyber-attack. Another work \cite{ElShamoutyKleebergerLammleHuber} employs simulation-driven machine learning for robots. However, none of the works proposes a~system structure allowing exogenous actions execution in the simulated world.

\subsection{Meta-models for CPS}
In the development process, a~language is required to plan, conceptualise, and specify the system. Currently, the state-of-the-art approach is a model-based approach utilising a DSL. Unified Modeling Language (UML) is the most known language; however, System Modeling Language (SysML)~\cite{wolny2020thirteen}  is proposed by the Object Management Group (OMG) to support the design, analysis and verification/validation of complex systems comprising software and hardware components. Different Model Driven Engineering approaches exist in the robotics domain~\cite{de2021survey}. For instance, Embodied Agent-Based cybeR-physical control systems modelling Language (EARL) \cite{earl2020} is SysML specialisation for robotics which allows analysis and specification of the robotic system properties. It is based on the Embodied Agent approach~\cite{Zielinski-KAiR-eng:2021}. The approach shapes the robotic system structure and inter-component communication by defining SPSys-related artefacts, component classes and their constraints. Other DSLs support verification and testing of, e.g. industry 4.0 plants \cite{8369563},  or agent-based computational systems \cite{FORTINO2012608}). Besides, the work \cite{DELAVARA201616} describes the specification of safety compliance needs for critical computer-based and software-intensive systems. 

\subsection{Characteristics of the related works}
The related models in Table~\ref{tab:related-work} are SPSys of different types or are tools for testing/designing SPSys. Two of the works design interaction between the DTs and PTs -- C2PS~\cite{7829368}, \cite{8822494}, three focus on simulation-based development of CPS -- Digital Mockup~\cite{5952295}, DEVSRT~\cite{MOALLEMI2013115} and aRD~\cite{4058987}, and the last one -- HMLF~\cite{ElShamoutyKleebergerLammleHuber} utilises DT concept in machine learning. The authors of RSHPN \cite{FigatZielinski-HPNmetamodel:2022} propose a meta-model to verify the lack of deadlocks in multi-component SPSys using Hierarchical Petri Nets. The nets are generated from a~DSL-based specification, and the code associated with the robot controller structure and communication is generated.

\section{The work novelty and result}
\label{sec:novelty}
None of the models presented in \Sec{sec:related-work} specifies SPSys in general, especially including a~physical part without equivalent Digital Twin, simulated parts without equivalent PT, or hybrid SPSys including Twins and non-Twin components. The key novel features delivered by SPSysML and SPSysDP are:
\begin{itemize}
    \item Integrity evaluation with quantitative factors,
    \item SysML-based structure model and system development procedure,
    \item System design optimisation considering simulation and physical embodiments of the system,
    \item Multiple system execution and testing setups specification,
    \item Forcing simulation-based testing prior to physical embodiment development, 
    \item Specification of Simulation-Physical System including multiple physical and simulated parts and multiple Digital Twins,
    \item Reflection of the dynamic environment in simulation to enable Digital Twins to observe exogenous actions, e.g. human moving objects in the simulated world.
\end{itemize}

Based on our experience in SPSys development (TIAGo robot \cite{Dudek:2021_phd-twiki}, Velma robot \cite{en14206693}, IRP6 robot\footnote{\scriptsize Real: \url{https://youtu.be/wJpFcy99Gh0}, Simulation: \url{https://youtu.be/BjwcbSdouHw}}~\cite{motion-generation,winiarski-wozniak-2013}) and the literature analysis, we propose the SPSys Development Procedure focused on simulation-based testing coverage and software integrity between the system embodiments maximisation. Complex system structuring is a broad topic with solutions utilising various methods and strategies, e.g. top-down, middle-out and bottom-up. In \cite{en15217983}, we describe a~binary communication-focused top-down approach for robotic systems. In this article, we propose a~requirement-based top-down system structuring method customised for SPSys. 

 
	\section{Simulation-Physical System}
 Simulation-Physical System specification is based on SysML and EARL.
	In the following sections, we describe SPSysML and SPSysDP. SPSysML defines stereotype-based meta-models of requirements and structure. Description of a~meta-model requires a~notation for multiple blocks or instances of a~stereotype (e.g. two instances of \stA{}). For this purpose, we append the stereotype with \textit{s}~(e.g. \stA{}\textit{s}). We refer to an instance of a stereotype using the \Part{part-name}{\textit{<<stereotype>>}} symbol.

 \subsection{SPSysML -- requirements meta-model for SPSys}
	\label{sec:requirement-model}
	
	
We define a~stereotype-based model of requirements (\Fig{fig:requirement-model}). The stereotypes explicate SysML requirement diagrams used for designing SPSys with SPSysML.

	\begin{figure}\centering
		\includegraphics[width=\linewidth]{./schemes/profile/requirement_stereotypes_generalisation_cd.png}
		\caption{Model of system requirements defined for SPSys}
		\label{fig:requirement-model}
	\end{figure}

 SPSysML specifies the requirements model as~SysML profile. The requirements can be defined based on various premises. In particular, they can derive from user requirements \cite{dos2008model}. The SPSysML profile defines structural, functional, configurational and environment requirements. Other requirement types can be added; however, these are used by SPSysDP in system setups' specification and requirement-based decomposition of the system. Auxiliary sequence diagrams presenting the concept of the system behaviour and use case diagrams are useful for requirements definition. Before SPSys requirements specification, its environment must be analysed. Therefore, in SPSysML, we distinguish Environment requirements. They can be of various stereotypes. This article focuses on \stEAR{} that describe exogenous agents interacting with the world alongside the system. In SPSysML, the system is decomposed into parts based on \stREQ{SysPartReq}\textit{s}. Each \stREQ{SysPartReq} is classified to elementary \stREQ{HardwareReq} or more general \stREQ{PhyPartReq}, \stREQ{SimPartReq} or \stREQ{SimPhyPartReq}. \stREQ{PhyPartReq} determines a~part interacting only with the Physical World (even during the system development, e.g. during parallel development of the dependent parts), and its simulated embodiment is not required (or cannot be created) during the system development. \stREQ{SimPartReq} specifies a~part interacting only with the Simulated World (e.g. mock-ups or demonstrators).  \stREQ{SimPhyPartReq} interacts with both Worlds (e.g. realised with a~pair of DT and PT).
	\stREQ{HardwareReq}\textit{s} are in a~\textit{satisfy} relationship with \stFR{}\textit{s}. This means hardware requirements specified with a~\stREQ{HardwareReq} enable the realisation of the functionality specified with the given \stFR{}. The configurational stereotypes specify if a~system part is obligatory to launch in any of its configurations (\stREQ{ObligatoryReq}) or if it is not (\stREQ{OptionalReq}). With optional requirements, the system gains multiple setups, addressing the optional requirement or not. The proposed development method defines separate system component groups, each structuring a system setup. The system setups are defined for any combination of the optional requirements.



	\subsection{SPSysML -- structure meta-model for SPSys}
 \label{sec:pl-structure}
	SPSysML derives from EARL \cite{earl2020} version 1.3~\cite{earl-1.3}. We use a~Group of Subsystems (\stGpS{}) to gather Subsystems with a~specific common properties, and a~Group of Agents (\stGpA{}) to organise the Agents (composed of Subsystems) cooperating for a~defined aim in the system. In a~SPSys we differentiate three specific Agent stereotypes that derive from \stA{} defined in EARL (\Fig{fig:dual_embodied_system_bdd}):
	\begin{itemize}
		\item \textit{Physical Agent} (\stPA{}) -- Runs only in the physical embodiment (in particular Agent interacting with or sensing real world),
		\item \textit{Simulation Agent} (\stSA{}) -- Runs only in the simulated embodiment (in particular Agent interacting with or sensing simulated world),
		\item \textit{Hybrid Agent} (\stHA{}) -- Runs in both embodiments with neither interaction nor perception of any world.
	\end{itemize} 
	
	\begin{figure}\centering
		\includegraphics[width=\linewidth]{./schemes/spsys/dual_embodied_system_bdd.png}
		\caption{Simulation-Physical System composition}
		\label{fig:dual_embodied_system_bdd}
	\end{figure}
	
	
	The Groups of Agents called \textit{World Mirror Group of Agents} aggregate \stSA{}\textit{s} that are Digital Twins of the Agents in the Physical World that are not controlled by the system and execute exogenous actions in the Simulated World. Groups of this type exist if the system works in a~dynamic environment (e.g. an environment with human inhabitants). For example, a~\textit{World Mirror Group of Agents} modifies the Simulated World as humans do in the Physical World. 
\subsubsection{Digital Twins in SPSys}
Integrity between SPSys embodiments is crucial. Therefore, the existence of DT of physical parts is advisable and common. We define the \texttt{mirror} relationship between \stPA{} and \stSA{} to model the relationship between DT and its PT. To enable multi-agent DT for a~single \stPA{} or single-agent DT for multi-agent PT, we introduce \stMPGA{} and \stMSGA{}. They aggregate Agents of different stereotypes (\Fig{fig:msga_mpga_bdd}).

	\begin{figure}\centering
		\includegraphics[width=\linewidth]{./schemes/spsys/msga_mpga_bdd.png}
		\caption{SPSys composed of 0...* Digital Twins (+dt) and Physical Twins (+pt) realised with \stMSGA{} and \stMPGA{} accordingly}
		\label{fig:msga_mpga_bdd}
	\end{figure}
	
	The definition of the \texttt{mirror} relationship is as follows:
	
	\begin{definition}[Mirror relationship]
		{\it Two Groups of Agents are said to be in a {\rm mirror relationship} if their input buffers and goals are the same and affect Simulated and Real Worlds congruently. The relationship is an association between Digital and Physical Twins.}
	\end{definition}
It is worth noting that the same stimuli of the mirroring Groups cause corresponding reactions in specific worlds, in the Simulated World for \textit{Mirror Simulation Group of Agents} and in the Physical World for {\textit{Mirror Physical Group of Agents}}. The particular reaction results from the requirements of the specific system and does not need to be identical between the Agent Groups that mirror each other. A~stimuli of a~Group of Agents is the input from other Agents or the environment through the Group of Agents interfaces. Agent's reaction to a~stimuli manifests as the Agent state change (including changes in memory or output data).
Considering a~pan-tilt head as an example, \stMSGA{} is the simulated head, and \stMPGA{} is the real one. In this case, the common stimuli are the light perception from the according world (simulated/physical) and the head joints' control. The common reaction is data in their output interface. A~digital twin (\stMSGA{}) for a~pan-tilt head development is a convenient tool, e.g. for servovision implementation or joint constraints evaluation. SPSys may consist of multiple such pairs, e.g. manipulator and mobile base in a~service robot case.

The mirror relationship does not propagate automatically to all the Agents aggregated in the mirroring Groups, so agents from \stMSGA{} do not mirror all agents of mirroring \stMPGA{} and vice versa.
	
The number of mirroring Agents should be maximised to maximise coverage of simulation-based testing and profits of DT. Additionally, the complexity and quantity of mirroring Agent Subsystems should be minimised to boost the modularity and integrity of the system. Otherwise, the system could be composed of just two mirroring agents. If a~computational functionality is required in both embodiments, a~\stHA{} should be designed for this purpose.

	\subsubsection{Subsystem types}\label{sect:subsystem_types}	The Agents are built with Subsystems of different types based on EARL. In EARL the central computational part of an Agent is the Control Subsystem \stCS{}. An Agent communicates with other Agents using communication buffers of its \stCS{}. To percept the environment, an Agent uses Real Receptors (\stRR{}\textit{s}), and to aggregate and preprocess stimuli, it uses Virtual Receptors (\stVR{}\textit{s}). To affect the environment, an Agent uses Real Effectors (\stRE{}\textit{s}). To preprocess \stCS{} commands to signals for \stRE{}\textit{s} it uses Virtual Effectors (\stVE{}\textit{s}). 
	SPSys interacts with both the simulated and physical world; thus, SPSysML differentiates between the types of the above Subsystems--- Simulated, Physical, and Simulated-Physical.
	To achieve maximum integrity between the simulated and physical embodiments, all \stCS{}\textit{s} should be Simulated-Physical (\stDCS{} stereotype) and constitute the general concept of the shared controller, recall~\Fig{fig:concept}. For iterating design purposes, embodiment-specific Control Subsystems concepts (\stPCS{} and \stSCS{}) may be helpful. The other Subsystems can be Simulated or Physical. 
 SPSysML defines \stGpS{}\textit{s} that aggregate receptors and effectors considering their embodiment and the world they interact with (\Fig{fig:hardware_group_bdd},
 \Fig{fig:drivers_group_bdd}).
 As one \stDCS{} can communicate with multiple Simulated/Physical Virtual Receptors and Effectors, we define four\stGpS{}\textit{s} aggregating Physical/Simulated Virtual/Real Subsystems. The data flow and communication links for \stDCS{} interacting with Simulated and Physical Worlds is shown in (\Fig{fig:inter-subsystem-interfaces}).
	
 \begin{figure}
     \centering
     \includegraphics[width=\linewidth]{schemes/spsys/hardware_group_bdd.png}
     \caption{Embodiments of Real Effectors and Receptors}
     \label{fig:hardware_group_bdd}
 \end{figure}
 \begin{figure}
     \centering
     \includegraphics[width=0.8\linewidth]{schemes/spsys/drivers_group_bdd.png}
     \caption{Embodiments of Virtual Effectors and Receptors}
     \label{fig:drivers_group_bdd}
 \end{figure}
 
    \begin{figure}[t]\centering
        \includegraphics[width=.9\linewidth]{./figures/ibd-subsystems.pdf}
        \caption{Interfaces between Subsystem Groups on example, where two agents share \stDCS{}}
        \label{fig:inter-subsystem-interfaces}
    \end{figure}
	
 
 \subsubsection{Realisation of the Subsystem and Agent types}
 Subsystems in a~\stPHGS{} expose interface realised with a communication interface controller used by the effector or sensor (e.g. Linux kernel driver for Inter-Integrated Circuit (I$^2$C) or network interface card). To these interfaces \stPDGS{}\textit{s} are connected and they expose an embodiment-abstract interface for a~\stCS{} of the Agent. Subsystems in \stSHGS{} expose interfaces realised with objects of an interface class defined for the utilised simulation environment (e.g. gazebo::ModelPlugin for \stSRE{} and gazebo::SensorPlugin for \stSRR{} in Gazebo\footnote{popular simulation environment for robots}). \stSDGS{} connects to these interfaces and exposes embodiment-abstract interface for \stCS{}\textit{s}. The interaction between the groups is shown in \Fig{fig:inter-subsystem-interfaces}.
	
	Each Agent type defined in SPSysML aggregates a~particular number of Subsystems of a~specific type~(\Fig{fig:agent_bdd}).
	
	\begin{figure}\centering
		\begin{subfigure}[]{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/spsys/physical_agent_bdd.png}
			\caption{Physical Agent}
			\label{fig:physical_agent_bdd}
		\end{subfigure}
		\begin{subfigure}[]{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/spsys/simulation_agent_bdd.png}
			\caption{Simulation Agent}
			\label{fig:simulation_agent_bdd}
		\end{subfigure}
		\begin{subfigure}[]{\linewidth}
			\centering
			\includegraphics[width=.85\linewidth]{./schemes/spsys/hybrid_agent_bdd.png}
			\caption{Hybrid Agent}
			\label{fig:hybrid_agent_bdd}
		\end{subfigure}
		\caption{Subsystems aggregated by Agent classes}
		\label{fig:agent_bdd}
	\end{figure}
	
	It should be noted that the Basic EARL meta-model defines only one \stCS{} in an Agent, and inter-agent communication is handled only by the \stCS{}. In SPSysML, we differentiate between specific types of \stCS{} for the embodiments; still, an Agent can aggregate just one specialisation of \stCS{}. 
  SPSys can be deployed in various setups (e.g. testing setups). The setups are a~Group of Agents fulfilling the system's functionality in the setup. For the system setup definition, we use \stSSGA{} to specify the Group of Agents working in the setup. The specific \stSSGA{} is derived from the system's requirements and test scenarios. This problem is considered in the SPSysDP section~(\Sec{sec:customisation-procedure}).
	
	
	\subsection{Simulation-Physical System Development Procedure (SPSysDP)}
	\label{sec:customisation-procedure}
	SPSysML defines system parts and the relations between them to enable  SPSys specification. Various agent-based system development procedures can be used for SPSysML-based systems; however, we define one that enables inter-embodiment integrity optimisation for SPSys (\Fig{fig:demol-procedure}). The main activities of the procedure can be executed in different development approaches, traditional, agile, or hybrid. In agile and hybrid approaches, the system is specified and implemented partially in an iterative manner. In the procedure shown in \Fig{fig:demol-procedure}, there are four decision nodes D1, D2, D3, and D4. The exact development procedure results from the logic predicates set to these nodes. D1 checks if the requirements of the considered system part are comprehensive and if the system parts and functions, considering the system's test scenarios, are expressed in the requirement diagrams. D2 checks if the structure evaluation is satisfactory. D3 checks whether any detailed analysis or requirements modification is required based on the design iteration, and D4 checks if the required \stSSGA{}\textit{s} are implemented and tested successfully. If needed, the procedure enables complete reiteration from the design stage. 

\def\szer1{0.79\linewidth}
 
	\begin{figure}\centering
		\begin{subfigure}{\szer1}\centering
			\includegraphics[width=\linewidth]{./schemes/spsys/development_procedure_general_act}
			%			\includegraphics[width=\linewidth]{./figures/main-procedure-scheme}
		\end{subfigure}
		
		\begin{subfigure}{\szer1}\centering
			\includegraphics[width=\linewidth]{./schemes/spsys/planning_act}
			%	\includegraphics[width=\linewidth]{./figures/procedure-planning-scheme}
		\end{subfigure}
		
		\begin{subfigure}{\szer1}\centering
			\includegraphics[width=\linewidth]{./schemes/spsys/design_act}
			%	\includegraphics[width=\linewidth]{./figures/procedure-design-scheme}
		\end{subfigure}
		
		\begin{subfigure}{\szer1}\centering
			\includegraphics[width=\linewidth]{./schemes/spsys/implementing_act}
			%\includegraphics[width=1.2\linewidth]{./figures/procedure-implementing-scheme}
		\end{subfigure}
		
		\caption{SPSys Development Procedure for Simulation-Physical Systems}
		\label{fig:demol-procedure}
	\end{figure}
  $\,$\\ %This is just a line change
  
	\noindent\textbf{System planning and analysis}
	\begin{itemize}
		\item \textbf{Step 1} (Requirement specification): The requirements are specified following the model defined in \Sec{sec:requirement-model}. It is recommended to define system use cases and typical interactions between system parts on sequence diagrams while specifying the requirements.
		\item \textbf{Step 2} (Requirement analysis): Analysis of the requirements considering the project stakeholders' demands and the system's test scenarios. In case it is needed, modifications to these requirements are made.
	\end{itemize}
	\noindent\textbf{System design}
	\begin{itemize}
		
		\item \textbf{Step 3} (World Synchronization): This step is not applicable if the system works in a~static environment (there are no exogenous actions of any non-system agent executed on the system's environment). In other cases, simulation of external agents (e.g. humans) is required, and it is done by \Part{WorldSync}{\stWMGA{}}. Each \stSA{} composed in \stWMGA{} manages one \stEAR{} specified in Steps 1-2. The key design aspects for the \stSA{}s are the Simulated World model perceived by the SPSys' receptors and the actions affecting this World. To model humans as \stSA{}, we propose our framework Human Behaviour in Robotics Research (HuBeRo)~\cite{hubero,10194930}. It specifies and implements agents mirroring human behaviours and their physical models in simulation~(\Fig{fig:hubero-model}).
  \begin{figure}
      \centering
      \includegraphics[width=\columnwidth]{schemes/incare/human_and_robot_system_bdd.png}
      \caption{Agent types of HuBeRo framework~\cite{hubero} used in SPSys as \stWMGA{} that mirrors humans in Simulated World.}
      \label{fig:hubero-model}
  \end{figure}
		\item \textbf{Step 4} (System decomposition): The system is decomposed into Agents systematically, based on the parts in the requirements. For each \stREQ{PhyPartReq} and \stREQ{SimPartReq} a~\Part{\texttt{part}}{\stPA{}} or \Part{\texttt{part}}{\stSA{}} are created. Each \stREQ{SimPhyPartReq} that has only \stREQ{ComputationalFunReq} becomes \Part{\texttt{part}}{\stHA{}}. The other \stREQ{SimPhyPartReq}\textit{s} become pairs of DT/PT, thus, are realised with a~pair of mirroring \Part{\texttt{part}}{\stMPGA{}} and \Part{\texttt{part}}{\stMSGA{}} (\Fig{fig:decomposition-concept}),
		
		
		\item \textbf{Step 5} (DT/PT decomposition -- Mirroring Agent Groups specification): Each mirroring \Part{\texttt{part}}{\stMPGA{}} and \Part{\texttt{part}}{\stMSGA{}} is iteratively decomposed to more groups to finally reach mirroring groups that each can be realised with a~single \stPA{} or \stSA{}. Each result of the decomposition iteration represents a~layer of the initial Group. The \texttt{mirror} relationship is set between \stMSGA{} and \textit{\stMPGA{}} and is specified in each layer of the decomposition. The decomposition scheme is shown in \Fig{fig:decomposition-concept}.
  \begin{figure}
      \centering
      \includegraphics[width=\linewidth]{figures/decomposition-scheme.pdf}
      \caption{Requirement-based SPSys decomposition, where \texttt{mirror} relationship constituting Physical and Digital Twins is obligatory for \stREQ{SimPhyPartReq}. As a~result of the decomposition, DT/PT may share \stHA{}s.}
      \label{fig:decomposition-concept}
  \end{figure}
		\item \textbf{Step 6} (Agent decomposition): Each \stA{} is decomposed to Subsystems. Various approaches can be used depending on the requirements formulation; however, we advise a~layered bottom-up one with a~definition of each layer interface. First, the hardware assigned to each \stA{} is expressed as \stPRR{}\textit{s}, \stPRE{}\textit{s}, \stSRE{}\textit{s} and \stSRR{}\textit{s} (constituting Agent hardware layer). Next, the interfaces of  \stPVR{}\textit{s}, \stPVE{}\textit{s}, \stSVE{}\textit{s} and \stSVR{}\textit{s} are defined based on \Sec{sect:subsystem_types} (constituting Agent driver layer). The target is to develop a~\stDCS{} (constituting Agent control layer) that:
  \begin{itemize}
      \item manages both mirroring Agents' behaviour,
      \item controls hardware (simulated/physical) using the embodiment-common interface of \stPDGS{} and \stSDGS{},
      \item communicates with other Agents using an inter-agent interface.
  \end{itemize}
  However, during the design process and testing, a~temporary \stSCS{} and \stPCS{} are helpful. Mirroring Agents consist of identical control layers; however, the Agents differ in drivers and hardware layers. The driver layer must fill the gap between the hardware and controller layers in the specific embodiments to enable embodiment abstraction for the control layer in mirroring Agents.
		
		\item \textbf{Step 7} (Structure evaluation): In each design iteration, the structure is evaluated. We propose the following evaluation factors for a two-scope analysis:
		
  \begin{itemize}
      \item System-wide:
        \begin{itemize}
			\item \textbf{Controller integrity factor} (\texttt{IIF}=$\frac{c^{dcs}}{c^{All}}$), where $c^{dcs}$ and $c^{All}$ are the cardinalities of \stDCS{}\textit{s} and all system \stCS{}\textit{s} accordingly, 
      			\item  \textbf{Driver generalisation factor} (\texttt{DGF}=$\frac{r_u}{r}$), where $r_u$ is the count of Real Subsystems aggregated in an Agent controlled by a~\stDCS{} and $r$ is the count of all Real Subsystems in the system,
   
			\item \textbf{Digital Twin coverage} (\texttt{DTC}=$\frac{a_{P}^{m}}{a_{P}^{All}}$), where $a_{P}^{m}$ is the count of \stPA{} aggregated in a~\stMPGA{} being a~PT of a~DT (\stMSGA{}), and $a^{P}_{All}$ is the count of all \stPA{} in the system,
     \end{itemize}
     \item DT/PT pair-wide:
     \begin{itemize}
			\item \textbf{Mirror integrity factor} (\texttt{MIF}$_{n}$=$\frac{c_{n}^{dcs}}{c_{n}^{All}}$), where {\textit{n}} is the considered pair of mirroring \stMPGA{} and \stMSGA{} composing one DT/PT pair, $c_{n}^{dcs}$ and $c_{n}^{All}$ are the counts of \stDCS{}\textit{s} and all \stCS{}\textit{s} accordingly in {\textit{n}$^{th}$} DT.
     \end{itemize}
  \end{itemize}

The structure optimisation target is the maximisation of the embodiment-common part of the system (\texttt{IIF}, \texttt{MIF}, \texttt{DGF}, \texttt{DTC}  factors) to maximise simulation-based testing coverage. The share of physical parts mirrored with Digital Twins (\texttt{DTC}) additionally boosts the system's robustness, as DT can replace malfunctioned hardware. The detailed analysis of the proposed factors is described in \Sec{sec:evaluation-factors-analysis}. The optimisation target can be defined with the above factors or others that can be defined for a~specific system. If the evaluation result is unsatisfactory, the system should be redesigned (starting from \textbf{Step 5}) following the factors' maximisation advice defined in \Sec{sec:evaluation-factors-analysis}.
		
		\item \textbf{Step 8} (System setups): Based on the \textit{optional} stereotypes in the requirements, all possible system setups emerge. Each setup (\stSSGA{}) is specified with an Internal Block Diagram (example diagrams are shown in \Fig{fig:simulated_sega_ibd},~\ref{fig:physical_sega_ibd}). The diagram shows the Agents composing given \stSSGA{}, their communication and interaction with Simulated and Physical Worlds. It should be noted that the system's operational setups are just a starting point for \stSSGA{}s specification. For each implementation testing scenario, a~\stSSGA{} should be specified. DTs are broadly used in development optimisation and CPS development safety improvement; therefore, in particular, for testing a \Part{part}{\stMPGA{}}, a~\stSSGA{} consisting of \Part{part}{\stMSGA{}} (DT of the \stMPGA{}) should be defined. The next step of this procedure makes sure that the \stSSGA{} with \Part{part}{\stMSGA{}} is implemented and tested prior to \stSSGA{} including \Part{part}{\stMPGA{}}.
	
	\end{itemize}
	\noindent\textbf{System implementation and testing}
	\begin{itemize}
		\item \textbf{Step 9} (Implementation of the Agents): \stSA{}s and \stHA{}s should be implemented before \stPA{}s for safety reasons. We want to test the system in simulation before its deployment on the real hardware. To achieve this, we queue \stSSGA{}s implementation and testing based on the simulation implementation factor, such that we begin with a~\stSSGA{} consisting of the highest share of the \stSA{}s and \stHA{}s and the lowest of \stPA{}s. The share evaluation is achieved with the simulation implementation factor. Therefore, the implementation step starts with a~\stSSGA{}, whose simulation implementation factor is the highest. The simulation implementation factor for example \Part{ex1}{\stSSGA{}} is $\mathtt{SIF}_{ex1}=\frac{s_{ex1}+h_{ex1}}{a_{all}}$, where $s_{ex1}$ and $h_{ex1}$ are cardinalities of the unimplemented \stSA{}\textit{s} and \stHA{}\textit{s} in \Part{ex1}{\stSSGA{}} and ${a_{all}}$ is a~number of Agents in the system. Before implementation, Subsystems must be translated to a PSM. For robotic systems utilising ROS/ROS2, we propose MeROS DSL~\cite{meros}. Implementation should include unit testing of each Subsystem and Agent (e.g. applying Robot Unit Testing 
 methodology~\cite{10.1007/978-3-319-11900-7_22}).
		\item \textbf{Step 10} (Integration verification): Test scenarios execution for all fully implemented \stSSGA{}.
	\end{itemize}
	
	
 \section{The design evaluation factors analysis}
 \label{sec:evaluation-factors-analysis}
  This section describes the interpretation of the evaluation factors and which system features they evaluate. We describe characteristics of edge case SPSys that scores maximum or minimum values of the design evaluation factors. This gives a basic intuition on the correlation between the factor values and the SPSys features. The interpretation of the evaluation factors is as follows:
 \begin{itemize}
			\item \texttt{IIF} -- is a~share of the software controller common between the embodiments. Virtual Subsystems are not considered, as their count may be related to the Real Subsystem counts in each embodiment. It is maximised by the reduction of the number of \stSCS{}\textit{s} and \stPCS{}\textit{s} in favour of an inter-embodiment \stDCS{}\textit{s}, {The higher} \texttt{IIF} is, the more software components are shared between the simulation and physical embodiments. At maximum (\texttt{IIF}=1), all hardware abstract parts of the system are common. 
 \begin{itemize}
     \item \texttt{IIF} = 0: There are no \stDCS{}, only \stPCS{} or \stSCS{}. The system’s parts in simulated and physical embodiments are disjunctive. Simulation-based testing is not possible. The system’s functions in the simulation may be completely different from those in the physical embodiment.
     \item \texttt{IIF} = 1: All Control Subsystems are \stDCS{}, and there are no \stPCS{} or \stSCS{}. This means all hardware abstract parts of the system are common between its embodiments, and the coverage of simulation-based testing is maximised and allows integration testing in simulation.
     \end{itemize}
			\item \texttt{MIF}$_{n}$ -- is a~share of the system parts common between Physical and Digital Twins composing the \textit{n}$^{th}$ twin pair (managing given \stREQ{SimPhyPartReq}). It is similar to~\texttt{IIF} but within the scope of $n^{th}$ pair of Physical and Digital Twin. { Tips for maximisation of the \texttt{MIF}$_{n}$ factor} are: \begin{itemize}
			    \item extraction of common functions as \stHA{}\textit{s} from \stMPGA{} and \stMSGA{} \item and/or redesign of interfaces between a~\stSCS{} and \stSDGS{} and between a~\stPCS{} and \stPDGS{} to emerge a~common \stDCS{} from the  \stSCS{} and \stPCS{},
       
			\end{itemize}
			\item \texttt{DGF} -- is a~share of Real Subsystems (hardware) controlled by \stDCS{}\textit{s} (shared controller). It expresses hardware control integrity between the embodiments.
   
     \begin{itemize}
     \item \texttt{DGF} = 0: All Hardware parts are controlled by embodiment-specific Control Subsystems. The causes of this depend on a specific case:
     \begin{itemize}
     \item For Physical Hardware without a~DT, it means the interface to hardware is embodiment-specific; thus, extending the system with a~DT of the hardware is complicated and would require adding simulation-specific \stSCS{}.
     \item For Physical Hardware with a~DT, it means the Hardware Drivers interface of Physical and Digital Twins differ, and the software using the interface differs between the embodiments. This means the system part designed as DT of the Physical hardware is not a~proper DT.
 \end{itemize}
     \item \texttt{DGF} = 1: All Hardware parts are controlled by embodiment-abstract Control Subsystems; thus, the Agents managing hardware are interchangeable between the embodiments, or future Digital/Physical Twin integration for Physical/Simulated Hardware is straightforward.
     
     \end{itemize}
			\item \texttt{DTC} -- is a~share of hardware and its controllers mirrored with a~DT. Its increase boosts coverage of simulation-based testing of hardware controllers and system robustness utilising the DT concept. If \texttt{DTC} = 0, there are no DTs in the system; if \texttt{DTC} = 1, all Physical Hardware parts have DTs.
		\end{itemize}
 Based on the factors' values, one can evaluate the system design in terms of the following:
 \begin{itemize}
     \item Safety and hardware independence during software testing -- based on \texttt{IIF} (for system scope), \texttt{MIF}$_n$ (for $n^{th}$ DT),
     \item Simulation-based testing and failure examination/prediction of the system parts  -- based on \texttt{DTC}
     \item Inter-embodiment integrity of hardware controllers and readiness for simulation-based hardware testing  -- based on \texttt{DGF}.
 \end{itemize}
Maximisation of the factors is not always required, and the optimisation goal can be set at a different point in the factors' space. The goal depends on the specific system requirements. However, the factors' values inform the designer about the inter-embodiment integrity of the system design, so her/his decision is conscious.
	\section{Ilustrative example - goal validation}
	\label{sec:example-system}
We execute the SPSysDP to design, implement and test a~complex SPSys utilising a~service robot for the INCARE project. 
	The INCARE system idea and requirements are published in \cite{brenvcivc2020intuitive}. The framework model developed to manage robot tasks is published in \cite{Dudek-multitasking-romoco-2019, tasker2020}.
	Developing a~complex system requires different implementations of its parts in various development phases. In INCARE, we use some commercial products like the TIAGo robot with its control system. We develop and integrate new parts into it (e.g. human fall detector and TIAGo audio interface extension). In such a~case, developing one part requires a~dummy of another part while being developed simultaneously. Developers can simulate the underdeveloped parts while the physical devices are under construction or development. In the case of INCARE, we use a~dummy for the human fall detector while developing a~TIAGo robot application helping the elderly who may fall over. We use and modify the TIAGo robot in this project; thus, we specify its hardware and controller as a~part of the INCARE system specification. 
	
	The result of each step of SPSysDP is as follows:
	\paragraph*{\bfseries Step 1 and 2}
	we specify the structural and functional requirements based on the general requirements of the INCARE project. The general and the robot-specific requirement diagrams are shown in~\Fig{fig:incare_req}.
 	\begin{figure}
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/incare_main_req.png}
			\caption{INCARE structural requirements}
			\label{fig:main_req}
		\end{subfigure}
		%	\end{figure}
		%	\begin{figure}[h]
		\begin{subfigure}{\linewidth}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/robot_req.png}
			\caption{The Robot requirements, where TTS and STT are text-to-speech and speech-to-text functions}
			\label{fig:robot_req}
		\end{subfigure}
		\caption{Example part of the INCARE requirements}
		\label{fig:incare_req}
	\end{figure}
 The requirements were accepted after some Step~1$\leftrightarrow$Step~2 iterations. These iterations led, for instance, to the decomposition of the \Part{Communication with humans}{\stSPFR{}}  to \Part{TTS and STT}{\stSPFR{}} and \Part{Dialoge management}{\stCFR{}}.
	
	\paragraph*{\bfseries Step 3} The robot in the INCARE project coexists with humans; thus, we utilise \Part{WorldSync}{\stWMGA{}} to manage humans in the Simulated World. Detailed specification and realisation of \Part{WorldSync}{\stWMGA{}} is available in~\cite{hubero}.
	
	\paragraph*{\bfseries Step 4 and 5} In the final design iteration, the system is decomposed to 5 embodiment-specific Agents, one for each system part: \Part{TIAGo}{\stSA{}} mirroring \Part{TIAGo}{\stPA{}}, \Part{FallDetector}{\stSA{}} mirroring \Part{FallDetector}{\stPA{}} and \Part{SmartHome}{\stPA{}}. Additionally, there are 3 Hybrid Agents, one for each computational function of the system: \Part{ComplexTaskExecution}{\stHA{}}, \Part{Talker}{\stHA{}}, \Part{FakeAudio}{\stHA{}}. \Part{TIAGo}{\stSA{}}, \Part{FakeAudio}{\stHA{}} and \Part{Talker}{\stHA{}} compose \Part{Robot}{<<MirrSimGpAgents>>}, and \Part{TIAGo}{\stPA{}} and \Part{Talker}{\stHA{}} compose \Part{Robot}{<<MirrPhyGpAgents>>}.
	
	
	\paragraph*{\bfseries Step 6} To provide an example, we describe the final decomposition of two \Part{TIAGo}{\stSA{}} realisations (\texttt{O3deTIAGo} (\Fig{fig:tiago_sim_o3de_ibd}) being the robot simulator implemented in the O3DE simulator and \texttt{GazeboTIAGo} (\Fig{fig:tiago_sim_gazebo_ibd}) implemented in Gazebo) and \Part{TIAGo}{\stPA{}} (\Fig{fig:tiago_phy_agent_ibd}). Each robot hardware component is specified as either \stPRR{}, \stPRE{}, \stSRR{}, or \stSRE{}. \Part{O3deTIAGo: TIAGo}{\stSA{}} integrates the system with O3DE simulation environment; thus, \stSRR{}\textit{s} and \stSRE{}\textit{s} are core O3DE components interacting with the simulated world, called gems. \Part{GazeboTIAGo: TIAGo}{\stSA{}} integrates the system with Gazebo simulation environment; thus, \stSRR{}\textit{s} and \stSRE{}\textit{s} expose gazebo::SensorPlugin and gazebo::ModelPlugin interfaces accordingly. As the physical robot, we use PAL Robotics' TIAGo; thus, \stPRR{}\textit{s}, \stPRE{}\textit{s} interfaces are adequate Linux Kernel drivers managing communication with the devices. In \Part{GazeboTIAGo: TIAGo}{\stSA{}} case, the Simulated Drivers connect to the gazebo::SensorPlugin and gazebo::ModelPlugin interfaces and expose the robot state information and typical ROS topics/services (e.g. \textit{JointStateInterface} and \textit{EffortJointInterface} for \Part{MobileBaseController}{\stSVE{}}\footnote{This \stVE{} is based on \textit{gazebo\_ros\_control} package: \url{https://classic.gazebosim.org/tutorials?tut=ros_control} } and \textit{/scan} ROS topic for \Part{lidar}{\stSVR{}}). If Simulated World is the Gazebo environment, \stSVE{}\textit{s} and \stSVR{}\textit{s} are usually implemented as Gazebo Plugins. \stPDGS{} connects to Linux Kernel drivers and, as a~whole Group, exposes to \stCS{} identical interfaces as \stSDGS{}. The diagrams of the TIAGo robot agents (simulated and physical) show their common \Part{RobotIf}{\stDCS{}}; however, as the physical robot and Gazebo simulator run \Part{ROS1: RobotIf}{\stDCS{}}, and O3DE simulator runs \Part{ROS2: RobotIf}{\stDCS{}}. 
		
	\begin{figure}
		\centering
			\centering
			\includegraphics[width=0.9\linewidth]{./schemes/incare/tiago_o3de_ibd.png}
			\caption{IBD of \Part{O3deTIAGo: TIAGo}{\stSA{}}}
			\label{fig:tiago_sim_o3de_ibd}
			
	\end{figure}	
	\begin{figure}[t]
	
			\centering
			\includegraphics[width=0.9\linewidth]{./schemes/incare/tiago_gazebo_ibd.png}
			\caption{IBD of \Part{GazeboTIAGo: TIAGo}{\stSA{}}}
			\label{fig:tiago_sim_gazebo_ibd}
			
	\end{figure}	
	\begin{figure}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/tiago_phy_agent_ibd.png}
			\caption{IBD of \Part{TIAGo}{\stPA{}}}
			\label{fig:tiago_phy_agent_ibd}
	\end{figure}	
		
	\paragraph*{\bfseries Step 7} The final structure evaluation resulted with: \texttt{IIF}=1, \texttt{MIF}$_{Robot}$=1, \texttt{MIF}$_{FallDetector}$=1, \texttt{DGF}=1, and \texttt{DTC}=0.67. The result means the structure consists of no \stSCS{} or \stPCS{}, and one \stPA{} is not mirrored by a DT (\Part{SmartHome}{\stSA{}}). The lack of DT for \Part{SmartHome}{\stSA{}} results from the requirements (\Fig{fig:main_req}), where Smart Home is not \stSPPR{}); thus, this is an informed decision of the designer. \texttt{DGF}=1 means the considered \Part{SmartHome}{\stSA{}} has \stDCS{}; therefore, its DT integration to the system in the future will be straightforward. One of the previous design iterations resulted with:  \texttt{IIF}=$\frac{5}{7}=0.71$, \texttt{MIF}$_{Robot}$=1, \texttt{MIF}$_{FallDetector}$=0, \texttt{DGF}=$\frac{20}{22}=0.91$, \texttt{DTC}=0.67. In this iteration the \Part{FallDetector}{\stSA{}} and \Part{FallDetector}{\stPA{}} use embodiment specific control layer (\stSCS{} and \stPCS{}), because \Part{FallDetector}{\stSA{}} consists \stSCS{}\textit{s} only. To increase \texttt{MIF}$_{FallDetector}$ and \texttt{DGF} the common part of \Part{FallDetector}{\stSCS{}} and \Part{FallDetector}{\stPCS{}} was extracted. The common part constitutes \Part{FallDetector}{\stDCS{}} in the final design.
 The \Part{FallDetector}{\stDCS{}} becomes a~universal interface between \Part{ComplexTaskExecution}{\stHA{}} and the driver layer of \Part{FallDetector}{\stPA{}}. It forced decomposition of \Part{FallDetector}{\stSA{}} to \Part{FallDetector}{\stDCS{}}, \Part{FallDetector}{\stSVR{}} and \Part{FallDetector}{\stSRR{}}. The latter two simulate fall detector sensing. Thanks to the structure optimisation,  \Part{FallDetector}{\stDCS{}} is used in both embodiments in the final structure, and this part of \texttt{FallDetector} will be tested in simulation because it is common in simulated and physical embodiments of the system.

	\paragraph*{\bfseries Step 8} Based on the \stREQ{OptionalReq}\textit{s} in the requirements we define 12 \stSSGA{}\textit{s} for (\Part{SmartHome}{\stPA{}} existing or not, \Part{FallDetector}{\stPA{}} or \Part{FallDetector}{\stSA{}} or no FallDetecor, \Part{Robot}{\stPA{}} or \Part{Robot}{\stSA{}}). We show \Part{Simulated}{\stSSGA{}} (\Fig{fig:simulated_sega_ibd}) and \Part{Physical}{\stSSGA{}} (\Fig{fig:physical_sega_ibd}) Internal Block Diagrams (IBDs) to exemplify \stSSGA{} specification. \Part{Simulated}{\stSSGA{}} presents two realisation of \Part{TIAGo}{\stSA{}}--- \texttt{GazeboTIAGo} and \texttt{O3deTIAGo}.  

	\begin{figure}
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/simulated_sega_ibd.png}
			\caption{\Part{Simulated}{\stSSGA{}} with example requirement allocations}
			\label{fig:simulated_sega_ibd}
			
	\end{figure}
	\begin{figure}[t]
		
			\centering
			\includegraphics[width=\linewidth]{./schemes/incare/physical_sega_ibd}
			\caption{\Part{Physical}{\stSSGA{}} with example requirement allocations}
			\label{fig:physical_sega_ibd}
	\end{figure}
  
	\paragraph*{\bfseries Step 9 and 10} In INCARE the \Part{Robot}{\stPA{}} and \Part{Robot}{\stSA{}} are realised with TIAGo robot and its simulations. PAL Robotics mostly implemented these. 
	We mapped the robot hardware and software to our design (as shown in \Fig{fig:tiago_sim_o3de_ibd}, \ref{fig:tiago_sim_gazebo_ibd} and \ref{fig:tiago_phy_agent_ibd}).  \Part{RosControl}{\stSDGS{}} is a~software package\footnote{\url{http://wiki.ros.org/ros_control}} implementing various common ROS controllers, and \Part{SimTIAGoDrives}{\stSHGS{}} is a~package\footnote{\url{http://wiki.ros.org/pal_hardware_gazebo}} implementing Gazebo plugins controlling TIAGo drives.
	Additionally, we boosted the robot's voice communication ability using the Google Dialogflow service. We equipped \Part{TIAGo}{\stPA{}} with additional USB Microphones \cite{arvix-tiago} to improve its audio perception. The other \stA{}\textit{s} were implemented and tested following the simulation implementation factor. In the result, we got \Part{Simulated}{\stSSGA{}} implemented and tested before \Part{Physical}{\stSSGA{}}, what improved robot system development safety.
    The simulated and physical worlds' synchronisation feature (mirroring humans in the Simulated World) was implemented with HuBeRo framework as \Part{WorldSync}{\stWMGA{}} and tested in a~crowded hospital environment (\Fig{fig:hubero-sim}).
      \begin{figure}
      \centering
      \includegraphics[width=0.8\columnwidth]{figures/human-sim.jpg}
      \caption{A frame from \Part{WorldSync}{\stWMGA{}} testing.}
      \label{fig:hubero-sim}
  \end{figure}

	The INCARE system was deployed in an end-user home, and the videos present its performance in the example tasks--- transportation (\Fig{fig:tiago-transport})\footnote{\url{https://vimeo.com/670252925}} and fall assistance (\Fig{fig:tiago-fall})\footnote{\url{https://vimeo.com/670246589}}.

 
 

	\section{Summary}
	\label{sec:summary}
Numerous Cyber-Physical Systems include simulation parts either as Digital Twins (DT), demonstrators, or mockups utilised during their development. We postulate the Simulation-Physical System (SPSys) concept to describe this kind of system. SPSys includes physical, simulated and hybrid parts. They cooperate to fulfil the system's aim; however, some are used as DTs to boost the system's reliability and analysis possibility. Some parts of the system can be used in the development process only as mockups and prototype simulators to increase the simulation-based testing coverage of the system. This, in turn, improves prototype safety and the resulting system robustness. 

SPSys application is wide; in particular, it can work in a~dynamic environment so that it can observe exogenous actions of the environment's habitants. Such a~situation is problematic because DT must perfectly mirror its PT. To answer the above needs, we propose a Domain-Specific Language named Simulation-Physical System Modeling Language (SPSysML) that models the SPSys artefact and demonstrates SPSys taxonomy and the relationships between the types of SPSys parts. 

One of the crucial aspects of reliable software development is integrity and reusability. Therefore, we propose an SPSys Development Procedure (SPSysDP) that, using design evaluation factors, supports quantitative analysis and optimisation targeted to software re-use maximisation between DT and PT and in different system setups. We analyze the evaluation factors and show features of the systems that score edge case values of the factors. 

Finally, we verify SPSysML and SPSysDP in complex robot system development. We demonstrate step-by-step SPSysDP execution. We point out significant system structure changes resulting from the design evaluation and the proposed quantitative factor-based guidelines applications. An example is \Part{FallDetector}{\stSA{}} and \Part{FallDetector}{\stPA{}} integration improvement by common part isolation as \stDCS{}. Moreover, the verification shows that 33\% of the system's Physical Agents do not have DTs, and thanks to the design modification, the whole hardware (physical and simulated) is controlled with \stDCS{} (\texttt{DGF}=1). This has two main advantages. First, all Digital and Physical Twins pairs share a common control subsystem. Second, if there is a~\stPA{} or \stSA{} without a~twin, it can be easily integrated with its Digital or Physical Twin in the future. 

The conducted validation shows that the requirement profile for SPSys enables critical analysis and may result in requirement decomposition and explication. An example is the decomposition of the \Part{Communication with humans}{\stSPFR{}}  to \Part{TTS and STT}{\stSPFR{}} and \Part{Dialoge management}{\stCFR{}} in the first and second steps of SPSysDP. Thanks to the \Part{Dialoge management}{\stCFR{}} separation, the proposed requirement-based procedure for the system decomposition resulted in the implementation of \Part{Talker}{\stHA{}} managing the requirement. As a consequence of the above, the requirement is managed by a component usable in different setups in cooperation with the simulated or physical embodiment. Otherwise, the requirement would be managed separately in simulation and physical embodiments of the robot.
The presented validation confirms the features distinguishing our method from the others listed in Table~\ref{tab:related-work}:
\begin{itemize}
    \item Integrity evaluation with quantitative factors,
    \item SysML-based structure model and system development procedure,
    \item System design optimisation considering simulation and physical embodiments of the system,
    \item Multiple system execution and testing setups specification,
    \item Forcing simulation-based testing prior physical embodiment development using simulation implementation factor for sequencing \stSSGA{} implementation and testing, 
    \item Specification of Simulation-Physical System including multiple physical and simulated parts and multiple Digital Twins.
    \item \stWMGA{} artefact definition and including its design in SPSysDP to reflect the dynamic environment in simulation, enabling Digital Twins to observe exogenous actions.
\end{itemize}

Based on the conducted validation, we observe the following limitations of our work: 
\begin{itemize}
    \item SPSysDP is a roadmap for SPSys's development. Various methodologies can be defined by setting appropriate logic predicates in decision nodes. Therefore, SPSysDP does not specify whether the system is developed top-down, bottom-up or middle-out. The final development approach depends on the decision nodes specification, and it is a~challenge for a~specific system. However, the literature does not specify either a~universal terminal predicate for systems' requirement definition or system designing.
\item The proposed, systematic requirement-based system structuring method is a~good starting point for system design and guides the designer to associate mirroring agents and provides a straightforward association between the system components and its requirements. However, it may not be optimal for any system; therefore, we suggest further iterating the design stage with other system design methods, like those based on the Design Structure Matrix~\cite{eppinger2012design}.
\item The requirement model defines only types utilised by the proposed requirement-based structuring method; however, other requirement types may be necessary for a~specific Simulation-Physical system. In such a~case the project team should extend the requirement model.
\end{itemize}

	In the future, we plan to automate testing SPSysML structure and code generation based on it with known, universal tools like Matlab and Enterprise Architect. Furthermore, this work revealed the need for a CPS structure optimisation indicators taxonomy. SPSysML and future work lead to optimal structure development automation for complex robot systems.

\section*{Acknowledgment}
The research was funded by the Centre for Priority Research Area Artificial Intelligence and Robotics of Warsaw University of Technology within the Excellence Initiative: Research University (IDUB) programme. The work takes the robot platform and its application from the INCARE project. The authors also acknowledge TALBOT, from the European Union’s Horizon 2020 research and innovation programme under Marie Skłodowska-Curie grant agreement No. 801342 (Tecniospring INDUSTRY) and the Government of Catalonia’s Agency for Business Competitiveness (ACCIÓ); and SHAPES, from the European Horizon 2020 research and innovation programme under grant agreement No 857159. The Spanish grant PID2021-125535NB-I00 has also supported the work.

	\bibliography{spsys}

\end{document}
