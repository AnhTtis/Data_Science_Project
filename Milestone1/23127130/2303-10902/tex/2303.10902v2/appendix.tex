\appendix
This supplementary material provides more details about our implementation (Sec.~\ref{sec:detail}), additional experiments on three corruption datasets (Sec.~\ref{sec:exp_corruption}), some discussion (Sec.~\ref{sec:discussion}), running time analysis (Sec.~\ref{sec:running_time}) and detailed results (Sec.~\ref{sec:full_results}).
\section{Other Implement Details}
\label{sec:detail}
We run our experiments mainly on a single RTX-A6000 or RTX-2080Ti GPU, depending on the need for GPU memory. For source training, we set the batch size as 32 for each source domain and the learning rate as $5e^{-5}$. We set dropout probability and weight decay to zero. We train source model 5k iterations except for DomainNet. We tripled it from 5k to 15k following \cite{swad}. All images are resized to 224$\times$224 and data augmentation is used in source domain training, which includes randomly cropping, flipping horizontally, jittering colour, and changing the intensity.

For implementations of different test time adaptation methods, we use publicly released code of T3A \cite{IwasawaM21}\footnote{\url{https://github.com/matsuolab/T3A}}, except for LAME \footnote{\url{https://github.com/fiveai/LAME}} \cite{BoudiafMAB22} and ETA\footnote{\url{https://github.com/mr-eggplant/EATA}} \cite{pmlr-v162-niu22a} we use source code of authors. For PL \cite{lee2013pseudo}, we set confidence as 0.9. We resize all images to 224$\times$224 and no data augmentation is used during the test time adaptation process.

For different backbones, we use \texttt{torchvision} implementation \footnote{\url{https://github.com/pytorch/vision}} except for ViT-B/16 and MLP-mixer, we use implementation from \texttt{timm} library\footnote{\url{https://github.com/rwightman/pytorch-image-models}}. For all experiments, we use three random seeds \{0,1,2\} and report the average results in the main text.
\section{Experiments on Corruption Benchmark}
\label{sec:exp_corruption}
We conduct experiments on three corruption datasets, including CIFAR-10/100-C and ImageNet-C. The results are listed in Table \ref{tab:exp_cifar_imagenet}. From the Table \ref{tab:exp_cifar_imagenet}, it it noticed that our method still achieves the state-of-the-art performance on corruption datasets.

\section{Discussion}
\label{sec:discussion}
\noindent
\textbf{Performance on VLCS}.  All compared methods shown poor performance on VLCS dataset. We notice that the label distribution is severely different among domains in VLCS compared to other datasets (\eg PACS and OfficeHome), which is probably why fewer methods show performance gain in VLCS compared to other datasets. We calculated the label distribution of VLCS dataset, as shown in Table \ref{tab:label_vlcs}. Since the label distribution is not considered for existing methods, the adaptation may fail.

\noindent
\textbf{Related Work}. There are some papers considering nearest neighbor information in the test time adaptation setting.
TAST \cite{jang2023testtime}, a concurrent work published in ICLR 2023, considers nearest neighbor information to refine pseudo-labels. AdaContrast~\cite{0001WDE22} uses a soft voting strategy among the nearest neighbors in the feature space to refine pseudo-labels. Both of them use nearest neighbor information to refine pseudo-labels. Different from them, our \textit{Memorized Spatial Local Clustering} aims to cluster features with the same pseudo-label.

\section{Running Time Analysis}
\label{sec:running_time}
We provide the running time of different methods for reference. Running time is tested using RTX-A6000 GPU and AMD-EPYC-7542 32 Core Processor. The results are listed in Table \ref{tab:running_time_analysis} using ResNet50 \cite{he2016deep} backbone.

\section{Full Results}
\label{sec:full_results}
We provide full results of different methods on ResNet-18/50, including results for each domain and error bars across three random seeds. See Table \ref{tab:pacs_resnet18}-\ref{tab:domainnet_resnet50}.
\begin{table}[t]
  \centering
  \caption{Label distribution on VLCS dataset.}
    \begin{tabular}{lccccc}
    \toprule
          & 0     & 1     & 2     & 3     & 4 \\
    \midrule
    Caltech101 & 237   & 123   & 118   & 67    & 870 \\
    LabelMe & 80    & 1209  & 88    & 42    & 1237 \\
    SUN09 & 20    & 932   & 1036  & 30    & 1264 \\
    VOC2007 & 330   & 699   & 428   & 420   & 1499 \\
    \bottomrule
    \end{tabular}
  \label{tab:label_vlcs}
\end{table}%

\begin{table}[t]
  \centering
  \caption{Accuracy on CIFAR-10/100-C and ImageNet-C. We use ResNet26 for CIFAR-10/100-C, and ResNet50 for ImageNet-C.}
  \resizebox{\linewidth}{!}{
   \begin{tabular}{lccc}
    \toprule
          & CIFAR-10-C & CIFAR-100-C & ImageNet-C \\
    \midrule
    ERM \cite{DBLP:books/daglib/0097035} & 70.7 & 41.4 & 18.0 \\
    BN \cite{SchneiderRE0BB20} & 77.4 & 48.0 & 33.5 \\
    Tent \cite{wang2021tent} & 80.7 & 51.7 & 42.7 \\
    PL \cite{lee2013pseudo}& 80.2 & 49.8 & 38.4 \\
    SHOT-IM \cite{liang2020we}& 80.7 & 52.1  & 43.1 \\    
    T3A \cite{IwasawaM21}& 77.4 & 44.6 & 36.5 \\     
    ETA \cite{pmlr-v162-niu22a}& 80.6  & \underline{52.4}  & \textbf{48.1} \\
    LAME \cite{BoudiafMAB22}& 79.4  & 50.6  & 47.6 \\
    %AdaC & \underline{81.1}  & 51.8 & 47.6 \\
    \hline
    Ours  & \textbf{81.7}  & \textbf{52.6}  & \underline{48.0}\\
    \bottomrule
    \end{tabular}  
  }    
  \label{tab:exp_cifar_imagenet}
\end{table}
\begin{table*}[t]
  \centering
  \caption{Running time analysis of different methods on four datasets. The units used in the table are seconds.  ``GD'' denotes whether the method requires gradient-based optimization.}
  
    \begin{tabular}{lccccc}
    \toprule
          & GD    & PACS \cite{li2017deeper}  & VLCS \cite{torralba2011unbiased}  & OfficeHome \cite{venkateswara2017deep} & DomainNet \cite{PengBXHSW19} \\
    \midrule
    ERM \cite{DBLP:books/daglib/0097035}   &  \XSolidBrush    & 17   & 17   & 56   & 736 \\
    BN \cite{SchneiderRE0BB20}   & \XSolidBrush     & 18   & 18   & 56   & 745 \\
    Tent \cite{wang2021tent}  & \Checkmark  & 32   & 33   & 67   & 1094 \\
    PL \cite{lee2013pseudo}   & \Checkmark     & 33   & 34   & 69   & 1339 \\
    SHOT-IM \cite{liang2020we}& \Checkmark     & 37   & 39   & 72   & 1339 \\
    T3A \cite{IwasawaM21}  & \XSolidBrush     & 19   & 19   & 57   & 829 \\
    ETA \cite{pmlr-v162-niu22a} & \Checkmark     & 21   & 22   & 66   & 1094 \\
    LAME \cite{BoudiafMAB22}  & \XSolidBrush     & 18   & 19   & 56  & 750 \\
    \hline
    Ours   & \Checkmark    & 35   & 37   & 71  & 1644 \\
    \bottomrule
    \end{tabular}
  \label{tab:running_time_analysis}%
\end{table*}

\begin{table*}[t]
  \centering
  \caption{Full results on PACS with ResNet18.}
    \begin{tabular}{lccccc}
    \toprule
    & A   & C & P & S & Avg \\
    \midrule
    ERM & 80.56$\pm$0.45 & 77.36$\pm$0.85 & 93.01$\pm$0.17 & 77.35$\pm$2.90 & 82.07$\pm$0.49 \\
    BN  & 81.60$\pm$0.16 & 82.00$\pm$0.51 & 92.85$\pm$0.24 & 74.86$\pm$1.10 & 82.82$\pm$0.34 \\ 
    Tent& 83.43$\pm$0.53 & 83.02$\pm$0.74 & 93.88$\pm$0.38 & 79.35$\pm$1.15 & 84.92$\pm$0.32\\
    PL  & 84.93$\pm$1.32 & 83.27$\pm$1.78 & 92.62$\pm$1.37 & 77.72$\pm$3.66 & 84.64$\pm$1.13 \\
SHOT-IM & 84.61$\pm$1.06 & 82.36$\pm$1.88 & 93.60$\pm$0.38 & 69.64$\pm$3.40 & 82.55$\pm$1.07 \\
    T3A & 83.00$\pm$0.76 & 79.56$\pm$0.44 & 94.48$\pm$0.34 & 76.95$\pm$2.94 & 83.50$\pm$0.67 \\
    ETA & 81.33$\pm$0.30 & 81.89$\pm$0.55 & 92.82$\pm$0.53 & 74.77$\pm$0.91 & 82.70$\pm$0.31 \\
   LAME & 83.05$\pm$0.53 & 83.06$\pm$0.51 & 94.30$\pm$0.29 & 77.91$\pm$0.80 & 84.58$\pm$0.23 \\
   Ours & 86.50$\pm$0.75 & 86.38$\pm$0.82 & 94.57$\pm$0.32 & 81.84$\pm$0.94 & 87.32$\pm$0.39 \\
    \bottomrule
    \end{tabular}%
  \label{tab:pacs_resnet18}%
\end{table*}%

\begin{table*}[t]
  \centering
  \caption{Full results on OfficeHome with ResNet18.}
    \begin{tabular}{lccccc}
    \toprule
    & A   & C & P & R & Avg \\
    \midrule
   ERM  & 55.49$\pm$0.61 & 51.41$\pm$0.46 & 71.92$\pm$0.47 & 73.67$\pm$0.18 & 63.12$\pm$0.26 \\
    BN  & 54.36$\pm$1.00 & 51.14$\pm$0.25 & 71.20$\pm$0.44 & 72.52$\pm$0.37 & 62.30$\pm$0.25 \\
  Tent  & 55.85$\pm$0.91 & 53.38$\pm$0.29 & 72.50$\pm$0.65 & 73.26$\pm$0.37 & 63.75$\pm$0.23 \\
    PL  & 54.64$\pm$0.96 & 48.36$\pm$1.58 & 68.83$\pm$1.08 & 69.05$\pm$0.58 & 60.22$\pm$0.37 \\
SHOT-IM & 55.45$\pm$1.08 & 52.32$\pm$0.99 & 73.23$\pm$0.76 & 72.67$\pm$0.37 & 63.42$\pm$0.52 \\
    T3A & 56.18$\pm$0.48 & 52.90$\pm$0.67 & 73.44$\pm$0.48 & 74.48$\pm$0.19 & 64.25$\pm$0.22 \\
   ETA  & 54.88$\pm$0.33 & 51.05$\pm$0.21 & 71.18$\pm$0.44 & 72.72$\pm$0.30 & 62.46$\pm$0.14 \\
   LAME & 54.84$\pm$0.86 & 50.90$\pm$0.26 &	70.85$\pm$0.30 & 72.19$\pm$0.30 & 62.20$\pm$0.21 \\ 
   Ours & 57.87$\pm$0.81 & 53.40$\pm$0.27 & 74.20$\pm$0.38 & 73.86$\pm$0.22 & 64.83$\pm$0.46 \\
    \bottomrule
    \end{tabular}%
  \label{tab:officehome_resnet18}%
\end{table*}%

\begin{table*}[t]
  \centering
  \caption{Full results on VLCS with ResNet18.}
    \begin{tabular}{lccccc}
    \toprule
    & C  & L & S & V & Avg \\
    \midrule
    ERM & 92.44$\pm$0.78 & 62.72$\pm$0.69 & 69.26$\pm$2.01 & 66.58$\pm$1.43 & 72.75$\pm$0.29 \\
   BN   & 76.23$\pm$1.99 & 57.84$\pm$0.80 & 58.04$\pm$0.73 & 65.12$\pm$0.35 & 64.31$\pm$0.47 \\
   Tent & 82.65$\pm$1.34 & 60.02$\pm$1.04 & 60.49$\pm$0.84 & 66.28$\pm$0.46 & 67.36$\pm$0.43 \\
    PL  & 86.64$\pm$3.45 & 61.66$\pm$1.47 & 61.78$\pm$2.66 & 65.64$\pm$1.53 & 68.93$\pm$1.07 \\
SHOT-IM & 76.65$\pm$2.94 & 57.34$\pm$1.26 & 59.13$\pm$0.85 & 66.46$\pm$0.55 & 64.90$\pm$0.70 \\
    T3A & 96.76$\pm$1.22 & 63.80$\pm$0.39 & 64.98$\pm$0.45 & 66.55$\pm$0.38 & 73.03$\pm$0.35 \\
    ETA & 76.1$\pm$1.90  & 57.89$\pm$0.87 & 58.12$\pm$0.73 & 65.31$\pm$0.23 & 64.35$\pm$0.40 \\
   LAME & 94.7$\pm$0.21  & 62.69$\pm$0.25 & 67.58$\pm$0.12 & 66.55$\pm$0.45 & 72.88$\pm$0.13 \\
   Ours & 97.2$\pm$1.15  & 64.50$\pm$0.28 & 65.42$\pm$0.34 & 67.32$\pm$0.38 & 73.61$\pm$ 0.42 \\
    \bottomrule
    \end{tabular}%
  \label{tab:vlcs_resnet18}%
\end{table*}%

\begin{table*}[t]
    \centering
    \caption{Full results on DomainNet with ResNet18.}
    \begin{tabular}{lccccccc}
    \toprule
         &  clipart        & infograph      & painting & quickdraw & real & sketch & Avg\\
    \midrule
     ERM & 55.86$\pm$0.15 & 16.85$\pm$0.06 & 44.80$\pm$0.20 & 12.49$\pm$0.38 & 56.74$\pm$0.04 & 46.96$\pm$0.12 & 38.95$\pm$0.08\\
     BN  & 55.90$\pm$0.09 & 12.07$\pm$0.15 & 43.58$\pm$0.06 & 11.63$\pm$0.15 & 56.47$\pm$0.09 & 47.16$\pm$0.15 & 37.80$\pm$0.06 \\
    Tent & 56.67$\pm$0.14 & 13.58$\pm$0.19 & 45.02$\pm$0.13 & 11.52$\pm$0.33 & 57.25$\pm$0.05 & 48.59$\pm$0.16 & 38.77$\pm$0.10\\
     PL  & 55.99$\pm$0.12 & 14.44$\pm$0.27 & 44.29$\pm$0.52 &  4.34$\pm$0.46 & 45.22$\pm$1.31 & 47.09$\pm$0.13 & 35.23$\pm$0.32\\
 SHOT-IM & 56.73$\pm$0.18 & 14.02$\pm$0.22 & 44.61$\pm$0.06 & 16.13$\pm$0.24 & 57.51$\pm$0.13 & 48.20$\pm$0.17 & 39.53$\pm$0.09\\
     T3A & 55.82$\pm$0.18 & 16.71$\pm$0.20 & 43.43$\pm$0.18 & 17.86$\pm$0.26 & 57.58$\pm$0.06 & 46.28$\pm$0.08 & 39.61$\pm$0.04\\
     ETA & 56.46$\pm$0.11 & 14.67$\pm$0.12 & 45.20$\pm$0.10 & 14.13$\pm$0.18 & 57.70$\pm$0.05 & 48.44$\pm$0.14 & 39.43$\pm$0.04\\
    LAME & 55.42$\pm$0.09 & 12.09$\pm$0.16 & 43.35$\pm$0.08 & 11.52$\pm$0.16 & 55.69$\pm$0.09 & 46.86$\pm$0.17 & 37.49$\pm$0.07 \\
    Ours & 56.79$\pm$0.12 & 18.42$\pm$0.14 & 46.71$\pm$0.12 & 13.45$\pm$0.22 & 57.65$\pm$0.12 &	48.12$\pm$0.24 & 40.19$\pm$0.08 \\
    \bottomrule
    \end{tabular}
    \label{tab:domainnet_resnet18}
\end{table*}

\begin{table*}[t]
  \centering
  \caption{Full results on PACS with ResNet50.}
    \begin{tabular}{lccccc}
    \toprule
    & A   & C & P & S & Avg \\
    \midrule
    ERM & 82.50$\pm$1.83 & 80.80$\pm$0.33 & 94.05$\pm$0.30 & 80.99$\pm$1.29 & 84.59$\pm$0.40 \\
    BN  & 83.27$\pm$0.47 & 84.91$\pm$0.43 & 94.03$\pm$0.31 & 77.92$\pm$1.23 & 85.03$\pm$0.20 \\
   Tent & 85.28$\pm$1.07 & 86.75$\pm$0.92 & 94.94$\pm$0.83 & 82.96$\pm$1.20 & 87.48$\pm$0.52 \\
     PL & 83.96$\pm$1.63 & 84.15$\pm$2.91 & 93.82$\pm$1.74 & 78.99$\pm$2.64 & 85.23$\pm$1.70 \\
SHOT-IM & 84.31$\pm$0.63 & 85.74$\pm$0.56 & 94.04$\pm$0.67 & 77.91$\pm$0.94 & 85.50$\pm$0.31 \\
    T3A & 84.07$\pm$0.68 & 82.37$\pm$0.92 & 95.02$\pm$0.27 & 82.72$\pm$1.06 & 86.04$\pm$0.24 \\
    ETA & 83.27$\pm$0.47 & 84.91$\pm$0.43 & 94.03$\pm$0.31 & 77.92$\pm$1.24 & 85.04$\pm$0.20 \\
   LAME & 84.97$\pm$0.77 & 85.50$\pm$0.55 & 95.04$\pm$0.23 & 80.97$\pm$1.09 & 86.62$\pm$0.22 \\
   Ours & 87.68$\pm$0.84 & 88.78$\pm$0.63 & 96.17$\pm$0.37 & 85.01$\pm$1.52 & 89.41$\pm$0.51 \\
    \bottomrule
    \end{tabular}%
  \label{tab:pacs_resnet50}%
\end{table*}%

\begin{table*}[t]
  \centering
  \caption{Full results on OfficeHome with ResNet50.}
    \begin{tabular}{lccccc}
    \toprule
    & A   & C & P & R & Avg \\
    \midrule
    ERM & 60.71$\pm$0.88 & 55.74$\pm$0.79 & 76.18$\pm$0.65 & 76.83$\pm$0.41 & 67.37$\pm$0.06 \\
    BN  & 58.23$\pm$0.76 & 55.62$\pm$0.68 & 75.08$\pm$0.60 & 75.47$\pm$0.35 & 66.10$\pm$0.20 \\
   Tent & 60.55$\pm$0.93 & 58.73$\pm$0.85 & 76.48$\pm$0.53 & 76.07$\pm$0.59 & 67.96$\pm$0.24 \\
     PL & 59.14$\pm$0.93 & 57.29$\pm$0.62 & 76.24$\pm$0.69 & 75.85$\pm$0.28 & 67.13$\pm$0.17 \\
SHOT-IM & 59.20$\pm$0.76 & 57.54$\pm$0.58 & 76.53$\pm$0.44 & 76.27$\pm$0.37 & 67.39$\pm$0.16 \\
    T3A & 61.23$\pm$1.00 & 56.69$\pm$1.11 & 77.95$\pm$0.43 & 77.31$\pm$0.22 & 68.29$\pm$0.21 \\
    ETA & 58.38$\pm$0.80 & 55.78$\pm$0.69 & 75.17$\pm$0.56 & 75.53$\pm$0.34 & 66.21$\pm$0.19 \\
   LAME & 58.67$\pm$0.70 & 55.58$\pm$0.53 & 75.09$\pm$0.65 & 75.40$\pm$0.31 & 66.19$\pm$0.20 \\
   Ours & 62.32$\pm$0.52 & 57.45$\pm$0.71 & 77.48$\pm$0.45 & 77.45$\pm$0.38 & 68.67$\pm$0.14 \\
    \bottomrule
    \end{tabular}%
  \label{tab:officehome_resnet50}%
\end{table*}%

\begin{table*}[t]
  \centering
  \caption{Full results on VLCS with ResNet50.}
    \begin{tabular}{lccccc}
    \toprule
    & C   & L & S & V & Avg \\
    \midrule
    ERM & 94.91$\pm$0.32 & 65.20$\pm$2.35 & 66.52$\pm$1.65 & 69.41$\pm$3.38 & 74.01$\pm$1.32 \\
    BN  & 75.26$\pm$1.15 & 56.85$\pm$0.53 & 60.87$\pm$0.68 & 66.16$\pm$0.59 & 64.78$\pm$0.34 \\
   Tent & 84.75$\pm$2.25 & 60.70$\pm$1.26 & 64.94$\pm$1.40 & 66.42$\pm$0.89 & 69.20$\pm$0.83 \\
     PL & 86.75$\pm$4.25 & 61.19$\pm$2.22 & 63.36$\pm$3.33 & 62.77$\pm$2.84 & 68.52$\pm$1.79 \\
SHOT-IM & 76.54$\pm$1.27 & 55.90$\pm$1.20 & 61.26$\pm$0.71 & 67.24$\pm$0.86 & 65.23$\pm$0.32\\
    T3A & 97.06$\pm$0.30 & 63.96$\pm$0.89 & 67.14$\pm$0.52 & 67.75$\pm$0.31 & 73.98$\pm$0.32 \\
    ETA & 75.27$\pm$1.13 & 56.85$\pm$0.52 & 60.89$\pm$0.67 & 66.16$\pm$0.58 & 64.79$\pm$0.34 \\
   LAME & 96.25$\pm$0.55 & 61.39$\pm$0.40 & 70.25$\pm$0.67 & 67.89$\pm$0.38 & 73.94$\pm$0.14 \\
   Ours & 97.40$\pm$0.41 & 64.89$\pm$0.64 & 68.05$\pm$0.45 & 68.12$\pm$0.43 & 74.52$\pm$0.27\\
    \bottomrule
    \end{tabular}%
  \label{tab:vlcs_resnet50}%
\end{table*}
\begin{table*}
    \centering
    \caption{Full results on DomainNet with ResNet50.}
    \begin{tabular}{lccccccc}
    \toprule
         &  clipart        & infograph      & painting & quickdraw & real & sketch & Avg\\
    \midrule
     ERM  & 64.76$\pm$0.06 & 22.11$\pm$0.11 & 51.77$\pm$0.18 & 13.84$\pm$0.14 & 64.66$\pm$0.21 & 54.04$\pm$0.27 & 45.20$\pm$0.09\\
     BN   & 64.46$\pm$0.09 & 15.62$\pm$0.05 & 50.64$\pm$0.08 & 11.84$\pm$0.05 & 63.86$\pm$0.11 & 53.86$\pm$0.19 & 43.38$\pm$0.03\\
     Tent & 65.78$\pm$0.08 & 18.18$\pm$0.02 & 52.96$\pm$0.01 & 10.77$\pm$0.11 & 64.85$\pm$0.09 & 55.71$\pm$0.09 & 44.71$\pm$0.03\\
     PL   & 64.96$\pm$0.05 & 19.00$\pm$0.03 & 50.30$\pm$0.27 &  4.21$\pm$0.68 & 54.40$\pm$0.55 & 54.20$\pm$0.15 & 41.18$\pm$0.13\\
SHOT-IM   & 65.62$\pm$0.05 & 18.73$\pm$0.21 & 52.41$\pm$0.08 & 19.01$\pm$0.24 & 66.47$\pm$0.12 & 55.54$\pm$0.08 & 46.30$\pm$0.07\\
    T3A   & 64.77$\pm$0.05 & 22.10$\pm$0.09 & 50.89$\pm$0.15 & 19.41$\pm$0.18 & 65.85$\pm$0.06 & 53.96$\pm$0.17 & 46.16$\pm$0.03\\
    ETA   & 65.11$\pm$0.09 & 19.37$\pm$0.19 & 52.69$\pm$0.11 & 18.24$\pm$0.33 & 65.92$\pm$0.10 & 55.48$\pm$0.16 & 46.13$\pm$0.08\\
    LAME  & 64.18$\pm$0.12 & 15.64$\pm$0.07 & 50.54$\pm$0.04 & 11.77$\pm$0.05 & 63.46$\pm$0.08 & 53.65$\pm$0.18 & 43.20$\pm$0.03\\
    Ours  & 66.12$\pm$0.08 & 24.12$\pm$0.12 & 52.82$\pm$0.10 & 18.17$\pm$0.08 &	68.45$\pm$0.12 & 56.72$\pm$0.12 & 47.73$\pm$0.05\\
    \bottomrule
    \end{tabular}
    \label{tab:domainnet_resnet50}
\end{table*}