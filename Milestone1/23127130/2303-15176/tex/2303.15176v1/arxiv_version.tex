\documentclass[journal, 12pt, draftclsnofoot, onecolumn]{IEEEtran}
\IEEEoverridecommandlockouts

% Load packages
\usepackage{amsmath,amssymb,amsfonts,steinmetz}
\usepackage{mathtools,algpseudocode,algorithm,MnSymbol}
\newcommand\hmmax{0}
\newcommand\bmmax{0}
\usepackage{bm}
\usepackage[pdftex]{graphicx}
\usepackage{textcomp}
\usepackage{color}
\usepackage{longtable}
\usepackage{gensymb}
\usepackage{booktabs}
%\usepackage{subfigure}
\usepackage{indentfirst}   
\usepackage{array}
\usepackage{multirow}
\usepackage{caption, subcaption}
\usepackage{tikz}
\usepackage{tabularx,ragged2e}
\usepackage{float}
\usepackage[inline]{enumitem}
\usepackage{nicefrac}
\usepackage{balance}
\usepackage{url}
\usepackage{pgfplots}
\addtolength{\topmargin}{.1in}
\usetikzlibrary{shapes.multipart,intersections}
\usepackage{cite}
\usepackage{xcolor}
\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{calc}
\makeatletter
\usepackage[nolist]{acronym}
\makeatother
\usepackage[draft]{todonotes}   % notes showed
\usepackage{upgreek}
\usepackage{seqsplit}
\usepackage[font={footnotesize},hypcap={false}]{caption}
\usepackage{hyperref}
\usepackage[utf8]{inputenc} %unicode support
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% define acronyms
\acrodef{RIS}{reconfigurable intelligent surface}
\acrodef{BS}{base station}
\acrodef{FF}{far field}
\acrodef{UE}{user equipment}
\acrodef{LoS}{line-of-sight}
\acrodef{NLoS}{non-line-of-sight}
\acrodef{NF}{nearfield}
\acrodef{SNR}{signal-to-noise ratio}
\acrodef{SINR}{signal-to-interference-and-noise-ratio}
\acrodef{SISO}{single-input-single-output}
\acrodef{PEB}{position error bound}
\acrodef{FIM}{Fisher information matrix}
\acrodef{SDP}{semidefinite program}
\acrodef{PSD}{positive semidefinite}
\acrodef{LMI}{linear matrix inequality}
\acrodef{MC}{multi-carrier}
\acrodef{MIMO}{multiple inputs multiple outputs}
\acrodef{OEB}{orientation error bound}
\acrodef{DoD}{Direction of Departure}
\acrodef{TDoA}{Time Difference of Arrival}
\acrodef{RIS}{Reconfigurable intelligent surface}
\acrodef{w.r.t.}{with respect to}
\acrodef{SRE}{Smart radio environment}
\acrodef{TX}{transmitter}
\acrodef{RX}{receiver}
\acrodef{QoS}{Quality of Service}
\acrodef{DFT}{Discrete Fourier Transform}

% define commands
\newcommand{\h}{\mathsf{H}}
\newcommand{\vect}[1]{\boldsymbol{#1}}
\newcommand{\norm}[1]{\left\lVert#1\right\rVert}

\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}

\newcommand{\pp}{\boldsymbol{p}}
\renewcommand{\aa}{\boldsymbol{a}}
\renewcommand{\AA}{\boldsymbol{A}}
\newcommand{\bb}{\boldsymbol{b}}
\newcommand{\BB}{\boldsymbol{B}}
\newcommand{\CC}{\boldsymbol{C}}
\newcommand{\xx}{\boldsymbol{x}}
\newcommand{\XX}{\boldsymbol{X}}
\newcommand{\yy}{\boldsymbol{y}}
\newcommand{\JJ}{\boldsymbol{J}}
\renewcommand{\gg}{\boldsymbol{g}}
\newcommand{\ff}{\boldsymbol{f}}
\newcommand{\FF}{\boldsymbol{F}}
\newcommand{\nn}{\boldsymbol{n}}
\newcommand{\II}{\boldsymbol{I}}
\newcommand{\uu}{\boldsymbol{u}}
\newcommand{\UU}{\boldsymbol{U}}
\newcommand{\ee}{\boldsymbol{e}}
\newcommand{\boldone}{\boldsymbol{1}}

\newcommand{\pprx}{\pp_{\text{\ac{RX}}}}
\newcommand{\pptx}{\pp_{\text{\ac{TX}}}}

\newcommand{\omegab}{\bm{\omega}}
\newcommand{\Omegab}{\bm{\Omega}}
\newcommand{\upzetab}{\bm{\upzeta}}
\newcommand{\upmub}{\bm{\upmu}}
\newcommand{\lambdab}{\bm{\lambda}}
\newcommand{\Lambdab}{\bm{\Lambda}}



\newcommand{\gettikzxy}[3]{%
  \tikz@scan@one@point\pgfutil@firstofone#1\relax
  \edef#2{\the\pgf@x}%
  \edef#3{\the\pgf@y}%
}
% ---------------------------------------
% ---------------------------------------
% new material
\newcommand{\newMaterial}[1]{\textcolor{olive}{#1}}
% ---------------------------------------
% ---------------------------------------
%%% Begin ...
\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Enter the title of your article here     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\title{Nearfield Localization Performance with Reflective RIS under Beam Pattern Approximation from Real Hardware Characterization}
% or 
\title{Performance of RIS-Aided Nearfield Localization under Beams Approximation from Real Hardware Characterization}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Enter the authors here                   %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\author{\IEEEauthorblockN{Moustafa Rahal\IEEEauthorrefmark{1}\IEEEauthorrefmark{3}, Beno\^{i}t Denis\IEEEauthorrefmark{1}, Kamran Keykhosravi\IEEEauthorrefmark{2}, \\Musa Furkan Keskin\IEEEauthorrefmark{2}, Bernard Uguen\IEEEauthorrefmark{3}, George C.~Alexandropoulos\IEEEauthorrefmark{4}, and Henk Wymeersch\IEEEauthorrefmark{2}}\\
\IEEEauthorblockA{\IEEEauthorrefmark{1}CEA-Leti, Université Grenoble Alpes, F-38000 Grenoble, France\\
\IEEEauthorrefmark{2}Department of Electrical Engineering, Chalmers University of Technology, Gothenburg, Sweden\\
\IEEEauthorrefmark{3}Université Rennes 1, IETR - UMR 6164, F-35000 Rennes, France\\
}
\IEEEauthorrefmark{4}Department of Informatics and Telecommunications,
National and Kapodistrian University of Athens, Greece
\thanks{Correspondent author: Moustafa Rahal (contact: moustafa.rahal@cea.fr).}
}
\maketitle
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% The Abstract begins here                  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstract}
The technology of reconfigurable intelligent surfaces (RIS) has been showing promising potential in a variety of applications relying on Beyond-5G networks. \ac{RIS} can indeed provide fine channel flexibility to improve communication quality of service (QoS) or restore localization capabilities in challenging operating conditions, while conventional approaches fail (e.g., due to insufficient infrastructure, severe radio obstructions). In this paper, we tackle a general low-complexity approach for optimizing the precoders that control such reflective surfaces under hardware constraints. More specifically, it allows the approximation of any desired beam pattern using a pre-characterized look-up table of feasible complex reflection coefficients for each \ac{RIS} element. The proposed method is first evaluated in terms of beam fidelity for several examples of \ac{RIS} hardware prototypes. Then, by means of a theoretical bounds analysis, we examine the impact of \ac{RIS} beams approximation on the performance of near-field downlink positioning in non-line-of-sight conditions, while considering several \ac{RIS} phase profiles (incl. directional, random and localization-optimal designs). 
Simulation results in a canonical scenario illustrate how the introduced \ac{RIS} profile optimization scheme can reliably produce the desired \ac{RIS} beams under realistic hardware limitations. They also highlight its sensitivity to both the underlying hardware characteristics and the required beam kinds in relation to the specificity of RIS-aided localization applications.
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% The keywords begin here                  %%
%%                                          %%
%% Put each keyword in separate \kwd{}.     %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{IEEEkeywords}
Reconfigurable intelligent surfaces,
Nearfield localization,
Beam approximation,
Look-up table,
Hardware characterization
\end{IEEEkeywords}


\section*{Introduction}

\acp{RIS} consist of (semi-)passive controllable electromagnetic mirrors or sensing surfaces, and have been identified as a key enabling technology for the upcoming sixth (6G) generation of wireless systems \cite{huang2019reconfigurable,qignqingwu2019}. They are indeed expected to reinforce both the service continuity and the \ac{QoS} of communication networks, or even to locally boost their performance on demand, while limiting the need for additional costly elements of infrastructure (e.g., active \ac{BS}). Although they were mostly intended to extend coverage under severe radio blockages, they have also shown fine capabilities to purposely shape the wireless propagation channel in a variety of location-dependent applications, such as \ac{UE} localization (in both geometric \ac{NF} and \ac{FF} regimes), physical environment mapping and distributed spectrum sensing, or limitation of unintentional radio emissions (e.g., for improved communication security or reduced field exposure) \cite{RISE6G_COMMAG,Kamran_Leveraging}.
%\cite{RISE6G_COMMAG,rise6g}.}

%An important property of \acp{RIS} is that they are largely passive,
%\acp{RIS} usually require per-element control  \cite{huang2020holographic}. 
 
The different unit elements of a \ac{RIS} can be optimized, for instance in order to concentrate the reflected energy in the \ac{UE} direction, similar to phased array systems \cite{Molisch_HBF_2017_all}. Many models have already been proposed accordingly, including phase control \cite{huang2019reconfigurable}, quantized phase control \cite{alexandg_2021}, amplitude-dependent phase control \cite{Abeywickrama_2020}, and joint amplitude and phase control \cite{Larsson_2021}, which all require a dedicated optimization procedure.
%
However, as \acp{RIS} are usually made of low-cost hardware, they may be naturally subject to imperfections, impairments, non-linearity effects, dispersed characteristics... \cite{RIS_Impairments,shen2020beamforming}. If not properly taken into account, these phenomena can significantly alter the result of the \ac{RIS} optimization and hence ultimately, the \ac{RIS} behavior itself, compared to the idealized case (i.e., with an unconstrained \ac{RIS} profile).
One unified way to address the various control models above while accounting for hardware characteristics is to use a lookup table. For a reflective RIS, the latter typically contains all the feasible complex reflection coefficients at each of the surface elements (i.e., in terms of amplitude and phase) for a certain \ac{RIS} hardware. In addition, such lookup tables can account for extra coupling effects, which are very complex to model analytically otherwise.

In this paper, we present a computationally efficient method initially introduced in \cite{Rahal_EuCNC22}, which can optimize the configuration of a reflective \ac{RIS} from an a priori imposed lookup table %(including the complex responses of a single \ac{RIS} element, based on real measurements) 
with the aim of approximating complex beam patterns.
%The proposed approach can account for both far-field and near-field effects, phase-dependent amplitude responses, and is amenable to a low-complexity implementation.
%Beyond low complexity considerations, another main advantage of the proposed method lies in its generality.}
%
Although the previous approach is generic and applicable to any type of \acp{RIS} or beams, %to (approximately) generate arbitrary beam patterns under real hardware constraints, 
as a concrete and practical study case, we herein consider applying it into the specific context of RIS-aided \ac{NF} localization, which somehow requires combining particular \ac{RIS} beams to reach optimality.
%
Localization-optimal \ac{RIS} phase configurations can indeed be determined through \ac{PEB} optimization, assuming prior information about the \ac{UE} \cite{Elzanaty2021,Rahal_Localization-Optimal_RIS}. %Beyond making localization feasible~\cite{rahal2021ris,Kamran_Leveraging}, 
The aim is hence to improve positioning performance in \ac{NLoS} situations, while relying on a unique \ac{RIS}-reflected path (i.e., as estimated at the \ac{UE}) over a sequence of \ac{SISO} downlink transmissions \cite{keykhosravi2021siso,rahal2021ris} (See Fig.~\ref{fig:Geometry}). Aiming more specifically at improving \ac{NF} localization performance in \cite{Rahal_Localization-Optimal_RIS}, it has been shown that such optimization would necessitate the use of four distinct types of beams at the reflective \ac{RIS} (i.e., one steering beam and its three derivatives \ac{w.r.t.} spherical coordinates). Those four desired beams will be taken here as references into the proposed synthesis process, and compared to directional or random designs. 

Overall, the main paper contributions are as follows: \emph{(i)} Leveraging the recent results from \cite{Rahal_EuCNC22} and \cite{Rahal_Localization-Optimal_RIS} recalled above, we apply a low-complexity \ac{RIS} beams approximation technique to RIS-aided \ac{NLoS} localization with several a priori \ac{RIS} design assumptions (incl. random, directional and localization-optimal options); \emph{(ii)} Accordingly, our analysis now includes not only a qualitative assessment of the fidelity of approximated \ac{RIS} beams \ac{w.r.t.} the desired beams (by means of a 1D/2D beam shape analysis), but also a quantitative assessment of the practical performance degradation induced by such beams approximation in comparison with their respective unconstrained  configurations (by means of a \ac{PEB} analysis); \emph{(iii)} Regarding input hardware constraints, we also extend the use of look-up tables (resulting from experimental characterization) to that of four distinct real \ac{RIS} prototypes \cite{fara2021prototype,DiPalma_2017,GNW_Prototype} and we devise their impact on localization performance in light of their respective design specificity.
\subsubsection*{Notations}
%
Vectors and matrices are, respectively, denoted by lower-case and upper-case bold letters (e.g., $\xx, \XX$). The notation $[\aa]_{i}$ is used to point at the $i$-th element of vector $\aa$, and similarly, $[\AA]_{i,j}$ represents the element in the $i$-th row and $j$-th column of matrix $\AA$, while $i:j$ is used to specify all the elements between indices $i$ and $j$. The Hadamard product is denoted by $\odot$ and $\dot{\aa}_{x}=\partial \aa/ \partial x$ is the partial derivation of $\aa$ \ac{w.r.t.} $x$. Moreover, the notations $(.)^\top$, $(.)^{*}$ and $(.)^{\mathsf{H}}$ denote the matrix transposition, conjugation, and Hermitian conjugation, respectively. Finally, $(.)^{(r)}$ denotes the $r$-th iteration in a loop and $\text{proj}_{\mathcal{V}}(\xx)$ represents the projection of vector $\xx$ onto a set $\mathcal{V}$.
%
The operator $\mathrm{tr}(\XX)$ denotes the trace of matrix $\XX$ and $\text{diag}(\xx)$ denotes a diagonal matrix with diagonal elements defined by vector $\xx$.  Finally, $\Vert\cdot\Vert$ is the $l_{2}$-norm operator and $(.)^\smallstar$ denotes the solution of an optimization problem.

\section*{Related State of the Art}

%An important challenge with \ac{RIS} lies in the optimization of their profiles 
The optimization of \ac{RIS} profiles
(i.e., the fine tuning of their element-wise reflection coefficients and/or phases) is a particularly challenging task in itself which can be seen as a beam design problem. This has been extensively studied for phased arrays, in both communication and radar literature \cite{monopulse_review}. 
%
%Typically, 
%the so-called \textit{multibeams} were proposed in \cite{zhang2018multibeam} to support joint communication and sensing, while in \cite{keskin_optimal_2021}, 
%in the monopulse radar literature \cite{monopulse_review}, so-called derivative (i.e., \textit{difference}) beams were proposed to support accurate localization, and were later extended to a \ac{RIS} setting in \cite{rahal2021ris}. 
%
The main difference, however, between a reflective \ac{RIS} and a phased array radar is that in order to create azimuth- and elevation-difference beams in reception via the latter, separate beamforming architectures are commonly employed  \cite{phasedArray_99,phasedArray_2016}; while on the other hand, a reflective \ac{RIS} is only able to passively reflect the impinging signals through optimized phase control and does not produce receive beams via dedicated hardware. 
%Hence, it is worth investigating how \ac{RIS} phase profiles can be designed under lookup table constraints to produce \textit{difference} beams.
%Such beams are two examples of non-standard beams that differ from traditional directional beams (i.e., from steering vectors). 

%(i) 
%before or %(ii) 
%after performing channel estimation. 
%
%For data communication purposes, the latter problem %(ii) 
%can be solved based on the estimated cascaded channel responses or using a priori location information~\cite{abrardo2020intelligent}. 
%
In a pure \ac{RIS}-aided communication context, the usual approach is to aim at increasing \ac{SNR} at the receiver, relying on the estimated cascaded channel responses (i.e., between \ac{BS} and \ac{RIS}, and between \ac{RIS} and \ac{UE}), or possibly simply based on the prior \ac{UE} location information (exact or more likely just estimated)~\cite{abrardo2020intelligent}.
%
The corresponding problem %(i) 
can hence be solved out by maximizing recovery performance, %\cite{chen2019channel}
based on the \ac{DFT} %~\cite{wei2021channel} 
and Hadamard matrices,
%~\cite{you2020channel}
or by leveraging location information from an external system~\cite{hu2020location}.
%In \cite{abrardo2020intelligent,hu2020location}, the required location information comes from an external source. However, location information can also be retrieved from \ac{RIS}-modified signals themselves, while relying on a unique wireless system. %\textcolor{red}{[BD: I don't know if we really need to describe in details the optimization of \ac{RIS} phase profiles for communication... we may summarize a bit or maybe consider merging some of the references at least.]}
%

As for RIS-aided localization specifically, a variety of control solutions have also been put forward recently, depending on the corresponding positioning strategy and operating context. In \cite{wymeersch_beyond_2020} for instance, based on prior \ac{UE} location, simple directional reflection beams are applied at a few \acp{RIS}, which are down-selected to maximize the amount of available location information (in a Fisher Information sense) while avoiding multipath interference. %, which intuitively corresponds to concentrating the reflected power towards the \ac{UE} and accordingly, increase \ac{SINR} at the \ac{UE}. % in presence of multipath self-interference for next location estimation steps. 
In \cite{keykhosravi2021siso}, even simpler random \ac{RIS} phase profiles are used to jointly enable downlink \ac{SISO} positioning and synchronization, relying on \ac{MC} transmissions, without necessitating prior information.
% in terat the detrimental cost of performance degradation though. 
In \cite{Elzanaty2021}, RIS
phases and beamformers are jointly optimized with respect to both the \ac{PEB} and the \ac{OEB} in a generic \ac{MIMO} \ac{MC} context. To overcome both the high number of real optimization variables and the problem non-convexity (resulting from the joint optimization of coupled variables), a simpler approach is then proposed that maximizes the sum of the \acp{SNR} for the central subcarrier at each \ac{BS} antenna. An upper bound on the \ac{SNR} is first maximized, before applying additional constant phase shifts to the \ac{RIS} profile so that both direct and reflective paths are quasi-coherently summed up at each receiving antenna.

Focusing on the specific case of \ac{NF} localization, many other \ac{RIS} optimization schemes have been put forward, such as \ac{SNR} maximization in \cite{Rinchi22} and \cite{Palmucci22} and \ac{DFT} matrices in \cite{Pan22}. On the other hand, a traditional randomized \ac{RIS} phase design was considered in \cite{Ghazalian22} to achieve bi-static localization of the \ac{RIS}. In \cite{rahal2021ris}, random profiles are also utilized and the authors showed, theoretically, that this profile design can ensure localization continuity in \ac{NLoS} conditions through direct positioning out of one single RIS-reflected path, relying on \ac{NF} properties. However random profiles are still clearly suboptimal in terms of localization performance. In \cite{Rahal_Localization-Optimal_RIS}, based on \ac{PEB} optimization in the same \ac{NF} \ac{NLoS} context, it is shown that four distinct beams must be applied (i.e., one steering beam and its three derivatives as a function of spherical coordinates), while adjusting their relative weights (in the power or time domain, indifferently) depending on prior \ac{UE} location. Finally, in \cite{Mei22}, \ac{RIS} phase design and quantization are ruled by hardware and its effect is studied on the \ac{NF} focusing performance, but no practical constrained beam generation method is proposed.

% SoTA provided by George
% ---------------------------------
% ---------------------------------
%\cite{alexandropoulos_near-field_2022}: fast alignment algorithm for the \ac{RIS} phase shifts and the transceiver beamformer; variable-width hierarchical phase-shift codebook\\
%\cite{liu_low-overhead_2022}: A far-field beam-based beam training  scheme, where a deep residual network is employed to estimate
%the optimal near-field \ac{RIS} codeword\\
%\cite{chung_location-aware_2021}: \ac{RIS} beamwidth adaptation during
%beam training and atomic norm channel estimation of the cascaded
%channel\\
%\cite{chen-hu_differential_2022}: Differential data is used for the determination of the best beam for the RIS.\\
%\cite{palmucci_ris-aided_2022}: jointly design the reflection coefficients of multiple RISs and the precoding strategy of a single BS to optimize the tracking of the position and the velocity of a single UE, with an iterative block coordinate descent algorithm.
% ---------------------------------
% ---------------------------------
Additionally, various works have considered beam design and optimization as \cite{alexandropoulos_near-field_2022} which presents a fast alignment algorithm for the phase shifts of the \ac{RIS} and the transceiver beam-former, which uses a variable-width hierarchical phase-shift codebook. Another recent study \cite{liu_low-overhead_2022} proposes a far-field beam-based beam training scheme, where a deep residual network is utilized to estimate the optimal near-field \ac{RIS} codeword. 
In \cite{chung_location-aware_2021}, the authors present a beamwidth adaptation technique during the beam training process, and an atomic norm channel estimation method for the cascaded channel.
 The paper \cite{chen-hu_differential_2022} proposes the use of differential data to determine the best beam for the \ac{RIS}. 
Furthermore, \cite{palmucci_ris-aided_2022} explores a joint design of the reflection coefficients of multiple \acp{RIS} and the precoding strategy of a single \ac{BS} to optimize the tracking of the position and velocity of a single \ac{UE} with an iterative block coordinate descent algorithm.
%\ac{RIS}-aided localization papers such as \cite{Elzanaty2021} studied the improvement brought by introducing \acp{RIS} in terms of localization accuracy, while \cite{keykhosravi2021siso} studied the use of \ac{RIS} to enable localization (i.e., when it is not possible without RIS). The above studies considered the presence of a \ac{LoS} path between the \ac{BS} and \ac{UE}. In contrast \cite{rahal2021ris} proposed to localize a \ac{UE} even when the \ac{LoS} path is blocked, by harnessing the wavefront curvature of the signal reflected from the larger \ac{RIS}, similar to the \ac{RIS} lens localization work in \cite{abu2021near}. In terms of \ac{RIS} signal design, these works have considered randomized \ac{RIS} profiles, ...


One major difficulty while optimizing \ac{RIS} beams under such hardware constraints is that the latter may be difficult to handle analytically. As an example, unit-norm constraints are usually non-convex and shall necessitate specific iterative approaches \cite{tranter2017}. In some other cases, the addressable \ac{RIS} configurations may be quantized \cite{DiPalma_2017}, subject to phase-dependent amplitude variations (wanted or unwanted) \cite{Abeywickrama_2020}, or only characterized experimentally as a lookup table derived from real measurements \cite{fara2021prototype}.
%
Under realistic hardware limitations, \ac{RIS} profile optimization can hence be performed either \textit{i}) by directly optimizing the constrained \ac{RIS} configuration with respect to the considered objective (e.g., minimize the \ac{PEB} in the localization context) \cite{huang2019reconfigurable,qignqingwu2019,Abeywickrama_2020, Huang_GLOBECOM_2019} or \textit{ii}) by carrying out an unconstrained optimization of the \ac{RIS} configuration first and then determining the best approximation that could be practically supported by the \ac{RIS}. These two options can be referred to as \emph{``constrain, then optimize''} or \emph{``optimize, then constrain''} (e.g., \cite{Rahal_Localization-Optimal_RIS}), respectively. For the former, low-complexity numerical methods offering good fidelity with respect to the desired (i.e., unconstrained) beam patterns are still needed, which is one of the purposes of this paper.
%
 
%Multibeam: \cite{zhang2018multibeam}
%\textcolor{magenta}{[Maybe developing a bit further NF localization aspects could also be appropriate.]}

\section*{System Model and General Problems Formulation}
%
%\textcolor{blue}{In this section, we describe the RIS-enabled wireless communication system under investigation, together with the considered design problem formulation for RIS-based arbitrary complex beam patterns.}

\subsection*{Overall System Model and Localization Scenario} 
%
Following \cite{basar2019wireless}, we first consider a single-antenna \ac{TX}, which is communicating in \ac{NLoS} with a single-antenna \ac{RX}. The transmission is hence enabled through an $M$-element reflective RIS, over two \ac{LoS} links (i.e., \ac{TX}-\ac{RIS} and \ac{RIS}-\ac{RX} links). In case of narrowband transmissions, and static and known RIS location, the corresponding baseband received signal is then expressed as follows \cite{rahal2021ris,AbuShaban_2021}:
%
\begin{equation}
\begin{split}
%    y_{t} & =\alpha \aa^{\top}(\pp)\Omegab_{t}\aa(\pp_{\text{BS}}) x_{t}    + n_{t}, 
y & =\alpha \aa^{\top}(\pprx)\Omegab\aa(\pptx) x + n \\
&= \alpha \omegab^\top \bb(\pprx,\pptx) x  + n,\label{eq:Received_signal}
\end{split}
\end{equation}
%
where $\pptx$ and $\pprx$ are respectively the \ac{TX} and \ac{RX} positions, $\alpha$ is the complex channel gain, $\Omegab\triangleq{\rm diag}(\omegab)$ with $\omegab\in \mathbb{C}^{M\times 1}$ accounting for the \ac{RIS} complex configuration, $x$ is the transmitted signal of energy $E_{\text{s}}$,
%$\mathbb{E}\{ |x_t|^2\}=E_{\text{s}}$
$n\sim\mathcal{CN}(0,N_0)$ is the additive white Gaussian noise of power spectral density $N_0$, and $\aa(\cdot)\in \mathbb{C}^{M\times 1}$ indicates the \ac{RIS} response. Considering a point $\pp$, the $m$-th ($m=1,2,\ldots,M$) entry of $\aa(\pp)$, corresponding to the $m$-th \ac{RIS} element located at $\pp_{m}$, is given by\footnote{Note that the model converges to the standard far-field model when the distance $\Vert \pp-\pp_{\text{RIS}}\Vert$ becomes large.} 
%
\begin{align}
    [\aa(\pp)]_{m}=\exp\left(-\jmath\frac{2\pi}{\lambda}\left(\Vert\pp-\pp_{m}\Vert - \Vert\pp-\pp_{\text{RIS}}\Vert \right)\right),\label{eq:RIS_response}
\end{align}
%
where $\pp_{\text{RIS}}$ is the \ac{RIS} center location and $\lambda$ is the wavelength. Finally, in \eqref{eq:Received_signal}, we have used the definition $\bb(\pprx,\pptx)\triangleq{\aa}(\pprx) \odot \aa(\pptx)$.
%
\begin{figure}[ht]
 \centering
 \includegraphics[width=0.8\linewidth]{figures/geometryV2.PNG}
 \caption{Typical \ac{NF} \ac{NLoS} positioning scenario over \acl{SISO} downlink transmissions with one single reflective \ac{RIS} and related problem geometry with respect to the \ac{RX} point $\pp$, where the \ac{RIS} center serves as the origin of both the spherical and Cartesian coordinates systems.}
 \label{fig:Geometry}
\end{figure}
%
Fig.~\ref{fig:Geometry} illustrates a millimeter wave (mmWave) downlink \ac{NLoS} localization scenario, where a \ac{BS} in $\pptx=\pp_{\text{\ac{BS}}}$ broadcasts a narrowband pilot signal $x_{t} \in \mathbb{C}$ over $T$ transmissions, with a bandwidth $W$, a transmit power $P_{\text{tx}}$, and a total transmit energy $E_{\text{tot}} = E_{s}MT=\nicefrac{(P_{\text{tx}}MT)}{W}$. From \eqref{eq:Received_signal}, the complex signal $y_t \in \mathbb{C}$ received by a \ac{UE} in $\pprx=\pp_{\text{UE}}$ at time $t$ after \ac{RIS} reflection can be written as
%
\vspace{-1mm}
\begin{align}
    y_{t} & =\alpha \aa^{\top}(\pp_{\text{UE}})\Omegab_{t}\aa(\pp_{\text{BS}}) x_{t}  
    + n_{t}, \label{eq:Received_signal_time}
\end{align}
%
where $\Omegab_{t} = \text{diag}(\omegab_{t}) $ with $\omegab_{t} \in \mathbb{C}^{M\times 1}$, which can vary as a function of time. 
%
This received signal can also be vectorized over the $T$ transmissions into $\yy \in \mathbb{C}^{T\times1}$ as follows\footnote{Without loss of generality, we assume a constant pilot $x_t=\sqrt{E_s}$ is transmitted.}
%
\vspace{-3mm}
\begin{align}
    \yy=\sqrt{E_{s}}\alpha \FF^{\top} \aa(\pp_{\text{UE}}) + \nn, \label{eq:generalized_received_signal}
\end{align}
%
where $\FF= [\ff_1,\ldots,\ff_T] \in \mathbb{C}^{M\times T}$ with $\ff_t = \Omegab_t \aa(\pp_{\text{BS}}) \in \mathbb{C}^{M\times1}$.

In the absence of \ac{LoS} and at reasonably short \ac{RIS}-\ac{UE} distances and/or with large surfaces, one can leverage properties of the \ac{NF} \ac{RIS} response (i.e., location-dependent information conveyed by radio wavefront curvature) to estimate the position of the \ac{UE} based on the observed received signals over time. Here, it is assumed that the position of the \ac{TX} and the \ac{RIS}, the orientation of the \ac{RIS},  and the \ac{RIS} profiles are known, where the \ac{RIS} profiles may be optimized to improve the accuracy of estimation.

%This model can equivalently be described as 
%\begin{align}
%    y_{t} & =\alpha \omegab_t^\top \bb(\pp) x_{t}  
%    + n_{t},
%\end{align}
%where $\bb(\pp)={\aa}(\pp) \odot \aa(\pp_{\text{BS}}) $ and $\omegab_t$ is the diagonal of $\Omegab_{t}$. 

\subsection*{\ac{RIS} Beam Approximation Problem}
%
Due to \ac{RIS} hardware limitations and/or design specificity~\cite{alexandg_2021}, all element-wise reflection coefficients are assumed to take values among a few discrete complex values only. In other words, for the $m$-th element of the vector $\omegab$ in \eqref{eq:Received_signal}, it holds that $\omega_m \in \mathcal{V}$, where $\mathcal{V}$ is a finite set of complex numbers, whose magnitude cannot exceed unity as the \ac{RIS} is passive. For instance in \cite[Table I]{fara2021prototype}, for a particular hardware prototype, the individual \ac{RIS} element response has been experimentally characterized, and the corresponding set $\mathcal{V}$ has the cardinality of 14. Leveraging the model in \eqref{eq:Received_signal}, we  first tackle a generic optimization framework that aims at approximating any desired beam pattern for a reflective RIS, i.e.
%
\begin{align}\label{eq:beam_pattern}
    G(\pp)= \omegab^\top\bb(\pp,\pptx)
\end{align}
%
for an arbitrary \ac{RX} point $\pp$ in the coverage area $\mathcal{G}$. Without loss of generality, %$\pp_{\text{RIS}}$ and 
$\pptx$ is assumed to be static.

As already alluded in the previous sections, concrete examples of usual canonical beam patterns to be synthesized in RIS-aided applications 
%, with $\pp_{\text{des},j}$ ($j=1, 2, \ldots,J$) denoting any desired \ac{RX} point(s) to steer a beam, 
include \emph{steering} beams (such as DFT beams)~\cite{AbuShaban_2021}, \emph{derivative} beams (e.g., difference beams just like in monopulse radar~\cite{monopulse_review}, MIMO radar~\cite{li2007range}, or even localization~\cite{keskin_optimal_2021}), or even \emph{multiple concurrent} beams~\cite{zhang2018multibeam,Rahal_EuCNC22}.
%
%\textcolor{blue}{\begin{itemize}
%\item \textbf{Directional beams (including DFT beams):} In this case, it holds $G(\pp)\propto  (\bb^*(\pp_{\text{des},1},\pptx))^\top \bb(\pp,\pptx)$, where $\propto$ indicates proportionality~\cite{AbuShaban_2021}; in this way, normalization issues can be avoided. 
%\item \textbf{Derivative beams}: Derivative beams \cite{tasosMultiBeam2019} correspond to difference beams used in monopulse radar \cite{monopulse_review}, MIMO radar \cite{li2007range}, or even localization~\cite{keskin_optimal_2021}. For such beams, the beam pattern is $G(\pp)\propto  (\dot{\bb}_{x}^*(\pp_{\text{des},1},\pptx))^\top \bb(\pp,\pptx)$, where 
%$\dot{\bb}_{x}(\pp_{\text{des},1},\pptx) = \partial {\bb}(\pp_{\text{des},1},\pptx) / \partial x$, in which $x$ can be the elevation angle, azimuth angle, or range (see Fig.~\ref{fig:Geometry}). 
%\item \textbf{Multiple concurrent beams}: For the multi-beam case \ac{w.r.t.} $J$ desired \ac{RX} points, the beam pattern becomes $G(\pp)\propto  (\sum_{j=1}^{J}\bb^*(\pp_{\text{des},j},\pptx))^\top \bb(\pp, \pptx)$.
%\end{itemize}}
%
As seen in the following, localization-optimal RIS configurations may request a combination of the latter canonical beams, jointly or sequentially depending on the implementation (typically, a steering beam pointing to the \ac{UE}, and its derivatives \ac{w.r.t.} the three spherical coordinates).
So one more goal here is to assess the theoretical performance degradation induced by such beam approximations directly at the application level (i.e., typically, in terms of \ac{PEB}), beyond beam fidelity issues.

\section*{Proposed RIS Beam Synthesis Methodology}
%
%\textcolor{blue}{In this section, we present the proposed design methodology for the configuration of reflective RISs, which can lead to beam patterns as close as possible to predefined ones.}
%
\subsection*{Least Squares Precoder Design}
%
Leveraging the approach in \cite{tranter2017}, the desired beam pattern in \eqref{eq:beam_pattern} is first discretized into a $N_G$-element vector $\gg$. Each element of $\gg$ corresponds to a specific point in $\mathcal{G}$. $N_G$ hence refers to the number of such discrete locations sampled from $\mathcal{G}$. Accordingly, it comes that $[\gg]_k=G(\pp_k)$, with $k=1,2,\ldots,N_G$. After defining the $N_G \times M$ complex-valued matrix $\BB\triangleq[\bb^\top(\pp_1,\pptx);\ldots;\bb^\top(\pp_{N_G}, \pptx)]$, %\textcolor{red}{[BD: Missing argument in all $\bb$ terms? MR: fixed]} 
the \ac{RIS} configuration optimization problem can be formulated as follows, like in \cite[eq.~(12)]{tranter2017}: 
%
\begin{subequations}
\label{eq:OPT1}
\begin{align}
    \min_{s,\omegab} & \quad \Vert \gg - s \BB \omegab\Vert^2\\ \label{eq_v_cons}
    \text{s.t.} &\quad  \omega_m \in \mathcal{V},\,m=1,2,\ldots, M,
\end{align} 
\end{subequations}
%
where $s \in \mathbb{C}$ is a normalization factor enabling to solve the scaling issue for $\gg$ while designing the beam pattern~\cite{tranter2017}. The optimization approach in \eqref{eq:OPT1} represents a RIS beam pattern synthesis problem aiming to determine the optimal RIS phase profile $\omegab$ that best matches a given desired beam pattern $\gg$.

To deal with the \ac{RIS} configuration problem exposed above, %in \eqref{eq:OPT1}, 
a simple projected gradient descent algorithm is used (See Algorithm~\ref{alg:algo1}), inheriting from \cite[Alg.~2]{tranter2017}. First of all, one gradient descent step is performed \ac{w.r.t.} scaling variable $s$ (See Line\,\ref{A1:L2} of Algorithm~\ref{alg:algo1}).
%and~\ref{alg:algo2}, which here is an instance of 
Then, we apply an unconstrained gradient descent step \ac{w.r.t.} \ac{RIS} configuration (See Line\,\ref{A1:L3}), whose result is subsequently projected onto the set $\mathcal{V}$ (See Line\,\ref{A1:L4}) so as to satisfy the look-up table constraint in \eqref{eq_v_cons}. Note that $\beta$ is just a design parameter that enables to adjust the step size, while $\lambda_{\max}(\cdot)$ refers to the largest eigenvalue of the matrix argument. Algorithm~\ref{alg:algo2} summarizes the projection step. Accordingly, the complexity of Algorithm~\ref{alg:algo1} (per iteration) is $\mathcal{O}(M (N_G + \lvert \mathcal{V} \rvert))$.
%
\begin{algorithm}[t]
\caption{RIS Configuration Design}
\label{alg:algo1}
\textbf{Initialize:} $\beta\in (0,1)$ and $\omegab^{(0)}=\text{proj}_{\mathcal{V}}(\BB^\dagger \gg)$.
\begin{algorithmic}[1]
    \For {$r=1,2,\ldots$} 
        \State Compute $s^{(r)}=\frac{(\omegab^{(r-1)})^{\h}\BB^{\h}\gg}{\Vert\BB\omegab^{(r-1)} \Vert^2}$. \label{A1:L2}%(\omegab^{(r-1)})^{\h}\BB^{\h}\gg/\Vert\BB\omegab^{(r-1)} \Vert^2$
        \vspace{2mm}
        \State Set $\omegab^{(r)}_{\text{u}}=\omegab^{(r-1)}+\frac{\beta \BB^{\h}(\gg-s^{(r)}\BB\omegab^{(r-1)})}{\lambda_{\text{max}}(|s^{(r)}|^{2}\BB^{\h}\BB)}$.\label{A1:L3}
        \vspace{2mm}
        \State Calculate $\omegab^{(r)}=\text{proj}_{\mathcal{V}}(\omegab^{(r)}_{\text{u}})$ using Algorithm~\ref{alg:algo2}.\label{A1:L4}
    \EndFor
\end{algorithmic}
\end{algorithm}
%
%
\begin{algorithm}[t]
\caption{Projection onto set $\mathcal{V}$: $\omegab_{\text{out}}=\text{proj}_{\mathcal{V}}(\omegab_{\text{in}})$}
\label{alg:algo2}
\begin{algorithmic}[1]
\For {$m=1,\ldots,M$}
\State Find $[{\omega}_{\text{out}}]_m=\arg \min_{{\omega} \in \mathcal{V}} |[\omegab_{\text{in}}]_m-\omega|^2$.
\EndFor
\end{algorithmic}
\end{algorithm}
%
\subsection*{Reduced-Complexity Solution}
%
As the definition domain of $G(\pp)$ may coincide with the full 3D space, $N_G$ can become tremendously large, and even prohibitive, resulting in very high computational complexity for Algorithm~\ref{alg:algo1}. To relax this burden, one can express the beams at stake in terms of spherical coordinates and re-define accordingly the optimization objective from \eqref{eq:OPT1}, with $\rho$ the distance, $\theta$ the azimuth angle and $\phi$ the elevation angle, all defined \ac{w.r.t.} the \ac{RIS} coordinates system (see Fig.~\ref{fig:Geometry}), 
%Assuming far-field communications, $G(\pp)$ is hence simply expressed as $G({\theta,\phi})$, where $\theta$ is the azimuth angle and $\phi$ is the elevation angle, defined with respect to the \ac{RIS} coordinates system (see Fig.~\ref{fig:Geometry}), %\textcolor{red}{[BD: If we don't have any figure plotting the pb geometry, I would suggest citing at least a paper that makes the same conventions]}. \textcolor{red}{[KK: maybe 
like in \cite[Fig.1b]{keykhosravi2021siso}.

%\captionsetup{belowskip=-5pt}

%\textcolor{magenta}{[Maybe the multi-beam description below is not necessary any more (unused in the following single-UE localization framework). We could just mention that it has been treated in \cite{Rahal_EuCNC22}. All the notations/equations could be simplified accordingly in the sequel, getting rid of subscript $i$ and related summations.]} 
%
% \newMaterial{If multiple concurrent beams must be generated (e.g., for multi-user simultaneous localization purposes), one can cover at a time $I\ge 1$ reference \ac{RX} positions $\pp_{\text{ref},i}$'s of spherical coordinates  $[\rho_{\text{ref},i},\theta_{\text{ref},i},\phi_{\text{ref},i}]^\top$, with $i=1,2,\ldots,I$: %, aiming at precise beam approximation. The latter preference positions are defined as:}
% %
% \begin{align}
%     \gg_{\rho,i}& =G([\rho,\theta_{\text{ref},i},\phi_{\text{ref},i}]^\top),~\rho \in \mathcal{R},\\
%     \gg_{\theta,i}& =G([\rho_{\text{ref},i},\theta,\phi_{\text{ref},i}]^\top),~\theta \in \mathcal{T},\\
%     \gg_{\phi,i}& =G([\rho_{\text{ref},i},\theta_{\text{ref},i},\phi]^\top),~\phi \in \mathcal{P},
% \end{align}
% %
% where $\mathcal{R}$, $\mathcal{T}$, and $\mathcal{P}$ corresponds to the discrete sets of respective spherical coordinates.} 

Let $\pp_{\text{ref}}$ be the reference \ac{RX} position in spherical coordinates, expressed as  $[\rho_{\text{ref}},\theta_{\text{ref}},\phi_{\text{ref}}]^\top$. Then, we define the following three beam patterns each time varying only one of the spherical dimensions (instead of covering the entire 3-D volume): %, aiming at precise beam approximation. The latter preference positions are defined as:}
%
\begin{align}
    \gg_{\rho}& =G([\rho,\theta_{\text{ref}},\phi_{\text{ref}}]^\top),~\rho \in \mathcal{R},\\
    \gg_{\theta}& =G([\rho_{\text{ref}},\theta,\phi_{\text{ref}}]^\top),~\theta \in \mathcal{T},\\
    \gg_{\phi}& =G([\rho_{\text{ref}},\theta_{\text{ref}},\phi]^\top),~\phi \in \mathcal{P},
\end{align}
%
where $\mathcal{R}$, $\mathcal{T}$, and $\mathcal{P}$ corresponds to the discrete sets of respective spherical coordinates.

Likewise, the different \ac{RIS} response vectors are also re-defined, e.g., \ac{w.r.t.} the azimuth: $\BB_{\theta}=[\bb^\top_{\theta,1};\ldots;\bb^\top_{\theta,|\mathcal{T}|}]$ where  $\bb^\top_{\theta,k}=\bb([\rho_{\text{ref}},\theta_k,\phi_{\text{ref}}]^\top)$ for $\theta_k$ being the $k$-th element ($k=1,2,\ldots,|\mathcal{T}|$) in $\mathcal{T}$.
All in all, the optimization problem can now be re-formulated as follows:
%
\begin{subequations}\label{eq_prob_lowcomp}
\begin{align}
    \min_{s,\omegab} & \quad \sum_{\text{p} \in \{ \rho,\theta,\phi\}}\Vert \gg_{\text{p}} - s \BB_{\text{p}} \omegab\Vert^2\\
    \text{s.t.} &\quad  \omega_m \in \mathcal{V}, m=1,\ldots, M.
\end{align} 
\end{subequations}
%
Just like for Algorithm\,\ref{alg:algo1}, the optimization problem above is solved through a gradient-descent step \ac{w.r.t.} the scaling factor $s$ (See Line\,2 of Algorithm\,\ref{alg_lowcomp}) and the vector of RIS phase shifts $\omegab$ (See Line\,3 of Algorithm\,\ref{alg_lowcomp}), before projecting finally the updated vector into the space $\mathcal{V}$ (See Line\,4 of Algorithm\,\ref{alg_lowcomp}). In this case, it is worth noting that $|\mathcal{R}|+|\mathcal{T}|+|\mathcal{P}|\ll |\mathcal{R}|\times|\mathcal{T}|\times |\mathcal{P}|=N_G$. %Similar to Algorithm~\ref{alg:algo1}, 
Accordingly, the complexity (per iteration) is now $\mathcal{O}(M (|\mathcal{R}|+|\mathcal{T}|+|\mathcal{P}| + \lvert \mathcal{V} \rvert))$, which is much lower than that of the initial Algorithm~\ref{alg:algo1}.
%
\begin{algorithm}[t]
\caption{Reduced-Complexity \ac{RIS} Configuration Design}
\label{alg_lowcomp}
\textbf{Initialize:} $\beta\in (0,1)$, $\omegab^{(0)}=\text{proj}_{\mathcal{V}}( \sum_{\text{p} \in \{ \rho,\theta,\phi\}}\BB_{\text{p}}^\dagger \gg_{\text{p}})$.
\begin{algorithmic}[1]
\For {$r=1,2,\ldots$} 
\State Update the scaling factor as:\begin{align}
    s^{(r)}= \sum_{\text{p} \in \{ \rho,\theta,\phi\}}\frac{(\omegab^{(r-1)})^{\h}\BB_{\text{p}}^{\h}\gg_{\text{p}}}{\Vert\BB_{\text{p}}\omegab^{(r-1)} \Vert^2}.
    \end{align}
    %(\omegab^{(r-1)})^{\h}\BB^{\h}\gg/\Vert\BB\omegab^{(r-1)} \Vert^2$
\State Update the \ac{RIS} configuration as:
\begin{align}
    & \omegab^{(r)}_{\text{u}}=\omegab^{(r-1)}+\\
    & \beta \sum_{\text{p} \in \{ \rho,\theta,\phi\}}\frac{
    (s^{(r)})^{*}\BB_{\text{p}}^{\h}(\gg_{\text{p}}-s^{(r)}\BB_{\text{p}}\omegab^{(r-1)})}{\lambda_{\text{max}}(|s^{(r)}|^{2}\BB_{\text{p}}^{\h}\BB_{\text{p}})}\notag 
\end{align}
\State Perform the projection: $\omegab^{(r)}=\text{proj}_{\mathcal{V}}(\omegab^{(r)}_{\text{u}})$.
\EndFor
\end{algorithmic}
\end{algorithm}
%
%
\section*{Application to Location Oriented RIS Beams Design}

%\newMaterial{In this section, we first recall from \cite{Rahal_Localization-Optimal_RIS}} \textcolor{red}{how RIS profiles can be optimized to minimize the \ac{PEB}}, \newMaterial{given a specific \ac{UE} position. Then we show how the resulting localization-optimal \ac{RIS} beams can be approximated following the proposed low-complexity synthesis method.} 

\subsection*{FIM and PEB}
%
In our specific localization application context, we first define the vector of \ac{UE} position and channel parameters in the 3D spherical coordinates system, as $\upzetab_\text{sph}=[ \rho, \theta, \phi,  \alpha_{r}, \alpha_{i}]^\top \in \mathbb{R}^{5\times1}$, and compute the \acs{FIM} accordingly \cite[Chapter~3.7]{kay_fundamentals}.
%
 \begin{align}
     \JJ_{\text{sph}}(\upzetab_{\text{sph}}) =
    \frac{2E_s}{N_0}  \text{Re} \left\{
    \left(\frac{\partial \upmub} {\partial\upzetab_\text{sph}}\right)^{\mathsf{H}} \frac{\partial \upmub} {\partial\upzetab_{\text{sph}}}
   \right\} 
    \in \mathbb{R}^{5\times 5}, \label{eq:FIMsph}
 \end{align}
 %
where $\upmub = \alpha \FF^{\top} \aa(\pp_{\text{UE}})$ refers to the noiseless part of the observation and 
 %To obtain the closed-form expressions of the \acs{FIM} terms, we differentiate $\upmub$ with respect to the corresponding parameters
 %
 \begin{align}
 \left[\frac{\partial \upmub}{\partial {\rho}},\frac{\partial \upmub}{\partial {\theta}},  \frac{\partial \upmub}{\partial 
 {\phi}} \right]& =\alpha \FF^\top\left[ \Dot{\aa}_{\rho}(\pp_{\text{UE}}), \Dot{\aa}_{\theta}(\pp_{\text{UE}}), \Dot{\aa}_{\phi}(\pp_{\text{UE}})\right]\\
     %\frac{\partial \upmub}{\partial {\rho}} & = \beta \FF^\top \Dot{\aa}_{\rho}(\pp)  %\\
     %\frac{\partial \upmub}{\partial {\theta}} &= \beta \FF^\top \Dot{\aa}_{\theta}(\pp)\\
     %\frac{\partial \upmub}{\partial
 %{\phi}} &= \beta \FF^\top \Dot{\aa}_{\phi}(\pp) \\
     \left[\frac{\partial \upmub}
    {\partial {{\alpha}}_{r}},\frac{\partial \upmub}
    {\partial {{\alpha}}_{i}}\right] &= \FF^\top \aa(\pp_{\text{UE}}) [1,\jmath], 
\end{align}
%
with $\Dot{\aa}_{x}(\pp_{\text{UE}}) = \nicefrac{\partial \aa(\pp_{\text{UE}})}
{\partial x}\in \mathbb{C}^{M\times 1}$.

After introducing the corresponding set of parameters in the Cartesian coordinates system, that is, $\upzetab_\text{car}=[ \pp_{\text{UE}}^{\top}, \alpha_{r}, \alpha_{i}]^\top \in \mathbb{R}^{5\times1}$ with $\pp_{\text{UE}}^{\top}=[x_{\text{UE}},y_{\text{UE}},z_{\text{UE}}]^{\top}$, the Jacobian $\CC = \nicefrac {\partial\upzetab_{\text{sph}} } {\partial\upzetab_{\text{car}}}$ is used to re-compute the previous \acs{FIM} as
%
\begin{align}\label{eq:carFIM}
    & \JJ_\text{car}(\upzetab_\text{car}) = \CC^{\top} \JJ_\text{sph}(\upzetab_\text{sph}) \CC.
\end{align}
%
Computing the \ac{FIM} in the spherical domain followed by a transformation to the cartesian domain is a better approach compared to directly calculating it in the latter. This is because the derivative beams used in the computation require access to the spherical positional variables.
Finally, the best achievable positioning performance is characterized by means of the following \ac{PEB}, which represents a lower bound on the accuracy of any unbiased location estimator \cite[Chapter~2.4.2]{vanTrees}
%
\begin{align}
\mathrm{PEB}(\FF;\upzetab_\text{car}) & = \sqrt{\mathrm{tr}\left(\left[\JJ_\text{car}^{-1}(\upzetab_\text{car})\right] _{(1:3,1:3)} \right)}\label{eq:PEB}\\
& \le \sqrt{\mathbb{E}\left\{ \Vert\pp_{\text{UE}}-\hat{\pp}_{\text{UE}} \Vert^2\right\}},
\end{align}
%
where $\hat{\pp}_{\text{UE}}$ stands for any unbiased estimate of $\pp_{\text{UE}}$ and we have made the dependence on the precoding matrix $\FF$ explicit.

In the following, the use of this \ac{PEB} is twofold. First, it is exploited as a parametric optimization objective to determine a localization-optimal \ac{RIS} configuration suited to the stated downlink \ac{NF} \ac{NLoS} positioning problem (See the next section). Beyond, the \ac{PEB} will be used also as a general performance indicator to assess and benchmark the impact of beam approximation on localization for several \ac{RIS} configurations and different \ac{RIS} lookup tables (See the numerical results section).

\subsection*{PEB Minimization}
%
Assuming the \ac{UE} position to be known a priori, the power-constrained \ac{PEB} optimization problem, as a function of the \ac{RIS} configuration, is first formulated as follows
%
\vspace{-3mm}
\begin{subequations}
\begin{align} \label{eq:PEB_optimization}
     \min_{\FF} \quad &  \mathrm{PEB}(\FF;\upzetab_\text{car}) \\
     \text{s.t.} \quad & \mathrm{tr}(\FF\FF^{\mathsf{H}})=MT. 
\end{align}
\end{subequations}
%
Similar to~\cite{Rahal_Localization-Optimal_RIS}, using the change of variable $\XX=\FF\FF^{\mathsf{H}}$ and removing the constraint $\text{rank}(\XX)=T$ \cite[Chapter~7.5.2]{boyd2004convex} \cite{garcia_optimal_2018}, it can be shown
%
%\begin{subequations}
%\begin{align}
%     \min_{\vect{X,u}} \quad & \boldone^{\top}\uu \\
%     \text{s.t.} \quad 
%     & 
%     \begin{bmatrix}
%    \JJ_\text{car} & \ee_{k} \\ 
%    \ee_{k}^{\top} & u_k 
%    \end{bmatrix} \succeq 0, k = 1, 2, 3 ,\\ 
%     & \mathrm{tr}(\XX)=MT, \\ 
%     & \XX \succeq 0, 
%\end{align}
%\end{subequations}
%
%\textcolor{red}{where $\uu = [u_{1}, u_{2}, u_{3}]^{\top}$ is an auxiliary variable and $\ee_{k}$ is the $k$-th column of the identity matrix. This optimization problem is a convex \ac{SDP} since the \acs{FIM} is a linear function of $\XX$, as we can see from \eqref{eq:FIMsph} to \eqref{eq:carFIM}, and the constraints are either \acp{LMI} or linear equalities. 
%According to
from~\cite[Appendix~C]{4359542}  
%
that the optimal %precoder covariance 
matrix solution $\XX^{\smallstar}$ to the equivalent relaxed convex \ac{SDP} problem is of the specific form 
%
\begin{align}
    \XX^{\smallstar} = \UU \Lambdab \UU^{\mathsf{H}} 
    \label{eq:Xopt}
\end{align}
%
where $\Lambdab \in \mathbb{C}^{4\times4}$ is a \ac{PSD} matrix with the beam weights to be applied onto -or equivalently, the relative powers allocated to- the columns of $\UU$ lying on its diagonal.
%
\begin{align}
    \UU \triangleq [
\aa^*(\pp_{\text{UE}}) \hspace{1mm}
\Dot{\aa}^*_{\rho}(\pp_{\text{UE}}) \hspace{1mm}
\Dot{\aa}^*_{\theta}(\pp_{\text{UE}}) \hspace{1mm}
\Dot{\aa}^*_{\phi}(\pp_{\text{UE}})
]. \label{eq:defU}
\end{align}
%
The columns of $\UU$ can be physically interpreted as the \ac{RIS} steering vector and its successive derivatives with respect to the spherical coordinates, similar to that involved in \eqref{eq:FIMsph}.
%
Note that the space spanned by these columns could also be spanned by 4 orthonormalized vectors, after application of the Gram-Schmidt algorithm, so that $\UU^{\mathsf{H}} \UU=M\II_4$. %For the remainder of this paper, we will use these orthonormalized vectors, since the error bounds are function of the latter \cite{garcia_optimal_2018}. 
This step enables us to re-write the initial optimization constraint $\mathrm{tr}(\XX)=MT$ as $\mathrm{tr}(\Lambdab)=T$. 
After performing the transformation above (i.e., from $\XX \in \mathbb{C}^{M\times M}$ to $\Lambdab \in \mathbb{C}^{4\times 4}$), and by applying schur's compliment on~\ref{eq:PEB_optimization} to eliminate the inverse of the information matrix term, an equivalent low-complexity optimization problem can be simply stated as follows 
%
\begin{subequations} \label{finalOpt}
\begin{align} 
    \min_{\Lambda\uu} \quad & \boldone^{\top}\uu \\
     \text{s.t.} \quad 
     & 
     \begin{bmatrix}
    \JJ_\text{car} & \ee_{k} \\ 
    \ee_{k}^{\top} & u_k 
    \end{bmatrix} \succeq 0, k = 1, 2, 3 ,  \\
     & \mathrm{tr}(\Lambdab)=T, \\
     & \Lambdab \succeq 0.
\end{align}
\end{subequations}
%
Furthermore, the problem can be further relaxed by forcing $\Lambdab$ to be diagonal, i.e., $\Lambdab=\text{diag}(\lambdab)$. The entries of vector $\lambdab$ can hence be viewed as relative power allocations (or equivalently, as relative transmission periods within a time-sharing approach, depending on the implementation \cite{Rahal_Localization-Optimal_RIS}), which must be assigned to the different columns of $\UU$. In the following, we consider solving the final optimization problem \eqref{finalOpt} through CVX \cite{cvx}.

%\begin{rem}[Assumption of prior knowledge] \label{rem:perfectprior}
%\textcolor{red}{In a real system, perfect 
%a priori knowledge of the \ac{UE} location is not available, but can be reasonably approximated by the latest \ac{UE}'s estimated location (typically, while tracking the \ac{UE} in the steady-state regime). In other words, we make use of this prior information to optimize the operating conditions for the next UE location estimate, given that the UE would be quasi-static in the meantime. Note that the presumed location uncertainty associated to this prior (if only made available by an estimator, e.g., as an error covariance or an uncertainty ellipse) can be taken into account in our optimization problem (\ref{eq:PEB_optimization}), by  minimizing the worst-case PEB in a region around the estimated UE location (i.e., in a set of points rather than in a single point), like in \cite{keskin_optimal_2021}.  Furthermore, given a \ac{BS}--\ac{RIS} deployment, the optimization routine can be run offline and tabulated as a function of possible \ac{UE} locations, so that the \ac{RIS} profile can be reconfigured during the online phase at no extra computational cost, based on this location estimate.
%\end{rem}}

\subsubsection*{Localization-optimal RIS Beams Approximation}

From \eqref{eq:defU}, if $\pp_{\text{des}} = \pp_{\text{UE}}$ denotes the position of one single \ac{UE} to be localized (i.e., $I=1$), it comes that 4 distinct desired beams must be synthesized in practice so as to optimize localization performance, as follows:
%
\begin{itemize}
%
\item \textbf{1 directional beam:} $G(\pp)\propto  (\bb^*(\pp_{\text{des}},\pptx))^\top \bb(\pp,\pptx)$, where $\propto$ indicates proportionality (to avoid normalization issues). Here, $\bb(\pp_{\text{des}},\pptx) = \aa(\pp_{\text{des}}) \odot \aa(\pptx) $, with $\aa(\pp_{\text{des}})$ representing the desired directional beam pointing towards the UE position.

%\textcolor{magenta}{[We may also express the desired beam explicitly in terms of $\aa(.)$ to relate more easily to the FIM part?]}
%
\item \textbf{3 derivative beams}: $G_x(\pp)\propto  (\dot{\bb}_{x}^*(\pp_{\text{des}},\pptx))^\top \bb(\pp,\pptx)$, where 
$\dot{\bb}_{x}(\pp_{\text{des}},\pptx) = \partial {\bb}(\pp_{\text{des}},\pptx) / \partial x$, in which $x$ represents alternatively the range $\rho$, elevation angle $\theta$, and azimuth angle $\phi$ (see Fig.~\ref{fig:Geometry}). Here, $\dot{\bb}_{x}(\pp_{\text{des}},\pptx) = \dot{\aa}_{x}(\pp_{\text{des}}) \odot \aa(\pptx) $, with $\dot{\aa}_{x}(\pp_{\text{des}})$ representing the desired derivative beam pointing towards the UE position.
%\textcolor{magenta}{[We may also express the desired beam explicitly in terms of $\aa(.)$ derivatives to relate more easily to the FIM part?]}
%
\end{itemize}

\section*{Numerical Results}

%\textcolor{blue}{In this section, we assess the quality of the proposed RIS-based beam pattern approximation approach, as well as its impact on localization performance, by means of numerical results. }  

\subsection*{Simulation Parameters}
%
To assess the performance of the proposed beam synthesis method, we considered actual lookup tables accounting for the \ac{RIS} response per unit element of distinct hardware prototypes, i.e., distinct sets of feasible complex reflection coefficients per element. These prototypes have been developed and characterized in the frame of the H2020 {RISE-6G}\footnote{See \url{https://RISE-6G.eu} for more information.} project. In particular, we have considered the following sets (See Fig.~\ref{fig:set_distribution}):
%
\begin{itemize}   
    \item $\mathcal{V}$ \cite[Table 1]{fara2021prototype}: a first set characterizing a prototype based on a single-diode varactor, with $14$ possible complex values per \ac{RIS} element;
    \item $\mathcal{K}1$ \cite{DiPalma_2017}: a second set characterizing a prototype revisiting a transmit-array architecture \cite{DiPalma_2017} based on p-i-n diodes and enabling $1$-bit phase quantization, hence with $2$ possible complex values per \ac{RIS} element;
    \item $\mathcal{K}2$: a third set similar to $\mathcal{K}1$, but with $2$-bit phase quantization and hence, 4 possible complex values per \ac{RIS} element.
    %\item A set $\mathcal{G}$ resulting from \cite{GNW_Prototype} \textcolor{magenta}{[GNW's HW specificities and characterization to be introduced here.]}. 
\end{itemize}
%
\begin{figure}[ht]
 \centering
 \resizebox{0.8\columnwidth}{!}{\input{figures/setDistributionV1.tex}}
 \caption{The sets $\mathcal{V}$, $\mathcal{K}1$, and $\mathcal{K}2$ with the values for the \ac{RIS} elements responses, as well as the unit-modulus set, plotted in the complex plane. %\textcolor{magenta}{[To be updated with GNW HW characterization.]}
 }
 \label{fig:set_distribution}
 \end{figure}
%
The performance obtained with each of the previous sets after beam approximation is compared with that of an idealized variant (so-called \emph{unconstrained}), where the \ac{RIS} complex element-wise reflection coefficients all lie on the unit circle with continuous phase values.

In our simulations, the carrier frequency was set at $5.15\,\mathrm{GHz}$ for $\mathcal{V}$ and $28\,\mathrm{GHz}$ for the other sets, %$\mathcal{K}1$ and $\mathcal{K}2$,
reflecting the actual operating frequency of each RIS hardware prototype. And to make sure that the localization performance comparison is fair, we ensured that the propagation loss of the \ac{BS}-\ac{RIS} \ac{RIS}-\ac{UE} paths is equal disregarding the operating frequency effect.
%The complex reflection coefficients of different RIS prototypes were plotted on the unit circle as shown in Fig.~\ref{fig:set_distribution}. 

In terms of addressed scenario, without loss of generality, we focus on a canonical configuration, where $\pptx$ is set to $[3, 3, 0]^\top~\mathrm{m}$ and the RIS is placed at the origin, i.e., $\pp_{\text{RIS}}=[0, 0, 0]^\top~\mathrm{m}$. %, with a total of 32 x 32 elements.  
For beam patterns visualization and beam fidelity analysis (See Fig.~\ref{fig:directional} to Fig.~\ref{fig:2D-K2}), we first consider a desired point $\pp_{\text{des}}\equiv \pp_{\text{UE}}$ located in $[0, 2, 0]^\top~\mathrm{m}$ for both steering and derivative beam patterns. The 1D visualizations are intended to show the performance in terms of maximum power gain and width, allowing us to evaluate the designed beams in the desired direction, whereas the 2D illustrations showcase the beam pattern in terms of both the azimuth and elevation angles, hence focusing on the overall angular behavior, as well as on the potential presence of harmful grating lobes. These visualizations include the magnitude $|G(\boldsymbol{p})|$ in 1D or 2D slices in spherical dimensions.
%
%\textcolor{magenta}{[Below points (simulation settings of PEB evaluations) to be developed/edited.]}\\
In Fig.~\ref{fig:PEBdist}, the \ac{PEB} is evaluated as a function of the \ac{RIS}-\ac{UE} distance and accordingly, the \ac{UE} position is set to $[-r,~r,~r]^{\top}~\mathrm{m}$ where $r$ varies between $0.2~\mathrm{m}$ and $10~\mathrm{m}$. However, in Fig.~\ref{fig:PEBaz}, we set the spherical coordinates of the user in a different way where the \ac{RIS}-\ac{UE} distance is set to a constant value $\rho = 2~\mathrm{m}$, the elevation angle is also set to a constant $\phi = \frac{\pi}{2}~\mathrm{rad}$; whereas $\theta$, the azimuth component, varies across the entire defined range, i.e., $[0~\cdots~\pi]~\mathrm{rad}$ (excluding the first and last values where the \ac{UE} is co-planar with the \ac{RIS}). 
Similarly, in Fig.~\ref{fig:PEBel}, the range is set to $\rho = 2~\mathrm{m}$, $\theta = \frac{\pi}{2}~\mathrm{rad}$ and now the elevation angle $\phi$ varies across the $[0~\cdots~\pi]~\mathrm{rad}$ range. 
For this positioning performance assessment, we compare the \ac{PEB} when applying ideal localization-optimal RIS beams with those obtained via the  proposed approximation method. For benchmark purposes, similar \ac{PEB} evaluations are also carried out with random and directional RIS configurations where we adopted a monte-carlo approach and we averaged the \ac{PEB} over all the random trials. %, after applying the beam synthesis method.
In the former case, the complex \ac{RIS} element-wise reflection coefficients are simply drawn randomly from the corresponding set for each prototype, with no further projection.
%\textcolor{magenta}{[If you have normalized your SNR for fairer PEB comparison btw sets V and K1/K2, while operating -by design- at distinct frequencies (i.e., "re-aligning" all the other power contributions..., besides the RIS design and beam approximation effects that we want to focus on), then you should explain how you have done exactly (in relation also to the parameters listed in Table~\ref{table:params}... typically, playing with BW, PTX, or maybe alpha ?).]}

 The main simulation parameters (system model and scenario) are summarized in Table~\ref{table:params}.
% simulation parameters table
\begin{table}
\centering
\caption{General simulation parameters.}
\resizebox{0.8\columnwidth}{!} {
\begin{tabular}{ |c|c||c|c| } 
 \hline
 parameter & value & parameter & value\\
 \hline
 $f_{c}$ & $5.15-28~\mathrm{GHz}$ & $E_{\text{tot}}$ & $(\nicefrac{P_{\text{tx}}}{W})MT$\\
 $W$ & $120~\mathrm{kHz}$ & $P_{\text{tx}}$ & $20~\mathrm{dBm}$\\ 
 noise figure $n_f$ & $8~\mathrm{dB}$ & RIS size & $M = 32\times 32$ elements\\
   $N_0$ & $-174~\mathrm{dBm/Hz}$ & transmissions & $T = 40$\\
 \hline
\end{tabular}\vspace{-4mm}
}
\label{table:params}
\vspace{-4mm}
\end{table}

\subsection*{Results and Discussion}
%
\subsubsection*{Qualitative Analysis of Approximated RIS Beams}

\paragraph*{1D Visualization}
In Fig.~\ref{fig:directional} and \ref{fig:derivative}, we show approximated patterns for both 1D steering and derivative beams, as a function of the azimuth parameter $\theta$, while maintaining the other coordinates at their true (i.e., desired) values. These patterns have been generated without imposing any constraint on the RIS precoder (\emph{unconstrained}) or by utilizing realistic hardware limitations derived from the lookup tables (sets $\mathcal{K}1$, $\mathcal{K}2$, and $\mathcal{V}$). It is important to note that the projection onto any set can be achieved through a single step or can be improved through iterative refinement. The latter approach have been adopted to achieve a higher level of precision.

In Fig.~\ref{fig:directional}, we notice at first that the main lobe of the \emph{unconstrained} steering beam (red curve) has a peak of $60.2 \mathrm{dB}$, which is in line with the beamforming gain offered by the considered \ac{RIS} of $M=32\times32$ elements. 
%As expected, the beam projection onto \emph{S-unit/2} (black curve) shows a loss of about $6$ dB, as $\Vert \omegab\Vert ^2$ is divided by a factor of $4$, whereas the \emph{unit} beam (not shown here) is obviously the same as the \emph{desired} one (e.g., using a steering vector). 
Moreover, comparing the beam projected onto the set $\mathcal{K}1$ (i.e., with $1$-bit unit cells; green curve) with the \emph{unconstrained} one, we see a significant loss, which can be mitigated by about $3 \mathrm{dB}$, by projecting the beam onto $\mathcal{K}2$ instead ($2$-bit unit cells; blue curve).
Furthermore, projecting the beam onto set $\mathcal{V}$, results in, as expected, more degradation in the beam peak value.
Beyond, if we take a look at the entire beam shape across $\theta$, we notice that constraining into real sets leaves the beam with unwanted secondary lobes, explaining also the power loss experienced at the peak of the main lobe. Table \ref{table:peakValues} summarizes the main indicators regarding beam fidelity issues, in terms of power loss in the desired direction and the presence of unwanted secondary lobes aside. It simply indicates the peak power value of the main lobe as well as the position and the peak value of the secondary lobes, across different prototypes, which are defined by the highest peaks breaking the \emph{unconstrained} envelope.
% peak values table
\begin{table}[ht]
\centering
\caption{Peak Gain Distribution of Main and Secondary Lobes Across Different \ac{RIS} Prototypes}
\resizebox{0.8\columnwidth}{!}{
  \begin{tabular}{c|c|c|c|c}
    %\hline
    & \emph{Unconstrained} & $\mathcal{K}1$ & $\mathcal{K}2$ & $\mathcal{V}$\\ \hline
    Main Lobe Peak Value~[$\mathrm{dB}$] & 60.2 & 55.2 & 58.2 & 54.2\\ %\hline
    Secondary Lobe Peak Value~[$\mathrm{dB}$] & - & 48.5  & 35.36 & 50.7 \\ %\hline
    Position of Secondary Lobe $\theta~[\mathrm{rad}]$ & - & 0.9 & 2.37 & 2.3\\
    %\hline
  \end{tabular}
}
  \label{table:peakValues}
\end{table}
%This unwanted power distribution is illustrated in Table~\ref{table:peakValues} where the corresponding peak values of both the main and secondary lobes (respectively desired and unwanted) are reported.

Fig.~\ref{fig:derivative} shows that the generated derivative beam patterns exhibit very similar trends to that observed with the steering ones. %when considering different hardware constraints for \ac{RIS}. 
Additionally, as the figure displays the derivative with respect to the azimuth angle, a null is present when $\theta$ corresponds to the desired direction, as already pointed out in~\cite{keskin_optimal_2021}. %The curves also indicate that the two sets $\mathcal{K}1$ and $\mathcal{K}2$ have more difficulties to accurately follow rapid changes in the beam shape, leading to the generation of significant side lobes. This results from the limited number of phase quantization levels.\textcolor{magenta}{[I know that we wrote also  this statement initially for EuCNC - Fig.5, but the "secondary" lobes of the unconstrained pattern in red look now much higher than that in the EuCNC (in such as way that most of the secondary lobes under HW constraints, typically for K2, don't look so high in the end... Any reason for this ?)]}
%\textcolor{magenta}{[To be completed with the analysis of $\mathcal{G}$ set.]}
\begin{figure}[ht]
 \centering
 \resizebox{0.9\columnwidth}{!}{\input{figures/beams1D_steering.tex}}
 %\include{figures/beams1D_steering.tex}
 \caption{Steering beam patterns as a function of the azimuth angle $\theta$ for various beam synthesis methods under gradual \ac{RIS} hardware constraints, including the realistic \ac{RIS} element responses of \cite{DiPalma_2017,fara2021prototype}.}
 \label{fig:directional}
 \end{figure}

 \begin{figure}[ht]
 \centering
 \resizebox{0.9\columnwidth}{!}{\input{figures/beams1D_derivative.tex}}
 %\include{figures/beams1D_derivative.tex}
 \caption{Derivative beam patterns as a function of the azimuth angle $\theta$ for various beam synthesis methods under gradual \ac{RIS} hardware constraints, including the realistic \ac{RIS} element responses of \cite{DiPalma_2017,fara2021prototype}.}
 \label{fig:derivative}
 \end{figure}
\paragraph*{2D Visualization}

The heatmaps in Fig.~\ref{fig:2D-desired} to Fig.~\ref{fig:2D-V} display, as a function of the direction of departure from the \ac{RIS} (i.e., of both azimuth and elevation angles) and a specified desired direction (red circle), the \emph{unconstrained} steering beam, as well as its projections onto sets $\mathcal{K}1$, $\mathcal{K}2$, and $\mathcal{V}$, respectively. In Fig.~\ref{fig:2D-desired}, we can see that only one main lobe is present in the desired direction, as expected. Note that this is used as a reference for comparing the beams constrained with realistic \ac{RIS} hardware.

Fig.~\ref{fig:2D-K1}, visualizes the beam projection onto set $\mathcal{K}1$, where the main lobe is still observed in the desired direction, even though clearly attenuated in comparison with the \emph{unconstrained} beam from Fig.~\ref{fig:2D-desired}. The presence of a strong and systematic secondary grating lobe is also noted, which turns out to be a standard reflection, regardless of the desired beam direction, number of \ac{RIS} elements, or inter-elements spacing. This kind of grating lobe  arises due to the severe quantization of the \ac{RIS} element phase, % and/or to a harmful linear phases distribution across the surface in presence of a planar impinging wavefront, thus 
creating some kind of spatial aliasing. %These effects are all the more prominent since the number of quantization bits is low (i.e., 1 bit for $\mathcal{K}1$ in our case) and/or as one operates at large distances (say, in far-field domain). 
However, as shown on Fig.~\ref{fig:2D-K2}, this problem of grating lobe can be mitigated after adding only one more bit of phase quantization. In this case, a higher peak value (by about $+3~\mathrm{dB}$) is also achieved for the main lobe in the desired direction, even if the levels of all the other secondary lobes remain globally high and comparable to those in the $1$-bit phase quantization case.
%
Lastly, Fig.~\ref{fig:2D-V} depicts the beam pattern gain resulting from the projection onto $\mathcal{V}$. Regardless of the high number of quantization levels (i.e., $14$) shown in Fig.~\ref{fig:set_distribution}, a secondary lobe is also sill present pointing towards a fixed unwanted direction, which corresponds to a natural specular reflection. This grating lobe comes from the fact that set $\mathcal{V}$ is not centered at the origin of the complex plane (See Fig.~\ref{fig:set_distribution}), but shifted and significantly down-scaled in comparison with the unit circle, due to amplitude losses. Accordingly, the $2\pi~\mathrm{rad}$ phase domain is not entirely covered by the feasible reflection coefficients per element. Indeed, given the span of valid phases observed in $\mathcal{V}$ (say, reflection coefficients experiencing attenuations lower that $5~\mathrm{dB}$), which covers less than $\pi~\mathrm{rad}$ in practice (i.e., less than what would be feasible with a $1$-bit quantization of the \ac{RIS} element phase in $\mathcal{K}1$), this unwanted reflection was hence expected with $\mathcal{V}$ too.
%
In addition to the main grating lobe, the intensity of all the secondary lobes is also generally higher throughout the entire 2D area. 
%\textcolor{magenta}{[To be completed with Fig.~\ref{fig:2D-G} analysis; GreenerWave's design.]}
\begin{figure}[ht]
    \centering
    \begin{subfigure}[b]{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{figures/beams2D_unconstrained.jpg}
        \caption[]%
        {Example of the \emph{unconstrained} steering RIS beam visualization in 2D.}    
        \label{fig:2D-desired}
    \end{subfigure}
        \hfill
    \begin{subfigure}[b]{0.48\textwidth}  
            \centering 
        \includegraphics[width=\textwidth]{figures/beams2D_K1.jpg}
        \caption[]%
        {Designed RIS beam resulting from the projection to $\mathcal{K}1$ (Same example as in Fig.~\ref{fig:2D-desired}).}    
        \label{fig:2D-K1}
    \end{subfigure}
    \vskip\baselineskip
    \begin{subfigure}[b]{0.48\textwidth}  
        \centering 
        \includegraphics[width=\textwidth]{figures/beams2D_K2.jpg}
        \caption[]%
        {Designed RIS beam resulting from the projection to $\mathcal{K}2$ (Same example as in Fig.~\ref{fig:2D-desired}).}    
        \label{fig:2D-K2}
    \end{subfigure}
   \hfill
    \begin{subfigure}[b]{0.48\textwidth}  
        \centering 
        \includegraphics[width=\textwidth]{figures/beams2D_v.jpg}
        \caption[]%
        {Designed RIS beam resulting from the projection to $\mathcal{V}$ (Same example as in Fig.~\ref{fig:2D-desired}).}    
        \label{fig:2D-V}
    \end{subfigure}
    \caption[]
    {Illustration of the steering beam pattern pointing to one single desired direction (red circle), as a function of angles $\phi$ (elevation) and $\theta$ (azimuth).} 
        \label{fig:2D-beams}
\end{figure}

\subsubsection*{Quantitative Analysis of Positioning Performance with Approximated RIS Beams}
%\textcolor{magenta}{[Analysis of Fig.~\ref{fig:PEBdist}, Fig.~\ref{fig:PEBaz}, and Fig.~\ref{fig:PEBel}; to be developed and improved if needed.]}\\
% -------------------------------------------
% -------------------------------------------
In Fig.~\ref{fig:PEBdist}, we show that \ac{PEB} increases globally as a function of the \ac{RIS}-\ac{UE} distance, as expected. We hence first note that the localization-optimal RIS phase design outperforms the random designs \cite{Rahal_Localization-Optimal_RIS}) for both \emph{constrained} and \emph{unconstrained} beam patterns, whatever the considered range.
Then, among the random phase designs more specifically, the performance of the so-called \emph{unconstrained} beam is only slightly better than that of all the \emph{constrained} beams, which are very close to each other, even if $\mathcal{V}$ looks slightly worse at very first sight (for the same reasons of unfavorable reflection coefficients distribution as before). Overall, this means in practice that the localization performance is not that sensitive to beam fidelity issues caused by beam patterns approximation under real hardware limitations, as long as all the feasible phases/amplitudes of the reflection coefficients are all visited within random \ac{RIS} configuration designs.
%
\begin{figure}[ht]
     \centering
     \resizebox{\columnwidth}{!}{\input{figures/PEBdist.tex}}
    \caption[]%
    {PEB as a function of \ac{RIS}-\ac{UE} distance for ideal and designed localization-optimal RIS beams, constrained by the real look-up tables/projection sets of the 4 characterized hardware prototypes.}
    \label{fig:PEBdist}
\end{figure}
%
Regarding the localization-optimal phase design, which requires a weighed combination of $4$ distinct beams, performance now seems much more sensitive to beam pattern approximation than that in the random design case, while experiencing much higher performance degradation in comparison with the \emph{unconstrained} case. This performance gap looks relatively constant as the \ac{RIS}-\ac{UE} distance increases though. Moreover, as expected, set $\mathcal{K}2$ seems relatively better than $\mathcal{K}1$ which is also better than $\mathcal{V}$. Finally, another set of two curves related to directional \ac{RIS} profile design are shown with different uncertainty sphere radii ($0.5~\mathrm{m}$ and $2~\mathrm{m}$). We Notice that in general, the \ac{PEB} of the directional design lies in between the localization-optimal and the random once. Furthermore, distributing the positions in a smaller uncertainty sphere yields a \ac{PEB} close to that projected onto sets $\mathcal{K}1$ and $\mathcal{K}1$ in the localization-optimal design only at short distances but then degrades quickly as the \ac{RIS}-\ac{UE} distance increases. On the other hand, using the bigger sphere gives the opposite behavior, this is inline with the results presented in~\cite{Rahal_Localization-Optimal_RIS}.

Fig.~\ref{fig:PEBaz} shows the PEB evolution as a function of the azimuth angle (i.e., the \ac{RIS}-\ac{UE} distance and elevation being fixed), where one can observe the same trends and ranking as before with the \ac{RIS}-\ac{UE} range. %However, the performance with set $\mathcal{V}$ looks strongly asymmetric, again likely due to the asymmetric/shifted distribution of the feasible reflection coefficients in the complex plane. \textcolor{magenta}{[If this is really the reason to invoke here, then why don't we see a similar PEB asymmetry as a function of the other elevation angle ?]}
Whatever the setting, the \ac{PEB} is also mainly better in the inner part of the spanned angular interval, illustrating typical geometric effects as we get away from the boresight, regardless of beam approximation. Since the \ac{RIS}-\ac{UE} distance is short, utilizing a directional phase design with a smaller sphere yields a better performance than a bigger one which in turn almost performs as the random design.
%
\begin{figure}[ht]
    \centering
    \resizebox{\columnwidth}{!}{\input{figures/PEBaz.tex}}
    \caption[]%
    {PEB as a function of \ac{RIS}-\ac{UE} azimuth angle for ideal and designed localization-optimal RIS beams, constrained by the real look-up tables/projection sets of the 4 characterized hardware prototypes.}
    \label{fig:PEBaz}
\end{figure}
%
Likewise, Fig.~\ref{fig:PEBel} shows similar \ac{PEB} curves as a function of the elevation angle (i.e., the \ac{RIS}-\ac{UE} distance and azimuth being fixed), where performance is still better in the inner part of the spanned angular intervals, illustrating typical effects as we get away from the boresight. The gap between the \ac{PEB} performance achieved with an \emph{unconstrained} beam pattern and its \emph{constrained} approximated variants seems all the more critical in those outer angular zones.
%
\begin{figure}[ht]
     \centering
     \resizebox{\columnwidth}{!}{\input{figures/PEBel.tex}}
    \caption[]%
    {PEB as a function of \ac{RIS}-\ac{UE} elevation angle for ideal and designed localization-optimal RIS beams, constrained by the real look-up tables/projection sets of the 4 characterized hardware prototypes.}
    \label{fig:PEBel}
\end{figure}
%
% -------------------------------------------
% -------------------------------------------
\section*{Conclusion and Future Work}
%todo{Check and possibly make more precise.}
%
In this study, we presented a low-complexity technique for optimizing the complex configuration of \acp{RIS} so as to create various beam patterns, while considering real hardware limitations. The proposed method utilizes a pre-determined lookup table of possible \ac{RIS} element reflection coefficients, characterized out of real measurements. %Examples of directional and derivative beam patterns were also illustrated while taking into account gradual hardware constraints (including that of four real \ac{RIS} prototypes currently under development).
%
Applying the proposed beam generation strategy into the concrete context of \ac{NF} \ac{NLoS} localization, the performance degradation induced by beams approximation has then been evaluated in terms of both beam fidelity and \ac{PEB}, and further benchmarked for different a priori \ac{RIS} control strategies (incl. random, directional and localization-optimal designs). First numerical simulations regarding beam fidelity emphasize the dominating influence of both phase quantization levels (and the span of practically valid phases) and power losses regarding the element-wise complex reflection coefficients on the power gain of the \ac{RIS} beam peak in the desired \ac{UE} direction, as well as on the existence of unwanted secondary lobes. Other simulations performed in a canonical scenario also reveal the effects of beam synthesis and their relative power losses on the localization performance of different \ac{RIS} prototypes. The \ac{PEB} metric was utilized for that manner and the positioning was evaluated versus both \ac{RIS}-\ac{UE} distance and angles (i.e., both azimuth and elevation) to ensure that the study covers all the possible dimensions. As expected, constraining the beam synthesis to \ac{RIS} designs with certain limits degrade the positioning performance across all dimensions with various \ac{RIS} profile designs.
%\textcolor{magenta}{[To be completed once the latest PEB results are stabilized and analyzed.]}

Future works should investigate more \ac{RIS} prototypes by testing their different design characteristics based on localization performance. Extending the results to state-of-the-art as well as novel localization algorithms is also a possible path where the gaps in the performance of the \ac{RIS} devices can be analyzed and fixed.
%the practical performance of RIS-empowered multi-user communications, localization, and sensing at system level, while applying the proposed method under realistic hardware constraints (rather than restricting the study to beam patterns only), as well as the design of new \ac{RIS} hardware prototypes offering even more suitable feasible complex sets, whose distribution in the complex plane shall typically be centered and as close as possible to the unit circle. Moreover, a more in-depth quantitative analysis and comparison with the least-squares beamforming algorithm of \cite{tranter2017} needs to be performed.} 

\


%\subsection*{Sub-heading for section}
%Text for this sub-heading\ldots
%
%\subsubsection*{Sub-sub heading for section}
%Text for this sub-sub-heading\ldots
%
%\paragraph*{Sub-sub-sub heading for section}

%In this section\ldots
%
%\[
%E \bigl[Z_1(vT_x) \bigr]=
%\int_0^{v\wedge
%1}Z_0(uT_x)
%\exp (\lambda_1)\,du .
%\]
%
%\begin{equation}\label{eqexpmuts}
%\begin{aligned}[b]
%&      E\bigl[Z_1(vT_x)\bigr]\\
%&\quad      = \frac{\mu}{r}\log x
%\int_0^{v\wedge1}x^{1-u}x^{({\lambda_1}/{r})(v-u)}\,du .
%\end{aligned}
%\end{equation}
%

%\section*{Appendix}
%Blabla

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Backmatter begins here                   %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Acknowledgements}
The authors would like to warmly thank Dr. Antonio Clemente, from CEA-Leti, France, Dr. Philippe Ratajczak, from Orange Innovation Networks, France, for sharing the look-up tables associated to their R-RIS hardware prototypes in the context of RISE-6G project, as well as for the fruitful technical discussions and the relevant advice regarding this paper.

\section*{Funding}%% if any
This work has been supported, in part, by the EU H2020
RISE-6G project under grant 101017011 and by the MSCA-IF
grant 888913 (OTFS-RADCOM).

\section*{Abbreviations}%% if any
\begin{itemize}
\item BS: Base Station
\item DoD: Direction of Departure
\item FIM: Fisher Information Matrix
\item LoS: Line-of-Sight
\item LMI: Linear Matrix Inequalities
\item MC: Multi-Carrier
\item MIMO: Multiple Inputs Multiple Outputs
\item NF: Nearfield
\item NLoS: Non-Line-of-Sight
\item OEB: Orientation Error Bound
\item PEB: Position Error Bound
\item PSD: Positive Semi Definite
\item RIS: Reconfigurable Intelligent Surface
\item QoS: Quality of Service
\item RX: Receiver
\item SDP: Semi Definite Program
\item S(I)NR: Signal-to-(Interference-and-)Noise-Ratio
\item SISO: Single-Input-Single-Output
\item SRE: Smart Radio Environment
\item UE: User Equipment
\item TDoA: Time Difference of Arrival
\item TX: Transmitter
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                  The Bibliography                       %%
%%                                                         %%
%%  Bmc_mathpys.bst  will be used to                       %%
%%  create a .BBL file for submission.                     %%
%%  After submission of the .TEX file,                     %%
%%  you will be prompted to submit your .BBL file.         %%
%%                                                         %%
%%                                                         %%
%%  Note that the displayed Bibliography will not          %%
%%  necessarily be rendered by Latex exactly as specified  %%
%%  in the online Instructions for Authors.                %%
%%                                                         %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% if your bibliography is in bibtex format, use those commands:
\bibliographystyle{bmc-mathphys} % Style BST file (bmc-mathphys, vancouver, spbasic).
\bibliography{bmc_article}      % Bibliography file (usually '*.bib' )
\end{document}
