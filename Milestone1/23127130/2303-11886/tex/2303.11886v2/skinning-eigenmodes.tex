\section{Skinning Eigenmodes}
\label{sec:skinning-eigenmodes}

Our goal is to derive a suitable linear subspace so that 
full-space complementary displacements $\u^c \in \mathbb{R}^{n(d)}$ may be approximated with a smaller $m$-dimensional linear subspace:
\begin{align}
\u^c \approx  \B \z,
\label{eq:subspace-approx}
\end{align}
where the columns of $\B \in \mathbb{R}^{n(d) \times m}$ form the subspace basis, and the vector $\z \in \mathbb{R}^{m}$ are the reduced degrees of freedom optimized at run-time.

To apply subspace reduction to the complementary dynamics problem (\refeq{cd}), we would like our subspace $\B$ to simultaneously: deal well with large (global and local) rotations, well-approximate the space of low-energy displacements, and accommodate the rig-complementarity constraints.
%
\edit{We make use of a linear blend skinning subspace basis for deformation $\Blbs$ \cite{1Gilles2011} and demonstrate in the following sections how we meet these three desirable criteria.}

Linear blend skinning represents displacements as a weighted summation of $m$ affine transformations applied to a shape's rest positions. The $i$th vertex on the shape is displaced via
\begin{align}
\u_i = \sum_{b=1}^m  w_{ib} \T_b \X_i,
\end{align}
where $w_{ib} \in \mathbb{R}$ is the weight of the $b$th transformation at vertex $i$, $\T_b \in \mathbb{R}^{d \times (d+1)}$ is the $b$th transformation, and $\X_i \in \mathbb{R}^{d+1}$ is the $i$th vertex's rest position in homogeneous coordinates.
%
This equation is linear in $\T$ and so it follows that it may be rearranged so that the degrees of freedom in $\T$ are collected in a single vector $\z = \text{vec}(\T) \in \mathbb{R}^k$ with $k=d(d+1)m$ and the 
weights $w$ and rest positions $\X$ form the columns of a matrix $\Blbs \in \mathbb{R}^{n(d) \times k}$:
\begin{align}
\Blbs &= \I_{d} \otimes (( \boldsymbol{1}_m^T \otimes \X ) \odot ( \W \otimes \boldsymbol{1}_{d+1}^T) ) \ ,
    \label{eq:linear-blend-skinning-matmul}
\end{align}
where $\W \in \mathbb{R}^{n \times m}$ is a matrix with columns collecting each transformation's weights and 
$\X \in \mathbb{R}^{n \times (d+1)}$ collects homogeneous rest positions in rows.
%
Since the rest positions are generally given, the only variables in our subspace design are the weights $\W$. We now propose a method for choosing $\W$ to ensure that weights span low-energy motions \emph{and} satisfy the complementarity constraints by construction. We defer discussion of how our choice of linear blend skinning subspace directly ensures good rotational properties (see \refsec{rotations}).


%This subspace may be leveraged to reduce optimization problem over $\u$ to $\z$:
%\begin{align}
%     \argmin_{\u} E(\u)   \approx
%    \B \argmin_{\z} E(\boldsymbol{Bz})  \label{eq:linear-model-reduction} 
%\end{align}

%\alec{We need to write somehwere that we assume $f_\text{rig}$ is linear. Something like, the most common real-time rigs are linear. In games they don't even use blend shapes, \emph{everything} is linear blend skinning.}
%To achieve interactive simulation speeds, we fully decouple the simulation optimization step from the constraint complexity \alec{what is ``constraint complexity''?} and the mesh resolution \alec{This feels repetitive. Have we said this multiple times already?}.
%% What about deleting the previous sentence and just starting here:
%To this end, we propose a fast complementary dynamics pipeline composed of three main building blocks:
%\begin{enumerate}
%    \item \textbf{A skinning subspace} for elasticity that guarantees rotation equivariant simulations, can represent rotational motion \alec{I don't understand the distinction being made.}, and is material \emph{and} rig-aware, low memory, and fast to compute. (Section \ref{sec:skinning-modes})
%    \item \textbf{A clustering scheme} for fast approximation of per-tet non-linearities.(Section \ref{sec:clustering})
%    \item \textbf{A fast local-global solver} that leverages both our subspace and our clusters for a simulation step that never requires \emph{any} full space operations. (Section \ref{sec:local-global-solver})
%\end{enumerate}
%\subsection{Skinning Subspace}
%\label{sec:skinning-subspace}
%\subsubsection{Deriving Skinning Weights for Secondary Motion}
%\label{sec:deriving-skinning-weights-for-secondary-motion}
%Because we aim to use linear blend skinning as a subspace for deformation, we need to derive a set of weights $\W \in \mathbb{R}^{n \times m}$ that parameterize our subspace and provide low energy deformations.
%
%We show that these weights can be derived in a very similar fashion to traditional displacement modes using a generalized eigenvalue problem (GEVP). 

Our first step follows the process for standard modal subspaces.
%
We approximate our elastodynamic energy with a Taylor expansion about the rest state truncated to second order terms,
\begin{align}
    E(\u + \x_0) &=  E_0 + \u^T \g_0 + \frac{1}{2} \u^T \H_0 \u + \mathcal{O}(\left\|\u\right\|^3) \, ,\nonumber \\
    E(\u + \x_0) &\approx  \frac{1}{2} \u^T \H \u \, ,
\end{align}
where we have dropped the subscript for the elastic energy Hessian in the second line for readability.
Without loss of generality, we have assumed zero elastic energy and vanishing elastic forces at rest ($E_0 = 0, \, \g_0 = \boldsymbol{0}$). 

We arrive at a standard modal subspace by
adding a (mass-) orthogonality constraint  $\B^T \M \B = \I$; substituting the subspace $\u = \B \z$; assuming $\z \sim \mathcal{D}$ are sampled from an as-of-yet arbitrary distribution, and minimize the expected value of the energy over $\B$:
\edit{
\begin{align}
   \Bdisp =  &\argmin_{\B^T \M \B = \I}  \mathbb{E}_ {\z\sim \mathcal{D}} [\z^T \B^T  \H \B \z] \\ 
    =  & \argmin_{\B^T \M \B = \I} \mathrm{tr}(\B^T \H \B \mathbb{E}_ {\z \sim \mathcal{D} }[\boldsymbol{zz}^T]) \  . 
\end{align}
}
We further assume that $\z$ are independent and identically distributed (i.i.d.) samples of a normal distribution, then  $\mathbb{E}_ {\z  \overset{\text{i.i.d.}}{\sim} \mathcal{N}( \boldsymbol{0}, \boldsymbol{1})} [\boldsymbol{zz}^T] = \I$, and
    \begin{align}
    \Bdisp=  & \argmin_{\B^T \M \B = \I}  \mathrm{tr}(\B^T \H \B). \label{eq:gevp-displacement-modes-derivation}
\end{align}
%
The optimal $\Bdisp$ may be found relatively efficiently with a generalized eigenvalue solver that supports large sparse matrices.
%
The columns of $\Bdisp$ can be directly interpreted as minimal-energy \emph{displacement} eigenmodes.

Our \emph{skinning} eigenmodes follows a similar derivation but we replace the optimization over $\B$ with an optimization over the weights $\W$. While \refeq{linear-blend-skinning-matmul} may appear to define $\Blbs$ as a complicated function of $\W$, it is \emph{linear} in and separable over the columns of $\W$. Thus, we may rewrite it as
 \begin{align}
     \Blbs &= \begin{bmatrix} \A_{i, j} & \dots & \A_{d, (d+1)} \end{bmatrix} (\I_{d(d+1)} \otimes \W),
     \label{eq:weight-space-skinning-jacobian}
\end{align}
where we introduce $\A_{i, j} \in \mathbb{R}^{n (d) \times n}$, our weight-space skinning Jacobians. These map contributions of each weight for all $d(d+1)$ affine parameters to the final skinning Jacobian. 

%
We derive $\A_{i, j}$ for the $d=2$ and $d=3$
in Appendix \ref{appendix-sec:weight-space-skinning-jacobians}, but for clarity show the result for $d=3$ here:
\begin{align}
\begin{matrix}
\A_{1, 1} = \P_x \bar{\X}  &\A_{1, 2} = \P_x \bar{\Y} &\A_{1, 3} = \P_x \bar{\Z} &
\A_{1, 4} = \P_x \\
\A_{2, 1} = \P_y \bar{\X} &\A_{2, 2} = \P_y  \bar{\Y} &\A_{2, 3} = \P_y \bar{\Z} &
\A_{2, 4} = \P_y \\
\A_{3, 1} = \P_z \bar{\X}  &\A_{3, 2} = \P_z \bar{\Y} &\A_{3, 3} = \P_z \bar{\Z} &
\A_{3, 4} = \P_z
\end{matrix}
\label{eq:weight-space-skinning-jacobian}
\end{align}
where the $\P_* \in \mathbb{R}^{3n \times n}$ selection matrices concatenate to form the identity matrix $\I_{3n} = [\P_x\, \P_y\, \P_z]$ and 
$\bar{\X}, \bar{\Y}, \bar{\Z} \in \mathbb{R}^{n\times n}$ are diagonal matrices containing the the $x$, $y$ and $z$ rest position values.

 % \begin{align}
 % \A_{i, j} = \P_i \mathbb{V}_j \W 
 % \end{align}
 % Where $\P_i \in \mathbb{R}^{3n\times n}$ is a selection matrix selection out the entries corresponding to the $i$-th dimension and $\mathbb{V}_j$ is a diagonal matrix composed of


% Where $\z$ is our set of reduced space coefficients, which can now also be interpreted as a flattened vector of affine rig parameters. 

% We wish to construct a linear blend skinning subspace $\B_{\mathrm{lbs}}$ that is comprised of a set of low energy \emph{affine transformations}. We leverage that $\B_{\mathrm{lbs}}$ is \emph{fully} parameterized linearly by a set of weights $\W$. 
% \begin{align}
%     \B_{\mathrm{lbs}} = \A (\I_{d(d+1)} \otimes \W)
% \end{align}

% Where $\A$ is derived in \Otman{Appendix} and describes the use of the blend weights $\W$ for every $d(d+1)$ affine rig parameters.
Following a similar procedure as before, we add a weight space orthogonality constraint $\W^T \M_{w} \W = \I$ and assume a generic distribution $\mathcal{D}$ on our sampling of $\z \sim \mathcal{D}$ to obtain

\edit{
 \begin{align}
     \W = &\argmin_{\W^T \M_{w} \W = \I} \mathrm{tr}(  \B_{\mathrm{lbs}}^T \H \B_{\mathrm{lbs}}\mathbb{E}_{\z \sim \mathcal{D}} [\z\z^T]) . 
 \end{align}}
 %
 We now need to make assumptions on the distribution of $\z$, as these now correspond to flattened affine matrix parameters and so have some structure to their distribution.
 %
 Specifically we assume that parameters belonging to different affine matrices are i.i.d. with respect to each other, but generally allow for intradependence between parameters belonging to the same affine matrix, as measured by the covariance matrix  $\C \in \mathbb{R}^{d(d+1) \times d(d+1) }$.
 \begin{align}
    \W = &\argmin_{\W^T \M_{w} \W = \I} \mathrm{tr}\left( (\I_{d(d+1)} \otimes \W)^T \A^T \H \A (\I_{d(d+1)} \otimes \W) (\I_m \otimes \C)\right).
    \nonumber
\end{align}
Expanding out all the Kronecker products and leveraging that the trace is just a sum of diagonal entries :
 \begin{align}
     \W = &\argmin_{\W^T \M_{w} \W = \I} \mathrm{tr}\left( \W^T \left(\sum_i^{d(d+1)} \sum_j^{d(d+1)} (\A^T_i \H \A_j)  c_{ij} \right) \W  \right).
     \end{align}
 Leading to the weight-space optimization:
 \begin{align}
    \W = &\argmin_{\W^T \M_{w} \W = \I} \mathrm{tr}\left( \W^T \H_{w} \W \right)
     \label{eq:gevp-skinning-modes-derivation}
 \end{align}
where $\M_{w} \in \mathbb{R}^{n \times n}$ is the weight-space mass matrix (we use the diagonal lumped mass matrix) and 
where we call $\H_{w} \in \mathbb{R}^{n \times n}$ the \emph{weight-space} elastic energy Hessian.




\begin{figure*}
\includegraphics[width=\textwidth, keepaspectratio]{images/secondary_weights.pdf}\timestamp[-0.25cm]{\tsWeightVis}
\caption{
We generate a linear blend skinning subspace for secondary motion parameterized by a set of skinning weights. Each weight $i$ shown is independently normalized to lie between $[-1, 1]\text{abs}(\boldsymbol{W}_i)$ and centered around 0. (Top) Weights generated by solving the unconstrained generalized eigenvalue problem on a weight-space elasticity Hessian. (Bottom) Secondary skinning weights that satisfy the weight-space complementarity constraint and are orthogonal to our rig space. These are naturally rig-aware, leading to higher frequency motion. \label{fig:skinning-weights-for-secondary-motion}}
\end{figure*}

\begin{figure}
\includegraphics[width=\linewidth,keepaspectratio]{images/mode_of_first_weight.pdf}\timestamp{\tsAffineMotions}
\caption{
One secondary linear blend skinning weight could produce 12 different motions, corresponding to 12 d.o.f.s of an affine matrix. We showcase this by flexing those associated with weight \#3. \label{fig:motions-producible-by-skinning-modes}}
\end{figure}

\begin{figure}
\includegraphics[width=\linewidth,keepaspectratio]{images/transformation_optimal_weights.pdf}
\caption{ Prioritizing scaling and shearing (middle left and middle right) provides weights that are unnaturally centered around the origin. For this reason, we prioritize translations (right). \label{fig:prioritizing-affine-parameters-as-subspace-for-def}}
\end{figure}

\begin{figure}
\includegraphics[width=\linewidth,keepaspectratio]{images/clusters.pdf}
\caption{
We generate clusters to accelerate the computation of per-tet energetic non-linearities. Our clusters inherit the rig-sensitivity of our skinnning weights. \label{fig:cluster-vis}}
\end{figure}

It is important to note this is overly determined for $\W$; The same set of weights are used to specify $d(d+1)$ different types of affine motions: scales, shears and translations. As a result, the set of weights that leads to optimal translations may not be the same set of weights that lead to optimal scales or shears. We can change which of these parameters we prioritize by modifying our affine parameter covariance matrix $\C$.

We choose to prioritize translations, neglecting shears and scales entirely, which are poorly suited for deformation subspaces.
%
The logic is that shears and scales are origin-dependent.
%
This leads the optimization in \refeq{gevp-skinning-modes-derivation} to see vertices far from the origin as \emph{stiffer} than vertices that are close to it, resulting in weights that are unnaturally concentrated around the origin, and decay far away from it as shown in \reffig{prioritizing-affine-parameters-as-subspace-for-def}. 

For $d=3$, taking i.i.d. samples from the standard normal distribution of each of the three translation parameters, while neglecting shears and scales leads to a covariance matrix of the form:
\begin{align}
    \C = \I_{3} \otimes 
    \begin{bmatrix} 
    1 & 0 & 0 & 0 \\
    0 & 0 & 0 & 0 \\
    0 & 0 & 0 & 0 \\
    0 & 0 & 0 & 0 \\
    \end{bmatrix}
\end{align}
which very conveniently leads to a simplified weight space Hessian:
\begin{align}
    \H_w = \P_x^T \H \P_x +  \P_y^T \H \P_y + \P_z^T \H \P_z.
    \label{eq:weight-space-hessian}
\end{align}

\begin{wrapfigure}{r}{5.0cm}
\includegraphics[width=\linewidth,keepaspectratio]{images/H_matrix_sum.pdf}
%\caption{ A single displacement mode (top) corresponds to a low energy deformation in a rest frame. The deformation described by the mode completely changes as its underlying geometry rotates (bottom). \label{fig:didactic-rotation-representation}}
\end{wrapfigure}
The inset, unburdened by notation, more clearly shows the simplicity of deriving this final weight-space Hessian; just take the diagonal blocks for each dimension of the Hessian and sum them up.
%
For co-rotational elasticity with homogeneous materials, $\H_w$ is proportional to the mesh's cotangent Laplacian matrix.
%
Whereas heterogeneous materials distributions affect $\H_w$ non-trivially and thus also the our optimal weights $\W$.
%

With these matrices defined, our optimal skinning eigenmodes are solutions to
\refeq{gevp-skinning-modes-derivation}, found efficiently via a genearlized eigenvalue solver.
%
%Finally, we can enforce the orthogonality constraint via Lagrange multipliers and solve for the weights by solving a weight-space GEVP:
%%
%\begin{align}
%    \boxed{\H_{w} \W =\W \M_{w} \boldsymbol{\Lambda}.}
%    \label{eq:gevp-skinning-modes-unconstrained}
%\end{align}
%
Each individual skinning eigenmode --- as a linear blend skinning weight --- corresponds to $d(d+1)$ degrees of freedom and may be used to generate  $d(d + 1)$ different motions, as shown in \reffig{motions-producible-by-skinning-modes} for $d=3$.
%
% Alec: why is this important to note? Why would someone do that?
%It is important to note that we can not arbitrarily select subsets of these degrees of freedom as doing so would destroy our subspace's closure under rotations as well as its ability to capture rotations. 
%Figure \ref{fig:motions-producible-by-skinning-modes} visualizes the space of 12 affine motions described by a single weight for $d=3$. 

\subsubsection{Weight Space Complementarity Constraint}
%
At run-time, our secondary-effect displacements should satisfy $\J^T \u^c = \boldsymbol{0}$, where recall $\J \in \mathbb{R}^{3n \times \dimp}$ is the current rig Jacobian.
%
In our subspace, this becomes $\J^T \Blbs \z = \boldsymbol{0}$.
%
Without knowledge of $\J$ \emph{a priori}, our optimized skinning eigenmodes will, in general, not admit non-trivial solutions. Even if they did, enforcing this constraint at run-time leads to a more difficult constrained optimization problem.
%
Fortunately, our formulation above as a generalized eigenvalue problem allows us to 
easily add constraints to our skinning weights, thus ensuring that our modes admit non-trivial solutions but also implicitly satisfy the constraint allowing us to remove it entirely at run-time.

\citet{Zhang:CompDynamics:2020} define $f_\text{rig}(\p)$ generically. For real-time  applications, we will assume that $f_\text{rig}$ is linear (single affine handle, linear blend skinning, blendshapes, etc.) and thus has a constant rig Jacobian $\J$.
%
Given $\J$, the constraint we need to add is
%
\begin{align}
    \J^T \Blbs = \boldsymbol{0} 
\end{align}

To express this in terms of $\W$, we can again make use of our weight-space skinning Jacobian matrices from \refeq{weight-space-skinning-jacobian} (not to be confused with $\J$) and expand the constraint to act on each weight.
%
This leads to a series of constraints that our weights need to satisfy: 
%
\begin{align}
\begin{matrix}
\J^T \A_{i, j} \W = \boldsymbol{0}
\end{matrix}  \in \mathbb{R}^{\dimp \times \nummodes}
\quad \forall i \in \{1, ...,d\}, \, j  \in \{1, ..., d+1\}
\end{align}
We can stack all our constraint matrices $\J^T \A_{i, j}$:
\begin{align}
\begin{bmatrix}
\J^T\A_{1, 1} \\
\vdots \\
\J^T \A_{d, d+1}\\
\end{bmatrix} 
\W = \J_w \W = \boldsymbol{0} \in \mathbb{R}^{p(d)(d+1) \times m}
\label{eq:weight-space-complementary-constraint}
\end{align}
where we call $\J_w \in \mathbb{R}^{ \dimp (d)(d+1) \times n}$ our weight-space complementarity constraint matrix.

We can incorporate this constraint in a standard generalized eigenvalue problem by solving instead
%
\begin{align}
    \begin{bmatrix}
    \H_{w}  & \J_{w}^T \\
    \J_{w} & \boldsymbol{0}
    \end{bmatrix}
    \begin{bmatrix}
    \W \\
    \boldsymbol{\mu}
    \end{bmatrix}
    =
     \begin{bmatrix}
    \M_{w}  & \boldsymbol{0} \\
    \boldsymbol{0} & \boldsymbol{0}
    \end{bmatrix} 
        \begin{bmatrix}
    \W \\
    \boldsymbol{\mu}
    \end{bmatrix}
    \boldsymbol{\Lambda}.  
    \label{eq:gevp-skinning-modes-constrained}
\end{align}

\reffig{skinning-weights-for-secondary-motion} shows how our derived skinning weights change to accommodate the rig-complementarity constraint.


%\input{localized_modes.tex}


% \begin{center}
%   \includegraphics[width=\textwidth, keepaspectratio]{images/weights_saturdated.pdf}
%     \captionof{figure}{Skinning Weights for Secondary Motion Under Different Rigs \label{fig:skinning-weights-for-secondary-motion}}
% \end{center}




\begin{figure*}
\includegraphics[width=\linewidth,keepaspectratio]{images/hetergeneous-worm-propeller.pdf} \timestamp[-0.25cm]{\tsHeterogeneousMaterialExperiment}
\caption{A material-aware subspace more efficiently captures the space of motions available to our simulation. This directly leads to richer dynamics.\label{fig:heterogeneous-skinning-modes}}
\end{figure*}
