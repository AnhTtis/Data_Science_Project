\documentclass[conference,a4paper,10pt]{IEEEtran}
%\documentclass{article}
\IEEEoverridecommandlockouts

% General
\usepackage[T1]{fontenc} % optional T1 font encoding
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{glossaries}
\input{acronym}
% Writing
\usepackage{lmodern}
\usepackage{comment}
\usepackage[colorlinks=true, allcolors=blue]{hyperref}
\usepackage{extarrows}
\usepackage{cite}
\usepackage[normalem]{ulem}
\hyphenation{op-tical net-works semi-conduc-tor}
% Plotting
\usepackage[svgnames]{xcolor}
\usepackage[pdftex]{graphicx}
\usepackage{caption}
\usepackage{subcaption}
% Tikz
\usepackage{tikz}
\usetikzlibrary{math, shapes}
\usepackage{pgfplots}
\pgfplotsset{
compat=1.3,
legend style={font=\scriptsize, fill opacity=0.8,  draw opacity=1, text opacity=1, draw=white!15!black, legend cell align=left, align=left}, 
width=6.5cm, 
yminorticks=false,
xminorticks=false,
title style={font=\small},
tick style={color=black},
tick label style={font=\small},
tick align=outside,
grid style={line width=.1pt, draw=gray!20},
major grid style={line width=.1pt,draw=gray!20},
label style={font=\small},
}
% Math
\usepackage{amssymb,amsmath,amsfonts,amsthm,bm,mathtools,cuted,bbold}
\usepackage[cmintegrals]{newtxmath}
\usepackage{cuted}
% Table
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage[ruled,vlined,linesnumbered]{algorithm2e}

% New commands
\newcommand{\T}{^{\intercal}}     % transpose
\renewcommand{\H}{^{\rm {H}}}   % hermitian
\newcommand{\E}[1]{\mathbb{E}\left\{ #1 \right\}} % expectation
\newcommand{\mc}[1]{\mathcal{#1}}   % mathcal abbreviation
\newcommand{\mb}[1]{\mathbf{#1}}    % mathbold abbreviation
\newcommand{\dpar}[2]{\mathop{}\!\frac{\partial #1}{\partial #2}}   % partial derivative
\newcommand*\diff{\mathop{}\!\mathrm{d}}    % differential in the integral
\DeclareMathOperator*{\argmax}{arg\,max}    % argmax
\DeclareMathOperator*{\argmin}{arg\,min}    % argmin
\DeclareMathOperator{\sinc}{sinc}

\newcommand{\DL}{^{\rm \scriptscriptstyle {DL}}} 
\newcommand{\UL}{^{\rm \scriptscriptstyle {UL}}} 
\newcommand{\HPp}{^{\rm \scriptscriptstyle {HP+}}}
\newcommand{\HPm}{^{\rm \scriptscriptstyle {HP-}}}


% Comments
\definecolor{gold}{rgb}{0.85,.66,0}
\definecolor{amaranth}{rgb}{0.9, 0.17, 0.31}


% COMMENTS
\newcommand{\TODO}[1]{\textcolor{orange}{TODO: {#1}}} % TODO commenting
\newcommand{\colb}{\textcolor{blue}} % used to highlight general changes
\newcommand{\colr}{\textcolor{red}} % used for problems in general 
\newcommand{\pp}[1]{\textcolor{blue}{ {#1}}} % Petar
\newcommand{\fs}[1]{\textcolor{amaranth}{#1}} % Fabio variations
\newcommand{\FS}[1]{\textcolor{amaranth}{\footnotesize \textsf{[Fabio: #1]}}} % Fabio comments
\newcommand{\KK}[1]{\textcolor{blue}{\footnotesize \textsf{[Kimmo: #1]}}} % Kimmo comments

\newtheorem{assumption}{Assumption}
\newtheorem{lemma}{Lemma}

%\title{A RIS-aided OFDM communication protocol exploiting positioning information}
% \title{Position based resource allocation with RIS in frequency selective channels}
\title{Localization-based OFDM framework for RIS-aided systems}
%\title{Why RIS chennels are inheretely frequency selective and how to fix it.}
\author{\IEEEauthorblockN{Fabio Saggese\IEEEauthorrefmark{1}, Kimmo Kansanen\IEEEauthorrefmark{1}\IEEEauthorrefmark{2}, and Petar Popovski\IEEEauthorrefmark{1}}
\IEEEauthorblockA{\IEEEauthorrefmark{1}Department of Electronic Systems, Aalborg University, Denmark (\{fasa, kimkan, petarp\}@es.aau.dk)}
\IEEEauthorblockA{\IEEEauthorrefmark{2}Department of Electronic Systems, Norwegian University of Science and Technology}\thanks{This work was partly supported by the Villum Investigator grant ``WATER'' from the Villum Foundation, Denmark, and by the Horizon 2020 ``RISE-6G'' project, financed by the European Commission under grant no. 101017011.}}

\begin{document}

\maketitle

\begin{abstract}
Efficient integration of reconfigurable intelligent surfaces (RISs) into the current wireless network standard is not a trivial task due to the overhead generated by performing channel estimation (CE) and phase-shift optimization. In this paper, we propose a framework enabling the coexistence between orthogonal-frequency division multiplexing (OFDM)
and RIS technologies. Instead of wasting communication symbols for the CE and optimization, the proposed framework exploits the localization information obtainable by RIS-aided communications to provide a robust
allocation strategy for user multiplexing. The results demonstrate the effectiveness of the proposed approach with respect to CE-based transmission methods.
\end{abstract}
\begin{IEEEkeywords}
Reconfigurable intelligent surfaces, OFDM, robust optimization, resource allocation
\end{IEEEkeywords}


\section{Introduction}
\Glspl{RIS} are considered among the enabling technologies for the next-generation (6G) of wireless networks due to their ability to control the wireless propagation environment~\cite{bjornson2021signalprocessing}. 

In recent years, many research works have shown the capabilities of the \gls{RIS} in terms of improved coverage, data rate, and mitigation of multi-user interference through accurate phase-shift optimization~\cite{mengnan2022survey}. 
However, only a few works have focused on integrating the \gls{RIS} into the existing communication protocols. To the best of the authors' knowledge, the authors of~\cite{Zheng2020cebf} were the first to consider \gls{RIS}-aided communications framework employing \gls{OFDM}, proposing a joint \gls{CE} and \gls{RIS} phase-shift optimization framework showing outstanding performance for a single \gls{UE} scenario.
Nevertheless, in multi-user systems, \gls{RIS} channel estimation procedures need pilot sequences whose length is proportional to the number of \gls{RIS} elements and the number of \glspl{UE} in the system~\cite{Wang2020ce, mengnan2022survey}. Hence, the \gls{CE} procedure may lead to an unfeasible overhead when serving a large number of users.
% \fs{While the effort of the community in reducing this overhead, it is still unclear if the \gls{RIS} can be integrated to the \gls{OFDM} classically.}

From a different perspective, the recent literature has shown the capability of using \gls{RIS} to enhance the performance of localization algorithms~\cite{bjornson2021signalprocessing}, and even enable new localization procedures not feasible without an \gls{RIS}~\cite{keykhosravi2021siso}.
Considering the relevance that \gls{ISAC} has gained to enable the \emph{connected intelligence} promised by the 6G, it is natural to imagine the use of the (improved) localization information available in \gls{RIS}-aided networks to help the scheduling decision: instead of wasting time for exchanging \gls{CE} pilot sequences, the knowledge of the \glspl{UE} position can be used to optimize the data transmission.
In this line, the authors of~\cite{Abrardo2021positioning} proposed a \gls{RIS} phase shift optimization based on localization information able to maximize the average spectral efficiency. Furthermore, in~\cite{wang2021joint}, the authors provide a \gls{TDD} framework to integrate communication and localization in \gls{RIS}-aided systems.

This paper proposes an \gls{OFDM} scheduling protocol for \gls{RIS}-aided systems based on localization information. 
 Following the time horizon provided by the \gls{OFDM} structure, our \gls{RIS} loads different configurations in different time slots, enhancing incoming signals in a space division manner. The configurations are stored in a \emph{codebook}, optimized to provide maximum gain within the configuration subspaces. 
The propagation scenario analyzed is far-field, with both direct and reflected paths present. We assume that the direct path is Rician distributed, while the \gls{RIS} reflected path is \gls{LOS}.
We show that the position can be used to determine a robust allocation strategy able to effectively utilize the designed codebook while keeping the \gls{OFDM} structure unchanged.
The performance is tested using max-rate and max-min allocation in both throughput and fairness and compared with the performance of a \gls{RIS}-aided system able to recover perfect \gls{CSI} through a minimum overhead \gls{CE} procedure.
Even considering the overhead obtained by the localization signaling needed to infer the position of the \gls{UE} in the system, we show that the proposed approach outperforms the \gls{CSI}-based system.\footnote{The simulation code for the paper is available at \url{https://github.com/lostinafro/ris-ofdm-loca-scheduling}}

%The rest of the paper is divided as follows: Sec.~\ref{sec:model} presents the system model and the proposed \gls{OFDM} structure. In Sec.~\ref{sec:codebook}, the design of the configuration codebook is given and its impact on the used spectrum is analyzed. Sec.~\ref{sec:scheduling} present the resource allocation strategy. Numerical results are presented in Sec.~\ref{sec:results}, while conclusion and future works are discussed in Sec.~\ref{sec:conclusions}.

\paragraph*{Notation} Integer sets are denoted by calligraphic letters $\mc{A}$ with cardinality $|\mc{A}|=A$. The complex Gaussian distribution is $\mc{CN}(\bm{\alpha},\mb{R})$ with mean $\bm{\alpha}$ and covariance matrix $\mb{R}$; non-central $\chi$-squared distribution with non-centrality $\xi$ and $v$ degrees of freedom is $\chi_v^{2}(\xi)$. Lowercase boldface letters denote column vectors $\mathbf{x}$; $\circ$ represents the element-wise vector multiplication. The identity matrix of size $N$ is $\mathbf{I}_N$, and $\mathbf{0}$ is a vector of zeros. %$\text{vec}(\cdot)$ vectorization of a matrix.
%  Euclidean norm of $\mathbf{x}$ is $\lVert\mathbf{x}\rVert_2$.  %Superscript $(\cdot)^*$ denotes complex conjugate. The $\arg\max(\cdot)$ function returns the index of the maximum element of a vector, while $\mathrm{med}\{\cdot\}$ and $\mathrm{max}\{\cdot\}$ denote the median and the maximum operator over a set, respectively. % The maximum operator over a set is.. % over a set.%We use $\bar{\cdot}$ and  

%We examine the propagation in an environment where a \gls{RIS} is deployed. We demonstrate how the \gls{RIS}, with an almost flat frequency response, imposes frequency selectivity even in a simple line of sight environment. We utilise the selectivity for frequency scheduling, effectively applying the principle of multi-user diversity.

\section{System model}
\label{sec:model}
We consider an \gls{UL} \gls{RIS}-aided communication scenario, where a single-antenna \gls{BS}, an \gls{RIS}, and set $\mc{K}$ of single-antenna \glspl{UE} are present. The \gls{BS} is assumed to have perfect knowledge of the \glspl{UE}' position, and it uses this information to make scheduling decisions.

\paragraph{Geometry} 
The scenario is shown in Fig.~\ref{fig:scenario}, where the $z$ axis points to the outgoing direction of the $x-y$ plane. The center of the \gls{RIS} is positioned at the origin of the axis, parallel to $x$ and $z$ axis. The dimensions of the \gls{RIS} are $D_x$ and $D_z$, and it is formed by $N = N_x \times N_z$ elements, having distance $d_x = \frac{D_x}{N_x}$ and $d_z = \frac{D_z}{N_z}$, on the $x$ and $z$ axes respectively.  We enumerate each element following the direction of the $x$ and $z$ axis, i.e., the element $n,n'$ has center position $\mb{r}_{n,n'} = \left[ d_x\left(n - (N_x + 1) / 2\right), 0, d_z\left(n' - (N_z + 1)/2 \right)\right]\T$, $n = 1, \dots, N_x$, $n'=1,\dots, N_z$. 
The \gls{BS} is positioned at $\mb{r}_b = [r_b, \theta_b, \varphi_b]\T$. The users are collected in the set $\mc{K}$, $|\mc{K}| = K$. Each user $k\in\mc{K}$ is positioned at $\mb{r}_k = [r_k, \theta_k, \varphi_k]\T$. The distance between \gls{UE} $k$ and \gls{BS} is denoted as $r_{b,k} = || \mb{r}_b  - \mb{r}_k||$. 
For simplicity of presentation, the elevation angle of both \gls{BS} and \gls{UE} is set as $\theta_k = \theta_b = \pi/2$, i.e., \glspl{UE}, \gls{BS} and \gls{RIS} lay on the same plane. The design principles given here can be extended for different elevation angles.

\begin{figure}[t]
    \centering
    \includegraphics[width=6cm]{img/scenario.pdf}
    \caption{Scenario in 2D.}
    \label{fig:scenario}
\end{figure}
 
\paragraph{RIS phase shift profile}
Each element $n,n'$ of the \gls{RIS} is able to imprint a %n attenuation $\alpha_{m,n}$ and 
phase shift $\phi_{n,n'}$ on the impinging electromagnetic wave\footnote{The \gls{RIS} is considered ideal, i.e., no attenuation or inter-element coupling is considered for mathematical tractability.}. The overall phase shift profile is a vector denoted as $\bm{\phi}\in\mathbb{C}^{N}$, collecting the phase shifts for each \gls{RIS}' element. A configuration \emph{codebook} collects the pre-determined phase shift profiles that can be loaded by the \gls{RIS}, i.e., \gls{RIS} and \gls{BS} share the knowledge of a finite set $\mc{C} = \{1, \dots, C\}$ of \gls{RIS}' configurations. When configuration $c\in\mc{C}$ is loaded, the correspondent \gls{RIS} phase shift profile $\bm{\phi}_c = [\phi_{1,1}^{(c)}, \dots, \phi_{N_x,1}^{(c)}, \phi_{1,2}^{(c)}, \dots, \phi_{N_x,2}^{(c)}, \dots, \phi_{N_x, N_z}^{(c)}]\T$ is designed to enhance the signal coming from a sector of the area, steering it towards the \gls{BS}. %In the remainder of the paper, the names ``configuration'' and ``phase shift profile'' will be used interchangeably.

\paragraph{Proposed data-frame structure}
The time-frequency resource grid is formed by $S$ time slots, collected in the set $\mc{S} = \{0,1,\dots,S-1\}$, each of duration $T_s$, and $F$ \glspl{RB}, collected in the set $\mc{F}=\{0, \dots, F-1\}$, each having bandwidth $\Delta_F$.
The first \gls{RB} is assumed to have central frequency $f_0$, i.e., wavelength $\lambda_0 = \frac{\nu}{f_0}$, where $\nu$ denotes the propagation velocity of the wave. Hence, the wavelength of \gls{RB} $f \in\mc{F}$ is $\lambda_f = \frac{\nu}{f_0 + f \Delta_F}$.
It is assumed that the coherence time is longer than the overall frame duration in time ($S T_s$), while $\Delta_F$ is lower than the coherence bandwidth.
% In the time domain, a different set of users is served by each \gls{RIS} configuration. 

% We assume that the \gls{RIS} frame length equals one time slot and, 
%Therefore, the number of slots is equal to the configurations employed, $S=C$. % Users positioned in the sector of the environment illuminated by configuration $c$ will share the time slot related to that configuration. 
%
Each time slot comprises $\tau_\mathrm{OFDM}$ \gls{OFDM} symbols; $\tau_d \le \tau_\mathrm{OFDM}$ are reserved for data communication, while $\tau_\ell = \tau_\mathrm{OFDM} - \tau_d$ are reserved for localization waveform the \gls{BS} can use to keep track of the user position through a specific algorithm, such as~\cite{keykhosravi2021siso}. It is assumed that the \gls{BS} can recover the position of each user without any error\footnote{The design of the localization algorithm is out of the scope of the paper. Future works will focus on the trade-off of localization and communication performance in this setting, taking into account the impact of the localization error in the overall scheduling strategy.}. 

At the beginning of each time slot, the \gls{RIS} loads a single configuration $c$, which is kept for the whole time slot duration. 
It is assumed that the time for loading a configuration is lower than the time of the \gls{CP} of the first \gls{OFDM} symbol, and hence the \gls{RIS} switching through different configurations does not influence the transmitted data (differently from, e.g.,~\cite{croisfelt2022oracle}).
\glspl{UE} are multiplexed through orthogonal slot-\gls{RB} allocation, as shown in the time-frequency example given in Fig.~\ref{fig:dataframe}. 

\begin{figure}
    \centering
    \includegraphics[width=0.9\columnwidth]{img/data-frame.pdf}
    \caption{Example of configuration and time-frequency allocation for $K = 7$ users.} % Configuration $c=1$ is associated to users $k\in\{1,2\}$, configuration $c$ for users $k\in\{3,4,5\}$ and configuration $c=S$ for $k\in\{6,7\}$.}
    \label{fig:dataframe}
\end{figure}

\paragraph{Signal model}
\label{sec:signal}
Consider that a single time-frequency resource related to configuration $c\in\mc{C}$ and frequency $f\in\mc{F}$ is exclusively allocated to user $k\in\mc{K}$. On that resource, the user transmits a symbols $x \in \mathbb{C}$, $\E{x} = 0$, $\E{|x|^2} = 1$, with power $P_k$. The received signal at the \gls{BS} is given by
\begin{equation}
    y_{k,f,c} = \Big( h_{k,f} + g_{k,f}(\bm{\phi}_c) \Big) \sqrt{P_k} x + w
\end{equation}
where we indicated $h_{f,k}\in \mathbb{C}$ as the direct \gls{BS}-\gls{UE} channel, $g_{f,k}(\bm{\phi}_c)\in\mathbb{C}$ as the \gls{BS}-\gls{RIS}-\gls{UE} reflected channel while the \gls{RIS} has configuration $c$ loaded, and $w \sim \mc{CN}(0, \sigma^2)$ as the \gls{AWGN} at the \gls{BS} receiver side.
The \gls{SNR} at the \gls{RB} is given by
\begin{equation} \label{eq:snr}
    \gamma_{k,f,c} = \frac{P_k}{\sigma^2} \left| |h_{k,f}|e^{j\angle h_{k,f}} + |g_{k,f}(\bm{\phi}_c)|e^{j\angle g_{k,f}(\bm{\phi}_c)} \right|^2
\end{equation}
where $\angle h_{k,f}$ is the phase shift that the signal experiences through the direct path, while $\angle g_{k,f}(\bm{\phi}_c)$ is the phase shift experienced through the reflective path comprehending the one imprinted by the \gls{RIS} configuration $c$. The \gls{SNR} of a single resource is maximized when $\angle g_{k,f}(\mb{\phi}_c) = \angle  h_{k,f}$. In the following, the assumption made on the channels and their formulation is given.

\begin{assumption} \label{assu:channel}
In this work, the direct channel coefficient is assumed to be Rician distributed, i.e., it has a deterministic \gls{LOS} component and a random \gls{NLOS} component; the reflected path has only a dominant deterministic \gls{LOS} component. \end{assumption}

According to Assumption~\ref{assu:channel}, the vector $\mb{h}_k, \mb{g}_k \in\mathbb{C}^F$ collecting the channel of the direct and reflective paths for all the \glspl{RB} are
\begin{align}
    &\mb{h}_{k} = \sqrt{\beta_k(r_{b,k})} \left[\sqrt{\frac{\kappa}{\kappa + 1}} \mb{d}(r_{b,k})   + \sqrt{\frac{1}{\kappa + 1}} \mb{n}_{k} \right], \label{eq:channel:direct}\\
    &\mb{g}_k(\bm{\phi}_c) = \hspace{-0.5mm}\sqrt{\beta_k(r_k r_b)} N \mb{d}(r_b + r_k) \hspace{-.8mm}\circ\hspace{-.5mm}\mb{a}_k(\bm{\phi}_c),  \label{eq:channel:reflected}
\end{align}
where $\mb{n}_k \sim \mc{CN}(\mb{0}, \mb{I}_F)$ is the random \gls{NLOS} component; the deterministic \gls{LOS} component is represented by
\begin{equation}
    \mb{d}(r) = e^{-j \frac{2 \pi}{\nu} f_0 r}  [1, e^{-j \frac{2 \pi}{\nu} \Delta_F r}, \dots, e^{-j \frac{2 \pi}{\nu} (F-1) \Delta_F r}]\T
\end{equation}
which collects the different propagation delays for different \glspl{RB}; $\kappa$ is the Rician factor previously estimated in the environment~\cite{Greenstein1999kfactor}; the path loss is~\cite{albanese2022marisa}
\begin{equation} \label{eq:pathloss}
    \beta_k(r) = \beta_0 \frac{G_k G_b}{r^\varepsilon} 
\end{equation}
having path-loss exponent $\varepsilon$\footnote{Here, we used the common assumption that the variation of the path loss on the different wavelengths is negligible.} and \gls{BS} and \gls{UE} antenna gains $G_b$ and $G_k$, respectively; finally, $\mb{a}_k(\bm{\phi}_c)$ is the normalized \gls{AF} generated by configuration $c$. 

Remark that \glspl{UE}, \gls{RIS} and \gls{BS} lay on the same plane; to provide the maximum gain on the $x-y$ plane, the phase shifts induced by the \gls{RIS} elements in the $z$-dimension are set to the same~\cite{Balanis2012antenna}. In other words, $\phi_{n,n'}^{(c)} = \phi_n$, $n'=1,\dots, N_z$, $\forall c \in\mc{C}$. The contribution of the normalized \gls{AF} on a frequency $f\in\mc{F}$ results~\cite{Balanis2012antenna, tang2020wireless}
\begin{equation} \label{eq:af:RB}
\begin{aligned} 
    a_{k, f}(\bm{\phi}_c) =& \, \frac{N_z}{N} e^{-j \frac{2 \pi}{\nu} (f_0 + f \Delta_F) \frac{N_x+1}{2} d_x (\cos\varphi_k + \cos\varphi_b)} \\
    \quad& \sum_{n=1}^{N_x} e^{j\phi_{n}^{(c)}} e^{j \frac{2 \pi}{\nu} (f_0 + f \Delta_F) n d_x (\cos\varphi_k + \cos\varphi_b)}.
\end{aligned}
\end{equation}

\section{Resource grid and codebook design}
\label{sec:codebook}
In this section, we propose a design of the codebook to cover the whole area of interest.
We remark that the element phase shift term $\phi_n^{(c)}$ influences all the \glspl{RB} in the same manner\footnote{Circuital-based \gls{RIS} models show that the \gls{RIS} phase shift is affected by the frequency~\cite{Li2021widebandris}. We neglect this effect to concisely show the design principle of the proposed protocol, considering that this dependency is deterministic and can be straightforwardly included.}; hence, we will design the phase shift for a single \gls{RB}, e.g., $f=0$, study the impact on the other frequencies, and finally provide a design of the configuration codebook to employ for the proposed paradigm.

\subsection{General phase-shift formulation}
For each configuration $c\in\mc{C}$, we aim to maximize the \gls{AF} gain when the received signal comes from a specific angular direction $\varphi_c$, for $f = 0$.  
By the observation of eq.~\eqref{eq:af:RB}, we can infer that each element phase shift $\phi_n^{(c)}$ needs to compensate for the phase shift generated by the \gls{BS} position, while let each term of the sum to be 1 when $\varphi_k = \varphi_c$.
Accordingly, we can design the phase shifts as
\begin{equation} \label{eq:phi_n}
    \phi_{n}^{(c)} = \frac{2 \pi}{\nu} f_0 (\phi_\text{res}^{(c)} - n d_x \phi^{(c)}_x),
\end{equation}
with
\begin{equation} \label{eq:phaseshifts}
\begin{cases}
   \phi_\text{res}^{(c)} = (\cos\varphi_b + \cos\varphi_c) \frac{N_x + 1}{2} d_x, \\
    \phi_{x}^{(c)} = \cos\varphi_b + \cos\varphi_c,
\end{cases}
\end{equation}
being $\phi_\text{res}^{(c)}$ set to cancel the residual phase shift given by the geometry of the \gls{RIS}. Indeed, plugging~\eqref{eq:phi_n}-\eqref{eq:phaseshifts} into eq.~\eqref{eq:af:RB} yields
\begin{equation} \label{eq:af:linearphase}
\begin{aligned}
    a_{k,f}(\bm{\phi}_c) &=  e^{-j \frac{2 \pi}{\nu} \frac{N_x+1}{2} d_x \left[f_0  (\cos\varphi_k - \cos\varphi_c) + f \Delta_F (\cos\varphi_k + \cos\varphi_b) \right]} \\
    & \frac{1}{N_x} \sum_{n=1}^{N_x} e^{j \frac{2 \pi}{\nu} n  d_x \left[f_0 (\cos\varphi_k - \cos\varphi_c) + f \Delta_F (\cos\varphi_k+ \cos\varphi_b) \right]}, \\
\end{aligned}
\end{equation}
which is maximized for $f=0$ if a user is located at $\varphi_k = \varphi_c$.
For $f \neq 0$, this design can remove the contribution of the \gls{AF} in the overall phase of the reflective channel 
% on the other hand, the residual phase given by the positions of \gls{UE} and \gls{BS} contribute in the \gls{AF} in the other \gls{RB} $\forall f \neq 0$. Luckily, these residual phase shifts do not contribute in the evaluation of 
$\angle g_{k,f}(\bm{\phi}_c)$. Indeed, by means of finite geometric series,  eq.~\eqref{eq:af:linearphase} can be rewritten as~\cite{Balanis2012antenna, tang2020wireless}
\begin{equation} \label{eq:af:sin}
\begin{aligned}
    a_{k,f}(\bm{\phi}_c) =& \frac{\sin\left(\frac{\pi d_x}{\nu} N_x \psi_{k,f} \right)}{N_x \sin\left(\frac{\pi d_x}{\nu} \psi_{k,f} \right)}
\end{aligned}
\end{equation}
where $\psi_{k,f} = f_0 (\cos\varphi_k - \cos\varphi_c) + f \Delta_F (\cos\varphi_k + \cos\varphi_b)$.
Eq.~\eqref{eq:af:sin} shows that $a_{k,f}(\bm{\phi}_c) \in \mathbb{R}$, i.e., $\angle a_{k,f}(\bm{\phi}_c) = \pi u(-a_{k,f}(\bm{\phi}_c))$ where $u(\cdot)$ is the Heaviside step function. Moreover, eq.~\eqref{eq:af:sin} is the \gls{AF} of the uniform linear phased array, being negative only outside of the main lobe region~\cite{Balanis2012antenna}. %, where the maximum gain is $\approx -13.46$ dB, i.e., the \gls{SLL}. 
Hence, as long as the allocated configuration and \glspl{RB} guarantee that the normalized \gls{AF} works in the main lobe for the user $k$, the contribution of the \gls{AF} in the total phase $\angle g_{k,f}(\bm{\phi}_k)$ is zero, i.e., $\angle a_{k,f}(\bm{\phi}_c) = 0$.

\begin{figure}[th]
    \centering
    \input{img/abs_af_frequency_varPhi}
    \caption{\gls{AF} vs. the frequency and for various values of $\varphi_k$, where $\varphi_c = \varphi_k$. $N_x = 8$, $d_x = d_z = \lambda_0 / 2$ m, and $\varphi_b = 150$°.}
    \label{fig:af:freq:phik}
\end{figure}

\subsection{Frequency dependency}
Regarding the influence on the frequency domain, we can prove experimentally that the \gls{AF} varies slowly with the different \glspl{RB}. A depiction of the frequency dependence of the \gls{AF} is given in Fig.~\ref{fig:af:freq:phik}; the plot is made for different angular positions and assuming that $\phi_c = \phi_k$, $\forall k$, to show the frequency dependence only. It can be seen that the position of the nulls of the function change according to the user position: the higher the azimuth angle, the narrower the main lobe\footnote{Remark that for particular positions $\cos\phi_k = -\cos\phi_b$, the \gls{AF} never changes, regardless the employed \gls{RB}.}.
Nevertheless, even considering the user at $\varphi_k = 170$°, to obtain a reduction of 20\% of the array gain, a frequency hop of $63.36$ MHz from the first \gls{RB} must be realized, i.e, $352$ \glspl{RB} with numerology 0~\cite{3gpp:rel15:MAC}. Therefore, we assume that the system has a number of available \glspl{RB} $F \le 350$ to minimize the effect of the variation of the \gls{AF} gain while guaranteeing that the contribution on the phase provided by the design~\eqref{eq:phi_n} is zero, regardless of the selected \gls{RB}.


\subsection{Codebook design}
To cover the whole area of interest using the proposed framework, we resort to an approach that enables us to create a codebook containing at least one configuration providing an \gls{AF} gain of at least $\tau \in (0,1]$ to any \gls{UE} $k$ regardless of its position, for $f=0$. To do so, we design a codebook having every consequent configuration to overlap at the angular direction that provides the desired minimum gain, similar to~\cite{croisfelt2022oracle}. 
For the sake of simplicity, we set $\tau = -3$ dB, but any other values can be considered with the same procedure. With negligible error, we approximate the main lobe of eq.~\eqref{eq:af:sin} by a $\sinc$ function~\cite{Balanis2012antenna, croisfelt2022oracle}. Thus, we find the argument such that $|\sinc(x_\tau)|^2 = \tau = 0.5$, which gives the value of $x_\tau \approx \pm 1.391$. Therefore, $\sinc(\pi d_x / \nu N_x \psi_{k,0}) \ge \tau$ when
\[
- x_\tau \le \frac{\pi d_x}{\nu} N_x f_0 (\cos\varphi_k - \cos\varphi_c) \le x_\tau,
\]
Now, define as $\varphi\HPm_c$ and $\varphi\HPp_c$ the angular directions where the \gls{AF} gain for configuration $c$ is half of the maximum, where $\varphi\HPm_c < \varphi_c < \varphi\HPp_c$; to let consequent configurations having overlapping half power angular direction, we impose $\varphi\HPm_{c+1} = \varphi\HPp_{c}$, $\forall c \in\mc{C}$. Accordingly, the set of equation to satisfy is $\forall c \in\mc{C}$
\begin{equation} \label{eq:halfpowersystem}
    \begin{cases}
        \frac{\pi d_x}{\nu} N_x f_0 \left( \cos\varphi\HPm_c - \cos\varphi_c \right) = x_\tau, \\
        \frac{\pi d_x}{\nu} N_x f_0 \left( \cos\varphi\HPp_c - \cos\varphi_c \right) = -x_\tau, \\
        \varphi\HPm_{c+1} = \varphi\HPp_{c}.
    \end{cases}
\end{equation}
To cover the whole area, we impose that $\varphi\HPm_1 = 0$, meaning that the first configuration has the half power direction towards the right limit of the area of interest. Therefore, by solving~\eqref{eq:halfpowersystem} in an iterative manner, we obtain
\begin{equation} \label{eq:codebook-design}
% \mc{C} = \{\bm{\phi}_c\}_1^C \,\, \text{s.t.} \,\,
\begin{cases}
    \cos\varphi_c = 1 - (2 c - 1)  \frac{\nu x_\tau}{\pi d_x N_x f_0}, \\
    \cos\varphi_c\HPm = 1 - (2 c - 2)  \frac{\nu x_\tau}{\pi d_x N_x f_0}, \\
    \cos\varphi_c\HPp = 1 - (2 c)  \frac{\nu x_\tau}{\pi d_x N_x f_0},
\end{cases}
\end{equation}
where the number of configurations to cover the area is
\begin{equation}
        C = \min\left\{c\in\mathbb{N} \,|\, \cos\varphi\HPp_c < -1\right\} = \left\lceil \frac{\pi d_x N_x f_0}{x_\tau \nu} \right\rceil.
    \label{eq:codebook-design:C}
\end{equation}
A visualization of the obtained codebook is given in Fig.~\ref{fig:codebook-design}.

\begin{figure}[thb]
    \centering
    \input{img/varPhi_array_factor}
    \caption{Visualization of the \gls{AF} using the codebook design in~\eqref{eq:codebook-design}, with $\tau = 0.5$, $x_\tau = 1.391$, and $N_x=8$.}
    \label{fig:codebook-design}
\end{figure}

\section{Resource allocation} \label{sec:scheduling}
In this section, we present the allocation scheduling process based on the proposed framework.

Given the set of configurations $\mc{C}$, the set of available of \glspl{RB}, and the position information of each user, 
we know the value of the deterministic part of the \gls{SNR} for all the \glspl{UE}, \glspl{RB} and time-slots. Nevertheless, the actual \gls{SNR} is a random variable: to provide a feasible communication rate, the \gls{SE} set for the data transmission must be lower than the achievable capacity. 
%Let us define $\epsilon$ as the probability of success of sending data in any time-frequency resource. 
To overcome this issue, we define the $\epsilon$-robust \gls{SE} $r_{k,f,c}^\epsilon$ as the \gls{SE} that assures that the data transmitted by \gls{UE} $k$ on \gls{RB} $f$ and under configuration $c\in\mc{C}$ are successfully decoded with probability $\epsilon$, i.e., the \gls{SE} satisfying
\begin{equation}
    \mc{P}\left[r_{k,f,c}^\epsilon \le \log_2\left( 1 + \gamma_{k,f,c}\right) \right] \le 1 - \epsilon.
\end{equation}
%The value of $r_{k,f,c}^\epsilon$ is given by the following Lemma.
\begin{lemma}
Following Assumption~\ref{assu:channel}, the  $\epsilon$-robust \gls{SE} is
\begin{equation}
    r_{k,f,c}^\epsilon = \log_2\left(1 + \frac{P_k}{2\sigma^2(\kappa +1)} F^{-1}_{\tilde{\gamma}_{k,f,c}}(1 - \epsilon) \right)
\end{equation}
where $F^{-1}_{\tilde{\gamma}_{k,f,c}}(\cdot)$ is the inverse \gls{CDF} function of $\tilde{\gamma}_{k,f,c} \sim \chi_2^{2}(\xi_{k,f,c})$, where $\xi_{k,f,c}$ is given in eq.~\eqref{eq:nc} at the top of next page.
\end{lemma}
%
\begin{figure*}[bt]
    \centering
\begin{equation} \label{eq:nc}
\xi_{k,f,c} = 2\left(\kappa + \frac{\kappa + 1}{\beta(r_{b,k})} |g_{f,k}(\mb{\phi}_c)|^2 + 2 \sqrt{\frac{\kappa + 1}{\beta(r_{b,k})}} \Re\{ d_{f}(r_{k,b}) g_{k,f}(\mb{\phi}_c)\} \right)
\end{equation}
\par\noindent\rule{\textwidth}{0.4pt}
\end{figure*}
%
\begin{proof}
The proof comes directly from the definition of the channels~\eqref{eq:channel:direct}-\eqref{eq:channel:reflected} after few manipulations. %, we have $h_{k,f} + g_{k,f}(\bm{\phi}_c) \sim \mc{CN}(\sqrt{\beta_k(r_{b,k}) \kappa / (\kappa + 1)} d_{f} + g_{k,f}, \beta_k(r_{b,k}) / (\kappa + 1))$. 
\end{proof}

In practice, knowing the deterministic part of the \gls{SNR} allows us to compute the $\epsilon$-robust \gls{SE} for all the resources and use it to optimize the allocation.
To this purpose, we further define the allocation variable $\rho_{k,f,c}\in\{0,1\}$, mapping each user with the corresponding time-frequency resource. Accordingly, the total \gls{SE} of user $k$ is
\begin{equation} \label{eq:rk}
    r_k = \sum_{c\in\mc{C}} \sum_{f\in\mc{F}} \rho_{k,f,c} r_{k,f,c}^\epsilon
\end{equation}
To evaluate the system performance with different metrics, we focus on two classical problems: maximize the overall rate, and maximize the minimum rate.

\paragraph{Max-Rate}
In order to maximize the overall communication throughput, we define the following optimization problem:
\begin{align}
    \max_{\bm{\rho}} & \sum_{k\in\mc{K}} r_k \label{eq:max-rate}\\    
    \text{s.t.} \quad & \rho_{k,f,c} \in \{0,1\}, \tag{\ref{eq:max-rate}.a} \quad \forall f \in \mc{F}, \label{eq:max-rate:integer}\\
    & \sum_{k\in\mc{K}} \rho_{k,f,c} \le 1, \tag{\ref{eq:max-rate}.b} \quad \forall f \in \mc{F}, \, \forall c\in\mc{C}, \label{eq:max-rate:rho}
\end{align}
where constraint~\eqref{eq:max-rate:integer} enforces the integer condition on the allocation variable, and constraint~\eqref{eq:max-rate:rho} assures that each time-frequency resource is allocated to at most one user.

The optimal solution of problem~\eqref{eq:max-rate} is trivial: each \gls{RB} of each slot is given to the \gls{UE} providing the highest $\epsilon$-robust \gls{SE}, i.e.,
\begin{equation} \label{eq:allovar}
    \rho_{k,f,c} =
    \begin{cases}
    1, \quad f = \argmax_{k\in\mc{K}} r_{k,f,c}^\epsilon,  \\
    0, \quad\text{othewise},
    \end{cases}
    \, \forall c\in\mc{C}.
\end{equation}

\paragraph{Max-min}
In order to maximize the minimum rate between the users, we define the following optimization problem:
\begin{equation} \label{eq:max-min}
\begin{aligned}
    &\max_{\bm{\rho}} \min_{k\in\mc{K}}~r_k  
    &\text{s.t} \quad \eqref{eq:max-rate:integer}, \, \eqref{eq:max-rate:rho}.
\end{aligned}    
\end{equation}

In this case, the problem is not trivial, and an optimal solution is hard to achieve. Therefore, we resort to a heuristic scheme that iteratively allocates the \gls{RB} to the \gls{UE} with the smallest rate~\cite{Radunovic2007maxmin}. The procedure is given in Algorithm~\ref{alg:max-min}, where $A = F C$, and $a$ represents the double index $(f,c)$ in lexicographic order.

\setlength{\textfloatsep}{0pt}
\begin{algorithm}[t]
\caption{Max-min allocation}
\label{alg:max-min}
\footnotesize
 \textbf{Initialize}: $r_k = 0$, $\forall k \in\mc{K}$, $\mc{A} = \{1, \dots, A\}$\; 
 \tcc{Assign at least one \gls{RB}}
   \For{$k\in\mc{K}$}{
    $\hat{a} = \argmax_{a\in\mc{A}} r_{k,:,:}^\epsilon$\;
    $\rho_{k,\hat{a}} = 1$\;     
    $\mc{A} = \mc{A} \setminus \{\hat{a}\}$\;
    update $r_k$ by~\eqref{eq:rk}\;
   }
   \tcc{Distribute the remaining \glspl{RB}}
   \While{$\mc{A} \neq \empty$}{
   $\hat{k} = \argmin_{k\in\mc{K}} r_k$\;
    $\hat{a} = \argmax_{a\in\mc{A}} r_{\hat{k},:,:}^\epsilon$\;
    $\rho_{\hat{k},\hat{a}} = 1$\;
    update $r_k$ by~\eqref{eq:rk}\;
   }   
   % \Return{$\bm{\rho}$, $\mb{r}$}
\end{algorithm}

\subsection{Joint vs. sequential allocation}
The scheduling procedure described performs both the $\epsilon$-robust rates evaluation and the allocation operation on the entire dimension of the tensor $K \times F \times C$. While the optimization problems presented here are relatively simple, performing more complicated resource allocation schemes may be computationally infeasible in a real application. 
In those cases, we can resort to a sequential allocation: time slot allocation first, followed by \gls{RB} allocation.

The time slot allocation is determined by comparing the angular position of the user with the angular pointing of the various configuration.
Denoting as $c_k$ the configuration employed by user $k$, we have
\begin{equation} \label{eq:conf-allocation}
    c_k = \argmin_c \left\{ |\varphi_c - \varphi_k|\right\},
\end{equation}
and the time slot allocation is obtained straightforwardly. 

For the \gls{RB} allocation, let us denote as $\mc{K}_c \subseteq \mc{K}$ the subset of the users allocated to configuration $c\in\mc{C}$. Consequently, we can apply eq.~\eqref{eq:allovar} for a max-rate allocation, taking care of substituting $\mc{K}_c$ to $\mc{K}$ in the rule.
Similarly, Algorithm~\ref{alg:max-min} can be applied for max-min allocations, where now $A = F$, and $a$ represents the index~$f$.


\section{Numerical results} \label{sec:results}

\setlength{\textfloatsep}{15pt}
\begin{table}[tb]
    \centering
    \caption{Simulation parameters.}\vspace{-0.2cm}
    \footnotesize
    {\renewcommand{\arraystretch}{1}
    \begin{tabular}{@{}lcc@{}}
    \toprule
    Parameter & Symbol & Value \\ \midrule
    %\multicolumn{3}{c}{\textbf{Geometry}} \\ \midrule
    Outer/inner radius & $R_\mathrm{out}, R_\mathrm{inn}$ & $30/9$~m\\     
    BS position (Cartesian) & $\mb{r}_b$ & $[10, 100, 0]\T$~m\\
    RIS element spacing & $d_x = d_z $ & $\lambda / 2$\\
    Number of RIS elements & $N_x = N_z$ & 10\\    
    %\midrule
     %\multicolumn{3}{c}{\textbf{Communication system}}\\ %\midrule     
     Central frequency & $f_0$ & 1.8 GHz\\
     Bandwidth & $\Delta_F$ & $180$~kHz\\
     \glspl{RB} & $F$ & 50 \\
     Time slots/Configurations & $S=C$ & $11$\\
     OFDM symbols & $\tau_\mathrm{OFDM}$ & 14 \\
     OFDM data/localization symbols & $\tau_d, \tau_\ell$ & 7, 7 \\
     Success probability & $\epsilon$ & $95$\% \\     
     Antenna gains &$G_b \cdot G_k$ & $12.85$~dB\\     
     Path loss exponent &$\varepsilon$ &$2.7$\\
     Reference path gain & $\beta_0$ & $-31.53$~dB\\     
     \bottomrule
    \end{tabular}\vspace{-0.4cm}}
    \label{tab:params}
\end{table}

In this section, we present our numerical results. 
To perform the simulations, we have deployed the $K$ users randomly in a ring having inner radius $R_\mathrm{inn}$ and outer radius $R_\mathrm{out}$. The parameters we used are listed in Table~\ref{tab:params}.
As a benchmark, we consider the \gls{CSI}-based approach working as follows: before the communication data phase, minimal length pilot sequences~\cite{Wang2020ce} are sent by the \glspl{UE} to perform \gls{CE}, one complex symbol per \gls{OFDM} symbol to cover all the \glspl{RB}. The estimation is assumed to be \emph{noise-free}, i.e., the \gls{BS} has perfect \gls{CSI} after the \gls{CE} ends. In the following, we label \texttt{csi} the performance obtained by the \gls{CSI}-based scheme, while \texttt{jnt} and \texttt{seq} the localization-based joint and sequential allocation performance.
The main performance metrics used are the average total throughput obtained by the system, and Jain's fairness index, given by
\begin{equation} \label{eq:metrics}
\begin{aligned}
    \bar{r} = \eta^{(i)} \frac{\Delta_F}{S} \sum_{k\in\mc{K}} r_k, \quad
    J = \frac{\left(\sum_{k\in\mc{K}} r_k\right)^2}{\sum_{k\in\mc{K}} r_k^2}
\end{aligned}
\end{equation}
In eq.~\eqref{eq:metrics}, $\eta^{(i)}$ represent the efficiency of the $i$-th communication scheme given by $\eta^{(\texttt{jnt})} = \eta^{(\texttt{seq})} = \epsilon \frac{\tau_d}{\tau_d + \tau_\ell}$ and $\eta^{(\texttt{csi})} =  \frac{S \tau_\mathrm{OFDM}}{S \tau_\mathrm{OFDM} + \tau_\mathrm{csi}}$,
% \begin{equation}
% \eta = 
%     \begin{cases}
%         \epsilon \frac{\tau_d}{\tau_d + \tau_\ell}, \quad i \in\{\texttt{jnt}, \texttt{seq}\}, \\
%         \frac{S \tau_\mathrm{OFDM}}{S \tau_\mathrm{OFDM} + \tau_\mathrm{csi}}, \quad i = \texttt{csi},
%     \end{cases}
% \end{equation}
where $\tau_\mathrm{csi} = \lceil K (N_x + 1)\rceil$~\cite{Wang2020ce}.

\begin{figure}[thb]
    \centering
    \begin{subfigure}[t]{.45\columnwidth}
    \centering
    \input{img/tikz/max_rate_throughput_vs_K.tex}
    \vspace{-0.6cm}
    \caption{$\kappa = -9$ dB}
    \end{subfigure}
    ~
    \begin{subfigure}[t]{.45\columnwidth}
    \input{img/tikz/max_rate_throughput_vs_kappa.tex}
    \vspace{-0.15cm}
    \caption{$K = 55$}
    \end{subfigure}
    \caption{Max-rate performance.}
    \label{fig:max-rate}
\end{figure}

Fig.~\ref{fig:max-rate} shows the performance obtained by the max-rate allocation schemes. Fig.~\ref{fig:max-rate}(a) presents the throughput as a function of the number of users $K$ when $\kappa = -9$ dB, while Fig.~\ref{fig:max-rate}(b) as a function of the Rician $\kappa$ factor when $K = 55$. Both localization-based paradigms outperform the CSI-based scheme. In particular, when the system is in an overloaded state, i.e., $K > F S$, the \gls{CE} overhead increases in a prohibitive manner. Interestingly, even with a low number of users, the localization-based schemes achieve superior performance for every value of $\kappa$ under test.


\begin{figure}[thb]
    \centering
    \begin{subfigure}[t]{.45\columnwidth}
    \centering
    \input{img/tikz/max_min_fairness_vs_K_kappa-9.tex}
    \vspace{-0.2cm}
    \caption{$\kappa = -9$ dB}
    \end{subfigure}
    ~
    \begin{subfigure}[t]{.45\columnwidth}
    \input{img/tikz/max_min_throughput_vs_kappa.tex}
    \vspace{-0.2cm}
    \caption{$K = 550$}
    \end{subfigure}
    \caption{Min-max performance.}
    \label{fig:min-max}
\end{figure}

Fig.~\ref{fig:min-max} shows the performance of the min-max allocation schemes. Fig.~\ref{fig:min-max}(a) presents the fairness as a function of the number of users $K$ when $\kappa = -9$ dB, while Fig.~\ref{fig:min-max}(b) the average throughput per user as a function of the Rician $\kappa$ factor when $K = 550$. In this case, the fairness performance of \texttt{jnt} and the \texttt{csi} are comparable, both outperforming \texttt{seq} for every $K$. Regarding the average throughput per user, the localization-based schemes outperform \texttt{csi}. In particular, \texttt{jnt} has a clear advantage to \texttt{csi} reaching similar fairness, but with an average rate more than doubled.


\section{Conclusions} \label{sec:conclusions}
This paper proposed an \gls{OFDM} framework for \gls{RIS}-aided communications that exploit localization information to perform a robust resource allocation in a multi-user scenario. The results presented show the effectiveness of the proposed approach w.r.t. \gls{CE}-based solutions.
While the proposed solution is promising, the impact of localization accuracy needs to be studied by investigating the trade-off of transmitting data and localization symbols.


%============================
% References
%============================
\bibliographystyle{IEEEtran}
\bibliography{loca.bib}
\end{document}
