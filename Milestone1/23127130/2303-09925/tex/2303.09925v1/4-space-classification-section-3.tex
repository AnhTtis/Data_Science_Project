% % !TEX options=--shell-escape
% \documentclass[12pt]{iopart}
% \pdfoutput=1 % go for pdflatex

% % == Standard packages ==
% \usepackage{iopams}
% \input{packages}

% % == Theorem environments ==
% \theoremstyle{definition}
% % A definition introduces a new concept rigorously:
% \newtheorem{definition}{Definition}[section]
% % A remark introduces tangential considerations: 
% \newtheorem{remark}{Remark}[section]
% % A theorem is a key result:
% \newtheorem{theorem}{Theorem}[section]
% % A proposition is a result requiring explicit proof:
% \newtheorem{proposition}[theorem]{Proposition}
% % A lemma is an intermediate result for a theorem or a proposition, requiring explicit proof:
% \newtheorem{lemma}[theorem]{Lemma}
% % An observation is a result not requiring explicit proof:
% \newtheorem{observation}[theorem]{Observation}
% % A corollary cis a result directly following from a previous result:
% \newtheorem{corollary}[theorem]{Corollary}
% % A conjecture is a result we think is true but could not prove:
% \newtheorem{conjecture}[theorem]{Conjecture}

% % == Macros ==
% \input{macros}
% \newcommand{\TODO}[1]{{\marginpar{\color{gray}\textsf{[TODO]}} \color{gray}\textsf{[#1]}}}
% \newcommand{\NOTE}[1]{{\marginpar{\color{gray}\textsf{[NOTE]}} \color{gray}\textsf{[#1]}}}

% \begin{document}

% % == Dummy Sections ==

% \section{Introduction}
% \label{section: introduction}

% \section{Causal orders}
% \label{section:causal-orders}

% \newpage

% === COMMENT ABOVE BEFORE COMPILING MAIN FILE ===


\section{Spaces of input histories}
\label{section:spaces}

In this Section we recap notions about spaces of input histories that form the basis for the topological framework presented in the next Section.
For a full discussion, including proofs of all results, we refer the reader to Section 3 of the companion work ``The Combinatorics of Causality'' \cite{gogioso2022combinatorics}.
For applications of spaces of input histories, we refer the reader to the comapnion works ``The Topology of Causality'' \cite{gogioso2022topology} and ``The Geometry of Causality'' \cite{gogioso2022geometry}

This work is concerned with the causal structure of a certain class of experiments or protocols, where events correspond to the local operation of black-box devices.
At each event, an input to the device is freely chosen from a finite input set, in response to which the device produces (probabilistically) an output in a finite output set.
The ensuing probability distribution on joint outputs for all devices, conditional on joint inputs for all devices, forms the basis of our causal analysis.
In the most general case, no causal constraints are given on the events.

When we say that the devices are operated locally at each event, we mean that no information about the other events is explicitly used in the operation: every dependence on the inputs and outputs at other events must be entirely mediated by the causal structure.
If event \ev{A} causally succeeds event \ev{B}, for example, then the output at \ev{A} is allowed depend on the input and output at \ev{B}: the devices being operated at the two events are black-box, and it is causally possible for one of them to signal the other.
However, the input at \ev{A} is still freely chosen, regardless of what happened at \ev{B}, and the input/output sets for the device at \ev{A} are fixed beforehand.
In the absence of causal constraints, it is therefore possible for the output at each event to arbitrarily depend on inputs at all events, and for the outputs at any set of events to be correlated.
As a consequence, the only conditional probability distribution that is well-defined in general is one on joint outputs for all events, conditional on joint inputs for all events.

\subsection{Partial Functions}
\label{subsection:spaces-pfuns}

Given a family $\underline{Y} = (Y_x)_{x \in X}$ of sets, the \emph{partial functions} $\PFun{\underline{Y}}$ on $\underline{Y}$ are defined to be all possible functions $f$ having subsets $D \subseteq X$ as their domain $\dom{f} := D$ and such that $f(x) \in Y_x$ for all $x \in D$.
\begin{equation*}
    \PFun{\underline{Y}}
    :=
    \bigcup_{D \subseteq X}
    \prod_{x \in D}
    Y_x
\end{equation*}
Partial functions are partially ordered by restriction:
\begin{equation*}
    f \leq g
    \hspace{2mm}\stackrel{def}{\Leftrightarrow}\hspace{2mm}
    \dom{f} \subseteq \dom{g}
    \text{ and }
    \restrict{g}{\dom{f}} = f
\end{equation*}
We observe that, under their restriction order, partial functions form a lower semilattice, with the empty function $\emptyset$ as its minimum and meets given by:
\begin{equation*}
\begin{array}{rcl}
    \dom{f \wedge g}
    &=&
    \suchthat{x \in \dom{f}\cap\dom{g}}{f(x) = g(x)}
    \\
    f \wedge g
    &=&
    \restrict{f}{\dom{f \wedge g}}
    =
    \restrict{g}{\dom{f \wedge g}}
\end{array}
\end{equation*}
We say that $f$ and $g$ are \emph{compatible} when the inclusion above is an equality:
\begin{equation*}
    \text{$f$ and $g$ compatible}
    \hspace{2mm} \Leftrightarrow \hspace{2mm}
    \dom{f \wedge g}
    =
    \dom{f} \cap \dom{g}
\end{equation*}
More generally, we say that a set $\mathcal{F} \subseteq \PFun{\underline{Y}}$ of partial functions is \emph{compatible} if $f$ and $g$ are compatible for all $f, g \in \mathcal{F}$.
The \emph{join} of a set $\mathcal{F}$ of partial functions exists exactly when the set is compatible, in which case it is given by:
\begin{equation*}
\label{eq:definition:join}
\begin{array}{rcl}
    \dom{\bigvee \mathcal{F}}
    &=&
    \bigcup\limits_{f \in \mathcal{F}} \dom{f}
    \\
    \bigvee \mathcal{F}
    &=&
    x \mapsto f(x) \text{ for any $f$ such that } x \in \dom{f}
\end{array}
\end{equation*}
The \emph{compatible joins} in a set $\mathcal{F}'$ of partial functions are all possible joins $\bigvee\mathcal{F}$ of compatible subsets $\mathcal{F} \subseteq \mathcal{F}'$.


\subsection{Input Histories for Causal Orders}
\label{subsection:spaces-order-induced}

Consider a causal order $\Omega$ and an associated family of input sets $\underline{I}$.
Because of causality, the output at an event $\xi$ can only depend on choices of inputs for the events $\omega$ in $\downset{\xi}$, the causal past of $\xi$. This observation motivates the following definition.

\begin{definition}
The \emph{input histories} for a given choice of order $\Omega$ and inputs $\underline{I} = (I_\omega)_{\omega \in \Omega}$ are defined to be the partial functions in the following set:
\begin{equation*}
    \Hist{\Omega, \underline{I}}
    \;:=\;
    \bigcup_{\xi \in \Omega}
    \prod_{\omega \in \downset{\xi}}
    I_\omega
    \;\;\subseteq\;\;
    \PFun{\underline{I}}    
\end{equation*}
Input histories inherit the restriction order of partial functions, and we refer to the partially ordered set $\Hist{\Omega, \underline{I}}$ as a \emph{space of input histories}.
\end{definition}

As a simple concrete example, let $\Omega$ be the total order on 3 events and consider its associated lattice of lowersets $\Lsets{\Omega}$.
In the lattice, the causal pasts of individual events have been colour-coded.
\begin{center}
    \raisebox{1.15cm}{$\LsetsSym$}
    \raisebox{1.15cm}{$\left(\rule{0cm}{1.35cm}\right.$}
    \hspace{-0.3cm}
    \raisebox{0cm}{
        \includegraphics[height=2.5cm]{svg-inkscape/total-ABC-highlighted_svg-tex.pdf}
    }
    \hspace{-0.3cm}
    \raisebox{1.15cm}{$\left.\rule{0cm}{1.35cm}\right)$}
    \hspace{0.5cm}
    \raisebox{1.15cm}{$=$}
    \hspace{0.25cm}
    \includegraphics[height=2.5cm]{svg-inkscape/total-ABC-lsets-highlighted_svg-tex.pdf}
\end{center}
Below is the Hasse diagram for the space of input histories, consisting of all binary functions on $\evset{A}$, $\evset{A,B}$ and $\evset{A,B,C}$.
\begin{center}
    \includegraphics[height=3cm]{svg-inkscape/total-ABC-hists-highlighted_svg-tex.pdf}
\end{center}

Input histories are not generally closed under meets, and the only subsets closed under joins are chains (in which case the join is the maximum).
When talking about the meet of two (or more) input histories, we will always mean the meet in $\PFun{\underline{I}}$; similarly, when saying that a subset $\mathcal{F} \subseteq \Hist{\Omega, \underline{I}}$ of input histories is compatible, we will always mean that it is compatible in $\PFun{\underline{I}}$.

\begin{definition}
The \emph{extended input histories} for a given choice of order $\Omega$ and inputs $\underline{I} = (I_\omega)_{\omega \in \Omega}$ are defined to be the partial functions in the following set:
\begin{equation*}
    \ExtHist{\Omega, \underline{I}}
    \;:=\;
    \bigcup_{U \in \Lsets{\Omega}}
    \prod_{\omega \in U}
    I_\omega
    \;\;\subseteq\;\;
    \PFun{\underline{I}}    
\end{equation*}
Extended input histories inherit the restriction order of partial functions, and we refer to the partially ordered set $\ExtHist{\Omega, \underline{I}}$ as a \emph{space of extended input histories}.
\end{definition}

The spaces of (extended) input histories derived from causal orders work quite well when the orders are definite, but they do not quite capture the full desired gamut of possibilities for indefinite causal orders.
Indeed, consider the following indefinite causal order $\Omega$ on 3 events, and its associated lattice of lowersets $\Lsets{\Omega}$.
\begin{center}
    \raisebox{1.15cm}{$\LsetsSym$}
    \raisebox{1.15cm}{$\left(\rule{0cm}{1.35cm}\right.$}
    \hspace{-0.4cm}
    \raisebox{0cm}{
        \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-highlighted_svg-tex.pdf}
    }
    \hspace{-0.5cm}
    \raisebox{1.15cm}{$\left.\rule{0cm}{1.35cm}\right)$}
    \hspace{0.5cm}
    \raisebox{1.15cm}{$=$}
    \hspace{0.25cm}
    \raisebox{0.0cm}{
        \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-lsets-highlighted_svg-tex.pdf}
    }
\end{center}
Because events \ev{B} and \ev{C} are in indefinite causal order, they have the same causal past, and hence they are never separated by input histories.
\begin{center}
    \includegraphics[height=2.25cm]{svg-inkscape/total-AZBCZ-hists-highlighted_svg-tex.pdf}
\end{center}


\subsection{Spaces of Input Histories}
\label{subsection:spaces-definition}

\begin{definition}
A subset $\Theta \subseteq \PFun{\underline{I}}$ is said to be \emph{$\vee$-prime} (read ``join-prime'') if no $h \in \Theta$ can be written as the compatible join $h = \bigvee \mathcal{F}$ of a subset $\mathcal{F} \subseteq \Theta$ such that $h \notin \mathcal{F}$:
\[
\left(
    \mathcal{F} \subseteq \Theta \text{ compatible and }
    \bigvee \mathcal{F} \in \Theta
\right)
\Rightarrow \bigvee \mathcal{F} \in \mathcal{F}
\]
Dually, a subset $W \subseteq \PFun{\underline{I}}$ is said to be \emph{$\vee$-closed} (read ``join-closed'') if for every pair of compatible $h, k \in W$ the join $h \vee k$ is itself in $W$.
This implies that, more generally:
\[
\mathcal{F} \subseteq \Theta \text{ compatible }
\Rightarrow
\bigvee \mathcal{F} \in \Theta
\]
\end{definition}

\begin{definition}
A \emph{space of input histories} is a finite set $\Theta$ of partial functions which is $\vee$-prime.
The associated \emph{event set} $\Events{\Theta}$ and family of \emph{input sets} $\underline{\Inputs{\Theta}} = (\Inputs{\Theta}_\omega)_{\omega \in \Events{\Theta}}$ are defined as follows:
\begin{equation*}
    \begin{array}{lcl}
        \Events{\Theta}
        &:=&
        \bigcup_{h \in \Theta} \dom{h}
        \\
        \Inputs{\Theta}_\omega
        &:=&
        \suchthat{h_\omega}{h \in \Theta, \omega \in \dom{h}}
    \end{array}
\end{equation*}
We have $\Theta \subseteq \PFun{\underline{\Inputs{\Theta}}}$ and the space $\Theta$ is equipped with the partial order inherited from $\PFun{\underline{\Inputs{\Theta}}}$.
The \emph{space of extended input histories} $\Ext{\Theta}$ associated to $\Theta$ is its $\vee$-closure:
\begin{equation*}
    \Ext{\Theta}
    :=
    \suchthat{\bigvee \mathcal{F}}{\mathcal{F} \subseteq \Theta \text{ compatible}}
\end{equation*}
We have $\Ext{\Theta} \subseteq \PFun{\underline{\Inputs{\Theta}}}$.
The space $\Ext{\Theta}$ is equipped with the partial order inherited from $\PFun{\underline{\Inputs{\Theta}}}$.
\end{definition}

We observe that, given any subset $W \subseteq \PFun{\underline{I}}$, we can obtain a space of input histories by taking its $\vee$-prime elements:
\begin{equation*}
    \Prime{W}
    :=
    \suchthat{w \in W}{
    \forall \mathcal{F} \subseteq W \text{ compatible}.\,
    w = \bigvee\mathcal{F} \Rightarrow w \in \mathcal{F}
    }
\end{equation*}
Below is an example of a space of input histories $\Theta$ (on the left) together with its corresponding space of extended input histories $\Ext{\Theta}$ (on the right).
Input histories have been colour-coded by the events whose output they refer to (more on this later), in both diagrams: grey coloured extended input histories on the right are those which are not input histories (i.e. they arise by join).
This space is a variation on the total order $\total{\ev{A}, \ev{B}, \ev{C}}$, where input 0 at event $\ev{B}$ causally disconnects $\ev{B}$ from $\ev{A}$ and input 0 at event $\ev{C}$ causally disconnects $\ev{C}$ from $\ev{B}$ and $\ev{A}$.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/total-ABC-B0C0-hists-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/total-ABC-B0C0-ext-hists-highlighted_svg-tex.pdf}
    \\
    $\Theta$
    &
    $\Ext{\Theta}$
    \end{tabular}
\end{center}

In the introduction to this Section we stated that inputs at events are ``freely chosen'', i.e. without any local or global constraint.
By stitching together input histories, it must therefore be possible to obtain all possible combinations of joint input values over all events.

\begin{definition}
A space of input histories $\Theta$ is said to satisfy the \emph{free-choice condition} if:
\[
    \max\Ext{\Theta} = \prod_{\omega \in \Events{\Theta}} \Inputs{\Theta}_\omega
\]
In spaces satisfying the free-choice condition, we refer to the histories in $\prod_{\omega \in \Events{\Theta}} \Inputs{\Theta}_\omega$ as the \emph{maximal extended input histories}.
\end{definition}

Recall now that causal orders form a hierarchy (a lattice) when ordered by inclusion.
We would like this hierarchy to generalise from causal orders $\Omega$ to their spaces of input histories $\Hist{\Omega, \underline{I}}$, and then to all spaces of input histories, including ones that don't arise from orders.
Unfortunately, this is not as simple as ordering the spaces themselves by inclusion: $\Omega \leq \Xi$ does not in general imply an inclusion relationship between $\Hist{\Omega, \underline{I}}$ and $\Hist{\Xi, \underline{I}}$.
However, a suitable statement of inclusion holds for the corresponding spaces of extended input histories (cf. Proposition 3.8 p.28 \cite{gogioso2022combinatorics}):
\begin{equation*}
    \Omega \leq \Xi
    \;\;\Leftrightarrow\;\;
    \ExtHist{\Omega, \underline{I}} \supseteq \ExtHist{\Xi, \underline{I}}    
\end{equation*}

\begin{definition}
\label{definition:spaces-order}
We define the following partial order on spaces of input histories:
\begin{equation*}
    \Theta' \leq \Theta
    \stackrel{def}{\Leftrightarrow}
    \Ext{\Theta'} \supseteq \Ext{\Theta}
\end{equation*}
We say that $\Theta'$ is a \emph{causal refinement} of $\Theta$ (more causal constraints), or that $\Theta$ is a \emph{causal coarsening} of $\Theta'$ (fewer causal constraints).
Equivalently, sometimes we say that $\Theta'$ is a \emph{sub-space} of $\Theta$ or that $\Theta'$ is a \emph{super-space} of $\Theta$.
\end{definition}

Note that Definition \ref{definition:spaces-order} allows us to compare spaces of input histories with different underlying sets of events and inputs.
We refer to the partial order, or ``hierarchy'', of all spaces of input histories simply as $\AllSpaces$.
Spaces $\Theta$ with $\underline{\Inputs{\Theta}} = \underline{I}$ for a specific choice $\underline{I} = (I_\omega)_{\omega \in E}$ form a sub-hierarchy:
\[
    \Spaces{\underline{I}}
    \hookrightarrow
    \AllSpaces
\]
Spaces satisfying the free-choice condition form a further sub-hierarchy $\SpacesFC{\underline{I}}$:
\[
    \SpacesFC{\underline{I}}
    \hookrightarrow\Spaces{\underline{I}}
    \hookrightarrow \AllSpaces
\]
It is a fact (cf. Proposition 3.10 p.30 \cite{gogioso2022combinatorics}) the three ``hierarchies'' above are lattices, sharing the same notion of join and meet:
\begin{equation*}
\begin{array}{rcl}
    \Theta \vee \Theta' &=& \Prime{\Ext{\Theta} \cap \Ext{\Theta'}}\\
    \Theta \wedge \Theta' &=& \Prime{\Ext{\Theta} \cup \Ext{\Theta'}}
\end{array}
\end{equation*}
We refer to the join of two spaces as their \emph{closest common coarsening}, and to their meet as their \emph{closest common refinement}.

\begin{definition}
Let $\Theta, \Theta'$ be spaces of input histories with $\Events{\Theta} \cap \Events{\Theta'} = \emptyset$.
The \emph{parallel composition} of $\Theta$ and $\Theta'$ is defined to be their union as sets:
\begin{equation*}
    \Theta \cup \Theta'
\end{equation*}
The \emph{sequential composition} of $\Theta$ before $\Theta'$ is defined as follows:
\begin{equation*}
    \Theta \seqcomposeSym \Theta'
    :=
    \Theta \cup \left(\max{\Ext{\Theta}}\allJoinsSym\Theta'\right)
\end{equation*}
where we adopted the symbol $\allJoinsSym$ to indicate all possible compatible joins between two sets (or families) of partial functions:
\begin{equation*}
    \max{\Ext{\Theta}}\allJoinsSym\Theta'
    :=
    \suchthat{k\vee h'}{k \in \max{\Ext{\Theta}}, h' \in \Theta'}
\end{equation*}
Note: because $\Events{\Theta} \cap \Events{\Theta'} = \emptyset$, all joins above are necessarily compatible.
\end{definition}

As simple examples of sequential and parallel composition of spaces, we consider the spaces $\Theta$ and $\Theta'$ induced by the discrete order $\discrete{A,B}$ and total order $\total{C,D}$ respectively.
The two spaces are depicted below.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=2.5cm]{svg-inkscape/space-AB-0-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=2.5cm]{svg-inkscape/space-CD-5-highlighted_svg-tex.pdf}
    \\
    $\Theta$
    &
    $\Theta'$
    \end{tabular}
\end{center}
The parallel composition $\Theta \cup \Theta'$ of the two spaces is simply the disjoint union of their histories, with no additional causal relationship between them. 
\begin{center}
    \begin{tabular}{c}
    \includegraphics[height=2.5cm]{svg-inkscape/space-AB-0-parallel-space-CD-5_svg-tex.pdf}
    \\
    $\Theta \cup \Theta'$
    \end{tabular}
\end{center}
The sequential composition $\Theta \seqcomposeSym \Theta'$ of the two spaces consists of a copy of $\Theta'$ appearing after each maximal extended input history of $\Ext{\Theta}$, for a total of four copies.
\begin{center}
    \begin{tabular}{c}
    \includegraphics[height=5cm]{svg-inkscape/space-AB-0-sequential-space-CD-5_svg-tex.pdf}
    \\
    $\Theta \seqcomposeSym \Theta'$
    \end{tabular}
\end{center}

\begin{definition}
Let $\Theta$ be a space of input histories and let $\underline{\Theta'} := (\Theta'_k)_{k \in \max{\Ext{\Theta}}}$ be a family of spaces of input histories such that $\Events{\Theta} \cap \Events{\Theta'_k} = \emptyset$ for all $k \in \max{\Ext{\Theta}}$.
The \emph{conditional sequential composition} of $\Theta$ and $\underline{\Theta'}$ is defined as follows:
\begin{equation*}
    \Theta \seqcomposeSym \underline{\Theta'}
    :=
    \Theta \cup \suchthat{k\vee h'}{k \in \max{\Ext{\Theta}}, h' \in \Theta'_k}
\end{equation*}
Sequential composition $\Theta \seqcomposeSym \Theta'$ arises as the special case of conditional sequential composition where $\Theta'_k = \Theta'$ for all $k \in \max\Ext{\Theta}$.
\end{definition}

As a simple example of conditional sequential composition, we compose the space induced by the discrete order on one event $\ev{A}$ (having \hist{A/0} and \hist{A/1} as its maximal extended input histories) with the spaces induced by the two total orders on two events $\ev{B}$ and $\ev{C}$:
\begin{center}
    \begin{tabular}{ccc}
    \includegraphics[height=2.5cm]{svg-inkscape/space-A-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=2.5cm]{svg-inkscape/space-BC-5-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=2.5cm]{svg-inkscape/space-BC-6-highlighted_svg-tex.pdf}
    \\
    $\Theta$
    &
    $\Theta'_{\hist{A/0}}$
    &
    $\Theta'_{\hist{A/1}}$
    \end{tabular}
\end{center}
The result of this conditional sequential composition is a ``3-party causal switch'' space, in which event \ev{A} controls the order of events \ev{B} and \ev{C} with its input, e.g. by setting $\ev{B} < \ev{C}$ when the input is 0 and $\ev{C} < \ev{B}$ when the input is 1.
In such a setting, the output at \ev{B} is fully determined by the inputs at events \ev{A} and \ev{B} when the input at \ev{A} is 0, but the input at event \ev{C} is also needed---in the general case---when the input at \ev{A} is 1.
\begin{center}
    \begin{tabular}{c}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-101-highlighted_svg-tex.pdf}
    \\
    $\Theta \seqcomposeSym \underline{\Theta'}$
    \end{tabular}
\end{center}

\subsection{Causally Complete Spaces}
\label{subsection:spaces-cc}

In our operational interpretation, input histories are the data upon which the output values at individual events are allowed to depend.
When the causal order is given, it is always clear which histories refer to which outputs: the output at event $\omega$ is determined by the input histories $h$ with domain $\dom{h} = \downset{\omega}$.
In the more general setting of spaces of input histories, however, a causal order might not be given: in the absence of a $\downset{\omega}$, how do we associate events to the input histories that determine their outputs?
To get ourselves started, we consider the example of the causal diamond $\Omega$.
\begin{center}
    \includegraphics[height=2.5cm]{svg-inkscape/diamond-ABCD-highlighted_svg-tex.pdf}
\end{center}
Looking at the space of input histories $\Hist{\Omega,\{0,1\}}$---a shorthand by which we mean $\Hist{\Omega,(\{0,1\})_{\omega \in \Omega}}$---we observe that an association between input histories and events can be made from the order of histories alone.
Indeed, if $h$ is a history with $\dom{h} = \downset{\omega}$, then we can look at all input histories $k < h$ strictly below it and recover $\omega$ as the only event in $\dom{h}\backslash\bigcup_{k < h}\dom{k}$: this is the only event not covered by the domains of the histories strictly below $h$, which we will refer to as a ``tip event''.
In the Hasse diagram below, we have color-coded input histories according to the tip event associated to them by this procedure.
\begin{center}
    \includegraphics[height=4cm]{svg-inkscape/diamond-ABCD-hists-highlighted_svg-tex.pdf}
\end{center}
The procedure works well for definite causal orders, but something goes wrong for indefinite ones: if two or more events are in indefinite causal order, they will appear together at the tip of histories.
Indeed, consider the following indefinite version of the diamond order above: the space $\total{\ev{A}, \evset{B,C}, \ev{D}}$, where the events \ev{B} and \ev{C} are in indefinite causal order rather than causally unrelated.
\begin{center}
    \includegraphics[height=3cm]{svg-inkscape/total-AZBCZD-highlighted2_svg-tex.pdf}
\end{center}
Because \ev{B} and \ev{C} cannot be distinguished by input histories in the space, the histories in the middle layer now have two ``tip events'' instead of one.
\begin{center}
    \includegraphics[height=4cm]{svg-inkscape/total-AZBCZD-hists-highlighted2_svg-tex.pdf}
\end{center}

The operational interpretation of multiple tip events is challenging: in a naive sense, it means that the output value at two events in indefinite causal order is to be produced ``simultaneously'', using the input values at both events.
This is problematic, because indefinite causal order should not trivialise to causal collapse: under our operational interpretation, distinct events should retain their independent local nature.
It should not, for example, be possible to perform the ``swap'' function $(b, c) \mapsto (c, b)$ on two events \ev{B} and \ev{C} in indefinite causal order: the devices would have to wait for both inputs to be given before producing their outputs, with the effect of delocalising the events.

However, there is an alternative way to look at the presence of multiple tip events, as a form of ``causal incompleteness''.
Rather than interpreting such spaces as allowing event delocalisation, we think of such spaces as not providing sufficient information for causal inference to be performed.
As such, we will focus our efforts on ``causally complete'' spaces, studying the incomplete spaces through the lens of their ``causal completions''.

\begin{definition}
Let $\Theta$ be a space of input histories.
Given an extended input history $h \in \Ext{\Theta}$, we define the \emph{tip events} of $h$ in $\Theta$ as the events which are in the domain of $h$ but not in the domain of any history strictly below it:
\begin{equation*}
    \begin{array}{rcl}
    \tips{\Theta}{h}
    &:=&
    \dom{h}\backslash\bigcup_{k < h}\dom{k}
    \\
    &=&
    \suchthat{\omega \in \dom{h}}{\forall k < h.\, \omega \notin \dom{k}}
    \end{array}
\end{equation*}
\end{definition}

\begin{definition}
Let $\Theta$ be a space of input histories satisfying the free-choice condition.
We say that $\Theta$ is \emph{causally complete} if all input histories $h \in \Theta$ have exactly one tip event, and that it is \emph{causally incomplete} otherwise.
If $\Theta$ is causally complete and $h \in \Theta$, we define the \emph{tip event} of $h$ in $\Theta$ to be the unique event in $\tips{\Theta}{h}$:
\begin{equation*}
    \Theta \text{ causally complete }
    \Leftrightarrow
    \forall h \in \Theta.\,
    \tips{\Theta}{h} = \{\tip{\Theta}{h}\}
\end{equation*}
\end{definition}

It is a fact (cf. Proposition 3.21 p.35 \cite{gogioso2022combinatorics}) that a space of input histories induced by a causal order is causally complete if and only if the causal order is causally definite.

\begin{definition}
Let $\Theta$ be a space of input histories satisfying the free-choice condition.
The \emph{causal completions} of $\Theta$ are the closest refinements of $\Theta$ which are causally complete, i.e. the maxima of the set of causally complete spaces which are causal refinements of $\Theta$:
\begin{equation*}
    \CausCompl{\Theta}
    :=
    \max
    \suchthat{\Theta' \leq \Theta}{\Theta' \text{ causally complete}}
\end{equation*}
Since the discrete space $\Hist{\discrete{E^\Theta}, \underline{I}^\Theta}$ is always causally complete, the set of causal completions of $\Theta$ is never empty. If $\Theta$ is itself causally complete, then $\CausCompl{\Theta} = \{\Theta\}$.
\end{definition}

As an example of causal completion, we refer back to the indefinite causal order $\total{\ev{A}, \evset{B,C}}$.
The associated space of input histories is causally incomplete, because \ev{B} and \ev{C} always appear together as tip events (coloured aquamarine, at the top).
\begin{center}
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-hists-narrow_svg-tex.pdf}
\end{center}
There are four possible causal completions for this space.
Two of the causal completions are obtained by imposing a fixed order on events \ev{B} and \ev{C}: either \ev{B} causally precedes \ev{C} (left below) or \ev{B} causally succeeds \ev{C} (right below).
\begin{center}
\begin{tabular}{cc}
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-completion-0_svg-tex.pdf}
    &
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-completion-3_svg-tex.pdf}
\end{tabular}
\end{center}
The remaining two causal completions are obtained by imposing an order on events \ev{B} and \ev{C} that depends on the input at event \ev{A}: either \ev{B} causally precedes \ev{C} when the input at \ev{A} is 0 and causally succeeds \ev{C} when the input at \ev{A} is 1 (left below), or \ev{B} causally succeeds \ev{C} when the input at \ev{A} is 0 and causally precedes \ev{C} when the input at \ev{A} is 1 (right below). 
\begin{center}
\begin{tabular}{cc}
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-completion-1_svg-tex.pdf}
    &
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-completion-2_svg-tex.pdf}
\end{tabular}
\end{center}

It is a fact (cf. Theorem 3.26, Theorem 3.27 and Corollary 3.28 p.38 \cite{gogioso2022combinatorics}) that causal composition, sequential composition and conditional sequential composition respect causal completeness.
The parallel composition $\Theta \cup \Theta'$ of two spaces of input histories satisfying the free-choice condition has the following causal completions:
\begin{equation*}
    \CausCompl{\Theta \cup \Theta'}
    =
    \suchthat{\hat{\Theta} \cup \hat{\Theta}'\;\;}{
        \begin{array}{l}
        \hat{\Theta} \in \CausCompl{\Theta},\\
        \hat{\Theta}' \in \CausCompl{\Theta'}
        \end{array}
    }
\end{equation*}
The sequential composition $\Theta \seqcomposeSym \Theta'$ of two spaces of input histories satisfying the free-choice condition has the following causal completions:
\begin{equation*}
    \CausCompl{\Theta \seqcomposeSym \Theta'}
    =
    \suchthat{\hat{\Theta} \seqcomposeSym \hat{\Theta}'\;\;}{
        \begin{array}{l}
        \hat{\Theta} \in \CausCompl{\Theta},\\
        \hat{\Theta}' \in \CausCompl{\Theta'}
        \end{array}
    }
\end{equation*}
The conditional sequential composition $\Theta \seqcomposeSym \underline{\Theta'}$ where all spaces satisfy teh free-choice condition has the following causal completions, as long as the families of input sets $\underline{\Inputs{\Theta'_k}}$ are identical for all $k \in \max\Ext{\Theta}$:
\begin{equation*}
    \CausCompl{\Theta \seqcomposeSym \underline{\Theta'}}
    =
    \suchthat{\hat{\Theta} \seqcomposeSym \underline{\hat{\Theta}'}\;\;}{
        \begin{array}{l}
        \hat{\Theta} \in \CausCompl{\Theta},\\
        \forall k.\; \hat{\Theta}'_k \in \CausCompl{\Theta'_k}
        \end{array}
    }
\end{equation*}


\subsection{The Hierarchy of Causally Complete Spaces}
\label{subsection:spaces-hierarchy}

Causally complete spaces are the main focus of this work: for given inputs $\underline{\Inputs{\Theta}} = \underline{I}$, we denote them by $\CCSpaces{\underline{I}}$.
It is a fact that they are closed under meet but not generally under join (cf. Proposition 3.28 p.39 \cite{gogioso2022combinatorics}): we refer to the $\wedge$-semilattice $\CCSpaces{\underline{I}}$ as the \emph{hierarchy of causally complete spaces} for $\underline{I}$.

To gain some intuition about this hierarchy, we look at several examples from the hierarchy $\CCSpaces{\left(\{0,1\}\right)_{\omega \in \evset{A,B,C}}}$ on three events.
This hierarchy has 2644 spaces, forming 102 equivalence classes under event-input permutation symmetry (cf. pp.40-41 of \cite{gogioso2022combinatorics}).
Figure \ref{fig:hierarchy-spaces-ABC} (p.\pageref{fig:hierarchy-spaces-ABC}) depicts condensed hierarchy formed by the 102 equivalence classes: in this condensed graph, an edge $i \rightarrow j$ indicates that some space---and hence every space---in equivalence class $i$ is a closest refinement of some space of equivalence class $j$.

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{svg-inkscape/hierarchy-spaces-ABC_svg-tex.pdf}
    \caption{
    The hierarchy of causally complete spaces on 3 events with binary inputs, grouped into 102 equivalence classes under event-input permutation symmetry.
    An edge $i \rightarrow j$ indicates that some space---and hence every space---in equivalence class $i$ is a closest refinement for some space in equivalence class $j$.

    Node colour indicates the number of causal functions for a space which are not causal for any of its subspaces, while edge colour indicates the number of causal functions for the head space that are not causal for the tail space.
    Grey nodes (e.g. eq. class 1) indicate spaces where every causal function is also causal for some subspace, while thicker dark blue edges (e.g. edge $0 \rightarrow 1$) indicate that all causal functions for the head space are also causal a single tail space.

    Thin purple borders for nodes indicate eq. classes of non-tight spaces (e.g. eq. class 1).
    Thick black borders for nodes indicate the eq. classes of spaces induced by causal orders.
    }
\label{fig:hierarchy-spaces-ABC}
\end{figure}

At the bottom of the hierarchy we find the discrete space, induced by the discrete order $\discrete{\ev{A},\ev{B},\ev{C}}$, sitting alone in equivalence class 0.
This the \emph{no-signalling space}, where the output at each event depends only on the input at that event.
The corresponding space of extended input histories contains all 26 binary-valued partial functions on the 3 events: histories supported by more than one event are not $\vee$-prime in this space.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-0-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-0-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{0}$
    &
    $\Ext{\Theta_{0}}$
    \end{tabular}
\end{center}

At the top of the hierarchy we find two equivalence classes of spaces, labelled 100 and 101.
Equivalence class 100 contains the 6 spaces induced by total order: below is the space induced by $\total{\ev{A},\ev{B},\ev{C}}$.
This space coincides with its own space of extended input histories.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-100-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-100-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{100}$
    &
    $\Ext{\Theta_{100}}$
    \end{tabular}
\end{center}
Equivalence class 101 contains the 6 spaces for a 3-party causal switch: below is the space where the input of \ev{A} determines the total order between \ev{B} and \ev{C}, with input 0 at \ev{A} setting $\ev{B} < \ev{C}$ and input 1 at \ev{A} setting $\ev{C} < \ev{B}$.
This space coincides with its own space of extended input histories.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-101-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-101-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{101}$
    &
    $\Ext{\Theta_{101}}$
    \end{tabular}
\end{center}
The spaces in equivalence class 101 are examples of causally complete spaces not admitting a fixed definite causal order: they are not refinements of $\Hist{\Omega, \{0,1\}}$ for any definite causal order $\Omega$ on \ev{A}, \ev{B} and \ev{C}.
There are 13 equivalence classes consisting of spaces that don't admit a fixed definite causal order (cf. Figure 6 p.44 \cite{gogioso2022combinatorics}).

The 5 equivalence classes of spaces induced by total orders are marked by a thick black border in Figure \ref{fig:hierarchy-spaces-ABC} (p.\pageref{fig:hierarchy-spaces-ABC}).
We have already seen equivalence class 0 (for the discrete order) and equivalence class 100 (for total orders): we now look at the remaining three.
Equivalence class 92 contains the 3 spaces induced by wedge orders: below is the space induced by order $\total{\ev{A},\ev{C}}\vee\total{\ev{B},\ev{C}}$.
The extended input histories supported by $\evset{A,B}$ are not $\vee$-prime in this space.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-92-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-92-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{92}$
    &
    $\Ext{\Theta_{92}}$
    \end{tabular}
\end{center}
%
Equivalence class 77 contains the 3 spaces induced by fork orders: below is the space induced by order $\total{\ev{A},\ev{B}}\vee\total{\ev{A},\ev{C}}$.
The extended input histories supported by all three events are not $\vee$-prime in this space.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-77-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-77-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{77}$
    &
    $\Ext{\Theta_{77}}$
    \end{tabular}
\end{center}
%
Equivalence class 33 contains the 6 spaces induced by the disjoint join of a total order on two events with a discrete third event: below is the space induced by order $\total{\ev{A},\ev{B}}\vee\discrete{\ev{C}}$.
The extended input histories supported by either $\evset{A,C}$ or by all three events are not $\vee$-prime in this space.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-33-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-33-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{33}$
    &
    $\Ext{\Theta_{33}}$
    \end{tabular}
\end{center}

Spaces not induced by causal orders can all be understood as introducing input-dependent causal constraints.
As a simple example, consider space $\Theta_{98}$ below, a representative from equivalence class 98 which is a closest refinement of $\Hist{\total{\ev{A},\ev{B},\ev{C}}, \{0,1\}}$.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-98-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-98-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{98}$
    &
    $\Ext{\Theta_{98}}$
    \end{tabular}
\end{center}
The only history in space $\Theta_{98}$ above additional to  $\Hist{\total{\ev{A},\ev{B},\ev{C}}, \{0,1\}}$ is $\hist{B/1}$, imposing the following constraint: when the input at \ev{B} is 1, the output at \ev{B} is independent of the input at event \ev{A}.
However, we mentioned the additional causal constraints need not be truly input dependent, as witnessed by the meet of order-induced spaces for causal orders $\Omega = \total{\ev{A},\ev{B}}\vee\discrete{\ev{C}}$ and $\Omega' = \discrete{A}\vee\total{\ev{C},\ev{B}}$.
\begin{center}
    \begin{tabular}{ccc}
    \includegraphics[height=2.5cm]{svg-inkscape/space-ABC-unique-33-0-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=2.5cm]{svg-inkscape/space-ABC-unique-33-0-meet-3-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=2.5cm]{svg-inkscape/space-ABC-unique-33-3-highlighted_svg-tex.pdf}
    \\
    $\Theta_{33} = \Hist{\Omega,\{0,1\}}$
    &
    \hspace{2mm}
    $\Theta_3 = \Hist{\Omega',\{0,1\}}\wedge\Hist{\Omega',\{0,1\}}$
    \hspace{2mm}
    &
    $\Hist{\Omega',\{0,1\}}$
    \end{tabular}
\end{center}
Indeed, the spaces in equivalence class 3 are exactly the meets of 3 pairs of spaces from equivalence class 33 (the other 15 non-trivial meets of pairs in equivalence class 33 all yield the discrete space, in equivalence class 0).
For space $\Theta_{3}$, specifically, we get the following additional constraints:
\begin{itemize}
    \item as a coarsening of $\Hist{\total{\ev{A},\ev{B}}\vee\discrete{\ev{C}},\{0,1\}}$, the additional constraints come from the 4 histories with domain $\evset{B,C}$: they state that the outputs on \evset{B,C} are independent of the input on \ev{A} for all possible choices of inputs on $\evset{B,C}$.
    \item as a coarsening of $\Hist{\discrete{\ev{A}}\vee\total{\ev{C},\ev{B}},\{0,1\}}$, the additional constraints come from the 4 histories with domain $\evset{A,B}$: they state that the outputs on \evset{A,B} are independent of the input on \ev{C} for all possible choices of inputs on $\evset{A,B}$.
\end{itemize}
Because the additional constraints appear for all possible choices of inputs on their common support, they are not truly input-dependent in this case.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3cm]{svg-inkscape/space-ABC-unique-untight-3-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3cm]{svg-inkscape/space-ABC-unique-untight-3-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{3}$
    &
    $\Ext{\Theta_{3}}$
    \end{tabular}
\end{center}

The description of the constraints for space $\Theta_3$ is a bit confusing: one would certainly be forgiven for thinking that these constraints should be equivalent to the no-signalling ones, generated by the discrete space.
And, in a sense, they are: $\Theta_3$ has the same causal functions as the discrete space (cf. ``The Topology of Causality'' \cite{gogioso2022topology}) and the same causal distributions as the discrete space when non-locality is concerned (cf. ``The Geometry of Causality'' \cite{gogioso2022geometry}), but it admits strictly more causal distributions for more general notions of contextuality.

Space $\Theta_3$ is an example of a ``non-tight'' space, one where the events in some histories are constrained by multiple causal orders.
Lack of tightness is a peculiar pathology: in some cases, it implies a form of contextuality where deterministic functions defined compatibly on certain subsets of input histories cannot always be glued together into functions defined on all histories.

\begin{definition}
\label{definition:tight-space}
Let $\Theta$ be a space of input histories.
We say that $\Theta$ is \emph{tight} if for every (maximal) extended input history $k \in \Ext{\Theta}$ and every event $\omega \in \dom{k}$ there is a unique input history $h \in \Theta$ such that $h \leq k$ and $\omega \in \tips{\Theta}{h}$.
We say that $\Theta$ is \emph{non-tight} otherwise.
\end{definition}

Non-tight spaces are indicated in Figure \ref{fig:hierarchy-spaces-ABC} (p.\pageref{fig:hierarchy-spaces-ABC}) by a thin violet border, and they constitute the majority of examples: out of 102 equivalence classes, 58 consist of non-tight spaces and 44 consist of tight spaces.
To understand what lack of tightness means concretely, let's consider space $\Theta_{17}$ below.
In the input histories below extended input history $\hist{A/1,B/1,C/2}$ (circled in blue), the event $\ev{C}$ appears as a tip event in two separate histories, namely $\hist{A/1, C/1}$ and $\hist{B/1, C/1}$; edges from the latter input histories to the former extended input histories have also been highlighted blue, for clarity.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-untight-17-ext-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-untight-17-conflict-tips-highlighted_svg-tex.pdf}
    \\
    $\Ext{\Theta_{17}}$
    &
    $\Ext{\Theta_{17}}$ with highlights
    \end{tabular}
\end{center}
The effect of this multiple appearance of $\ev{C}$ as a tip event is that causal functions on space $\Theta_{17}$ must yield identical output values at event $\ev{C}$ for both input histories $\hist{A/1, C/1}$ and $\hist{B/1, C/1}$, which would have otherwise been unrelated.
Put in other words, in history $\hist{A/1,B/1,C/2}$ the output at event $\ev{C}$ must satisfy the constraints of two different causal orders: \total{\ev{A}, \ev{C}, \ev{B}} (from $\hist{A/1} \rightarrow \hist{A/1, C/1} \rightarrow \hist{A/1, B/1, C/1}$) and \total{\ev{B}, \ev{C}, \ev{A}} (from $\hist{B/1} \rightarrow \hist{B/1, C/1} \rightarrow \hist{A/1, B/1, C/1}$).

The hierarchy $\CSwitchSpaces{\underline{I}}$ of causally complete spaces is full of complicated examples.
Its ``canopy'', however, is significantly more tranquil: it is a fact (cf. Theorem 3.36 p.51 \cite{gogioso2022combinatorics}) that the maxima of $\CCSpaces{\underline{I}}$ are exactly the causal switch spaces $\CSwitchSpaces{\underline{I}}$ defined below.
This is what Figure \ref{fig:hierarchy-spaces-ABC} (p.\pageref{fig:hierarchy-spaces-ABC}) shows for the 3-event case and it is consistent with the approach taken by previous literature on indefinite causality.
It is furthermore a fact (cf. Theorem 3.34 and Corollary 3.35 p.51 \cite{gogioso2022combinatorics}) that causal switch spaces are exactly the causally complete spaces $\Theta$ such that $\Theta = \Ext{\Theta}$.

\begin{definition}
Let $E$ be a set of events and $\underline{I} = (I_\omega)_{\omega \in E}$ be a family of non-empty input sets.
The \emph{causal switch spaces} $\CSwitchSpaces{\underline{I}}$ are defined as follows.
If $E = \emptyset$, then $\CSwitchSpaces{\underline{I}} = \emptyset$.
Otherwise, for each $\omega_1 \in E$ we can consider:
\[
\begin{array}{rcl}
\restrict{\underline{I}}{\{\omega_1\}} &=& (I_\omega)_{\omega \in \{\omega_1\}}\\
\restrict{\underline{I}}{E\backslash\{\omega_1\}} &=& (I_\omega)_{\omega \in E\backslash\{\omega_1\}}
\end{array}
\]
Then the set $\CSwitchSpaces{\underline{I}}$ is defined inductively as follows:
\begin{equation*}
    \bigcup\limits_{\omega_1 \in E}
    \suchthat{
    \Hist{\{\omega_1\}, \restrict{\underline{I}}{\{\omega_1\}}}
    \seqcomposeSym
    \underline{\Theta}
    }
    {
    \underline{\Theta}
    \in
    \CSwitchSpaces{\restrict{\underline{I}}{E\backslash\{\omega_1\}}}^{I_{\omega_1}}
    }    
\end{equation*}
\end{definition}


% === COMMENT BELOW BEFORE COMPILING MAIN FILE ===

\newpage


% % == Dummy Sections ==


% \section{The Topology of Causality}
% \label{section:topology-causality}

% % == Dummy Biblio ==

% \bibliographystyle{unsrt}
% \bibliography{biblio}
% % \nocite{*}

% \end{document}
