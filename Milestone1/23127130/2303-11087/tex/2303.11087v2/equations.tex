

\section{Thermal Runaway in Li-Ion Batteries}
\label{sec:govern-eqs}

\begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{figures/Homogenization_Hybrid_Illustration.pdf}
    \caption{{Illustration of (a) a fine-scale battery pack domain, (b) homogeization of the fine-scale battery pack domain into two upscaled packing material and battery cell domains, and (c) a hybrid domain consists of both fine-scale and homogenized domains.}}
    \label{fig:homogenization-illu}
\end{figure}

The onset of thermal runaway in a cell due to mechanical, thermal, and electric abuse can compromise the entire battery pack and lead to an explosion \cite{Feng2018-ix}. Understanding heat transfer in these systems at the relevant scales is critical to optimize design and operation. Nevertheless, the development of accurate heat transfer models in battery systems, ranging from the sub-electrode to the battery pack scale, represents a formidable multiscale task because of the complex interactions between the processes at each scale, such as heat generation at the electrode scale and thermal runaway at the packing/module scale. 

One common approach to modeling thermal runaway in battery cells is to develop spatially independent models with experimentally determined and calibrated parameters \cite{Ren2018-zj}. However, such parameters, calibrated on the basis of lab-scale systems, can have significant uncertainties and tend to vary from system to system. Therefore, the applicability of these models to large-scale systems is questionable. 

The alternative is to perform fine-scale simulations that resolve the governing partial differential equations in a defined computational domain \cite{Kong2021-sb, Guo2019-td}. With appropriate mesh resolution and computational methods, heat transfer in the battery pack can be accurately simulated. However, these high-fidelity simulations generally require significant computational costs \cite{Yousefzadeh2023-rg}, and are unlikely to be used as predictive tools for large battery packs that contain thousands of cells.

Another approach is to develop upscaled models from fine-scale equations based on homogenization/coarse-graining theory. Recently, Pietrzyk \emph{et al.} \cite{Pietrzyk2023-ou} have generated upscaled equations using the automated upscaling engine, \symbolica, to model heat transfer in battery packs. Yet, when certain applicability conditions are invalidated due to, e.g., manufacturing defects and cell aging, the prediction from upscaled models can deviate significantly from the average fine-scale behavior. In the following, we develop a hybrid formulation that couples fine-scale equations with upscaled equations when applicatibility conditions of the latter are violated within a small portion of the computational domain. In Section~\ref{sec:sub-govens}, we present the governing equations at the fine- and continuum-scales for the thermal runaway problem. 


\subsection{Problem description and governing equations}
\label{sec:sub-govens}
We consider heat transfer within a two-dimensional battery pack $\hat{\Omega}_\epsilon \subset \mathbb{R}^2$ (Figure~\ref{fig:domain_eg}) that is bounded by packing edges $\hat{\Gamma}_{\epsilon} \subset \mathbb{R}^2$. The edges of the pack include the top, bottom, left, and right and are referred to as $\hat{\Gamma}_{\epsilon}^{\left(T\right)} \subset \hat{\Gamma}_{\epsilon}$, $\hat{\Gamma}_{\epsilon}^{\left(B\right)} \subset \hat{\Gamma}_{\epsilon}$, $\hat{\Gamma}_{\epsilon}^{\left(L\right)} \subset \hat{\Gamma}_{\epsilon}$ and $\hat{\Gamma}_{\epsilon}^{\left(R\right)} \subset \hat{\Gamma}_{\epsilon}$, respectively. The battery pack consists of three distinct domains: battery cells $\hat{\mathcal{B}}_{\epsilon}^{\left(c\right)} \subset \hat{\Omega}_{\epsilon}$, packing material $\hat{\mathcal{B}}_{\epsilon}^{\left(p\right)} \subset \hat{\Omega}_{\epsilon}$ and cooling water pipes $\hat{\mathcal{B}}_{\epsilon}^{\left(w\right)} \subset \hat{\Omega}_{\epsilon}$ (Figure~\ref{fig:domain_eg}); $\hat{\Gamma}_\epsilon^{\left(pc\right)}$ denotes the interface between packing material and battery cell, while $\hat{\Gamma}_\epsilon^{\left(pw\right)}$ denotes the interface between packing material and cooling water pipes. Both packing materials and cooling water pipes are used as heat sinks to absorb the heat generated by the battery cells. Following the notation of Pietrzyk et al.~\cite{Pietrzyk2023-ou}, we use the ``hat'' and subscript $\epsilon$ to denote dimensional and fine-scale quantities, respectively. The governing equations of heat transfer in the packing material and battery cells are modeled as 
\begin{subequations}
\label{eq:Heat_Transfer_Eq}
\begin{align}
&\derive{\left(\hat{\rho}^{\left(p\right)}\hat{C}^{\left(p\right)}\hat{T}_{\epsilon}^{\left(p\right)}\right)}{\hat{t}} = \hat{\nabla}\bm{\cdot}\left(\hat{k}^{\left(p\right)}\hat{\nabla}\hat{T}_{\epsilon}^{\left(p\right)}\right) \quad \text{for } \hat{\mathbf{x}} \in \hat{\mathcal{B}}_{\epsilon}^{\left(p\right)}, \label{eq:Heat_Transfer_Eq_Packing} \\
% &\derive{\left(\hat{\rho}^{\left(c\right)}\hat{C}^{\left(c\right)}\hat{T}_{\epsilon}^{\left(c\right)}\right)}{\hat{t}} = \hat{\nabla}\bm{\cdot}\left(\hat{k}^{\left(c\right)}\hat{\nabla}\hat{T}_{\epsilon}^{\left(c\right)}\right) + \hat{\Pi}\left(\hat{t}, \hat{\mathbf{x}}\right) \quad \text{for } \hat{\mathbf{x}} \in \hat{\mathcal{B}}_{\epsilon}^{\left(c\right)}, 
&\derive{\left(\hat{\rho}^{\left(c\right)}\hat{C}^{\left(c\right)}\hat{T}_{\epsilon}^{\left(c\right)}\right)}{\hat{t}} = \hat{\nabla}\bm{\cdot}\left(\hat{k}^{\left(c\right)}\hat{\nabla}\hat{T}_{\epsilon}^{\left(c\right)}\right) + {\hat{\Pi}} \quad \text{for } \hat{\mathbf{x}} \in \hat{\mathcal{B}}_{\epsilon}^{\left(c\right)}, \label{eq:Heat_Transfer_Eq_Cell} 
\end{align}


\noindent respectively, subject to boundary conditions
\begin{align}
 &-\n_{\epsilon}^{\left(p\right)} \bm{\cdot} \hat{k}^{\left(p\right)}\hat{\nabla}\hat{T}_{\epsilon}^{\left(p\right)} = \hat{U}^{\left(pc\right)}\left(\hat{T}_{\epsilon}^{\left(p\right)} - \hat{T}_{\epsilon}^{\left(c\right)}\right) \quad \text{for } \hat{\mathbf{x}} \in \hat{\Gamma}_{\epsilon}^{\left(pc\right)}, \label{eq:BC_pc_packing}\\
% &-\n_{\epsilon}^{\left(p\right)} \bm{\cdot} \hat{k}^{\left(p\right)}\hat{\nabla}\hat{T}_{\epsilon}^{\left(p\right)} = \hat{q}_{\epsilon}^{\left(pw\right)}\left(\hat{t}, \hat{\mathbf{x}}\right) \quad \text{for } \hat{\mathbf{x}} \in \hat{\Gamma}_{\epsilon}^{\left(pw\right)}, \label{eq:BC_pw}\\
&-\n_{\epsilon}^{\left(p\right)} \bm{\cdot} \hat{k}^{\left(p\right)}\hat{\nabla}\hat{T}_{\epsilon}^{\left(p\right)} = {\hat{q}_{\epsilon}^{\left(pw\right)}} \quad \text{for } \hat{\mathbf{x}} \in \hat{\Gamma}_{\epsilon}^{\left(pw\right)}, \label{eq:BC_pw}\\
&-\n_{\epsilon}^{\left(c\right)} \bm{\cdot} \hat{k}^{\left(c\right)}\hat{\nabla}\hat{T}_{\epsilon}^{\left(c\right)} = \hat{U}^{\left(pc\right)}\left(\hat{T}_{\epsilon}^{\left(c\right)} - \hat{T}_{\epsilon}^{\left(p\right)}\right) \quad \text{for } \hat{\mathbf{x}} \in \hat{\Gamma}_{\epsilon}^{\left(pc\right)}, \label{eq:BC_pc_cell}  
\end{align}
\end{subequations}
\noindent where $i=p$ or $c$ refers to packing material or the battery cell, respectively,  $\hat{\rho}^{\left(i\right)}$ [\si{ML\tothe{-3}}] is the density, $\hat{C}^{\left(i\right)}$ [\si{L\tothe{2}T\tothe{-2}\Theta\tothe{-1}}] is the heat capacity, {$\hat{T}_{\epsilon}^{\left(i\right)}  \equiv \hat{T}_{\epsilon}^{\left(i\right)}\left(\hat{t}, \hat{\mathbf{x}}\right) [\si{\Theta}]$}  is the temperature at time $\hat{t} > 0$ and location $\hat{\mathbf{x}} \in \hat{\mathcal{B}}_{\epsilon}^{\left(i\right)}$, $\hat{k}^{\left(i\right)}$ [\si{MLT\tothe{-3}\Theta\tothe{-1}}] is the thermal conductivity, $\n_{\epsilon}^{\left(i\right)} \equiv \n_{\epsilon}^{\left(i\right)}\left(\hat{\mathbf{x}}\right)$ is the normal vector to the interfaces pointing away from the domain, $\hat{U}^{\left(pc\right)}$ [\si{MT\tothe{-3}\Theta\tothe{-1}}] is the total heat transfer coefficient between the packing material and battery cells,  $\hat{q}_{\epsilon}^{\left(pw\right)}\left(\hat{t}, \hat{\mathbf{x}}\right)$ [\si{MT\tothe{-3}}]  is a power flux between the packing material and the cooling water pipes, and $\hat{\Pi}(\hat{t}, \hat{\mathbf{x}})$ [\si{ML\tothe{-1}T\tothe{-3}}] is a power flux source term. {Equation~\eqref{eq:Heat_Transfer_Eq} still holds with temperature-dependent material properties. For this study, we assume that the material properties are constant.}

\begin{figure}
\centerline{
 {\includegraphics[width=0.6\textwidth]{figures/Domain.pdf}}}
\caption{Example of a fine-scale two-dimensional battery pack.}
\label{fig:domain_eg}
\end{figure}

To model the battery cell heat generation, the power flux source term $\hat{\Pi}(\hat{t}, \hat{\mathbf{x}})$ is approximated using polynomial of $\hat{T}_{\epsilon}^{\left(c\right)}${~\cite{Pietrzyk2023-ou} where}
\begin{subequations}\label{PI}
\begin{align}
    & {\hat{\Pi}\left(\hat{t}, \hat{\x}\right) \equiv \hat{\Pi}\left(\hat{T}_{\epsilon}^{\left(c\right)}, \hat{\x}\right) \equiv \sum_{k = 0}^{\infty} \hat{a}_k\left(\hat{\x}\right) \left(\hat{T}_{\epsilon}^{\left(c\right)}\right)^k,}
\end{align}
such that 
\begin{align}
\hat{\Pi}\left(\hat{T}_{\epsilon}^{\left(c\right)}, \hat{\mathbf{x}}\right) &= \hat{\Pi}_{\text{base}}\left(\hat{\mathbf{x}}\right) + \frac{1}{2}\left\{\text{Erf}\left[C_1\left(2\frac{\hat{T}_a - \hat{T}_{\epsilon}^{\left(c\right)} + \hat{T}_{ref}}{\hat{T}_{s1}} + 1\right)\right] + 1\right\}\left(\hat{\Pi}_{\text{burn}} - \hat{\Pi}_{\text{base}}\left(\hat{\mathbf{x}}\right)\right) \nonumber \\   
&- \frac{1}{2}\left\{\text{Erf}\left[C_2\left(2\frac{\hat{T}_{max} - \hat{T}_{\epsilon}^{\left(c\right)} + \hat{T}_{ref}}{\hat{T}_{s2}} - 1\right)\right] + 1\right\}\hat{\Pi}_{\text{burn}}, \label{eq:new_pi_term1}
\end{align}
\noindent and
\begin{align}
&\hat{T}_{max} = \hat{T}_{Max} - \hat{T}_{ref}, \label{eq:new_pi_term2}\\ 
&\hat{T}_{Max} = \hat{T}_{ref} + \hat{T}_{a} + \hat{T}_{s1} + \hat{T}_{b} + \hat{T}_{s2}, \label{eq:new_pi_term2_1}\\
&{C_1 = \text{Erf}^{-1}\left(2\epsilon_{s1} - 1\right),} \label{eq:new_pi_term3}\\
&{C_2 = \text{Erf}^{-1}\left(2\epsilon_{s2} - 1\right)}. \label{eq:new_pi_term3_2}  
\end{align}
\end{subequations}
\noindent {In Eq.~\eqref{PI}, $\hat{a}_k(\hat{\x})$ are the coefficients of the polynomial}, $\hat{\Pi}_{\text{base}}(\hat{\mathbf{x}})$ and $\hat{\Pi}_{\text{burn}}$ are the \textit{base} and \textit{burn} power flux values, respectively, $\hat{T}_{ref}$~[\si{\Theta}] is the reference temperature, $\hat{T}_a$~[\si{\Theta}] and $\hat{T}_b$~[\si{\Theta}] are temperature ranges {over which} $\hat{\Pi}(\hat{T}_{\epsilon}^{\left(c\right)},\hat{\mathbf{x}}) = \hat{\Pi}_{\text{base}}(\hat{\mathbf{x}})$ and $\hat{\Pi}(\hat{T}_{\epsilon}^{\left(c\right)}, \hat{\mathbf{x}}) = \hat{\Pi}_{\text{burn}}$, respectively, $\hat{T}_{s1}$ and $\hat{T}_{s2}$ are the temperature ranges for which $\hat{\Pi}(\hat{T}_{\epsilon}^{\left(c\right)}, \hat{\mathbf{x}})$ transitions from $\hat{\Pi}_{\text{base}}(\hat{\mathbf{x}})$ to $\hat{\Pi}_{\text{burn}}$ and from $\hat{\Pi}_{\text{burn}}$ to $0$, respectively, and {$\epsilon_{s1} = 0.0005$ and $\epsilon_{s2} = 0.0005$ are dimensionless parameters associated with} smoothness of the error functions. {A plot for $\hat \Pi$ can be found in Figure 2 of Pietrzyk et al.~\cite{Pietrzyk2023-ou}. Additionally,} the detailed formulation and validation of the source term can be found in Pietrzyk et al.~\cite{Pietrzyk2023-ou}.


\subsection{Dimensionless fine-scale governing equations}

{In order to apply homogenization theory, we followed the nondimensionalization procedures in Pietrzyk et al.~\cite{Pietrzyk2023-ou} to derive a set of dimensionless numbers that provides insight into the physical mechanisms within a system. We define the reference scales as} 

%\textcolor{red}{[It should be $\hat{\mathbf{x}} = \hat{\mathcal{L}}\mathbf{x}$. Also the comma was left in the fraction]}

\begin{gather}
\hat{T}_{\epsilon}^{\left(p\right)} = \hat{T}_{max}T_{\epsilon}^{\left(p\right)} + \hat{T}_{ref}, \quad \hat{T}_{\epsilon}^{\left(c\right)} = \hat{T}_{max}T_{\epsilon}^{\left(c\right)} + \hat{T}_{ref}, \quad \hat{k}^{\left(p\right)} = \hat{\mathcal{K}}^{\left(p\right)} k^{\left(p\right)}, \nonumber \\ 
\hat{k}^{\left(c\right)} = \hat{\mathcal{K}}^{\left(c\right)} k^{\left(c\right)}, \quad \hat{\nabla} = \frac{1}{\hat{\mathcal{L}}} \nabla, \quad \hat{t} = \frac{\hat{\rho}^{\left(p\right)}\hat{C}^{\left(p\right)}\hat{\mathcal{L}}^2}{\hat{\mathcal{K}}^{\left(p\right)}} t, \quad {\hat{\mathbf{x}} = \hat{\mathcal{L}}\mathbf{x}},  \nonumber \\ \hat{\Pi}\left(\hat{T}_{\epsilon}^{\left(c\right)}, \hat{\mathbf{x}}\right) = \hat{\Pi}_{\text{burn}} \Pi\left(T_{\epsilon}^{\left(c\right)}, \mathbf{x}\right), \quad \hat{q}_{\epsilon}^{\left(pw\right)}\left(\hat{t}, \hat{\mathbf{x}}\right) = \hat{Q}^{\left(pw\right)} q_{\epsilon}^{\left(pw\right)}\left(t, \mathbf{x}\right), \label{eq:Scales}
\end{gather}
\noindent where {$\hat{\mathcal{L}}$ is the size of the macroscopic domain,} $\hat{\mathcal{K}}^{\left(i\right)}$ is the reference scale of the thermal conductivity, and $\hat{Q}^{\left(pw\right)}$ is the reference scale of the power flux sink term at $\hat{\Gamma}_{\epsilon}^{\left(pw\right)}$. By scaling the equations with the reference scales, the nondimensional fine-scale governing equations are obtained as 
\begin{subequations}
\begin{align}
&\derive{T_{\epsilon}^{\left(p\right)}}{t} = \nabla \bm{\cdot} \left(k^{\left(p\right)} \nabla T_{\epsilon}^{\left(p\right)}\right) \quad \text{for } \mathbf{x} \in \mathcal{B}_{\epsilon}^{\left(p\right)}, \label{eq:Heat_Transfer_Eq_Packing_dimless} \\
&\derive{T_{\epsilon}^{\left(c\right)}}{t} = \left(\varrho \bm{\cdot} \varsigma\right) \nabla \bm{\cdot} \left(k^{\left(c\right)} \nabla T_{\epsilon}^{\left(c\right)}\right) + \left(\varrho \bm{\cdot} \mathcal{R}\right) {\Pi} \quad \text{for } \mathbf{x} \in \mathcal{B}_{\epsilon}^{\left(c\right)}, \label{eq:Heat_Transfer_Eq_Cell_dimless}
\end{align}
\label{eq:pore_goven_eqs}
\noindent subject to boundary conditions 
\begin{align}
&-\n_{\epsilon}^{\left(p\right)} \bm{\cdot} k^{\left(p\right)} \nabla T_{\epsilon}^{\left(p\right)} = \text{Bi}^{\left(p\right)}\left(T_{\epsilon}^{\left(p\right)} - T_{\epsilon}^{\left(c\right)}\right) \quad \text{for } \mathbf{x} \in \Gamma_{\epsilon}^{\left(pc\right)}, \label{eq:BC_pc_packing_dimless} \\
&-\n_{\epsilon}^{\left(p\right)} \bm{\cdot} k^{\left(p\right)}\nabla T_{\epsilon}^{\left(p\right)} = \mathcal{Q} \bm{\cdot} {q_{\epsilon}^{\left(pw\right)}} \quad \text{for } \mathbf{x} \in \Gamma_{\epsilon}^{\left(pw\right)}, \label{eq:BC_pw_dimless} \\
&-\n_{\epsilon}^{\left(c\right)} \bm{\cdot} k^{\left(c\right)} \nabla T_{\epsilon}^{\left(c\right)} = \text{Bi}^{\left(c\right)}\left(T_{\epsilon}^{\left(c\right)} - T_{\epsilon}^{\left(p\right)}\right) \quad \text{for } \mathbf{x} \in \Gamma_{\epsilon}^{\left(pc\right)}. \label{eq:BC_pc_cell_dimless} 
\end{align}
\end{subequations}
The dimensionless power flux source term is defined as 
\begin{subequations}
\begin{align}
\Pi\left(T_{\epsilon}^{\left(c\right)}, \mathbf{x}\right) &= \Pi_{\text{base}}\left(\mathbf{x}\right) + \frac{1}{2}\left\{\text{Erf}\left[A_1 T_{\epsilon}^{\left(c\right)} + B_1\right] + 1\right\}\left(1 - \Pi_{\text{base}}\left(\mathbf{x}\right)\right) \nonumber \\ 
& - \frac{1}{2}\left\{\text{Erf}\left[A_2 T_{\epsilon}^{\left(c\right)} + B_2\right] + 1\right\},\label{eq:new_pi_term_dimless}
\end{align}

\noindent where

\neweq{new_pi_term_dimless_coefs}{A_1 = -2C_1\frac{\hat{T}_{max}}{\hat{T}_{s1}}, \quad B_1 = 2C_1\frac{\hat{T}_{a}}{\hat{T}_{s1}} + C_1, \quad A_2 = -2C_2\frac{\hat{T}_{max}}{\hat{T}_{s2}}, \quad B_2 = 2C_2\frac{\hat{T}_{max}}{\hat{T}_{s2}} - C_2.}
\end{subequations}

\noindent Scaling the governing equations results in six dimensionless numbers $\text{Bi}^{\left(p\right)}$, $\mathcal{Q}$, $\varrho$, $\varsigma$, $\text{Bi}^{\left(c\right)}$, and $\mathcal{R}$ such that

\neweqgat{eq:dimless_groups}{\text{Bi}^{\left(p\right)} = \frac{\hat{U}^{\left(pc\right)}\hat{\mathcal{L}}}{\hat{\mathcal{K}}^{\left(p\right)}}, \quad \mathcal{Q} = \frac{\hat{Q}^{\left(pw\right)}\hat{\mathcal{L}}}{\hat{T}_{max}\hat{\mathcal{K}}^{\left(p\right)}}, \quad \varrho = \frac{\hat{\rho}^{\left(p\right)}\hat{C}^{\left(p\right)}}{\hat{\rho}^{\left(c\right)}\hat{C}^{\left(c\right)}}, \\
\varsigma = \frac{\hat{\mathcal{K}}^{\left(c\right)}}{\hat{\mathcal{K}}^{\left(p\right)}},  \quad \text{Bi}^{\left(c\right)} = \frac{\text{Bi}^{\left(p\right)}}{\varsigma}, \quad \mathcal{R} = \frac{\hat{\Pi}_{\text{burn}}\hat{\mathcal{L}}^2}{\hat{T}_{max}\hat{\mathcal{K}}^{\left(p\right)}}.}

\subsection{Unit-cell and domain formulation}
In each battery pack, the battery cells can be divided into $n$ regions such that $\mathcal{B}_\epsilon^{\left(c,n\right)} \subseteq \mathcal{B}_\epsilon^{\left(c\right)}$ $n \in \mathbb{Z}^{+}$, $n \leq N^{\left(c\right)}$, and $N^{\left(c\right)}$ is the number of battery cells in the battery pack. The geometry of the two-dimensional battery pack is defined by the unit cell, the number of unit cells in the $x$ and $y$ directions $N^{\left(c\right)}_{x}$ and $N^{\left(c\right)}_{y}$, respectively. The unit cell geometry (Figure~\ref{fig:unit-cell-geom}) is then defined by the distance between the battery cell and the boundary of the unit cell $\hat{d}_\epsilon^{\left(cc\right)}$, the radius of the battery cell $\hat{r}_\epsilon^{\left(c\right)}$, the radius of the cooling water pipe $\hat{r}_\epsilon^{\left(w\right)}$ and the distances between the battery cell and the cooling pipe $\hat{d}_\epsilon^{\left(1\right)}$ and $\hat{d}_\epsilon^{\left(2\right)}$. The length of the unit cell is computed as 
\begin{align}
\hat{\ell} &= 2\left( \hat{d}_\epsilon^{\left(1\right)} + \hat{d}_\epsilon^{\left(2\right)} + \hat{r}_\epsilon^{\left(c\right)} + \hat{r}_\epsilon^{\left(w\right)} \right),
\end{align}
the aspect ratio of the unit cell $a$ is defined as 
\begin{align}
a &= \ddfrac{2\left(\hat{d}_\epsilon^{\left(cc\right)} + \hat{r}_\epsilon^{\left(c\right)}\right)}{\hat{\ell}}.
\end{align}
With the defined unit cell geometry, {the length $\hat{\mathcal{L}}_{x}$ and the width $\hat{\mathcal{L}}_{y}$ of the battery pack are defined as} 
\begin{align}
\hat{\mathcal{L}}_{x} &= N_{x}^{\left(c\right)}\hat{\ell},\\
\hat{\mathcal{L}}_{y} &= N_{y}^{\left(c\right)}\hat{\ell}a.
\end{align}
{The main objective of this study is to demonstrate the capability and accuracy of the approach. As a result, the arrangement of cooling pipes and battery cells may not be realisitc since their location is not optimized.}
\begin{figure}
\centerline{
 {\includegraphics[width=.5\linewidth]{figures/unit-cell-geom.pdf}}}
\caption{Unit cell geometry with defined dimensional parameters {in the $x$ and $y$ directions.}}
\label{fig:unit-cell-geom}
\end{figure}

% The nondimensional fine-scale governing equations are defined as 
% \begin{subequations}
% \label{eq:pore_goven_eqs}
% \begin{align}
% &\pdv{T_\epsilon^{\left(p\right)}}{t_\epsilon} - k^{\left(p\right)}\grad_\epsilon \bm{\cdot} \grad{T_\epsilon^{\left(p\right)}} = 0, \\
% &\pdv{T_\epsilon^{c}}{t_\epsilon} - k^{c}\left(\varrho \bm{\cdot} \varsigma\right)\grad_\epsilon \bm{\cdot} \grad{T_\epsilon^{c}} - \left(\varrho \bm{\cdot} \mathcal{R}\right)\Pi\left(t_\epsilon, \mathbf{x}_\epsilon\right) = 0,
% \end{align}
% \end{subequations}
% where the subscript $\epsilon$ indicates the fine-scale quantities, the superscript $i=p$ or $c$ refers to the packing and cell quantities, respectively, $T_\epsilon^{i}$ is the dimensionless temperature, $k^{i}$ is the dimensionless thermal conductivity, and $\Pi\left(t_\epsilon, \mathbf{x}_\epsilon\right)$ is a dimensionless source term representing the heat energy generated by battery cells such that
% \begin{align}
% \Pi\left(t_\epsilon, \mathbf{x}_\epsilon\right) = \ddfrac{1}{2} \Bigg\{  &\text{Erf}\left[  C_1\left(2 \ddfrac{\hat{T}_{d}}{\hat{T}_{s1}} + 1 \right)\right]  - \left. \text{Erf}\left[ C_2\left(2 \ddfrac{\hat{T}_{d}}{\hat{T}_{s2}} + 1 \right)\right] \right\} \left(1 - \ddfrac{\hat{\Pi}_{\text{base}}}{\hat{\Pi}_{\text{burn}}} \right) + \Pi_1,
% \end{align}
% where 
% \begin{subequations}
% \begin{align}
% & \hat{T}_{d} = \hat{T}_a - T_{\epsilon}^{c}\hat{T}_{\max} \\
% &\hat{T}_{\max} = \hat{T}_a + \hat{T}_{s1} + \hat{T}_{b} + \hat{T}_{s2}, \\
% &C_1 = \text{Erf}\left(2\epsilon_{s1} -1\right), \\
% &C_2 = \text{Erf}\left(2\epsilon_{s2} -1\right), \\
% &\Pi_1 = 
% \begin{cases}
% \hat{\Pi}_{\text{base}}/\hat{\Pi}_{\text{burn}}, \text{ for unburned battery cells}, \\
% \hat{\Pi}_{\text{burn}}/\hat{\Pi}_{\text{burn}}, \text{ for burned battery cells},
% \end{cases}
% \end{align}
% \end{subequations}
% $\hat{T}_{a}$ and $\hat{T}_{b}$ are the dimensional limit temperatures, $\hat{\Pi}_{\text{base}}$ and $\hat{\Pi}_{\text{burn}}$ are the dimensional source terms that represent the heat energy generated by the unburned and burned battery cells and $\epsilon_{s1}$ and $\epsilon_{s2}$ are constants associated with the error functions. The formulation of the source term $\Pi\left(t_\epsilon, \mathbf{x}_\epsilon\right)$ has been validated by Pietrzyk et al. (2022), demonstrating its ability to capture thermal runaway in experimental battery packs. $\varrho$, $\varsigma$ and $\mathcal{R}$ are derived dimensionless numbers such that 
% \begin{equation}
% \label{eq:dimless-group1}
% \varrho = \ddfrac{\hat{\rho}^{p}\hat{C}^{p}}{\hat{\rho}^{c}\hat{C}^{c}}, 
% \qquad
% \varsigma = \ddfrac{\hat{\mathcal{K}}^{c}}{\hat{\mathcal{K}}^{p}}, 
% \qquad
% \mathcal{R} = \ddfrac{\hat{\Pi}_{\text{burn}}\hat{\mathcal{L}}^2}{\left(\hat{T}_{b} - \hat{T}_{\infty} \right) \hat{\mathcal{K}}^{p}},
% \end{equation}
% where $\hat{\rho}^{i}$ is density, $\hat{C}^{i}$ is heat capacity, $\hat{T}_\infty$ is a defined temperature at the edges of the battery pack $\hat{\Gamma}_\epsilon$, $\hat{\mathcal{L}} = \max(\hat{\mathcal{L}}_x, \hat{\mathcal{L}}_y)$ is the maximum length of the battery pack, and $\hat{\mathcal{K}}^{i}$ is thermal conductivity. The corresponding boundary conditions for the fine-scale equations are derived as 
% \begin{subequations}
% \label{eq:pore-bc}
% \begin{align}
% &-k^{\left(p\right)}\left(\mathbf{n}_\epsilon^{p} \bm{\cdot} \grad_\epsilon{T_\epsilon^{\left(p\right)}} \right) = -\text{Bi}^{\left(p\right)} \bm{\cdot} \left(T_\epsilon^{c} - T_\epsilon^{\left(p\right)}\right), \\
% &-k^{c}\left(\mathbf{n}_\epsilon^{c} \bm{\cdot} \grad_\epsilon{T_\epsilon^{c}} \right) = \text{Bi}^{\left(c\right)} \bm{\cdot} \left(T_\epsilon^{c} - T_\epsilon^{\left(p\right)}\right),\\
% &-k^{\left(p\right)}\left(\mathbf{n}_\epsilon^{p} \bm{\cdot} \grad_\epsilon{T_\epsilon^{\left(p\right)}} \right) = \mathcal{Q} \bm{\cdot} q_\epsilon^{pw}\left(t_\epsilon, \mathbf{x}_\epsilon \right),
% \end{align}
% \end{subequations}
% where $q_\epsilon^{pw}$ is the dimensionless power flux between the packing materials and the cooling water pipes, $\mathbf{n}_\epsilon^{p}$ and $\mathbf{n}_\epsilon^{c}$ are the normal vectors pointing outward to the packing and cell domains, respectively. $\text{Bi}^{\left(p\right)}$, $\text{Bi}^{\left(c\right)}$ and $\mathcal{Q}$ are derived dimensionless numbers such that 
% \begin{equation}
% \label{eq:dimless-group2}
% \text{Bi}^{\left(p\right)} = \ddfrac{\hat{U}^{pc}\hat{\mathcal{L}}}{\hat{\mathcal{K}}^{p}}, 
% \qquad
% \text{Bi}^{\left(c\right)} = \ddfrac{\text{Bi}^{\left(p\right)}}{\varsigma}, 
% \qquad
% \mathcal{Q} = \ddfrac{\hat{Q}^{pw}\hat{\mathcal{L}}}{\left(\hat{T}_{b} - \hat{T}_{\infty} \right) \hat{\mathcal{K}}^{p}},
% \end{equation}
% where $\hat{U}^{pc}$ is the total transfer coefficient between the packing materials and the battery cells and $\hat{Q}^{pw}$ is the power flux between the packing materials and the cooling water pipes. 
\subsection{Dimensionless upscaled governing equations}

Based on homogenization theory, the upscaled governing equations are derived from the fine-scale governing equations using the automated pipeline, \symbolica~\cite{Pietrzyk2023-ou} by applying averaging operators as

\neweqgat{eq:ave-op}{\langle \;\; \bm{\cdot}^{\left(i\right)} \rangle_{Y} \equiv \frac{1}{|Y|} \int_{\mathcal{B}^{\left(i\right)}}\left( \;\; \bm{\cdot}^{\left(i\right)}\right)\;d\xiv, \quad \langle \bm{\cdot} \rangle_{\mathcal{B}^{\left(i\right)}} \equiv \frac{1}{|\mathcal{B}^{\left(i\right)}|} \int_{\mathcal{B}^{\left(i\right)}}\left(\bm{\cdot}\right)\;d\xiv, \quad \langle \bm{\cdot} \rangle_{\Gamma^{\left(j\right)}} \equiv \frac{1}{|\Gamma^{\left(j\right)}|} \int_{\Gamma^{\left(j\right)}}\left(\bm{\cdot}\right)\;d\xiv,}

\noindent respectively, where $i = p$, $c$, or $w$ refer to packing material, battery cell and cooling water pipe, respectively; $j = pc$ or $pw$ refers to the interface between packing material and battery cell, and the interface between packing material and cooling water pipes, respectively; $|Y|$ is the area of the unit-cell domain; $|\mathcal{B}^{\left(i\right)}|$ is the area of the region $\mathcal{B}^{\left(i\right)}$ in the unit-cell, and $|\Gamma^{\left(j\right)}|$ is the length of interface $\Gamma^{\left(j\right)}$ in the unit-cell. {While the second averaging operator in Equation~\eqref{eq:ave-op} is typically used in homogenization, the first averaging operator ensures a better comparison between fine-scale and upscaled results. Hence, for completeness, we report both.}
% $\langle \bm{\cdot} \rangle_Y$ such that 
% \begin{align}
% \label{eq:ave-op}
% \langle \bm{\cdot} \rangle_Y \equiv \ddfrac{1}{\abs{Y}} \int_Y \left( \bm{\cdot} \right) \ \dd\boldsymbol{\xi} = \ddfrac{1}{\abs{Y}} \left[ \int_{\mathcal{B}^p} \left(\cdot\right) \ \dd\boldsymbol{\xi} + \int_{\mathcal{B}^c} \left(\cdot\right) \ \dd\boldsymbol{\xi}\right],
% \end{align}
% where $\abs{Y}$ refers to the volume of the unit cell $Y$.

{

The main objective of deriving upscaled equations is to obtain average packing material and cell temperatures.} The accuracy of the derived upscaled equations has been thoroughly validated by Pietrzyk et al.~\cite{Pietrzyk2023-ou}. The upscaled governing equations of the average temperatures $\ensmean{T^{p}}_Y$ and $\ensmean{T^{c}}_Y$ are {derived by applying the averaging operator 
 (equation~\eqref{eq:ave-op}) such that}
 
\begin{subequations}\label{upscaled}
\label{eq:upscaled_goven_eqs}
\neweq{Nc_2_homo_eq_1}{\phi^{\left(p\right)}\derive{\langle T^{\left(p\right)} \rangle_{Y}}{t} + \U^{\left(p\right)} \bm{\cdot} \nabla_{\mathbf{x}} \langle T^{\left(p\right)} \rangle_{Y} - \V^{\left(p\right)} \bm{\cdot} \nabla_{\mathbf{x}} \langle T^{\left(c\right)} \rangle_{Y} - \nabla_{\mathbf{x}} \bm{\cdot} \left(\K^{\left(p\right)} \bm{\cdot} \nabla_{\mathbf{x}} \langle T^{\left(p\right)} \rangle_{Y}\right)                   \\
= -R_1^{\left(p\right)}\langle T^{\left(p\right)} \rangle_{Y} + R_2^{\left(p\right)}\langle T^{\left(c\right)} \rangle_{Y} - R_3^{\left(p\right)}q^{\left(pw\right)}\left(t, \mathbf{x}\right) + \R_4^{\left(p\right)} \bm{\cdot} \nabla_{\mathbf{x}} {q^{\left(pw\right)}},}

\neweq{Nc_2_homo_eq_2}{\phi^{\left(c\right)}\derive{\langle T^{\left(c\right)} \rangle_{Y}}{t} + \U^{\left(c\right)} \bm{\cdot} \nabla_{\mathbf{x}} \langle T^{\left(c\right)} \rangle_{Y} - \V^{\left(c\right)} \bm{\cdot} \nabla_{\mathbf{x}} \langle T^{\left(p\right)} \rangle_{Y} - \nabla_{\mathbf{x}} \bm{\cdot} \left(\K^{\left(c\right)} \bm{\cdot} \nabla_{\mathbf{x}} \langle T^{\left(c\right)} \rangle_{Y}\right)               \\
= R_1^{\left(c\right)} \langle T^{\left(p\right)} \rangle_{Y} - R_2^{\left(c\right)} \langle T^{\left(c\right)} \rangle_{Y} + R_3^{\left(c\right)} q^{\left(pw\right)}\left(t, \mathbf{x}\right) + R_4^{\left(c\right)} {\overline{\Pi}},}

\neweq{eq:upscale_power_flux_source}{{\overline{\Pi}} = \Pi_{\text{base}} + \frac{1}{2}\left\{\text{Erf}\left[\frac{A_1}{\phi^{\left(c\right)}} \langle T^{\left(c\right)} \rangle_{Y} + B_1\right] + 1\right\}\left(1 - \Pi_{\text{base}}\right)                   \\
- \frac{1}{2}\left\{\text{Erf}\left[\frac{A_2}{\phi^{\left(c\right)}} \langle T^{\left(c\right)} \rangle_{Y} + B_2\right] + 1\right\}.}
\end{subequations}

\noindent where

\begin{subequations}\label{effectivecoefficients}
\neweq{}{\U^{\left(p\right)} = \phi^{\left(p\right)}\frac{\text{Bi}^{\left(p\right)}}{|\mathcal{B}^{\left(p\right)}|} |\Gamma^{\left(pc\right)}| \langle \chiv^{\left(p\right)\left[3\right]} \rangle_{\Gamma^{\left(pc\right)}} - k^{\left(p\right)}\langle\nabla_{\xiv}\chi^{\left(p\right)\left[2\right]}\rangle_{Y},}
\neweq{}{\V^{\left(p\right)} = \frac{\phi^{\left(p\right)}}{\phi^{\left(c\right)}}\left[\phi^{\left(p\right)}\frac{\text{Bi}^{\left(p\right)}}{|\mathcal{B}^{\left(p\right)}|} |\Gamma^{\left(pc\right)}| \langle \chiv^{\left(c\right)\left[2\right]} \rangle_{\Gamma^{\left(pc\right)}} - k^{\left(p\right)}\langle \nabla_{\xiv}\chi^{\left(p\right)\left[2\right]} \rangle_{Y}\right],}
\neweq{}{\K^{\left(p\right)} = k^{\left(p\right)}\left[\phi^{\left(p\right)}\I + \langle \nabla_{\xiv}\chiv^{\left(p\right)\left[3\right]} \rangle_{Y}\right],}
\neweq{}{R_1^{\left(p\right)} = \phi^{\left(p\right)}\frac{\text{Bi}^{\left(p\right)}}{|\mathcal{B}^{\left(p\right)}|}|\Gamma^{\left(pc\right)}|\left(\frac{1}{\epsilon} - \langle\chi^{\left(c\right)\left[1\right]}\rangle_{\Gamma^{\left(pc\right)}} + \langle\chi^{\left(p\right)\left[2\right]}\rangle_{\Gamma^{\left(pc\right)}}\right),}
\neweq{}{R_2^{\left(p\right)} = \frac{\phi^{\left(p\right)}}{\phi^{\left(c\right)}}R_1^{\left(p\right)},}
\neweq{}{R_3^{\left(p\right)} = \phi^{\left(p\right)^2}\left[\frac{\mathcal{Q}|\Gamma^{\left(pw\right)}|}{|\mathcal{B}^{\left(p\right)}|\epsilon} + \frac{\text{Bi}^{\left(p\right)}}{|\mathcal{B}^{\left(p\right)}|} |\Gamma^{\left(pc\right)}| \langle \chi^{\left(p\right)\left[1\right]} \rangle_{\Gamma^{\left(pc\right)}}\right],}
\neweq{}{\R_4^{\left(p\right)} = \phi^{\left(p\right)}k^{\left(p\right)}\langle\nabla_{\xiv}\chi^{\left(p\right)\left[1\right]}\rangle_{Y}.}
\neweq{}{\U^{\left(c\right)} = \varrho \varsigma \left[\phi^{\left(c\right)}\frac{\text{Bi}^{\left(c\right)}}{|\mathcal{B}^{\left(c\right)}|} |\Gamma^{\left(pc\right)}| \langle \chiv^{\left(c\right)\left[2\right]} \rangle_{\Gamma^{\left(pc\right)}} + k^{\left(c\right)}\langle\nabla_{\xiv}\chi^{\left(c\right)\left[1\right]}\rangle_{Y}\right],}
\neweq{}{\V^{\left(c\right)} = \frac{\phi^{\left(c\right)}}{\phi^{\left(p\right)}}\varrho \varsigma \left[\phi^{\left(c\right)}\frac{\text{Bi}^{\left(c\right)}}{|\mathcal{B}^{\left(c\right)}|} |\Gamma^{\left(pc\right)}| \langle \chiv^{\left(p\right)\left[3\right]} \rangle_{\Gamma^{\left(pc\right)}} + k^{\left(c\right)}\langle\nabla_{\xiv}\chi^{\left(c\right)\left[1\right]}\rangle_{Y}\right],}
\neweq{}{\K^{\left(c\right)} = \varrho \varsigma k^{\left(c\right)}\left[\phi^{\left(c\right)}\I + \langle\nabla_{\xiv}\chiv^{\left(c\right)\left[2\right]}\rangle_{Y}\right],}
\neweq{}{R_1^{\left(c\right)} = \frac{\phi^{\left(c\right)}}{\phi^{\left(p\right)}} R_2^{\left(c\right)},}
\neweq{}{R_2^{\left(c\right)} = \phi^{\left(c\right)}\frac{\left(\text{Bi}^{\left(c\right)} \varrho \varsigma\right)}{|\mathcal{B}^{\left(c\right)}|} |\Gamma^{\left(pc\right)}| \left(\frac{1}{\epsilon} - \langle \chi^{\left(c\right)\left[1\right]} \rangle_{\Gamma^{\left(pc\right)}} + \langle \chi^{\left(p\right)\left[2\right]} \rangle_{\Gamma^{\left(pc\right)}}\right),}
\neweq{}{R_3^{\left(c\right)} = \phi^{\left(c\right)^2}\frac{\left(\text{Bi}^{\left(c\right)} \varrho  \varsigma\right)}{|\mathcal{B}^{\left(c\right)}|} |\Gamma^{\left(pc\right)}| \langle \chi^{\left(p\right)\left[1\right]} \rangle_{\Gamma^{\left(pc\right)}},}
\neweq{}{R_4^{\left(c\right)} = \phi^{\left(c\right)^2} \varrho \mathcal{R},}
\end{subequations}
{In equations \eqref{upscaled}~--~\eqref{effectivecoefficients}, $\langle T^{\left(p\right)} \rangle_{Y}\left(t, \mathbf{x}\right)$ and $\langle T^{\left(c\right)} \rangle_{Y}\left(t, \mathbf{x}\right)$ are the averaged packing and battery cell temperatures, $\overline{\Pi}(\langle T^{\left(c\right)} \rangle_{Y}, \mathbf{x})$ is the homogenized power flux source term and ${\Pi}_{\text{base}}(\hat{\mathbf{x}})$ is the dimensionless \textit{base} power flux values, respectively.}  $\U^{\left(i\right)}$ are effective velocities, $\V_{i}^{\left(\bm{\cdot}\right)}$ are effective parameters corresponding to the emergent terms, $\K^{\left(i\right)}$ are effective thermal conductivities, $R_{\bm{\cdot}}^{\left(i\right)}$ and $\R_{5}^{\left(p\right)}$ are effective reaction rates, and ${\chi}_0^{p}$, ${\chi}_1^{p}$, $\boldsymbol{\chi}_2^{p}$ and ${\chi}_0^{c}$ are closure problems that must be solved in the unit cell with periodic boundary conditions. Since these closure problems are only solved once, the increase in computation cost is negligible. A detailed formulation of closure problems can be found in~\ref{subsection:Appendix_E_Closure_Problems} or in Pietrzyk et al.~\cite{Pietrzyk2023-ou}.

% \begin{subequations}
% \begin{align}
% &\boldsymbol{\widetilde{\kappa}}^{p} = -k^{\left(p\right)}\left( \boldsymbol{I} + \ensmean{\grad_{\boldsymbol{\xi}} \boldsymbol{\chi}_2^{p}}_{\mathcal{B}^{p}} \right), \\
% &\boldsymbol{\theta}^{p} = \left( \ddfrac{\text{Bi}^{\left(p\right)} \vert \Gamma^{pc} \vert}{\vert \mathcal{B}^{p} \vert} \ensmean{\boldsymbol{\chi}_2^{p}}_{\Gamma^{pc}} - k^{\left(p\right)}\ensmean{\grad_{\boldsymbol{\xi}} {\chi}_1^{p}}_{\mathcal{B}^{p}} \right), \\
% &\boldsymbol{\theta}^{pc} = -\ddfrac{\phi^{\left(p\right)}}{\phi^{c}} \left( \ddfrac{\text{Bi}^{\left(p\right)} \vert \Gamma^{pc} \vert}{\vert \mathcal{B}^{p} \vert} \ensmean{\boldsymbol{\chi}_1^{c}}_{\Gamma^{pc}} - k^{\left(p\right)}\ensmean{\grad_{\boldsymbol{\xi}} {\chi}_1^{p}}_{\mathcal{B}^{p}} \right),
% \end{align}
% \begin{align}
%  \boldsymbol{\mathbb{S}}^{\left(p\right)}\left(t, \mathbf{x}\right) &= \ddfrac{\text{Bi}^{\left(p\right)} \left\vert \Gamma^{pc} \right\vert}{\vert \mathcal{B}^{p} \vert} \left(\epsilon^{-1} -  \ensmean{{\chi}_0^{c}}_{\Gamma^{pc}} + \ensmean{{\chi}_1^{p}}_{\Gamma^{pc}} \right) \left( \ddfrac{\phi^{\left(p\right)}}{\phi^{c}}\ensmean{T^{c}}_Y - \ensmean{T^{p}}_Y \right) \nonumber \\
%  &+ \phi^{\left(p\right)}k^{\left(p\right)} \ensmean{\grad_{\boldsymbol{\xi}} {\chi}_0^{p}}_{\mathcal{B}^{p}} \bm{\cdot} \grad_{\mathbf{x}} q^{pw}(t,\mathbf{x}) \nonumber\\ 
%  & - \phi^{\left(p\right)} \left(\ddfrac{\text{Bi}^{\left(p\right)} \vert \Gamma^{pc} \vert }{\abs{\mathcal{B}^{p}}} \ensmean{{\chi}_0^{p}}_{\Gamma^{pc}} + \ddfrac{\mathcal{Q}\abs{ \Gamma^{pw}}}{\abs{\mathcal{B}^{p}}\epsilon}\right) q^{pw}(t,\mathbf{x}),
% \end{align}
% \begin{align}
% &\boldsymbol{\theta}^{cp} = -\ddfrac{\phi^{c}}{\phi^{\left(p\right)}} \left(\varsigma \bm{\cdot} \varrho \right) \left( \ddfrac{\text{Bi}^{\left(c\right)} \vert \Gamma^{pc} \vert}{\vert \mathcal{B}^{c} \vert} \ensmean{\boldsymbol{\chi}_2^{p}}_{\Gamma^{pc}}\right), 
% \end{align}
% \begin{align}
%  \boldsymbol{\mathbb{S}}^{c}\left(t, \mathbf{x}\right) &= \ddfrac{\text{Bi}^{\left(c\right)} \bm{\cdot} \varsigma \bm{\cdot} \varrho \vert \Gamma^{pc} \vert}{\vert \mathcal{B}^{c} \vert} \left(\epsilon^{-1} -  \ensmean{{\chi}_0^{c}}_{\Gamma^{pc}} + \ensmean{{\chi}_1^{p}}_{\Gamma^{pc}} \right) \left( \ddfrac{\phi^{c}}{\phi^{\left(p\right)}}\ensmean{T^{p}}_Y - \ensmean{T^{c}}_Y \right) \nonumber \\
%  & + \phi^{c} \ddfrac{\text{Bi}^{\left(c\right)} \bm{\cdot} \varsigma \bm{\cdot} \varrho \vert \Gamma^{pc} \vert }{\abs{\mathcal{B}^{c}}} \ensmean{{\chi}_0^{p}}_{\Gamma^{pc}} q^{pw}(t,\mathbf{x}) + \phi^{c} \left( \mathcal{R} \bm{\cdot} \varrho\right) \Pi(t,\mathbf{x}),
% \end{align}
% \end{subequations}

\subsection{Hybrid governing equations}
\label{sec:coupling-conditions}
Assuming the existence of breakdown regions ${\Omega}_{\text{break}}$ in a dimensionless battery pack ${\Omega}_{\epsilon}$, we consider a two-dimensional heterogeneous battery pack ${\Omega}_{\epsilon,\text{het}} \in \mathbb{R}^2$ where the homogeneous assumption in the upscaled governing equations~\eqref{eq:upscaled_goven_eqs} is violated in the breakdown regions. Instead of solving the entire ${\Omega}_{\epsilon,\text{het}}$ with fine-scale equations~\eqref{eq:pore_goven_eqs} which is computationally expensive, a hybrid approach that combines the advantages of fine-scale and upscaled approaches is preferred. In hybrid simulations, the fine-scale subdomain {${\Omega}_{\text{fine}}$} is defined as ${\Omega}_{\text{break}} \cap {\Omega}_{\epsilon,\text{het}}$ while the upscaled subdomain ${\Omega}_{\text{up}}$ is defined as ${\Omega}_{\text{break}} \backslash {\Omega}_{\epsilon,\text{het}}$. There,  {${\Omega}_{\text{fine}}$} and ${\Omega}_{\text{up}}$ are solved by fine-scale and upscaled equations, respectively. These two subdomains are coupled by a coupling boundary ${\Gamma}^{\left(HC\right)}_{\epsilon} \subset \mathbb{R}^2$. In this study, we simplify the problem by assuming that ${\Gamma}^{\left(HC\right)}_{\epsilon}$ is defined in $\mathcal{B}_\epsilon^{\left(p\right)}$ and only dependent on $x$ instead of both $x$ and $y$. Therefore, ${\Omega}_{\text{up}}$ is bounded by packing edges ${\Gamma}^{\left(R\right)}$,  ${\Gamma}^{\left(T\right)}$ and ${\Gamma}^{\left(B\right)}$ and the coupling boundary ${\Gamma}^{\left(HC\right)}_{\epsilon}$, while the fine-scale subdomain {${\Omega}_{\text{fine}}$} is bounded by packing edges ${\Gamma}_\epsilon^{\left(L\right)}$,  ${\Gamma}_\epsilon^{\left(T\right)}$ and ${\Gamma}_\epsilon^{\left(B\right)}$ and the coupling boundary ${\Gamma}^{\left(HC\right)}_{\epsilon}$ (Figure~\ref{fig:het-domain-eg}). 

\begin{figure}
\centerline{
 {\includegraphics[width=.7\linewidth]{figures/Domain_het.pdf}}}
\caption{{Schematic diagram of a hypothetical hybrid domain with fine-scale and upscaled subdomains. The sizes of the fine-scale and upscaled subdomains are arbitrary.}}
\label{fig:het-domain-eg}
\end{figure}

% Let's focus on a  region across the coupling boundary with $\mathbf{x}_{HC} \in \Gamma_\epsilon^{\left(HC\right)}$ (Figure~\ref{fig:hybrid_illu_1}). {We now define two arbitrary volumes, which live in} {${\Omega}_{\text{fine}}$} and ${\Omega}_{\text{up}}$, with centroids $\mathbf{x}^{+}$ and $\mathbf{x}^{-}$. {As $\mathbf{x}^{+}$ and $\mathbf{x}^{-}$ approach $\mathbf{x}_{HC}$ from the right and the left, respectively, =======



% move toward and eventually coincide with $\mathbf{x}_{HC} \in \Gamma_\epsilon^{\left(HC\right)}$ from their respective subdomains where} $\mathbf{x}_{HC}$ is the centroid of the coupling volume $Y_{HC}$, heat and flux conservation will be guaranteed (Figure~\ref{fig:hybrid_illu_2}) as 


{

Let's focus on a region across the coupling boundary with $\mathbf{x}_{HC} \in \Gamma_\epsilon^{\left(HC\right)}$ (Figure~\ref{fig:hybrid_illu_1}). %\textcolor{red}{[Here, it looks like you use $\langle \cdot \rangle_{Y}$ on Pore-scale values. I know what you are trying to say, but it might be worth defining a separate average for this, since you technically can only use that average to denote upscaled quantities. If you look at the other battery paper, we define an average over moving domain $\mathcal{W}\left(\mathbf{x}\right)$ (which is rigorously defined) for what you are trying to do here. It looks like the reviewer has some confusion on similar points as well (i.e., doesn't understand the double integrals in the appendix, etc.]}
We now define two average temperatures $\ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+})$ and $\ensmean{T^{\left(p\right)}}_{Y}(\mathbf{x}^{-})$, with centroids $\mathbf{x}^{+} \in \Omega_{\text{fine}}$ and $\mathbf{x}^{-} \in \Omega_{\text{up}}$ , respectively. As $\mathbf{x}^{+}$ and $\mathbf{x}^{-}$ approach $\mathbf{x}_{HC}$ from the right and the left, %\textcolor{red}{[should be left and right? not right and left]}, 
respectively, the limiting average temperatures, $\ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}_{HC}) :=\lim_{\mathbf{x}^{+} \rightarrow \mathbf{x}_{HC}} \ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+})$ and  $\ensmean{T^{\left(p\right)}}_{Y}(\mathbf{x}_{HC}) :=\lim_{\mathbf{x}^{-} \rightarrow \mathbf{x}_{HC}} \ensmean{T^{\left(p\right)}}_{Y}(\mathbf{x}^{-})$, will be equivalent, satisfying the continuity of heat. By applying a similar concept to the heat flux across the coupling boundary, the continuities of heat and flux are defined as (Figure~\ref{fig:hybrid_illu_2})} %\textcolor{red}{[I think there might be implications to the $\mathbf{n}$ being outside the integral (i.e., boundary HC must be straight). I don't know if you want to address this or not]}


% volumes, which live in{${\Omega}_{\text{fine}}$} and ${\Omega}_{\text{up}}$, with centroids $\mathbf{x}^{+}$ and $\mathbf{x}^{-}$. {As $\mathbf{x}^{+}$ and $\mathbf{x}^{-}$ approach $\mathbf{x}_{HC}$ from the right and the left, respectively, =======



% move toward and eventually coincide with $\mathbf{x}_{HC} \in \Gamma_\epsilon^{\left(HC\right)}$ from their respective subdomains where} $\mathbf{x}_{HC}$ is the centroid of the coupling volume $Y_{HC}$, heat and flux conservation will be guaranteed (Figure~\ref{fig:hybrid_illu_2}) as 

\begin{subequations}
\label{eq:coupling-conds}
\begin{align}
&{\ensmean{T^{\left(p\right)}}_{Y}(\mathbf{x}^{-}) = \ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+}),  \quad \text{for} \quad \abs{\mathbf{x}^{+} - \mathbf{x}^{-}} \rightarrow 0, }\\
& {\ensmean{\mathbf{J}^{\left(p\right)}}_{Y}(\mathbf{x}^{-})  \bm{\cdot} \mathbf{n}^{\left(p\right)}_\epsilon = \phi^{\left(p\right)}\ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+})  \bm{\cdot} \mathbf{n}^{\left(p\right)}_\epsilon, \quad \text{for} \quad \abs{\mathbf{x}^{+} - \mathbf{x}^{-}} \rightarrow 0,}\label{eq:packing_flux_hc}
\end{align}
\end{subequations}
where  ${\mathbf{J}_\epsilon^{\left(p\right)}}(\mathbf{x}^{+})$ and $\ensmean{\mathbf{J}^{\left(p\right)}}_{Y}(\mathbf{x}^{-})$ are the packing material fluxes in the fine-scale and upscaled equations, respectively. Although there are packing and cell temperatures, heat and flux continuities are only required for the packing temperature. The derivations of the flux conditions in equation~\eqref{eq:packing_flux_hc} can be found in~\ref{app:packing-flux-proof} and~\ref{app:cell-flux-proof}. One challenge associated with equation~\eqref{eq:coupling-conds} is that the average fine-scale quantities {(RHS of equation~\eqref{eq:coupling-conds})} are unknown. Therefore, appropriate approximation methods such as the Taylor (Section~\ref{sec:taylor}) or Series (Section~\ref{sec:series}) expansion approach are needed to compute the average fine-scale quantities. 


\begin{figure*}
    \centering
    \begin{subfigure}[ht]{0.7\textwidth}
    \caption{}
    \centerline{
     {\includegraphics[width=\textwidth]{figures/Hybrid_illustration_1.pdf}}}
    \label{fig:hybrid_illu_1}
    \end{subfigure}
    
    \begin{subfigure}[ht]{0.7\textwidth}
    \caption{}
    \centerline{
     {\includegraphics[width=\textwidth]{figures/Hybrid_illustration_2.pdf}}}
    \label{fig:hybrid_illu_2}
    \end{subfigure}
    
    \begin{subfigure}[ht]{0.7\textwidth}
    \caption{}
    \centerline{
     {\includegraphics[width=\textwidth]{figures/Hybrid_illustration_3.pdf}}}
    \label{fig:hybrid_illu_3}
    \end{subfigure}
     \caption{{Schematic illustration of the formulation of the hybrid approach. (a) Two volumes with centroids $\mathbf{x}^{+}$ in the fine-scale domain (blue) and $\mathbf{x}^{-}$ in the upscaled domain (orange) move toward each other, (b) two volumes coincide where $\mathbf{x}^{+} = \mathbf{x}^{-} = \mathbf{x}_{HC}$, and (c) the coupling volume from the fine-scale domain is divided into two regions $Y_{in}$ and $Y_{out}$ with centroids $\mathbf{x}_{c,in}^{+}$ and $\mathbf{x}_{c,out}^{+}$, respectively, where $Y_{in}$ intersects with the fine-scale domain and $Y_{out}$ intersects with the upscaled domain.}}
     \label{fig:hybrid_illu_all}
\end{figure*}


% In addition, as demonstrated in Section X, since equation~\eqref{eq:cell_flux_hc} is valid, no boundary conditions on the cell temperatures in fine-scale and upscaled simulations have been imposed, resulting in a jump or discontinuity at the coupling boundary due to errors between fine-scale and upscaled simulations. To eliminate the discontinuity and enforce equations~\ref{eq:coupling-conds} simultaneously, we added a flux to the battery cell nearest to the coupling boundary (Section~\ref{sec:taylor} and~\ref{sec:series}).  
\subsubsection{Taylor expansion approach}
\label{sec:taylor}
At the coupling boundary, we separate the coupling volume $Y(\mathbf{x}_{HC})$ into $Y_{in}(\mathbf{x}^{+}_{c,in}) = Y \cap {\Omega}_{\text{fine}}$ and $Y_{out}(\mathbf{x}^{+}_{c,out}) = Y \cap {\Omega}_{\text{up}}$ where $\mathbf{x}^{+}_{c,in}$ and $\mathbf{x}^{+}_{c,out}$ are the centroids of $Y_{in}$ and $Y_{out}$, respectively (Figure~\ref{fig:hybrid_illu_3}). Using this definition, $\ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+})$ can be expressed as %\textcolor{red}{[can maybe get rid of the $"\in Y_{in}"$ and $"\in Y_{out}"$]}
\begin{align}
\label{eq:Tp}
&\ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+}) = \ddfrac{1}{\abs{Y}} \int_{\mathcal{B}^{\left(p\right)}_{in}} T_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y} + \ddfrac{1}{\abs{Y}} \int_{\mathcal{B}^{\left(p\right)}_{out} } T_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y},
\end{align}
where $\mathcal{B}^{\left(p\right)}_{in}$ and $\mathcal{B}^{\left(p\right)}_{out}$ are the packing material domains in $Y_{in}$ and $Y_{out}$, respectively.

Since the quantities in $Y_{out}$ are solved with upscaled equations, the fine-scale packing temperature $T_\epsilon^{\left(p\right)}$ is unknown. To approximate the second integral in equation~\eqref{eq:Tp}, one approach is use a  Taylor series at the nearest defined location (the coupling boundary $\mathbf{x}_{HC}$). 
% However, $T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC})$ is not defined unless $\mathbf{x}_{HC} \in \mathcal{B}^p$ is satisfied. Therefore, instead of expanding at $\mathbf{x}_{HC}$, the integral is expanded at $\mathbf{x}^{*}_{HC}$ and retains the first two terms where $\mathbf{x}^{*}_{HC}$ is defined as
% \begin{align}
%     &\mathbf{x}^{*}_{HC} = \argmin_{y} \left(y-\mathbf{x}_{HC} \right),
% \end{align}
% where $y \in \mathcal{B}^p$ and $\abs{\mathbf{x}^{*}_{HC} - \mathbf{x}_{HC}} < \epsilon$ are satisfied to ensure that $\mathbf{x}^{*}_{HC}$ is in the same unit cell as $\mathbf{x}_{HC}$. 
As such, the integral can be expressed as
\begin{align}
&\int_{\mathcal{B}^{\left(p\right)}_{out}} T_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y} = \int_{\mathcal{B}^{\left(p\right)}_{out}} \left[ T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) + \pdv{T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC})}{\mathbf{x}} \left(\mathbf{y} - \mathbf{x}_{HC}\right) + \mathcal{O}\left((\mathbf{y}-\mathbf{x}_{HC})^2\right) \right] \ \dd\mathbf{y}.
\end{align}
By defining the centroid of $Y_{out}$ as
\begin{align}
&\mathbf{x}^{+}_{c,out} = \ddfrac{1}{\abs{\mathcal{B}^{\left(p\right)}_{out}} } \int_{\mathcal{B}^{\left(p\right)}_{out}} \mathbf{y} \ \dd\mathbf{y},
\end{align}
and $\abs{\mathcal{B}^{\left(p\right)}_{out}} = \abs{Y_{out}}\phi^{\left(p\right)}_{out}$, the approximated integral is then expressed as
\begin{align}
\int_{\mathcal{B}^{\left(p\right)}_{out}} T_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y} &= \abs{Y_{out}}\phi^{\left(p\right)}_{out} \left[ T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) + \pdv{T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC})}{\mathbf{x}} \left(\mathbf{x}^+_{c,out} - \mathbf{x}_{HC}\right) \right] \\
&+  \int_{\mathcal{B}^{\left(p\right)}_{out}} \mathcal{O}\left((\mathbf{y}-\mathbf{x}_{HC})^2\right) \ \dd\mathbf{y}
\end{align}
where $\phi^{\left(p\right)}_{out}$ is the volume fraction of the packing materials in $Y_{out}$ such that
\begin{align}
    \phi^{\left(p\right)}_{out} = \frac{\abs{Y}\phi^{(p)} -  \int_{\mathcal{B}^{\left(p\right)}_{in}} \mathbf{1} \ \dd\mathbf{y}}{\abs{Y_{out}}}.
\end{align}
Finally, by truncating at the second-order term, the integral is approximated as 
% However, $\phi^{\left(p\right)}_{out}$ cannot be computed because $Y_{out}$ is only defined in the upscaled domain, which does not contain information on battery cells and cooling water pipes. By ensuring $\abs{Y_{out}} \ge \abs{Y}$, $\phi^{\left(p\right)}_{out} = \phi^{\left(p\right)}$ is guaranteed where $\phi^{\left(p\right)}$ is the known volume fraction of packing material in a unit cell that can be computed with the known unit cell geometry. Finally, the second-order accurate approximate integral is simplified to 

\begin{align}
\label{eq:taylor-tp-approx}
&\int_{\mathcal{B}^{\left(p\right)}_{out}} T_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y} \approx \abs{Y_{out}}\phi^{\left(p\right)}_{out} \left[ T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) + \pdv{T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC})}{\mathbf{x}} \left(\mathbf{x}^+_{c,out} - \mathbf{x}_{HC}\right) \right].
\end{align}
By substituting equation~\eqref{eq:taylor-tp-approx} into equation~\eqref{eq:Tp}, the average packing temperature at the coupling boundary can be approximated as 
\begin{align}
\label{eq:approx-tp}
&\ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+}) \approx \ensmean{T_\epsilon^{\left(p\right)}}_{Y_{in}}(\mathbf{x}^{+}) + \alpha^{-1} \phi^{\left(p\right)}_{out} \left[ T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) + \pdv{T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC})}{\mathbf{x}} \left(\mathbf{x}^+_{c,out} - \mathbf{x}_{HC}\right) \right],
\end{align}
where $\ensmean{T_\epsilon^{\left(p\right)}}_{Y_{in}}(\mathbf{x}^{+}) = \ddfrac{1}{\abs{Y}} \int_{\mathcal{B}^{\left(p\right)}_{in}} T_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y}$ and $\alpha = \abs{Y}/\abs{Y_{out}}$.

% By applying a similar approach to approximate the average cell temperature $\ensmean{T_\epsilon^{c}}_Y_{Y}(\mathbf{x}^{+})$, we derive the second-order accurate approximation as 
% \begin{align}
% \label{eq:approx-tc}
% &\ensmean{T_\epsilon^{c}}_Y_{Y}(\mathbf{x}^{+}) \approx \ensmean{T_\epsilon^{c}}_Y_{Y_{in}}(\mathbf{x}^{+}) + \alpha^{-1} \phi^{c} \left[ T_\epsilon^{c}(\mathbf{x}^{*}_{HC}) + \pdv{T_\epsilon^{c}(\mathbf{x}^{*}_{HC})}{\mathbf{x}} \left(\mathbf{x}^+_{c,out} - \mathbf{x}^{*}_{HC}\right) \right],
% \end{align}
% where $\phi^{c}$ is the known volume fraction of battery cell in a unit cell. A point to note is that $\mathbf{x}^{*}_{HC}$ in equations~\ref{eq:approx-tp} and~\ref{eq:approx-tc} might not be equivalent since the approximate centroids are defined on the respective domain.

To derive the average flux of packing material $\ensmean{\mathbf{J}_\epsilon^{(p)}}_{Y}(\mathbf{x}^{+})$, a similar approach as that used in equation~\eqref{eq:Tp} is employed, such that 
\begin{align}
\phi^{\left(p\right)}\ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+})  \bm{\cdot} \mathbf{n}^{\left(p\right)}_\epsilon &= \ddfrac{\phi^{\left(p\right)}}{\abs{Y}} \int_{\mathcal{B}^{\left(p\right)}_{in}} \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y}  \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)} + \ddfrac{\phi^{\left(p\right)}}{\abs{Y}} \int_{\mathcal{B}^{\left(p\right)}_{out}} \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y} \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)} \nonumber \\
&\approx \phi^{\left(p\right)}\ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y_{in}}(\mathbf{x}^{+}) \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)} + q^{\left(p,n\right)},
\end{align}
where {$\ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y_{in}}(\mathbf{x}^{+}) =  \ddfrac{1}{\abs{Y}} \int_{\mathcal{B}^{\left(p\right)}_{in}} \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y}$} and $q^{\left(p,n\right)} = {\ddfrac{\phi^{\left(p\right)}}{\abs{Y}} \int_{\mathcal{B}^{\left(p\right)}_{out}} \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{y}) \ \dd\mathbf{y} \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)} }$ is the {unresolved} %\text{color}{is it unknown or unresolved? I am not sure we talked about guessing yet. Guessing is how we handle this unknown.} 
flux of the packing material at iteration $n$. {To derive the flux boundary conditions of the fine-scale equation, we expand the unresolved flux at $\mathbf{x}_{HC}$ and the integral can be approximated as }% \textcolor{red}{[It might just be me, but I got a little lost here; I see what's happening after rereading it a few times, but having a formula for a ``guess flux" was a little weird at first.]}
\begin{align}
\label{eq:approx-flux-long}
   q^{\left(p,n\right)} &= \alpha^{-1}\phi^{\left(p\right)} \phi^{\left(p\right)}_{out}\left[ \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) + \pdv{\mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC})}{\mathbf{x}} \left(\mathbf{x}^+_{c,out} - \mathbf{x}_{HC}\right) \right] \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)} \nonumber \\
  &+  \int_{\mathcal{B}^{\left(p\right)}_{out}} \mathcal{O}\left((\mathbf{y}-\mathbf{x}_{HC})^2\right) \ \dd\mathbf{y}.
\end{align}
To relate $q^{\left(p,n\right)}$ to the flux boundary conditions of the fine-scale equations $\mathbf{J}_\epsilon^{(p)}(\mathbf{x}_{HC})$, equation~\eqref{eq:approx-flux-long} is truncated to the first-order  and approximated as 
\begin{align}
\label{eq:approx-flux}
  &  q^{\left(p,n\right)} \approx \alpha^{-1}\phi^{\left(p\right)} \phi^{\left(p\right)}_{out} \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)} .
\end{align}
By rearranging the equation~\eqref{eq:approx-flux}, the flux boundary condition for the fine-scale equations is defined as 
\begin{align}
\mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)}  \approx {\alpha}{\left(\phi^{\left(p\right)} \phi^{\left(p\right)}_{out}\right)}^{-1} q^{\left(p,n\right)}. 
\end{align}
In summary, by using Taylor series expansion, we derived the first-order accurate coupling boundary conditions for both fine-scale and upscaled equations as 
\begin{subequations}
\label{eq:taylor-hc}
\begin{align}
&\ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+}) \approx \ensmean{T_\epsilon^{\left(p\right)}}_{Y_{in}}(\mathbf{x}^{+}) + \alpha^{-1} \phi^{\left(p\right)}_{out} \left[ T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) + \pdv{T_\epsilon^{\left(p\right)}(\mathbf{x}_{HC})}{\mathbf{x}} \left(\mathbf{x}^+_{c,out} - \mathbf{x}_{HC}\right) \right], \label{eq:taylor-hc-temp}\\
&\phi^{\left(p\right)}\ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+})  \bm{\cdot} \mathbf{n}^{\left(p\right)}_\epsilon \approx \phi^{\left(p\right)}\ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y_{in}}(\mathbf{x}^{+}) \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)} + q^{\left(p,n\right)}, \label{eq:taylor-hc-flux}\\
& \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)} \approx {\alpha}{\left(\phi^{\left(p\right)} \phi^{\left(p\right)}_{out}\right)}^{-1} q^{\left(p,n\right)}.
\end{align}
\end{subequations}
{For equation~\eqref{eq:taylor-hc} to be valid, two conditions on $Y$ must be satisfied: (1) $\Gamma^{\left(HC\right)}$ only intersects with the packing materials, and (2) $\mathbf{x}_{HC} \in \Gamma^{\left(HC\right)}$ are the centroids of the coupling volume $Y$.}

\subsubsection{Series expansion approach}
\label{sec:series}
% In Section~\ref{sec:taylor}, we show that the Taylor series approach is first-order accurate due to the relationship between the guess flux and the flux boundary conditions of the fine-scale equations. 
{In Section~\ref{sec:taylor}, we show that the Taylor series approach is first-order accurate for the approximation of coupling fluxes (Equation~\eqref{eq:taylor-hc-flux}) because the Taylor expansion for flux is truncated at the first-order.} According to Pietrzyk et al.~\cite{Pietrzyk2021-lu}, \symbolica is capable of achieving higher-order accurate upscaled equations; therefore, limiting the hybrid coupling method to be first-order accurate narrows its applicability. Therefore, we propose a one-sided scheme that uses Series expansion to derive high-order accurate coupling conditions. The main advantage of this approach is that the information in the upscaled subdomain will not be {necessary}. For any quantity of interest $\langle \bm{\cdot} \rangle_{Y} (\mathbf{x}^+)$, in a homogeneous domain, we apply a second-order accurate approximation such that %\textcolor{red}{[It took me awhile to figure out equation (28) came from (i.e., Taylor expansions). As such, I think this paragraph might lean-in too hard on ``This is not Taylor expansion; it is something else". Maybe just call it "An approach for second order accuracy"?]}
\begin{align}
\label{eq:general_series}
\langle \bm{\cdot} \rangle_Y \left(\mathbf{x}^++\ddfrac{\epsilon}{2}\right) \approx \ddfrac{ \langle \bm{\cdot} \rangle_Y (\mathbf{x}^+) + \langle \bm{\cdot} \rangle_Y (\mathbf{x}^++\epsilon)}{2},
\end{align}
where %\textcolor{red}{[shouldn't it be $\mathcal{B}^{\left(i\right)}\left(\mathbf{x}\right)$? Otherwise I think $\langle \bm{\cdot} \rangle_{Y}\left(\mathbf{x}\right)$ should just be $\langle \bm{\cdot} \rangle_{Y}$. See previous comment on defining an average over $\mathcal{W}$.]}
\begin{align}
    &\langle \bm{\cdot} \rangle_Y (\mathbf{x})  = \ddfrac{1}{\abs{Y}}\int_{\mathcal{B}^{(i)}(\mathbf{x})} \left( \bm{\cdot} \right)^{(i)} \ \dd \mathbf{y}.
\end{align}
By rearranging the equation~\eqref{eq:general_series}, we can derive the second-order accurate approximation as 
\begin{align}
\label{eq:general_series_mod}
\langle \bm{\cdot} \rangle_Y (\mathbf{x}^+) = 2\langle \bm{\cdot} \rangle_Y \left(\mathbf{x}^+ + \ddfrac{\epsilon}{2}\right) - \langle \bm{\cdot} \rangle_Y (\mathbf{x}^++\epsilon).
\end{align}
To derive the flux boundary conditions for fine-scale equations, we define the {unresolved} flux $q^{\left(p,n\right)}$ of the packing material as 
\begin{align}
q^{\left(p,n\right)} = \phi^{\left(p\right)}\ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+})  \bm{\cdot} \mathbf{n}^{\left(p\right)}_\epsilon.
\end{align}
By expanding the integral at the coupling boundary $\mathbf{x}_{HC}$ with Taylor expansion, we approximate the integral as %\textcolor{red}{[I think it should be written $\mathcal{O}\left(\left(\mathbf{y} - \mathbf{x}_{HC}\right)^2\right)$]}
\begin{align}
\label{eq:series-flux-to-ps}
q^{\left(p,n\right)} &=  \ddfrac{\phi^{\left(p\right)}}{\abs{Y}}\int_{\mathcal{B}_\epsilon^{\left(p\right)}}  \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{y})  \ \dd \mathbf{y} \bm{\cdot} \mathbf{n}^{(p)}_{\epsilon}  \nonumber \\
&= \ddfrac{\phi^{\left(p\right)}}{\abs{Y}} \int_{\mathcal{B}_\epsilon^{\left(p\right)}}  \left[\mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) + \pdv{\mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC})}{\mathbf{x}} \left(\mathbf{y} - \mathbf{x}_{HC}\right) + \mathcal{O}\left((\mathbf{y}-\mathbf{x}_{HC})^2\right) \right]\ \dd \mathbf{y}.
\end{align}
By defining the centroid of the unit cell $Y$ as
\begin{align}
    &\mathbf{x}_{c} = \ddfrac{1}{\phi^{\left(p\right)}\abs{Y} } \int_{\mathcal{B}_\epsilon^{\left(p\right)}} \mathbf{y} \ \dd\mathbf{y},
\end{align}
and $\abs{\mathbf{x}_{c} - \mathbf{x}_{HC}} = 0$ due to the collocation of the coupling boundary {$\mathbf{x}_{HC}$} and centroid of the unit cell {$\mathbf{x}_{c}$}, equation~\eqref{eq:series-flux-to-ps} can be simplified to %\textcolor{red}{[I think it should be written $\mathcal{O}\left(\left(\mathbf{y} - \mathbf{x}_{HC}\right)^2\right)$]}
\begin{align}
q^{\left(p,n\right)} &= \left(\phi^{\left(p\right)}\right)^2 \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC})  + \int_{\mathcal{B}_\epsilon^{\left(p\right)}}   \mathcal{O}\left((\mathbf{y}-\mathbf{x}_{HC})^2\right) \ \dd \mathbf{y}.
\end{align}
By rearranging the equation, we can express the fine-scale packing material flux as 
\begin{align}
& \mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) \approx  {\left(\phi^{\left(p\right)}\right)}^{-2} q^{\left(p,n\right)}.
\end{align}
% To ensure continuity in average cell temperature, we add a flux boundary condition for the battery cell temperature as 
% \begin{align}
% & \mathbf{J}_\epsilon^{c}(\mathbf{x}_{HC})= \ddfrac{1}{\phi^c} q^{c,n},
% \end{align}
% where $q^{c,n}$ is the guess flux for the battery cell temperature.

In summary, the second-order accurate coupling conditions with Series expansion approach can be expressed as
\begin{subequations}
\label{eq:series-hc}
\begin{align}
&\ensmean{T_\epsilon^{\left(p\right)}}_{Y_{HC}}(\mathbf{x}^{+}) \approx 2\ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+}+\ddfrac{\epsilon}{2}) - \ensmean{T_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+}+\epsilon), \label{eq:series-hc-temp}\\
&\phi^{\left(p\right)}\ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+})  \bm{\cdot} \mathbf{n}^{\left(p\right)}_\epsilon \approx \phi^{\left(p\right)}\left(2\ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+}+\ddfrac{\epsilon}{2}) - \ensmean{\mathbf{J}_\epsilon^{\left(p\right)}}_{Y}(\mathbf{x}^{+}+\epsilon)\right) \bm{\cdot} \mathbf{n}^{\left(p\right)}_\epsilon, \label{eq:series-hc-flux}\\
&\mathbf{J}_\epsilon^{\left(p\right)}(\mathbf{x}_{HC}) \bm{\cdot} \mathbf{n}_{\epsilon}^{\left(p\right)}  \approx {\left(\phi^{\left(p\right)}\right)}^{-2} q^{\left(p,n\right)},
\end{align}
\end{subequations}

For numerical implementation, we utilized open-source software \fenics ~\cite{Alnaes2009-ty,Alnaes2014-kl,Alnaes2015-hx,Kirby2004-xd,Kirby2006-el,Olgaard2010-pd,Logg2010-mw,Logg2012-ul}. To avoid the time-step size constraint, we discretized the equations with the first-order implicit Euler method. Details on the numerical implementation of fine-scale and upscaled equations in \fenics can be found in Pietrzyk et al.~\cite{Pietrzyk2023-ou}.
% \subsection{Numerical implementation}
% For numerical implementation, we utilized open-source software \fenics~\cite{Alnaes2009-ty,Alnaes2014-kl,Alnaes2015-hx,Kirby2004-xd,Kirby2006-el,Olgaard2010-pd,Logg2010-mw,Logg2012-ul}. To avoid the time-step size constraint, we discretized the equations with the first-order implicit Euler method. Details on the numerical implementation of fine-scale and upscaled equations in \fenics can be found in Pietrzyk et al. (2022). One key component in implementing hybrid coupling is to explicitly calculate the average quantities at the coupling boundary. We introduced a few modifications to ensure numerical robustness and accuracy. To compute the average temperature fields and fluxes, we first define a naive operator on a continuous domain $V$ such that 
% \begin{eqnarray}
% \label{eq:naive}
% \ensmean{a}_V = \ddfrac{1}{\abs{V}}\int_V a \ \dd\mathbf{x} = \ddfrac{\int_V a \ \dd\mathbf{x}}{\int_V 1 \ \dd\mathbf{x}},
% \end{eqnarray}
% where $a$ is the quantity of interest, $V$ is the integrated domain that is usually in the order of a unit cell and $\abs{V}$ is the volume of domain $V$. Two equalities in equation~\eqref{eq:naive} are valid on a continuous domain. For a discrete domain $V_{dis}$, equation~\eqref{eq:naive} is violated because
% \begin{subequations}
% \begin{align}
% \label{eq:non-ideal}
%     & \ddfrac{1}{\abs{V}}\int_V a \ \dd\mathbf{x} \ne \ddfrac{\sum_i^N a_i V_{dis,i}}{\abs{V}}, \\
%     & \ddfrac{\int_V a \ \dd\mathbf{x}}{\int_V 1 \ \dd\mathbf{x}} \ne \ddfrac{\sum_i^N a_i V_{dis,i}}{\sum_i^N V_{dis,i}},
% \end{align}
% \end{subequations}
% where $N$ is the total number of nodes in $V_{dis}$ and $i$ refers to the $i$th node. Overall, equation~\eqref{eq:naive} is only true for a structured Cartesian grid where the coupling boundary perfectly intersects with the boundary nodes of $Y_{dis}$.
% \begin{figure}
% \centerline{
%  {\includegraphics[width=\linewidth]{unit-cell.eps}}}

% \caption{Packing material mesh of a unit cell in the computational domain.}
% \label{fig:unit-cell-mesh}
% \end{figure}
%  For an unstructured grid (Figure~\ref{fig:unit-cell-mesh}), the coupling boundary is unlikely to intersect with the boundary nodes of $Y_{dis}$, therefore, errors  will be introduced because of equation~\eqref{eq:non-ideal}. What complicate the problem more is that the coupling boundary only lies in the packing material domain $\mathcal{B}^p_\epsilon$ but not in the battery cell domain $\mathcal{B}_\epsilon^c$, different treatments to the averaging operators are required to ensure accuracy.

% To overcome this in the packing material domain, we introduce a correction factor $\gamma$ that accounts for the difference between continuous packing material domain $V^p$ and discrete packing material domain $V^p_{dis}$. To derive $\gamma$, we first decompose $V$ and $V_{dis}$ into
% \begin{align}
%     &\abs{V} = \abs{V^p} + \abs{V^c} + \abs{V^{cwp}} \\ 
%     &\abs{V_{dis}} = \abs{V_{dis}^p} + \abs{V_{dis}^c} + \abs{V_{dis}^{cwp}}, 
% \end{align}
% where $c$ and $cwp$ refers to the battery cell and cooling water pipe domains. Since the coupling boundary only lies in the packing material, $\abs{V^c} = \abs{V_{dis}^c}$ and $\abs{V^{cwp}} = \abs{V_{dis}^{cwp}}$ are valid. Therefore, the correction factor $\gamma$ is defined as 
% \begin{align}
%     &\gamma = \ddfrac{\abs{V^p_{dis}}}{\abs{V^p}} = \ddfrac{\abs{V^p_{dis}}}{\abs{V} - \abs{V_{dis}} + \abs{V^p_{dis}}}.
% \end{align}
% For the battery cell domain, $\int_V a \ \dd\mathbf{x} = \sum_i^N a_{dis,i} V_{dis,i}$ is valid because the coupling boundary only lies in the packing material domain. Therefore, $\gamma = 1$ will be used to calculate the average quantity in the battery cell domain. In summary, to reduce the error associated with the computation of the integrand, we introduced a modified averaging operator as 
% \begin{eqnarray}
% \ensmean{a}_Y^* = \ddfrac{1}{\gamma\abs{Y}}\int_Y a \ \dd\mathbf{x},
% \end{eqnarray}
% where 
% \begin{eqnarray}
% \gamma= \begin{cases}
% \ddfrac{\abs{V^p_{dis}}}{\abs{V} - \abs{V_{dis}} + \abs{V^p_{dis}}} , \text{ for } a \equiv T^{p}_\epsilon,\\
% 1, \text{ for } a \equiv T^{c}_\epsilon.
% \end{cases}
% \end{eqnarray}
\subsection{Summary of the hybrid simulation algorithm}

Overall, the hybrid simulation is given by the following steps (Figure~\ref{fig:hybrid_alg}):

\begin{enumerate}
    \item Solve fine-scale equations with {a guess for} flux $q^{\left(p,n\right)}$ from the previous time step 
    \item Calculate average packing materials flux with either Taylor (equations~\eqref{eq:taylor-hc-flux}) or Series (equations~\ref{eq:series-hc-flux}) expansion
    \item Solve upscaled equations with calculated average packing material's flux
    \item Compute average packing temperature with either Taylor (equation~\eqref{eq:taylor-hc-temp}) or Series (equation~\eqref{eq:series-hc-temp}) expansion
    \item Compute the error of average temperature continuity $\mathcal{F}$ at the coupling boundary 
    \begin{align}
    & \mathcal{F} = \ensmean{T^{(p)}} - \ensmean{T_\epsilon^{\left(p\right)}}, 
    \end{align}
    
    \item If $\max(\norm{{\mathcal{F}}}_\infty, \norm{{\mathcal{F}}}_2)  > \epsilon_{tol}$ where $\epsilon_{tol}$ is a defined tolerance, refine the unresolved flux $q^{\left(p,n\right)}$ with a zero-finding algorithm (i.e, Broyden's method) and repeat Step 1-5.
\end{enumerate}


\begin{figure}
\centerline{
 {\includegraphics[width=0.8\textwidth]{figures/Hybrid_flowchart.pdf}}}
\caption{Flow chart of the hybrid algorithm. }
\label{fig:hybrid_alg}
\end{figure}


