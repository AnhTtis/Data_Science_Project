% !TeX root = ../main.tex

\section{Experimental setup}\label{sec:experimental_setup}
\noindent 
In this section, we detail how we set up our measurement device \ac{gwen}, how we configured each \ac{dut}, and how we were able to collect distance measurement data from \ac{uwb} over a USB connection. 

We evaluated each device listed in \cref{tab:available_uwb} in three different environments to see how multipath effects and reflections might change the results.


\subsection{Measurement Setup}\label{ssec:general_setup}


\begin{figure}[!t]
    \centering
    \input{figures/tikz/gwen_measurement_setup.tex}
    \caption{Setup of GWEn with a control PC and a remote device.}\label{fig:GWEn_setup}
\end{figure}


\Cref{fig:GWEn_setup} shows the hardware setup for a typical measurement.
The setup consists of \ac{gwen}, two devices to test, a laptop, and a tripod.
The \ac{dut} is mounted on \ac{gwen}, which is placed on a camera tripod such that the \ac{dut} remains at a height of \SI{80}{\centi\metre}. This height should model the distance of a jeans' pockets to the ground.  
The \ac{dut} has been placed such that its antennas were in the intersection of the rotation axis of \ac{gwen} (see \cref{fig:GWEn_setup_top_view}).
The remote device is mounted on a tripod and a desired distance between them is set. 
The distance between both devices is measured using a laser meter or a measurement tape. 
The arm is set to $\phi=\SI{0}{\degree}$ by using an internal sensor that detects when the motor has rotated to the correct position. The base is aligned such that the tower is located at an angle of \SI{90}{\degree} as shown in \cref{fig:GWEn_setup_top_view}, which we define as $\theta=\SI{0}{\degree}$ (see \cref{fig:GWEn_setup_top_view}).

The rotation axes of \ac{gwen} and according to labels are plotted in \cref{fig:gwen_rotation_axes} and detailed in \cref{sec:gwen}.
For all our experiments \ac{gwen} performs these steps: 
\begin{enumerate}
    \item Start at arm rotation $\phi=\SI{0}{\degree}$ and base rotation $\theta=\SI{0}{\degree}$
    \item Rotate the arm $\phi$ by \SI{10}{\degree} 
    \item When the arm reaches $\phi=\SI{180}{\degree}$, rotate the base $\theta$ by \SI{10}{\degree}
    \item Rotate the arm $\phi$ by \SI{-10}{\degree} 
    \item When the arm reaches $\phi=\SI{0}{\degree}$, rotate the base $\theta$ by \SI{10}{\degree}
    \item Continue with step 2 until the base reaches $\theta=\SI{360}{\degree}$
\end{enumerate}

At each position, we measure the distance and collect the measurements, before \ac{gwen} continues with the next step. 

Each measurement for each pair of devices has been conducted in the same way in the same environments to ensure comparability.
Once the measurement is started all operations for the measurement happen on \ac{gwen} and the external laptop is no longer needed. For \ac{uwb} measurements, the ranging has to be started on the \ac{dut} and the remote device in advance. 

\input{figures/tikz/gwen_setup_top_view.tex}

\paragraph*{Antenna locations}
We identified the location of the \ac{uwb} transmission antenna in smartphones by using an oscilloscope and manually searching for the location with the strongest signal.
All manufacturers placed the antennas close to the rear cameras.
Since they all offer multiple receive antennas to determine the \ac{aoa} the receive antennas are often next to the transmission antenna~\cite{amaldevUWBTechApple2021}. We validated our claims by closely inspecting online device tear-downs~\cite{amaldevUWBTechApple2021,ifixitSamsungGalaxyS212021,dixonIPhone12122020,hughjeffreysPixelProTeardown2021}. All \ac{uwb} antennas are marked in \cref{fig:smartphone_antenna_placement,fig:dw3000_annotated}. 

\begin{figure}[!t]
    \includegraphics[width=\linewidth]{./figures/UWB_Antenna_location.pdf}
    \caption{Left to right: Apple iPhone 12 Pro, Samsung Galaxy S21 Ultra, and Google Pixel 6. Pro. The \ac{uwb} antenna locations are marked in black.}\label{fig:smartphone_antenna_placement}
\end{figure}

\begin{figure}[!t]
    \centering 
    \includegraphics[width=\linewidth]{figures/eval/devices/DW3000_annotated_2.pdf}
    \caption{A DW3000EVB attached to a STM32 Nucleo board.}\label{fig:dw3000_annotated}
\end{figure}

\subsection{Evaluation environments}

\begin{figure*}
    \centering
    \begin{subfigure}[t]{0.32\textwidth}
        \centering
        \includegraphics[width=\textwidth]{figures/environments/outside.jpg}
        \caption{Outside}\label{fig:outside_picture}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.32\textwidth}
        \centering
        \includegraphics[width=\textwidth]{figures/environments/lab.jpg}
        \caption{Lab}\label{fig:lab_picture}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.32\textwidth}
        \centering
        \includegraphics[width=\textwidth]{figures/environments/garage.jpg}
        \caption{Garage}\label{fig:garage_picture}
    \end{subfigure}
    \hfill

    \caption{Our three measurement environments.}\label{fig:environment_pictures}

\end{figure*}

We decided on three environments: outside, our lab, and a parking garage. A photo of each environment is shown in \cref{fig:environment_pictures}.  

\paragraph{Outside}
A location outside with no reflecting objects nearby is a good environment to measure a ground truth with a low amount of multipath interference. The soil-based ground cannot reflect signals well. 
There were no nearby Wi-Fi signals that could have interfered with our measurements.
The only nearby Wi-Fi signal was emitted by \ac{gwen} itself and limited to the \SI{2.4}{\giga \hertz} band, which does not interfere with our tested \ac{uwb} channels. The setup is similar to the one used by~\cite{malajnerUWBRangingAccuracy2015,jimenezComparingDecawaveBespoon2016}. 

\paragraph{Lab} 
Our lab offers a range of difficulties for \ac{uwb} measurements that can also occur in an office environment. Our measurement location was close to a glass whiteboard, several computers, monitors, and office furniture. 
These office environments are likely locations for future application of \ac{uwb}--enabled locks that can replace the need for special key fobs. 

\paragraph{Public parking garage}
A \ac{uwb}-based \ac{pke} system is already deployed in new car models. A parking garage is a natural environment to evaluate this. 
Nearby cars are reflecting \ac{uwb} pulses and might cause collisions between them. Identifying the correct first path might become difficult as demonstrated in~\cite{279984,singhSecurityAnalysisIEEE2021a}. 

\subsection{Device configuration}\label{ssec:dev_conf}
All devices need to be configured in a way that they start measuring the distance using \ac{uwb}. We, therefore, explain the different configuration options and how we initiated the measurements. 
As \ac{uwb} is a rather new technology in consumer devices, there is no fully open \ac{api} available by any smartphone manufacturer, which would have allowed fine-grained configuration of the \ac{uwb} chip. Therefore, the configuration of \ac{uwb} parameters, like channel, preamble, data rate and \ac{sts} may not be changed. In many cases, we were also not able to extract the used parameters after the measurement. 

\paragraph{Apple}
The Apple \textit{NearbyInteraction} framework~\cite{appleinc.NearbyInteractionApplea} can be used by any iOS app and can be configured to measure either the distance to another iPhone, Apple Watch or to a compatible \ac{uwb} third-party chip. We use an \textbf{iPhone 12 Pro} as the \ac{dut} and an \textbf{iPhone 12 mini} as the remote device. Both devices utilize the same generation of Apple's U1 chipset. 

\paragraph{Samsung}
Samsung and Google both implement the \ac{fira} protocol and would be theoretically compatible with the other chipsets and the iPhone. Unfortunately, no documentation on how to initialize ranging with any other device is not available publicly. 

The Samsung Galaxy S21 Ultra that we used for testing comes with an installed \textit{UWBTest} app. This app is hidden and can only be launched by opening the telephone app and typing \texttt{*\#UWBTEST\#} in the phone number field. 
We use this app to run our \ac{uwb} measurements between two Samsung devices because this has been the most reliable option on Android. 
We cannot determine which channel or preamble is used here. A \textbf{Samsung Galaxy S21 Ultras} is used as the \ac{dut} and the remote device.

\paragraph{Google}
So far, there are only the Google Pixel 6 Pro and Pixel 7 Pro available that integrate a \ac{uwb} chip. The only supported feature with \ac{uwb} is Android Nearby Share~\cite{googleinc.HowWeRe2022} and the Android 12 \ac{uwb} API~\cite{googleinc.UltrawidebandUWBCommunication}. 
We developed a small test application that is able to perform \ac{uwb} ranging between compatible Android devices. Unfortunately, this \ac{uwb} API needs up to $10$ and may fail to measure the distance completely. All our measurements are conducted using Android 12. 
We configured the app to use channel 9 and the preamble code 11 for all our measurements. 
A \textbf{Google Pixel 6 Pro} is used as the \ac{dut} and the remote device. Additionally, we also performed all measurements with a \textbf{Samsung Galaxy S21 Ultra} as the remote device. Both measurements are compared in \cref{ssec:different_remote_device}. 


\paragraph{Qorvo}
The Qorvo DWM3000EVB is a board that can be attached to an STM development board. By using the SDK provided by Qorvo, it's possible to write programs that can execute simple ranging measurements. Their sample code already provides most features needed for our evaluation. We configured the devices to use a static \ac{sts} and perform \ac{ds-twr} on channel 9 using preamble code 11. 

\subsection{Measurement result extraction}

Every device that we researched is able to generate results for the measurements and accessing them works differently on every device. As introduced in \cref{sec:gwen}, \ac{gwen} connects to all devices via USB to record measurement data while performing the measurement. We implemented separate parsers for each device that we support. 
If possible, we use raw measurements which are not enhanced by optimization algorithms. 

\paragraph{Apple} Apple devices often use extensive logging but omit sensitive data from the logs. To allow developers to debug their apps, certain logs can be activated using a \textit{debug profile}. We use the \textit{AirTag debug profile} to enable rich logs from \texttt{nearbyd}, a process which handles all \ac{uwb} related tasks~\cite{appleinc.ProfilesLogsBug}. 
With a USB connection to \ac{gwen}, we can fetch the logs and extract relevant measurement data. 
We extract raw measurements, as user-facing distance measurements are enhanced by custom machine learning algorithms.

\paragraph{Samsung} Samsung's devices also offer the option to increase the log verbosity by activating \textit{verbose vendor logging} in the developer settings. Then the smartphone logs all distance measurement data in a raw measurement and a calibrated measurement. Depending on the internal state the calibrated measurement may not be available.
\Ac{gwen} extracts both measurements using the \texttt{adb logcat} command line interface. 

\paragraph{Google} Google's smartphones log the \ac{uwb} distance measurements by default. Unfortunately, the logs are less verbose than Apple's or Samsung's. We, therefore, decide to use a custom logging format.  
We expect that all distance measurements on Google smartphones are raw measurements. Furthermore, we did not find any hints of a specially calibrated result or any machine learning-based enhancements. 

\paragraph{Qorvo} We mounted the DWM3000EVB to an STM32 development board. By programming the STM32 board, we are able to create a serial connection between the board and \ac{gwen}. Two-way communication allows \ac{gwen} to instruct the board to perform new measurements and to receive measurement results from the board. All results are raw results without any calibration. We tested the effect of calibrating the chips briefly, but we could not identify larger differences if compared to not calibrated devices.  