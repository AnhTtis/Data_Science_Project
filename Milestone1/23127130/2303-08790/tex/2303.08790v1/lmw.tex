\documentclass[12pt]{article}
%\pagestyle{empty}
\usepackage{setspace}
%\doublespacing
%\onehalfspacing
\usepackage{longtable}
\usepackage{graphicx}


%% underscore and subscript in verbatim
\usepackage{fancyvrb}
\makeatletter
\newcommand{\m}[1]{%
  \begingroup
  \def\FV@Space{ }% spaces in math are ignored
  \mathcode`\_="8000 % _ is math active
  \do@@us % underscore is subscript
  $#1$%
  \endgroup
}
\newcommand{\do@@us}{%
  \begingroup\lccode`~=`\_ \lowercase{\endgroup\let~}\sb
}
\makeatother

%% break long verbatims
\usepackage{spverbatim}

%rotate figure
\usepackage{lscape}
\usepackage{rotating}
\usepackage{tcolorbox}

\usepackage[section]{placeins}
\usepackage[top=1in, left=1in, right=1in, bottom=1in]{geometry}
\geometry{letterpaper}	% ... or a4paper or a5paper or ...
%\geometry{landscape}	% Activate for for rotated page geometry
\usepackage[parfill]{parskip}	% Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage[export]{adjustbox}
\usepackage{amssymb}
\usepackage{epstopdf}
\DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}
\usepackage{bbm}
\usepackage{bm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsfonts}
\newcommand{\indicator}[1]{\mathbbm{1}_{ {#1} }}
\usepackage{lscape}
\usepackage{enumitem}
\usepackage{rotating}
\usepackage{setspace}
\usepackage{threeparttable}
\usepackage{booktabs}
\usepackage[compact]{titlesec}
\usepackage{lmodern}

\fontfamily{lmtt}\selectfont
%\renewcommand*\familydefault{\sfdefault} % If the base font of the document is to be sans serif
\usepackage[T1]{fontenc}
\newcommand{\argmax}{\arg\!\max}
\newcommand*{\dbar}[1]{\overline{\overline{#1}}}

\usepackage[nocitation]{apacite}
\usepackage{natbib}
\bibpunct{(}{)}{;}{a}{}{,}
\usepackage{hyperref}
\usepackage{titling}
\usepackage{pifont}
\usepackage[capposition=top]{floatrow}
\newcommand{\subtitle}[1]{%
  \posttitle{%
    \par\end{center}
    \begin{center}\large#1\end{center}
    \vskip0.5em}%
}
\usepackage{amsthm}
\usepackage{amsmath} %maths
\usepackage{multirow}

\usepackage{multicol}
\setlength{\columnsep}{0.2cm}

\usepackage{mathrsfs}

\newenvironment{psmallmatrix}
  {\left(\begin{smallmatrix}}  % small matrix
  {\end{smallmatrix}\right)}


\newcommand{\set}[1]{\left\{#1\right\}}                     % Set operator
\newcommand{\abs}[1]{\left|#1\right|}                       % Absolute value
\newcommand{\Pow}[1]{{\cal P}\left(#1\right)}               % Power set
\newcommand{\bra}[1]{\left(#1\right)}
\newcommand{\norm}[1]{\left\lVert#1\right\rVert}
\newcommand\independent{\protect\mathpalette{\protect\independenT}{\perp}}
\def\independenT#1#2{\mathrel{\rlap{$#1#2$}\mkern2mu{#1#2}}}
\newtheorem{theorem}{Theorem}[section]
%\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{lemma}{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{problem}[theorem]{Problem}
\newtheorem{algorithm}[theorem]{Algorithm}
\newtheorem{Assumption}{Assumption}
\def\ci{\perp\!\!\!\perp}

\defcitealias{observational2021observational}{Observational Studies 2021}

\usepackage{mathrsfs}

\usepackage{color}


%% packages for table with equations
\usepackage{array}
\newcolumntype{C}[1]{>{\centering\arraybackslash}m{#1}}
%\newlength\mylen
%\settowidth\mylen{\myrange}
%\usepackage{newtxtext,newtxmath}
\captionsetup[table]{format=plain,
                     labelfont=bf,
                     labelsep=newline,
                     singlelinecheck=false,
                     skip=0pt}




\begin{document}
\pagestyle{plain}



\newtheoremstyle{mystyle}% name
{\topsep}% Space above
{\topsep}% Space below
{\it}% Body font
{}% Indent amount
{\bf}% Theorem head font
{.}%Punctuation after theorem head
{.5em}%Space after theorem head
{}% theorem head spec
\theoremstyle{mystyle}
\newtheorem{assumptionex}{Assumption}
\newenvironment{assumption}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{}\assumptionex}
  {\popQED\endassumptionex}
\newtheorem{assumptionexp}{Assumption}
\newenvironment{assumptionp}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{}\assumptionexp}
  {\popQED\endassumptionexp}
\renewcommand{\theassumptionexp}{\arabic{assumptionexp}$'$}
%\newtheorem{assumptionexpp}{Assumption}
%\newenvironment{assumptionpp}
%  {\pushQED{\qed}\renewcommand{\qedsymbol}{}\assumptionexp}
%  {\popQED\endassumptionexp}
%\renewcommand{\theassumptionexp}{\arabic{assumptionexpp}$''$}

\newtheorem{assumptionexpp}{Assumption}
\newenvironment{assumptionpp}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{}\assumptionexpp}
  {\popQED\endassumptionexpp}
\renewcommand{\theassumptionexpp}{\arabic{assumptionexpp}$''$}

\newtheorem{assumptionexppp}{Assumption}
\newenvironment{assumptionppp}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{}\assumptionexppp}
  {\popQED\endassumptionexppp}
\renewcommand{\theassumptionexppp}{\arabic{assumptionexppp}$'''$}

\renewcommand{\arraystretch}{1.3}

\newcommand{\argmin}{\mathop{\mathrm{argmin}}}
\makeatletter
\newcommand{\grande}{\bBigg@{2.25}}
\newcommand{\enorme}{\bBigg@{5}}

\newcommand{\blind}{0}

\newcommand{\tit}{\Large \texttt{lmw}: Linear Model Weights for Causal Inference}
%\newcommand{\tit}{\Large Linear Model Weights for Causal Inference: A Tutorial}

\if0\blind

{\title{\tit\thanks{We thank Bijan Niknam for helpful commments. This work was supported by the Alfred P. Sloan Foundation (G-2020-13946) and the Patient-Centered
Outcomes Research Institute (PCORI, ME-2022C1-25648).}}
\author{Ambarish Chattopadhyay\thanks{Stanford Data Science, Stanford University, 450 Jane Stanford Way Wallenberg, Stanford, CA 94305; email: \url{hsirabma@stanford.edu}.} \and Noah Greifer\thanks{Institute for Quantitative Social Sciences (IQSS), Harvard University, CGIS Knafel Building, Office K303, 1737 Cambridge Street, Cambridge, MA 02138; emai: \url{ngreifer@iq.harvard.edu.}}
\and Jos\'{e} R. Zubizarreta\thanks{Departments of Health Care Policy, Biostatistics, and Statistics, Harvard University, 180 A Longwood Avenue, Office 307-D, Boston, MA 02115; email: \url{zubizarreta@hcp.med.harvard.edu}.}
}

\date{} 

\maketitle
}\fi

\if1\blind
\title{\bf \tit}
\date{} 
\maketitle
\fi

\begin{abstract}
The linear regression model is widely used in the biomedical and social sciences as well as in policy and business research to adjust for covariates and estimate the average effects of treatments. 
%Under the general rule ``no causation without manipulation,'' b
Behind every causal inference endeavor there is at least a notion of a randomized experiment.
However, in routine regression analyses in observational studies, it is unclear how well the adjustments made by regression approximate key features of randomization experiments, such as covariate balance, study representativeness, sample boundedness, and unweighted sampling. 
In this paper, we provide software to empirically address this question.
In the new \texttt{lmw} package for \texttt{R}, we compute the implied linear model weights for average treatment effects and provide diagnostics for them.
The weights are obtained as part of the design stage of the study; that is, without using outcome information.
The implementation is general and applicable, for instance, in settings with instrumental variables and multi-valued treatments; in essence, in any situation where the linear model is the vehicle for adjustment and estimation of average treatment effects with discrete-valued interventions.
\end{abstract}


%\vspace*{.3in}

\begin{center}
\noindent Keywords:
%\small
{Causal Inference; Linear Models; \texttt{R} Programming Language; Regression Modeling; Observational Studies}
%\normalsize
\end{center}
\clearpage
\doublespacing

\singlespacing
\pagebreak
\tableofcontents
%\pagebreak
\doublespacing

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
\pagebreak
\section{Introduction}

%The linear regression model
%Widely used
%Typical use
%Interpretation
In observational studies, the linear regression model is widely used to estimate the causal effect of a treatment, intervention, or exposure on an outcome variable.
Examples are ubiquitous across the biomedical and social sciences, as well as in policy and business research. 
In common practice, the linear regression model is fitted by least squares, including as explanatory or predictor variables of the outcome a treatment indicator plus a series of control variables or covariates.
The estimated coefficient is interpreted as the average effect of the treatment on the response variable, holding the other predictors constant (e.g., \citealt{angrist2008mostly}, Chapter 3; \citealt{imbens2015causal}, Section 12.2.4).

%The good
%Extensively studied
%Appealing properties
%BLUE
%Easy to use
%Given conventional wisdom, easy to communicate
The linear regression model has been extensively studied.
Among its properties is that the least squares estimator is the best (minimum variance) linear unbiased estimator of the treatment indicator coefficient, provided the model is correctly specified. 
Furthermore, the model is easy to fit and implement in practice, and is broadly accepted across disciplines as a valid method for data analysis.
%Given certain consensuses,
%In conventional wisdom, it is widely accepted and easy to communicate broadly. 
However, when it comes to estimating the causal effect of a treatment, typical use of regression can blur certain notions and principles that are central to causal inference in observational studies.

%The gap
One of them is the idea of approximating or emulating the randomized experiment that would have been conducted under controlled circumstances \citep{dorn1953philosophy, cochran1965planning, rosenbaum2010design1, hernan2016using}. 
Underlying, is the notion of balance, that is, of constructing treatment and control groups that are comparable in terms of confounding factors.
%, in order to isolate the effect of treatment.
Also central is a clear definition of the target population to which the inferences apply.
Finally, another important consideration is the extent to which the estimator extrapolates beyond the region restricted by the observed data and relies on parametric assumptions that are untestable. 
%\citep{robins2007comment}.
In routine practice, it is unclear how linear regression adheres to these principles.

%Matching and weighting
Arguably, other methods for adjustment in observational studies, such as matching and weighting, follow these principles more explicitly than regression in common practice.
For instance, weighting adjusts the treatment and control groups in order to balance their observed covariate distributions, characterizing the target population in an open manner, and producing an estimator that is sample bounded.
Moreover, weighting does not require outcome information to complete the adjustment process.
As argued by \cite{rubin2007design}, this helps to preserve the objectivity and validity of an observational study.

Recently, \cite{chattopadhyay2021implied} offered a connection between weighting and linear regression methods for causal inference.
In particular, they obtained new closed form expressions for the implicit weights in different methods involving the linear regression model.
See \cite{abadie2015comparative}, \cite{imbens2015matching}, \cite{gelman2018high}, and \cite{ben2021augmented} for related analyses.
\cite{chattopadhyay2021implied} examined properties of the implied weights of linear regression in both finite- and large-sample regimes.
In finite samples, they showed that the implied weights of general regression problems can be obtained equivalently by solving a convex optimization problem akin to the stable balancing weights \citep{zubizarreta2015stable}, which involve minimizing the variance of the weights subject to constraints on covariate balance. 
In large samples, they studied multiply robust properties of regression estimators from the perspective of their implied weights. 
Among others, they proposed new regression diagnostics for causal inference that are part of the design stage of an observational study.

%Outline
In this paper, we implement and demonstrate this weighting approach to regression.
In particular, we illustrate the new \emph{linear model weights} \texttt{lmw} package for \texttt{R}, which is freely available on CRAN.
Using it, we explore a number of settings.
For this, in Section 2 we present the notation, estimands, and basic assumptions.
In Section 3, we discuss two regression approaches, termed uni- and multi-regression imputation.
In Section 4, we introduce our running example.
In Section 5, we illustrate the use of the \texttt{lmw} package in settings with binary treatments, multivariate matching, multi-valued treatments, and instrumental variables, explaining step by step the code.

%Contrast to weighting and matching...
%New diagnostics...

%The practice of linear regression in causal inference is different to regression and matching

%We show how it can be used to obtain closed form expressions of the implied weights of linear regression.

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
\section{Setup}
\label{sec_setup}

Consider an observational study based on a random sample of $n$ independent and identically distributed units drawn from a population.
For each unit $i \in \{1,2,...,n\}$, let $A_i$ be their treatment assignment indicator, with $A_i = 1$ if the unit is assigned to treatment, and $A_i = 0$ otherwise; $\bm{X}_i$ be a vector of $k$ observed covariates; and $Y_i$ be the observed outcome.
Define $n_t$ and $n_c$ as the sample sizes of the treatment and control groups, respectively.
Denote $\bar{\bm{X}}_t$ and $\bm{V}_t$, and $\bar{\bm{X}}_c$ and $\bm{V}_c$, as the mean vector and covariance matrix of the covariates in the treatment and control groups, correspondingly.
Write $\bar{\bm{X}}$ for the mean vector of the covariates in the entire sample.

Following the potential outcome framework (\citealt{neyman1923application, rubin1974estimating}), let $Y_i(a)$ be the potential outcome of unit $i$ under treatment $a \in \{0,1\}$ and $Y^{\text{obs}}_i = A_i Y_i(1) + (1-A_i)Y_i(0)$ be their observed outcome. 
In this paper, we are interested in two causal estimands: the average treatment effect $\text{ATE} = \mathbb{E}[Y_i(1) - Y_i(0)]$ and the average treatment effect on the treated $\text{ATT} = \mathbb{E}[Y_i(1) - Y_i(0)|A_i=1]$. 
For identification of these estimands, for the most of this paper we assume the following conditions hold \citep{rosenbaum1983central}: (a) positivity: $0<\Pr(A_i = 1\mid \bm{X}_i = \bm{x})<1$ for all $\bm{x} \in \text{supp}(\bm{X}_i)$, and (b) unconfoundedness: $A_i \ci \{Y_i(0),Y_i(1)\} \mid \bm{X}_i$.

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
\section{Methods}
\label{sec_methods}

Following \cite{chattopadhyay2021implied}, we focus on two common regression modeling approaches. 
In the first approach, the outcome is regressed on the covariates and the treatment indicator without any treatment-covariate interactions, and the average treatment effect is estimated by the coefficient of the treatment indicator. 
This approach is called uni-regression imputation (URI) because it is equivalent to an imputation estimator based on a single (uni) linear outcome model. In the second approach, the outcome is regressed on a similar model that adds treatment-covariate interactions. 
This approach is called multi-regression imputation (MRI) because it is equivalent to an imputation estimator based on two (multi) linear outcome models, one fitted in each treatment group.

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
\subsection{Uni-regression imputation}
\label{sec_methods_URI}
URI is arguably the most commonly used method for regression adjustments in observational studies (\citealt{aronow2016does}, \citealt{angrist2008mostly} Chapter 3). 
%In URI, the outcome is regressed linearly on the covariates and the treatment indicator in the study sample, and the ATE is estimated by the coefficient of the treatment indicator. 
The URI estimator of the ATE is $\hat{\tau}^{\scriptscriptstyle\text{OLS}}$, the ordinary least squares (OLS) estimator of $\tau$ in the model $Y^{\text{obs}}_{i} = \beta_0 + \bm{\beta}^\top_1 \bm{X}_i + \tau A_i + \epsilon_i$. Implementations of URI and associated inferences are straightforward and can be done using, e.g., the \texttt{lm} function in \texttt{R}. 
% underlying causal models
However, standard software implementations do not make clear how faithfully URI designs an observational study in terms of approximating features of randomized experiments. 

To address this concern, we consider the implied weighting framework of \cite{chattopadhyay2021implied}. This framework represents the URI estimator as a weighting estimator, i.e., $\hat{\tau}^{{\scriptscriptstyle \text{OLS}}}=  \sum_{i:A_i=1}w^{{\scriptscriptstyle \text{URI}}}_i Y^{\text{obs}}_i - \sum_{i:A_i=0}w^{{\scriptscriptstyle \text{URI}}}_i Y^{\text{obs}}_i$, where $w^{{\scriptscriptstyle \text{URI}}}_i = \frac{1}{n_t} + (\bm{X}_i  -\bar{\bm{X}}_t)^\top (n_t\bm{V}_t + n_c\bm{V}_c)^{-1} (\bar{\bm{X}}_c - \bar{\bm{X}}_t)$ if unit $i$ is in the treatment group and $w^{{\scriptscriptstyle \text{URI}}}_i = \frac{1}{n_c} + (\bm{X}_i  -\bar{\bm{X}}_c)^\top (n_t\bm{V}_t + n_c\bm{V}_c)^{-1} (\bar{\bm{X}}_t - \bar{\bm{X}}_c)$ if unit $i$ is in the control group. The weights $w^{{\scriptscriptstyle \text{URI}}}_i$ sum to one within each group and, moreover, are functions of the covariates and treatment but not the outcome. Thus, these implied weights make precise how URI acts on treated and control units in the sample without using outcome information. As a result, we can characterize in finite samples the adjustments under URI in terms of covariate balance, study representativeness, model extrapolation, and weight dispersion. 

In particular, the URI weights exactly balance the means of the covariates, but towards a population that is different from the ``natural'' populations corresponding to treated population, the control population, or the overall study population, i.e., $\sum_{i:A_i=1} w^{{\scriptscriptstyle \text{URI}}}_i \bm{X}_i = \sum_{i:A_i=0} w^{{\scriptscriptstyle \text{URI}}}_i \bm{X}_i = \bm{X}^{*{\scriptscriptstyle \text{URI}}}:= n_c\bm{V}_c(n_t\bm{V}_t + n_c\bm{V}_c)^{-1} \bar{\bm{X}}_t + n_t\bm{V}_t (n_t\bm{V}_t + n_c\bm{V}_c)^{-1} \bar{\bm{X}}_c$. Also, the URI weights can be negative, which may lead to extrapolation beyond the support of the observed data. Finally, the URI weights are optimal in that they are the weights of minimum variance that sum to one and exactly balance the means of the covariates towards the profile $\bm{X}^{*{\scriptscriptstyle \text{URI}}}$. 

%$\bm{X}^{*{\scriptscriptstyle \text{URI}}}$

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
\subsection{Multi-regression imputation}
\label{sec_methods_MRI}

MRI is another widely used method for regression adjustments in observational studies, also known as g-computation or regression estimation in the causal inference literature (\citealt{hernan2020causal}, \citealt{schaferAverageCausalEffects2008}). 
%In MRI, the outcome is regressed linearly on the covariates, the treatment indicator, and the interactions between the treatment and the (centered) covariates. Equivalently, 
In MRI, we fit a linear regression model $Y^{\text{obs}}_i = \beta_{0t} + \bm{\beta}^\top_{1t} \bm{X}_i + \epsilon_{it}$ in the treatment group and a separate linear regression model $Y^{\text{obs}}_i = \beta_{0c} + \bm{\beta}^\top_{1c} \bm{X}_i + \epsilon_{ic}$ in the control group using OLS. The MRI estimators of the ATE and the ATT are then $\widehat{\text{ATE}} = \frac{1}{n}\sum_{i=1}^{n} (\hat{\beta}_{0t} + \hat{\bm{\beta}}^\top_{1t} \bm{X}_i) - \frac{1}{n}\sum_{i=1}^{n} (\hat{\beta}_{0c} + \hat{\bm{\beta}}^\top_{1c} \bm{X}_i)$ and $\widehat{\text{ATT}} = \frac{1}{n}\sum_{i:A_i=1}^{n} Y^{\text{obs}}_i - \frac{1}{n_t}\sum_{i:A_i=1} (\hat{\beta}_{0c} + \hat{\bm{\beta}}^\top_{1c} \bm{X}_i)$.

Using the implied weighting framework, we can represent the MRI estimators for the estimands of interest as weighting estimators, i.e., $\widehat{\text{ATE}} = \sum_{i:A_i=1}w^{{\scriptscriptstyle \text{MRI}}}_i Y^{\text{obs}}_i - \sum_{i:A_i=0}w^{{\scriptscriptstyle \text{MRI}}}_i Y^{\text{obs}}_i$ and $\widehat{\text{ATT}} = \sum_{i:A_i=1}w^{{\scriptscriptstyle \text{MRI}}}_i Y^{\text{obs}}_i - \sum_{i:A_i=0}w^{{\scriptscriptstyle \text{MRI}}}_i Y^{\text{obs}}_i$, where the weights sum to one within each group. 
For the ATE, $w^{{\scriptscriptstyle \text{MRI}}}_i = \frac{1}{n_t}\{1 + (\bm{X}_i -\bar{\bm{X}}_t)^\top \bm{V}_t^{-1} (\bar{\bm{X}} - \bar{\bm{X}}_t)\}$ if unit $i$ is treated and $w^{{\scriptscriptstyle \text{MRI}}}_i = \frac{1}{n_c}\{1 + (\bm{X}_i -\bar{\bm{X}}_c)^\top \bm{V}_c^{-1} (\bar{\bm{X}} - \bar{\bm{X}}_c)\}$ otherwise. 
For the ATT, $w^{{\scriptscriptstyle \text{MRI}}}_i = \frac{1}{n_t}$ if unit $i$ is treated and $w^{{\scriptscriptstyle \text{MRI}}}_i = \frac{1}{n_c}\{1 + (\bm{X}_i -\bar{\bm{X}}_c)^\top \bm{V}_c^{-1} (\bar{\bm{X}}_t - \bar{\bm{X}}_c)\}$ otherwise. Similar to URI, the MRI weights do not depend on the outcome, so they can also be obtained in the design stage of a causal study. Specifically, the MRI weights exactly balance the means of the covariates, but unlike the URI weights, they balance them toward the intended target populations. 
That is, $\sum_{i:A_i=1} w^{{\scriptscriptstyle \text{MRI}}}_i \bm{X}_i = \sum_{i:A_i=0} w^{{\scriptscriptstyle \text{MRI}}}_i \bm{X}_i = \bm{X}^{*{\scriptscriptstyle \text{MRI}}}$ where $\bm{X}^{*{\scriptscriptstyle \text{MRI}}}$ equals  $\bar{\bm{X}}$ and $\bar{\bm{X}}_t$ when the estimand is the ATE and the ATT, respectively. 
Further, the MRI weights the weights of minimum variance that sum to one and exactly balance the means of the covariates towards the profile $\bm{X}^{*{\scriptscriptstyle \text{MRI}}}$. 
Finally, similar to URI, the MRI weights can take negative values, leading to possible extrapolation beyond the support of the observed data. 

In large samples, both URI and MRI weights converge to inverse probability weights, albeit under stringent assumptions on the treatment assignment process. Moreover, leveraging this convergence, the URI and MRI estimators can be shown to be multiply robust under conditions for the true treatment and outcome models. See \cite{chattopadhyay2021implied} for details.

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
\subsection{Extensions}
\label{sec_methods_extensions}

The implied weighting framework applies to regression estimators in more general settings, such as those with multi-valued treatments and instrumental variables. 
First, consider a multi-valued treatment taking values in a finite set $\mathcal{A}$ of treatment levels. Without loss of generality, let the estimand be $\text{ATE}_{a,1} := \mathbb{E}[Y_i(a) - Y_i(1)]$, $a \in \{2,...,|\mathcal{A}|\}$, i.e., the average treatment effect of level $a$ (the active level) over level $1$ (the reference level). The MRI approach fits separate linear regression models in the groups $A_i = a$ and $A_i=1$ and hence, the MRI weights and their properties for binary treatment settings directly apply to this setting. The URI approach fits the model $Y^{\textrm{obs}}_i = \beta_0 + \bm{\beta}^\top_1 \bm{X}_i + \sum_{a=2}^{|\mathcal{A}|}\tau_{a,1} \mathbbm{1}(A_i=a) + \epsilon_i $ and estimates $\text{ATE}_{a,1}$ by $\hat{\tau}^{\scriptscriptstyle\text{OLS}}_{a,1}$. This estimator admits the weighting representation $\hat{\tau}^{\scriptscriptstyle \text{OLS}}_{a,1} = \sum_{i:A_i=a}w^{{\scriptscriptstyle \textrm{URI}}}_{i,a,1} Y^{\textrm{obs}}_i - \sum_{A_i \neq a} w^{{\scriptscriptstyle \textrm{URI}}}_{i,a,1} Y^{\textrm{obs}}_i$, where the weights $w^{{\scriptscriptstyle \textrm{URI}}}_{i,a,1}$ sum to one within the groups $A_i = a$ and $A_i \neq a$. In general, the URI weights may be non-zero for units in groups other than groups $a$ and $1$. 
That is, other treatment groups besides $a$ and $1$ have a say in the contrast between groups $a$ and $1$.
In fact, when estimating $\text{ATE}_{a,1}$, URI borrows strength from all the treatment groups using linearity. Finally, while the weights exactly balance the means of the covariates between groups $A_i = a$ and $A_i \neq a$, the implied target population under URI varies with the active treatment level $a$ (that is, it varies within the same fitted model), and in general, none of these populations match the overall study population. 

% iv
Second, consider an instrumental variable (IV) setting with a binary instrument $Z_i$, which takes the value $Z_i = 1$ if unit $i$ is encouraged to receive treatment, and $Z_i = 0$ otherwise. A common method to estimate the effect of treatment in this setting is two-stage least squares (2SLS) regression. In the first stage of 2SLS, one fits the regression model $A_i = \delta_0 + \bm{\delta}^\top_1 \bm{X}_i + \gamma Z_i + \epsilon_i$ using OLS. In the second stage, one uses $\hat{A}_i$, the predicted values of $A_i$ from the first stage, to fit the regression model $Y^{\textrm{obs}}_i = \alpha_0 + \bm{\alpha}^\top_1 \bm{X}_i + \tau \hat{A}_i + \eta_i$ again using OLS. The 2SLS estimator is $\hat{\tau}^{\scriptscriptstyle\text{2SLS}}$, the estimator of $\tau$ from the second stage regression. Using the implied weighting framework, $\hat{\tau}^{\scriptscriptstyle\text{2SLS}}$ can also be represented as a weighting estimator: 
$\hat{\tau}^{{\scriptscriptstyle \text{2SLS}}} = \sum_{i:A_i=1} w^{{\scriptscriptstyle \textrm{2SLS}}}_i Y^{\textrm{obs}}_i - \sum_{i:A_i=0} w^{{\scriptscriptstyle \textrm{2SLS}}}_i Y^{\textrm{obs}}_i$, where the weights $w^{{\scriptscriptstyle \textrm{2SLS}}}_i$ sum to one within each treatment group and depend only on the covariates, treatment, and the instrument. Similar to the URI and MRI weights, the 2SLS weights exactly balance the means of the covariates. Moreover, these weights allow us to explicitly characterize the implied target populations of 2SLS regression in finite samples. In general, the implied population of 2SLS differs from the treated, control, or the overall study population, which is why the 2SLS estimand, the local average treatment effect (LATE), often differs from the true ATE. Finally, the weights under 2SLS can be negative and, in fact, such negative weights occur more frequently in this setting than under URI (\citealt{chattopadhyay2021implied_v2, chattopadhyay2022new}).

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
\section{Data}
\label{sec_data}

To illustrate the \texttt{lmw} package, we use as a running example a part of the famous Lalonde observational study (\citealt{lalonde1986evaluating}). The study evaluates the effect of a labor training program 
(the National Supported Work Demonstration) on future earnings. In our analysis, the treatment group corresponds to a subset of $n_t = 185$ units enrolled in the program from the Lalonde experimental study \citep{dehejia1999causal}, and the control group corresponds to a subset of $n_c = 2490$ non-experimental units from the Population Survey of Income Dynamics (PSID). The dataset can be downloaded from \url{https://users.nber.org/~rdehejia/data/.nswdata2.html}.
There are $k=7$ baseline covariates: \texttt{age} (age in years), \texttt{education} (years of education), \texttt{race} (Black, Hispanic, and White), \texttt{married} (indicator for married status), \texttt{nodegree} (indicator for high school dropout), \texttt{re74} (earnings in 1974), and \texttt{re75} (earnings in 1975). The outcome variable of interest is \texttt{re78} (earnings in 1978). The standard estimand in this study is the ATT, i.e., the average effect of the training program on the earnings of subjects who are part of the program. However, for illustration, we also consider estimating the ATE.

% multi-treatment categories
In addition, we use the covariate data to generate an artificial multi-valued treatment with three levels. We label the original treatment group as group 1 and split the original control group into two groups: group 2 (of size 901) and group 3 (of size 1589) based on the logistic regression model $\text{logit}\{P(A_i = 3|\bm{X}_i, A_i \neq 1)\} = 1 - \texttt{age} + 1.2 \times  \texttt{education} - \texttt{black} + 1.2 \times \texttt{re75}$. We also generate an artificial binary instrument $Z_i$ based on the logistic regression model $\text{logit}\{P(Z_i = 1|\bm{X}_i, A_i \neq 1)\} = 1 - \texttt{age}  + 0.5 \times \texttt{education} - 0.5 \times \texttt{hispanic} + 0.8 \times \text{black} + 0.8 \times \texttt{re74} + 3 \times \mathbbm{1}(A_i=1)$. The generated instrument, by construction, has a significant partial correlation with treatment after adjusting for the covariates. Also, the instrument passes a pseudo-outcome-based heuristic test for the assumptions of exclusion restriction and independence with unobserved covariates (see \citealt{baiocchi2014instrumental}). 

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
\section{Using \texttt{lmw}}

Although the usual target estimand with the Lalonde data is the ATT, here we target the ATE to demonstrate the features of \texttt{lmw} that can be used to diagnose balance, representativeness, and extrapolation. We will follow with an example targeting the ATT, an example using a multi-valued treatment, and an example using 2SLS with an instrumental variable.

The primary function of the \texttt{lmw} package is \texttt{lmw()}, which computes the implied regression weights. The syntax of \texttt{lmw()} is very similar to the linear modeling function \texttt{lm()}, with a few adjustments.

\singlespacing
\begin{verbatim}
lmw_out <- lmw(~ A + X1 + X2 + X3, data = dataset,
               estimand = "ATE", method = "URI",
               treat = "A")
\end{verbatim}
\doublespacing

The first argument specifies the regression model formula, with the treatment and covariates on the right-hand-side of \texttt{\~}. Unlike with \texttt{lm()}, an outcome does not need to be specified because the linear regression weights do not depend on the outcome; this allows for the preservation of the distinction between the design and analyses stages, where the outcome is not involved until the final step of estimating the treatment effect. The second argument, \texttt{data}, specifies the dataset containing the variables in the model formula. The \texttt{estimand} argument specifies the desired target estimand for the analysis. The \texttt{method} argument specifies whether URI or MRI is to be used. Finally, the \texttt{treat} argument specifies which variable in the model formula is to be regarded as the treatment variable; if omitted, the first variable is assumed to be the treatment. \texttt{lmw()} has several other arguments for more advanced uses that will be discussed later.

\subsection{URI for the ATE}
Below is an example of using \texttt{lmw()} to compute the URI weights for the Lalonde dataset. After running \texttt{lmw()}, the output is printed, displaying a summary of the resulting \texttt{lmw} object.

\singlespacing
\begin{verbatim}
lmw_ate_out <- lmw(~ treat + age + education + married + race + 
                     nodegree + re74 + re75, data = lalonde,
                   estimand = "ATE", method = "URI", treat = "treat")
lmw_ate_out

## An lmw object
##  - treatment: treat (2 levels)
##  - method: URI (uni-regression imputation)
##  - number of obs.: 2675
##  - sampling weights: none
##  - base weights: none
##  - target estimand: ATE
##  - covariates: age, education, married, race, nodegree, re74, re75
\end{verbatim}
\doublespacing
The next step is to run \texttt{summary()} on the resulting object to examine the balance and representativeness of the sample weighted by the regression weights.

\singlespacing
\begin{verbatim}
lmw_ate_sum <- summary(lmw_ate_out)
lmw_ate_sum
## 
## Call:
## lmw(formula = ~ treat + age + education + married + race + nodegree + 
##     re74 + re75, data = lalonde, estimand = "ATE", method = "URI", 
##     treat = "treat")
## 
## Summary of Balance for Unweighted Data:
##                 SMD TSMD Control TSMD Treated    KS TKS Control TKS Treated
## age          -1.009        0.070       -0.940 0.377       0.026       0.351
## education    -0.681        0.047       -0.633 0.403       0.028       0.375
## married      -1.845        0.128       -1.718 0.677       0.047       0.630
## raceblack     1.482       -0.102        1.379 0.593       0.041       0.552
## racehispanic  0.129       -0.009        0.120 0.027       0.002       0.025
## racewhite    -1.625        0.112       -1.512 0.620       0.043       0.577
## nodegree      0.880       -0.061        0.820 0.403       0.028       0.375
## re74         -1.718        0.119       -1.599 0.729       0.050       0.679
## re75         -1.774        0.123       -1.652 0.774       0.054       0.720
## 
## Summary of Balance for Weighted Data:
##              SMD TSMD Control TSMD Treated    KS TKS Control TKS Treated
## age            0       -0.891       -0.891 0.127       0.350       0.332
## education      0       -0.615       -0.615 0.081       0.352       0.352
## married        0       -1.574       -1.574 0.000       0.578       0.578
## raceblack      0        1.338        1.338 0.000       0.535       0.535
## racehispanic   0        0.129        0.129 0.000       0.027       0.027
## racewhite      0       -1.474       -1.474 0.000       0.562       0.562
## nodegree       0        0.769        0.769 0.000       0.352       0.352
## re74           0       -1.578       -1.578 0.578       0.528       0.665
## re75           0       -1.636       -1.636 0.566       0.523       0.711
## 
## Effective Sample Sizes:
##          Control Treated
## All       2490.    185. 
## Weighted   367.3   180.6
\end{verbatim}
\doublespacing
\texttt{summary()} produces two tables, one containing balance statistics for the original unweighted sample and one containing balance statistics for the sample weighted by the regression weights. Each row corresponds to a covariate and each column is a balance statistic. The statistics include \texttt{SMD}, the standardized mean difference (SMD) of the covariate between the treatment and control groups; \texttt{TSMD Control} and \texttt{TSMD Treated}, the SMD between each treatment group and the target population implied by the target estimand (in this case is the full sample because \texttt{estimand} was set to \texttt{"ATE"}; see \citealt{chattopadhyay2020balancing} for details); and the corresponding values of the Kolmogorv-Smirnov (KS) statistics. The \texttt{addlvariables} argument can be supplied with the names of additional variables or terms (e.g., transformations of the covariates or interactions between them) to assess balance on them in addition to the variables used in the model. The effective sample size (ESS) represents the approximate size of an unweighted sample that contains the same precision as the weighted sample in question for estimating a counterfactual mean.

One can also use \texttt{plot()} on the \texttt{summary()} output to produce a visualization of the resulting balance. The plot can be customized to display difference balance statistics, add threshold lines, and change the order of the covariates.

\singlespacing
\begin{verbatim}
plot(lmw_ate_sum)
\end{verbatim}
\doublespacing

\begin{figure}[H]
    \centering
    \includegraphics[width=4.5in]{graphics/lmw_plot1.jpeg}
\end{figure}

The first table in the \texttt{summary()} output reveals several imbalances between the treatment groups and between each treatment group and the target population before adjustments, as indicated by the high SMDs and KS statistics, especially for the treated group; these are also indicated by the crosses ($\times$) in the plot. After applying the regression weights, the SMDs are equal to 0 for all covariates, indicating good covariate balance between the treatment groups (though some of the KS statistics remain high). However, the target imbalance is severe, even more so than prior to adjustment by the regression weights, as indicated by the TSMD and TKS statistics and the black circles in the plots. In particular, target imbalance for the control group becomes much worse than it was prior to weighting, while target imbalance for the treated group barely changed. The distribution of the covariates in the resulting weighted sample can be summarized using \texttt{summary()} with the additional argument \texttt{stat = "distribution"}:

\singlespacing
\begin{footnotesize}
\begin{verbatim}
summary(lmw_ate_out, stat = "distribution")

## Call:
## lmw(formula = ~ treat + age + education + married + race + nodegree + 
##     re74 + re75, data = lalonde, estimand = "ATE", method = "URI", 
##     treat = "treat")
## 
## Distribution Summary for Unweighted Data:
##              Mean Overall  SD Overall Mean Control  SD Control Mean Treated SD Treated
## age                34.226    (10.500)       34.851    (10.441)       25.816    (7.155)
## education          11.994     (3.054)       12.117     (3.082)       10.346    (2.011)
## married             0.819     (0.385)        0.866     (0.340)        0.189    (0.392)
## raceblack           0.292     (0.454)        0.251     (0.433)        0.843    (0.364)
## racehispanic        0.034     (0.182)        0.033     (0.177)        0.059    (0.236)
## racewhite           0.674     (0.469)        0.717     (0.451)        0.097    (0.296)
## nodegree            0.333     (0.471)        0.305     (0.461)        0.708    (0.455)
## re74            18230.003 (13722.252)    19428.746 (13406.877)     2095.574 (4886.620)
## re75            17850.894 (13877.777)    19063.338 (13596.955)     1532.055 (3219.251)
## 
## Distribution Summary for Weighted Data:
##              Mean Target   SD Target Mean Control  SD Control Mean Treated SD Treated
## age               34.226    (10.500)       26.247     (6.071)       26.247    (7.283)
## education         11.994     (3.054)       10.394     (2.821)       10.394    (2.053)
## married            0.819     (0.385)        0.242     (0.428)        0.242    (0.428)
## raceblack          0.292     (0.454)        0.827     (0.378)        0.827    (0.378)
## racehispanic       0.034     (0.182)        0.061     (0.240)        0.061    (0.240)
## racewhite          0.674     (0.469)        0.112     (0.315)        0.112    (0.315)
## nodegree           0.333     (0.471)        0.685     (0.465)        0.685    (0.465)
## re74           18230.003 (13722.252)     2310.339 (19516.079)     2310.339 (5243.971)
## re75           17850.894 (13877.777)     1690.432 (20103.272)     1690.432 (3525.011)
##
## Effective Sample Sizes:
##          Control Treated
## All       2490.    185. 
## Weighted   367.3   180.6
\end{verbatim}
\end{footnotesize}
\doublespacing

The first table contains the mean and standard deviation of each covariate in the full sample and each treatment group prior to weighting, and the second table contains the mean and standard deviation of each covariate in the target population and in the treatment groups after weighting. The severe target imbalances are apparent in this table. For example, the mean of age in the target population is approximately 34 years, while in the sample weighted by the regression weights, the mean of age is approximately 26 years. The proportion of married subjects in the target population is approximately 82\%, and in the weighted sample is 24\%. These extreme imbalances demonstrate that the population implied by the URI weights is not representative of the population that the ATE intends to target.

Using \texttt{plot()} directly on the \texttt{lmw} output object provides additional insight into the distribution of the weights. The \texttt{type} argument can be used to select which among three types of plots to display; we consider the extrapolation plot (\texttt{type = "extrapolation"}) here and the other two later.

\singlespacing
\begin{verbatim}
plot(lmw_ate_out, type = "extrapolation",
     var = ~ age + married + re74)
\end{verbatim}
\doublespacing

\begin{figure}[H]
    \centering
    \includegraphics[width=4.5in]{graphics/lmw_plot2.jpeg}
\end{figure}

The extrapolation plot displays how the weights distribute by the covariates listed in \texttt{var}. The vertical line indicates the mean of the covariate in each treatment group after weighting, and the cross ($\times$) indicates the mean of the covariate in the target population. Each point represents an observation, with black and red points indicating units with positive and negative weights, respectively, and the size of each point reflecting the magnitude of its weight. From this plot it is apparent that the covariate means in the treatment groups do not align with the means in the target population, and extrapolation is fairly severe given the preponderance of negative weights (red points). Negative weights often yield poor balance on components of the covariate distribution not directly targeted by the model; this can be seen in the high KS statistics in the weighted sample even while the SMDs are 0.

Given the severe target imbalance and extrapolation induced by using URI to estimate the ATE, one has a few options. First, one can attempt to use other methods that retain the target estimand, such as MRI or other weighting or matching methods (possibly in combination with MRI or URI). Second, one can change the target estimand of interest to one that is better supported by the data, though this choice should be determined primarily by substantive considerations (see \cite{greifer2021choosing}). We use both of these approaches below, changing the target estimand to the studyâ€™s more natural estimand, the ATT, and investigating the performance of MRI and an initial matching step to reduce extrapolation and dependence on the outcome model.

\subsection{MRI for the ATT}
Below, we use the MRI to target the ATT. The call to \texttt{lmw()} is almost identical, except this time we set \texttt{method = "MRI"} and  \texttt{estimand = "ATT"}:

\singlespacing
\begin{verbatim}
lmw_att_out <- lmw(~ treat + age + education + married + race + 
                     nodegree + re74 + re75, data = lalonde,
                     estimand = "ATT", method = "MRI", treat = "treat")
lmw_att_out
## An lmw object
##  - treatment: treat (2 levels)
##  - method:  MRI (multi-regression imputation)
##  - number of obs.: 2675
##  - sampling weights: none
##  - base weights: none
##  - target estimand: ATT
##  - covariates: age, education, married, race, nodegree, re74, re75
\end{verbatim}
\doublespacing

The model formula is interpreted slightly differently when using MRI than when using URI. With URI, the model formula corresponds exactly to the linear model that a user would fit, e.g., using \texttt{lm()}; with MRI, the model formula simply indicates the terms that will be fit in the linear model separately for each treatment group, and the treatment variable can be omitted (but still must be specified in the treat argument).

After computing the weights, target balance can be assessed using \texttt{summary()}:

\singlespacing
\begin{verbatim}
lmw_att_sum <- summary(lmw_att_out)
lmw_att_sum
## 
## Call:
## lmw(formula = ~treat + age + education + married + race + nodegree + 
##     re74 + re75, data = lalonde, estimand = "ATT", method = "MRI", 
##     treat = "treat")
## 
## Summary of Balance for Unweighted Data:
##                 SMD TSMD Control TSMD Treated    KS TKS Control TKS Treated
## age          -1.263        1.263            0 0.377       0.377           0
## education    -0.881        0.881            0 0.403       0.403           0
## married      -1.729        1.729            0 0.677       0.677           0
## raceblack     1.630       -1.630            0 0.593       0.593           0
## racehispanic  0.114       -0.114            0 0.027       0.027           0
## racewhite    -2.091        2.091            0 0.620       0.620           0
## nodegree      0.886       -0.886            0 0.403       0.403           0
## re74         -3.547        3.547            0 0.729       0.729           0
## re75         -5.446        5.446            0 0.774       0.774           0
## 
## Summary of Balance for Weighted Data:
##              SMD TSMD Control TSMD Treated    KS TKS Control TKS Treated
## age            0            0            0 0.144       0.144           0
## education      0            0            0 0.085       0.085           0
## married        0            0            0 0.000       0.000           0
## raceblack      0            0            0 0.000       0.000           0
## racehispanic   0            0            0 0.000       0.000           0
## racewhite      0            0            0 0.000       0.000           0
## nodegree       0            0            0 0.000       0.000           0
## re74           0            0            0 0.593       0.593           0
## re75           0            0            0 0.579       0.579           0
## 
## Effective Sample Sizes:
##          Control Treated
## All      2490.       185
## Weighted  333.61     185

plot(lmw_att_sum)
\end{verbatim}
\doublespacing

\begin{figure}[H]
    \centering
    \includegraphics[width=4.5in]{graphics/lmw_plot3.jpeg}
\end{figure}

This time, the SMDs and target SMDs after weighting by the MRI weights are all exactly equal to 0, indicating that the requested target population is being targeted accurately (in this case, the treated group, as indicated by the TSMDs for the treated group prior to weighting). Some imbalances remain on features of the covariate distributions beyond the means, however, as indicated by the high KS statistics. The linearity of the model is not able to account for imbalances in the whole covariate distribution, despite perfectly balancing the means. Such imbalances can be particularly severe in the presence of negative weights.

We can use \texttt{plot()} with the argument \texttt{type = "weights"} to examine the distribution of the weights and, in particular, to examine the presence of negative weights.

\singlespacing
\begin{verbatim}
plot(lmw_att_out, type = "weights")
\end{verbatim}
\doublespacing

\begin{figure}[H]
    \centering
    \includegraphics[width=4.5in]{graphics/lmw_plot4.jpeg}
\end{figure}

The upper plot displays the distribution of the weights for the control group (the treated group weights are all equal to 1). The distribution is depicted using a kernel density plot and a rug plot, with the vertical red line indicating the average of the weights (which is equal to the inverse of the control group sample size, i.e., $1/2490$). This plot indicates significant extrapolation given that a large share of the weights distribution takes values less than 0 and with somewhat high magnitude. The high variability of the weights is reflected in the low ESS (334) compared to the original sample size.

As before, one can request an extrapolation plot to further examine the extent of extrapolation using \texttt{plot()} with \texttt{type = "extrapolation"}:

\singlespacing
\begin{verbatim}
plot(lmw_att_out, type = "extrapolation",
     var = ~age + married + re74)
\end{verbatim}
\doublespacing

\begin{figure}[H]
    \centering
    \includegraphics[width=4.5in]{graphics/lmw_plot5.jpeg}
\end{figure}

These plots indicate somewhat severe extrapolation based on the parts of the distributions with negative weights (red circles). This time, though, the vertical black lines (indicating the weighted covariate means) align exactly with the covariate means in the target population.

Finally, one can estimate the potential outcome means and the treatment effect using \texttt{lmw\_est()}, which fits the linear model specified in the \texttt{lmw} object. To do so, the outcome variable must be supplied to the \texttt{outcome} argument. The output of \texttt{lmw\_est()} contains the fitted model, but to compute the effect estimate and its standard error, \texttt{summary()} must be called on the resulting output.

\singlespacing
\begin{Verbatim}[commandchars=\\\{\}]
lmw_att_est <- lmw_est(lmw_att_out, outcome = re78)
lmw_att_est
## An lmw_est object
##  - outcome: re78 
##  - standard errors: robust (HC3) 
##  - estimand: ATT 
##  - method: MRI 
## 
## Use summary() to examine estimates, standard errors, p-values,
## and confidence intervals.
summary(lmw_att_est)
## 
## Effect estimates:
##              Estimate Std. Error 95% CI L 95% CI U t value Pr(>|t|)
## {E[\m{\text{Y\textsubscript{1}-Y\textsubscript{0}}}|A=1]}    790.5      793.7   -765.7   2346.8   0.996    0.319
## 
## Residual standard error: 10060 on 2657 degrees of freedom
## 
## Potential outcome means:
##           Estimate Std. Error 95% CI L 95% CI U t value Pr(>|t|)    
## E[\m{\text{Y\textsubscript{0}}}|A=1]   5558.6      520.6   4537.8   6579.4   10.68   <2e-16 ***
## E[\m{\text{Y\textsubscript{1}}}|A=1]   6349.1      599.1   5174.5   7523.8   10.60   <2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{Verbatim}
\doublespacing







By default, \texttt{lmw\_est()} applies HC3 robust standard errors to the outcome model parameters; this behavior can be controlled using the \texttt{robust} argument. The \texttt{summary()} output displays potential outcome means estimates of \$6349 for the treated group and \$5558 for the control group, yielding an ATT of \$791 (SE: \$794, 95\% CI: (-767, 2347), p = .319). 
When URI is used, the potential outcome means will not be displayed because they are not estimated by the outcome model directly; only the treatment effect is.

A common concern in weighting is that estimates may be dominated by a handful of observations, in particular for continuous outcomes such as earnings. The influence of individual observations can be assessed using the sample influence curve (SIC), which is a function of the implied regression weights, residuals, and hat values for the fitted outcome model. The \texttt{influence()} function can be used on \texttt{lmw} or \texttt{lmw\_est} objects to produce the usual measures of influence (hat values and residuals) and SIC values. These can be plotted by using \texttt{plot()} with \texttt{type = "influence"}, which displays SIC values by ID, highlighting the most influential cases.

\singlespacing
\begin{verbatim}
plot(lmw_att_est, type = "influence")
\end{verbatim}
\doublespacing

\begin{figure}[H]
    \centering
    \includegraphics[width=4.5in]{graphics/lmw_plot6.jpeg}
\end{figure}

\subsection{MRI after matching for the ATT}
Performing regression after matching (e.g., propensity score matching) or weighting (e.g., inverse probability weighting) can reduce residual imbalances and extrapolation and add robustness to the effect estimate (i.e., robustness to misspecification of the outcome model). \texttt{lmw()} accepts a \texttt{base.weights} argument to incorporate balancing weights into the regression model for the outcome. When \texttt{base.weights} is supplied, the \texttt{dr.method} argument can be set to \texttt{"WLS"} to perform weighted least squares regression in the weighted sample or \texttt{"AIPW"} to perform augmented inverse probability weighting using the weights and outcome model; \texttt{"WLS"} is the default. \texttt{lmw} also provides direct compatibility with the \texttt{MatchIt} and \texttt{WeightIt} packages for matching and weighting, respectively; the user can supply the output of a call to \texttt{MatchIt::matchit()} or \texttt{WeightIt::weightit()} to the \texttt{obj} argument of \texttt{lmw()}, which will extract the weights and estimand.

Below, we use an initial matching step to attempt to balance the covariates prior to fitting the outcome model for the treatment effect. We use \texttt{MatchIt::matchit()} to perform nearest neighbor propensity score matching.

\singlespacing
\begin{verbatim}
library(MatchIt)
matchit_out <- matchit(treat ~ age + education + married + race + 
                     nodegree + re74 + re75, data = lalonde,
                   estimand = "ATT")
matchit_out
## A matchit object
##  - method: 1:1 nearest neighbor matching without replacement
##  - distance: Propensity score
##              - estimated with logistic regression
##  - number of obs.: 2675 (original), 370 (matched)
##  - target estimand: ATT
##  - covariates: age, education, married, race, nodegree, re74, re75
\end{verbatim}
\doublespacing

Next, we supply the \texttt{matchit} output object to the \texttt{obj} argument of \texttt{lmw()} to incorporate the matching weights into the outcome model. This effectively fits a weighted least squares regression with the matching weights (though in this case the matching weights are all either 0 or 1).

\singlespacing
\begin{verbatim}
lmw_match_out <- lmw(~ treat + age + education + married + race + 
                       nodegree + re74 + re75, obj = matchit_out,
                     method = "MRI")
lmw_match_out
## An lmw object
##  - treatment: treat (2 levels)
##  - method:  MRI (multi-regression imputation)
##  - number of obs.: 2675
##  - sampling weights: none
##  - base weights: matching weights from MatchIt
##  - doubly-robust method: weighted least squares (WLS)
##  - target estimand: ATT
##  - covariates: age, education, married, race, nodegree, re74, re75
\end{verbatim}
\doublespacing

When using \texttt{summary()} to assess balance, balance is presented for the unadjusted sample, for the sample after matching, and for the sample after matching and weighting by the regression weights.

\singlespacing
\begin{verbatim}
summary(lmw_match_out)
## 
## Call:
## lmw(formula = ~treat + age + education + married + race + nodegree + 
##     re74 + re75, method = "MRI", obj = matchit_out)
## 
## Summary of Balance for Unweighted Data:
##                 SMD TSMD Control TSMD Treated    KS TKS Control TKS Treated
## age          -1.263        1.263            0 0.377       0.377           0
## education    -0.881        0.881            0 0.403       0.403           0
## married      -1.729        1.729            0 0.677       0.677           0
## raceblack     1.630       -1.630            0 0.593       0.593           0
## racehispanic  0.114       -0.114            0 0.027       0.027           0
## racewhite    -2.091        2.091            0 0.620       0.620           0
## nodegree      0.886       -0.886            0 0.403       0.403           0
## re74         -3.547        3.547            0 0.729       0.729           0
## re75         -5.446        5.446            0 0.774       0.774           0
## 
## Summary of Balance for Base Weighted Data:
##                 SMD TSMD Control TSMD Treated    KS TKS Control TKS Treated
## age          -0.652        0.652            0 0.178       0.178           0
## education    -0.016        0.016            0 0.092       0.092           0
## married      -0.690        0.690            0 0.270       0.270           0
## raceblack     0.238       -0.238            0 0.086       0.086           0
## racehispanic -0.023        0.023            0 0.005       0.005           0
## racewhite    -0.274        0.274            0 0.081       0.081           0
## nodegree      0.190       -0.190            0 0.086       0.086           0
## re74         -0.492        0.492            0 0.416       0.416           0
## re75         -0.519        0.519            0 0.297       0.297           0
## 
## Summary of Balance for Weighted Data:
##              SMD TSMD Control TSMD Treated    KS TKS Control TKS Treated
## age            0            0            0 0.147       0.147           0
## education      0            0            0 0.058       0.058           0
## married        0            0            0 0.000       0.000           0
## raceblack      0            0            0 0.000       0.000           0
## racehispanic   0            0            0 0.000       0.000           0
## racewhite      0            0            0 0.000       0.000           0
## nodegree       0            0            0 0.000       0.000           0
## re74           0            0            0 0.382       0.382           0
## re75           0            0            0 0.222       0.222           0
## 
## Effective Sample Sizes:
##               Control Treated
## All           2490.       185
## Base weighted  185.       185
## Weighted        77.93     185
\end{verbatim}
\doublespacing

Although balance after matching alone was somewhat poor, using MRI after matching improved balance relative to matching alone and to regression without matching. Matching can also decrease extrapolation, as the plots below indicate:

\singlespacing
\begin{verbatim}
plot(lmw_match_out, type = "extrapolation",
     var = ~age + married + re74)
\end{verbatim}
\doublespacing

\begin{figure}[H]
    \centering
    \includegraphics[width=4.5in]{graphics/lmw_plot7.jpeg}
\end{figure}

Finally, one can estimate the treatment effect, again using \texttt{lmw\_est()} and \texttt{summary()}. Because pair matching was used to find the matches, we use cluster-robust standard errors by setting  \texttt{cluster = \char`\~ subclass} in the call to \texttt{lmw\_est()}:

\singlespacing
\begin{Verbatim}[commandchars=\\\{\}]
lmw_match_est <- lmw_est(lmw_match_out, outcome = re78, cluster = ~subclass)
lmw_match_est
## An lmw_est object
##  - outcome: re78 
##  - standard errors: cluster robust (HC1) 
##  - estimand: ATT 
##  - method: MRI 
## 
## Use summary() to examine estimates, standard errors, p-values, 
## and confidence intervals.
summary(lmw_match_est)
## 
## Effect estimates:
##              Estimate Std. Error 95% CI L 95% CI U t value Pr(>|t|)  
## E[\m{\text{Y}\textsubscript{1}\text{-}\text{Y}\textsubscript{0}}|A=1]   1904.5      872.3    189.0   3620.1   2.183   0.0297 *
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 6922 on 352 degrees of freedom
## 
## Potential outcome means:
##           Estimate Std. Error 95% CI L 95% CI U t value Pr(>|t|)    
## E[\m{\text{Y}\textsubscript{0}}|A=1]   4444.6      634.0   3197.8   5691.4   7.011 1.22e-11 ***
## E[\m{\text{Y}\textsubscript{1}}|A=1]   6349.1      577.2   5213.9   7484.4  10.999  < 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{Verbatim}
\doublespacing

The \texttt{summary()} output indicates the potential outcome means of \$6349 for the treated group and \$4445 for the control group, yielding an ATT of \$1905 (SE: \$872, 95\% CI: (189, 3620), p = .030).

\subsection{Multi-valued treatments}
The procedure for the multi-valued treatment setting is similar to that with binary treatments. Here we estimate the average treatment effects with respect to the two constructed control groups. Although it is possible to use URI with multi-valued treatments, it carries a number of shortcomings, both the same ones URI poses for binary treatments (i.e., failure to target the right population, extrapolation across treatment groups) and shortcomings unique to the multi-valued treatment case (i.e., treatment effects from the same model generalizing to different populations, changes in the procedure depending on which category serves as the reference). Given these problems, we recommend using MRI to estimate the effects of multi-valued treatments, which we demonstrate below.

The syntax for multi-valued treatments is essentially the same as with binary treatments except that the \texttt{focal} argument needs to be supplied when \texttt{estimand = "ATT"} to identify which treatment level is to be considered the â€œtreatedâ€ or â€œfocalâ€ level. (When URI is used, an additional \texttt{contrast} argument is required to identify a pair of groups to be contrasted, since each contrast will receive its own set of weights, which will be computed one at a time by \texttt{lmw()}.)

\singlespacing
\begin{verbatim}
lmw_multi_out <- lmw(~ treat_multi + age + education + married + race + 
                     nodegree + re74 + re75, data = lalonde,
                   estimand = "ATT", method = "MRI",
                   treat = "treat_multi", focal = "1")
lmw_multi_out
## An lmw object
##  - treatment: treat_multi (3 levels)
##  - method:  MRI (multi-regression imputation)
##  - number of obs.: 2675
##  - sampling weights: none
##  - base weights: none
##  - target estimand: ATT (focal = "1")
##  - covariates: age, education, married, race, nodegree, re74, re75
\end{verbatim}
\doublespacing

Using \texttt{summary()} on the resulting object produces a balance table for each treatment level against the target sample (in this case, treatment level â€œ1â€). To view balance statistics between pairs of treatment levels, the \texttt{contrast} argument can be used to specify for which pair of levels balance statistics should be displayed. (When using URI, only the two groups involved in the contrast supplied to \texttt{lmw()} will be compared.)

\singlespacing
\begin{verbatim}
summary(lmw_multi_out)
## 
## Call:
## lmw(formula = ~treat_multi + age + education + married + race + 
##     nodegree + re74 + re75, data = lalonde, estimand = "ATT", 
##     method = "MRI", treat = "treat_multi", focal = "1")
## 
## Summary of Balance for Unweighted Data:
##              TSMD 1 TSMD 2 TSMD 3 TKS 1 TKS 2 TKS 3
## age               0  1.791  0.963     0 0.538 0.312
## education         0 -0.210  1.499     0 0.164 0.573
## married           0  1.679  1.757     0 0.658 0.688
## raceblack         0 -0.912 -2.037     0 0.332 0.741
## racehispanic      0 -0.101 -0.121     0 0.024 0.029
## racewhite         0  1.200  2.596     0 0.356 0.769
## nodegree          0 -0.225 -1.261     0 0.102 0.573
## re74              0  2.350  4.226     0 0.634 0.791
## re75              0  3.297  6.664     0 0.630 0.857
## 
## Summary of Balance for Weighted Data:
##              TSMD 1 TSMD 2 TSMD 3 TKS 1 TKS 2 TKS 3
## age               0      0      0     0 0.158 0.118
## education         0      0      0     0 0.028 0.086
## married           0      0      0     0 0.000 0.000
## raceblack         0      0      0     0 0.000 0.000
## racehispanic      0      0      0     0 0.000 0.000
## racewhite         0      0      0     0 0.000 0.000
## nodegree          0      0      0     0 0.000 0.000
## re74              0      0      0     0 0.484 0.677
## re75              0      0      0     0 0.439 0.675
## 
## Effective Sample Sizes:
##            1      2       3
## All      185 901.   1589.  
## Weighted 185 153.16  109.55
\end{verbatim}
\doublespacing

The means of each treatment group are equal to the means of the target sample after weighting by the MRI weights, but some imbalances remain on the KS statistics between the two control groups and the target. Just as with binary treatments, \texttt{plot()} can be used on the \texttt{summary()} output to plot balance statistics or on the \texttt{lmw()} output to view the distribution of weights and the degree of extrapolation.

Estimating the treatment effect follows the same procedure as with binary treatments: use \texttt{lmw\_est()} to fit the outcome model and use \texttt{summary()} to extract the treatment effect estimates and their standard errors.

\singlespacing
\begin{Verbatim}[commandchars=\\\{\}]
lmw_multi_est <- lmw_est(lmw_multi_out, outcome = re78)
lmw_multi_est
## An lmw_est object
##  - outcome: re78 
##  - standard errors: robust (HC3) 
##  - estimand: ATT 
##  - method: MRI 
## 
## Use summary() to examine estimates, standard errors, p-values, 
## and confidence intervals.
summary(lmw_multi_est)
## 
## Effect estimates:
##              Estimate Std. Error 95% CI L 95% CI U t value Pr(>|t|)
## E[\m{\text{Y}\textsubscript{1}\text{-}\text{Y}\textsubscript{2}}|A=1]   1418.5      866.1   -279.7   3116.7   1.638    0.102
## E[\m{\text{Y}\textsubscript{1}\text{-}\text{Y}\textsubscript{3}}|A=1]    757.6     1114.6  -1427.9   2943.1   0.680    0.497
## E[\m{\text{Y}\textsubscript{2}\text{-}\text{Y}\textsubscript{3}}|A=1]   -660.9     1129.0  -2874.6   1552.9  -0.585    0.558
## 
## Residual standard error: 10040 on 2648 degrees of freedom
## 
## Potential outcome means:
##           Estimate Std. Error 95% CI L 95% CI U t value Pr(>|t|)    
## E[\m{\text{Y}\textsubscript{1}}|A=1]   6349.1      599.1   5174.5   7523.8  10.598  < 2e-16 ***
## E[\m{\text{Y}\textsubscript{2}}|A=1]   4930.6      625.5   3704.2   6157.1   7.883 4.62e-15 ***
## E[\m{\text{Y}\textsubscript{3}}|A=1]   5591.5      939.9   3748.6   7434.5   5.949 3.05e-09 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{Verbatim}
\doublespacing

The ATTs for the control groups are \$1419 (SE: \$866, 95\% CI: (-280, 3117), p = .102) and \$758 (SE: \$1115, 95\% CI: (-1428, 2943), p = .497).

\subsection{Two-stage least squares}
Using \texttt{lmw} with instrumental variables is straightforward; the user must specify the â€œsecond-stageâ€ (i.e., outcome) model in the main model formula and must supply the instrument separately. The \texttt{lmw\_iv()} function is used to compute the weights implied by the 2SLS model. Both URI and MRI are possible with 2SLS, although URI is far more common. When MRI is used or treatment-covariate interactions are included in the outcome model, interactions between the covariates and the instrument will be included as additional instruments. We will use URI here, using the simulated variable \texttt{Ins} as an instrument and conditioning on \texttt{age}, \texttt{education}, \texttt{race}, and \texttt{re74} in the 2SLS models. Specifying the estimand does not affect estimation of the weights with URI when no treatment-covariate interactions are included in the outcome model, but it can be useful to determine how far the target population of the local average treatment effect implied by the weights is from the desired target population.

\singlespacing
\begin{verbatim}
lmw_iv_out <- lmw_iv(~treat + age + education + race + re74,
                     data = lalonde, estimand = "ATT", method = "URI",
                     treat = "treat", iv = ~Ins)
lmw_iv_out
## An lmw_iv object
##  - treatment: treat (2 levels)
##  - instrument: Ins
##  - method: URI (uni-regression imputation)
##  - number of obs.: 2675
##  - sampling weights: none
##  - base weights: none
##  - target estimand: ATT
##  - covariates: age, education, race, re74
\end{verbatim}
\doublespacing

As before, one can use \texttt{summary()} to assess balance. Variables that were not included in the model can be added using \texttt{addlvariables}.

\singlespacing
\begin{verbatim}
summary(lmw_iv_out, addlvariables = ~married + nodegree + re75)
## 
## Call:
## lmw_iv(formula = ~treat + age + education + race + re74, data = lalonde, 
##     estimand = "ATT", method = "URI", treat = "treat", iv = ~Ins)
## 
## Summary of Balance for Unweighted Data:
##                 SMD TSMD Control TSMD Treated    KS TKS Control TKS Treated
## age          -1.263        1.263            0 0.377       0.377           0
## education    -0.881        0.881            0 0.403       0.403           0
## raceblack     1.630       -1.630            0 0.593       0.593           0
## racehispanic  0.114       -0.114            0 0.027       0.027           0
## racewhite    -2.091        2.091            0 0.620       0.620           0
## re74         -3.547        3.547            0 0.729       0.729           0
## married      -1.729        1.729            0 0.677       0.677           0
## nodegree      0.886       -0.886            0 0.403       0.403           0
## re75         -5.446        5.446            0 0.774       0.774           0
## 
## Summary of Balance for Weighted Data:
##                 SMD TSMD Control TSMD Treated    KS TKS Control TKS Treated
## age           0.000        0.539        0.539 0.324       0.432       0.198
## education     0.000       -0.218       -0.218 0.580       0.534       0.106
## raceblack     0.000       -0.557       -0.557 0.000       0.203       0.203
## racehispanic  0.000        0.390        0.390 0.000       0.092       0.092
## racewhite     0.000        0.373        0.373 0.000       0.110       0.110
## re74          0.000       -0.219       -0.219 0.704       0.725       0.103
## married      -1.255        1.388        0.134 0.491       0.544       0.052
## nodegree      1.275       -1.175        0.100 0.580       0.534       0.045
## re75          0.260       -0.322       -0.062 0.535       0.532       0.059
## 
## Effective Sample Sizes:
##          Control Treated
## All      2490.     185. 
## Weighted    2.25    59.6
\end{verbatim}
\doublespacing

Extrapolation can be a problem with 2SLS models due to large, negative weights; the extrapolation plot displays the severity of this problem in this data setting:

\singlespacing
\begin{verbatim}
plot(lmw_iv_out, type = "extrapolation",
     var = ~age + married + re74)
\end{verbatim}
\doublespacing


Finally, one can estimate the treatment effect using \texttt{lmw\_est()}, which produces a treatment effect estimate based on the second-stage regression model on the treatment and covariates after adjustment by the instrument. As with other regression models, robust standard errors are produced by default.

\singlespacing
\begin{Verbatim}[commandchars=\\\{\}]
lmw_iv_est <- lmw_est(lmw_iv_out, outcome = re78)
lmw_iv_est
## An lmw_est_iv object
##  - outcome: re78 
##  - standard errors: robust (HC3) 
##  - estimand: ATT 
##  - method: URI 
## 
## Use summary() to examine estimates, standard errors, p-values, 
## and confidence intervals.
summary(lmw_iv_est)
## 
## Effect estimates:
##              Estimate Std. Error 95% CI L 95% CI U t value Pr(>|t|)
## E[\m{\text{Y}\textsubscript{1}\text{-}\text{Y}\textsubscript{0}}|A=1]     7802       7160    -6238    21841    1.09    0.276
## 
## Residual standard error: 11030 on 2668 degrees of freedom
\end{Verbatim}
\doublespacing

The treatment effect estimate is \$7802 (SE: \$7160, 95\% CI: (-6238, 21841), p = .276). Note this estimate should not be taken seriously as the instrument here was synthetic and used solely for illustration purposes.


%%%%%%%%%%%%%%%%%%%%
\pagebreak
%\onehalfspacing
%\bibliographystyle{natbib}
\bibliographystyle{asa}
\bibliography{bib}

%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%

\end{document}
