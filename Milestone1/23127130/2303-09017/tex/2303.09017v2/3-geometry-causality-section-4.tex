% % !TEX options=--shell-escape
% \documentclass[12pt]{iopart}
% \pdfoutput=1 % go for pdflatex

% % == Standard packages ==
% \usepackage{iopams}
% \input{packages}

% % == Theorem environments ==
% \theoremstyle{definition}
% % A definition introduces a new concept rigorously:
% \newtheorem{definition}{Definition}[section]
% % A remark introduces tangential considerations: 
% \newtheorem{remark}{Remark}[section]
% % A theorem is a key result:
% \newtheorem{theorem}{Theorem}[section]
% % A proposition is a result requiring explicit proof:
% \newtheorem{proposition}[theorem]{Proposition}
% % A lemma is an intermediate result for a theorem or a proposition, requiring explicit proof:
% \newtheorem{lemma}[theorem]{Lemma}
% % An observation is a result not requiring explicit proof:
% \newtheorem{observation}[theorem]{Observation}
% % A corollary is a result directly following from a previous result:
% \newtheorem{corollary}[theorem]{Corollary}

% % == Macros ==
% \input{macros}
% \newcommand{\TODO}[1]{{\marginpar{\color{gray}\textsf{[TODO]}} \color{gray}\textsf{[#1]}}}
% \newcommand{\NOTE}[1]{{\marginpar{\color{gray}\textsf{[NOTE]}} \color{gray}\textsf{[#1]}}}

% \begin{document}

% % == Dummy Sections ==

% \section{Introduction}
% \label{section: introduction}

% \section{Causal orders}
% \label{section:causal-orders}

% \section{Spaces of input histories}
% \label{section:spaces}

% \begin{definition}
% \label{definition:compatible-pfun}
% We say that $f$ and $g$ are \emph{compatible} when the inclusion above is an equality:
% \begin{equation*}
%     \text{$f$ and $g$ compatible}
%     \hspace{2mm} \Leftrightarrow \hspace{2mm}
%     \dom{f \wedge g}
%     =
%     \dom{f} \cap \dom{g}
% \end{equation*}
% More generally, we say that a set $\mathcal{F} \subseteq \PFun{\underline{Y}}$ of partial functions is \emph{compatible} if $f$ and $g$ are compatible for all $f, g \in \mathcal{F}$.
% \end{definition}

% \begin{definition}
% \label{definition:compatible-join}
% The \emph{join} of a set $\mathcal{F}$ of partial functions exists exactly when the set is compatible, in which case it is given by:
% \begin{equation*}
% \label{eq:definition:join}
% \begin{array}{rcl}
%     \dom{\bigvee \mathcal{F}}
%     &=&
%     \bigcup\limits_{f \in \mathcal{F}} \dom{f}
%     \\
%     \bigvee \mathcal{F}
%     &=&
%     x \mapsto f(x) \text{ for any $f$ such that } x \in \dom{f}
% \end{array}
% \end{equation*}
% The \emph{compatible joins} in a set $\mathcal{F}'$ of partial functions are all possible joins $\bigvee\mathcal{F}$ of compatible subsets $\mathcal{F} \subseteq \mathcal{F}'$.
% \end{definition}

% \begin{figure}[h!]
%     \centering
%     \includegraphics[width=0.9\textwidth]{svg-inkscape/hierarchy-spaces-ABC_svg-tex.pdf}
%     \caption{
%     The hierarchy of causally complete spaces on 3 events with binary inputs, grouped into 102 equivalence classes under event-input permutation symmetry.
%     An edge $i \rightarrow j$ indicates that some space in eq. class $i$ is a closest refinement for some space in eq. class $i$.

%     Node colour indicates the number of causal functions for a space which are not causal for any of its subspaces, while edge colour indicates the number of causal functions for the head space that are not causal for the tail space.
%     Grey nodes (e.g. eq. class 1) indicate spaces where al causal functions are also causal for some subspace, while thicker dark blue edges (e.g. edge $0 \rightarrow 1$) indicate that all causal functions for the head space are also causal for the tail space.

%     Thin purple borders for nodes indicate eq. classes of non-tight spaces (e.g. eq. class 1).
%     Thick black borders for nodes indicate the eq. classes of spaces induced by causal orders.
%     }
% \label{fig:hierarchy-spaces-ABC}
% \end{figure}


% \newpage

% === COMMENT ABOVE BEFORE COMPILING MAIN FILE ===



\section{The topology of causality}
\label{section:topology-causality}

In this Section, we summarise the results of the companion work ``The Topology of Causality'' \cite{gogioso2022topology}, which form the basis for the geometric framework presented in the next Section.
For a full discussion, including proofs of all results, we refer the reader to Section 4 of ``The Topology of Causality'' \cite{gogioso2022topology}.

The ultimate purpose of this Section is to provide a definition for ``empirical models'', probability distributions on joint outputs conditional to joint inputs which respect given causal constraints.
Contrary to most works on causality, where such constraints take the form of linear equations and inequalities, the definition of empirical models given in this Section is purely topological, in a setting which is natural for the study of non-locality and contextuality.
In Section \ref{section:geometry-causality}, we show how a geometric description in terms of causal polytopes arises naturally from our topological definition.

Empirical models are defined as ``compatible families'' for a ``presheaf'' of probability distributions over causal functions, the latter being the deterministic mappings of input histories to local outputs which respect causal the causal structure.
The underlying space of input histories is enriched from a combinatorial object to a topological one, where a choice of open cover corresponds to the possible ``contexts'' over which probability distributions are guaranteed to be simultaneously definable.
The hierarchy formed by open covers under refinement then corresponds to all possible kinds and degrees of contextuality.


\subsection{Causal Functions (tight causally complete spaces)}
\label{subsection:topology-causality-cfun-tightcc}

Many of the choices made in the definition of spaces of input histories are dictated by our desire to accommodate a certain notion of ``causal function'', mapping inputs to outputs in a way which respects a given causal structure.
To better connect with previous literature, we start by defining our functions on the joint inputs of an operational scenario (cf. previous Section), independently of any causal constraints.

\begin{definition}
\label{definition:joint-io-function}
A \emph{joint input-output (IO) function} for an operational scenario $(E, \underline{I}, \underline{O})$ is any function $F: \prod_{\omega \in E}I_\omega \rightarrow \prod_{\omega \in E} O_\omega$ which maps joint inputs to joint outputs.
For every choice $k \in \prod_{\omega \in E}I_\omega$ of joint inputs and every event $\omega \in E$, we refer to the component $F(k)_{\omega} \in O_\omega$ as the \emph{output of $F$ at $\omega$}.
\end{definition}

In previous discussion, we have conceptualised spaces of input histories as defining causal constraints, by specifying the possible input histories upon which the output at any given event $\omega$ is allowed to depend---namely, those having $\omega$ as (one of) their tip event(s).
That conceptualisation is now made concrete in the following definition of a ``causal'' function.

\begin{definition}
\label{definition:causal-function-whole}
Let $F: \prod_{\omega \in E} I_\omega \rightarrow \prod_{\omega \in E} O_\omega$ be a joint IO function for an operational scenario $(E, \underline{I}, \underline{O})$ and let $\Theta$ be a space of input histories such that $\underline{\Inputs{\Theta}} = \underline{I}$.
We say that $F$ is \emph{causal} for $\Theta$ if the output of $F$ at any given event $\omega$ only depends on the data specified by the input histories having $\omega$ as a tip event.
In other words, for all input histories $h \in \Theta$, the outputs $\restrict{F(k)}{\tips{\Theta}{h}}$ at the tips of $h$ are the same for all joint inputs $k \in \prod_{\omega \in E} I_\omega$ such that $h \leq k$.
\end{definition}

As a concrete example, we look at space $\Theta_{33}$ from Figure~5 (p.42) of \cite{gogioso2022combinatorics}.
Recall that $\Theta_{33}$ is a tight space, induced by causal order $\total{\ev{A},\ev{B}}\vee\discrete{\ev{C}}$ with binary inputs for all events.
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-33-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-33-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{33}$
    &
    $\Ext{\Theta_{33}}$
    \end{tabular}
\end{center}
A generic function $F: \{0,1\}^{3}\!\rightarrow\!\{0,1\}^{3}$ with binary outputs takes following form: 
\[
F(k_\ev{A}, k_\ev{B}, k_\ev{C})
=
\left(
\begin{array}{c}
F_\ev{A}(k_\ev{A}, k_\ev{B}, k_\ev{C})\\
F_\ev{B}(k_\ev{A}, k_\ev{B}, k_\ev{C})\\
F_\ev{C}(k_\ev{A}, k_\ev{B}, k_\ev{C})\\
\end{array}
\right)
\]
where the binary functions $F_\omega: \{0,1\}^{\evset{A,B,C}} \rightarrow \{0,1\}$ produce the outputs at the three events.
In the case of causal order $\total{\ev{A},\ev{B}}\vee\discrete{\ev{C}}$, we expect joint IO functions $F$ which are causal for $\Theta_{33}$ to take the following simplified form, for generic $G_{\ev{A}}$, $G_{\ev{B}}$ and $G_{\ev{C}}$:
\[
F(k_\ev{A}, k_\ev{B}, k_\ev{C})
=
\left(
\begin{array}{c}
G_\ev{A}(k_\ev{A})\\
G_\ev{B}(k_\ev{A}, k_\ev{B})\\
G_\ev{C}(k_\ev{C})\\
\end{array}
\right)
\]
Indeed, we show that Definition \ref{definition:causal-function-whole} implies the above form for $F(k)$:
\begin{itemize}
    \item The component $F_\ev{A}(k)$ must have the same value for all $k \in \prod_{\omega \in E} I_\omega$ such that $\hist{A/k_\ev{A}} \leq k$, for each choice of $k_\ev{A} \in \{0,1\}$:
    \[
        \begin{array}{rl}
         &F_\ev{A}\left(\hist{A/k_\ev{A},B/0,C/0}\right)
         =F_\ev{A}\left(\hist{A/k_\ev{A},B/0,C/1}\right)\\
        =&F_\ev{A}\left(\hist{A/k_\ev{A},B/1,C/0}\right)
         =F_\ev{A}\left(\hist{A/k_\ev{A},B/1,C/1}\right)
        \end{array}
    \]
    This means that $F_\ev{A}(k_\ev{A}, k_\ev{B}, k_\ev{C}) = G_\ev{A}(k_\ev{A})$ for a generic function $G_\ev{A}: \{0,1\} \rightarrow \{0,1\}$.
    \item The component $F_\ev{B}(k)$ must have the same value for all $k \in \prod_{\omega \in E} I_\omega$ such that $\hist{A/k_\ev{A}, B/k_\ev{B}} \leq k$, for each choice of $k_\ev{A}, k_\ev{B} \in \{0,1\}$:
    \[
         F_\ev{B}\left(\hist{A/k_\ev{A},B/k_\ev{B},C/0}\right)
        =F_\ev{B}\left(\hist{A/k_\ev{A},B/k_\ev{B},C/1}\right)
    \]
    This means that $F_\ev{B}(k_\ev{A}, k_\ev{B}, k_\ev{C}) = G_\ev{B}(k_\ev{A}, k_\ev{B})$ for a generic function $G_\ev{B}: \{0,1\}^2 \rightarrow \{0,1\}$.
    \item The component $F_\ev{C}(k)$ must have the same value for all $k \in \prod_{\omega \in E} I_\omega$ such that $\hist{C/k_\ev{C}} \leq k$, for each choice of $k_\ev{C} \in \{0,1\}$:
    \[
        \begin{array}{rl}
         &F_\ev{C}\left(\hist{A/0,B/0,C/k_\ev{C}}\right)
         =F_\ev{C}\left(\hist{A/0,B/1,C/k_\ev{C}}\right)\\
        =&F_\ev{C}\left(\hist{A/1,B/0,C/k_\ev{C}}\right)
         =F_\ev{C}\left(\hist{A/1,B/1,C/k_\ev{C}}\right)
        \end{array}
    \]
    This means that $F_\ev{C}(k_\ev{A}, k_\ev{B}, k_\ev{C}) = G_\ev{C}(k_\ev{C})$ for a generic function $G_\ev{C}: \{0,1\} \rightarrow \{0,1\}$.
\end{itemize}
Analogous reasoning can be used to prove a general result (cf. Proposition 4.1 p.35 \cite{gogioso2022topology}) about the structure of joint IO functions $F: \prod_{\omega \in \Omega}I_\omega \rightarrow \prod_{\omega \in \Omega} O_\omega$ which are causal for spaces induced by induced by causal orders $\Omega$, possibly indefinite:
\[
F\left(k\right)_\omega
=
% \left(
G_\omega\left(k|_{\downset{\omega}}\right)
% \right)_{\omega \in \Omega}
\]
where $G_\omega: \{0,1\}^{\downset{\omega}} \rightarrow \{0,1\}$ are functions that can be freely specified at all events of $\Omega$.
This structural characterisation is a mainstay of classical causality, so it is legitimate to ask why we didn't use it directly as part of Definition \ref{definition:causal-function-whole}.
The reason is simple: the characterisation of causality as independence of output components from certain input components only works for those (few) spaces which are induced by causal orders.
As an example not fitting this mold, consider space $\Theta_{101}$ from Figure~5 (p.42) of \cite{gogioso2022combinatorics}:
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-101-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=3.5cm]{svg-inkscape/space-ABC-unique-tight-101-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta_{101}$
    &
    $\Ext{\Theta_{101}}$
    \end{tabular}
\end{center}
This space is not order-induced: the definite causal order between events \ev{B} and \ev{C} depends on the input choice at event \ev{A}.
Lets consider again a generic function $F: \{0,1\}^{3}\!\rightarrow\!\{0,1\}^{3}$ with binary outputs: 
\[
F(k_\ev{A}, k_\ev{B}, k_\ev{C})
=
\left(
\begin{array}{c}
F_\ev{A}(k_\ev{A}, k_\ev{B}, k_\ev{C})\\
F_\ev{B}(k_\ev{A}, k_\ev{B}, k_\ev{C})\\
F_\ev{C}(k_\ev{A}, k_\ev{B}, k_\ev{C})\\
\end{array}
\right)
\]
Definition \ref{definition:causal-function-whole} gives the following constraints on a joint IO function $F$ which is causal for $\Theta_{101}$:
\begin{itemize}
    \item The component $F_\ev{A}(k)$ must have the same value for all $k \in \prod_{\omega \in E} I_\omega$ such that $\hist{A/k_\ev{A}} \leq k$, for each choice of $k_\ev{A} \in \{0,1\}$:
    \[
        \begin{array}{rl}
         &F_\ev{A}\left(\hist{A/k_\ev{A},B/0,C/0}\right)
         =F_\ev{A}\left(\hist{A/k_\ev{A},B/0,C/1}\right)\\
        =&F_\ev{A}\left(\hist{A/k_\ev{A},B/1,C/0}\right)
         =F_\ev{A}\left(\hist{A/k_\ev{A},B/1,C/1}\right)
        \end{array}
    \]
    This means that $F_\ev{A}(k_\ev{A}, k_\ev{B}, k_\ev{C}) = G_\ev{A}(k_\ev{A})$ for a generic function $G_\ev{A}: \{0,1\} \rightarrow \{0,1\}$.
    \item The component $F_\ev{B}(k)$ must have the same value for all $k \in \prod_{\omega \in E} I_\omega$ such that $\hist{A/0, B/k_\ev{B}} \leq k$, for each choice of $k_\ev{B} \in \{0,1\}$:
    \[
         F_\ev{B}\left(\hist{A/0,B/k_\ev{B},C/0}\right)
        =F_\ev{B}\left(\hist{A/0,B/k_\ev{B},C/1}\right)
    \]
    This means that $F_\ev{B}(0, k_\ev{B}, k_\ev{C}) = G_{\ev{B},0}(k_\ev{B})$ for a generic function $G_{\ev{B},0}: \{0,1\} \rightarrow \{0,1\}$.
    \item The component $F_\ev{B}(k)$ must have the same value for all $k \in \prod_{\omega \in E} I_\omega$ such that $\hist{A/1,B/k_\ev{B},C/k_\ev{C}} \leq k$, for each choice of $k_\ev{B},k_\ev{C} \in \{0,1\}$.
    This doesn't impose any constraints, as the only such $k$ is $k=\hist{A/1,B/k_\ev{B},C/k_\ev{C}}$ itself.
    This means that $F_\ev{B}(1, k_\ev{B}, k_\ev{C}) = G_{\ev{B},1}(k_\ev{B}, k_\ev{C})$ for a generic function $G_{\ev{B},1}: \{0,1\}^2 \rightarrow \{0,1\}$.
    \item The component $F_\ev{C}(k)$ must have the same value for all $k \in \prod_{\omega \in E} I_\omega$ such that $\hist{A/1, C/k_\ev{C}} \leq k$, for each choice of $k_\ev{C} \in \{0,1\}$:
    \[
         F_\ev{C}\left(\hist{A/0,B/0,C/k_\ev{C}}\right)
        =F_\ev{C}\left(\hist{A/0,B/1,C/k_\ev{C}}\right)
    \]
    This means that $F_\ev{C}(1, k_\ev{B}, k_\ev{C}) = G_{\ev{C},1}(k_\ev{C})$ for a generic function $G_{\ev{C},1}: \{0,1\} \rightarrow \{0,1\}$.
    \item The component $F_\ev{C}(k)$ must have the same value for all $k \in \prod_{\omega \in E} I_\omega$ such that $\hist{A/0,B/k_\ev{B},C/k_\ev{C}} \leq k$, for each choice of $k_\ev{B},k_\ev{C} \in \{0,1\}$.
    This doesn't impose any constraints, as the only such $k$ is $k=\hist{A/0,B/k_\ev{B},C/k_\ev{C}}$ itself.
    This means that $F_\ev{C}(0, k_\ev{B}, k_\ev{C}) = G_{\ev{B},0}(k_\ev{B}, k_\ev{C})$ for a generic function $G_{\ev{C},0}: \{0,1\}^2 \rightarrow \{0,1\}$.
\end{itemize}
Putting all constraints above together, we get the following characterisation of a generic $F$ which is causal for $\Theta_{101}$, for generic functions $G_\ev{A}, G_{\ev{B}, 0}, G_{\ev{B}, 1}, G_{\ev{C}, 0}, G_{\ev{C}, 1}$:
\[
F(0, k_\ev{B}, k_\ev{C})
=
\left(
\begin{array}{c}
G_\ev{A}(0)\\
G_{\ev{B}, 0}(k_\ev{B})\\
G_{\ev{C}, 0}(k_\ev{B}, k_\ev{C})\\
\end{array}
\right)
\hspace{1cm}
F(1, k_\ev{B}, k_\ev{C})
=
\left(
\begin{array}{c}
G_\ev{A}(1)\\
G_{\ev{B}, 1}(k_\ev{B}, k_\ev{C})\\
G_{\ev{C}, 1}(k_\ev{C})\\
\end{array}
\right)
\]

Definitions \ref{definition:joint-io-function} and \ref{definition:causal-function-whole} have the advantage of talking about causality as a property of functions which are themselves defined independently of the causal space.
They allow us to start with a joint IO function $F$ and ask the question ``Is $F$ causal for space $\Theta$?'', or to take a joint IO function $F$ which we already know to be causal for some space $\Theta$ and ask the question ``Is $F$ also causal for space $\Theta'$?''.
They act as a bridge between the causality constraints for different spaces on the given events and inputs.

The same definitions, however, have a major disadvantage: they talk about causality as a set of constraints that a generic function must satisfy, rather than focusing on the causal data which underlies the functions.
Given a joint IO function $F$ for an operational scenario, they make it straightforward to check whether $F$ is causal for a space $\Theta$; given $\Theta$, on the other hand, they don't make it easy to characterise the set of joint IO functions which are causal for $\Theta$.

As it turns out, input histories are the key to understanding the structure of causal functions: up to a minor complication arising from lack of tightness, the joint IO functions which are causal for a causally complete space $\Theta$ are in exact correspondence with functions mapping input histories in $\Theta$ to outputs at their tip events.
We use this as the basis to define ``causal functions'' for a space of input histories $\Theta$, and proceed to show that this definition of causality agrees with that of Definitions \ref{definition:joint-io-function} and \ref{definition:causal-function-whole}. 
We start from the special case of tight causally complete spaces---where things work right off the bat---then generalise to arbitrary tight spaces, and finally generalise to arbitrary spaces of input histories. 

\begin{definition}
\label{definition:causal-function-tight-cc}
Let $\Theta$ be a tight causally complete space and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
The \emph{causal functions} $\CausFun{\Theta, \underline{O}}$ for space $\Theta$ and outputs $\underline{O}$ are the functions mapping each history in $\Theta$ to the output value for its tip event:
\begin{equation*}
    \CausFun{\Theta, \underline{O}}
    :=
    \prod_{h \in \Theta}
    O_{\tip{\Theta}{h}}
\end{equation*}
In the special case where the output sets $\underline{O} = (O)_{\omega \in \Events{\Theta}}$ are the same $O$ for all events $\omega$---e.g. the binary case $O=\{0,1\}$---the definition takes the simplified form of functions from the space $\Theta$ to the output set $O$:
\[
    \CausFun{\Theta, O}
    =
    \Theta \rightarrow O
\]
In such cases, $\CausFun{\Theta, O}$ is shorthand for $\CausFun{\Theta, (O)_{\omega \in \Events{\Theta}}}$.
\end{definition}

We now proceed to draw a general connection between the causal functions from Definition \ref{definition:causal-function-tight-cc} to the joint IO function from Definitions \ref{definition:joint-io-function} and \ref{definition:causal-function-whole}.
We do so by turning the causal functions $f \in \CausFun{\Theta, \underline{O}}$ into corresponding ``extended causal functions'' $\Ext{f}$: the latter are defined on all extended input histories, assigning to each $k \in \Ext{\Theta}$ the output values specified by $f$ on all events in $\dom{k}$.

\begin{definition}
\label{definition:space-extended-function}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty output sets.
The \emph{extended functions} on $\Theta$ (with output $\underline{O}$) are defined as:
\begin{equation*}
    \ExtFun{\Theta, \underline{O}}
    :=
    \prod_{k \in \Ext{\Theta}}\prod_{\omega \in \dom{k}}O_\omega
\end{equation*}
\end{definition}

\begin{definition}
\label{definition:ext-f-tight-cc}
Let $\Theta$ be a tight causally complete space and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
For each causal function $f \in \CausFun{\Theta, \underline{O}}$, define the corresponding \emph{extended causal function} $\Ext{f} \in \ExtFun{\Theta, \underline{O}}$ as follows:
\begin{equation*}
    \Ext{f}(k)
    :=
    \left(f\left(h_{k,\omega}\right)\right)_{\omega \in \dom{k}}
    \text{ for all }
    k \in \Ext{\Theta}
\end{equation*}
where $h_{k,\omega}$ is the unique input history $h \in \Theta$ such that $h \leq k$ and $\tip{\Theta}{h} = \omega$ (by definition of a tight space).
We refer to $\Ext{f}(k)$ as the \emph{extended output history} corresponding to extended input history $k$.
We say that an extended function $\hat{F} \in \ExtFun{\Theta, \underline{O}}$ is \emph{causal} if it is an extended causal function, i.e. if takes the form $\hat{F} = \Ext{f}$ for some $f \in \CausFun{\Theta, \underline{O}}$.
We write $\ExtCausFun{\Theta, \underline{O}} \subseteq \ExtFun{\Theta, \underline{O}}$ for the subset of extended causal functions.
\end{definition}

An alternative way to describe the extended causal function $\Ext{f}$ is as a ``gluing''---by means of compatible joins---of the output values of $f$ over compatible input histories.
Such ``gluing'' characterisation is made precise by the following definition and subsequent results.

\begin{definition}
\label{definition:consistency-condition}
Let $\Theta$ be a space of input histories and let $\hat{F} \in \ExtFun{\Theta, \underline{O}}$ be an extended function.
We say that $\hat{F}$ satisfies the \emph{consistency condition} if it assigns consistent output histories to compatible extended input histories: $\hat{F}(k') \leq \hat{F}(k)$ for all $k, k' \in \Ext{\Theta}$ such that $k' \leq k$.
We say that $\hat{F}$ satisfies the \emph{gluing condition} if it respects compatible joins: $\hat{F}(k)$ and $\hat{F}(k')$ are compatible for all compatible $k, k' \in \Ext{\Theta}$, and we have $\hat{F}(k\vee k') = \hat{F}(k) \vee \hat{F}(k')$.
\end{definition}

The consistency condition is turns out to be equivalent to the gluing condition (cf. Proposition 4.2 p.38 \cite{gogioso2022topology}), and the extended functions $\hat{F} \in \ExtFun{\Theta, \underline{O}}$ which are causal are exactly those which satisfy the consistency condition (cf. Theorem 4.3 p.38 \cite{gogioso2022topology}).
Indeed, the following defines a causal function $\Prime{\hat{F}} \in \CausFun{\Theta, \underline{O}}$:
\begin{equation*}
    \Prime{\hat{F}} := h \mapsto \hat{F}(h)_{\tip{\Theta}{h}}
\end{equation*}
Furthermore, the causal function defined above is the unique $f \in \CausFun{\Theta, \underline{O}}$ such that $\Ext{f} = \hat{F}$, because of of the following equation:
\begin{equation*}
    \Prime{\Ext{f}} = f
\end{equation*}

Since causally complete spaces $\Theta$ satisfy the free-choice condition, we can restrict $\Ext{f}$ to the maximal extended input histories and obtain a joint IO function which is causal for $\Theta$.
Conversely, it is a fact (cf. Proposition 4.4 p.39 \cite{gogioso2022topology}) that every joint IO function which is causal for $\Theta$ arises this way, for a unique choice of $f \in \CausFun{\Theta, \underline{O}}$:
\begin{equation*}
    f(h)
    :=
    F(k)_{\tip{\Theta}{h}}
    \text{ for any maximal ext. input history $k$ s.t. } h \leq k    
\end{equation*}
This means that the two definitions of causal functions are in exact correspondence, at least in the case of tight causally complete spaces.
As an example of this correspondence, consider once more the tight causally complete space $\Theta_{33}$, in the binary case $\underline{O} = (\{0,1\})_{\omega \in \evset{A,B,C}}$.
Recall that the joint IO functions $F$ which are causal for $\Theta_{33}$ take the following form, for generic $G_{\ev{A}}$, $G_{\ev{B}}$ and $G_{\ev{C}}$:
\[
F(k_\ev{A}, k_\ev{B}, k_\ev{C})
=
\left(
\begin{array}{c}
G_\ev{A}(k_\ev{A})\\
G_\ev{B}(k_\ev{A}, k_\ev{B})\\
G_\ev{C}(k_\ev{C})\\
\end{array}
\right)
\]
Given one such joint IO function $F$, the causal function $f \in \CausFun{\Theta_{33}, \{0,1\}}$ defined by the equation above takes the following form:
\[
\begin{array}{rcl}
\hist{A/k_\ev{A}}
&\stackrel{f}{\mapsto}&
G_\ev{A}(k_\ev{A})
\\
\hist{A/k_\ev{A},B/k_\ev{B}}
&\stackrel{f}{\mapsto}&
G_\ev{B}(k_\ev{A}, k_\ev{B})
\\
\hist{C/k_\ev{C}}
&\stackrel{f}{\mapsto}&
G_\ev{C}(k_\ev{C})
\\
\end{array}
\]
The extended causal function $\Ext{f}$ then takes the following form:
\[
\begin{array}{rcl}
\hist{A/k_\ev{A}}
&\stackrel{\Ext{f}}{\mapsto}&
\hist{A/G_\ev{A}(k_\ev{A})}
\\
\hist{C/k_\ev{C}}
&\stackrel{\Ext{f}}{\mapsto}&
\hist{C/G_\ev{C}(k_\ev{C})}
\\
\hist{A/k_\ev{A},B/k_\ev{B}}
&\stackrel{\Ext{f}}{\mapsto}&
\hist{A/{G_\ev{A}(k_\ev{A})},B/{G_\ev{B}(k_\ev{A}, k_\ev{B})}}
\\
\hist{A/k_\ev{A},C/k_\ev{C}}
&\stackrel{\Ext{f}}{\mapsto}&
\hist{A/{G_\ev{A}(k_\ev{A})},C/{G_\ev{C}(k_\ev{C})}}
\\
\hist{A/k_\ev{A},B/k_\ev{B},C/k_\ev{C}}
&\stackrel{\Ext{f}}{\mapsto}&
\hist{A/{G_\ev{A}(k_\ev{A})},B/{G_\ev{B}(k_\ev{A}, k_\ev{B})},C/{G_\ev{C}(k_\ev{C})}}
\\
\end{array}
\]
The last line of the definition of $\Ext{f}$ above is its restriction to the maximal extended input histories, which coincides with the original definition of $F$.


\subsection{Causal Functions (general case)}
\label{subsection:topology-causality-cfun}

We now proceed to generalise the definition of causal functions to all spaces of input histories: we first drop the causal completeness requirement, and then drop the tightness requirement.

\begin{definition}
\label{definition:causal-function-tight}
Let $\Theta$ be a tight space and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
The \emph{causal functions} $\CausFun{\Theta, \underline{O}}$ for space $\Theta$ and outputs $\underline{O}$ are the functions mapping each history in $\Theta$ to the output values for its tip events:
\begin{equation*}
    \CausFun{\Theta, \underline{O}}
    :=
    \prod_{h \in \Theta}
    \prod_{\omega \in \tips{\Theta}{h}}
    O_{\omega}
\end{equation*}
\end{definition}

When $\Theta$ is a causally complete space, we have $\tips{\Theta}{h} = \{\tip{\Theta}{h}\}$ for all $h$, so that Definition \ref{definition:causal-function-tight} is equivalent to Definition \ref{definition:causal-function-tight-cc}:
\[
\prod_{\omega \in \tips{\Theta}{h}} O_{\omega}
=
\prod_{\omega \in \{\tip{\Theta}{h}\}} O_{\omega}
\simeq
O_{\tip{\Theta}{h}}
\]
Causal functions on a causally incomplete space include, in particular, all causal functions for its causal completions: it might be tempting to think of causal incompleteness as specifying indefinite causal order to be made precise by a causally complete subspace.
However, not all causal functions on a causally incomplete space arise this way: some of them are ``inseparable'', requiring multiparty signalling and leading to delocalised events.

As a concrete example, consider the tight space $\Theta = \Hist{\Omega, \{0,1\}}$ of in input histories induced by the indefinite causal order $\Omega = \total{\ev{A}, \evset{B,C}}$ with binary inputs.
The space satisfies the free-choice condition, and the 8 maximal extended input histories have $\evset{B,C}$ as their tip events.
\begin{center}
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-hists-narrow_svg-tex.pdf}
\end{center}
Recall that there are four causal completions for this space: two where $\ev{B}$ and $\ev{C}$ are unconditionally totally ordered, and two where they are totally ordered conditionally to the input at $\ev{A}$.
\begin{center}
\begin{tabular}{cc}
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-completion-0_svg-tex.pdf}
    &
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-completion-3_svg-tex.pdf}
    \\
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-completion-1_svg-tex.pdf}
    &
    \includegraphics[height=2.5cm]{svg-inkscape/total-AZBCZ-completion-2_svg-tex.pdf}
\end{tabular}
\end{center}
The causally incomplete space $\Theta$ has the following number of causal functions:
\[
\prod_{h \in \Theta} 2^{|\tips{\Theta}{h}|}
=
2^{\sum_{h \in \Theta}|\tips{\Theta}{h}|}
=
2^{2\cdot 1 + 8 \cdot 2}
=
2^{18}
=
262144
\]
Each of the four causal completions has the following number of causal functions:
\[
\prod_{h \in \Theta} 2^{|\tips{\Theta}{h}|}
=
2^{\sum_{h \in \Theta} 1}
=
2^{|\Theta|}
=
2^{14}
=
16384
\]
However, some causal functions are common to multiple causal completions, so only 50176 of the 262144 causal functions on $\Theta$ ``arise from'' one of its completions.

\begin{definition}
Let $\Theta, \Theta'$ be spaces of input histories such that $\Theta' \leq \Theta$.
Let $f \in \CausFun{\Theta, \underline{O}}$ be a causal function on $\Theta$ and let $f' \in \CausFun{\Theta', \underline{O}'}$ be a causal function on $\Theta'$.
We say that $f$ \emph{arises from} $f'$ if the extended causal function $\Ext{f'}$ restricts to  the extended causal function $\Ext{f}$:
\[
f \text{ arises from } f'
\Leftrightarrow
\restrict{\Ext{f'}}{\Ext{\Theta}} = \Ext{f}
\]
where we have used the fact that $\Theta' \leq \Theta$ is defined as $\Ext{\Theta'} \supseteq \Ext{\Theta}$.
\end{definition}

The causal functions for $\Theta'$ and $\underline{O}'$ can be safely identified with the causal functions that arise from them (cf. Proposition 4.5 p.42 \cite{gogioso2022topology}):
\[
\begin{array}{rrcl}
&\CausFun{\Theta', \underline{O}'}
&\hookrightarrow
&\CausFun{\Theta, \underline{O}}
\\
&f'
&\mapsto
&\Prime{\restrict{\Ext{f'}}{\Ext{\Theta}}}
\end{array}
\]
The 211968 causal functions on $\Theta = \Hist{\total{\ev{A}, \evset{B,C}}, \{0,1\}}$ that don't arise from one of its causal completions---and hence don't arise from any one of its causally-complete sub-spaces---are ``inseparable'': the joint output produced at tip events $\evset{B,C}$ on one of the maximal extended input histories functionally depend on the inputs at both events $\ev{B}$ and $\ev{C}$, making it incompatible with any causally complete subspace.
As a simple example, consider the following ``controlled swap'' causal function on $\Theta$:
\[
\begin{array}{rcl}
\hist{A/k_\ev{A}}
&\stackrel{\text{cswap}}{\mapsto}&
\hist{A/k_\ev{A}}
\\
\hist{A/0,B/k_\ev{B},C/k_\ev{C}}
&\stackrel{\text{cswap}}{\mapsto}&
\hist{B/k_\ev{B},C/k_\ev{C}}
\\
\hist{A/1,B/k_\ev{B},C/k_\ev{C}}
&\stackrel{\text{cswap}}{\mapsto}&
\hist{B/k_\ev{C},C/k_\ev{B}}
\\
\end{array}
\]
The controlled swap function requires true bipartite signalling, where events \ev{B} and \ev{C} are delocalised even conditional to the input at \ev{A}.
Indeed, when the input at \ev{A} is 1:
\begin{enumerate}
    \item the output at \ev{B} depends on the input at \ev{C}, which must therefore be in \ev{B}'s past;
    \item the output at \ev{C} depends of the input at \ev{B}, which must therefore be in \ev{C}'s past.
\end{enumerate}
As a consequence, the controlled swap function cannot arise from any causal function $f$ on any causally complete subspace $\Theta' \leq \Theta$ (i.e. we cannot have $\restrict{\Ext{f}}{\Ext{\Theta}} = \Ext{\text{cswap}}$).
To see why, consider the extended input history \hist{A/1,B/0,C/0}, with tips $\evset{B,C}$.
Any causal completion $\Theta'$ of our space $\Theta$ must necessarily include as an extended input history one of the following partial functions:
\begin{enumerate}
    \item \hist{A/1,C/0}, obtained by removing $\ev{B}$ from the domain of \hist{A/1,B/0,C/0}
    \item \hist{A/1,B/0}, obtained by removing $\ev{C}$ from the domain of \hist{A/1,B/0,C/0}
\end{enumerate}
In either case, the causal function $\text{cswap} \in \CausFun{\Theta, \{0,1\}}$ cannot arise from any $f' \in \CausFun{\Theta', \{0,1\}}$, because $\Ext{f'}$ cannot satisfy the consistency condition.
If $\hist{A/1,C/0} \in \Ext{\Theta'}$, we are forced to make the following inconsistent assignments:
\begin{itemize}
    \item from $\hist{A/1,C/0} \leq \hist{A/1,B/0,C/0}$, we must have:
    \[
        \Ext{f'}_{\ev{C}}\left(\hist{A/1,C/0}\right)
        =
        \Ext{f'}_{\ev{C}}\left(\hist{A/1,B/0,C/0}\right)=0
    \]
    \item from $\hist{A/1,C/0} \leq \hist{A/1,B/1,C/0}$, we must have:
    \[
        \Ext{f'}_{\ev{C}}\left(\hist{A/1,C/0}\right)
        =
        \Ext{f'}_{\ev{C}}\left(\hist{A/1,B/1,C/0}\right)=1
    \]
\end{itemize}
If instead $\hist{A/1,B/0} \in \Ext{\Theta'}$, we are forced to make inconsistent assignments:
\begin{itemize}
    \item from $\hist{A/1,B/0} \leq \hist{A/1,B/0,C/0}$, we must have:
    \[
        \Ext{f'}_{\ev{B}}\left(\hist{A/1,B/0}\right)
        =
        \Ext{f'}_{\ev{B}}\left(\hist{A/1,B/0,C/0}\right)=0
    \]
    \item from $\hist{A/1,B/0} \leq \hist{A/1,B/0,C/1}$, we must have:
    \[
        \Ext{f'}_{\ev{B}}\left(\hist{A/1,B/0}\right)
        =
        \Ext{f'}_{\ev{B}}\left(\hist{A/1,B/0,C/1}\right)=1
    \]
\end{itemize}
The information above, proving that $\text{cswap}$ is inseparable, can be summarised as follows. There is an extended input history $k=\hist{A/1,B/0,C/0}$ such that for all events $\omega \in \dom{k}$ the function $\Ext{\text{cswap}}$ could not be extended to $\restrict{k}{\dom{k}\backslash\{\omega\}}$:
\begin{enumerate}
    \item if $\omega = \ev{B}$, $\restrict{k}{\dom{k}\backslash\{\omega\}} = \hist{A/1,C/0}$
    \item if $\omega = \ev{C}$, $\restrict{k}{\dom{k}\backslash\{\omega\}} = \hist{A/1,B/0}$
\end{enumerate}
This is because for each $\omega$ there is an extended input history $k'_\omega \in \Ext{\Theta}$ with $\restrict{k}{\dom{k}\backslash\{\omega\}} \leq k'_\omega$ and an event $\xi_\omega \in \dom{k}\backslash\{\omega\}$ such that $\Ext{\text{cswap}}(k)_{\xi_\omega} \neq \Ext{\text{cswap}}(k'_\omega)_{\xi_\omega}$:
\begin{enumerate}
    \item if $\omega = \ev{B}$, we can choose $k'_\omega = \hist{A/1,B/1,C/0}$ and $\xi_\omega = \ev{C}$
    \item if $\omega = \ev{C}$, we can choose $k'_\omega = \hist{A/1,B/0,C/1}$ and $\xi_\omega = \ev{B}$
\end{enumerate}
We refer to such a triple $\left(k, (k'_\omega)_\omega, (\xi_\omega)_\omega\right)$ as an ``inseparability witness'': it proves that the controlled swap cannot arise from a causal function $f'$ on a causally complete subspace $\Theta' \leq \Theta$.

The above intuitions about inseparable functions and inseparability witnesses are formalised by the following definitions.
A causal function $f \in \CausFun{\Theta, \underline{O}}$ is inseparable if and only if it admits an inseparability witness $(k, \underline{k'}, \underline{\xi})$ (cf. Theorem 4.9 p.45 \cite{gogioso2022topology}).

\begin{definition}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty output sets.
A causal function $f \in \CausFun{\Theta, \underline{O}}$ is said to be \emph{separable} if it arises from $f' \in \CausFun{\Theta', \underline{O}}$ for some causally complete $\Theta' \leq \Theta$, and \emph{inseparable} otherwise.
We refer to the causal functions which are (in)separable as \emph{(in)separable functions}, for short.
\end{definition}

\begin{definition}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty output sets.
An \emph{inseparability witness} for a causal function $f \in \CausFun{\Theta, \underline{O}}$ is a triple $(k, (k'_\omega)_{\omega \in \dom{k}}, (\xi_\omega)_{\omega \in \dom{k}})$ where: 
\begin{itemize}
    \item $k \in \Ext{\Theta}$ is an extended input history;
    \item for every $\omega \in \dom{k}$, $k'_\omega \in \Ext{\Theta}$ is such that $\restrict{k}{\dom{k}\backslash\{\omega\}} \leq k'_\omega$;
    \item for every $\omega \in \dom{k}$, $\xi_\omega \in \dom{k}\backslash\{\omega\}$ is such that $\Ext{f}(k)_{\xi_{\omega}} \neq \Ext{f}(k'_\omega)_{\xi_{\omega}}$.
\end{itemize}
We say that a causal function $f$ \underline{admits} an inseparability witness if such a witness exists for $f$.
\end{definition}

Having investigated the effects of causal incompleteness in the definition of causal functions, we now proceed to relax the tightness assumption: for each extended input history $k \in \Ext{\Theta}$ and $\omega \in \dom{k}$, we are no longer guaranteed that the input history $h \leq k$ with $\omega \in \tips{\Theta}{h}$ will be unique.
When $\Theta$ is not tight, this will impose additional constraints to the definition of causal functions $f \in \CausFun{\Theta}$: if $h, h' \leq k$ are distinct input histories such that $\omega \in \tips{\Theta}{h} \cap \tips{\Theta}{h'}$, then the outputs $f(h)_\omega$ and $f(h')_\omega$ at event $\omega$ must coincide.

\begin{definition}
Let $\Theta$ be a space of input histories.
For each $\omega \in \Events{\Theta}$, the \emph{tip histories} for $\omega$ are the input histories which have $\omega$ as a tip event:
\begin{equation*}
    \TipHists{\Theta}{\omega}
    :=
    \suchthat{h \in \Theta}{\omega \in \tips{\Theta}{h}}
\end{equation*}
\end{definition}

\begin{definition}
\label{definition:hist-constrained-at-event}
Let $\Theta$ be a space of input histories.
For any $\omega \in \Events{\Theta}$, we say that two histories $h, h' \in \Theta$ are \emph{constrained at $\omega$}, written $\histconstr{\omega}{h}{h'}$, if they both have $\omega$ as a tip event and the consistency condition from Definition \ref{definition:consistency-condition} forces all extended functions $\hat{F} \in \ExtFun{\Theta, \{0,1\}}$ to output the same value for $\omega$ on $h$ and $h'$:
\[
    \hat{F}(h)_\omega = \hat{F}(h')_\omega
\]
\end{definition}

The relation $\histconstr{\omega}{h}{h'}$ is an equivalence relation for fixed $\omega$, and a space $\Theta$ is tight if an only if $\histconstr{\omega}{h}{h'}$ always implies $h=h'$ (cf. Proposition 4.10 and Corollary 4.11 p.48 \cite{gogioso2022topology}).

\begin{definition}
\label{definition:causal-function}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
The \emph{causal functions} $\CausFun{\Theta, \underline{O}}$ for space $\Theta$ and outputs $\underline{O}$ are the functions mapping each history in $\Theta$ to the output values for its tip events, subject to the the additional requirement that $f(h)_\omega = f(h')_\omega$ for any input histories $h,h'$ which are constrained at an event $\omega$:
\begin{equation*}
    \CausFun{\Theta, \underline{O}}
    :=
    \suchthat{\!\!
        f \in \prod_{h \in \Theta}
        \prod_{\omega \in \tips{\Theta}{h}}
        \!\!\!O_{\omega}
    }
    {
       \histconstr{\omega}{h}{h'} \Rightarrow f(h)_\omega\!=\!f(h')_\omega
    \!\!}
\end{equation*}
\end{definition}

At first sight, such constrains make is seem like the definition of causal functions is no longer ``free'', but this is not actually the case: instead of a constrained mapping of individual input histories to outputs at their tip event(s), we can think of a causal function on a non-tight space as a free mapping of equivalence classes of input histories to outputs on a common tip event.
For any $\omega \in \Events{\Theta}$, we define $\TipEqCls{\Theta}{\omega}$ to be the set of equivalence classes for $\histconstrSym{\omega}$:
\begin{equation*}
    \TipEqCls{\Theta}{\omega}
    :=
    \TipHists{\Theta}{\omega}\!/\!\histconstrSym{\omega}
    =
    \suchthat{\histconstreqcls{h}{\omega}}{h \in \TipHists{\Theta}{\omega}}
\end{equation*}
We then observe that there is a bijection between the causal functions in $\CausFun{\Theta, \underline{O}}$ and the functions freely mapping each event $\omega \in \Events{\Theta}$ and each equivalence class $\histconstreqcls{h}{\omega} \in \TipEqCls{\Theta}{\omega}$ to the common output value at $\omega$ for all input histories in $\histconstreqcls{h}{\omega}$:
\begin{equation*}
\begin{array}{rcl}
    \CausFun{\Theta, \underline{O}}
    &\longleftrightarrow&
    \prod\limits_{\omega \in \Events{\Theta}} \left(O_\omega\right)^{\TipEqCls{\Theta}{\omega}}
    \\
    f
    &\mapsto&
    \left(
        \left(\omega, \histconstreqcls{h}{\omega}\right) \mapsto f(h)_\omega
    \right)
    \\
    \left(
    h \mapsto
    \left(g\left(\omega,\histconstreqcls{h}{\omega}\right)\right)_{\omega \in \tips{\Theta}{h}}
    \right)
    &\mapsfrom&
    g
\end{array}
\end{equation*}
With this observation, we are finally in a position to fully generalise our definition of causal functions and their characterisation, to accommodate the possibility of causal incompleteness and/or lack of tightness.

\begin{definition}
\label{definition:ext-f}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
For each causal function $f \in \CausFun{\Theta, \underline{O}}$, define the corresponding \emph{extended causal function} $\Ext{f} \in \ExtFun{\Theta, \underline{O}}$ as follows:
\begin{equation*}
    \Ext{f}(k)
    :=
    \left(f\left(h_{k,\omega}\right)_\omega\right)_{\omega \in \dom{k}}
    \text{ for all }
    k \in \Ext{\Theta}
\end{equation*}
where $h_{k,\omega}$ is any input history $h \in \TipHists{\Theta}{\omega}$ such that $h \leq k$.
We refer to $\Ext{f}(k)$ as the \emph{extended output history} corresponding to extended input history $k$.
We write $\ExtCausFun{\Theta, \underline{O}}$ for the subset of $\ExtFun{\Theta, \underline{O}}$ consisting of the extended causal functions.
\end{definition}

The function $\Ext{f}$ is well-defined because the definition of the causal function $f$ implies that $f\left(h_{k, \omega}\right)_\omega$ is the same for any choice of $h_{k, \omega}$.
It is then again a fact (cf. Theorem 4.14 p.49 \cite{gogioso2022topology}) that the extended functions $\hat{F} \in \ExtFun{\Theta, \underline{O}}$ which are causal are exactly those which satisfy the consistency condition.
Indeed, the following defines a causal function $\Prime{\hat{F}} \in \CausFun{\Theta, \underline{O}}$ such that $\Ext{\Prime{\hat{F}}} = \hat{F}$:
\begin{equation*}
    \Prime{\hat{F}} := h \mapsto \left(\hat{F}(h)_\omega\right)_{\omega \in \tips{\Theta}{h}}
\end{equation*}
Furthermore, the above causal function is the unique $f \in \CausFun{\Theta, \underline{O}}$ such that $\Ext{f} = \hat{F}$ and we can express extended causal functions as ``gluings'' of the output values of causal functions, via compatible joins (cf. Proposition 4.15 p.49 \cite{gogioso2022topology}).

The restriction of $\Ext{f}$ to the maximal extended input histories is a joint IO function for the operational scenario $(\Events{\Theta}, \underline{\Inputs{\Theta}}, \underline{O})$ which is causal for $\Theta$.
Conversely, it is a fact (cf. Proposition 4.16 p.49 \cite{gogioso2022topology}) any joint IO function $F$ which is causal for $\Theta$ arises as the restriction of $\Ext{f}$ to maximal extended input histories, where $f \in \CausFun{\Theta, \underline{O}}$ can be defined as follows for all $\omega \in \tips{\Theta}{h}$:
\begin{equation*}
\label{equation:causal-fun-from-extended-fun}
    f(h)_\omega
    :=
    F(k)_\omega
    \text{ for any maximal ext. input history $k$ s.t. } h \leq k    
\end{equation*}

Finally, it is possible to derive factorisation results for causal functions in the presence of parallel composition, sequential composition and conditional sequential composition (cf. Theorems 4.17, 4.18 and 4.19 p.50 \cite{gogioso2022topology}).
The set of causal functions for the parallel composition space $\Theta \cup \Theta'$ factors into the product of the causal functions on the individual spaces:
\begin{equation*}
     \CausFun{\Theta \cup \Theta', \underline{O}\vee\underline{O}'}
     \cong
     \CausFun{\Theta, \underline{O}}
     \times
     \CausFun{\Theta', \underline{O}'}
\end{equation*}
The set of causal functions for the sequential composition space $\Theta \seqcomposeSym \Theta'$ factors into the product of the causal functions on $\Theta$ and the families of causal functions on $\Theta'$ indexed by the maximal extended input histories of $\Theta$:
\begin{equation*}
     \CausFun{\Theta \seqcomposeSym \Theta', \underline{O}\vee\underline{O}'}
     \cong
     \CausFun{\Theta, \underline{O}}
     \times
     \CausFun{\Theta', \underline{O}'}^{\max\Ext{\Theta}}
\end{equation*}
The set of causal functions for the conditional sequential composition space $\Theta \seqcomposeSym \underline{\Theta'}$ factors into the product of the causal functions on $\Theta$ and the families of causal functions on the spaces $\Theta'_k$ indexed by the maximal extended input histories $k \in \max\Ext{\Theta}$:
\begin{equation*}
     \CausFun{\Theta \seqcomposeSym \underline{\Theta'}, \underline{O}\vee\underline{O}'}
     \cong
     \CausFun{\Theta, \underline{O}}
     \times
     \hspace{-5mm}
     \prod_{k \in \max\Ext{\Theta}}
     \hspace{-5mm}
     \CausFun{\Theta', \underline{O}'_k}
\end{equation*}


\subsection{The presheaf of (extended) causal functions}
\label{subsection:topology-causality-psheaf}

The (extended) causal functions defined in the previous subsections are an example of ``causal data'', that is, data defined on a space of input histories and respecting the associated causal constraints.
However, (extended) causal functions are a rather special case: as the correspondence with joint IO functions shows, they can be obtained from objects defined globally on the space by applying certain constraints, making them an example of non-contextual data.
This means that we can't use causal functions directly as a blueprint to define causal data in theories, such as quantum theory, where contextuality is a feature---both expected and desirable.
Instead, we must first shift from the global perspective to a more general contextual perspective: this is where topology finally comes into the picture.

The definition of compatible contextual data and the process that ``glues'' it together into global data is the purview of \emph{sheaf theory}, a complex mathematical discipline at the intersection of topology, geometry, algebra and category theory.
From the perspective of sheaf theory, ``contextual data'' is data associated to the open sets of some topological space, the ``contexts'', together with an appropriate definition of what it means to ``restrict'' data to open subsets.
The possible values taken by data on the open sets of a topological space, together with a specification for its restriction, defines what's known as a ``presheaf''.
Contextual data specified on different open sets is ``compatible'' if it has the same restrictions to all common open subsets: a ``sheaf'' is a presheaf where compatible contextual data can always be ``glued'' together, in a unique way.

\begin{definition}
Let $X$ be a topological space and let $\mathcal{T}(X)\subseteq \Subsets{X}$ be it collection of open sets, which we also refer to as the \emph{contexts}.
A \emph{presheaf} $P$ on $X$ is an association of:
\begin{itemize}
    \item a set $P(U)$ to each $U \in \mathcal{T}(X)$, specifying the possible values for \emph{contextual data} on $U$;
    \item a \emph{restriction} $P(U,V): P(U) \rightarrow P(V)$ for each open set $U$ and each open subset $V \subseteq U$, restricting contextual data on $U$ to corresponding contextual data on $V$.
\end{itemize}
The restrictions are required to satisfy the following conditions: 
\begin{enumerate}
    \item $P(U,U) = id_{P(U)}$, i.e. the trivial restriction from $U$ to $U$ is the identity on $P(U)$;
    \item $P(V, W) \circ P(U, V) = P(U, W)$, i.e. restrictions are stable under function composition.
\end{enumerate}
When the presheaf $P$ is clear from context, we adopt the following lightweight notation for restriction of contextual data $a \in P(U)$ to some open subset $V \subseteq U$:
\[
    \restrict{a}{V} := P(U,V)(a)
\]
The two restriction conditions can then be rewritten as follows, for all $a \in P(U)$
\begin{equation*}
\text{(i)}\hspace{2mm}
\restrict{a}{U} = a
\hspace{30mm}
\text{(ii)}\hspace{2mm}
\restrict{\left(\restrict{a}{V}\right)\!}{W} = \restrict{a}{W}    
\end{equation*}
\end{definition}

\begin{definition}
Let $X$ be a topological space and let $P$ be a presheaf on $X$.
Let $\mathfrak{U} \subseteq \mathcal{T}(X)$ be a family of open sets in $X$ and let $a = (a_U)_{U \in \mathfrak{U}}$ be a family specifying contextual data on the open sets in $\mathfrak{U}$.
We say that $a$ is a \emph{compatible family} (for $P$) if for every $U, U' \in \mathfrak{U}$ we have:
\begin{equation*}
    \restrict{\left(a_U\right)\!}{U \cap U'} = \restrict{\left(a_{U'}\right)\!}{U \cap U'}
\end{equation*}
that is, if the restriction of data on $U$ to the intersection $U\cap U'$ coincides with the restriction of data on $U'$ to the same intersection.
\end{definition}

\begin{definition}
Let $X$ be a topological space and let $P$ be a presheaf on $X$.
Let $\mathfrak{U} \subseteq \mathcal{T}(X)$ be a family of open sets in $X$ and let $a = (a_U)_{U \in \mathfrak{U}}$ be a family specifying contextual data on the open sets in $\mathfrak{U}$.
We say that some contextual data $\hat{a} \in P\left(\bigcup \mathfrak{U}\right)$ is a \emph{gluing} for the family $a$ if it restricts to $a_U$ for all $U \in \mathfrak{U}$:
\begin{equation*}
    \restrict{\hat{a}}{U} = a_U
\end{equation*}
We say that $P$ is a \emph{sheaf} if every compatible family has exactly one gluing.
\end{definition}

Typically, data can be specified in many isomorphic ways, corresponding to different sets of values connected by suitable bijections.
A similar notion of isomorphism holds for contextual data specified by presheaves: in this ``natural'' isomorphism, the individual sets of data values assigned by two presheaf to each context are put in bijection, in such a way as to respect restrictions.

\begin{definition}
Let $X$ be a topological space and let $\mathcal{T}(X)\subseteq \Subsets{X}$ be it collection of open sets. 
We say that two presheaves $P$ and $P'$ on $X$ are \emph{naturally isomorphic}, written $P \cong P'$, if there is a family $\phi = \left(\phi_U\right)_{U \in \mathcal{T}(X)}$ of bijections $\phi_U: P(U) \rightarrow P'(U)$ such that for all inclusions $V \leq U$ of open sets we have:
\begin{equation*}
\phi_V \circ P(U, V)
=
P'(U, V) \circ \phi_U    
\end{equation*}
The commutation condition can be written more succinctly as follows, for all $a \in P(U)$:
\[
\phi_V(\restrict{a}{V})
=
\restrict{\phi_U(a)}{V}
\]
If we wish to specify a specific \emph{natural isomorphism} $\phi$, we can also write $\phi: P \cong P'$.
\end{definition}

In order for the machinery of sheaf theory to become available to us, we must first endow our spaces of input histories with a suitable topology.
Because a space of input histories $\Theta$ is a partial order, a natural choice of topology is given by taking its lower sets $\Lsets{\Theta}$ to be the open sets.
This is the dual of the Alexandrov topology, where the upper sets are taken to be the open sets, and all techniques applicable to Alexandrov topologies naturally dualise to lowerset topologies.
In particular, we make the following standard observations:
\begin{itemize}
    \item The points of $\Theta$, i.e. the input histories $h \in \Theta$, can be identified with downsets $\downset{h} \in \Lsets{\Theta}$.
    \item The downsets of input histories are exactly the lowersets $U \in \Lsets{\Theta}$ which are $\cup$-prime, i.e. those which cannot be written as $U=V\cup W$ for some lowersets $V,W \neq U$.
    \item The order on $\Theta$ can be reconstructed from the inclusion order on $\Lsets{\Theta}$, by observing that $h \leq h'$ if and only if $\downset{h} \subseteq \downset{h'\!}$.
\end{itemize}
But there's more!
The extended input histories $k \in \Ext{\Theta}$ can themselves be identified with certain lowersets, namely with the intersection $\downset{k\!}\!\cap\;\Theta$ of their downset in $\Ext{\Theta}$ with the space $\Theta$.
This identification is both injective and order-preserving, generalising the previous identification of $h \in \Theta$ with $\downset{h}$:
\[
\begin{array}{rcl}
\left(\Ext{\Theta}, \leq\right)
&\lhook\joinrel\longrightarrow&
\left(\Lsets{\Theta}, \subseteq\right)
\\
k
&\mapsto&
\downset{k\!}\!\cap\;\Theta
\end{array}
\]
Clearly, lowersets $\Lsets{\Theta}$ provide an equivalent way to talk about input histories, extended input histories and their order: we adopt then as our default topology for spaces of (extended) input histories, as well as other spaces derived from partial functions.

\begin{definition}
When talking about spaces of (extended) input histories as topological spaces, we take them endowed with the lowerset topology.
Unless otherwise specified, when talking about subsets $S \subseteq \PFun{\underline{Y}}$ we take them endowed with the partial order of $\PFun{\underline{Y}}$ and the lowerset topology.
\end{definition}

It is a well-known fact (proven, for convenience, in Proposition 4.22 p.54 \cite{gogioso2022topology}) that functions between partial orders are order-preserving exactly when they are continuous with respect to the lowerset topology.
By using the alternative characterisation of causality as consistency/gluing, we can then show (cf. Theorem 4.26 p.55 \cite{gogioso2022topology}) that an extended function $\hat{F} \in \ExtFun{\Theta, \underline{O}}$ is causal if and only if it is continuous as a function $\hat{F}:\Ext{\Theta} \rightarrow \PFun{\underline{O}}$ where both $\Ext{\Theta}$ and $\PFun{\underline{O}}$ are equipped with the lowerset topology.

Having drawn a clear connection between causality and lowerset topology, we now wish to formulate (extended) causal functions as a special case of causal data, potentially patched together from contextual parts.
In other words, we now proceed to construct a ``presheaf of (extended) causal functions''.
As our first step, we show (Propositions 4.27 and 4.28 p.55 \cite{gogioso2022topology}) that the lowersets of spaces of input histories, i.e. the open sets in their topologies, are themselves spaces of input histories.
They inherit tightness and tip events from their parent spaces, but not necessarily causal completeness (because they might fail to satisfy the free-choice condition).
However, preservation of tips and constraints for input histories immediately imply (cf. Corollary 4.29 p.55 \cite{gogioso2022topology}) that causal functions restrict to causal functions, providing the impetus for a very straightforward definition of the presheaf of causal functions.

\begin{definition}
\label{definition:causal-function-presheaf}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
The \emph{presheaf of causal functions} $\CausFun{\Lsets{\Theta}, \underline{O}}$ for space $\Theta$ and outputs $\underline{O}$ is the presheaf on the topological space $\Theta$ defined as follows:
\begin{itemize}
    \item to lowersets $\lambda \in \Lsets{\Theta}$, the open sets of $\Theta$, it associates the causal functions for $\lambda$:
    \begin{equation*}
        \CausFun{\Lsets{\Theta}, \underline{O}}\left(\lambda\right)
        :=
        \CausFun{\lambda, \underline{O}}
    \end{equation*}
    \item to inclusions $\lambda' \subseteq \lambda$ of lowersets, it associates ordinary function restriction:
    \begin{equation*}
        \CausFun{\Lsets{\Theta}, \underline{O}}\left(\lambda, \lambda'\right)
        :=
        f \mapsto \restrict{f}{\lambda'}
    \end{equation*}
\end{itemize}
Compatible families are families of functions which are compatible in the sense of Definition~3.3 from \cite{gogioso2022combinatorics}: their gluing is given by their compatible join whenever the compatible join is causal, and no gluing exists otherwise (cf. Theorem 4.30 p.56 \cite{gogioso2022topology}).
\end{definition}

Extended causal functions can also be arranged into a presheaf, which is naturally isomorphic to the presheaf of causal functions via the bijection $f \mapsto \Ext{f}$ (cf. Proposition 4.35 p.59 \cite{gogioso2022topology}).
The reason for explicitly defining such a presheaf is one of convenience: the data of extended causal functions is already ``glued together'', providing outputs for all events in the domain of any extended input history.


\begin{definition}
\label{definition:ext-causal-function-presheaf}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
The \emph{presheaf of extended causal functions} $\ExtCausFun{\Lsets{\Theta}, \underline{O}}$ for space $\Theta$ and outputs $\underline{O}$ is the presheaf on the topological space $\Theta$ defined as follows:
\begin{itemize}
    \item to lowersets $\lambda \in \Lsets{\Theta}$, it associates the extended causal functions for $\lambda$:
    \begin{equation*}
        \ExtCausFun{\Lsets{\Theta}, \underline{O}}\left(\lambda\right)
        :=
        \ExtCausFun{\lambda, \underline{O}}
    \end{equation*}
    \item to inclusions $\lambda' \subseteq \lambda$ of lowersets, it associates the following restrictions:
    \begin{equation*}
        \ExtCausFun{\Lsets{\Theta}, \underline{O}}\left(\lambda, \lambda'\right)
        :=
        \Ext{f} \mapsto \restrict{\Ext{f}}{\Ext{\lambda}}
    \end{equation*}
\end{itemize}
\end{definition}

\begin{remark}
Previous work on non-locality \cite{abramsky2011sheaf} shows that the presheaf of causal functions for the discrete/no-signalling space---therein called the ``sheaf of events''---is a sheaf: this remains true for tight spaces of input histories, but fails to hold in general once the requirement for tightness is dropped.
We refer to the novel phenomenon responsible for this failure as ``solipsistic contextuality'' (cf. Definition 4.23 p.50 of ``The Topology of Causality'' \cite{gogioso2022topology}): certain non-tight spaces make it possible to define contextual causal constraints, so that compatible families of functions which are causal locally to each context might fail to be gluable to functions which are causal for the entire space (cf. Theorem 4.34 p.51 of ``The Topology of Causality'' \cite{gogioso2022topology}).
\end{remark}


\subsection{Empirical models}
\label{subsection:topology-causality-empmod}

Having recast causal functions into contextual objects, we are finally ready to step away from determinism and enter the world of probabilities and empirical models.
In this subsection, we only deal with topological and sheaf-theoretic aspects of empirical models: the geometric picture, where empirical models are identified with the points of certain polytopes, is entirely the purview of Section \ref{section:geometry-causality}.

As our first ingredient, we turn our presheaves of (extended) causal functions into presheaves of distributions over (extended) causal functions, where restrictions are given by distribution marginalisation.
These presheaves are obtained from causal functions by using a mapping known as the ``distribution monad''.
The distribution monad sends a set $X$ to the set $\Dist{X}$ of finitely supported probability distributions over $X$, and it linearly extends functions $f: X \rightarrow Y$ between sets to functions $\Dist{f}: \Dist{X} \rightarrow \Dist{Y}$ defined on probability distributions.

\begin{definition}
The \emph{distribution monad} $\DistSym$ is the following mapping on sets and functions:
\begin{itemize}
    \item If $X$ is a set, $\Dist{X}$ is the set of probability distributions over $X$ with finite support:
    \begin{equation*}
        \Dist{X}
        :=
        \suchthat{d: X \rightarrow \mathbb{R}^+}{\sum_{x \in X}d(x) = 1, \supp{d}\text{ is finite}}
    \end{equation*}
    where the support of a distribution is the set of points over which it is non-zero:
    \begin{equation*}
        \supp{d} := \suchthat{x \in X}{d(x) \neq 0}
    \end{equation*}
    \item If $f: X \rightarrow Y$ is a function between sets, $\Dist{f}$ is the function $\Dist{X} \rightarrow \Dist{Y}$ defined as the linear extension of $f$ to probability distributions with finite support:
    \begin{equation*}
        \Dist{f}
        :=
        d
        \mapsto
        \sum_{x \in X} d(x) \delta_{f(x)}
    \end{equation*}
    where $\delta_{y} \in \Dist{Y}$ is the delta distribution at $y$:
    \begin{equation*}
        \delta_{y}
        :=
        y' \mapsto
        \left\{
        \begin{array}{l}
        1 \text{ if } y' = y\\
        0 \text{ otherwise}
        \end{array}
        \right.
    \end{equation*}
\end{itemize}
\end{definition}

As it turns our, we can ``compose'' the distribution monad $\DistSym$ with a presheaf $P$ to form a new presheaf $\DistSym P$, where the contextual data defined by $\DistSym P$ consists of probability distributions over the contextual data originally defined by $P$.

\begin{definition}
Let $X$ be a topological space and let $\mathcal{T}(X)\subseteq \Subsets{X}$ be it collection of open sets.
For a presheaf $P$ on $X$, let $\DistSym P$ be the following mapping:
\begin{itemize}
    \item On an open set $U \in \mathcal{T}(X)$, define $\DistSym P(U) := \Dist{P(U)}$.
    \item On a subset inclusion $V \leq U$, define $\DistSym P(U, V) := \Dist{P(U, V)}$.
\end{itemize}
\end{definition}

Composition is simple to define, and it conveniently respects natural isomorphism between presheaves: if $P$ is a presheaf on $X$, then $\DistSym P$ is also a presheaf on $X$ (cf. Proposition 4.38 p.60 \cite{gogioso2022topology}) and if $\phi: P \cong P'$ are naturally isomorphic then $\DistSym\phi: \DistSym P \cong \DistSym P'$ are also naturally isomorphic (cf. Proposition 4.39 p.61 \cite{gogioso2022topology}).
We could thus define our causal distributions equivalently using causal functions or extended causal functions, since the two presheaves are isomorphic.
To simplify our upcoming definition of empirical models, we choose extended causal functions as our base for causal distributions.

\begin{definition}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty output sets.
The \emph{presheaf of causal distributions} for $\Theta$ is defined as follows:
\begin{equation*}
    \CausDist{\Lsets{\Theta},\underline{O}}
    :=
    \DistSym \,\ExtCausFun{\Lsets{\Theta},\underline{O}}
\end{equation*}
We also define the following notation for the individual sets of distributions:
\begin{equation*}
    \CausDist{\lambda,\underline{O}}
    :=
    \Dist{\ExtCausFun{\lambda, \underline{O}}}
\end{equation*}
\end{definition}

It can be shown (cf. Proposition 4.40 p.61 \cite{gogioso2022topology}) that restrictions of the presheaf $\CausDist{\Lsets{\Theta},\underline{O}}$ act by marginalisation on probability distributions $d \in \CausDist{\lambda,\underline{O}}$:
\begin{equation*}
\label{equation:causal-dist-marginal}
    \restrict{d}{\lambda'}
    =
    \Ext{f'}
    \mapsto
    \hspace{-3mm}
    \sum_{f \text{ s.t. } \restrict{f}{\lambda'}=f'}
    \hspace{-3mm}
    d\left(\Ext{f}\right)
\end{equation*}
In words, the probability assigned by the marginal $\restrict{d}{\lambda'} \in \CausDist{\lambda',\underline{O}}$ to a generic extended causal function $\Ext{f'} \in \ExtCausFun{\lambda', \underline{O}}$ is the sum of the probabilities assigned by $d$ to all extended causal functions $\Ext{f} \in \ExtCausFun{\lambda, \underline{O}}$ which restrict to $\Ext{f'}$.

\begin{definition}
\label{definition:standard-emp-model}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
A \emph{standard empirical model} $e$ is a compatible family $e = (e_{\downset{k}})_{k \in \max\Ext{\Theta}}$ for the presheaf of causal distributions:
\[
e_{\downset{k}} \in \CausDist{\downset{k\!}, \underline{O}}
\]
\end{definition}

In the next Section, we shall prove that standard empirical models admit a description in terms of distributions on extended output histories conditional to maximal extended input histories.
For example, we will study the following empirical model for the causal fork space $\Theta = \Hist{\discrete{C}\seqcomposeSym\discrete{A,B}, \{0,1\}}$:
\begin{center}
\begin{tabular}{l|rrrrrrrr}
\hfill
ABC & 000 & 001 & 010 & 011 & 100 & 101 & 110 & 111\\
\hline
000 & $1/4$ & $1/4$ & $0$ & $0$ & $0$ & $0$ & $1/4$ & $1/4$\\
001 & $0$ & $0$ & $1/4$ & $1/4$ & $1/4$ & $1/4$ & $0$ & $0$\\
010 & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$\\
011 & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$\\
100 & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$\\
101 & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$ & $1/8$\\
110 & $1/4$ & $0$ & $0$ & $1/4$ & $0$ & $1/4$ & $1/4$ & $0$\\
111 & $1/4$ & $0$ & $0$ & $1/4$ & $0$ & $1/4$ & $1/4$ & $0$\\
\end{tabular}
\end{center}
In this tabular form, each row $i_Ai_Bi_C$ corresponds to a maximal extended input history $\hist{A/i_A, B/i_B, C/i_C} \in \StdCov{\Theta}$, while each column $o_Ao_Bo_C$ corresponds to an associated extended output history $\hist{A/o_A, B/o_B, C/o_C}$.
For now, however, each line $i_Ai_Bi_C$ of the same empirical model has to be defined explicitly as a distribution on extended causal functions:
\[
\Dist{\ExtCausFun{\downset{\hist{A/i_A, B/i_B, C/i_C}}, \{0,1\}}}
\]
Equivalently, we look at distributions on causal functions, which are freely characterised:
\[
\Dist{\CausFun{\downset{\hist{A/i_A, B/i_B, C/i_C}}, \{0,1\}}}
\]
Because the space of histories $\Theta$ is both tight and causally complete, the causal functions on $\downset{\hist{A/i_A, B/i_B, C/i_C}}$ take the following form:
\[
    \prod_{h \leq \hist{A/i_A, B/i_B, C/i_C}}
    O_{\tip{\Theta}{h}}
\]
where we used the fact that $\tip{\downset{\hist{A/i_A, B/i_B, C/i_C}}}{h}=\tip{\Theta}{h}$ to simplify the expression.
The input histories $h \leq \hist{A/i_A, B/i_B, C/i_C}$ are exactly:
\begin{itemize}
    \item $h = \hist{C/i_C}$ with tip event \ev{C}
    \item $h = \hist{C/i_C, A/i_A}$ with tip event \ev{A}
    \item $h = \hist{C/i_C, B/i_B}$ with tip event \ev{B}
\end{itemize}
Hence the causal functions in $\CausFun{\downset{\hist{A/i_A, B/i_B, C/i_C}}, \{0,1\}}$ are:
\[
f_{o_Ao_Bo_C|i_Ai_Bi_C}:=
\left\{
\begin{array}{rl}
    \hist{C/i_C}       &\mapsto o_C\\
    \hist{C/i_C,A/i_A} &\mapsto o_A\\
    \hist{C/i_C,B/i_B} &\mapsto o_B
\end{array}
\right.
\]
Using these functions, we can reconstruct the desired distribution for each row of the empirical model above.
For example, the second row is indexed by the maximal extended input history $\hist{A/0, B/0, C/1}$ and it corresponds to the following distribution on extended causal functions:
\[
\frac{1}{4}\delta_{\Ext{f_{010|001}}}
+\frac{1}{4}\delta_{\Ext{f_{011|001}}}
+\frac{1}{4}\delta_{\Ext{f_{100|001}}}
+\frac{1}{4}\delta_{\Ext{f_{101|001}}}
\]
Doing this for all rows yields the following standard empirical model:
\[
e_{\downset{\hist{A/i_\ev{A}, B/i_\ev{B}, C/i_\ev{C}}}}
:=
\left\{
\begin{array}{rl}
\frac{1}{4}\sum\limits_{o_\ev{A}\oplus o_\ev{B} = i_\ev{C}}\sum\limits_{o_\ev{C}} \delta_{\Ext{f_{o_\ev{A}o_\ev{B}o_\ev{C}|i_\ev{A}i_\ev{B}i_\ev{C}}}}
&\text{ if } i_\ev{A} = i_\ev{B}\\
\frac{1}{8}\sum\limits_{o_\ev{A}}\sum\limits_{o_\ev{B}}\sum\limits_{o_\ev{C}} \delta_{\Ext{f_{o_\ev{A}o_\ev{B}o_\ev{C}|i_\ev{A}i_\ev{B}i_\ev{C}}}}
&\text{ if } i_\ev{A} \neq i_\ev{B}
\end{array}
\right.
\]

In Definition \ref{definition:standard-emp-model}, we referred to our empirical models as ``standard''.
As we will discuss in the next Section, standard empirical models encompass the probability distributions on joint outputs conditional to joint inputs which are considered in previous literature on causality, further extended to the very many new causal constraints that can be expressed using arbitrary (e.g. non-tight) spaces of input histories.
As a very special case---corresponding to the discrete spaces at the bottom of our causal hierarchies---standard empirical models capture all non-locality scenarios previously described by the sheaf-theoretic literature.
However, standard empirical models are too specific to cover more general examples of contextuality, such as those studied in previous sheaf-theoretic literature or the solipsistic contextuality examples we previously explored.
Luckily, it is straightforward to extend our definition to encompass all such examples.
The key is to observe that $\suchthat{\downset{k}}{k \in \max\ExtHist{\Theta, \underline{O}}}$ is an example of an ``open cover'' for the topological space $\Theta$, and to explore what happens if we define empirical models on other such open covers.
What we derive is a ``hierarchy of contextuality'', corresponding to different operational assumptions. Three covers are of particular interest.
\begin{itemize}
    \item The ``standard cover'' $\suchthat{\downset{k}}{k \in \max\ExtHist{\Theta, \underline{O}}}$, accommodating generic causal distributions on joint outputs conditional to the maximal extended input histories.
    It models settings where it is, at the very least, possible to define conditional distributions when all events are taken together.
    \item The ``classical cover'' $\{\Theta\}$ is the ``coarsest'' cover, lying at the top of the hierarchy (cf. Proposition 4.42 p.45 \cite{gogioso2022topology}).
    It models settings admitting a deterministic causal hidden variable explanation.
    Empirical models on the classical cover can be restricted to every other open cover: the empirical models arising this way are known as ``non-contextual''.
    \item The ``fully solipsistic cover'' $\suchthat{\downset{h}}{h \in \max\Hist{\Theta, \underline{O}}}$ is the ``finest'' cover, lying at the bottom of the hierarchy (cf. Proposition 4.42 p.45 \cite{gogioso2022topology}).
    It models settings more restrictive than those modelled by the standard cover, where it might only be possible to define distributions over the events in the past of some event---``witnessing'' the existence of the events before it, so to speak.
    That is, the fully solipsistic cover accommodates all causal distributions on joint outputs conditional to the maximal input histories.
    Every empirical model can be restricted to the fully solipsistic cover, and if an empirical model is contextual then so is its restriction to the fully solipsistic cover.
    In particular, the fully solipsistic cover contains the empirical models witnessing solipsistic contextuality.
\end{itemize}
% Starting from any cover $\mathcal{C}$, we can obtain a coarser cover $\mathcal{C}'$ by fusing certain contexts---open sets of $\Theta$---together into their union.
% See ``The Topology of Causality'' \cite{gogioso2022topology} for further discussion.

\begin{definition}
Let $X$ be a topological space and $\mathcal{T}(X) \subseteq \Subsets{X}$ be its topology.
An \emph{open cover}, or simply a \emph{cover}, for $X$ is a maximal antichain in the partial order $\mathcal{T}(X)$, i.e. a collection $\mathcal{C} \subseteq \mathcal{T}(X)$ of open sets which are incomparable and which cover the whole space $X$:
\[
    % \forall U, V \in \mathcal{C}.\; V \leq U \Rightarrow V = U
    \forall U, V \!\in \mathcal{C}.\; U \!\neq\! V \Rightarrow
        \left[\, V \!\not\subseteq\! U \text{ and } U \!\not\subseteq V\! \,\right]
    \hspace{2cm}
    X = \bigcup_{U \in \mathcal{C}} U
\]
If $\mathcal{C}$ and $\mathcal{C}'$ are covers on $X$, we say that $\mathcal{C}'$ is \emph{finer} than $\mathcal{C}$, written $\mathcal{C}' \preceq \mathcal{C}$, when we have:
\begin{equation*}
    \mathcal{C}' \preceq \mathcal{C}
    \Leftrightarrow
    \forall V \in \mathcal{C}'.\,
    \exists U \in \mathcal{C}.\;
    \text{ s.t. } V \subseteq U
\end{equation*}
Equivalently, we say that $\mathcal{C}$ is \emph{coarser} than $\mathcal{C}'$.
Note that $\preceq$ is a partial order on covers for $X$, known as the \emph{refinement order}.
\end{definition}

If $a = (a_U)_{U \in \mathcal{C}}$ be a compatible family over a cover $\mathcal{C}$ and $\mathcal{C}' \preceq \mathcal{C}$ is a finer cover, then the following is a compatible family over $\mathcal{C}'$, known as the \emph{restriction} of $a$ to $\mathcal{C}'$:
\begin{equation*}
    \restrict{a}{\mathcal{C}'}
    :=
    (\restrict{a_{U_V}}{V})_{V \in \mathcal{C'}}
\end{equation*}
where $U_V \in \mathcal{C}$ is any open such that $V \subseteq U_V$.

\begin{definition}
Let $\Theta$ be a space of input histories.
\begin{itemize}
    \item The \emph{standard cover} on is defined as $\StdCov{\Theta}:=\suchthat{\downset{k}}{k \in \max\ExtHist{\Theta, \underline{O}}}$
    \item The \emph{fully solipsistic cover} is defined as $\SolCov{\Theta}:=\suchthat{\downset{h}}{h \in \max\Hist{\Theta, \underline{O}}}$
    \item The \emph{global cover} is defined as $\ClsCov{\Theta}:=\{\Theta\}$
\end{itemize}
The \emph{hierarchy of covers} for $\Theta$ is the set $\Covers{\Theta}$ of open covers ordered by refinement $\preceq$.
We refer to covers $\mathcal{C}$ such that $\mathcal{C} \not\preceq \StdCov{\Theta}$ as \emph{solipsistic covers}.
\end{definition}

% A our first and simplest example, we look at the open covers on the discrete space with 1 event and ternary inputs $\Hist{\ev{A}, \{0,1,2\}}$: we chose this particular example because it is simple enough that all covers can be enumerated explicitly, but at the same time supports an interesting contextual empirical model (on cover \#7 below).
% There are 9 open covers for this space, arranged in the following hierarchy.
% \begin{center}
%     \includegraphics[height=3cm]{svg-inkscape/covers-A-012_svg-tex.pdf}
% \end{center}
% Because $\Hist{\ev{A}, \{0,1,2\}}=\ExtHist{\ev{A}, \{0,1,2\}}$, the standard cover and fully solipsistic cover coincide for this example.
% \begin{itemize}
% \item Cover \#0 (standard/fully solipsistic cover) contains the following lowersets:
% \[
%     \left\{\pigl\{\hist{A/0}\pigr\}, \pigl\{\hist{A/1}\pigr\}, \pigl\{\hist{A/2}\pigr\}\right\}
% \]
% \item Cover \#1 contains the following lowersets:
% \[
%     \left\{\pigl\{\hist{A/0}\pigr\}, \pigl\{\hist{A/1}, \hist{A/2}\pigr\}\right\}
% \]
% \item Cover \#2 contains the following lowersets:
% \[
%     \left\{\pigl\{\hist{A/1}\pigr\}, \pigl\{\hist{A/0}, \hist{A/2}\pigr\}\right\}
% \]
% \item Cover \#3 contains the following lowersets:
% \[
%     \left\{\pigl\{\hist{A/2}\pigr\}, \pigl\{\hist{A/0}, \hist{A/1}\pigr\}\right\}
% \]
% \item Cover \#4 contains the following lowersets:
% \[
%     \left\{\pigl\{\hist{A/0}, \hist{A/1}\pigr\}, \pigl\{\hist{A/0}, \hist{A/2}\pigr\}\right\}
% \]
% \item Cover \#5 contains the following lowersets:
% \[
%     \left\{\pigl\{\hist{A/0}, \hist{A/1}\pigr\}, \pigl\{\hist{A/1}, \hist{A/2}\pigr\}\right\}
% \]
% \item Cover \#6 contains the following lowersets:
% \[
%     \left\{\pigl\{\hist{A/0}, \hist{A/2}\pigr\}, \pigl\{\hist{A/1}, \hist{A/2}\pigr\}\right\}
% \]
% \item Cover \#7 contains the following lowersets:
% \[
%     \left\{\pigl\{\hist{A/0}, \hist{A/1}\pigr\}, \pigl\{\hist{A/0}, \hist{A/2}\pigr\}, \pigl\{\hist{A/1}, \hist{A/2}\pigr\}\right\}
% \]
% \item Cover \#8 (global cover) contains the following lowersets:
% \[
%     \left\{\pigl\{\hist{A/0}, \hist{A/1}, \hist{A/2}\pigr\}\right\}
% \]
% \end{itemize}

As a simple example, we look at the hierarchy of open covers for the following space on 2 events with binary inputs (which is both tight and causally complete):
\begin{center}
    \begin{tabular}{cc}
    \includegraphics[height=2.25cm]{svg-inkscape/space-AB-1-highlighted_svg-tex.pdf}
    &
    \includegraphics[height=2.25cm]{svg-inkscape/space-AB-1-ext-highlighted_svg-tex.pdf}
    \\
    $\Theta$
    &
    $\Ext{\Theta}$
    \end{tabular}
\end{center}
This space has 80 open covers, arranged into the following partial order under refinement:
\begin{center}
\includegraphics[width=0.65\textwidth]{svg-inkscape/covers-space-AB-weird_svg-tex.pdf}
\end{center}
The standard cover \#5 is coloured violet in the hierarchy and takes the following form:
\[
\scalebox{0.80}{$\left\{\pigl\{\hist{A/0}, \hist{B/0}\pigr\}, \pigl\{\hist{A/0}, \hist{B/1,A/0}\pigr\}, \pigl\{\hist{A/1}, \hist{B/0}\pigr\}, \pigl\{\hist{A/1}, \hist{B/1,A/1}\pigr\}\right\}$}
\]
The refinements of the standard cover are coloured red in the hierarchy above.
They include the fully solipsistic cover \#0, which takes the following form:
\[
\scalebox{0.80}{$\left\{\pigl\{\hist{B/0}\pigr\}, \pigl\{\hist{A/0}, \hist{B/1,A/0}\pigr\}, \pigl\{\hist{A/1}, \hist{B/1,A/1}\pigr\}\right\}$}
\]
The two covers \#1 and \#2 lying between the solipsistic and standard cover take the following form, for $i_A \in \{0,1\}$:
\[
\scalebox{0.80}{$\left\{\pigl\{\hist{A/i_A}, \hist{B/0}\pigr\}, \pigl\{\hist{A/0}, \hist{B/1,A/0}\pigr\}, \pigl\{\hist{A/1}, \hist{B/1,A/1}\pigr\}\right\}$}
\]
The coarsenings of the standard cover are coloured blue in the hierarchy above.
They include the classical cover \#79, which takes the following form:
\[
\scalebox{0.80}{$\left\{\pigl\{\hist{A/0}, \hist{A/1}, \hist{B/0}, \hist{B/1,A/0}, \hist{B/1,A/1}\pigr\}\right\}$}
\]

Empirical models for an arbitrary cover $\mathcal{C}$ are a straightforward generalisation of those for the standard cover: families of distributions on causal functions for each lowerset $\lambda \in \mathcal{C}$.

\begin{definition}
\label{definition:emp-model}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
If $\mathcal{C}$ is a cover of $\Theta$, an \emph{empirical model} $e$ on $\mathcal{C}$ is a compatible family $e = (e_{\lambda})_{\lambda \in \mathcal{C}}$ for the presheaf of causal distributions $\CausDist{\Lsets{\Theta}, \underline{O}}$.
A \emph{standard empirical model} is an empirical model on the standard cover, a \emph{solipsistic empirical model} is an empirical model on a solipsistic cover, and a \emph{classical empirical model} is an empirical model on the classical cover.
We write $\EmpModels{\mathcal{C}, \underline{O}}$ for the empirical models on a cover $\mathcal{C}$ of $\Theta$, with outputs valued in $\underline{O}$.
\end{definition}

\begin{definition}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
Let $e$ be an empirical model.
We say that $e$ is \emph{non-contextual} if it arises as restriction $e = \restrict{\hat{e}}{\dom{e}}$ of a classical empirical model $\hat{e} \in \EmpModels{\ClsCov{\Theta}, \underline{O}}$; otherwise, we say that $e$ is \emph{contextual}.
If $e$ is a standard empirical model, we adopt \emph{local} as a synonym of non-contextual, and \emph{non-local} as a synonym of contextual.
\end{definition}

\begin{definition}
Let $\Theta$ be a space of input histories and let $\underline{O} = (O_\omega)_{\omega \in \Events{\Theta}}$ be a family of non-empty sets of outputs.
Let $e$ be a solipsistic empirical model.
We say that $e$ is \emph{solipsistically non-contextual} if it arises as restriction $e = \restrict{\hat{e}}{\dom{e}}$ of an empirical model $\hat{e} \in \EmpModels{\mathcal{C}, \underline{O}}$ for some cover $\mathcal{C} \succeq \StdCov{\Theta}$; otherwise, we say that $e$ is \emph{solipsistically contextual}.
\end{definition}

Contextuality in the case of no-signalling spaces has been extensively studied by previous literature.
However, the introduction of causal connections between events paves the way for novel explorations of the interplay between contextuality and causality.
Below are some initial results in this direction, proven in the companion work ``The Topology of Causality'' \cite{gogioso2022topology}:
\begin{itemize}
    \item We prove the existence of empirical models displaying ``solipsistic contextuality'' (cf. Theorem 4.48 p.75 \cite{gogioso2022topology}).
    This phenomenon arises for certain non-tight spaces, on covers finer than the standard cover where the causal constraints themselves are context-dependent.
    Contextuality arises from the failure of local data on certain contexts to satisfy the causal constraints prescribed by other compatible contexts.
    \item We prove a no-go result for non-locality on totally ordered spaces and causal switch spaces (cf. Theorem 4.51 p.77 \cite{gogioso2022topology}).
    The proof follows from our earlier factorisation result for causal functions on conditional sequential compositions, which is used to progressively define hidden variables for the outputs at each event based on the inputs at all previous events.
    The result is limited to empirical models on the standard cover, and it cannot be straightforwardly generalised to arbitrary covers on arbitrary causal switch spaces.
\end{itemize}
In the next Section, furthermore, we show the existence of ``contextual causality'', where the causal structure itself becomes contextual.
Specifically, we connect non-locality---the failure for output probabilities to be classically explained---to ``causal inseparability''---the failure for causal structure to be classically explained.


% === COMMENT BELOW BEFORE COMPILING MAIN FILE ===

% \newpage

% \section{The Geometry of Causality}
% \label{section:geometry-causality}

% % == Dummy Biblio ==

% \bibliographystyle{unsrt}
% \bibliography{biblio}
% % \nocite{*}

% \end{document}
