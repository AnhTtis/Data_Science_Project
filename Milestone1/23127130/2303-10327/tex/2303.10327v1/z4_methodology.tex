\section{Methodology}
To control the system in \defref{def:hybrid-sys}, we propose a learning framework in \algorref{alg:hybrid-control}. Guided by \theoref{theo-2}, we first learn the controller and the CLF to stabilize the \postac{system } within each mode. Then we perform the RoA estimation, and finally, we bring in the differentiable planner that leverages the controller and RoA estimator to enforce the hybrid system stability.

\subsection{Learning neural Lyapunov functions and controllers}
We train neural networks (NN) to synthesize the control Lyapunov functions $V(x,p)$ and controllers $u=\pi(x,p)$ for each \postac{system mode}. During training, we use the controller to roll out trajectories from uniformly sampled initial states and compute the CLF values. 
To satisfy the CLF conditions in \theoref{theo-2}, 
we design the Lyapunov function as $V(x,p)=||P_{\text{NN}}(p)(x-x^*)||+V_\text{NN}(x,p)^2 ||x-x^*||^2$, where $P_\text{NN}(p)$ is an NN that takes $p$ as input and outputs a matrix, and $V_{\text{NN}}(x,p)$ is an NN taking $x,p$ as inputs and outputs a scalar. In this way, 
%the first two and the last two terms are naturally satisfied 
the positive definiteness and the norm inequalities of the Lyapunov functions are naturally satisfied. 
Finally, to enforce the Lyapunov value decreasing (exponentially) along the trajectories $\mathcal{S}$, we design the loss: 
\begin{equation}
    \mathcal{L}_{clf}=\sum\limits_{x\in\mathcal{S}, p\in\mathcal{P}} \text{ReLU}\Big(\gamma V(x, p)+\frac{\partial V(x,p)}{\partial x} f(x, u)\Big)
    \label{eq:loss}
\end{equation}
where $u=\pi(x,p)$ and we compute the derivative term $\frac{\partial V(x_t,p)}{\partial x_t} f(x_t,u)\approx (V_{t+1}-V_t)/dt$.

\subsection{Learning neural RoA estimator}
\label{sec:roa-est}
After training for the CLF and controllers, we estimate the maximum $\epsilon$-stable level set in \defref{def:e-level-set} for any given $p$ using: $c^*(p)=\max\Big\{c \,\Big|\, \forall x_0\in \mathcal{C}_i,\, V(x_0,p)\leq c\rightarrow x_0 \in \mathcal{R}^{\epsilon}  \Big\}$
, where $\mathcal{R}^{\epsilon}$ is the $\epsilon$-RoA in \defref{def:e-roa}. For each $p_i$, we set $\epsilon=10^{-2}$ and uniformly sample $10^3 \sim 10^4$ initial states, roll out trajectories and find the largest Lyapunov value $c_i^*$ for all the initial states that have exiting states within the $\epsilon$-ball of the equilibrium. We train the NN RoA Estimator $R_{\text{NN}}(p)$ with:
\begin{equation}
    \mathcal{L}_{roa}=\sum\limits_{(p_i, c_i^*)\sim\mathcal{Z}} \Big(R_{\text{NN}}(p_i) - c_i^*\Big)^2 
    \label{eq:loss-roa}
\end{equation}
where $\mathcal{Z}$ is the set for simulated trajectories and maximum $\epsilon$-Stable level set indices. In this way, the RoA under configuration $p$ can be approximated by $\big\{x \ | \ V(x,p)\leq R_{\text{NN}}(p)\big\}$.


% \input{fig_latex/fig1_env.tex}
% \input{fig_latex/fig2_reward.tex}

\subsection{Differentiable configuration planner}
We use a differentiable planner to ensure switching stability by satisfying the last condition in \eqref{eq:v-condition} of \theoref{theo-2}. Assume $p_j$ is given at mode $i$. We use gradient descent to find $p_i$ to minimize:
\begin{equation}
\begin{aligned}
    \mathcal{L}_{e}& =\text{ReLU}\Big(V_i(x_i, p_i) - R_{\text{NN}}(p_i)\Big) +\text{ReLU}\Big(V_j(h_i(x^*, u, p_i), p_j) - \eta R_{\text{NN}}(p_j) + \kappa \Big)
    \label{eq:loss-e}
\end{aligned}
\end{equation}
where $\eta=\frac{\alpha_j}{\beta_j}$ and $\kappa=\alpha_j K_i \epsilon$. It is time-consuming to evaluate $\alpha_j$, $\beta_j$ and $K_i$ for each $p_i$ and $p_j$. Empirically, we set $\eta$=0.9 and $\kappa$=$10^{-2}$ for $\epsilon$=$10^{-2}$ (ablation in~\appref{appendix-abl-hyper}).  The optimization converges after 3$\sim$10 steps, adding only little runtime overhead. 
%Ideally, the optimal configuration should zero the loss in \eqref{eq:loss-e}. If not, 
We can also use a new loss $\mathcal{L}_{e}^+$ for periodic systems with decomposable jump map (common in error-state dynamics):
\begin{equation}
    h_i(x,u;p_i,p_j)=h^+(x,p_i)+p_i-p_j,\, h^+(x^*,p_i)=x^*
    \label{eq:special-sys}
\end{equation}
where the heuristic is to guide the configuration gradually approaches the target configuration $p_j$:  
\begin{equation}
    \mathcal{L}_{e}^+ = \text{ReLU}\Big(V_i(x_i, p_i) - R_{\text{NN}}(p_i)\Big) + \lambda ||p_j-p_i||
    \label{eq:loss-e-heur}
\end{equation}
We guarantee it converges to the target $p_j$ in finite steps (proved in \appref{appendix-prop3}):

\begin{theorem}[Finite-step converging toward the target configuration]
For special hybrid systems with $h_i$ defined in \eqref{eq:special-sys}. If $c_m(p_m)\geq \beta_m K_m \epsilon$ for all modes $m$ and $p_m$, and assume the first term in \eqref{eq:loss-e-heur} is zero for the optimal $p$, then the system is $\epsilon$-stable and the configuration is guaranteed to reach the target configuration $p_j$ in finite switches $N\leq \left\lceil\frac{||p_j-p_i||}{\min\limits_{m}\frac{c_m}{\beta_m}-K_{m} \epsilon}\right\rceil$. 
\label{theo-3}
\end{theorem}

\input{z10_algorithm}