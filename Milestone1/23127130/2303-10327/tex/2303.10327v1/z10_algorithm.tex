% \begin{algorithm}
% \small
% \caption{Hybrid System Control Algorithm}\label{alg:hybrid-control}
% \begin{algorithmic}[1]

% \Function{Learn\_CLF}{$f_i,\, p_i$} %\Comment{Learn CLF and controller}
% \State Initialize NN CLF $V_i$ and NN controller $\pi_i$
% \State{Train $ V_i$ and $\pi_i$ with the loss $\mathcal{L}_{clf}$ in \eqref{eq:loss} and \Return $V_i$, $\pi_i$}
% \EndFunction

% \Function{Estimate\_ROA}{$\{f_i, p_i, V_i, \pi_i\}_{i=1}^N$} %\Comment{Estimate RoA}
% \State{Initialize RoA Estimator $R_{NN}$ and find $c_i^*$ (in \secref{sec:roa-est})}
% \State{Train $R_{NN}$ with the loss $\mathcal{L}_{roa}$ in \eqref{eq:loss-roa} and  \Return $R_{NN}$}
% \EndFunction

% \Function{Plan\_Config}{$V_i$, $V_j$, $R_{NN}$, $\mathcal{P}$, $\tilde{p}_j$} %\Comment{Find optimal configuration}
% \State{Optimize $p_i$ with the loss $\mathcal{L}_e$ ($\mathcal{L}_e^+$) in \eqref{eq:loss-e} (\eqref{eq:loss-e-heur}) and \Return $p_i$}
% \EndFunction

% \Function{Main}{\null}
% \State{Sample $\{f_i, p_i\}_{i=1}^N$ from the hybrid system in \defref{def:hybrid-sys}} %\Comment{Training phase}
% \ForAll{$f_i$, $p_i$} 
% \State{$V_i,\pi_i \gets$ \textsc{Learn\_CLF}($f_i$, $p_i$)} 
% \EndFor
% \State{$R_{NN} \gets$ \textsc{Estimate\_ROA}($\{f_i, p_i, V_i, \pi_i\}_{i=1}^N$)} 
% \State{Initialize state $x(0)\gets x_0$, mode $k$ and time $t\gets 0$} %\Comment{Deployment phase}
% \While{$t\leq T$}
% \If{ right before entering mode $i$ (with next mode $j$)} %\Comment{Mode switching}
% \State{$p_i \gets$ \textsc{Plan\_Config}($V_i$, $V_j$, $R_{NN}$, $\mathcal{P}$, $\tilde{p}_j$)}
% \State{$x(t)\gets h_k(x(t), u; p_k, p_i), \,\, k\gets i$}
% \Else %\Comment{Within the mode}
% \State{$x(t+\Delta t)\gets x(t) + %\int_{t}^{t+\Delta t} 
% f_k(x(\tau), \pi_k(x(\tau), p_k), p_k) \Delta t$
% \State{$t\gets t+\Delta t$}
% }

% \EndIf
% \EndWhile
% \EndFunction
% \end{algorithmic}
% \end{algorithm}

% \begin{algorithm}[H]
%     % \SetLine
%     \SetAlgoNoLine
%     % \SetKwProg{Fn}{function}{ is}{}
%     \SetKwFor{While}{while}{do}{}
%     \SetKwFor{ForAll}{forall}{do}{}
%     \SetKwProg{Fn}{Function}{}{}
%     \Fn{\textsc{Learn\_CLF}($f_i$, $p_i$)}{
%     Initialize CLF $V_i$ and controller $\pi_i$\;
    
%     Train $ V_i$ and $\pi_i$ with the loss $\mathcal{L}_{clf}$ in \eqref{eq:loss} and \Return $V_i$, $\pi_i$\;
%     }

%     \Fn{\textsc{Estimate\_ROA}($\{f_i, p_i, V_i, \pi_i\}_{i=1}^N$)}{
%     Initialize RoA Estimator $R_{NN}$ and find $c_i^*$ (according to~\secref{sec:roa-est})\;
    
%     Train $R_{NN}$ with the loss $\mathcal{L}_{roa}$ in \eqref{eq:loss-roa} and  \Return $R_{NN}$
%     }

%     \Fn{\textsc{Plan\_Config}($V_i$, $V_j$, $R_{NN}$, $\mathcal{P}$, $\tilde{p}_j$)}{

%     Optimize $p_i$ with the loss $\mathcal{L}_e$ ($\mathcal{L}_e^+$) in \eqref{eq:loss-e} (\eqref{eq:loss-e-heur}) and \Return $p_i$
    
%     }

%     \Fn{\textsc{MAIN}()}{
%     Sample $\{f_i, p_i\}_{i=1}^N$ from the hybrid system in \defref{def:hybrid-sys}

%     \ForAll{$f_i$, $p_i$}{
%         $V_i,\pi_i \gets$ \textsc{Learn\_CLF}($f_i$, $p_i$)
%     }
%     % \EndFor

%     $R_{NN} \gets$ \textsc{Estimate\_ROA}($\{f_i, p_i, V_i, \pi_i\}_{i=1}^N$)

%     Initialize state $x(0)\gets x_0$, mode $k$ and time $t\gets 0$

%     \While{$t\leq T$}{
%     \uIf{ right before entering mode $i$ (with next mode $j$)}{
%         $p_i \gets$ \textsc{Plan\_Config}($V_i$, $V_j$, $R_{NN}$,   $\mathcal{P}$, $\tilde{p}_j$)

%         $x(t)\gets h_k(x(t), u; p_k, p_i), \,\, k\gets i$
%     }
%     \uElse{
%         $x(t+\Delta t)\gets x(t) + f_k(x(\tau), \pi_k(x(\tau), p_k), p_k) \Delta t$, \quad $t\gets t+\Delta t$
%     }
    
%     }
    
%     }
% \caption{Hybrid System Control Algorithm}\label{alg:hybrid-control}
% \end{algorithm}



\begin{algorithm}[H]
\scriptsize
    % \SetLine
    \SetAlgoNoLine
    % \SetKwProg{Fn}{function}{ is}{}
    \SetKwFor{While}{while}{do}{}
    \SetKwFor{ForAll}{foreach}{do}{}
    \SetKwProg{Fn}{Function}{}{}
    % \Fn{\textsc{Learn\_CLF}($f_i$, $p_i$)}{
    % Initialize CLF $V_i$ and controller $\pi_i$\;
    
    % Train $ V_i$ and $\pi_i$ with the loss $\mathcal{L}_{clf}$ in \eqref{eq:loss} and \Return $V_i$, $\pi_i$\;
    % }

    % \Fn{\textsc{Estimate\_ROA}($\{f_i, p_i, V_i, \pi_i\}_{i=1}^N$)}{
    % Initialize RoA Estimator $R_{NN}$ and find $c_i^*$ (according to~\secref{sec:roa-est})\;
    
    % Train $R_{NN}$ with the loss $\mathcal{L}_{roa}$ in \eqref{eq:loss-roa} and  \Return $R_{NN}$
    % }

    % \Fn{\textsc{Plan\_Config}($V_i$, $V_j$, $R_{NN}$, $\mathcal{P}$, $\tilde{p}_j$)}{

    % Optimize $p_i$ with the loss $\mathcal{L}_e$ ($\mathcal{L}_e^+$) in \eqref{eq:loss-e} (\eqref{eq:loss-e-heur}) and \Return $p_i$
    
    % }

    % \Fn{\textsc{MAIN}()}{
    Sample $\{f_i, p_i\}_{i=1}^N$ from the hybrid system in \defref{def:hybrid-sys} \tcp*{Training phase}

    \ForAll{$f_i$, $p_i$}{
        % $V_i,\pi_i \gets$ \textsc{Learn\_CLF}($f_i$, $p_i$)
        Train $ V_i$ and $\pi_i$ with the loss $\mathcal{L}_{clf}$ in \eqref{eq:loss}
        
        Find $c_i^*$ for $V_i$ and $\pi_i$ (according to~\secref{sec:roa-est})
    }
    Train $R_{NN}$ on $\{(p_i, c_i^*)\}_{i=1}^N$ with the loss $\mathcal{L}_{roa}$ in \eqref{eq:loss-roa}
    % \EndFor
    % $R_{NN} \gets$ \textsc{Estimate\_ROA}($\{f_i, p_i, V_i, \pi_i\}_{i=1}^N$)

    Initialize state $x(0)\gets x_0$, mode $k$ and time $t\gets 0$ \tcp*{Testing phase}

    \While{$t\leq T$}{
    \uIf{ right before entering mode $i$ (with next mode $j$)}{
        % $p_i \gets$ \textsc{Plan\_Config}($V_i$, $V_j$, $R_{NN}$,   $\mathcal{P}$, $\tilde{p}_j$)

        Optimize $p_i$ with the loss $\mathcal{L}_e$ ($\mathcal{L}_e^+$) in \eqref{eq:loss-e} (\eqref{eq:loss-e-heur})

        $x(t)\gets h_k(x(t), u; p_k, p_i), \,\, k\gets i$
    }
    \uElse{
        $x(t+\Delta t)\gets x(t) + f_k(x(\tau), \pi_k(x(\tau), p_k), p_k) \Delta t$, \quad $t\gets t+\Delta t$
    }
    
    }
    
    % }
\caption{Hybrid System Control Algorithm}\label{alg:hybrid-control}
\end{algorithm}