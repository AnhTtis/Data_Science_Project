% ****** Start of file apssamp.tex ******
%
%   This file is part of the APS files in the REVTeX 4.2 distribution.
%   Version 4.2a of REVTeX, December 2014
%
%   Copyright (c) 2014 The American Physical Society.
%
%   See the REVTeX 4 README file for restrictions and more information.
%
% TeX'ing this file requires that you have AMS-LaTeX 2.0 installed
% as well as the rest of the prerequisites for REVTeX 4.2
%
% See the REVTeX 4 README file
% It also requires running BibTeX. The commands are as follows:
%
%  1)  latex apssamp.tex
%  2)  bibtex apssamp
%  3)  latex apssamp.tex
%  4)  latex apssamp.tex
%
\documentclass[%preprint,
superscriptaddress,
%groupedaddress,
%unsortedaddress,
%runinaddress,
%frontmatterverbose, 
%preprint,
%preprintnumbers,
%nofootinbib,
%nobibnotes,
%bibnotes,
 amsmath,amssymb,
 aps,
%pra,
%prb,
%rmp,
%prstab,
%prstper,
%floatfix,
]{revtex4-2}

\usepackage{graphicx}% Include figure files
\usepackage{dcolumn}% Align table columns on decimal point
\usepackage{bm}% bold math


\renewcommand{\thepage}{S\arabic{page}} 
\renewcommand{\thesection}{S\arabic{section}}  
\renewcommand{\thetable}{S\arabic{table}}  
\renewcommand{\thefigure}{S\arabic{figure}} 

\renewcommand{\theequation}{S\arabic{equation}} 

\usepackage[colorlinks = true,
            allcolors = {Blue}]{hyperref}
%% the following code added from stackexchange, to fix language in bib
\usepackage[english]{babel}

\makeatletter
% A change to a babel macro
\def\bbl@set@language#1{%
  \edef\languagename{%
    \ifnum\escapechar=\expandafter`\string#1\@empty
    \else\string#1\@empty\fi}%
  %%%% ADDITION
  \@ifundefined{babel@language@alias@\languagename}{}{%
    \edef\languagename{\@nameuse{babel@language@alias@\languagename}}%
  }%
  %%%% END ADDITION
  \select@language{\languagename}%
  \expandafter\ifx\csname date\languagename\endcsname\relax\else
    \if@filesw
      \protected@write\@auxout{}{\string\select@language{\languagename}}%
      \bbl@for\bbl@tempa\BabelContentsFiles{%
        \addtocontents{\bbl@tempa}{\xstring\select@language{\languagename}}}%
      \bbl@usehooks{write}{}%
    \fi
  \fi}
% The user interface
\newcommand{\DeclareLanguageAlias}[2]{%
  \global\@namedef{babel@language@alias@#1}{#2}%
}
\makeatother

\DeclareLanguageAlias{en}{english}


\usepackage[dvipsnames]{xcolor}
\newcommand{\sketch}[1]{{\color{Gray}#1}}



\begin{document}

%\preprint{APS/123-QED}

\title{Supplemental Material for ``Optimizing performance of quantum operations with non-Markovian decoherence: the tortoise or the hare?''}

\author{Eoin P. Butler}
 \affiliation{School of Physics, Trinity College Dublin, College Green, Dublin 2, Ireland}
\author{Gerald Fux}%
\affiliation{SUPA, School of Physics and Astronomy, University of St Andrews, St Andrews KY16 9SS, United Kingdom}%
\affiliation{Abdus Salam International Center for Theoretical Physics (ICTP), Strada Costiera 11, 34151 Trieste, Italy}%
\author{Brendon W. Lovett}
\affiliation{SUPA, School of Physics and Astronomy, University of St Andrews, St Andrews KY16 9SS, United Kingdom}
\author{Jonathan Keeling}
\affiliation{SUPA, School of Physics and Astronomy, University of St Andrews, St Andrews KY16 9SS, United Kingdom}%
\author{Paul R. Eastham}
 \affiliation{School of Physics, Trinity College Dublin, College Green, Dublin 2, Ireland}


\date{28 March 2023}% It is always \today, today,
             %  but any date may be explicitly specified
\maketitle


This supplemental material is organized as follows. In Sec.\ \ref{sec:suppintro} we provide a brief general introduction to the process tensor formalism and some additional details of the method. Section~\ref{sec:suppgrad} provides additional details of the computation of the gradient of an objective function. Supplementary results, giving the optimal controls and dynamics for a range of process durations, are provided in a separate file, and explained in Sec.\ \ref{sec:suppresults}.

\section{Brief introduction to process tensors}
\label{sec:suppintro}

\begin{figure}
    \centering
    \includegraphics{fig-process-tensor.pdf}
    \caption{\label{fig:process-tensor}%
    Tensor network diagrams representing the reduced system state $\rho^\mathrm{S}(t_4)$ at time $t_4$.
    Panels (a) and (b) show $\rho^\mathrm{S}(t_4)$ after the application of a control sequence $\{\mathcal{A}_1, \ldots, \mathcal{A}_4 \}$.
    Panels (c), (d), and (e) show $\rho^\mathrm{S}(t_4)$ after an evolution that can be separated into brief unitary propagators $\tilde{\mathcal{U}}_n$ due to the environment interaction $\tilde{H} = H_{SB} + H_B$ and brief unitary propagators $U_n$ due to the pure system part $H_\mathrm{S}(t)$.
    The red dotted regions show the process tensors in matrix product operator form (PT-MPO).
    The red triangle marked $\mathrm{Tr}_B$ denotes the partial trace over the environment, and $\rho^B_0$ and $\rho^\mathrm{S}_0$ denote the initial environment and system states, respectively.}

\end{figure}

The process tensor formalism is an operational approach to general (i.e. not restricted to Markovian) open quantum systems~\cite{pollock_non-markovian_2018}.
The key idea is to describe open quantum system through a mathematical object---the process tensor (PT)---that encodes the outcome of all possible experiments that consist of a sequence of \emph{control operations} on the system.
A control operation may be any experimentally realizable intervention on the system, i.e. a completely positive map, which for example includes measurements on the system, or the application of a unitary.


In Fig.~\ref{fig:process-tensor}a we draw a quantum circuit in Liouville space for a general total system (i.e. the open system together with its environment) with control operations on only the open system at times $t_1$, $t_2$, $t_3$, and $t_4$.
The super-operators $\mathcal{U}_n=\exp\left[\int_{t_{n-1}}^{t_{n}} \mathcal{L}_\mathrm{tot}(t) \mathrm{d}t \right]$ are the propagators between time $t_{n-1}$ and $t_n$, where $\mathcal{L}_\mathrm{tot}(t) \: \cdot = - i \left[ H_\mathrm{tot}(t) , \:\cdot\:\right]$ is the Liouvillian for the total system.
Because we assume that the experimenter has no direct access to the environment we trace it out at the final time.
The object that encodes the outcome of all different control sequences $\{\mathcal{A}_1, \mathcal{A}_2, \mathcal{A}_3, \mathcal{A}_4\}$ can be easily identified as the red dotted region in Fig.~\ref{fig:process-tensor}a.
This is the process tensor as introduced in~\cite{pollock_non-markovian_2018}.
Through a reinterpretation of this quantum circuit as a tensor network one may note that the process tensor naturally assumes the form of a matrix product operator (PT-MPO).
Note that the particular MPO representation in Fig.~\ref{fig:process-tensor}a uses the environment Liouville space as bonds, which is prohibitively large for most systems of interest.
However, because there is no need to explicitly keep track of the environment, there often exists an efficient representation of the PT-MPO with low bond dimensions, which we draw in Fig.~\ref{fig:process-tensor}b.
As mentioned in the main text, there are several numerical methods that allow such a PT-MPO for multiple different types of environments to be obtained~\cite{makri_tensor_1995, makri_tensor_1995-1, banuls_matrix_2009, jorgensen_exploiting_2019, strathearn_modelling_2020, lerose_influence_2020, fux_efficient_2021, cygorek_simulation_2022, sonner_influence_2021, ye_constructing_2021, white_non-markovian_2021, thoenniss_non-equilibrium_2022, OQuPy2022, thoenniss_efficient_2022, ng_real_2022}.
The necessary bond dimensions of an PT-MPO is related to the degree of non-Markovianity of the interaction between the system and environment~\cite{pollock_operational_2018}.


In this paper we make use of a Suzuki-Trotter expansion~\cite{trotter_product_1959} of the unitary evolution of the total system \mbox{$H_\mathrm{tot} = H_\mathrm{S}(t) + H_B + H_{SB}$} into an environment interaction part and a pure system part. For small enough time steps the unitary evolution $\mathcal{U}_n$ can be separated into the unitary evolution $\tilde{\mathcal{U}}_n$ due to the environment interaction $\tilde{H} = H_{SB} + H_B$ and the unitary evolution $U_n$ due to the pure system part $H_\mathrm{S}(t)$ as shown in Fig.~\ref{fig:process-tensor}c~and~\ref{fig:process-tensor}d.
One can then view the pure system propagators $U_n$ as control operations and the rest as a process tensor for a total system with the reduced total Hamiltonian $\tilde{H} = H_{SB} + H_B$ as shown in Fig.~\ref{fig:process-tensor}d.


For the computations in the main text we employed the method introduced in~\cite{jorgensen_exploiting_2019} to obtain such a PT-MPO representation of the Trotterized time evolution. We used the implementation in the OQuPy package~\cite{OQuPy2022} with a time step $\Delta t = 0.05\ \text{ps}$, a memory time cut-off of~$3\ \text{ps}$, and a relative singular value decomposition cutoff threshold of~$10^{-7}$, which resulted in a PT-MPO with a maximal bond dimension of~$73$.
We emphasize that the method introduced in this work is however not restricted to the particular choice of the environment or the particular choice of algorithm used to compute the PT-MPO.
The method only relies on the availability of the environment's PT-MPO with a moderate bond dimension, which may be obtained for a variety of different environments through a variety of different methods.


\section{Construction of the gradient from the process tensor}

\label{sec:suppgrad}

In this section we present details of how we calculate the gradient of an objective function from the PT-MPO. To establish notation we first recall the calculation of the time evolution from an initial to a final state, shown in Fig.~\ref{fig:process-tensor}e and Fig. 1a of the main text. Recall that states here are vectorized system density matrices. The time evolution proceeds in discrete time steps at times $t_n=n\Delta t$ for $n=1,\ldots,N_t$. For a system with Hilbert space dimensionality $d_{H_S}$ the state at time $t_n$ is a $d_{H_S}^2$ component vector which we denote $\rho^i_n$ ($i=1,\ldots d_{H_S}^2$). The system propagator over the $n^{th}$ time step is a $(d_{H_S}^2,d_{H_S}^2)$ matrix we denote $U^{ij}_n$. 

Fig~\ref{fig:process-tensor}e shows the evolution over four time steps with time increasing from bottom to top. The state at the final time can be constructed by evaluating the contractions in this network forwards in time. One first contracts the lowest external leg of the PT-MPO with the leg of the initial state. The next two external legs of the PT-MPO are, in order, an output from it and an input to it. The output (input) leg of the PT-MPO is joined to the input (output) leg of the system propagator for the first time step. The propagators for the the next two time steps are included in a similar manner, thus interleaving the factors in the path integral due to the environment and the system Hamiltonian. The final step is a contraction of the last output leg of the PT-MPO with the input leg of the last system propagator. The resulting diagram has one open leg, the output leg of the last system propagator, and represents the final state.

In the main text we considered a particular objective function, the fidelity $\mathcal{F}$, and took as control parameters the fields $h_{x,z}(t_n)$. Here we consider a more general case where the objective is a function $Z(\rho^i_f=\rho_{N_t}^i)$ of the final state, and there are $N$ control parameters $c_a$. In general each propagator $U^{ij}_n$ can depend on all the control parameters. Thus we have \begin{equation}\label{eq:chainrule}
    \frac{\partial Z}{\partial c_a} = \sum_{n} \sum_{i,j,k}^{d_{H_S}^2} %\sum_t^{T}\sum_{i,j}^{d_{H_S}^2} 
    \frac{\partial Z}{\partial \rho_f^i} \frac{\partial\rho_f^i}{\partial U^{jk}_n} \frac{\partial U^{jk}_n}{\partial c_a}.\end{equation} 
    
Fig.\ \ref{fig:chainrule} shows Eq. (\ref{eq:chainrule}) for four time steps. The terms involving the propagators $U_1,\ldots,U_4$ are shown in panels (a)--(d) respectively. Panel (e) shows how panel (a) is formed from the three factors in Eq. (\ref{eq:chainrule}). The rank-1 tensor $Z^i\equiv\frac{\partial Z}{\partial \rho^i_f}$ is the purple circle at the top of the diagram, and the rank-2 tensor $\frac{\partial U^{jk}_1}{\partial c_a}$, for a given $a$, is the yellow circle at the first time step. The remainder of the diagram is the rank-3 tensor $\frac{\partial \rho_f^i}{\partial U_1^{jk}}$. As discussed in the main text, the PT is a multilinear map from the propagators to the final state. Thus the diagram for $\frac{\partial \rho_f^i}{\partial U_1^{jk}}$, for example, is the same as that for the final state, with the first propagator, $U_1$, omitted. Furthermore, the contraction of this tensor with $Z^i$ is the derivative of the objective function with respect to the first propagator, $\frac{\partial Z}{\partial U_1^{jk}}$. This important object is the diagram in Fig.\ \ref{fig:chainrule}a with the yellow circle omitted. The derivatives with respect to the propagators at other time steps are obtained similarly from Figs.\ \ref{fig:chainrule}b--d. 

To calculate Eq. (\ref{eq:chainrule}) we first compute the derivatives of the objective function with respect to the system propagators. This is done using two computations of the tensor network: a forward propagation, shown in Fig.~\ref{fig:forwardprop}, and a back propagation, shown in Fig.~\ref{fig:backprop}. In the forward propagation, we evaluate the network starting from the initial state and proceeding forward in time, as is done to compute the objective function itself. The only change is that we store the tensors obtained at each time step, shown in Figs.\ \ref{fig:forwardprop}b--e. Each stored tensor has two legs, one internal leg within the PT-MPO, known as a `bond' leg, and one external leg to the PT-MPO, which would normally have been connected to a system propagator, known as a `state' leg. The back propagation is shown in Fig.\ \ref{fig:backprop}. One evaluates this diagram starting from the top with the tensor $Z^i$ and proceeding backwards in time. One again retains the intermediate forms computed at each time step, shown in Figs.\ \ref{fig:backprop}b--e. We see that by joining the bond leg in Fig.\ \ref{fig:forwardprop}b with that in Fig.\ \ref{fig:backprop}e we obtain the derivative $\frac{\partial Z}{\partial U_1}$.  The other derivatives are obtained similarly from pairs of tensors stored during the forward and back propagation. These derivatives
are then combined with the factors $\frac{\partial U_n}{\partial c_a}$ to give the gradient. 

To connect these considerations to the special case considered in the main text, we note that there the objective function is the fidelity $\mathcal{F}$, and because we are only interested in pure target states, $|\sigma\rangle$, $\mathcal{F}=\langle\sigma|\rho_f|\sigma\rangle$. This equation in Liouville space is the scalar product of the vectorized forms of the final density matrix and the transposed target density matrix, $\mathcal{F}=(\sigma^T)^i \rho^i_f$.  Thus $Z^i=(\sigma^T)^i$, and the gradient of the fidelity is obtained by back propagation from the transposed target state as claimed. An additional simplification in that case is that the propagator at each time step depends only on the control parameters at that time step. There is then no sum over time steps in Eq.\ \ref{eq:chainrule}.


\begin{figure}
    \centering
    \includegraphics{chainrulefig_pre.pdf}
    \caption{Diagrammatic representation of the derivative of an objective function with respect to a control parameter, Eq. (\ref{eq:chainrule}). (a) is the contribution involving the propagator over the first time step, $U_1$, and (b--d) the contributions from subsequent steps. The yellow circle in each panel is the derivative of the propagator over that time step with respect to the control parameter. The purple circle at the top of each panel is the derivative of the objective function with respect to the final state. (e) shows how (a) is constructed by joining legs (contracting indices) among tensors corresponding to the factors in Eq. (\ref{eq:chainrule}).
    \label{fig:chainrule}}
\end{figure}

\begin{figure}
\includegraphics[width=\linewidth]{sup_forwardprop.pdf}
\caption{Illustration of the forward propagation calculation for a process tensor with four time steps. The left-hand diagram is the scalar product of the time-evolved state with the derivative of the objective function with respect to that state (top purple circle). In forward propagation the initial state is evolved forwards in time, to successively compute the diagrams shown in panels (b--e). To compute the gradient these tensors are stored.\label{fig:forwardprop}}

\end{figure}

\begin{figure}
\includegraphics[width=\linewidth]{sup_backprop.pdf}
\caption{\label{fig:backprop}  Illustration of the back propagation calculation for a process tensor with four time steps. The left-hand diagram is the scalar product of the time-evolved state with the derivative of the objective function with respect to that state (top purple circle). In back propagation this tensor is evolved backwards in time, to successively compute the diagrams shown in panels (b--e). The gradient is obtained by combining these tensors with those stored during the forward propagation (see text).} 
\end{figure}

\section{Results for different process durations}
\label{sec:suppresults}

Fig. 3 of the main text showed the optimal controls and dynamics for a process duration of 4 ps. The file \verb|supplementary_results.pdf| shows the corresponding results for a range of process durations from 1 to 5 ps, with each page corresponding to a different duration. The bottom left panel, which is repeated on every page, reproduces Fig. 2a of the main text. The infidelity of the optimal control (control A) is shown as a function of process duration as the blue curve. On each page one point on that curve is marked with a red cross. This indicates the process duration for which results are shown in the remaining panels. These are the computed optimal controls (top left), the time-dependence of the expectation values (top right) and the trajectory in the Bloch sphere (bottom right). The top right panel also shows the length of the Bloch vector for the unoptimized control (control B).


% the main text
% \input{mainv2.bbl} % or include the bbl file
\newsavebox\mytempbib
\savebox\mytempbib{\parbox{\textwidth}{\input{ms.bbl}}}

\end{document}
