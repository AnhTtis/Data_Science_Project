\begin{algorithm}[t]
\caption{Pseudo-code of one epoch of \putouralg}
\label{alg:code}
\definecolor{codeblue}{rgb}{0.25,0.5,0.5}
\lstset{
  backgroundcolor=\color{white},
  basicstyle=\fontsize{7.2pt}{7.2pt}\ttfamily\selectfont,
  columns=fullflexible,
  breaklines=true,
  captionpos=b,
  commentstyle=\fontsize{7.2pt}{7.2pt}\color{codeblue},
  keywordstyle=\fontsize{7.2pt}{7.2pt},
}
\begin{lstlisting}[language=python]
# f, g, h: encoder, classifier, and projector
# b_x: labeled batch
# b_w, b_s: weak, strong unlabeled batches
# u_id: unique index of unlabeled samples
# N, C: num unlabeled samples, num classes
# CA: cluster assignment bank (N x 2)
# CPL: clusters pseudo-label bank (N x C)
# PH: samples pseudo-label bank (N x 1)
# Q: cluster centers
# P: class prototypes
# P_acc: prototypes accumulator
# alpha: pseudo-label refinement ratio

for b_x, b_w, b_s, u_id in loader:  
    # forward images and obtain p and q
    p_x, p_w, p_s = f(g(b_x, b_w, b_s))
    q_x, q_w, q_s = f(h(b_x, b_w, b_s))
    # calculate and save cluster assignment
    CA[u_id] = calc_clust_assignmnt(q_w, Q)  # Eqn.5
    # update centers and dual variables
    Q = update_cluster_centers(q_w)        # Eqn. 6 & 7
    #retrieve cluster pseudo-labels from previous epoch
    z = CPL[CA[u_id]]
    # refine p_w
    p_w_hat = alpha*p_w + (1 - alpha)*z   # Eqn. 9
    # save hard pseudo-labels
    PH[u_id] = argmax(p_w_hat)
    # accumulate prototypes (of reliable samples only)
    P_acc = accum_prototypes(q_x, q_w, PH[u_id])
    # apply losses (except in first epoch)
    Lx, Lp, Lu, Lc = backward_losses()  # Eqn. 2, 10-12
# after each epoch
P = update_prototypes(P_acc)  # Eqn. 1
CPL = calc_cluster_pseudo_labels(CA, PH) # Eqn. 8
\end{lstlisting}
\end{algorithm}





% \begin{algorithm}[t]
%    \caption{\putouralg}
%    \label{alg:protocon}
% \begin{algorithmic}
%    \STATE {\bfseries Input:} Dataset $\Xcal, \Ucal$, \#clusters $K$, \#epochs $T$, 
%    \STATE Randomly initialize cluster centers $\Qcal$
%    \STATE Initialize cluster assignment memory bank
%    \STATE Initialize clusters pseudo-label bank
%    \STATE Initialize samples pseudo-label bank
%    \STATE Initialize prototypes $\Pcal$
   
%    \FOR{epoch in 1 {\bfseries to} MaxEpochs}
%    \FOR{batch in 1: NumBatches} 
%    \STATE Obtain and save cluster assignments (Eqn.~\ref{eq:solution})
%    \STATE Update dual variables $\rho$ as in (\ref{eq:finalrho})
%    \STATE Update cluster centers as in (\ref{eq:updatemulti})
%    \STATE Retrieve cluster pseudo-labels based on sample clusters 
%    \STATE $m=m+b$
%    \ENDFOR
%    \ENDFOR
%    \RETURN $\{\mu^T, C^T\}$
% \end{algorithmic}
% \end{algorithm}


