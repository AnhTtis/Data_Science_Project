\subsection{Overview}\label{Overview}

\noindent \textbf{Problem formulation:} Following the setting of cell instance segmentation, we are provided with a dataset with $K$ images and the corresponding annotations $\mathcal{D} =  \left\{(\mathcal{X}_{k},\mathcal{Y}_{k})\right\}_{k=1}^{K}$, each of which contains annotations of bounding boxes $\mathcal{B}_{k}=\left\{b_{k, i}\right\}^{N_{k}}_{i=1}$, object categories  $\mathcal{C}_{k} = \left\{c_{k, i} \right\}^{N_{k}}_{i=1}$, and instance masks  $\mathcal{E}_{k} = \left\{e_{k, i}\right\}^{N_{k}}_{i=1}$, where $N_{k}$ denotes the number of instances in the $k$-th image.
Here, we focus on segmenting the nucleus and cytoplasm for cell instance $c_{k, i} \in \left\{\text{nuclei}, \text{cytoplasm} \right\}$. For each cell cluster, based on the localization relationship among the cells, we decompose the instance mask into the intersection region $\mathcal{O}_{k} = \left\{o_{k, i}\right\}^{N_{k}}_{i=1}$ and the complement region
$\mathcal{M}_{k} = \left\{m_{k,i}\right\}^{N_{k}}_{i=1}$ via the logical operation (see in Figure \ref{fig1}), which is used to model their relationship in the DoNet.

\noindent \textbf{Workflow:} 
The flowchart of the proposed DoNet is provided in Figure \ref{fig2}. It takes Mask R-CNN \cite{he2017mask} as the base model, followed by a Dual-path Region segmentation Module (DRM) which takes the instance features as input to predict intersection regions $\hat{o}_{k, i}$ and complement regions $\hat{m}_{k, i}$ of cytoplasm via the intersection and complement layers (Section \ref{DRM}). 
After decomposing cell clusters according to the position relationship, a Consistency-guided Recombination Module (CRM) takes instance features from DRM and RoIAlign layer to generate the recombined masks $\hat{e}^{r}_{k, i}$ for consistency regularization (Section \ref{DRM}).
Then, the recombined cytoplasm prediction is utilized as prior knowledge for intra-cellular object prediction throughout the Mask-guided Region Proposal (MRP) (Section \ref{MRP}).
We will present the details of our framework in the following sections.

\noindent\textbf{Coarse Mask Segmentation:} Previous research works on Mask R-CNN has shown competitive performance in instance segmentation \cite{he2017mask, huang2019mask, follmann2019learning}, adopted into the proposed DoNet for coarse mask segmentation. Mask R-CNN consists of two stages. The first stage utilizes Feature Pyramid Network (FPN) for feature extraction and a Region Proposal Network (RPN) for candidate object bounding boxes generation. The second stage generates Region-of-Interest (RoI) features $f^{roi}_{k, i}$ via the RoIAlign layer and predicts object classes $\hat{c}_{k, i}$ and bounding boxes $\hat{b}_{k, i}$ from the detection head, and semantic masks $\hat{e}^{c}_{k, i}$ from the Instance Mask Head ($H_{i}$), respectively. Due to limited perception capability in overlapping regions, $\hat{e}^{c}_{k, i}$ may contain ambiguous boundaries. Thus, we denote $\hat{e}^{c}_{k, i}$ as the coarse mask, which provides information for sub-region decomposition in DRM and suppresses the interference from background mimics. Following standard losses in \cite{he2017mask}, a multi-task loss $\mathcal{L}_{coarse}$ for coarse mask segmentation is formed as,
\begin{equation}
  \mathcal{L}_{coarse} = \mathcal{L}_{reg} + \mathcal{L}_{cls} + \mathcal{L}_{cmask},
  \label{eq:eq1}
\end{equation}
where $\mathcal{L}_{reg}$ denotes the smooth-L1 loss for bounding box regression, $\mathcal{L}_{cls}$ denotes cross-entropy (CE) loss for classification, and $\mathcal{L}_{cmask}$ denotes pixel-wise CE loss for segmentation.

\subsection{Decompose-and-recombined Strategy} \label{DRM}
Previous solutions for amodal perception infer the integral structure of occluded instances using visible regions\cite{follmann2019learning,xiao2021amodal}. However, they ignore information from overlapping regions, which tend to be sub-optimal in the case of complex superposition of translucent objects. To empower the perception capability of model for overlapping translucent regions, we specifically design the decompose-and-recombined strategy.

\noindent\textbf{Dual-path Region Segmentation Module (DRM):}
As shown in Figure \ref{fig2}, DRM consists of an Intersection Mask Head $H_{o}$ and a Complement Mask Head $H_{m}$ with the same architecture. Let $f_{k, i}^{c}$ denotes the rich semantic feature before the coarse mask prediction in the Instance Mask Head. Both $H_{o}$ and $H_{m}$ take the concatenation of $f^{roi}_{k, i}$ and  $f_{k, i}^{c}$ as input to predict the intersection and complement regions $\hat{o}_{k, i}, \hat{m}_{k, i}$ in clusters. See the supplementary material for details of the Concatenation Unit. Specifically, each head consists of 4 convolutional layers to generate features in $14 \times  14 \times 256$, followed by one deconvolutional layer to get the semantic mask with a resolution of $28 \times 28 \times 1$. Here, we add the pixel-wise CE loss to both heads as the explicit constraint for decomposition,
\begin{equation}
\begin{aligned}
  \mathcal{L}_{dec} = \frac{1}{K}\sum_{k=1}^{K}\frac{1}{N_{k}}\sum_{i=1}^{N_{k}} \left ( \mathcal{L}_{ce} (\hat{o}_{k, i}, o_{k,i})
  + \mathcal{L}_{ce}(\hat{m}_{k, i}, m_{k,i})\right ).
  \label{eq:eq4}
\end{aligned}
\end{equation}

\noindent\textbf{Semantic Consistency-guided Recombination Module (CRM):}
To further enhance the perception capability for overlapping instances, CRM is designed to encourage DoNet to perceive integral instances. Specifically, let $f_{k,i}^{o}$ and $f_{k,i}^{m}$ denote the features before the last layer in the intersection mask head and the complement mask head. The rich semantic feature for the overlapping and non-overlapping region is considered as the residual information for the complex areas which is fused with $f^{roi}_{k, i}$ and then fed into the recombined mask head. See the supplementary material for details of the Fusion Unit. Noted that we reuse the Instance Mask Head ($H_{i}$) here to predict the integral instance. This combination facilitates CRM to leverage contextual information of overlapping instances, leading to the improvement of perception capability. The refined mask $\hat{e}_{k,i}^{r}$ from CRM is optimized by segmentation loss $\mathcal{L}_{rmask}$,
\begin{equation}
  \mathcal{L}_{rmask} = \frac{1}{K} \sum_{k=1}^{K}\frac{1}{N_{k}} \sum_{i=1}^{N_{k}}{\mathcal{L}_{ce}(\hat{e}_{k,i}^{r}, e_{k,i}) }.
  \label{eq:eq5}
\end{equation}

To further enhance the feature representation capacity for the relationship of components, we add semantic consistency regularization between the recombination $\hat{e}_{k, i}^{r}$ and merged predictions of $\hat{o}_{k, i}$ and $\hat{m}_{k, i}$,
\begin{equation}
  \mathcal{L}_{cons} = \frac{1}{K}\sum_{k=1}^{K} \frac{1}{N_{k}} \sum_{i=1}^{N_{k}}{\mathcal{L}_{ce}\left (\hat{e}_{k,i}^{r}, \mathcal{F}_{merge}\left (\hat{o}_{k, i}, \hat{m}_{k, i}\right )\right ) },
  \label{eq:eq6}
\end{equation}
where $\mathcal{F}_{merge}( \cdot)$ represents the merging operation for the intersection region and the complement region in Mergence Unit, which is $xor()$, two sub-region masks are passed through Sigmoid function for normalization. Then, we calculate the Mask Exclusive-OR of two mask logits for merging them and suppressing redundant predicted pixels.

\subsection{Mask-guided Region Proposal} \label{MRP}
It is inevitable for cytology images to exist abundant cellular debris and non-target objects, e.g., white blood cells and mucus. These objects often have a similar appearance as the nuclei, with small round surfaces stained in dark purple, which increases the model identification difficulty. To avoid the interference it brings,  we further propose a Mask-guided Region Proposal module (MRP) to encourage the model to generate nuclei proposals in intra-cellular regions.

For each image, we can aggregate all the recombined instance predictions $\hat{e}_{k, i}^{r}$ in CRM together into a semantic mask $\hat{M}_{k}$. The raw predictions are first mapped back and then summed up according to their bounding boxes predictions $\hat{b}_{k, i}$ in the detection head, followed by a Sigmoid function to normalize them into probabilities. $\hat{M}_{k}$ is considered as the attention score to re-weight features $f_{k}$ in origin FPN via element-wise multiplication:
\begin{equation}
  f_{k}^{w} = \hat{M}_{k} \circ f_{k},
  \label{eq:eq2}
\end{equation}
where $f_{k}^{w} $ denotes the re-weighted features for nuclei proposal predictions in MRP. Thus, extracellular pixels with a lower probability to be cytoplasm are suppressed, which reduces the false positives for background instances (i.e., blood, mucus, and others). In addition, MRP also builds information interaction between different stages, which naturally encourages feature representation ability.

\subsection{End-to-end Learning}\label{E2e}
\noindent \textbf{Extended dataset with synthetic clusters:}
The semi-transparency characteristic of cytoplasm alleviates the effect of high overlap, allowing cytologists to delineate the contour of cellular instances based on expert knowledge. However, extremely challenging labeling and unavoidable label noise limit the availability of large-scale annotated datasets. To tackle this problem, we propose an instance-level data augmentor for overlapping cell data augmentation, which can generate large-scale synthetic cell clusters  with controllable overlapping ratios and transparency based on the annotated cellular instances. This synthetic dataset further facilitates the generalization ability, by providing more diverse data to implicitly learn the concept of instance and its components. See the supplementary material for details of the synthetic pipeline. Unless otherwise specified, we do not use this synthetic dataset in the following comparison.

\noindent \textbf{Overall Loss Function:} 
The proposed cell instance segmentation framework can be trained in a supervised manner. The overall objective $\mathcal{L}$ is as follows,
\begin{equation}
\mathcal{L} =  \mathcal{L}_{coarse} + \lambda_{dec}\mathcal{L}_{dec} + \lambda_{rmask}\mathcal{L}_{rmask} + \lambda_{cons}\mathcal{L}_{cons},   
  % \mathcal{L}_{Sup} = \mathcal{L}_{co} + \lambda_{DRM} \mathcal{L}_{DRM} + \lambda_{CRM} \mathcal{L}_{CRM}
  \label{eq:eq8}
\end{equation}
where $\mathcal{L}_{coarse}$ denotes losses for RoI extraction and coarse mask prediction, $\mathcal{L}_{dec}$ denotes the decomposition loss for intersection and complement regions segmentation, $\mathcal{L}_{rmask}$ is the segmentation loss for refined masks, $\mathcal{L}_{cons}$ supervises the semantic consistency between integral instance and sub-regions. $\lambda_{dec}$, $\lambda_{rmask}$, and $\lambda_{cons}$ are trade-off parameters controlling the importance of each component.
