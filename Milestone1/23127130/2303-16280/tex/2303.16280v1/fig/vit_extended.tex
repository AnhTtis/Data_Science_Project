
    
    \begin{tikzpicture}[font=\fontsize{8}{8}\selectfont]
        \tikzstyle{block} = [
            inner sep=0,
            rectangle, 
            rounded corners=2, 
            blur shadow={
                shadow blur steps=5, 
                shadow xshift=1pt, 
                shadow yshift=-1pt
            },
            align=center,
            draw=black!40, 
        	fill=black!15,
        ]

        \tikzset{
            shadowed/.style={
                preaction={
                    transform canvas={shift={(1pt, -1pt)}},
                    draw=gray,
                    opacity=.75,
                    line width=1pt
                }
            },
        }
        
        \def\xs{180pt}
        \def\ys{200pt}
        \def\lw{.75pt}
        \begin{scope}[x=\xs, y=\ys]
            \def\s{.05 * \xs}
            \tikzstyle{token} = [block, minimum size=\s]
            \tikzstyle{style} = [block, minimum size=\s, draw=or!50!black!75, fill=or!75]
            \tikzstyle{posemb} = [block, minimum size=\s, draw=pr!50!black!75, fill=pr!35]
            \tikzstyle{linear} = [block, draw=yg!50!black!75, fill=yg!35]
            \tikzstyle{transformer} = [block, draw=b2!50!black!75, fill=b2!35]
            \tikzstyle{flow} = [-{Latex[length=1.5mm,width=1.5mm]}, rounded corners, line width=\lw, shorten <=1pt, draw]
            
            \def\hexp{3}
            \def\vexp{1.05}

            \foreach \p/\c in {1/1, 2/2, 3/3, 16/5} {
                \node[token] (i_\c) at (\c * \s * \hexp, 0) {}; 
                \node[token] (ip_\c) at (\c * \s * \hexp, 2 * \vexp * \s) {};
                \path[flow] ([xshift=-.1 * \s]i_\c.north) -- ([xshift=-.1 * \s]ip_\c.south);
                \node[posemb] (p_\c) at (\c * \s * \hexp - 1.15 * \s, 2 * \vexp * \s) {$\p$};

                % linear layer 1 in
                \node[inner sep=0] (l1it_\c) at (\c * \s * \hexp - .65 * \s, 2.5 * \vexp * \s) {};
                \node[inner sep=0] (l1ih_\c) at (\c * \s * \hexp - .65 * \s, 3.5 * \vexp * \s) {};
                \path[flow] (l1it_\c) -- (l1ih_\c);
                % linear layer 1 out
                \node[inner sep=0] (l1ot_\c) at (\c * \s * \hexp - .65 * \s, 4.5 * \vexp * \s) {};
                \node[inner sep=0] (l1oh_\c) at (\c * \s * \hexp - .65 * \s, 5.5 * \vexp * \s) {};
                \path[flow] (l1ot_\c) -- (l1oh_\c);
                
                % transformer in
                \node[token] (tin_\c) at (\c * \s * \hexp - .6 * \s, 6 * \vexp * \s) {};
                % transformer out
                \node[token] (tout_\c) at (\c * \s * \hexp - .6 * \s, 10 * \vexp * \s) {};

                % transformer in
                \node[inner sep=0] (tit_\c) at (\c * \s * \hexp - .65 * \s, 6.5 * \vexp * \s) {};
                \node[inner sep=0] (tih_\c) at (\c * \s * \hexp - .65 * \s, 7.5 * \vexp * \s) {};
                \path[flow] (tit_\c) -- (tih_\c);
                % transformer out
                \node[inner sep=0] (tot_\c) at (\c * \s * \hexp - .65 * \s, 8.5 * \vexp * \s) {};
                \node[inner sep=0] (toh_\c) at (\c * \s * \hexp - .65 * \s, 9.5 * \vexp * \s) {};
                \path[flow] (tot_\c) -- (toh_\c);

                % linear layer 2 in
                \node[inner sep=0] (l2it_\c) at (\c * \s * \hexp - .65 * \s, 10.5 * \vexp * \s) {};
                \node[inner sep=0] (l2ih_\c) at (\c * \s * \hexp - .65 * \s, 11.5 * \vexp * \s) {};
                \path[flow] (l2it_\c) -- (l2ih_\c);
                % linear layer 2 out
                \node[inner sep=0] (l2ot_\c) at (\c * \s * \hexp - .65 * \s, 12.5 * \vexp * \s) {};
                \node[inner sep=0] (l2oh_\c) at (\c * \s * \hexp - .65 * \s, 13.5 * \vexp * \s) {};
                \path[flow] (l2ot_\c) -- (l2oh_\c);

                \node[token] (o_\c) at (\c * \s * \hexp - .6 * \s, 14 * \vexp * \s) {};
                
            }
            % positional embedding label
            \node[inner sep=0, anchor=west, align=center] (plabel) at (6 * \s * \hexp - 1.15 * \s, 2 * \vexp * \s) {concatenate\\positional\\embedding};
            
            % dots
            \node[inner sep=0] at (4 * \s * \hexp, 0) {$\cdots$};
            \node[inner sep=0] at (4 * \s * \hexp - .5 * \s, 2 * \s) {$\cdots$};
            \node[inner sep=0] at (4 * \s * \hexp - .6 * \s, 6 * \vexp * \s) {$\cdots$};
            \node[inner sep=0] at (4 * \s * \hexp - .6 * \s, 10 * \vexp * \s) {$\cdots$};

            % style in, label, and out
            \node[style] (sin) at (6 * \s * \hexp - .6 * \s, 6 * \vexp * \s) {$S$};
            \node[inner sep=0, align=center] (slabel) at (7 * \s * \hexp - .6 * \s, 6 * \vexp * \s) {append a\\style token};
            \node[style] (sout) at (6 * \s * \hexp - .6 * \s, 10 * \vexp * \s) {$S$};
            
            % transformer in
            \node[inner sep=0] (tit) at (6 * \s * \hexp - .65 * \s, 6.5 * \vexp * \s) {};
            \node[inner sep=0] (tih) at (6 * \s * \hexp - .65 * \s, 7.5 * \vexp * \s) {};
            \path[flow] (tit) -- (tih);
            % transformer out
            \node[inner sep=0] (tot) at (6 * \s * \hexp - .65 * \s, 8.5 * \vexp * \s) {};
            \node[inner sep=0] (toh) at (6 * \s * \hexp - .65 * \s, 9.5 * \vexp * \s) {};
            \path[flow] (tot) -- (toh);

            % linear layer 1
            \tikzmath{coordinate \L;\L = (ip_5.north east) - (p_1.south west);}
            \coordinate (lm) at ($(l1it_1)!.5!(l1oh_1)$);
            \node[linear, minimum width=\Lx, minimum height=\s, anchor=west] (linear1) at (p_1.west |- lm) {linear layer};
            % linear layer 2
            \coordinate (lm) at ($(l2it_1)!.5!(l2oh_1)$);
            \node[linear, minimum width=\Lx, minimum height=\s, anchor=west] (linear2) at (p_1.west |- lm) {linear layer};
            % transformer stack
            \tikzmath{coordinate \T;\T = (sin.north east) - (linear1.south west);}
            \coordinate (lm) at ($(tit_1)!.5!(toh_1)$);
            \node[transformer, minimum width=\Tx, minimum height=\s, anchor=west] (trans) at (p_1.west |- lm) {transformer encoder block $\times n$};

            \newcommand{\im}{
                \begin{tikzpicture}
                    \def\exp{1.1}
                    \foreach \r in {1, 2, 3, 4} {
                        \foreach \c in {1, 2, 3, 4} {
                            \node[token] at (\c * \s * \exp, -\r * \s * \exp) {};
                        }
                    }    
                \end{tikzpicture}
            }
            \node[inner sep=0, anchor=east] (enOut) at (0, 0) {\im};
            \node[block, rotate=90, minimum height=\s, minimum width=6 * \s, anchor=south, inner sep=2] (unet_en) at ([xshift=-1.2 * \s]enOut.west) {UNet encoding};
            \path[flow] (unet_en) -- (enOut);
            \node[inner sep=0, anchor=west] (deIn) at (sout.west |- o_5) {\im};
            \path[flow] (enOut) -- (i_1);
            \path[flow] (o_5) -- (deIn);
            \coordinate (de) at ([xshift=1.2 * \s]deIn.east);
            \path[flow] (deIn.east) -- (de);
            \path[flow, draw=or, line width=1.2pt] (sout) -- (de |- sout);
            \coordinate (u) at ($(deIn.east)!.5!(sout.east)$) {};
            \node[block, rotate=90, minimum height=\s, minimum width=6 * \s, anchor=north, inner sep=2] (unet_de) at (u -| de) {UNet decoding}; 
        \end{scope}
    \end{tikzpicture}

