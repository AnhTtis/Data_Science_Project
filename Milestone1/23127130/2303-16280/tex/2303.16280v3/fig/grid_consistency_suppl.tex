\tikzstyle{imagenode} = [inner sep=0, anchor=west]

\tikzstyle{textBG} = [
    inner sep=0, 
    minimum width=\width, 
    minimum height=\width, 
    text width=.9 * \width,
    anchor=west,
    align=left, 
    fill=black!15,
    font=\fontsize{6}{6}\selectfont
]

\tikzstyle{header} = [
    inner sep=0, 
    minimum width=\width, 
    minimum height=.25 * \width, 
    anchor=south,
    rounded corners=2,
    fill=black!30,
    path fading=south,
    font=\fontsize{8}{8}\selectfont,
]

\tikzstyle{index} = [
    inner sep=0, 
    rotate=90,
    anchor=south,
    rounded corners=2,
    fill=black!30,
    path fading=east,
    font=\fontsize{8}{8}\selectfont,
]

\def\folder{fig/grid_consist}
\def\width{.0935\textwidth}
\def\expand{1.03}
\def\comWidth{.2\textwidth}

\newcommand{\fillError}[5]{
    % Inception L2
    \pgfplotstablegetelem{#1}{l2_#2}\of\table;
    \pgfmathsetmacro\IL{\pgfplotsretval};
    % Pixel-wise L2
    \pgfplotstablegetelem{#1}{pixel_l2_#2}\of\table;
    \pgfmathsetmacro\PL{\pgfplotsretval};
    % Source-like consistency categories
    \pgfplotstablegetelem{#1}{#2}\of#5
    % location of the node
    \coordinate (local_temp) at (\width * \expand * #4, -\width * \expand * #3);
    \node[textBG] (\row_#4) at (local_temp) {
        \setlength\tabcolsep{1pt}
        \renewcommand{\arraystretch}{1.2}
        \begin{tabular}{rcp{15pt}}    
            $L_2$ & $=$ & $\round[1]{\PL}$\\
            I-$L_2$ & $=$ & $\round[1]{\IL}$\\
            PIF & $=$ & \pgfplotsretval
        \end{tabular}
    };
}


\newcounter{dummy}

\newcommand{\gridSym}[4][]{
    \begin{tikzpicture}
        \pgfplotstableread[col sep=comma]{\folder/male2female_#2.csv}\table        
        \setcounter{dummy}{0}% 
        \foreach \idx [count=\row] in {#3} {
            \stepcounter{dummy}
            \foreach \name/\col in {input/0, EGSDE1/-1, UVCGAN2wo/1}{
                \def\fname{\folder/male2female_#2_\name_\idx.png.jpg}
                \coordinate (local_temp) at (\width * \expand * \col, -\width * \expand * \row);
                \node[imagenode] (\row_\col) at (local_temp) {\includegraphics[width=\width]{\fname}};
            }
            % EGSDE and UVCGAN L2s
            \fillError{\idx}{EGSDE1}{\row}{-2}{#4}
            \fillError{\idx}{UVCGAN2wo}{\row}{2}{#4}
        }
        % headers
        \node[header] (h_input) at (1_0.north) {input};
        \tikzmath{ coordinate \C; \C = (1_-1.north east) - (1_-2.south west); }
        \node[header, minimum width=\Cx, anchor=south west] at (1_-2.north west) {\egsde};
        \tikzmath{ coordinate \C; \C = (1_2.north east) - (1_1.south west); }
        \node[header, minimum width=\Cx, anchor=south west] at (1_1.north west) {\thename};
        % index (used to indicate type)
        \edef\num{\arabic{dummy}}
        \ifthenelse{\equal{#1}{}} % test whether an index string is given
                   {} % if not, do nothing
                   {\node[index, minimum width=\num * \width * \expand - \width * \expand + \width, minimum height=.28 * \width, anchor=south east] at (1_-2.north west) {#1};}
    \end{tikzpicture}
}


\begin{filecontents}{typeOneComment.tab}
EGSDE1 & UVCGAN2wo
7    & 1, 2, 3, 4
     & 2, 3, 4
7    & 2, 3
     & 2, 3, 4
7, 8 & 3, 4, 5, 6
     & 1, 2, 4, 6
8    & 1, 2, 4, 6
7    & 2, 3, 6
     & 1, 3, 5, 6
7, 8 & 2, 3, 4
8    & 1, 2, 4, 6
     & 1, 2, 3
     & 2, 3, 4, 8
     & 2, 3, 4, 8  
\end{filecontents}
\pgfplotstableread[col sep=&]{typeOneComment.tab}{\commentOne}

\begin{filecontents}{typeTwoComment.tab}
EGSDE1 & UVCGAN2wo
7    & 2, 3, 5
     & 2, 3
7    & 1, 2, 3, 6
7    & 2, 3, 5, 6
6    & 1, 2, 3, 5
7    & 1, 2, 3, 6
\end{filecontents}
\pgfplotstableread[col sep=&]{typeTwoComment.tab}{\commentTwo}

\begin{table*}
    \centering
    \caption{\textbf{Comparing \egsde and \thename translations with $L_2$ and I-$L_2$ scores.}}
    \vskip-3mm
    \label{tab:comparingTransWithL2}
    \tikzexternaldisable
    \tikzsetnextfilename{app-comparison_type1_1}
    \begin{tikzpicture}
        \node[inner sep=2pt, fill=white] at (0, 0) {
            \begin{tikzpicture}
                \node[inner sep=0] (Type1left) at (0, 0) {\gridSym[Type 1]{type1}{0, ..., 6}{\commentOne}};
                \node[inner sep=0, anchor=west] (Type1right) at ([xshift=3pt]Type1left.east) {\gridSym{type1}{7, ..., 13}{\commentOne}};
                \node[inner sep=0, anchor=north] (Type2left) at ([yshift=-5pt]Type1left.south) {\gridSym[Type 2]{type2}{0, ..., 2}{\commentTwo}};
                \node[inner sep=0, anchor=north] (Type2right) at ([yshift=-5pt]Type1right.south) {\gridSym{type2}{3, ..., 5}{\commentTwo}};
        
                \node[inner sep=5pt, 
                      draw=black!40,
                      thick,
                      anchor=north east, 
                      fill=black!20,
                      blur shadow={shadow blur steps=5},
                      rounded corners] at ([xshift=-1pt, yshift=-5pt]Type2right.south east) 
                {
                    \begin{tikzpicture}
                        \def\lwidth{1.28 * \width}
                        \tikzstyle{legendCell} = [inner sep=0, align=left, anchor=north, font=\fontsize{9}{9}\selectfont]
                        \foreach \cat [count=\idx] in {background, bone structure, expression, apparent age, eye color, eyebrows, hair color, hair texture} {
                            \node[legendCell, 
                                 %text width=\lwidth
                                 ] (1_\idx) at (\idx * \lwidth, 0) {\idx.~\cat};
                        }
                        \node[legendCell, anchor=south west] at ([xshift=-4pt, yshift=4pt]1_1.north west) {Categories of perceived image faithfulness (PIF):};
                    \end{tikzpicture}
                };
            \end{tikzpicture}
        };
    \end{tikzpicture}
\end{table*}
