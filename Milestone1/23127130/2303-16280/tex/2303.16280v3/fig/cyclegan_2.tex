




    % \resizebox{\linewidth}{!}{
    \begin{tikzpicture}[font=\fontsize{8}{8}\selectfont]
        \tikzstyle{block} = [
            rectangle, 
            rounded corners=2, 
            blur shadow={
                shadow blur steps=5, 
                shadow xshift=1pt, 
                shadow yshift=-1pt},
            align=center,
            draw=black!40, 
        	fill=black!15,
        ]
    
        \def\xs{150pt}
        \def\ys{160pt}
        \def\lw{1pt}
        
        \begin{scope}[x=\xs, y=\ys]
            \tikzstyle{data} = [block, minimum size=.09 * \xs]
            
            \tikzstyle{gen} = [block, minimum size=.09 * \xs, text=black, draw=or!100!black!80, fill=or!80, inner sep=2pt]
            \tikzstyle{dis} = [block, minimum size=.09 * \xs, text=white, draw=b2!100!black!80, fill=b2, inner sep=2pt]
            
            \tikzstyle{loss} = [block, inner sep=3pt, execute at begin node=\setlength{\baselineskip}{3ex}]
            \tikzstyle{genloss} = [loss, draw=or!50!black!40, fill=or!40, font=\fontsize{7}{7}\selectfont]
            \tikzstyle{disloss} = [loss, draw=b2!50!black!40, fill=b2!40, font=\fontsize{7}{7}\selectfont]
            
            \tikzstyle{flow} = [-{Latex[length=2mm, width=2mm]}, rounded corners=5pt, line width=2.5*\lw, draw=black!75]
            \tikzstyle{flowloss} = [-{Latex[length=1.5mm, width=1.5mm]}, rounded corners=5pt, line width=1.5 * \lw, densely dotted, draw=black!45]
            \tikzstyle{flowloss} = [-{Latex[length=1.5mm, width=1.5mm]}, rounded corners=5pt, line width=1.5 * \lw, densely dotted, draw=black!45]
            \tikzstyle{textnode} = [inner sep=1pt, font=\fontsize{7}{7}\selectfont]
    
            \def\xshift{.5 * \xs}
            \def\yshift{0.11 * \ys}
            
            % domainA
            \node[data, fill=white] (A) at (0, 0) {$a$};
            \node[gen, anchor=north] (GabA) at ([yshift=-\yshift]A.south) {$\gab$};
            \node[data, anchor=north] (FB) at ([yshift=-\yshift]GabA.south) {$\fake{b}$};
            \node[data, anchor=east] (CA) at ([xshift=-\xshift]A.west) {$\reco{a}$};
            \node[gen, anchor=north] (GbaA) at ([yshift=-\yshift]CA.south) {$\gba$};
            \draw[flow] (A) -- (GabA);
            \draw[flow] (GabA) -- (FB);
            
            \node[genloss, align=center] (CycleLossA) at ($(A)!.5!(CA)$) {Cycle-\\consistency\\loss};
            \draw[flowloss, rounded corners=15] (FB) -| (GbaA);
            \draw[flowloss] (GbaA) -- (CA);
            \draw[flowloss] (A) -- (CycleLossA);
            \draw[flowloss] (CA) -- (CycleLossA);

            % \coordinate (cir) at ([xshift=10pt]$(CycleLossA.north)!1.2!(CycleLossA.south)$) {};
            % \draw[flowloss, opacity=.5] (cir)  arc (60:-240:15pt);
            
            % domain B
            \node[data, anchor=west, fill=white] (B) at ([xshift=1.3*\xshift]FB.east) {$b$};
            \node[gen, anchor=south] (GbaB) at ([yshift=\yshift]B.north) {$\gba$};
            \node[data, anchor=south] (FA) at ([yshift=\yshift]GbaB.north) {$\fake{a}$};
            \node[data, anchor=west] (CB) at ([xshift=\xshift]B.east) {$\reco{b}$};
            \node[gen, anchor=south] (GabB) at ([yshift=\yshift]CB.north) {$\gab$};

            \draw[flow] (B) -- (GbaB);
            \draw[flow] (GbaB) -- (FA);
            
            \node[genloss] (CycleLossB) at ($(B)!.5!(CB)$) {Cycle-\\consistency\\loss};
            \draw[flowloss, rounded corners=15] (FA) -| (GabB);
            \draw[flowloss] (GabB) -- (CB);
            \draw[flowloss] (B) -- (CycleLossB);
            \draw[flowloss] (CB) -- (CycleLossB);
            
            % \coordinate (cir) at ([xshift=-10pt]$(CycleLossB.south)!1.2!(CycleLossB.north)$) {};
            % \draw[flowloss, opacity=.5] (cir)  arc (240:-60:15pt);

            % discriminator
            \node[dis] (DA) at ($(A)!.5!(FA)$) {$\da$};
            \node[dis] (DB) at ($(FB)!.5!(B)$) {$\db$};
            \draw[flowloss] (A) -- (DA);
            \draw[flowloss] (FA) -- (DA);
            \draw[flowloss] (B) -- (DB);
            \draw[flowloss] (FB) -- (DB);

            % Identity loss Gba
            \node[data, anchor=north west, fill=white] (AA) at ([xshift=1.5 * \xshift]FA.east |-CycleLossA.north) {$a$};
            \node[data, anchor=west] (AI) at ([xshift=1 * \xshift]AA.east) {$\iden{a}$};
            \node[gen] (GbaI) at ($(AA)!.5!(AI)$) {$\gba$};
            \draw[flowloss] (AA) -- (GbaI);
            \draw[flowloss] (GbaI) -- (AI);
            \node[genloss, anchor=north] (AIdtLoss) at ([yshift=-.35 * \yshift]GbaI.south) {Identity loss};
            \draw[flowloss] (AA) |- (AIdtLoss);
            \draw[flowloss] (AI) |- (AIdtLoss);
            
            % Identity loss Gba
            \node[data, anchor=north, fill=white] (BB) at ([yshift=-1.3 * \yshift]AA.south) {$b$};
            \node[data, anchor=west] (BI) at (AI.west |- BB) {$\iden{b}$};
            \node[gen] (GabI) at ($(BB)!.5!(BI)$) {$\gab$};
            
            \draw[flowloss] (BB) -- (GabI);
            \draw[flowloss] (GabI) -- (BI);
            \node[genloss, anchor=north] (BIdtLoss) at ([yshift=-.35 * \yshift]GabI.south) {Identity loss};
            \draw[flowloss] (BB) |- (BIdtLoss);
            \draw[flowloss] (BI) |- (BIdtLoss);

            % legend
            \tikzmath{coordinate \L; \L=(AI.east)-(AA.west);}
            \node[minimum height=\yshift, minimum width=\Lx, rounded corners=4, fill=black!15, anchor=south west] (LegendBG) at (BB.west |- CycleLossB.south) {};
            % legend arrow and label
            \coordinate (TI) at ($(LegendBG.west)!.05!(LegendBG.east)$);
            \coordinate (HI) at ($(LegendBG.west)!.20!(LegendBG.east)$);
            \draw[flow] (TI) -- (HI);
            \node[textnode, anchor=west, align=left] (legendInf) at ([xshift=4pt]HI.east) {inference\\(translation)};
            \coordinate (TL) at ($(LegendBG.west)!.65!(LegendBG.east)$);
            \coordinate (HL) at ($(LegendBG.west)!.80!(LegendBG.east)$);
            \draw[flowloss] (TL) -- (HL);
            \node[textnode, anchor=west] (legendLoss) at ([xshift=4pt]HL.east) {loss};

            % Discriminator and generator losses
            \tikzmath{coordinate \C;\C=(FA.east |- DA.north)-(A.west |- DA.south);}
            \def\dxsep{.58 * \Cx}
            \def\dysep{.88 * \Cy}
            \def\gxsep{.34 * \Cx}
            \def\gysep{.84 * \Cy}
            \begin{pgfonlayer}{back}
                \def\op{.6}
                \node[disloss, inner xsep=\dxsep, inner ysep=\dysep, rounded corners=4, draw opacity=\op] (DALoss) at ($(DA.north)!.76!(DA.south)$) {};
                \node[disloss, inner xsep=\dxsep, inner ysep=\dysep, rounded corners=4, draw opacity=\op] (DBLoss) at ($(DB.south)!.76!(DB.north)$)  {};
                \coordinate (V) at ($(FA)!.52!(DA)$);
                \coordinate (H) at ($(DA.south)!.70!(DA.north)$);
                \node[genloss, inner xsep=\gxsep, inner ysep=\gysep, rounded corners=4, draw opacity=\op] (GabGANLoss) at (V |- H) {};
                \coordinate (V) at ($(FB)!.52!(DB)$);
                \coordinate (H) at ($(DB.north)!.70!(DB.south)$);
                \node[genloss, inner xsep=\gxsep, inner ysep=\gysep, rounded corners=4, draw opacity=\op] (GbaGANLoss) at (V |- H) {};
                \node[textnode, anchor=south] at (DALoss.south) {Discriminator GAN loss};
                \node[textnode, anchor=north] at (DBLoss.north) {Discriminator GAN loss};
                \node[textnode, anchor=north] at (GabGANLoss.north) {Generator GAN loss};
                \node[textnode, anchor=south] at (GbaGANLoss.south) {Generator GAN loss};
            \end{pgfonlayer}
            
            % % legend background
            % \tikzmath{coordinate \L; \L=(legendLoss.east |- legendInf.north)-(TI.west |- legendInf.south);}
            % \begin{pgfonlayer}{back}
            %     \node[inner xsep=.55 * \Lx, inner ysep=.6 * \Ly, rounded corners=4, fill=black!10, anchor=west] (legendBG) at (GbaA.west |- TI) {}; 
            % \end{pgfonlayer}
            
        \end{scope}    
    \end{tikzpicture}
    % }
