



    \begin{tikzpicture}[font=\fontsize{8}{8}\selectfont]
        \tikzstyle{block} = [
            rectangle, 
            rounded corners=2, 
            blur shadow={
                shadow blur steps=5, 
                shadow xshift=1pt, 
                shadow yshift=-1pt
            },
            align=center,
            draw=black!40, 
        	fill=black!15,
        ]

        \def\xs{145pt}
        \def\ys{150pt}
        \def\lw{1pt}
        
        \begin{scope}[x=\xs, y=\ys]

            \tikzstyle{encdec} = [block, minimum width=.23 * \xs, minimum height=.22 * \ys]
            \tikzstyle{inout} = [block, minimum width=.23 * \xs, minimum height=.1 * \ys]
            \tikzstyle{inner} = [inner sep=1pt, block, minimum width=.18 * \xs, minimum height=.07 * \ys]
            \tikzstyle{basic} = [inner, draw=b1!.5!black, fill=b1!50]
            \tikzstyle{downsample} = [inner, draw=yg!.5!black, fill=yg!50]
            \tikzstyle{upsample} = [inner, draw=pg!.5!black, fill=pg!75]
            \tikzstyle{modconv} = [inner, draw=or!.5!black, fill=or!75]
            \tikzstyle{bottleneck} = [block, minimum width=.35 * \xs, minimum height=.12 * \ys]
            \tikzstyle{concat} = [circle, inner sep=.005 * \xs, draw=black, fill=black!5]
            \tikzstyle{flow} = [-{Latex[length=1.5mm,width=1.5mm]}, rounded corners, line width=\lw]

            \node[bottleneck] (b) at (0, 0) {extended ViT};
            \foreach \layerId/\level in {4/.7, 3/1.7, 2/2.7, 1/3.7} {
                % get height
                \pgfmathsetmacro\height{\level / 4}
                % get width
                \pgfmathparse{sqrt(\height)}
                \pgfmathsetmacro{\width}{\pgfmathresult}

                % blocks
                \node[encdec] (enc_\layerId) at (-\width, \height) {};
                \node[encdec] (dec_\layerId) at (\width, \height) {};
                \def\innershift{.018}
                \node[basic, anchor=south] (b_\layerId) at (-\width, \height + \innershift) {$B_{\layerId}$};
                \node[downsample, anchor=north] (d_\layerId) at (-\width, \height - \innershift) {$D_{\layerId}$};
                \node[upsample, anchor=north] (u_\layerId) at (\width, \height - \innershift) {$U_{\layerId}$};
                \node[modconv, anchor=south] (m_\layerId) at (\width, \height + \innershift) {$M_{\layerId}$};
                \node[concat] (c_\layerId) at ($(m_\layerId.east)!1.8!(m_\layerId.west)$) {$\oplus$};
                
                % inner level flows
                \draw[flow] (b_\layerId) -- (d_\layerId);
                \draw[flow] (b_\layerId) -- (c_\layerId);
                \draw[flow] (u_\layerId) -| (c_\layerId);
                \draw[flow] (c_\layerId) -- (m_\layerId);
            }
            
            % the L-shaped flows between levels
            \draw[flow] (d_4) |- (b);
            \draw[flow] ($(b.north east)!.35!(b.south east)$) -| (u_4);
            \foreach \fr/\to in {1/2, 2/3, 3/4} {
                \draw[flow] (d_\fr) |- (b_\to);
                \draw[flow] ($(m_\to.north east)!.35!(m_\to.south east)$) -| (u_\fr);
            }
            
            % the flow of "mod"
            \def\modCol{or}
            \def\bendPointXShift{.2 * \xs}
            \def\lw{1.2pt}
            \draw[line width=\lw, draw=\modCol] ($(b.north east)!.65!(b.south east)$) --++ (\bendPointXShift, 0);
            \node[inner sep=1pt, text=\modCol, anchor=south west, rotate=35] at ($(b.north west)!2.2!(b.north east)$) {style};
            \coordinate (l) at ($(m_1.north west)!.65!(m_1.south west)$);
            \coordinate (r) at ($(m_1.north east)!.65!(m_1.south east)$);
            
            \draw[draw=\modCol, name path=parabola, line width=\lw] ([xshift=\bendPointXShift]$(b.north east)!.65!(b.south east)$) parabola ($(l)!1.8!(r)$);
            \foreach \layerId in {1, 2, 3, 4} {
                \coordinate (p_\layerId) at ($(m_\layerId.north east)!.65!(m_\layerId.south east)$);
                \path[name path=phantom, overlay] (p_\layerId) --++ (.5 * \xs, 0);
                \draw[flow, draw=\modCol, name intersections={of=parabola and phantom, by=i}] (i) -- (p_\layerId); % !!!!!! DON'T PUT WHITE SPACE AFFTER "of"
            }

            % input and output
            \node[inout] (input) at ($(b_1.south)!2.5!(b_1.north)$) {Input};
            \node[inout] (output) at ($(m_1.south)!2.5!(m_1.north)$) {Output};
            \draw[flow] (input) -- (b_1);
            \draw[flow] (m_1) -- (output);

            % mark the branches of the unet
            \draw[flow,dashed,black!50] ([xshift=.1 * \xs]enc_1.east) to[bend right=10] ([xshift=0.1 * \xs]enc_4.east);
            \node[inner sep=1pt,align=center,text=black!50, fill=white] at ([xshift=0.15 * \xs, yshift=-.075 * \ys]enc_2.east) {encoding};
            \draw[flow,dashed,black!50] ([xshift=-.25 * \xs, yshift=0]dec_4.west) to[bend right=10] ([xshift=-.25 * \xs]dec_1.west);
            \node[inner sep=1pt,align=center,text=black!50,fill=white] at ([xshift=-.275 * \xs, yshift=-.075 * \ys]dec_2.west) {decoding};
        \end{scope}
    \end{tikzpicture}

