

    \begin{tikzpicture}[font=\fontsize{10}{10}\selectfont]
        \tikzstyle{block} = [
            rectangle, 
            rounded corners=2, 
            blur shadow={
                shadow blur steps=5, 
                shadow xshift=1pt, 
                shadow yshift=-1pt},
            align=center,
            draw=black!40, 
        	fill=black!15,
        ]
    
        \def\xs{140pt}
        \def\ys{150pt}
        \def\lw{1pt}
        
        \begin{scope}[x=\xs, y=\ys]
            \tikzstyle{data} = [block, minimum size=.1 * \xs, font=\fontsize{11}{11}\selectfont]
            
            \tikzstyle{gen} = [block, minimum size=.1 * \xs, text=white, draw=or!100!black!80, fill=or, inner sep=2pt]
            \tikzstyle{dis} = [block, minimum size=.1 * \xs, text=white, draw=b2!100!black!80, fill=b2, inner sep=2pt]
            
            \tikzstyle{loss} = [block, inner sep=3pt, execute at begin node=\setlength{\baselineskip}{3ex}]
            \tikzstyle{genloss} = [loss, draw=or!50!black!40, fill=or!40]
            \tikzstyle{disloss} = [loss, draw=b2!50!black!40, fill=b2!40]
            
            \tikzstyle{flow} = [-{Latex[length=1.5mm, width=1.5mm]}, rounded corners=5pt, line width=\lw]
    
            \def\xshift{.1 * \xs}
            \def\yshift{0.07 * \ys}
            
            % upper
            \node[data] (A) at (0, 0) {$a$};
            \node[gen, anchor=west] (GabU) at ([xshift=14pt]A.east) {$\gab$};
            \node[data, anchor=west] (FB) at ([xshift=\xshift]GabU.east) {$\fake{b}$};
            \node[gen, anchor=west] (GbaU) at ([xshift=\xshift]FB.east) {$\gba$};
            \node[data, anchor=west] (CA) at ([xshift=\xshift]GbaU.east) {$\reco{a}$};
            \draw[flow] (A) -- (GabU);
            \draw[flow] (GabU) -- (FB);
            \draw[flow] (FB) -- (GbaU);
            \draw[flow] (GbaU) -- (CA);
            \node[genloss, anchor=south] (CycleLossU) at ([yshift=\yshift]FB.north) {cycle-consistency loss};
            \draw[flow] (A) |- (CycleLossU);
            \draw[flow] (CA) |- (CycleLossU);
            
            % lower
            \node[data, anchor=north] (B) at ([yshift=-4.8* \yshift]FB.south) {$b$};
            \node[gen, anchor=east] (GbaL) at ([xshift=-\xshift]B.west) {$\gba$};
            \node[data, anchor=east] (FA) at ([xshift=-\xshift]GbaL.west) {$\fake{a}$};
            \node[gen, anchor=east] (GabL) at ([xshift=-\xshift]FA.west) {$\gab$};
            \node[data, anchor=east] (CB) at ([xshift=-\xshift]GabL.west) {$\reco{b}$};
            \draw[flow] (B) -- (GbaL);
            \draw[flow] (GbaL) -- (FA);
            \draw[flow] (FA) -- (GabL);
            \draw[flow] (GabL) -- (CB);
            \node[genloss, anchor=north] (CycleLossL) at ([yshift=-\yshift]FA.south) {cycle-consistency loss};
            \draw[flow] (B) |- (CycleLossL);
            \draw[flow] (CB) |- (CycleLossL);

            % discriminator
            \node[dis] (DA) at ($(A)!.5!(FA)$) {$\da$};
            \node[dis] (DB) at ($(FB)!.5!(B)$) {$\db$};
            \draw[flow] (A) -- (DA);
            \draw[flow] (FA) -- (DA);
            \draw[flow] (B) -- (DB);
            \draw[flow] (FB) -- (DB);
            
            % Identity loss Gba
            \node[data] (AA) at ([xshift=-7*\xshift]DA.west) {$a$};
            \node[gen, anchor=west] (GbaI) at ([xshift=\xshift]AA.east) {$\gba$};
            \node[data, anchor=west] (AI) at ([xshift=\xshift]GbaI.east) {$\iden{a}$};
            \draw[flow] (AA) -- (GbaI);
            \draw[flow] (GbaI) -- (AI);
            \node[genloss, anchor=south] (AIdtLoss) at ([yshift=\yshift]GbaI.north) {identity loss};
            \draw[flow] (AA) |- (AIdtLoss);
            \draw[flow] (AI) |- (AIdtLoss);
            
            % Identity loss Gba
            \node[data] (BB) at ([xshift=2*\xshift]DB.east) {$b$};
            \node[gen, anchor=west] (GabI) at ([xshift=\xshift]BB.east) {$\gba$};
            \node[data, anchor=west] (BI) at ([xshift=\xshift]GabI.east) {$\iden{b}$};
            \draw[flow] (BB) -- (GabI);
            \draw[flow] (GabI) -- (BI);
            \node[genloss, anchor=north] (BIdtLoss) at ([yshift=-\yshift]GabI.south) {identity loss};
            \draw[flow] (BB) |- (BIdtLoss);
            \draw[flow] (BI) |- (BIdtLoss);

            % legend
            \node[genloss, inner ysep=4pt, inner xsep=10pt, anchor=west] (LegendGLoss) at ([xshift=-\xshift]BB |- CycleLossL) {};
            \node[inner sep=0, anchor=west] at ([xshift=4pt]LegendGLoss.east) {generator losses};
            \node[disloss, inner ysep=4pt, inner xsep=10pt, anchor=south west] (LegendDLoss) at ([yshift=5pt]LegendGLoss.north west) {};
            \node[inner sep=0, anchor=west] at ([xshift=4pt]LegendDLoss.east) {discriminator losses};
            
            % Discriminator and generator losses
            \tikzmath{coordinate \C;\C=(A.north -| DA.east)-(FA.south -| DA.west);}
            \def\dxsep{.90 * \Cx}
            \def\dysep{.58 * \Cy}
            \def\gxsep{.68 * \Cx}
            \def\gysep{.36 * \Cy}
            \begin{pgfonlayer}{back}
                \node[disloss, inner xsep=\dxsep, inner ysep=\dysep, rounded corners=4] (DALoss) at ([yshift=2pt]DA) {};
                \node[genloss, inner xsep=\gxsep, inner ysep=\gysep, rounded corners=4] (GabGANLoss) at ($(A)!.5!(DA)$) {};
            \end{pgfonlayer}
            
            \tikzmath{coordinate \C;\C=(FB.north -| DA.east)-(B.south -| DA.west);}
            \begin{pgfonlayer}{back}
                \node[disloss, inner xsep=\dxsep, inner ysep=\dysep, rounded corners=4] (DBLoss) at ([yshift=-2pt]DB) {};
                \node[genloss, inner xsep=\gxsep, inner ysep=\gysep, rounded corners=4] (GbaGANLoss) at ($(B)!.5!(DB)$) {};
            \end{pgfonlayer}
            \node[anchor=west] at (BI.east) {};
        \end{scope}    
    \end{tikzpicture}
