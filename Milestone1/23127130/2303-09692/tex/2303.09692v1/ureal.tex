
\section{Unit real interval (complete lattice)}
\label{sec:ureal}
Our probabilistic programs are real-valued functions over state space, and specifically, they are the functions from state space to real numbers between 0 and 1 inclusive, or the \emph{unit real interval} ($\ureal$). We call them $\ureal$-valued functions, denoted as $S \fun \ureal$. To deal with the semantics of probabilistic loops in Section~\ref{sec:rec} using the Knasterâ€“Tarski and Kleene fixed-point theorems~\cite{Tarski1955}, we define a complete lattice containing a set of these functions together with a pointwise comparison relation $\leq$.

Section~\ref{ssec:ureal_def} defines $\ureal$ and constructs a complete lattice containing the set $\ureal$ with relation $\leq$. Then we define $\ureal$-valued functions and the pointwise comparison relation in Section~\ref{ssec:ureal_functions}. With these definitions, we construct the required complete lattice for characterising probabilistic loops. 

\subsection{Definition of $\ureal$}
\label{ssec:ureal_def}
The $\ureal$ is defined below as a set of real numbers between $0$ and $1$. 
\begin{definition}[Unit real interval]
%    \begin{align*}
        $\ureal \defs \{0 \upto 1\}$
%    \end{align*}
    $ $\isalink{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice.thy\#L17}
\end{definition}

We also define two functions to get the smaller and larger value of two comparable numbers, such as real numbers and $ureal$ numbers. 
\begin{definition}[Maximum and minimum of real numbers]
    \label{def:min_max}
   \begin{align*}
       & \umax\left(x, y\right) \defs \left(\IF x \leq y \THEN y \ELSE x\right) \qquad 
       \umin\left(x, y\right) \defs \left(\IF x \leq y \THEN x \ELSE y\right)
   \end{align*}
\end{definition}

The two functions $\umin$ and $\umax$ entitle us to define conversions between real numbers and $\ureal$ numbers.
\begin{definition}[Conversion between $\ureal$ and $\real$]
    \label{def:u2r_r2u}
    We define functions $\urealreal$ (\isaref{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice.thy\#L30}) and $\realureal$ (\isaref{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice.thy\#L27}) (notations $x^r$ and $y^u$) to convert $x$ of $\ureal$ to $\real$, and $y$ of $\real$ to $\ureal$.
    \begin{align*}
       & x^r \defs \left(x :: \real\right) \qquad
       y^u \defs \umin\left(\umax\left(0, y\right), 1\right)
    \end{align*}
\end{definition}
The conversion of a $\ureal$ number $x$ to a real number, by function $\urealreal$, is simply a type cast from $\ureal$ to $\real$. The conversion of a real number $y$ to $\ureal$, by function $\realureal$, however, needs to deal with the cases when $y$ is out of the unit interval. We use $\umin$ and $\umax$ to bound it to 0 or 1 in these cases, and keep its value if $y$ is between 0 and 1. We show both functions are monotonic. 

\begin{lem}
    The function $\urealreal$ is strictly monotonic (\isaref{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice_laws.thy\#L42}). That is, if $x < y$, then $x^r < y^r$. The function $\realureal$ is monotonic (\isaref{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice_laws.thy\#L49}), but not strictly. 
   For example, $2^u = 3^u$ (both equal to $\uone$) though $2 < 3$.
\end{lem}

The function $\realureal$ is the inverse of $\urealreal$. 
\begin{lem}
    $\left(x^r\right)^u = x$ \isalink{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice_laws.thy\#L320}
\end{lem}

The function $\urealreal$ is the inverse of $\realureal$ only if the real number to be converted is between 0 and 1.
\begin{lem}
   $\left(x \geq 0 \land x \leq 1\right) \implies \left(x^u\right)^r = x$ 
    \isalink{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice_laws.thy\#L314}
\end{lem}

Infimum and supremum of $\ureal$ are defined using Hilbert's $\varepsilon$-operator.
\begin{definition}[Infimum and supremum of $\ureal$]
    \begin{align*}
       & \thninf A \defs \left(\varepsilon~x \bullet \left(\forall y \in S @ x \leq y \right) \land \left(\forall z \bullet \left(\forall y\in A \bullet z \leq y\right) \implies z \leq x \right)\right)  \\
       & \thnsup A \defs \left(\varepsilon~x \bullet \left(\forall y \in S @ y \leq x \right) \land \left(\forall z \bullet \left(\forall y\in A \bullet y \leq z\right) \implies x \leq z \right)\right) 
    \end{align*}
\end{definition}
Essentially, the infimum satisfies Laws~\ref{law:Inf_lower} and \ref{law:Inf_greatest}, and the supremum satisfies Laws~\ref{law:Sup_upper} and \ref{law:Sup_least}.

A complete lattice is now formed using these definitions.
\begin{thm}
   % The poset $\left(\ureal, \leq\right)$ is a complete lattice, with infimum $\umin$, supremum $\umax$, greatest element $\uone$ ($1^u$), and least element $\uzero$ ($0^u$).
   The poset $\left(\ureal, \leq\right)$ with the least element $\uzero$ ($0^u$), the greatest element $\uone$ ($1^u$), $\umin$, $\umax$, $\thninf$, and $\thnsup$ forms a complete lattice $\left(\ureal, \leq, <, \uzero, \uone, \umin, \umax, \thnsup, \thninf\right)$.
   %The poset $\left(\ureal, \leq, <, \uzero, \uone, \umin, \umax, \right)$ is a complete lattice, with infimum $\umin$, supremum $\umax$, greatest element $\uone$ ($1^u$), and least element $\uzero$ ($0^u$).
    $ $\isalink{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice.thy\#L51}
\end{thm}

This complete lattice is illustrated in the left diagram of Fig.~\ref{fig:ureal_complete_lattices}. Indeed, it is a totally ordered set.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[!ht]
    \begin{center}
\newcommand\SC{0.75}
\newcommand\SCC{0.75}
\begin{tikzpicture}[x=1.4cm,y=1.8cm,
        roundnode/.style={circle, draw=green!60, fill=green!5, very thick, minimum size=7mm},
        distnode/.style={rectangle, draw=black, fill=red!5},
        supdistnode/.style={rectangle, draw=black, very thick},
        subdistnode/.style={rectangle, draw=black, dashed},
    ]% <-- change this numbers if you need (separations)
% nodes
\node at (0,0)    (UB)  {\small$\uzero(\bot)$};
\node at (0,1*\SC)    (U1)  {\small$\frac{1}{4}$};
\node at (0,2*\SC)   (U2)  {\small$\frac{1}{2}$};
\node at (0,3*\SC)   (U3)  {\small$\frac{3}{4}$};
\node at (0,4*\SC)   (UT)  {\small$\uone(\top)$};
% lines
\draw (UB) -- (U1) -- (U2) -- (U3) -- (UT);

\node[subdistnode] at (4,0)    (F0)  {\small$\ufzero(\bot)$};
\node[subdistnode] at (4,1*\SCC)    (F14)  {\small$\mathring{\frac{1}{4}}$};
\node[distnode] at (4,2*\SCC)    (F12)  {\small$\mathring{\frac{1}{2}}$};
\node[supdistnode] at (4,3*\SCC)    (F34)  {\small$\mathring{\frac{3}{4}}$};
\node[supdistnode] at (4,4*\SCC)    (F1)  {\small$\ufone(\top)$};

\node[subdistnode] at (2.5,0.5*\SCC)    (F1814)  {\small$\langle {\frac{1}{8}}, {\frac{1}{4}}\rangle$};
\node[subdistnode] at (2.5,1.5*\SCC)    (F1214)  {\small$\langle {\frac{1}{2}}, {\frac{1}{4}}\rangle$};
\node[distnode] at (2.5,2.5*\SCC)    (F3414)  {\small$\langle {\frac{3}{4}}, {\frac{1}{4}}\rangle$};
\node[supdistnode] at (2.5,3.5*\SCC)    (F0114)  {\small$\langle 1, {\frac{1}{4}}\rangle$};

\node[subdistnode] at (5.5,0.5*\SCC)    (F1718)  {\small$\langle {\frac{1}{7}}, {\frac{1}{8}}\rangle$};
\node[subdistnode] at (5.5,1.5*\SCC)    (F1727)  {\small$\langle {\frac{1}{7}}, {\frac{2}{7}}\rangle$};
\node[distnode] at (5.5,2.5*\SCC)    (F3747)  {\small$\langle {\frac{3}{7}}, {\frac{4}{7}}\rangle$};
\node[supdistnode] at (5.5,3.5*\SCC)    (F3701)  {\small$\langle {\frac{3}{7}}, 1\rangle$};

\draw (F0) -- (F14) -- (F12) -- (F34) -- (F1);
\draw (F0) -- (F1814) -- (F14) -- (F1214) -- (F3414) -- (F0114) -- (F1);
\draw (F1214) -- (F12);
\draw (F1814) -- (F1214);
\draw (F3414) -- (F34);
\draw (F0) -- (F1718) -- (F1727) -- (F3747) -- (F3701) -- (F1);
\draw (F1718) -- (F14);
\draw (F1727) -- (F12);
\draw (F3747) -- (F34);
\draw (F14) -- (F3747);
%\foreach\i in {1,...,5}
%  \draw (I)   -- (A\i);
%\foreach\i in {1,2} \foreach\j[evaluate={\jj=int(2*\i+\j-2);}] in {1,2}
%  \draw (B\i) -- (A\jj);
%\foreach\i in {1,3} \foreach\j[evaluate={\jj=int(\i+\j-1);}] in {1,2,3}
%  \draw (C\i) -- (B\jj);
%\draw   (C2)  -- (B3);
%\foreach\i in {1,2,3}
%  \draw (G)   -- (C\i);
%\foreach\i in {1,...,5}
%  \draw[white border] (A5) -- (B\i);
\end{tikzpicture}
    \end{center}
    \caption{Complete lattices: left $\left(\ureal, \leq\right)$ and right $\left([S]\urexpr, \leq\right)$. Dashed: subdistributions; normal: distributions; thick: superdistributions.}
    \label{fig:ureal_complete_lattices}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The addition, subtraction, and multiplication operators for real numbers are lifted for $\ureal$. 
\begin{definition}[Bounded plus and minus]
    Provided both $x$ and $y$ are of type $\ureal$.
    $ $\isalink{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice.thy\#L95}
    \begin{align*}
       & x + y \defs \left(\umin\left(1, x^r + y^r\right)\right)^u \qquad 
       x - y \defs \left(\umax\left(0, x^r - y^r\right)\right)^u \qquad
       x * y \defs \left(x^r * y^r\right)^u 
    \end{align*}
\end{definition}
The addition $+$ and subtraction $-$ are bounded to $\ureal$ by using $\umin$ and $\umax$. For example, $0.5 + 0.7 = 1$ and $0.5 - 0.7 = 0$.

\subsection{The $\ureal$-valued functions}
\label{ssec:ureal_functions}
We now consider $\ureal$-valued functions and define several constant functions for real-valued and $\ureal$-valued. 
\begin{definition}[Real- and $\ureal$-valued constant functions]
    \label{def:urf_const}
    $ $ \isalink{https://github.com/RandallYe/probabilistic_programming_utp/blob/caff4fb2e69474d807aa066d718f1e19b1f4f01e/probability/probabilistic_relations/utp_prob_rel_lattice.thy\#L201}
    \begin{align*}
        & \rfzero \defs \lambda s @ 0 \qquad 
         \rfone \defs \lambda s @ 1 \qquad  
         \ufzero \defs \lambda s @ \uzero \qquad  
         \ufone \defs \lambda s @ \uone 
%        & \rfzero \defs \lambda s @ 0 \tag*{[Real-valued constant 0 function]} \label{def:rfzero} \\
%        & \rfone \defs \lambda s @ 1 \tag*{[Real-valued constant 1 function]} \label{def:rfone} \\
%        & \ufzero \defs \lambda s @ \uzero \tag*{[$\ureal$-valued constant 0 function]} \label{def:urfzero} \\
%        & \ufone \defs \lambda s @ \uone \tag*{[$\ureal$-valued constant 1 function]} \label{def:urfone} \\
    \end{align*}
\end{definition}
The $\rfzero$ and $\rfone$ are real-valued constant functions, and $\ufzero$ and $\ufone$ are $\ureal$-valued constant functions.

The addition and subtraction operators, and relations $\leq$ and $<$ are also lifted to functions in a pointwise manner.
\begin{definition}[Pointwise functions]
    \label{def:urf_pointwise}
    \begin{align*}
        & f - g \defs \left(\lambda x \bullet f(x) - g(x)\right) \qquad  
         f + g \defs \left(\lambda x \bullet f(x) + g(x)\right) \\
        & f \leq g \defs \left(\forall x \bullet f(x) \leq g(x)\right) \qquad 
         f < g \defs \left(\forall x \bullet f(x) < g(x)\right) 
%        & f - g \defs \left(\lambda x \bullet f(x) - g(x)\right) \tag*{[Pointwise minus]} \label{def:pointwise_minus} \\
%        & f + g \defs \left(\lambda x \bullet f(x) + g(x)\right) \tag*{[Pointwise plus]} \label{def:pointwise_plus} \\
%        & f \leq g \defs \left(\forall x \bullet f(x) \leq g(x)\right) \tag*{[Pointwise comparison]} \label{def:pointwise_leq} 
%        & f < g \defs \left(\forall x \bullet f(x) < g(x)\right) \tag*{[Pointwise strict comparison]} \label{def:pointwise_le} 
    \end{align*}
\end{definition}

We denote a function whose domain and range are of type $S$ and $\ureal$ as $[S]\urexpr$ ($\defs S \fun \ureal$). The complete lattice for $\ureal$-valued functions is formed.
\begin{thm}
    \label{thm:ureal_func_complete}
    % The poset $\left([S]\urexpr, \leq\right)$ is a complete lattice, with greatest element $\ufone$, and least element $\ufzero$, where $\ufzero$, $\ufone$, and the point-wise comparison operator $\leq$ on functions $f$ and $g$ are defined.
    The poset $\left([S]\urexpr, \leq\right)$ with the least element $\ufzero$, the greatest element $\ufone$, the infimum and supremum in a pointwise manner forms a complete lattice $\left([S]\urexpr, \leq, <, \ufzero, \ufone, \umin, \umax, \thnsup, \thninf\right)$. \isalink{https://isabelle.in.tum.de/library/HOL/HOL/Complete_Lattices.html}
\end{thm}

We illustrate an example of the complete lattice $\left([S]\urexpr, \leq\right)$ in the right diagram of Fig.~\ref{fig:ureal_complete_lattices}. Here we consider $S$ containing two elements and use $\langle \frac{1}{2}, \frac{1}{4}\rangle$ to denote probabilities over $S$: $\frac{1}{2}$ and $\frac{1}{4}$ respectively. Constant functions such as $\mathring{\frac{1}{2}}$ are on the central column. In the diagram, we only show a few functions where a dashed box, a normal box, or a thick box denotes a subdistribution, a distribution, or a superdistribution whose probabilities sum to less than or equal to 1, equal to 1, or larger than 1.

