
%% bare_conf.tex
%% V1.4b
%% 2015/08/26
%% by Michael Shell
%% See:
%% http://www.michaelshell.org/
%% for current contact information.
%%
%% This is a skeleton file demonstrating the use of IEEEtran.cls
%% (requires IEEEtran.cls version 1.8b or later) with an IEEE
%% conference paper.
%%
%% Support sites:
%% http://www.michaelshell.org/tex/ieeetran/
%% http://www.ctan.org/pkg/ieeetran
%% and
%% http://www.ieee.org/

%%*************************************************************************
%% Legal Notice:
%% This code is offered as-is without any warranty either expressed or
%% implied; without even the implied warranty of MERCHANTABILITY or
%% FITNESS FOR A PARTICULAR PURPOSE! 
%% User assumes all risk.
%% In no event shall the IEEE or any contributor to this code be liable for
%% any damages or losses, including, but not limited to, incidental,
%% consequential, or any other damages, resulting from the use or misuse
%% of any information contained here.
%%
%% All comments are the opinions of their respective authors and are not
%% necessarily endorsed by the IEEE.
%%
%% This work is distributed under the LaTeX Project Public License (LPPL)
%% ( http://www.latex-project.org/ ) version 1.3, and may be freely used,
%% distributed and modified. A copy of the LPPL, version 1.3, is included
%% in the base LaTeX documentation of all distributions of LaTeX released
%% 2003/12/01 or later.
%% Retain all contribution notices and credits.
%% ** Modified files should be clearly indicated as such, including  **
%% ** renaming them and changing author support contact information. **
%%*************************************************************************


% *** Authors should verify (and, if needed, correct) their LaTeX system  ***
% *** with the testflow diagnostic prior to trusting their LaTeX platform ***
% *** with production work. The IEEE's font choices and paper sizes can   ***
% *** trigger bugs that do not appear when using other class files.       ***                          ***
% The testflow support page is at:
% http://www.michaelshell.org/tex/testflow/



%\documentclass[journal]{IEEEtran}

\documentclass[12pt,draftclsnofoot,onecolumn]{IEEEtran}
% Some Computer Society conferences also require the compsoc mode option,
% but others use the standard conference format.
%
% If IEEEtran.cls has not been installed into the LaTeX system files,
% manually specify the path to it like:
% \documentclass[conference]{../sty/IEEEtran}





% Some very useful LaTeX packages include:
% (uncomment the ones you want to load)


% *** MISC UTILITY PACKAGES ***
%
%\usepackage{ifpdf}
% Heiko Oberdiek's ifpdf.sty is very useful if you need conditional
% compilation based on whether the output is pdf or dvi.
% usage:
% \ifpdf
%   % pdf code
% \else
%   % dvi code
% \fi
% The latest version of ifpdf.sty can be obtained from:
% http://www.ctan.org/pkg/ifpdf
% Also, note that IEEEtran.cls V1.7 and later provides a builtin
% \ifCLASSINFOpdf conditional that works the same way.
% When switching from latex to pdflatex and vice-versa, the compiler may
% have to be run twice to clear warning/error messages.
\usepackage{xcolor}
\usepackage{balance}
\usepackage{stfloats}
\usepackage{cite}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{acronym}
\usepackage{xcolor}
\usepackage{tikz} % for tikz
\usepackage[utf8]{inputenc}
\usepackage{pgfplots} 
\usepackage{pgfgantt}
\usepackage{pdflscape}
\usepackage{changes}
\usepackage{comment}
\usepackage{subfigure}
\usepackage{mathtools,algpseudocode,algorithm,MnSymbol}
\usepackage{geometry}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

%\usepackage{hyperref}
\geometry{top=1.93cm,left=1.4cm,right=1.4cm,bottom=4.2cm}
%\addtolength{\topmargin}{0.15 in}

\usepackage{pgfplots}
  \pgfplotsset{compat=newest}
  %% the following commands are needed for some matlab2tikz features
  \usetikzlibrary{plotmarks}
  \usetikzlibrary{arrows.meta}
  \usepgfplotslibrary{patchplots}
  \usepackage{grffile}
  \usepackage{amsmath}

\newcommand{\red}[1]{\textcolor{red}{\footnotesize{\textsf {#1}}}}
\newcommand{\Yu}[1]{\textcolor{magenta}{\footnotesize{\textsf {[Yu: #1]}}}}
\newcommand{\Hui}[1]{\textcolor{cyan}{\footnotesize{\textsf {[Hui: #1]}}}}
\pgfplotsset{compat=newest} 
\pgfplotsset{plot coordinates/math parser=false} % end of tikz

%\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
%    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}

\setlength{\marginparwidth }{2 cm}
\setlength{\columnsep}{0.21 in}
%\usepackage[font={footnotesize}]{caption}




% *** CITATION PACKAGES ***
%
%\usepackage{cite}
% cite.sty was written by Donald Arseneau
% V1.6 and later of IEEEtran pre-defines the format of the cite.sty package
% \cite{} output to follow that of the IEEE. Loading the cite package will
% result in citation numbers being automatically sorted and properly
% "compressed/ranged". e.g., [1], [9], [2], [7], [5], [6] without using
% cite.sty will become [1], [2], [5]--[7], [9] using cite.sty. cite.sty's
% \cite will automatically add leading space, if needed. Use cite.sty's
% noadjust option (cite.sty V3.8 and later) if you want to turn this off
% such as if a citation ever needs to be enclosed in parenthesis.
% cite.sty is already installed on most LaTeX systems. Be sure and use
% version 5.0 (2009-03-20) and later if using hyperref.sty.
% The latest version can be obtained at:
% http://www.ctan.org/pkg/cite
% The documentation is contained in the cite.sty file itself.












% *** MATH PACKAGES *** 
%
%\usepackage{amsmath}
% A popular package from the American Mathematical Society that provides
% many useful and powerful commands for dealing with mathematics.
%
% Note that the amsmath package sets \interdisplaylinepenalty to 10000
% thus preventing page breaks from occurring within multiline. Use:
%\interdisplaylinepenalty=2500
% after loading amsmath to restore such page breaks as IEEEtran.cls normally
% does. amsmath.sty is already installed on most LaTeX systems. The latest
% version and documentation can be obtained at:
% http://www.ctan.org/pkg/amsmath





% *** SPECIALIZED LIST PACKAGES ***
%
%\usepackage{algorithmic}
% algorithmic.sty was written by Peter Williams and Rogerio Brito.
% This package provides an algorithmic environment fo describing algorithms.
% You can use the algorithmic environment in-text or within a figure
% environment to provide for a floating algorithm. Do NOT use the algorithm
% floating environment provided by algorithm.sty (by the same authors) or
% algorithm2e.sty (by Christophe Fiorio) as the IEEE does not use dedicated
% algorithm float types and packages that provide these will not provide
% correct IEEE style captions. The latest version and documentation of
% algorithmic.sty can be obtained at:
% http://www.ctan.org/pkg/algorithms
% Also of interest may be the (relatively newer and more customizable)
% algorithmicx.sty package by Szasz Janos:
% http://www.ctan.org/pkg/algorithmicx




% *** ALIGNMENT PACKAGES ***
%
%\usepackage{array}
% Frank Mittelbach's and David Carlisle's array.sty patches and improves
% the standard LaTeX2e array and tabular environments to provide better
% appearance and additional user controls. As the default LaTeX2e table
% generation code is lacking to the point of almost being broken with
% respect to the quality of the end results, all users are strongly
% advised to use an enhanced (at the very least that provided by array.sty)
% set of table tools. array.sty is already installed on most systems. The
% latest version and documentation can be obtained at:
% http://www.ctan.org/pkg/array


% IEEEtran contains the IEEEeqnarray family of commands that can be used to
% generate multiline  as well as matrices, tables, etc., of high
% quality.







% *** FLOAT PACKAGES ***
%
%\usepackage{fixltx2e}
% fixltx2e, the successor to the earlier fix2col.sty, was written by
% Frank Mittelbach and David Carlisle. This package corrects a few problems
% in the LaTeX2e kernel, the most notable of which is that in current
% LaTeX2e releases, the ordering of single and double column floats is not
% guaranteed to be preserved. Thus, an unpatched LaTeX2e can allow a
% single column figure to be placed prior to an earlier double column
% figure.
% Be aware that LaTeX2e kernels dated 2015 and later have fixltx2e.sty's
% corrections already built into the system in which case a warning will
% be issued if an attempt is made to load fixltx2e.sty as it is no longer
% needed.
% The latest version and documentation can be found at:
% http://www.ctan.org/pkg/fixltx2e


%\usepackage{stfloats}
% stfloats.sty was written by Sigitas Tolusis. This package gives LaTeX2e
% the ability to do double column floats at the bottom of the page as well
% as the top. (e.g., "\begin{figure*}[!b]" is not normally possible in
% LaTeX2e). It also provides a command:
%\fnbelowfloat
% to enable the placement of footnotes below bottom floats (the standard
% LaTeX2e kernel puts them above bottom floats). This is an invasive package
% which rewrites many portions of the LaTeX2e float routines. It may not work
% with other packages that modify the LaTeX2e float routines. The latest
% version and documentation can be obtained at:
% http://www.ctan.org/pkg/stfloats
% Do not use the stfloats baselinefloat ability as the IEEE does not allow
% \baselineskip to stretch. Authors submitting work to the IEEE should note
% that the IEEE rarely uses double column  and that authors should try
% to avoid such use. Do not be tempted to use the cuted.sty or midfloat.sty
% packages (also by Sigitas Tolusis) as the IEEE does not format its papers in
% such ways.
% Do not attempt to use stfloats with fixltx2e as they are incompatible.
% Instead, use Morten Hogholm'a dblfloatfix which combines the features
% of both fixltx2e and stfloats:
%
% \usepackage{dblfloatfix}
% The latest version can be found at:
% http://www.ctan.org/pkg/dblfloatfix




% *** PDF, URL AND HYPERLINK PACKAGES ***
%
%\usepackage{url}
% url.sty was written by Donald Arseneau. It provides better support for
% handling and breaking URLs. url.sty is already installed on most LaTeX
% systems. The latest version and documentation can be obtained at:
% http://www.ctan.org/pkg/url
% Basically, \url{my_url_here}.




% *** Do not adjust lengths that control margins, column widths, etc. ***
% *** Do not use packages that alter fonts (such as pslatex).         ***
% There should be no need to do such things with IEEEtran.cls V1.6 and later.
% (Unless specifically asked to do so by the journal or conference you plan
% to submit to, of course. )

\newcommand{\HW}[1]{\textcolor{red}{\footnotesize{\textsf {[Henk: #1]}}}}
\newcommand{\FJ}[1]{\textcolor{blue}{\footnotesize{\textsf {[Fan: #1]}}}}
\newcommand{\PH}[1]{\textcolor{cyan}{\footnotesize{\textsf {[Peter: #1]}}}}

% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}

\newtheorem{rem}{Remark}

\input{acronyms.tex} 


\begin{document}

\bibliographystyle{IEEEtran}
\bstctlcite{IEEEexample:BSTcontrol}
%
% paper title
% Titles are generally capitalized except for words such as a, an, and, as,
% at, but, by, for, in, nor, of, on, or, the, to and up, which are usually
% not capitalized unless they are the first or last word of the title.
% Linebreaks \\ can be used within to get better formatting as desired.
% Do not put math or special symbols in the title.
%\title{An End-to-end 5G SLAM Framework with a Low-complexity Channel Estimator}
\title{Experimental Validation of Single BS 5G mmWave Positioning and Mapping for Intelligent Transport}


% author names and affiliations
% use a multiple column layout for up to three different
% affiliations
\author{Yu Ge,~\IEEEmembership{Student~Member,~IEEE,} Hedieh Khosravi,~\IEEEmembership{Student~Member,~IEEE,} \\ Fan Jiang,~\IEEEmembership{Member,~IEEE,} Hui Chen,~\IEEEmembership{Member,~IEEE,} Simon Lindberg, Peter Hammarberg,  Hyowon Kim,~\IEEEmembership{Member,~IEEE,} Oliver Brunneg\aa rd,
 Olof Eriksson,  
Bengt-Erik Olsson, 
\\Fredrik Tufvesson,~\IEEEmembership{Fellow,~IEEE,} 
Lennart Svensson,~\IEEEmembership{Senior~Member,~IEEE,}     \\ 
Henk Wymeersch,~\IEEEmembership{Senior~Member,~IEEE}
\thanks{Yu Ge, Fan Jiang, Hui Chen, Hyowon Kim, Lennart Svensson and Henk Wymeersch are with the Department of Electrical Engineering, Chalmers University of Technology, Gothenburg, Sweden. Emails: 
\{yuge, fan.jiang, hui.chen, hyowon, lennart.svensson, henkw\}@chalmers.se.}
\thanks{Hedieh Khosravi and Fredrik Tufvesson are with the Department of Electrical and Information Technology, Lund University, Lund, Sweden. Emails: \{hedieh.khosravi,fredrik.tufvesson\}@eit.lth.se.}
\thanks{Simon Lindberg is with Qamcom, Gothenburg, Sweden. Email: simon.lindberg@qamcom.se.}
\thanks{Peter Hammarberg and Bengt-Erik Olsson are with Ericsson Research, Gothenburg, Sweden. Email: \{peter.hammarberg, bengt-erik.olsson\}@ericsson.com.}
\thanks{Oliver Brunneg\aa rd and Olof Eriksson are with Veoneer, V\aa rg\aa rda, Sweden. Email: \{oliver.brunnegard, olof.eriksson\}@veoneer.com.}
\thanks{This work was partially supported by the Vinnova 5GPOS project under grant 2019-03085, by the Swedish Research Council under grant 2018-03705, and by the Wallenberg AI, Autonomous Systems and Software Program (WASP) funded by Knut and Alice Wallenberg Foundation.}
}
% conference papers do not typically use \thanks and this command
% is locked out in conference mode. If really needed, such as for
% the acknowledgment of grants, issue a \IEEEoverridecommandlockouts
% after \documentclass



% use for special paper notices
%\IEEEspecialpapernotice{(Invited Paper)}




% make the title area
\maketitle
\pagestyle{empty}
\thispagestyle{empty}
% As a general rule, do not put math, special symbols or citations
% in the abstract
\begin{abstract}
Positioning with 5G signals generally requires connection to several \acp{bs}, which makes positioning more demanding in terms of infrastructure than communications. To address this issue, there have been several theoretical studies on single \ac{bs} positioning, leveraging high-resolution angle and delay estimation and multipath exploitation possibilities at mmWave frequencies. This paper presents the first realistic experimental validation of such studies, involving a commercial 5G mmWave \ac{bs} and a \ac{ue} development kit mounted on  a test vehicle. We present the relevant signal models, signal processing methods (including channel parameter estimation and position estimation), and validate these based on real data collected in an outdoor science park environment. Our results indicate that  positioning is possible, but 
the performance with a single \ac{bs} is limited by the knowledge of the position and orientation of the infrastructure and the multipath visibility and diversity. 
\end{abstract}

\vskip0.5\baselineskip
\begin{IEEEkeywords}
 Experimental validation, 5G mmWave, single BS positioning and mapping, intelligent transportation.
\end{IEEEkeywords}





% For peer review papers, you can put extra information on the cover
% page as needed:
% \ifCLASSOPTIONpeerreview
% \begin{center} \bfseries EDICS Category: 3-BBND \end{center}
% \fi
%
% For peerreview papers, this IEEEtran command inserts a page break and
% creates the second title. It will be ignored for other modes.
% \IEEEpeerreviewmaketitle

%This paper will mainly focus on technical details of the component of the systems and the algorithms to realize positioning and mapping.

%Target journal: IEEE Journal on Selected Areas in Communications (5G/6G Precise Positioning on Cooperative Intelligent Transportation Systems (C-ITS) and Connected Automated Vehicles (CAV))

%Deadline: December 1st

\section{Introduction}
%1.5 pages
\acresetall

5G and Beyond 5G communication systems are expected to play an important role in intelligent transportation \cite{bartoletti2021positioning}, complementing on-board sensors such as radar, lidar, and \ac{gnss}, by providing an absolute position estimate, even in harsh urban and indoor environments. 
To realize 5G/B5G positioning, standardization efforts in 3GPP and ETSI as well as different means of technical enhancements are provided to support a variety of commercial use cases with different performance requirements~\cite{tr:38845-3gpp21,tr:38859-3gpp22}.
%Standardization efforts in 3GPP and ETSI focus on supporting a variety of commercial use cases with different positioning performance requirements \cite{tr:38845-3gpp21}, by means of technical enhancements \cite{tr:38859-3gpp22}. 
The main technical enabler for accurate positioning in 5G is the ability to operate at mmWave frequencies above 24 GHz, which brings a number of concrete benefits \cite{wymeersch20175g,dwivedi2021positioning,tr:38855-3gpp19}. First of all, large bandwidths in the order of 400 MHz are available at mmWave, providing high delay resolution. Second, within a fixed footprint, more  antenna elements can be deployed in mmWave compared to sub-6 GHz, at both \ac{bs} and \ac{ue} sides. This provides high angular resolution and the possibility of \ac{ue} orientation estimation. Third, the propagation channel at mmWave tends to be more geometric and less random than at sub-6 GHz carriers, making practical and scalable model-based positioning algorithms 
possible. %, where machine learning methods provide reasonable positioning performance  \cite{butt2020rf}.



An important limitation of 5G mmWave positioning is the high demand in terms of infrastructure. 5G mmWave communication links typically provide coverage of no more than a few hundred meters, which is further compounded by the fact that conventional \ac{TDOA} positioning  requires simultaneous connections to at least four synchronized \acp{bs} \cite{keating2019overview} and typically many more for specific scenarios like highways \cite{del2016feasibility}. Multi-\ac{bs} solutions also require optimized deployments \cite{posluk20215g} and accurate calibration processes to obtain anchor positions. 

To reduce the infrastructure and deployment cost, the community has made a concerted effort to devise alternative approaches whereby 3D positioning of a \ac{ue} can be accomplished with a single \ac{bs}. These can be characterized in roughly four categories: (i) single-\ac{bs} positioning using \ac{rtt} and \ac{AOD} (in downlink) or \ac{AOA} (in uplink) \cite{guo2022performance,blanco2019performance,kanhere2018position}; (ii) single-\ac{bs} positioning using information fusion \cite{mostafavi2019vehicular,mostafavi2020vehicular} (e.g., from external sensors); (iii) single-\ac{bs} positioning using \acp{RIS} \cite{Henk_RISSLAM_VTM2020,zhang2022toward,fascista2021ris,keykhosravi2021siso}; (iv) single-\ac{bs} positioning based on passive multipath information \cite{witrisal2016high,Shahmansoori18,wen20195g,NLOSforPositionOrientationEstimation--R.Mendrzik_H.Wymeersch_G.Bauch,ge2022computationally,ge2022mmwave,sun2021comparative,wymeersch20185g,liu2017prospective}. 
In particular, turning multipath from foe to friend in (iv) is attractive, as it comes at no cost in terms of time-frequency resources (in contrast to approach (i)), it does not require external sensors to provide a position fix (in contrast to approach (ii)), and it does not require additional infrastructure (in contrast to approach (iii)). 

\begin{figure}
    \centering
\includegraphics[width=0.6\columnwidth]{Figures_without_ESPRIT/Overview1.jpg}
    \caption{Exemplifying scenario of single-BS positioning, harnessing delay, \ac{AOD}, and \ac{AOA} information from the \acf{los} and resolved \acf{nlos} paths. } \vspace{-5mm}
    \label{fig:overview}
\end{figure}

Despite significant theoretical progress, only a limited subset of the above approaches has been shown to operate in practice \cite{yammine2021experimental,mata2020preliminary,witrisal2016high,ge2022experimental}. 
In \cite{yammine2021experimental}, a 5G FR2 experimental setup for indoor positioning based on \ac{TOA} was demonstrated, and an analysis of the impact of beam pairing was conducted. In \cite{mata2020preliminary}, results on indoor and outdoor trials in 5G FR1 were reported, yielding ranging errors from sub-meter indoors to several hundreds of meters outdoors, indicating that 5G measurements should be integrated with other sensors (e.g., \ac{gnss}) to meet requirements for \ac{AD}
 and \ac{ADAS} applications. A demonstration of combined \ac{TOA} and \ac{AOA} LTE positioning was demonstrated in \cite{blanco2019performance}, while \cite{kanhere2018position} evaluated the combination of  \ac{RSS} and \ac{AOA} in 5G mmWave. 
The concept of multipath exploitation was validated in \cite{witrisal2016high} for an indoor scenario following the IEEE 802.11ad standard (with 63 GHz carrier and 2 GHz bandwidth). 
Apart from our preliminary results \cite{ge2022experimental} on  \ac{bs} calibration, there have been no reported demonstrations of 5G mmWave vehicular positioning using commercial devices. 
 
 







%3GPP \cite{ts:38211-3gpp20,tr:38855-3gpp19}.

%Fusion paper possibility of single \ac{bs} positioning \cite{ge2022experimental}.

%Single Base Station ToA-AoA Positioning in an LTE Testbed \cite{blanco2019performance}, even though it is not 5G, it is radio and also has experiments.

%A magazine \cite{liu2017prospective}.



%5G ranging measurements fuse with GNSS, has experiments\cite{yin2018gnss,wang2022simulation}


%This also might be useful \cite{kanhere2018position}


%Studies reporting experimental validation of 5G mmWave positioning have been limited \cite{yammine2021experimental,mata2020preliminary,ge2022experimental}, and most existing works rely on simulations \cite{dwivedi2021positioning,keating2019overview}.

In this paper, we present the results of a unique demonstration of single BS 5G mmWave positioning of a vehicle using commercial hardware and a real vehicle. Our demonstration sheds new light on the capabilities of 5G to support intelligent transportation applications as well as several limitations that should be addressed in future standards. The main contributions are summarized as follows. 
 \begin{itemize}
        \item \textbf{Single-BS positioning system overview:} We introduce the hardware specification for the 5G single base-station positioning system, including the commercial \ac{bs}, the \ac{ue}, the ground-truth system, and the outdoor operating environment. Particular emphasis is placed on the UE device mounting, UE and BS array configurations, and utilized beam patterns. %We introduce the hardware specification for the 5G single base-station positioning systems, including the commercial BS, the \ac{ue}, and the ground-truth system.
        \item \textbf{End-to-end signal processing description:} We provide technical algorithms for processing the 5G mmWave measurements for positioning purposes, including channel parameter estimation, BS calibration, and positioning and mapping algorithms.  In particular, we provide low-complexity algorithms for single-BS \ac{los}-only positioning using RTT and AOD, as well as mixed LOS and \ac{nlos} positioning with multipath exploitation. Moreover, a simple environment mapping algorithm is presented, given the estimated UE position.%We provide technical algorithms for processing the real 5G measurements for positioning purposes, including channel estimation, BS calibration, and positioning and mapping algorithms.
        \item \textbf{Performance evaluation with real data:} We show positioning and mapping results using real 5G measurements and analyze the performance gap via different combinations of real and simulated measurements. We found that the combination of RTT, AOD and AOA provides around 1.71 m positioning accuracy (90\% of cases), but can be further improved with super-resolution methods. Positioning with multipath aiding and \ac{TDOA} turns out to be severely limited by the propagation environment and yielded errors in excess of 10 meters. Correspondingly, mapping performance is shown to be much better when RTT is available.
        %\item \textbf{LOS and mixed LOS \& NLOS positioning and mapping:}  We provide algorithms for single-BS LOS-only positioning using RTT and AOD, as well as mixed LOS and NLOS positioning with multipath exploitation. 
        %\item \textbf{Performance evaluation with real data:} We show positioning and mapping results using real 5G measurements and analyze the performance gap via different combinations of real and simulated measurements. %, and provide outlook for future, using generated map (if necessary), different levels of clock bias noise, different channel estimation.
    \end{itemize}
%\begin{itemize}
%\item What, and why it is important, its benefits

%\item Background, 5G provides new opportunities

%\item Literature reviews on previous works, pros \& cons 

%\item Challenges

%\item Contributions
%    \begin{itemize}
 %       \item Introduce the hardware details about the 5G single base-station positioning (potential mapping) systems, including BS, user, GPS;
  %      \item Provide necessary technical algorithms on processing the real 5G measurements to achieve positioning purpose, including channel estimation, BS calibration, and MAP estimator using only LOS for positioning;
   %     \item Provide algorithms on utilizing NLOS and real-time positioning (SLAM), including offline LOS + NLOS positioning and mapping, and SLAM filter;
    %    \item Show positioning and mapping using real 5G measurement;
     %   \item Analyze the performance gap via using different combination of real measurements and simulated measurement, and provide outlook for future, using generated map (if necessary), different levels of clock bias noise, different channel estimation.
    %\end{itemize}


%\end{itemize}

The remainder of this paper is structured as follows. The system models are described in Section \ref{models}. The system components are then introduced in Section \ref{sec:Components}. The channel estimation, %are displayed in Section \ref{Section:channel_estimation}, and
positioning and mapping algorithms are derived in Section \ref{sec:localization_mapping}. Tests and results are presented in Section \ref{results}, followed by our conclusions in Section \ref{Conclusions}.


\subsubsection*{Notations}Scalars (e.g., $x$) are denoted in italic, vectors (e.g., $\boldsymbol{x}$) are denoted in bold lower-case letters, and matrices (e.g., $\boldsymbol{X}$) are denoted in bold capital letters. The transpose is denoted by $(\cdot)^{\mathsf{T}}$, the Hermitian transpose is denoted by $(\cdot)^{\mathsf{H}}$, the conjugate is denoted by $(\cdot)^{*}$, the Euclidean norm is denoted by $\lVert \cdot \rVert$, the $n$-th component of a vector is denoted by $[\cdot]_{n}$, while $[\cdot]_{n:n'}$ extracts components $n$ until $n'>n$, 
a Gaussian distribution with mean $\boldsymbol{u}$ and covariance $\boldsymbol{\Sigma}$, evaluated in value $\boldsymbol{x}$, is denoted by $\mathcal{N}(\boldsymbol{x};\boldsymbol{u},\boldsymbol{\Sigma})$.



\section{System models}\label{models}
%{1.5 pages}
In this section, we introduce the state models of the \ac{ue}, \ac{bs} and landmark in a typical 5G mmWave downlink scenario, where a single \ac{ue} mounted on a vehicle, a single \ac{bs} mounted on a tower,  and a few others landmarks, e.g., buildings or walls, are included. Moreover, the received signal model and the measurement model are also provided.

\subsection{State Models}
We use the global reference coordinate system as the reference in this paper.
The \ac{bs} is fixed and equipped with a \ac{URA}, where its center is located at $\boldsymbol{p}_\text{BS} = [x_{\text{BS}}, y_{\text{BS}}, z_{\text{BS}}]^{\mathsf{T}}$. It has a rotation of $\boldsymbol{\psi}_{\text{BS}}=[\alpha_\text{BS}, \beta_\text{BS}, \gamma_\text{BS}]^{\mathsf{T}}$, denoting the roll, pitch and yaw in the respective order, 
which describes the orientation of the transmitter \ac{URA} with respect to the reference coordinate system \cite{blanco2010tutorial}.
%which describes the direction of the transmitter \ac{URA} and shows how to rotate the reference coordinate system to the local coordinate system of the transmitter \ac{URA} \cite{blanco2010tutorial}.
Therefore, the state of the \ac{bs} can be modeled as $\boldsymbol{s}_\text{BS}=[\boldsymbol{p}_{\text{BS}}^{\mathsf{T}}, \boldsymbol{\psi}_{\text{BS}}^{\mathsf{T}}]^{\mathsf{T}}$, which is usually known a priori. 


The \ac{ue} moves on the ground over time. It is also equipped with an \ac{URA}, and has the state $\boldsymbol{s}_{\text{UE},k}=[\boldsymbol{p}_{\text{UE},k}^{\mathsf{T}}, \boldsymbol{\psi}_{\text{UE},k}^{\mathsf{T}},b_{k}]^{\mathsf{T}}$ at time $k$, with
$\boldsymbol{p}_{\text{UE},k}=[x_{\text{UE},k}, y_{\text{UE},k},z_{\text{UE},k}]^{\mathsf{T}}$ denoting the position of the center of the \ac{URA} at the receiver side, $\boldsymbol{\psi}_{\text{UE},k}=[\alpha_{\text{UE},k}, \beta_{\text{UE},k}, \gamma_{\text{UE},k}]^{\mathsf{T}}$ representing the direction of the receiver, and $b_{k}$ denoting the clock bias caused by the imperfect synchronization between the transmitter and the receiver. 

Apart from the \ac{bs}, there are a few other landmarks in the scenario, like buildings and walls, and their facades can reflect and/or diffuse downlink signals to the receiver, which results in \ac{nlos} paths. Therefore, we describe the environment with some effective surfaces and parameterize the point where the signal hit the effective surface as an \ac{IP} with location $\boldsymbol{p}_{\mathrm{IP}}$. \acp{IP} of those \ac{nlos} paths which are reflected or diffused by the same source are on the same surface by definition, so that \acp{IP} reveal where surfaces exist.  %and we can estimate surfaces from \acp{IP}.

 


%Apart from the \ac{bs}, there a few other landmarks in the scenario, like some buildings or walls, and their facades can reflect or/and diffuse downlink signals to the receiver. Therefore, we describe the environment with some effective surfaces. Each effective surface can be parameterized by a fixed \ac{VA} with location $\boldsymbol{p}_{\mathrm{VA}}$, which is the reflection of the  \ac{bs} with respect to the effective surface{\cite{Rappaport_6G100GHz_Access2019,palacios2019single}}
% kim20205g}:
%\begin{align}
    %\boldsymbol{p}_{\mathrm{VA}}=(\boldsymbol{I}-2\boldsymbol{\nu}\boldsymbol{\nu}^{\mathsf{T}}) \boldsymbol{p}_{\mathrm{BS}}+2\boldsymbol{\mu}^{\mathsf{T}}\boldsymbol{\nu} \boldsymbol{\nu},\label{VA}
%\end{align}
%where $\boldsymbol{\nu}$ is the normal to the reflecting surface and $\boldsymbol{\mu}$ is an arbitrary point on the surface. From \eqref{VA}, we could obverse that the \ac{VA} does not depend on the \ac{ue} state, so that although the \acp{IP} where the signals hit the surface change with \ac{ue} moving around, the VA remains static. Moreover, the \ac{VA} is surface-specific, and when the \ac{VA} is given, the surface can be determined.

\subsection{Signal Model}
%\begin{itemize}
%    \item Received OFDM signal model (measurements as close as)
%    \item Angles (in their own coordinate system) and Delays
 %   \item 4*100MHz
%\end{itemize}
The \ac{bs} sends \ac{OFDM} downlink signals to the receiver with a period of $\Delta$ seconds, which can arrive at the receiver directly, termed as the \ac{los} path, or reflected or diffused by the surfaces then reach the receiver, termed as \ac{nlos} paths, or via both \ac{los} and \ac{nlos} paths. When considering the transmissions of $N_{\text{OFDM}}$ \ac{OFDM} symbols with $S$ subcarriers, we can express the received signal for the $g$-th \ac{OFDM} symbol at time $k$ and the $\kappa$-th subcarrier as \cite{heath2016overview} 
\begin{align}
    {y}_{\kappa,g,k}&= \boldsymbol{w}_{\text{UE},g,k}^{\mathsf{H}} \underset{\boldsymbol{H}_{\kappa,k}} {\underbrace{\sum _{i=1}^{I_{k}}\rho_{k}^{i}\boldsymbol{a}_{\text{R}}(\boldsymbol{\theta}_{k}^{i})\boldsymbol{a}_{\text{T}}^{\mathsf{H}}(\boldsymbol{\phi}_{k}^{i})e^{-\jmath 2\pi \kappa \Delta_f \tau_{k}^{i}}}}  \boldsymbol{f}_{\text{BS},g,k} p_{\kappa,g} +  \boldsymbol{w}_{\text{UE},g,k}^{\mathsf{H}} \boldsymbol{n}_{\kappa,g,k},\label{eq:FreqObservation} 
\end{align}
where $p_{\kappa,g}$ denotes the pilot signal, $\boldsymbol{f}_{\text{BS},g,k}$ denotes the precoder at the transmitter,  $\boldsymbol{w}_{\text{UE},g,k}$ denotes the combiner at the receiver,
$\boldsymbol{H}_{\kappa,k}$ denotes the channel matrix, $\boldsymbol{a}_{\text{T}}(\cdot)$ denotes the steering vector at the transmitter side, $\boldsymbol{a}_{\text{R}}(\cdot)$ denotes the steering vector at the receiver side, $\Delta_f$ denotes the subcarrier spacing, and $\boldsymbol{n}_{\kappa,g,k}$ denotes white Gaussian noise across the receiver antenna arrays. In the propagation channel, there are $I_{k}$ paths in total, including both \ac{los} ($i=1$) and \ac{nlos} ($i>1$) paths, and each path can be described by a complex channel gain $\rho_{k}^{i}$, a \ac{TOA} $\tau_{k}^{i}$, an \ac{AOA} pair $\boldsymbol{\theta}_{k}^{i}=[\theta_{\text{az},k}^{i},\theta_{\text{el},k}^{i}]^{\mathsf{T}}$ in azimuth and elevation, and an \ac{AOD} pair $\boldsymbol{\phi}_{k}^{i}=[\phi_{\text{az},k}^{i},\phi_{\text{el},k}^{i}]^{\mathsf{T}}$ in azimuth and elevation. These channel parameters can be determined by the geometric relationships among the \ac{ue}, \ac{bs} and the \ac{IP} of the path if exists. It is important to note that $I_{k}$ is usually different from the number of visible landmarks, as a surface could generate more than one path.

\subsection{Measurement Model}
Given the received downlink signals ${y}_{\kappa,g,k}$, the channel estimator (introduced later in Section \ref{Section:channel_estimation}) can provide estimates of the channel parameters, i.e., \ac{TOA}, \ac{AOD}, \ac{AOA}, as measurements. However, all $I_{k}$ paths usually cannot have their corresponding measurements, due to limited resolution and imperfections of the channel estimator.
If we assume the $i$-th path has its corresponding measurement $\boldsymbol{z}_k^{i}$ and the measurement noise is a zero-mean Gaussian, $\boldsymbol{z}_k^{i}$  follows 
\begin{equation}\label{measurment_model}
    \boldsymbol{z}_k^{i} = 
    \boldsymbol{h}(\boldsymbol{s}_{k},\boldsymbol{s}_{\text{BS}},\boldsymbol{p}_{\text{IP},k}^{i} ) + \boldsymbol{r}_{k}^{i},
\end{equation} 
where $\boldsymbol{p}_{\text{IP},k}^{i}$ is its \ac{IP}, $\boldsymbol{r}_{k}^{i}\sim \mathcal{N}\left(\boldsymbol{0},\boldsymbol{R}_{k}^{i}\right)$ is the measurement noise, and $\boldsymbol{h}(\boldsymbol{s}_{k},\boldsymbol{s}_{\text{BS}},\boldsymbol{p}_{\text{IP},k}^{i} )= [{\tau}_{k}^{i},({\boldsymbol{\theta}}_{k}^{i})^{\mathsf{T}},({\boldsymbol{\phi}}^{i}_{k})^{\mathsf{T}}]^{\mathsf{T}}$ is the measurement function, representing the geometric relations among the \ac{ue}, \ac{bs} and the \ac{IP}, which is defined in Appendix \ref{GeometricRelationships}. Thus, we have \begin{align}
f(\boldsymbol{z}_{k}^{i}|\boldsymbol{p}_{\text{IP},k}^{i},\boldsymbol{s}_{k})=\mathcal{N}(\boldsymbol{z}_{k}^{i};\boldsymbol{h}(\boldsymbol{s}_{k},\boldsymbol{s}_{\text{BS}},\boldsymbol{p}_{\text{IP},k}^{i} ),\mathbf{R}_k^i) \label{likelihood}.
\end{align}
In principle, $\boldsymbol{p}_{\text{IP},k}^{i}$ does not exist, if it is a \ac{los} path, i.e., $i=1$. However, we still use $\boldsymbol{h}(\boldsymbol{s}_{k},\boldsymbol{s}_{\text{BS}},\boldsymbol{p}_{\text{IP},k}^{i} )$ for both \ac{los} and \ac{nlos} cases, to make the representation consistent.






\section{System Components}
\label{sec:Components}

The deployed 5G mmWave positioning system consists of a transmitter antenna array system at the \ac{bs} side and a receiver antenna array system at the \ac{ue} side operated at 27.2 GHz. 
The \ac{bs} broadcasts known reference signals to the \ac{ue}, which performs channel estimation, positioning, and mapping calculations.
Additionally, the \ac{ue} is equipped with a high-accuracy \ac{gnss} receiver, which provides the position and orientation of the \ac{ue} at any given time to be used as ground truth.
In this section, details about the system components are described.

\subsection{BS Description}
%\begin{itemize}
%    \item 1-1.5 column, 2-3 figures
%    \item BS Description
%    \item Antenna array
%    \item Deployment uncertainties in position and orientation
%    \item transmit signal
%    \item beam pattern (let Ericsson decide, we don't have, only can have public, like URA structure )
%    \item PRS
%\end{itemize}
% Placeholder text from FUSION paper. To be revised! [Peter]

%\PH{I note that we have not mentioned the carrier frequency. Should we do that in the BS section or will we tabulate any parameters including Fc?}

The \ac{bs} consists of a tower-mounted Antenna Integrated Radio unit for mmWave 5G NR (Ericsson AIR 5322), referred to as an \ac{AAS}, connected to a baseband unit located in a remote building. 
The baseband unit is responsible for controlling the reference signal generation, scheduling and mapping the signal to the radio resources, as well as controlling which beam to be used for the transmission at the \ac{AAS}.  
Central to the operation of the positioning system are the spatial properties of the beams at the output of the \ac{AAS}, as well as the properties of the transmitted reference signals, which are described below. 

\begin{figure}
    \centering
    \includegraphics[width=0.6\linewidth]{5GPOS_DJI_0044_mod.jpg}
    \caption{The tower \ac{bs} site, with three Ericsson AIR 5322 Antenna Integrated
Radio unit mounted to cover the surroundings. The unit facing the parking area was the one used during the experiments.}
    \label{fig:mounted_platform}
\end{figure}

\subsubsection{Antenna System Description}
%TODO: VERIFY IF WE WERE RUNNING WITH SPLIT ARRAY, IE 8x24 ANTENNAS
The \ac{AAS} is equipped with a phased array antenna module with a total of $16\times24$ dual-polarized antenna elements. 
Analog beamforming is implemented, creating a set of $4\times34$ (elevation $\times$ azimuth) available beams. 
The coverage area of the beam set is approximate $\pm~60^{\circ}$ in azimuth and $\pm~15^{\circ}$ in elevation, as illustrated in Fig.~\ref{fig:BSbeams}.
The characteristics of the individual beams show some variation depending on direction. However, the 3 dB beamwidth of the center beam is approximately $4.1^{\circ}$ in azimuth and $10.4^{\circ}$ in elevation.
%, and the aggregated beamwidth is approximate $\pm~60^{\circ}$ in azimuth and $\pm~15^{\circ}$ in elevation, as illustrated in Fig.~\ref{fig:BSbeams}.%and in the configuration used in the demo the \ac{AAS} can produce $4\times34$ beams. 
 In the custom-built beam-controlling software, all 136 beams are activated sequentially, with each beam being repeated over multiple \ac{OFDM} symbols, sweeping all beams with a periodicity of $40~\text{ms}$. 

For communication purposes, detailed information on the individual beam patterns is generally not required. 
Instead, information allowing for cell planning for data communication is available.
That is, $\boldsymbol{a}_{\text{T}}^{\mathsf{T}}(\boldsymbol{\phi}_{k}^{i}) \boldsymbol{f}_{\text{BS},g,k}$ is only known approximately (see Fig.~\ref{fig:BSbeams}), which may preclude the use of super-resolution methods for channel estimation. 
For the work presented in this paper, any detailed characterization of the produced beams has not been performed. Instead, we rely on the beam properties designed and obtained through simulations which, in general, show good correspondence. 
%However, it may not be the case for high accuracy positioning exploiting
%angular information of the incoming radio wave, which is derived using beam directions and underlying beam
%shape. In particular, for communication $\boldsymbol{a}_{\text{T}}^{\mathsf{T}}(\boldsymbol{\phi}_{k}^{i}) \boldsymbol{w}_{\text{BS},g,k}$ is only known approximately (see Fig.~\ref{fig:BSbeams}), while neither $\boldsymbol{a}_{\text{T}}(\boldsymbol{\phi}_{k}^{i})$ or $\boldsymbol{w}_{\text{BS},g,k}$ are characterized precisely, precluding the use of super-resolution methods. Hence, any characterization of the deployed \ac{AAS} and the produced beams have not been performed, instead we rely on the beam properties designed and obtained through simulations which in general show a good correspondence.   

\subsubsection{Reference Signal Description}\label{Sec_Sys_Ref}
To allow channel estimation at the \ac{ue}, the \ac{CSI-RS} is transmitted. 
The \ac{CSI-RS} is implemented according to the 3GPP NR 5G standard \cite{ts:38211-3gpp20}, configured to produce a pseudorandom sequence and mapped to QPSK symbols which are transmitted on every fourth subcarrier. The \ac{CSI-RS} is transmitted on each of the four phase-locked component carriers, producing a total bandwidth of $4\times100$ MHz. With 120 kHz subcarrier spacing and the standardized guard band between carriers, a total of $4\times198$ subcarriers are available for channel estimation.   
Additionally, to allow the \ac{ue} to perform time and frequency synchronization towards the \ac{bs}, \ac{SSB} \cite{ts:38211-3gpp20} is transmitted on dedicated beams at the beginning of the beam sweep. The \ac{SSB} contains synchronization signals and system information, which enable a \ac{ue} to perform synchronization and perform random access procedures for network connection.

\begin{figure}
    \centering
    \includegraphics[width=0.7\linewidth]{Ericsson_Beams.png}
    \caption{Horizontal and vertical cuts of the \ac{bs} beam pattern envelope.}
    \label{fig:BSbeams}
    \vspace{-4mm}
\end{figure}

\subsubsection{Deployment} \label{Sec_deploy}
The \ac{AAS} used in the experiment is part of a three-sector site, as seen in Fig.~\ref{fig:mounted_platform}, targeting omni-directional communication coverage. The two AASs not part of the experiment are configured to operate in a different frequency band. The site is situated at the top of a radio tower approximately $21~\mathrm{m}$  above the ground, with the \ac{AAS} mounted in a northbound direction overlooking a rooftop and a larger parking area surrounded by buildings. The AAS is down-tilted by $12^{\circ}$ to form the coverage area. Along with the coordinates of the base of the tower, it is possible to form the BS state $\boldsymbol{s}_\text{BS}$ vector. 
Even though the state values could be surveyed to arbitrary accuracy in theory, errors are inevitable in practice. 
% Even though the state values could, in theory, be surveyed to arbitrary accuracy, errors are, in practice, inevitable. 
Using sites that are intended to be used for communication, rather than accurate positioning, only coarse state information may be available. 
This is true for the deployment used in this experiment, where explicit surveying of the site has not been performed, and instead, over-the-air parameter estimation or calibration is performed as discussed in Section \ref{sec:bs_cal}.


%\subsubsection{Uncertainties and Impact for Positioning}
%\PH{I propose we shorten this section and move the discussion to the BS calibration section in V. Potentially, we could add some details on the deployment here.}
%There are a number of uncertainties that have an impact
%on the accuracy of the channel parameter estimation. They
%relate both to the \ac{AAS} and its
%deployment. From the \ac{AAS} perspective, each
%device experiences small individual variations naturally occurring in the 
% production and calibration process. These small variations have an impact on
%the properties of the beam shape produced by the \ac{AAS}.
%From the wireless communication perspective, these variations
%have an insignificant impact on the system performance and regulatory requirements. 
%However, it may not be the case for high accuracy positioning exploiting
%angular information of the incoming radio wave, which is derived using beam directions and underlying beam
%shape. In particular, for communication $\boldsymbol{a}_{\text{T}}^{\mathsf{T}}(\boldsymbol{\phi}_{k}^{i}) \boldsymbol{w}_{\text{BS},g,k}$ is only known approximately (see Fig.~\ref{fig:BSbeams}), while neither $\boldsymbol{a}_{\text{T}}(\boldsymbol{\phi}_{k}^{i})$ or $\boldsymbol{w}_{\text{BS},g,k}$ are characterized precisely, precluding the use of super-resolution methods. Hence, any characterization of the deployed \ac{AAS} and the produced beams have not been performed, instead we rely on the beam properties designed and obtained through simulations which in general show a good correspondence.   


%Being off by a degree in estimated \ac{AOA} can induce
%positioning errors in the order of meters in worse case.
%From the deployment perspective, not knowing the exact position of the \ac{bs} can induce large positioning errors. When exploiting angular information for positioning, both the coordinate and the orientation of the \ac{AAS} need to be known. 
%
%For cell planning, communication, or coarse positioning, the requirement of the accuracy of the information on the above entities is not large. However, if high accuracy positioning is targeted, extra care needs to be taken when deploying the base stations, and dedicated surveying is required to reduce uncertainties. This will inevitably increase the cost of deploying the network. 
%For measurements performed and presented in this paper, we reuse a deployment intended for communication, where highly accurate surveying of the location and orientation of the \ac{AAS} has not been performed. 

%----------------------------------------------
%------------------ UE ------------------------
%----------------------------------------------

\subsection{UE Description}
%\begin{itemize}
%    \item 2-3 columns, 2-3 figures
%    \item deployment of the array on the vehicle and corresponding uncertainties in position and orientation
%    \item Any other information regarding the vehicle you think is relevant
%    \item describe the hardware, antenna arrays
%    \item Describe the receiver beams
%    \item Describe uncertainties related to the array and beams and synchronization
%    \item the signal structure
%    \item the signal acquisition
%    \item signal processing steps
%    \item relevant uncertainties (eg. synchronization)
%    \item Different synchronization, like the synchronization between GPS and receiver, between BS and receiver (interpolation, compensate the bias with accurate clock, Meeting with Simon)
%\end{itemize}

The \ac{ue} is based on the Sivers Semiconductors STP02800 platform. To increase the covered angle, the platform has been modified to run with two receiver channels. For the measurements, the platform was mounted on the roof of a test vehicle, see Fig~\ref{fig:mounted_platform_ue}. The radios were mounted perpendicular to each other with one facing forward and the other to the left of the car. Therefore, when the \ac{ue} drives towards the \ac{bs} from north to south, or alongside the \ac{bs} azimuth coverage from east to west, it could be assured that one of the radios lies within the \ac{los} while the other one could increase the chance of capturing the reflections.
Each radio is equipped with 2 URA antenna modules of size $2 \times 8$, where only one of them serves at the time, and the other is used as a backup. %With the beamsteering capability in the azimuth angle, There are 21 predefined beams covering the range $\pm45^{\circ}$.        

\begin{figure}
    \centering
    \includegraphics[trim={40cm 25cm 30cm 15cm},clip,angle=-90,width=0.5\linewidth]{20220316_154130}
    \caption{The two radio modules, with the \acf{RFSoC} in the background, mounted on the top of the car.}
    \label{fig:mounted_platform_ue}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.6\linewidth]{UE-21Beams.pdf}
    \caption{The UE beam patterns are characterized by the antenna responses measurement in a chamber at 27.2 GHz and predefined antenna weighting factors.}
    \label{fig:UE_Beams}
\end{figure}

 Unlike the BS side, the antenna response of the UE radio receiver has been characterized in a chamber with absorbers. It was done by $1^{\circ}$ of resolution in azimuth at 27.2 GHz with 400 MHz bandwidth. The Beam patterns were subsequently generated by applying the predefined antenna weighting vectors as shown in Fig~\ref{fig:UE_Beams}. Considering the overlapping of some UE beams, it might not be necessary to sweep all of them during the measurement.

As described earlier, the transmitted signal from the \ac{bs} consists of two parts. The first part consists of \ac{SSB} data for synchronization, and the second part consists of \ac{CSI-RS} data used for positioning. The first step in the calibration is to estimate the frequency offset between the \ac{bs} and \ac{ue}, and do the symbol timing synchronization. These steps are performed simultaneously using the \ac{PSS} part of the \ac{SSB}. The final step is the symbol synchronization which is achieved with the \ac{SSS} and \ac{PBCH-DMRS}. Once the synchronization is done, the \ac{RFSoC} keeps the synchronization for the rest of the measurements, meaning that the synchronization only has to be done once before starting the measurements. To be able to keep the synchronization, the clock on the \ac{RFSoC} has to be synchronized with the clock on the \ac{bs}. This was achieved by the use of an external rubidium clock providing the \ac{RFSoC} with a \ac{PPS} signal. With this solution, the \ac{RFSoC} was able to keep the synchronization with the \ac{bs} within a few samples.%$\pm2$~samples.

Once the synchronization is done, the data collection can begin. For each of the \ac{bs} beams, data was collected for $15$ of the $21$ available \ac{ue} beams. The used beam indices were $1, 3, 4, 5, 7, 8, 9, 11, 13, 14, 15, 17, 18, 19~\text{and}~21$. Each beam combination was measured for a duration of $2$ \ac{OFDM} symbols, which corresponds to around $18~\mathrm{\mu s}$. Each measurement lasted for $40$~ms and the data collected was downloaded from the \ac{RFSoC} and stored on a computer. Once the data is stored, a new measurement will start, resulting in a measurement taking place approximately every 3rd second. For each measurement, the current \ac{GPS} position was also saved to be used as a reference position.

\subsection{Ground-truth System}
%The test campaign used the Oxford RT3003G v2 system, referred to as OxTS, for the collection of ground truth trajectory. The system combines \ac{IMU}, comprised by three accelerometer and three gyroscopes. The OxTS can achieve $1~\text{cm}$ accuracy positioning by utilizing the \ac{RTK}. The \ac{RTK}  corrected \ac{GNSS} to provide a very accurate ground truth of the position of the ego vehicle. The Oxford RT3003G v2 system for this purpose. The system provides up to 1 cm accuracy positioning by combining the \ac{RTK} corrections with the \ac{GNSS} with the onboard \ac{IMU} and gyroscopes. The OXTS system provides outputs for latitude and longitude position, accelerations in three dimensions as well as rotations in three dimensions, with an update frequency of 100 Hz.

The test campaign used the Oxford RT3003G v2 system \cite{oxts}, referred to as OXTS, for the collection of ground-truth trajectory, which can achieve very accurate ground truth of the position of the ego vehicle down to $0.1~\text{m}$. The system consists of an \ac{IMU}, comprised of three accelerometers and three gyroscopes, a \ac{gnss} receiver, and a real-time on-board processor. A Kalman filter is used to fuse the IMU and GNSS inputs, which provides a real-time estimate of the position. The system also utilizes \ac{RTK} corrections provided via the SWEPOS network-\ac{RTK} service \cite{swepos} to further enhance the position accuracy, which is a technique used for resolving common errors in the GPS signal created by, for example, the atmosphere. By deploying a static \ac{bs} at a known position, an analysis of the carrier wave can be achieved and corrections can be broadcasted to the mobile rover in the area, hence making very accurate positioning achievable. Table \ref{tab:oxts_uncertainty} summarizes the average measurement uncertainties reported by the OXTS during the test.

The OXTS was installed in the vehicle's trunk, centered over the rear wheel axis. The system used a dual antenna setup to enhance the heading accuracy of the measurements during static measurements. The primary antenna was installed on top of the trunk of the vehicle. The secondary antenna was mounted on the engine hood. As the measurements from the OXTS were intended to describe the position and the orientation of the UE rather than the vehicle itself, all measurements were translated from the position and the orientation of the OXTS to the position and orientation of the UE antenna. The translation was based on manual measurements of the distances and rotations between the OXTS system to the UE on the roof of the vehicle. %, to the primary antenna and then to the UE on the roof of the vehicle. Measurements were done in (x,y,z) where x is the forward direction of the vehicle, y is to the left-hand side of the vehicle and z is the upwards direction.
% OxTS - What does it measure, what is RTK, how it works and what benifits it brings
% Vehicle installation, where is the OxTS mounted and how does it relate to the position of the UE (pos and rot)
% How we measured the distance between the UE and OxTS
% Figures... [I have some alternatives, perhaps exchange/complement visualization by Fan's pictures]



\begin{table}[h]
    \centering
    \caption{Average measurement uncertainties reported by OXTS during the test.}
    \label{tab:oxts_uncertainty}
    \begin{tabular}{|c|c|c|c|c|c|}
    \hline
     $\alpha_{\text{UE},k}$& $\beta_{\text{UE},k}$ &
    $\gamma_{\text{UE},k}$ &$x_{\text{UE},k}$ & $y_{\text{UE},k}$ & $z_{\text{UE},k}$\\ \hline
     $0.060^\circ$ & $0.052^\circ$ & $1.136^\circ$ & $0.194~\mathrm{m}$ &  $0.187~\mathrm{m}$ 
     &  $0.245~\mathrm{m}$\\
     \hline
    \end{tabular}
\end{table}



%\subsection{Beamspace Measurements}






\section{Channel Parameter Estimation, Positioning and Mapping} \label{sec:localization_mapping}

This section discusses how to obtain the channel parameters and how to perform positioning and mapping. The \ac{bs} calibration is first introduced, then the positioning algorithm using only \ac{los} is described, followed by  the positioning and mapping algorithm using both \ac{los} and \ac{nlos} paths. % for synchronized and asynchronized cases.


\subsection{Channel Parameter Estimation}\label{Section:channel_estimation}

At the CSI-RS transmission stage, both the BS and UE apply the beam-sweeping mechanism. Considering the number of beams on each side and the signal numerology, it was possible to send $30$ OFDM  symbols per each BS beam, which make sure all the $15$ UE beams are captured within $2$ ODFM symbols per UE beam. Taking the average over the $2$ received OFDM symbols per beam pair results in $G = 15\times 136$ OFDM symbols for each measurement. Therefore, we denote $\boldsymbol{\vartheta}_{g,k}$ and $\boldsymbol{\varphi}_{g,k}$ as the local beamforming angles for the $g$-th OFDM symbol at the UE and the BS sides, corresponding to $\boldsymbol{w}_{\text{UE},g,k}$ and $\boldsymbol{f}_{\text{BS},g,k}$, respectively. Based on the collected beamspace measurements $y_{\kappa, g, k}$ and the pilot signal $p_{\kappa,g}$ as described in Section~\ref{Sec_Sys_Ref}, the beamspace channel over the $\kappa$-th subcarrier, i.e., $h_{\kappa, g, k} = \boldsymbol{w}_{\text{UE},g,k}^\top \boldsymbol{H}_{\kappa, k}\boldsymbol{f}_{\text{BS}, g, k}$ is given by
\begin{equation}
    \hat h_{\kappa,g,k} = \frac{p_{\kappa,g}^*\hat y_{\kappa, g, k}}{|p_{\kappa,g}|^2} = h_{\kappa,g,k} + \frac{p_{\kappa,g}^*\hat n_{\kappa, g, k}}{|p_{\kappa,g}|^2}.
    \label{eq:beamspace_channel}
\end{equation}

Without completely calibrated complex beam pattern responses, a simple beam sweeping channel estimator can be designed to find the strongest beam pairs across the total $G$ transmissions. With the estimated beamspace channel in~\eqref{eq:beamspace_channel}, the strongest propagation path at the time $k$ can be obtained as
\begin{equation}
    \hat g_k = \argmax_g \sum_\kappa|\hat h_{\kappa, g,k}|^2,
\end{equation}
and the associated AOA and AOD can be obtained as  $\hat{\boldsymbol{\theta}}_k = \boldsymbol{\vartheta}_{\hat g, k}$ and $\hat{\boldsymbol{\phi}}_k = \boldsymbol{\varphi}_{\hat g, k}$. Considering the UE board has limited resolution on elevation, we describe the AOA estimation as $\hat \theta_k = [\theta_{\text{az}, k},0]^{\mathsf{T}}$ with setting the covariance of the AOA elevation very large later. Further refinement can be done by interpolation of adjacent beams. To do this, we first formulate a weighting tensor $\bar{\mathcal{\boldsymbol{H}}}\in \mathbb{R}^{15\times 4\times 34}$ at time $k$ with each element as
\begin{equation}
\bar{h}_{g, k} = \bar{h}_{g_1, g_2, g_3, k} = [\bar{\mathcal{\boldsymbol{H}}}_{k}]_{g_1, g_2, g_3} =  \sum_\kappa|\hat h_{\kappa, g,k}|^2,
\label{eq:tensor_channel}
\end{equation}
where the OFDM symbol index $g$ has a one-to-one mapping to indices $g_1, g_2, g_3$ of $\bar{\mathcal{\boldsymbol{H}}}_{k}$, which correspond to the indices of the UE beam, the BS elevation beam, and the BS azimuth beam at the $g$-th transmission, respectively.
% of the tensor space $\bar{\mathcal{\boldsymbol{H}}}_{k}$, and $g_1, g_2, g_3$ 
The refined angle estimation, taking AOD for example, can be calculated as 
\begin{equation}
    \hat{\boldsymbol{\phi}}_k = \frac{\sum_{g_2 \in \mathcal{G}_2}\sum_{g_3 \in \mathcal{G}_3} \bar{h}_{\hat g_1, g_2, g_3, k}\boldsymbol{\varphi}_{\hat g_1, g_2, g_3, k}}
    {\sum_{g_2 \in \mathcal{G}_2}\sum_{g_3 \in \mathcal{G}_3} \bar{h}_{\hat g_1, g_2, g_3, k}},
\end{equation}
where $\hat g_1$ is the index of the UE beam corresponding to the strongest propagation path $\hat g_k$, $\mathcal{G}_2$ and $\mathcal{G}_3$ contain the adjacent beams at the second and third dimension of the tensor, e.g., $G_3 = \{\hat g_3-1, \hat g_3, \hat g_3+1\}$ if $1<\hat g_3<15$.

For each beam-pair received signal, the phase changes linearly with the subcarrier index as indicated in \eqref{eq:FreqObservation}. However, the true phases are wrapped within $[0, 2\pi)$, and the delay for the strongest beam pair $\hat{g}$ can be estimated as
\begin{equation}
    \hat{\tau}_{k} = \argmin_{\tau} |\sum_{\kappa} {\hat{h}_{\kappa,\hat{g}_k,k}} e^{j 2 \pi \kappa \Delta_f \tau}|^2.
    \label{eq:delay_estimation}
\end{equation}
% \begin{equation}  
% \hat{\tau}_{k}^{i} = -\frac{\hat a_{k}}{2\pi \Delta_f},
% \end{equation}
% where
% \begin{equation}  
%         [\hat{a}_{k}, \hat{m}_{k}] = \argmin_{(a_{k},m_{k})} \sum_{\kappa}\| \angle{\hat{h}_{\kappa,\hat{g},k}} - a_{k}\kappa - m_{k}\|^2.
% \end{equation}
The AOAs/AODs and delays of other paths can be obtained in a similar way, providing the estimated channel parameters $\hat{\boldsymbol{z}}_k^i = [\hat \tau_k^i, (\hat{\boldsymbol{\theta}}_k^i)^{\mathsf{T}}, (\hat{\boldsymbol{\phi}}_k^i)^{\mathsf{T}}]^{\mathsf{T}}$. 


In case only downlink measurements are used (see Section \ref{sec:TDOApositioning}), the UE clock bias is an unknown that should be estimated along with the UE position (see Appendix \ref{GeometricRelationships}). If the downlink measurement corresponds to the return part of an RTT protocol, the clock bias can be removed and the estimated TOA can be directly related to the distance between BS and UE. In this case, errors are due to the combination of clock stability, signal quality, and multipath resolution. The RTT model will be used in Section \ref{los_localization} and Section \ref{sec:RTT-NLOS}.

%\Yu{Please note we intend to use RTT in this paper, where the TOA is used as the return path in an RTT protocol. Therefore, the RTT performance is limited by how well we can estimate the TOA. At the UE side, the TOA is estimated, where the clock bias and errors are included, then used to compute the RTT. The larger clock bias and errors are in the TOA, the worse RTT will be.} 


% old text:
% Both the BS and UE apply the beam sweeping mechanism, i.e., for each transmission, one column in $\boldsymbol{W}_{\mathrm{BS}}$ is selected as the precoding vector $\boldsymbol{w}_{\mathrm{BS}, g, k}$, and one column in $\boldsymbol{W}_{\mathrm{UE}}$ is selected as the combining vector $\boldsymbol{w}_{\mathrm{UE}, g, k}$. Therefore, after $15\times 136$ OFDM transmissions (each beam pair measurement is averaged over two OFDM transmissions\Hui{136x15? do you mean two boards?}), the beamspace channel matrix $\hat{\boldsymbol{H}}_{\kappa}\in \mathbb{C}^{15\times 134}$ is obtained as
% \begin{align}
% \hat{\boldsymbol{H}}_{\kappa} =& \boldsymbol{W}_{\mathrm{UE}}^{\mathsf{H}} \boldsymbol{H}_{\kappa} \boldsymbol{W}_{\mathrm{BS}} + \tilde{\boldsymbol{N}}_{\kappa},\label{Rec_Beamspace}
% \end{align}
% where the time index $k$ is dropped as we assume the channel remains unchanged during one sweeping period (40ms). The equivalent noise component $\tilde{\boldsymbol{N}}_{\kappa}\in \mathbb{C}^{15\times 134}$ are modeled with each entry independent and identically distributed, following $\tilde{n}_{i,j}\sim \mathcal{CN}(0, \sigma_n^2/E_{\mathrm{s}})$.

% With the estimation of the beamspace channel matrix over all subcarriers, we define a 3D tensor $\tilde{\boldsymbol{\mathcal{H}}}\in \mathbb{C}^{N_{\mathrm{BU}}\times N_{\mathrm{BB}} \times N}$.


\subsection{BS Calibration}
\label{sec:bs_cal}
%\begin{itemize}
%    \item 6D BS calibration
%    \item MAP(ML) estimator
%    \item Data choose
%\end{itemize}

%In principle, the ground truth of the \ac{bs} state $\boldsymbol{s}_\text{BS}$ is given, and the \ac{ue} can directly use $\boldsymbol{s}_\text{BS}$ and measurements to localize itself. However, it is expected that the provided $\boldsymbol{s}_\text{BS}$ is not accurate enough and contains biases, as it is usually manually measured or the deployed position and orientation may change slightly after a long time exposure outside. This can cause significant errors, especially at a large distance. 
As discussed in Section~\ref{Sec_deploy}, explicit surveying of the site has not been performed. The \ac{bs} state $\boldsymbol{s}_\text{BS}$ is not provided with sufficient accuracy for positioning purposes.
Therefore, we need to calibrate the \ac{bs} state $\boldsymbol{s}_\text{BS}$ before doing positioning or other further processes. To do this, we utilize \ac{los} paths at different \ac{ue} locations, where the \ac{ue} positions and orientations at those locations are provided by the OXTS system. The \ac{nlos} paths are not used even though they contain the information on $\boldsymbol{s}_{\text{BS}}$, as the corresponding \ac{IP} of each \ac{nlos} path is unavailable. Moreover, we do not use the delay information of \ac{los} paths either, as the delay is affected by the clock bias. Although the BS and the UE are synchronized by the synchronization process, the clock bias between the BS and the UE is still time-varying and may suffer from non-negligible variations over time.

When the \ac{ue} arrives at a new location at time step $k$, the OXTS system provides its position $\boldsymbol{p}_{\text{UE},k}$, and the orientation $\boldsymbol{\psi}_{\text{UE},k}$. The channel estimator provides a group of measurements, and the measurement
associated with the \ac{los} path is denoted by $\boldsymbol{z}_{k}^{1}$, which is determined by selecting the strongest and shortest path as follows: ${\boldsymbol{z}}_{k}^{1} =  \{\boldsymbol{z}_{k}^{i}: \min_i \{\tau_k^i\} \}$. We pick up the AOA and the AOD of the \ac{los} path, denoted as $\check{\boldsymbol{z}}_{k}^{1}=[\boldsymbol{z}_{k}^{1}]_{2:5}$. 
% We only use the angle information of $\boldsymbol{z}_{k}^{1}$, which is denoted as $\check{\boldsymbol{z}}_{k}^{1}$. 
When considering the $K$ different locations, the posterior of $\boldsymbol{s}_{\text{BS}}$ given all $K$ groups of $\boldsymbol{p}_{\text{UE},k}$, $\boldsymbol{\psi}_{\text{UE},k}$ and $\check{\boldsymbol{z}}_{k}^{1}$ can be derived as 
\begin{align}
f(\boldsymbol{s}_\text{BS} |&\boldsymbol{p}_{\text{UE},1:K},\boldsymbol{\psi}_{\text{UE},1:K},\check{\boldsymbol{z}}_{1:K}^{1}) \propto \label{posterior_bs}f(\boldsymbol{s}_\text{BS})\prod_{k=1}^K f(\boldsymbol{p}_{\text{UE},k}) f(\boldsymbol{\psi}_{\text{UE},k})f(\check{\boldsymbol{z}}_{k}^{1}|\boldsymbol{p}_{\text{UE},k},\boldsymbol{\psi}_{\text{UE},k},\boldsymbol{s}_\text{BS}),
\end{align}
where $f(\boldsymbol{s}_{\text{BS}})$ is a uniform prior for $\boldsymbol{s}_\text{BS}$ within a small area centered at the provided ground truth, and $f(\boldsymbol{p}_{\text{UE},k})$ and $f(\boldsymbol{\psi}_{\text{UE},k})$ denote the densities of the $\boldsymbol{p}_{\text{UE},k}$ and $\boldsymbol{\psi}_{\text{UE},k}$, respectively, with the mean measured by the OXTS system,  and covariances as shown in Table \ref{tab:oxts_uncertainty}, and $f(\check{\boldsymbol{z}}_{k}^{1}|\boldsymbol{s}_{\text{UE},k},\boldsymbol{\psi}_{\text{UE},k},\boldsymbol{s}_\text{BS})$ is the likelihood of $\check{\boldsymbol{z}}_{k}^{1}$, which is equivalent to taking the angular part of \eqref{likelihood}. Then, $\boldsymbol{s}_\text{BS}$ can be estimated by maximize  \eqref{posterior_bs}
\begin{align}
 \hat{\boldsymbol{s}}_\text{BS} &=\argmax_{\boldsymbol{s}_\text{BS}}f(\boldsymbol{s}_\text{BS} |\boldsymbol{p}_{\text{UE},1:K},\boldsymbol{\psi}_{\text{UE},1:K},\check{\boldsymbol{z}}_{1:K}^{1}).\label{max_pos}
\end{align}
Considering the uniform and Gaussian distributions in \eqref{posterior_bs}, it is equivalent to write \eqref{max_pos} as 

\begin{align}
 \hat{\boldsymbol{s}}_{\text{BS}} =\argmin_{\boldsymbol{s}_{\text{BS}}}\sum_{k=1}^K &\left( \check{\boldsymbol{h}}_{k}^{1} - \check{\boldsymbol{z}}_{k}^{1} \right)^\top (\check{\boldsymbol{R}}_{k}^{1})^{-1}  \left( \check{\boldsymbol{h}}_{k}^{1} - \check{\boldsymbol{z}}_{k}^{1} \right)  \label{LS}\\
\text{s.t.} \quad  & \boldsymbol{s}_\text{BS} \in 
\mathbb{S}_{\text{BS}}\nonumber,
\end{align}
where $\mathbb{S}_{\text{BS}}$ denotes a small space centered around the uncalibrated \ac{bs} state, and $\check{\boldsymbol{h}}_{k}^{1}$ and $\check{\boldsymbol{R}}_{k}^{1}$ are the angular parts of ${\boldsymbol{h}}_{k}^{1}$ and ${\boldsymbol{R}}_{k}^{1}$, respectively. Since \eqref{LS} does not have a closed-form solution, $\hat{\boldsymbol{s}}_\text{BS}$ is approximated iteratively. The problem is initialized using the uncalibrated state, and the gradient-based trust-region-reflective algorithm is used to solve the problem.

\subsection{Positioning based on LOS path only}\label{los_localization}


%\begin{itemize}
%        \item Describe the used information
%        \item ML estimator
%        \item LOS pick-up
%    \end{itemize}

After the \ac{bs} calibration, a more accurate \ac{bs} state can be acquired, and we directly  denote the calibrated \ac{bs} state as $\boldsymbol{s}_\text{BS}$ from now on. When knowing $\boldsymbol{s}_\text{BS}$, we can use measurements provided by the channel estimator to localize the \ac{ue}, which is to estimate $\boldsymbol{p}_{\text{UE},k}$ in this paper. The most straightforward way is to utilize the \ac{los} path. If $\boldsymbol{\psi}_{\text{UE},k}$ is unknown to the \ac{ue}, $\boldsymbol{\theta}_{k}^{1}$ cannot be used, as it also depends on the orientation of the \ac{ue}. In this case, only $\tau_{k}^{1}$ and $\boldsymbol{\phi}_{k}^{1}$ can be used, and $\boldsymbol{p}_{\text{UE},k}$ has a closed-form solution as 
\begin{equation}\label{positioning_syn}
    \boldsymbol{p}_{\text{UE},k} = \boldsymbol{p}_\text{BS} + d_{k}^{1}\underset{{\boldsymbol{u}^{1}_{\text{BS},k}}}{\underbrace{\boldsymbol{R}_{\text{BS}} ^{\textsf{T}}\begin{bmatrix} \cos\left({\phi}_{\text{az},k}^{1} \right)\cos\left({\phi}_{\text{el},k}^{1} \right) \\ 
    \sin\left({\phi}_{\text{az},k}^{1} \right)\cos\left({\phi}_{\text{el},k}^{1} \right) \\
\sin\left({\phi}_{\text{el},k}^{1}\right)\end{bmatrix}}},
\end{equation}
where $d_{k}^{1}=( \tau_{k}^{1} - b_{k} )c$ is the propagation distance of the \ac{los} path, and $\boldsymbol{R}_{\text{BS}}^{\textsf{T}}$ is the rotation matrix from local coordinate system of the \ac{bs} to the global reference. This approach works only if the clock bias is eliminated by the RTT protocol, %the synchronization problem between the transmitter and the receiver is solved 
and the clock bias is quite stable during the estimation procedure. %, so that the clock bias is given or can be estimated. 
However, if the clock bias varies seriously with time, \eqref{positioning_syn} will result in large positioning errors. Although $\boldsymbol{\theta}_{k}^{1}$ cannot be used in these cases, it is still possible to do single-\ac{bs} positioning, as long as we know at least one dimension of $\boldsymbol{p}_{\text{UE},k}$, e.g., the height of the \ac{ue} $z_{\text{UE},k}$. Knowing $z_{\text{UE},k}$ is a reasonable assumption, especially in the urban vehicular scenario, where the vehicle moves on the ground, and the height does not change much. Then, the 2D position of the \ac{ue} on the x-y domain can be computed by
%\begin{align}\label{positioning_unsyn}
%    &\begin{bmatrix} x_{\text{UE},k} \\ 
%    y_{\text{UE},k} \end{bmatrix}= \begin{bmatrix} x_{\text{BS}} \\ 
%    y_{\text{BS}} \end{bmatrix} + \\& \qquad \frac{ z_{\text{UE},k} - z_{\text{BS}} }{\sin\left(\boldsymbol{\theta}_{\text{el},k}^{1} \right)}[\boldsymbol{R}_{\text{BS}} ^{\textsf{T}}]_{1:2,1:3}\begin{bmatrix} \cos\left(\boldsymbol{\theta}_{\text{az},k}^{1} \right)\cos\left(\boldsymbol{\theta}_{\text{el},k}^{1} \right) \\ 
%    \sin\left(\boldsymbol{\theta}_{\text{az},k}^{1} \right)\cos\left(\boldsymbol{\theta}_{\text{el},k}^{1} \right) \\
%\sin\left(\boldsymbol{\theta}_{\text{el},k}^{1}\right)\end{bmatrix}.\nonumber
%\end{align}
\begin{align}\label{positioning_unsyn}
    &\begin{bmatrix} x_{\text{UE},k} \\ 
    y_{\text{UE},k} \end{bmatrix}= \begin{bmatrix} x_{\text{BS}} \\ 
    y_{\text{BS}} \end{bmatrix} +  \frac{ z_{\text{UE},k} - z_{\text{BS}} }{[\boldsymbol{u}^{1}_{\text{BS},k}]_{3}}[\boldsymbol{u}^{1}_{\text{BS},k}]_{1:2}.
\end{align}
In an ideal case, where the clock bias is stable and provided, and $\boldsymbol{\psi}_{\text{UE},k}$ is known, $\boldsymbol{p}_{\text{UE},k}$ can be acquired by
\begin{align}
 \hat{\boldsymbol{p}}_{\text{UE},k} =\argmin_{\boldsymbol{p}_{\text{UE},k}} \left( {\boldsymbol{h}}_{k}^{1} - {\boldsymbol{z}}_{k}^{1} \right)^\top ({\boldsymbol{R}}_{k}^{1})^{-1}  \left( {\boldsymbol{h}}_{k}^{1} - {\boldsymbol{z}}_{k}^{1} \right)  \label{LS_pos_ideal},
\end{align}
where $\boldsymbol{h}_{k}^{1}$ is the shorthand of $\boldsymbol{h}(\boldsymbol{s}_{k},\boldsymbol{s}_{\text{BS}})$. Note that $\boldsymbol{p}_{\text{UE}}$ is included in $\boldsymbol{s}_{\text{BS}}$ by definition.


\subsection{Positioning based on LOS and NLOS }

%    \begin{itemize}
%        \item Data Association
%        \item clustering algorithm
%        \item ML estimator for sensor station
%        \item How to map the environment
%    \end{itemize}
In Section \ref{los_localization}, only the \ac{los} path is used to position the \ac{ue} every single time snapshot, and all the \ac{nlos} paths are not utilized. These \ac{nlos} paths contain information on the  \ac{ue} position, which is beneficial to positioning. Since \ac{nlos} paths also depend on the surrounding environment, it is possible to both localize the \ac{ue} and map the environment by utilizing all \ac{los} and \ac{nlos} paths. To solve this positioning and mapping problem, the most straightforward way is to first solve the \ac{ML} problem as
\begin{align}
 \hat{\boldsymbol{p}}_{\text{UE},k},\hat{b}_{k},[\hat{\boldsymbol{p}}_{\text{IP},k}^{i}]_{i=2}^{\hat{I}_{k}}=\argmax_{\boldsymbol{p}_{\text{UE},k},b_{k},[\boldsymbol{p}_{\text{IP},k}^{i}]_{i=2}^{\hat{I}_{k}}}\prod_{i=1}^{\hat{I}_{k}}f(\boldsymbol{z}_{k}^{i}|\boldsymbol{s}_{k},\boldsymbol{s}_{\text{BS}},\boldsymbol{p}_{\text{IP},k}^{i})\label{ML_LM},
\end{align}
After getting all \acp{IP} $[\hat{\boldsymbol{p}}_{\text{IP},k}^{i}]_{i=2}^{\hat{I}_{k}}$, surfaces can be estimated from those points, as \acp{IP} of paths reflected/diffused by the same surface should be on the same surface.

\subsubsection{RTT-based Positioning} \label{sec:RTT-NLOS}
Even with an RTT-based protocol where $b_k$ can be assumed known, the high-dimensional optimization is required in \eqref{ML_LM}, which usually has high complexity. To avoid this, we propose a low-complex search-free positioning and mapping method that follows two steps. The first step is to localize the \ac{ue} using all paths. For a path $i$, we define a unit vector at the transmitter side $\boldsymbol{u}^{i}_{\text{BS},k}$ to represent the direction of the signal leaving the transmitter in the global coordinate system, denoted as
\begin{align}
    \boldsymbol{u}^{i}_{\text{BS},k} =\boldsymbol{R}_{\text{BS}} ^{\textsf{T}}\begin{bmatrix} \cos\left({\phi}_{\text{az},k}^{i} \right)\cos\left({\phi}_{\text{el},k}^{i} \right) \\ 
    \sin\left({\phi}_{\text{az},k}^{i} \right)\cos\left({\phi}_{\text{el},k}^{i} \right) \\
\sin\left({\phi}_{\text{el},k}^{i}\right)\end{bmatrix}.
\end{align}
Similarly, we define a unit vector at the receiver side $\boldsymbol{u}^{i}_{\text{UE},k}$ to represent the direction of the signal arriving at the receiver in the global coordinate system, denoted as
\begin{align}
\boldsymbol{u}^{i}_{\text{UE},k}=\boldsymbol{R}_{\text{UE},k} ^{\textsf{T}}\begin{bmatrix} \cos\left({\theta}_{\text{az},k}^{i} \right)\cos\left({\theta}_{\text{el},k}^{i} \right) \\ 
    \sin\left({\theta}_{\text{az},k}^{i} \right)\cos\left({\theta}_{\text{el},k}^{i} \right) \\
\sin\left({\theta}_{\text{el},k}^{i}\right)\end{bmatrix}.\label{ue_position_fra}
\end{align}
where $\boldsymbol{R}_{\text{UE},k}^{\textsf{T}}$ denotes the rotation matrix from the local coordinate system of the UE to the global reference.
Then, the \ac{ue} position can be given by
\begin{align}
\boldsymbol{p}_{\text{UE},k} = \boldsymbol{p}_\text{BS} + d_{k}^{i}\gamma_{k}^{i}\boldsymbol{u}^{i}_{\text{BS},k} - d_{k}^{i}(1-\gamma_{k}^{i})\boldsymbol{u}^{i}_{\text{UE},k},
\end{align}
where $d_{k}^{i}=( \tau_{k}^{i} - b_{k} )c$ denotes the corresponding propagation distance of the path, and $\gamma_{k}^{i}\in[0,1]$ represents the fraction of the propagation distance on the direction of $\boldsymbol{u}^{i}_{\text{BS},k}$,  which is unknown yet. By rearranging \eqref{ue_position_fra} and gathering known and unknown parts separately, we have
\begin{align}\label{lines}
\boldsymbol{p}_{\text{UE},k} = \underset{\boldsymbol{\mu}_{k}^{i}} {\underbrace{\boldsymbol{p}_\text{BS}-d_{k}^{i}\boldsymbol{u}^{i}_{\text{UE},k}}} + \gamma_{k}^{i} d_{k}^{i}\underset{\boldsymbol{\nu}_{k}^{i}} {\underbrace{(\boldsymbol{u}^{i}_{\text{BS},k} +\boldsymbol{u}^{i}_{\text{UE},k})}},
\end{align}
which means $\boldsymbol{p}_{\text{UE},k}$ is $\gamma_{k}^{i}d_{k}^{i}|\boldsymbol{\nu}_{k}^{i}|$ away from the point $\boldsymbol{\mu}_{k}^{i}$ alongside the direction of $\boldsymbol{\nu}_{k}^{i}$, i.e., the direction of $\boldsymbol{u}^{i}_{\text{BS},k} +\boldsymbol{u}^{i}_{\text{UE},k}$, and it is obvious that $\boldsymbol{p}_{\text{UE},k}$ is on the determined line, as described in Fig.~\ref{fig:nlos_local}. There are $\hat{I}_{k}$ estimated paths, and each will determine a line. Therefore, $\boldsymbol{p}_{\text{UE},k}$
can be determined by finding the intersection points of these lines. This can be done by minimizing the cost function
\begin{align} \label{distance_to_lines}
 \hat{\boldsymbol{p}}_{\text{UE},k}=\argmin_{\boldsymbol{p}_{\text{UE},k}}\sum_{i=1}^{\hat{I}_{k}}\eta_{k}^{i}||\boldsymbol{p}_{\text{UE},k}-\boldsymbol{\mu}_{k}^{i}-(\bar{\boldsymbol{\nu}}_{k}^{i})^{\textsf{T}}(\boldsymbol{p}_{\text{UE},k}-\boldsymbol{\mu}_{k}^{i})\bar{\boldsymbol{\nu}}_{k}^{i}||^{2},
\end{align}
with $\eta_{k}^{i}$ denoting the strength of the $i$-th path, and $\bar{\boldsymbol{\nu}}_{k}^{i}=\boldsymbol{\nu}_{k}^{i}/|\boldsymbol{\nu}_{k}^{i}|$ denoting the corresponding norm vector of the direction. The interpretation of \eqref{distance_to_lines} is finding a $\boldsymbol{p}_{\text{UE},k}$ that results in the smallest sum of the distance between $\boldsymbol{p}_{\text{UE},k}$ and the line \eqref{lines} of each path. There is a closed-form solution for \eqref{distance_to_lines}, which is the least-square solution given by
\begin{align} \label{pos_least_square}
 \hat{\boldsymbol{p}}_{\text{UE},k}=\Big(\sum_{i=1}^{\hat{I}_{k}}\eta_{k}^{i}(\boldsymbol{I}-\bar{\boldsymbol{\nu}}_{k}^{i}(\bar{\boldsymbol{\nu}}_{k}^{i})^{\textsf{T}})\Big)^{-1}\sum_{i=1}^{\hat{I}_{k}}\eta_{k}^{i}(\boldsymbol{I}-\bar{\boldsymbol{\nu}}_{k}^{i}(\bar{\boldsymbol{\nu}}_{k}^{i})^{\textsf{T}})\boldsymbol{\mu}_{k}^{i}.
\end{align}
\begin{figure}
    \centering
    \includegraphics[width=0.6\linewidth]{Figures_without_ESPRIT/nlos_local.jpg}
    \caption{The visualization of \eqref{lines}, where $\boldsymbol{u}^{i}_{\text{BS},k}$, $\boldsymbol{u}^{i}_{\text{UE},k}$, $\boldsymbol{p}_\text{BS}$ and $ d_{k}^{i}$ are known,  $\gamma_{k}^{i}$ is unknown, and  $\boldsymbol{p}_{\text{UE},k}$ is on the line of $\boldsymbol{\mu}_{k}^{i}+\boldsymbol{\nu}_{k}^{i}$.}
    \label{fig:nlos_local}
\end{figure}

\subsubsection{TDOA-based Positioning} \label{sec:TDOApositioning}
The solution of \eqref{pos_least_square} requires a known $b_{k}$. It is still possible to simultaneously localize the \ac{ue} and synchronize it with the \ac{bs}. To do it, we firstly reconstruct \eqref{lines} as
\begin{align}\label{lines_new}
\boldsymbol{p}_{\text{UE},k}-b_{k}c\boldsymbol{u}^{i}_{\text{UE},k} = \underset{\tilde{\boldsymbol{\mu}}_{k}^{i}} {\underbrace{\boldsymbol{p}_\text{BS}-\tau_{k}^{i}c\boldsymbol{u}^{i}_{\text{UE},k}}} + \gamma_{k}^{i} d_{k}^{i}\underset{\boldsymbol{\nu}_{k}^{i}} {\underbrace{(\boldsymbol{u}^{i}_{\text{BS},k} +\boldsymbol{u}^{i}_{\text{UE},k})}}.
\end{align}
As we want to estimate both $\boldsymbol{p}_{\text{UE},k}$ and $b_{k}$, we can reformulate the optimization problem in \eqref{distance_to_lines} as
\begin{align} \label{distance_to_lines_new}
 &\hat{\boldsymbol{p}}_{\text{UE},k},\hat{b}_{k}=\argmin_{\boldsymbol{p}_{\text{UE},k},b_{k}}\sum_{i=1}^{\hat{I}_{k}}\eta_{k}^{i}||\boldsymbol{p}_{\text{UE},k}-b_{k}c\boldsymbol{u}^{i}_{\text{UE},k}-\tilde{\boldsymbol{\mu}}_{k}^{i}-(\bar{\boldsymbol{\nu}}_{k}^{i})^{\textsf{T}}(\boldsymbol{p}_{\text{UE},k}-b_{k}c\boldsymbol{u}^{i}_{\text{UE},k}-\tilde{\boldsymbol{\mu}}_{k}^{i})\bar{\boldsymbol{\nu}}_{k}^{i}||^{2}.
\end{align}
The closed-form solution of \eqref{distance_to_lines_new} is given by
\begin{align} \label{pos_bias_least_square}
\begin{bmatrix} \hat{\boldsymbol{p}}_{\text{UE},k} \\ \hat{b}_{k}\end{bmatrix}&=\Big(\sum_{i=1}^{\hat{I}_{k}}\eta_{k}^{i}(\boldsymbol{J}_{k}^{i})^{\textsf{T}}(\boldsymbol{I}-\bar{\boldsymbol{\nu}}_{k}^{i}(\bar{\boldsymbol{\nu}}_{k}^{i})^{\textsf{T}})\boldsymbol{J}_{k}^{i}\Big)^{-1}\sum_{i=1}^{\hat{I}_{k}}\eta_{k}^{i}(\boldsymbol{J}_{k}^{i})^{\textsf{T}}(\boldsymbol{I}-\bar{\boldsymbol{\nu}}_{k}^{i}(\bar{\boldsymbol{\nu}}_{k}^{i})^{\textsf{T}})\tilde{\boldsymbol{\mu}}_{k}^{i},
\end{align}
where $\boldsymbol{J}_{k}^{i}=[\boldsymbol{I},-c\boldsymbol{u}^{i}_{\text{UE},k}]$.

\subsection{Estimating \ac{IP} Locations (mapping)}
After getting $\hat{\boldsymbol{p}}_{\text{UE},k}$ and $\hat{b}_{k}$ (if required), we can compute each $\boldsymbol{p}_{\text{IP},k}^{i}$ for all \ac{nlos} paths ($i>1$) by
\begin{align}
 \hat{\boldsymbol{p}}_{\text{IP},k}^{i} =\argmin_{\boldsymbol{p}_{\text{IP},k}^{i}}\left( {\boldsymbol{h}}_{k}^{i} - {\boldsymbol{z}}_{k}^{i} \right)^\top ({\boldsymbol{R}}_{k}^{i})^{-1}  \left( {\boldsymbol{h}}_{k}^{i} - {\boldsymbol{z}}_{k}^{i} \right)  \label{LS_inc_points},
\end{align}
where $\boldsymbol{h}_{k}^{i}$ is the shorthand of $\boldsymbol{h}(\boldsymbol{s}_{k},\boldsymbol{s}_{\text{BS}},\boldsymbol{p}_{\text{IP},k}^{i} )$, and $\hat{\boldsymbol{p}}_{\text{UE},k}$ in \eqref{pos_least_square} is plugged into $\boldsymbol{h}_{k}^{i}$.  The optimization problem in \eqref{LS_inc_points} initialized by the intersection point of two lines determined by $(\boldsymbol{p}_\text{BS} + d_{k}^{i}\gamma_{k}^{i}\boldsymbol{u}^{i}_{\text{BS},k})$ and $(\hat{\boldsymbol{p}}_\text{UE,k} + d_{k}^{i}(1-\gamma_{k}^{i})\boldsymbol{u}^{i}_{\text{UE},k})$, which is given by
\begin{align}
 &\hat{\boldsymbol{p}}_{\text{IP},k}^{i} =\left((\boldsymbol{I}-\boldsymbol{u}^{i}_{\text{BS},k}(\boldsymbol{u}^{i}_{\text{BS},k})^{\textsf{T}})+(\boldsymbol{I}-\boldsymbol{u}^{i}_{\text{UE},k}(\boldsymbol{u}^{i}_{\text{UE},k})^{\textsf{T}})\right)^{-1} \label{initialization}\left((\boldsymbol{I}-\boldsymbol{u}^{i}_{\text{BS},k}(\boldsymbol{u}^{i}_{\text{BS},k})^{\textsf{T}})\boldsymbol{p}_\text{BS} +(\boldsymbol{I}-\boldsymbol{u}^{i}_{\text{UE},k}(\boldsymbol{u}^{i}_{\text{UE},k})^{\textsf{T}})\hat{\boldsymbol{p}}_\text{UE,k} \right),
\end{align}
where $\tau_{k}^{i}$ is not directly used. As there is no closed-form solution, to use all the measurement components and consider the uncertainty of the measurement, the optimization problem can be approximated by using the sigma point least square method, where a list of sigma points is created, Levenberg-Marquardt algorithm \cite{marquardt1963algorithm} is used to approximate the optimization problem for each sigma point, and the estimated state can be acquired by averaging over all optimization outputs of sigma points. 

\begin{comment}


\subsection{LOS and NLOS Positioning (known \acp{IP})}
If we know all the \acp{IP}, we dn not need \ac{AOD} information to localize the \ac{ue}, as the \ac{AOD} is determined by the \ac{IP} and the \ac{bs} states. Therefore, the \ac{ue} position determined by a \ac{nlos} can be given by 
\begin{align}
\boldsymbol{p}_{\text{UE},k} = \boldsymbol{p}_\text{IP}^{i} - (\tau_{k}^{i}c- b_{k}c-||\boldsymbol{p}_{\text{IP},k}^{i}-\boldsymbol{p}_{\text{BS}}||)\boldsymbol{u}^{i}_{\text{UE},k}.\label{eq:nlos_localization}
\end{align}
For \ac{los} paths, the \ac{ue} position can also be determined by simply set $\boldsymbol{p}_\text{IP}^{i}=\boldsymbol{p}_{\text{BS}}$ for the \ac{los} paths. Then we can estimate $\boldsymbol{p}_{\text{UE},k}$ and $b_{k}$ by solving the optimization problem 
\begin{align} \label{distance_to_points}
 \hat{\boldsymbol{p}}_{\text{UE},k},\hat{b}_{k}=&\argmin_{\boldsymbol{p}_{\text{UE},k},b_{k}}\sum_{i=0}^{\hat{I}_{k}}\eta_{k}^{i}||\boldsymbol{p}_{\text{UE},k}-\boldsymbol{p}_\text{IP}^{i} + \\ & \quad (\tau_{k}^{i}c- b_{k}c-||\boldsymbol{p}_{\text{IP},k}^{i}-\boldsymbol{p}_{\text{BS}}||)\boldsymbol{u}^{i}_{\text{UE},k}||^{2},\nonumber
\end{align}
The closed-form solution of \eqref{distance_to_points} is given by
\begin{align} \label{pos_bias_least_square_knowmap}
\begin{bmatrix} \hat{\boldsymbol{p}}_{\text{UE},k} \\ \hat{b}_{k}\end{bmatrix}&=\left(\sum_{i=0}^{\hat{I}_{k}}\eta_{k}^{i}(\boldsymbol{H}_{k}^{i})^{\textsf{T}}\boldsymbol{H}_{k}^{i}\right)^{-1}\\&\times\sum_{i=0}^{\hat{I}_{k}}\eta_{k}^{i}(\boldsymbol{H}_{k}^{i})^{\textsf{T}}(\boldsymbol{p}_\text{IP}^{i}-(\tau_{k}^{i}c- ||\boldsymbol{p}_{\text{IP},k}^{i}-\boldsymbol{p}_{\text{BS}}||)\boldsymbol{u}^{i}_{\text{UE},k}),\nonumber
\end{align}
.

\end{comment}
\begin{comment}
After translating all \ac{nlos} paths into estimated \acp{IP}, we want to estimate all \acp{VA} from those estimated \acp{IP}. The basic idea behind this is that the \ac{IP} is the point where the signal hits the wall so that \acp{IP} of the paths reflected or diffused from the same source should be on the same surface. Therefore, we can find a surface that best fits all estimated \acp{IP} of the paths from the same surface, and compute its \ac{VA}. However, the source of each path is still unknown at this point, except the \ac{los} path, which is supposed to be the strongest and shortest path, so we could not directly estimate \acp{VA} from them. In order to do this, we need firstly cluster \acp{IP} of paths from the same source together, which is feasible since those points in the same cluster should be geometrically close to each other. We employ the \ac{DBSCAN} algorithm \cite{DBSCAN96} in this work, which can classify all these points either into clusters or identified as outlier points, and these clusters are characterized by density-reachability. The \ac{DBSCAN} algorithm is controlled by two parameters $\epsilon$ and $N_{\min}$. A core point is defined as a point with at least $N_{\min}$ points (including itself) within the distance of $\epsilon$, where we use Euclidean distance in this paper. A point is directly reachable from a core point if the distance between two points is within in $\epsilon$, and points are only directly reachable from core points. Moreover, a point is reachable from a given core point, if it can be reached through a series of core points starting from the given core point, where the current core point is directly reachable from the last core point. Please note that all the points on the path from the given core point to the target point  should be core points, with the possible exception of the target point. Any points that are not reachable from any other point are defined as outlier points. The \ac{DBSCAN} algorithm clusters a core point with all its reachable points, no matter core or non-core points, to create a cluster, and forms different clusters and picks up all outlier points.  The details of the algorithm can be found in \cite[Algorithm 1]{ge20205GSLAM}

Suppose $\mathcal{C}$ is one of the clusters output from the \ac{DBSCAN} algorithm. The corresponding surface is the surface that best fits all points in $\mathcal{C}$, i.e., the  overall distances to the surface is minimal. Therefore, its \ac{VA} 
$\boldsymbol{p}_{\mathrm{VA},k}^{\mathcal{C}}$ can be estimated by minimize the cost function
\begin{align} \label{distance_to_surface}
 &\hat{\boldsymbol{p}}_{\mathrm{VA},k}^{\mathcal{C}}=\\&\argmin_{\boldsymbol{p}_{\mathrm{VA},k}^{\mathcal{C}}}\sum_{\boldsymbol{p}_{\text{IP},k}\in\mathcal{C}}|\boldsymbol{p}_{\text{IP},k}-\boldsymbol{\mu}_{k}^{\mathcal{C}}-(\bar{\boldsymbol{\nu}}_{k}^{\mathcal{C}})^{\textsf{T}}(\boldsymbol{p}_{\text{IP},k}-\boldsymbol{\mu}_{k}^{\mathcal{C}})\bar{\boldsymbol{\nu}}_{k}^{\mathcal{C}}|^{2},\nonumber
\end{align}
which denotes the summation of distances to the surface of all points in $\mathcal{C}$, and $\boldsymbol{\mu}_{k}^{\mathcal{C}}=(\boldsymbol{p}_{\mathrm{VA},k}^{\mathcal{C}}+\boldsymbol{p}_\text{BS})/2$ is a point on the surface and $\bar{\boldsymbol{\nu}}_{k}^{\mathcal{C}}=(\boldsymbol{p}_{\mathrm{VA},k}^{\mathcal{C}}-\boldsymbol{p}_\text{BS})/|\boldsymbol{p}_{\mathrm{VA},k}^{\mathcal{C}}-\boldsymbol{p}_\text{BS}|$ is the norm to the surface. Since \eqref{distance_to_surface} does not admit a closed-form solution, we can also use the Levenberg-Marquardt algorithm \cite{marquardt1963algorithm} to approximate this optimization problem iteratively. As each cluster corresponds to a unique surface, we solve \eqref{distance_to_surface} and estimate a \ac{VA} for each cluster.
\end{comment}


%\subsection{LOS + NLOS Positioning \& Mapping filter}
%   \begin{itemize}
%        \item Random walk for sensor state
%        \item IEKF (IPLF)
%    \end{itemize}
    
\section{Results} \label{results}
In this section, we introduce the test environment and display the channel estimation,  \ac{bs} calibration, \ac{los} positioning, and \ac{los} and \ac{nlos} positioning and mapping results by using test measurements. We also analyze some potential improvements by comparing the results using real test measurements with the results using the combination of parts of the test measurements and the simulated measurements.

\subsection{Test Environment}
%    \begin{itemize}
%        \item Parameters 
%        \item Location
%    \end{itemize}
The tests were carried out at Ideon scientific park, Lund, as shown in Fig.~\ref{fig:google_map}. The single \ac{bs} was fixed on the top of the signal tower at coordinate (5542'58.6"N 1313'32.9"E) with a height around $21~\mathrm{m}$, and the transmitter antenna array at the \ac{bs} was facing north with a $12^\circ$ tilt angle, see Fig.~\ref{fig:mounted_platform}.  There was no explicit surveying of the \ac{bs} performed before, and these measurements are some preliminary measurements that contain biases and need to be calibrated. The vehicle has its UE platform mounted on its roof with one of the two \acp{URA} facing to the \ac{bs}, as shown in Fig.~\ref{fig:mounted_platform_ue}. There was an absorption shield below the UE platform, which can avoid some ground reflections. The front \ac{URA} was aligned with the vehicle's direction. The relative positions and the orientations of the \ac{ue} \acp{URA} with respect to the \ac{ue}'s GPS point on the rear axis, in longitudinal, lateral, height, roll, pitch, and yaw, were measured manually onsite before starting the actual test. Although these measurements may contain some minor errors, those errors are negligible; thus, we ignored them in this paper. 

During the test, we first drove the vehicle randomly to many different locations in the parking area and kept it static to collect measurements for the \ac{bs} calibration purpose. After that, we did the test for positioning and mapping purposes. The vehicle was slowly driven alongside the trajectory described as the red arrows in Fig.~\ref{fig:google_map} for measurement collection. All these test points and the trajectory were in an effective measurement area, where the \ac{bs} can always be seen by the \ac{ue}, and there are large multi-story buildings that can have some reflections or diffusion.  The \ac{ue} continuously received downlink signals sent from the transmitter every a few seconds, which can arrive at the receiver both via the \ac{los} and possible \ac{nlos} paths. In the meantime, the GPS measured the ground truth of the \ac{ue} position and orientation. We repeated the same test for positioning and mapping purposes a few times. Note that although two rounds of the test should follow the same designed trajectory in principle, we cannot make the vehicle exactly follow the same trajectory every time. Therefore, each test still had different measurements and ground truths. After data collection, the received downlink signals were further processed and used for the \ac{bs} calibration and positioning and mapping purposes. The GPS measurements were used for the \ac{bs} calibration as well as the evaluation of positioning performances of different algorithms.

\begin{figure}
    \centering
    \includegraphics[width=0.6\linewidth]{Figures_without_ESPRIT/Google_MAP.png}
    \caption{The test happened at Ideon scientific park, Lund. The \ac{bs} is mounted on a signal tower, visible at the red circle in the bottom left part of the figure. The vehicle slowly drove alongside the trajectory, shown as the red arrows in the figure, with the antenna arrays towards the \ac{bs}. The \ac{ue} received signals sent from the \ac{bs}. The maximum distance between the UE and the BS is about 130 m, and the minimum distance is about 85 m. The dashed green lines are examples of a \ac{los} and a \ac{nlos} at a specific \ac{ue} location. }
    \label{fig:google_map}
\end{figure}

%To validate and understand the measurement results, we performed a theoretical analysis of the \ac{bs} positioning based on simulated data, and compare it with the \ac{bs} positioning results of the measurement data. We directly generate the channel parameters according to the experimental setup. We consider a simulated scenario with a single \ac{bs} located at $\boldsymbol{p}_{\text{BS}}=[140~\mathrm{m},0,30~\mathrm{m}]^{\mathsf{T}}$ with a $12^\circ$ tilt angle, where the \ac{ue} is placed at several different positions. Among $\boldsymbol{s}_{\text{UE},l}$ $x_{\text{UE},l}$ varies within $[0~\mathrm{m}, 80~\mathrm{m}]$, $y_{\text{UE},l}$ varies within $[-40~\mathrm{m}, 40~\mathrm{m}]$, $z_{\text{UE},l}$ varies within $[-2~\mathrm{m}, 2~\mathrm{m}]$, $\alpha_{\text{UE},l}$ varies within $[-2^{\circ}, 2^{\circ}]$, $\beta_{\text{UE},l}$ varies within $[-5^{\circ}, 5^{\circ}]$, and $\gamma_{\text{UE},l}$ varies within $[-45^{\circ}, 45^{\circ}]$, as the heights, rolls and pitches do not seriously change on the road. We generate a group of measurement from each \ac{bs} location. The prior of the \ac{ue} $p(\boldsymbol{p}_\text{BS})$ is a uniform distribution over the space. The \ac{bs} orientation is given, and we only estimate $p(\boldsymbol{p}_\text{BS})$. The standard deviation of each dimension of the GPS measurement is set as the corresponding accuracy shown in Table. \ref{tab:oxts_uncertainty}. As %the synchronization problem is not well solved, and there is no ability to estimate \ac{AOA} elevation, we only consider \ac{AOA} azimuth and \ac{AOD} azimuth and elevation angles, with the resolutions  $4.5^{\circ}$, $4^{\circ}$, and $7^{\circ}$ (approximated from the beam-width). %However, if the synchronization problem is solved (low bias drift uncertainty) and the resolution on  \ac{AOA} elevation is provided, \ac{TOA} and \ac{AOA} elevation should also be used. Overall, 100 \ac{MC} simulations are performed, and the results are obtained by averaging over the different \ac{MC} simulations. We evaluated the \ac{bs} positioning performance by the \ac{MAE} over all \ac{MC} simulations. This analysis will then tell us if the test results are in a meaningful range. 

%\subsection{Results and Discussion}
    %\begin{itemize}
        %\item Channel estimation results: We first visualize the beamspace channel in Fig channel estimation results of a signel snapshot beamspace channel The channel estimation results of a single snapshot is shown in 
        %\item BS calibration error
        %\item Positioning using only LOS with calibrated BS and uncalibrated BS
        %\item Positioning using only LOS with different information
        %\item Synchronization error 
        %\item Positioning using only LOS with different level synchronization error
        %\item LOS + NLOS Positioning \& Mapping results, how NLOS helps positioning
        %\item LOS + NLOS Positioning \& Mapping filter results, how filter helps results
    %\end{itemize}



\subsection{Results and Discussion}
\subsubsection{Channel estimation}
We first visualize the beamspace channel of a specific position (i.e., P2) in terms of received signal strength by fixing BS elevation beams (i.e., $\bar{\boldsymbol{H}}_{[:, \hat g_2, :]}\in \mathbb{R}^{15\times 34}$), based on~\eqref{eq:beamspace_channel}--\eqref{eq:tensor_channel}, as shown in Fig.~\ref{fig:CE01}. The two strong beam pairs (27, 11) and (31, 3) can be clearly observed, which correspond to the LOS path and NLOS path, respectively. By processing all the measurements based on~\eqref{eq:delay_estimation} along the vehicle trajectory (i.e.,  solid red arrow from P1 to P3 in Fig.~\ref{fig:google_map}), the delay (with clock bias) estimations from both the front and left board for repeated three times of measurement are plotted in Fig.~\ref{fig:CE02}. {We can see that the clock bias does not drift (i.e., there is no increasing error over time), but still % . Please note that the drift means that the error increases over time. Even though clock bias does not drift, it is still time-varying and may 
suffers from non-negligible variations, due to  hardware imperfections, imperfect synchronization, and unresolved multipath. %Therefore, the clock bias can be compensated by the mean of the clock bias over time, and it performs well if the variation is not high.
} In the first part of the measurement, the left array has better visibility with fewer outliers (red square markers) than the front array. However, when the vehicle continues heading south (towards P3), the channel estimates from both boards are getting unstable as the transmitter and receiver are far away from the boresights of each other's antenna array. The results from Fig.~\ref{fig:CE02} show that the benefit from beamforming gain by using an antenna array (instead of an omnidirectional antenna) will cause coverage issues (e.g., both arrays cannot be seen by the BS when the vehicle is approaching P3), and a multi-panel mmWave transceiver array, as well as adaptive beamforming, could be adopted on the vehicle side to mitigate this effect.


\begin{figure}[t!]
\subfigure[\,The energy heatmap (in dB) of BS-UE beam pairs.]{\input{Figures_without_ESPRIT/c_1}\label{fig:CE01}}
\subfigure[\,Delay estimation from both arrays.]{\input{Figures_without_ESPRIT/c_2_3times}\label{fig:CE02}}

% \subfigure[\,The delay of each beam.]{\input{5G mmWave Positioning/c_3}\label{beampair_delay}}
\caption{Channel estimation results for the vehicle trajectory in Fig.~\ref{fig:google_map}. (a) Beamspace channel matrix of a single measurement at location P2 with LOS and NLOS paths; (b) Delay estimations of the LOS path from two arrays (including clock bias, repeated 3 times).}
\label{fig:channel_estimation}
% \vspace{-5mm}
\end{figure}

\subsubsection{BS calibration}
After the implementation of the channel estimator on all received measurements, we first take all measurements for the \ac{bs} calibration purpose and apply the \ac{bs} calibration algorithm described in Section \ref{sec:bs_cal}. The calibrated \ac{bs} results are summarized in Table \ref{tab:bs_cal}, compared with the provided "ground truth". The calibrated 3D \ac{bs} position is $[0.78~\mathrm{m},0.73~\mathrm{m},18.66~\mathrm{m}]^{\textsf{T}}$ and calibrated Euler angle is $[1.25^\circ,9.92^\circ,73.45^\circ]^{\textsf{T}}$, while the uncalibrated position and orientation are $[0,0,21~\mathrm{m}]^{\textsf{T}}$ and  $[0,12^\circ,69^\circ]^{\textsf{T}}$, respectively. From the result, we observe that the provided \ac{bs} state gives a relatively good x-y position, but a relatively bad orientation and height, which is due to the orientation are relatively hard to measure when deployed and there was no explicit surveying of the site performed before. Moreover, we only know the radio tower is approximately 21 meters, but its global reference height is unknown. These biases can result in positioning errors.
\begin{table}[t]
    \centering
    \caption{The comparison between the calibrated \ac{bs} state and the uncalibrated \ac{bs} state.}
        \begin{tabular}{ |c|c|c| } 
         \hline
           State & Before calibration  & After calibration  \\ \hline 
         Position & $[0,0,21~\mathrm{m}]^{\textsf{T}}$ & $[0.78~\mathrm{m},0.73~\mathrm{m},18.66~\mathrm{m}]^{\textsf{T}}$
         \\ 
         Orientation  & $[0,12^\circ,69^\circ]^{\textsf{T}}$ & $[1.25^\circ,9.92^\circ,73.45^\circ]^{\textsf{T}}$  
         \\
         \hline
        \end{tabular} 
    \label{tab:bs_cal}
\end{table}

%We  implemented the \ac{bs} positioning algorithm on the channel estimates of the real measurements. We recall that since the UE and BS are not synchronized, the LOS path only provides information via the AOA and AOD. We find that the overall error is $24.82~\mathrm{m}$, based on the measurements from P1 and P2 in Fig.~\ref{fig:meaEnv}. This is because %that the delay cannot be used due to the serious clock drift, no resolution on \ac{AOA} elevation is provided, and  measurements are from two 2 different \ac{ue} locations. although there are 20 measurements in total, they are from only 2 different locations, hence measurements from the same locations are highly correlated. Only knowing the BS direction with respect to the two different UE locations, the \ac{bs} location is found by the intersection point of the two corresponding lines, which is sensitive to the angle errors, especially at a long distance. 

We now evaluate the benefits of the \ac{bs} calibration. We assume the height of the  \ac{ue} is known, and apply the positioning algorithm described as \eqref{positioning_unsyn} on the channel estimation results given the calibrated and uncalibrated \ac{bs} states, respectively, as shown in Fig.~\ref{fig:2D_cali}. Since the UE height is known, only the AOD is used. 
From the figure, we find that better positioning performance can be acquired when using the calibrated \ac{bs} state, as the solid line is always on the left side of the dashed line. This is because the positioning algorithms highly depend on the \ac{bs} state, and the biases of the \ac{bs} state lead to positioning errors, which are especially sensitive to the angle errors at a long distance and a small bias can cause a significant error. By using the calibrated \ac{bs} state, the positioning algorithm using only LOS can get below-5-meter accuracy with 88.3\% and  below-10-meter accuracy with 94.8\%, if the UE height is given.



\begin{figure}
\centering
\input{Figures_without_ESPRIT/error_los_2D.tex}
\caption{\acp{CDF} of errors on the x-y plane of the LOS-only positioning algorithm using \ac{AOD} measurements assuming UE height is known, given the calibrated or uncalibrated \ac{bs} states.}
\label{fig:2D_cali}
% \vspace{-5mm}
\end{figure}

\subsubsection{\ac{los} positioning}
After the \ac{bs} calibration, we then implement the \ac{los} positioning algorithm, described in Section \ref{los_localization}, on the channel estimation results of the measurements for the positioning purpose. To emulate RTT measurements, we remove a fixed clock bias from all the measurements and rely on the external rubidium clock to maintain a stable clock at the UE. 
{We only show the results on the x-y domain and the results on height estimates are omitted; as in a vehicular scenario, all vehicles move on the ground and the x-y position is more important than the height. However,  errors on the height follow similar tendencies as errors on the x-y domain.} We apply the positioning algorithm using experimental \ac{rtt} and \ac{AOD}, described as \eqref{positioning_syn} and the positioning algorithm using experimental \ac{rtt}, \ac{AOD} and \ac{AOA}, described as \eqref{LS_pos_ideal}, compared with the performance of the positioning algorithm using experimental \ac{AOD} and ground-truth UE height, and results are as solid lines shown in Fig.~\ref{fig:3D_los_without_esprit}. We observe that the performance of the algorithm using \ac{rtt} and \ac{AOD} is not as good as the performance of the algorithm using \ac{AOD} and ground-truth UE height, as below-10-meter accuracy is only 62.4\%, compared with 94.8\% using experimental \ac{AOD} and ground-truth UE height. 
{This degradation is due to the relatively poor RTT estimates, as seen in Fig.~\ref{fig:CE02}, which exhibit a \ac{MAE} of the estimated \ac{los} propagation distance of around 9.8 m. The error is attributed to a combination of clock instability, insufficient resolution of the beam sweeping channel estimation, as well so that inter-path interference due to limited resolution.} 
We can get better positioning performance than the algorithm using \ac{rtt} and \ac{AOD} when  also  \ac{AOA} is included, as the solid yellow line is always on the left side of the solid red line and the below-10-meter accuracy is 88.5\%. The reason is that more information is provided by the \ac{AOA}. However, it performs worse than the algorithm using  \ac{AOD} and ground-truth UE height, as the solid yellow line is on the right side of the solid blue line. The reason is that the unknown height adds one additional degree of freedom to the state, combined with the aforementioned RTT errors. To remove the impact of the delay measurements,  we  replace the experimental \ac{rtt} with synthetic measurements, which are generated by adding noise with $1~\mathrm{m}$ standard deviation to the ground truth propagation distances. The results of positioning algorithms using a mix of experimental and synthetic data are displayed as dashed lines in Fig.~\ref{fig:3D_los_without_esprit}, compared with the result when using pure experimental data. The more accurate RTT helps positioning algorithms to achieve better positioning performances, as the dashed lines are all on the left side of the solid lines, and the combination of synthetic RTT, AOD and AOA provides around 1.71 m positioning accuracy with 90\% of cases. Such performance levels can possibly be attained by high-resolution estimators. 
%Therefore, 
%
%\Yu{we can try to better solve the clock instability problem to get more accurate \ac{rtt}, as well as provide high-resolution channel estimators in the future}.
\begin{comment}
\begin{figure}
\centering
\input{Figures/error_los_more_mea.tex}
\caption{\acp{CDF} of errors on x-y plane of the three \ac{los} positioning algorithms.}
\label{fig:3D_los}
% \vspace{-5mm}
\end{figure}
\end{comment}

\begin{figure}
\centering
\input{Figures_without_ESPRIT/error_los_more_mea_delta1.tex}
\caption{\acp{CDF} of errors on the x-y plane of the three \ac{los} positioning algorithms different combinations of information, where "AOD+$z_{\text{UE},k}$" represents \eqref{positioning_unsyn}, "RTT+AOD" represents \eqref{positioning_syn}, "RTT+AOD+AOA" represents \eqref{LS_pos_ideal}. All methods use experimental data, except RTT(S), which uses synthetic RTT measurements.}
\label{fig:3D_los_without_esprit}
% \vspace{-5mm}
\end{figure}



%Fig.~\ref{fig:2dbeamrefine} shows the \ac{los} positioning algorithm utilizing \ac{TOA}, and all \ac{AOA} and \ac{AOD} angles (see \eqref{LS_pos_ideal}), where the \ac{ue} orientation is assumed to be known and given by given by the GPS. From the figure, 






\begin{comment}
All \ac{nlos} paths are not used before, we start to consider \ac{nlos} paths from now on. However, \ac{nlos} paths are not always visible at all \ac{ue} locations, as these paths are too weak to be resolved when the \ac{ue} are far away from landmarks. Therefore, we randomly set some \acp{VA} at reasonable locations in the testing space, where \acp{VA} are  well separated, not close to the \ac{bs}, and not able to block any \ac{los} and \ac{nlos} paths. We artificially generate  \ac{nlos} paths based on the ground-truth \ac{ue} states and the \acp{VA} locations using
\eqref{measurment_model}, where each \ac{VA} only create one paths and the \ac{IP} is the intersection point of the line of \ac{ue} and \ac{VA} on the surface. Then the \ac{los} and \ac{nlos} positioning algorithm (see \eqref{pos_least_square}) is implemented on the \ac{los} paths provided by the channel estimator and generated \ac{nlos} paths. The performances are summarized in Fig.~\ref{fig:3D_nlos_gen}, compared with the performance of the \ac{los} positioning algorithm with all dimensions of measurement. Fig.~\ref{fig:3D_nlos_gen} demonstrates that the better positioning performance can be  acquired with the help of the \ac{nlos} paths, and the more \ac{nlos} paths are available, the better performance we can get, as the dashed lines are all on the left side of the solid yellow line and the left lines are always with more \ac{nlos} paths. After getting all the \ac{ue} locations, we then apply the mapping algorithm to get \acp{IP}, which are further clustered by the \ac{DBSCAN} algorithm with  $\epsilon=10~\text{m}$ and $N_{\min}=5$, and a \ac{VA} is estimated for each cluster. The \ac{MAE} of all estimated \acp{VA} are $4.69~\mathrm{m}$, $4.05~\mathrm{m}$ and $3.38~\mathrm{m}$ when there are one, two, and five \acp{VA} in the environment, respectively. It is clear that we can achieve better mapping performance with more \ac{nlos} paths. This is because, with the help of more \ac{nlos} paths, better \ac{ue} locations can be estimated, which can benefit the mapping algorithm in turn. 


\begin{figure}
\centering
\input{Figures/error_nlos_syn_gen.tex}
\caption{\acp{CDF} of errors on x-y plane of the positioning algorithm \eqref{pos_least_square} using \ac{los} paths provided by the channel estimator and \ac{nlos} paths generated from different number of \acp{VA}.}
\label{fig:3D_nlos_gen}
% \vspace{-5mm}
\end{figure}
\end{comment}

\subsubsection{\ac{los} and \ac{nlos} positioning and mapping}
In the previous sections, we have not considered \ac{nlos} paths, and we start to consider \ac{nlos} paths from now on. However, \ac{nlos} paths are not always visible at all \ac{ue} locations, as these paths are too weak to be resolved when the \ac{ue} are far away from landmarks. %As not all \ac{ue} locations have clear \ac{nlos} paths, 
We picked 20 points where some \ac{nlos} paths can be clearly observed. Then the \ac{los} and \ac{nlos} positioning algorithm (see \eqref{pos_least_square}) are implemented at these points and its performance is evaluated by the \ac{MAE} of the x-y plane, which is on average $3.98~\text{m}$ compared with $4.86~\text{m}$ when only \ac{los} paths are used for these points. The better positioning performance is acquired due to the help of the \ac{nlos} paths. After getting the estimated \ac{ue} positions, we then apply the mapping algorithm to get \acp{IP}. Fig.~\ref{fig:nlos_lam} summarizes the results of \ac{los} and \ac{nlos} positioning and mapping algorithm for the selected points. From Fig.~\ref{fig:nlos_lam}, we can see that the algorithm can localize the \ac{ue} even though there are some errors, as the blue crosses are close to blue circles. \acp{IP} of all \ac{nlos} are recovered by \eqref{initialization}, shown as red crosses in Fig.~\ref{fig:nlos_lam}. Although we do not have the ground truth of the \acp{IP}, 
the locations of these points in the ground-truth map are reasonable, which are on the surfaces of the buildings. From \acp{IP}, we can know where the surfaces are. Therefore, both positioning and mapping are achieved by utilizing the \ac{los} and \ac{nlos} paths. There are only a few \acp{IP} and only one surface can be mapped, shown as the magenta circle, which is because we do not have enough \ac{nlos} paths. However, if we could observe more \ac{nlos} paths, more landmarks can be mapped. However, this is for the synchronized case where the clock bias is known, we also implement the algorithms for the asynchronized case, as shown in Fig.~\ref{fig:nlos_lam_unsyn}. The positioning and mapping results are not good, because there is only one \ac{nlos} observed at each time point. Clock bias gets very large estimation error, as a few degrees errors in angles make large errors on bias estimation, which further leads to bad positioning and mapping permanence. %If the known the \acp{IP}, we can also implement \eqref{pos_bias_least_square_knowmap} to get the \ac{ue} position and clock bias. We then use the \acp{IP} in Fig.~\ref{fig:nlos_lam} to do this work, and the results are shown in Fig.~\ref{fig:nlos_lam_unsyn_knownmap}. We find noticeable errors in the estimations, which is due to the estimation of \acp{IP} are not good. Together with the \ac{los} path, only two paths can easily get very large errors on the joint state of \ac{ue} position and clock bias.

\begin{figure}
    \centering
    \includegraphics[width=0.6\linewidth]{Figures_without_ESPRIT/nlos_lam_noVA.pdf}
    \caption{The visualization of the result of the \ac{los} and \ac{nlos} positioning and mapping algorithm evaluated at the selected 20 points where \ac{nlos} can be resolved if the clock bias is known.}
    \label{fig:nlos_lam}
\end{figure}
%\subsubsection{\ac{los} and \ac{nlos} mapping}
%\begin{figure}
%\centering
%\input{Figures/error}
%\caption{The CDF of errors for under different settings, and w.cal. represents with BS calibration, and w.o.cal represents without BS calibration.}
%\label{fig:cur_set}
% \vspace{-5mm}
%\end{figure}


\begin{figure}
    \centering   \includegraphics[width=0.6\linewidth]{Figures_without_ESPRIT/nlos_lam_noVA_unsyn.pdf}
    %\vspace{-3mm}
    \caption{The visualization of the result of the \ac{los} and \ac{nlos} positioning and mapping algorithm evaluated at the selected 20 points where \ac{nlos} can be resolved if the clock bias is unknown.}
\label{fig:nlos_lam_unsyn}
\end{figure}


\begin{comment}


\begin{figure}
    \centering   \includegraphics[width=\columnwidth]{Figures_without_ESPRIT/nlos_lam_noVA_unsyn_knownmap.pdf}
    \caption{The visualization of the result of the \ac{los} and \ac{nlos} positioning and mapping algorithm evaluated at the selected 20 points where \ac{nlos} can be resolved if the \acp{IP} are known and the clock bias is unknown.}
\label{fig:nlos_lam_unsyn_knownmap}
\end{figure}
\end{comment}

\section{Conclusions} \label{Conclusions}
5G mmWave signals are useful for \ac{ue} positioning for intelligent transport, due to the increased spatial and temporal resolution, compared to sub-6 GHz signals. Current solutions are based on using several \acp{bs} to determine the UE location, which poses significant demands in terms of 5G infrastructure. In this paper, we evaluated, through real-world demonstration, the ability to localize a \ac{ue} by a single \ac{bs}, operating according to the current release of the 3GPP standard. By virtue of the high resolvability, we also show the ability to map the environment and thus operate as a bistatic sensing system.
We have detailed the hardware used for the real tests, including a commercial mmWave \ac{bs} and a vehicle-mounted cellular receiver combined with an RTK-enabled GNSS receiver as ground truth. We have also described the considered low-complexity channel estimation algorithms to process the received measurements, and proposed a \ac{bs} calibration algorithm, as well as positioning algorithms using only \ac{los} paths, and  a positioning and mapping algorithm using \ac{los} and \ac{nlos} paths. Via real-life data, we demonstrated that \ac{ue} positioning is feasible with a single BS. One of the main findings is that positioning based on multipath TDOA exploitation is sensitive to the environment geometry and may lead to poor positioning results. Positioning based on RTT, on the other hand, leads to good performance (below 2-meter error), provided AOA, AOD, and simulated RTT information is used. Correspondingly, environment mapping with RTT exhibits far better performance compared to based on multipath TDOA. Another important finding is that BS calibration is of high importance, not least in terms of the BS antenna panels, if downlink-AOD or uplink-AOA information is to be used. Such calibration is generally not needed for communication but is critical for positioning.
Overall, the results indicate that there is still a significant gap between theory and practice, which is ascribed to the combined effect of (i) BS calibration; (ii) synchronization errors; (iii) limited angular resolution in elevation, especially at the UE side; and (iv) limited knowledge of the used beam-patterns. If all these effects are mitigated, we foresee that sub-meter accuracy is attainable with a single BS. The inclusion of optimized signal design (precoding and combining) to boost the positioning accuracy, and the extension to a \ac{slam} problem where the UE motion model  is expected to further improve the positioning accuracy.




%5G mmWave signals are useful for \ac{ue} positioning and environment mapping. We did real-life tests to evaluate the possibility and the accuracy of the positioning and mapping using 5G mmWave downlink signals with a single \ac{bs}  according to the current release of the 3GPP standard. In this paper, we have introduced hardware details about the  5G single base-station positioning and mapping system we used for the real tests, including a standard commercial \ac{bs} and a vehicle-mounted cellular receiver combined with an RTK-enabled GNSS receive. We have also described the proposed channel estimation algorithms to process the received measurements, and displayed the proposed \ac{bs} calibration algorithm, positioning algorithms using only \ac{los} paths, and  positioning and mapping algorithm using \ac{los} and \ac{nlos} to achieve positioning and mapping. Via real-life data, we demonstrated that good \ac{ue} positioning performance can be acquired using only \ac{los} paths, which can be further improved if the synchronization problem is better solved. Our results also demonstrated that with the help of \ac{nlos} paths, a better positioning performance can be acquired and it is also possible to map the surrounding environment. %The more \ac{nlos} paths are available, the better positioning and mapping performances can be be achieved.

%Based on the results, we will conduct a future project, which will include better solving the synchronization problem, changing antenna patterns to have better spatial resolutions, the use of high-dimensional channel estimation to provide more accurate and precise channel estimations and extract more \ac{nlos} paths, the inclusion of optimized signal design (precoding and combining) to boost the positioning accuracy, and the extension to a \ac{slam} problem where the motion model of the \ac{ue} is considered.

%\begin{table*}[ht]
%\centering
%\begin{tabular}[width=0.75\linewidth]{ |c|c|c|c|c|c|c|c|c|c|c| } 
        % \hline
         %Tasks & Lead & week 40  & week 41 & week 42 & week 43 & week 44 & week 45 & week 46 & week 47 & week 48  \\ \hline 
        % Meeting and assign tasks & Yu & $\checkmark$ & & & & & & & &
        % \\ \hline 
     %    Write BS   & Ericsson? &  &$\checkmark$ & $\checkmark$ & & & & & &
    %     \\\hline 
    %     Write UE   & Lund \& Qamcom? & & $\checkmark$ &$\checkmark$ & & & & & &
   %      \\ \hline 
   %      Write GPS  & Veoneer? & & $\checkmark$ &$\checkmark$ & & & & & &
   %      \\\hline 
   %      Provide better MPCS  & Hedieh & &$\checkmark$ &$\checkmark$ &$\checkmark$ & $\checkmark$& & & &
   %      \\\hline 
   %      Write channel estimation  & Hedieh (Chalmers helps)  & & &$\checkmark$ &$\checkmark$ & $\checkmark$& & & &
   %      \\\hline 
   %      Work on code & Yu &$\checkmark$ &$\checkmark$ & $\checkmark$& $\checkmark$ &$\checkmark$ & & & &
   %      \\\hline 
   %      Write down algorithms & Yu & & &  & $\checkmark$ &$\checkmark$ & & & &
   %      \\\hline 
   %      Results \& conclusion  & Yu & & & & & $\checkmark$ & $\checkmark$& & &
         %\\\hline 
         %Introduction \& abstract  & Henk, Fredrik & & & & & $\checkmark$ & %$\checkmark$ & & &
         %\\ \hline 
         %Review & All authors & & & & & & %& $\checkmark$ & $\checkmark$ &  
         %\\\hline 
         %Edit & Yu & & & & & & &  & %$\checkmark$ &   $\checkmark$
         %\\\hline 
         %Submit  & Yu & & & & & & & & & %$\checkmark$ 
%         \\
%         \hline
%        \end{tabular}
%\end{table*}

% use section* for acknowledgment
%{
%\section*{Acknowledgment}
%This work was partially supported by the Vinnova 5GPOS project under grant 2019-03085, by the Swedish Research Council under grant 2018-03705, and by the Wallenberg AI, Autonomous Systems and Software Program (WASP) funded by Knut and Alice Wallenberg Foundation.
%}
\appendices
\section{Geometric Relationships}\label{GeometricRelationships}
Within the geometric relationship $\boldsymbol{h}(\boldsymbol{s}_{k},\boldsymbol{s}_{\text{BS}},\boldsymbol{p}_{\text{IP},k}^{i} )$, the \ac{TOA} $\tau_{k}^{i}$ is determined by the propagation distance and the clock bias $b_{k}$, given by
\begin{align}
    \tau_{k}^{i} = \begin{cases} ||\boldsymbol{p}_{\text{BS}}-\boldsymbol{p}_{\text{UE},k}||/c + b_{k} & i=0 \\  ||\boldsymbol{p}_{\text{IP},k}^{i}-\boldsymbol{p}_{\text{UE},k}||/c + ||\boldsymbol{p}_{\text{IP},k}^{i}-\boldsymbol{p}_{\text{BS}}||/c +b_{k} & i\neq0\end{cases} \label{delay},
\end{align}
with $c$ denoting the speed of light, which is prior known. The \ac{AOA} $\boldsymbol{\theta}_{k}^{i}$ is determined by the arrival direction of the signal at the receiver $\boldsymbol{q}_{\text{AOA},k}^{i}$, and have components
\begin{align}
    &\theta_{\text{az},k}^{i} = \mathrm{arctan2}([\boldsymbol{q}_{\text{AOA},k}^{i}]_{2},[\boldsymbol{q}_{\text{AOA},k}^{i}]_{1}),\label{AOAAZ}\\
    &\theta_{\text{el},k}^{i} = \arcsin([\boldsymbol{q}_{\text{AOA},k}^{i}]_{3},||\boldsymbol{q}_{\text{AOA},k}^{i}||).\label{AOAEL}
\end{align}
The arrival direction of the signal $\boldsymbol{q}_{\text{AOA},k}^{i}$ is considered in the local coordinate system of the receiver so that it can be calculated by 
\begin{align}
 \boldsymbol{q}_{\text{AOA},k}^{i} = \begin{cases} \boldsymbol{R}_{\text{UE},k}(\boldsymbol{p}_{\text{BS}}-\boldsymbol{p}_{\text{UE},k}) & i=0 \\ \boldsymbol{R}_{\text{UE},k}(\boldsymbol{p}_{\text{IP},k}^{i}-\boldsymbol{p}_{\text{UE},k}) & i\neq0\end{cases}.
\end{align}
where $\boldsymbol{R}_{\text{UE},k}$ is the rotation matrix from the global reference coordinate system to the local coordinate system of the \ac{ue} \ac{URA} at time step $k$, determined by $\boldsymbol{\psi}_{\text{UE},k}$ as \cite{blanco2010tutorial}
\begin{align}
    &\boldsymbol{R}_{\text{UE},k} = \left[ \begin{matrix} \cos \gamma_{\text{UE},k} & -\sin \gamma_{\text{UE},k} & 0 \\ \sin \gamma_{\text{UE},k} &\cos \gamma_{\text{UE},k} & 0 \\ 0 & 0 & 1 \end{matrix}\right]  \label{eq:Euler2Rot} \left[ \begin{matrix} \cos \beta_{\text{UE},k} &0& \sin \beta_{\text{UE},k}  \\ 0 &1&0\\-\sin \beta_{\text{UE},k} &0&\cos \beta_{\text{UE},k}\end{matrix}\right] \left[ \begin{matrix} 1 &0 & 0 \\ 0 &\cos \alpha_{\text{UE},k} & -\sin \alpha_{\text{UE},k}  \\ 0 & \sin \alpha_{\text{UE},k} &\cos \alpha_{\text{UE},k}\end{matrix}\right], 
\end{align}
then, $\boldsymbol{R}_{\text{UE},k}^{\textsf{T}}$ denotes the rotation matrix from the local coordinate system to the global reference by definitely. Similarly, the \ac{AOD} $\boldsymbol{\phi}_{k}^{i}$ is determined by the arrival direction of the signal at the transmitter $\boldsymbol{q}_{\text{AOD},k}^{i}$, and have components
\begin{align}
    &\phi_{\text{az},k}^{i} = \mathrm{arctan2}([\boldsymbol{q}_{\text{AOD},k}^{i}]_{2},[\boldsymbol{q}_{\text{AOD},k}^{i}]_{1}),\label{AODAZ}\\
    &\phi_{\text{el},k}^{i} = \arcsin([\boldsymbol{q}_{\text{AOD},k}^{i}]_{3},||\boldsymbol{q}_{\text{AOD},k}^{i}||),\label{AODEL}
\end{align}
where $\boldsymbol{q}_{\text{AOA},k}^{i}$ is considered in the local coordinate system of the transmitter, given by
\begin{align}
    \boldsymbol{q}_{\text{AOD},k}^{i} = \begin{cases} \boldsymbol{R}_{\text{BS}}(\boldsymbol{p}_{\text{UE},k}-\boldsymbol{p}_{\text{BS}}) & i=0 \\ \boldsymbol{R}_{\text{BS}}(\boldsymbol{p}_{\text{IP},k}^{i}-\boldsymbol{p}_{\text{BS}}) & i\neq0\end{cases},
\end{align}
with $\boldsymbol{R}_{\text{BS}}$ denoting the rotation matrix from the global reference coordinate system to the local coordinate system of the \ac{bs} \ac{URA}, which is determined by $\boldsymbol{\psi}_{\text{BS}}$ as  % denoted by %\cite{blanco2010tutorial}
\begin{align}
    &\boldsymbol{R}_{\text{BS}} = \left[ \begin{matrix} \cos \gamma_{\text{BS}} & -\sin \gamma_{\text{BS}} & 0 \\ \sin \gamma_{\text{BS}} &\cos \gamma_{\text{BS}} & 0 \\ 0 & 0 & 1 \end{matrix}\right] \left[ \begin{matrix} \cos \beta_{\text{BS}} &0& \sin \beta_{\text{BS}}  \\ 0 &1&0\\-\sin \beta_{\text{BS}} &0&\cos \beta_{\text{BS}}\end{matrix}\right] \left[ \begin{matrix} 1 &0 & 0 \\ 0 &\cos \alpha_{\text{BS}} & -\sin \alpha_{\text{BS}}  \\ 0 & \sin \alpha_{\text{BS}} &\cos \alpha_{\text{BS}}\end{matrix}\right],
\end{align}
and $\boldsymbol{R}_{\text{BS}}^{\textsf{T}}$ is the rotation matrix from local coordinate system of the \ac{bs} to the global reference by definition.


\balance 
\bibliography{IEEEabrv,Bibliography}


% trigger a \newpage just before the given reference
% number - used to balance the columns on the last page
% adjust value as needed - may need to be readjusted if
% the document is modified later
% \IEEEtriggeratref{7}
% The "triggered" command can be changed if desired:
% \IEEEtriggercmd{\enlargethispage{-20cm}}

% references section

% can use a bibliography generated by BibTeX as a .bbl file
% BibTeX documentation can be easily obtained at:
% http://mirror.ctan.org/biblio/bibtex/contrib/doc/
% The IEEEtran BibTeX style support page is at:
% http://www.michaelshell.org/tex/ieeetran/bibtex/
%\bibliographystyle{IEEEtran}
% argument is your BibTeX string definitions and bibliography database(s)
%\bibliography{IEEEabrv,../bib/paper}
%
% <OR> manually copy in the resultant .bbl file
% set second argument of \begin to the number of references
% (used to reserve space for the reference number labels box)







% that's all folks
\end{document}


