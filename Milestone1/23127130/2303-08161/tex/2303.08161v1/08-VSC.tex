% !TEX root = main.tex

\section{Value Substitution Calculus}
\label{sect:vsc}
\input{figures/figure-vsc} 
%Among the many extensions of Plotkin's calculus, Accattoli and Paolini's \emph{value substitution calculus} \cite{accattoli+paolini-vsc} (abbreviated as VSC) has a special place. It was conceived as a graph-free presentation of linear logic proof nets for the \cbv $\l$-calculus by Accattoli \cite{Accattoli-proofnets}, it was used to study reasonable time for \cbv by Accattoli et al. \cite{DBLP:conf/lics/AccattoliCC21}, and to refine the understanding of meaningless terms in \cbv by Accattoli and Guerrieri \cite{DBLP:journals/pacmpl/AccattoliG22}. Additionally, Accattoli and Guerrieri  relate it to three other extensions of Plotkin's calculus, among which the mentioned shuffling calculus, and prove that they are all equivalent with respect to the study of termination \cite{accattoli+guerrieri-opencbv}.

Intuitively, the VSC is a \cbv $\lambda$-calculus extended with $\letexp$-expressions, as is common for \cbv $\l$-calculi such as \citeauthor{DBLP:conf/lics/Moggi89}'s one [\citeyear{Moggi88tech,DBLP:conf/lics/Moggi89}]. 
We do however replace a $\letexp$-expression $\letin\var\tmtwo\tm$ with a more compact  \emph{explicit substitution} (ES for short) notation $\tm\esub{\var}{\tmtwo}$, which binds $\var$ in $\tm$ and that has precedence over abstraction and application (that is, $\la\var\tm\esub\vartwo\tmtwo$ stands for $\la\var(\tm\esub\vartwo\tmtwo)$ and $\tm\tmthree\esub\vartwo\tmtwo$ for $\tm(\tmthree\esub\vartwo\tmtwo)$). Moreover, our $\letexp$/ES does not fix an order of evaluation between $\tm$ and $\tmtwo$, in contrast to many papers in the literature (\eg \citet{DBLP:journals/toplas/SabryW97,DBLP:journals/iandc/LevyPT03}) where $\tmtwo$ is evaluated first.

The reduction rules of VSC are slightly unusual as they use \emph{contexts} both to allow one to reduce redexes located in sub-terms, which is standard, \emph{and} to define the redexes themselves, which is less standard---these kind of rules is %sometimes 
called \emph{at a distance}. The rationale behind is that the rewriting rules are designed to mimic exactly cut-elimination on linear logic proof nets, via Girard's \cite{DBLP:journals/tcs/Girard87} \cbv translation $(A \Rightarrow B)^v = ! (A^v \multimap B^v)$ of intuitionistic logic into linear logic, see \citet{Accattoli-proofnets}.  


\paragraph{Root rewriting rules}
In VSC, 
there are two main rewrite rules, the \emph{multiplicative} one $\tom$ and the \emph{exponential} one $\toe$ (the terminology comes from the connection between VSC and linear logic), and both work \emph{at a distance}: they use contexts even in the definition of their \emph{root} rules (that is, before the contextual closure). Their definition is based on \emph{substitution contexts} $\sctx$, which are lists of~ES. 
In \Cref{fig:vsc}, the root rule $\rtom$ (resp. $\rtoe$) is assumed to be capture-free, so no free
 variable of $\tmtwo$ (resp. $\tm$) is captured by the substitution context $\sctx$ (by possibly $\alpha$-renaming on-the-fly). 


Examples: $(\la\var\vartwo)\esub\vartwo\tm\tmtwo \rtom \vartwo\esub\var\tmtwo\esub\vartwo\tm$ and $(\la\varthree\var\var)\esub\var{\vartwo\esub\vartwo\tm} \rtoe (\la\varthree\vartwo\vartwo)\esub\vartwo\tm$. An example with on-the-fly $\alpha$-renaming is $(\la\var\vartwo)\esub\vartwo\tm\vartwo \rtom \varthree\esub\var\vartwo\esub\varthree\tm$.

A key point is that $\beta$-redexes are decomposed via ES: the \emph{by-value} restriction is on ES-redexes, \emph{not} on $\beta$-redexes, because only values can be substituted.
The multiplicative rule
$\rtom$ fires a $\beta$-redex at a distance and generates an  ES even when the argument is not a value.
	The \cbv discipline is entirely encoded in the exponential rule $\toe$ (see \Cref{fig:vsc}): it can fire an  ES performing a substitution only when its argument is a \emph{value} (\ie a variable or an abstraction) up to a list of ES. This means that only values can be duplicated or erased.
It is useful to split the exponential root rule $\rtoe$ in twoÂ disjoint rules, depending on whether it is an abstraction (rule $\rtoeabs$) or a variable ($\rtoevar$) that it is substituted. 

\paragraph{Rewriting Rules} We close the root rules by evaluation contexts $\evctx$, which allow reduction everywhere but under abstractions. In other papers about the VSC \cite{accattoli+paolini-vsc,accattoli+guerrieri-opencbv,DBLP:conf/lics/AccattoliCC21,DBLP:journals/pacmpl/AccattoliG22}, where other contextual closures are also considered, they are called \emph{weak} or \emph{open} contexts. We consider both the reduction that includes the substitution of variables $\toevar$, noted $\tovsc$, and the one that does not, noted $\tovscp$ (note that $\tovscp \,=\, \tovsc\smallsetminus \toevar$) where $\symfont{p}$ stands for \emph{practical} because it is in implementations of \cbv that variables cannot be substituted, see \citet{DBLP:journals/iandc/AccattoliC17}.  Examples:
\begin{align*}
		\tm \esub\var{(\la\vartwo\tmtwo)\esub\varthree\tmthree \tmfour}
		& \tom \tm \esub\var{\tmtwo\esub\vartwo\tmfour\esub\varthree\tmthree}
		&
		\tm (\var\var) \esub\var{\vartwo\esub\varthree\tmtwo} & \toevar\! \tm (\vartwo\vartwo)\esub\varthree\tmtwo
		\\[-2pt]
		((\var\var) \esub\var{\la\vartwo\varthree} \tm)\esub\varfour\tmtwo 
		& \toeabs\! ((\la\vartwo\varthree) (\la\vartwo\varthree) \tm)\esub\varfour\tmtwo
		&
		\la\varthree (\var\var) \esub\var{\la\vartwo\varthree} & \not\toeabs\!  \la\varthree(\la\vartwo\varthree) \la\vartwo\varthree
\end{align*}

\paragraph{Diamond} Both $\tovsc$ and $\tovscp$ are non-deterministic, as for instance:
\begin{center}
$\delta (\delta \Id) \ \lRew{\expoabs}\  \vartwo\esub\vartwo\delta (\delta \Id) \ \tom \ \vartwo\esub\vartwo\delta((\var\var)\esub\var\Id).$
\end{center}
They are however more than confluent, they are diamond.
\begin{proposition}[Diamond \cite{DBLP:journals/pacmpl/AccattoliG22}]
\label{prop:vsc-diamond}
Let $a\in\set{\vscsym,\vscpsym}$. Then $\Rew{a}$ is diamond.
\end{proposition}
%The diamond property is a strong form of confluence (note that it holds for \emph{steps}, rather than \emph{sequences}, which is stronger) with relevant consequences. Firstly, it implies confluence. Secondly, it means that non-determinism is only apparent, because if an $\Rew{a}$-reduction sequence from $\tm$ reaches
%a $a$-normal form $\tmtwo$, then \emph{every} $\Rew{a}$-sequence from $\tm$ eventually ends in $\tmtwo$;
%and all these sequences have the \emph{same length} and \emph{same number} of $\msym$-steps and $\esym$-steps. Such a \emph{length invariance} shall be crucial for the proof of compatibility for the similarities of the next sections.

\paragraph{Irrelevance of $\toevar$} Splitting $\toe$ in $\toeabs$ and $\toevar$ is motivated by the fact that the removal of $\toevar$ does not alter the rewriting properties of the calculus, that is, $\toevar$ is postponable and the removal does not change the notion of termination, what Accattoli and Guerrieri deem (operational) \emph{irrelevance} \cite{DBLP:journals/pacmpl/AccattoliG22}. Removing $\toevar$, however, does change the equational theory, thus $\toevar$ shall be relevant for us. More precisely, at first we shall remove it, to present a simplified version of similarity for the VSC, and then we shall re-introduce it.

\begin{proposition}[$\toevar$ postponement, \cite{DBLP:journals/pacmpl/AccattoliG22}]
If $\tm \tovsc^* \tmtwo$ then there exists $\tm \tovscp^*\tmthree\toevar^* \tmtwo$. Moreover, $\tm$ is $\tovsc$-terminating if and only if it is $\tovscp$-terminating.
\end{proposition}

Actually, the reduction $\tovscp$ without $\rtoevar$ has stronger properties. In particular, it admits a neat inductive description via \emph{inert terms}, as we now explain.

\paragraph{Inert Terms and Normal Forms} 
\cbv is about \emph{values}, and, if terms are closed, normal forms are abstractions. In going beyond the closed setting,  a finer and more general view is required. First, normal forms (for $\tovscp$) are given by mutual induction with the notions of \emph{inert term}, as in \Cref{fig:vsc}. 
Second, variables are \emph{both} values and inert terms. This is on purpose, because they have the properties of both kinds of term.

Examples: $\la\var\vartwo$ is a normal form 
as an abstraction, while $\vartwo(\la\var\var)$, $\var\vartwo$, and $(\varthree(\la\var\var))(\varthree\varthree) (\la\vartwo(\varthree\vartwo))$ are normal forms as inert terms. The grammars also allow to have ES containing inert terms around abstractions and applications: $(\la\var\vartwo)\esub\vartwo{\varthree\varthree}$ is a fireball and $\var\esub\var{\vartwo(\la\var\var)}\vartwo$ is an inert term. One of the key points of inert terms is that they have a \emph{free} head variable (in particular they are open). In  
\cite{DBLP:conf/icfp/GregoireL02}, inert terms are called \emph{accumulators}, and normal forms are  called \emph{values}. In some papers about the VSC, normal forms are called \emph{fireballs}.

 Note that $\var\esub\var\vartwo$ is an inert term and it is not $\toevar$ normal, thus not $\tovsc$ normal. Normal forms for $\tovsc$ are a slightly stricter subset of $\tovscp$-normal forms (they cannot have ES of shape $\esub\var{\sctxp\vartwo}$), with a similar but less neat description that shall be given in \refsect{net}.

\begin{proposition}[Normal forms \cite{DBLP:journals/pacmpl/AccattoliG22}]
$\tm$ is $\tovscp$-normal if and only if $\tm$ is a $\ntm$-term as defined in \Cref{fig:vsc}. 
		If $\tm$ is $\tovsc$-normal then it is a $\ntm$-term.
\end{proposition}


\paragraph{\cbv Scrutability} One of the features of the VSC is that it solves the issues of Plotkin's calculus with respect to \cbv scrutability. Consider the term $\Omega^L =  (\la\var\delta)(\vartwo\varthree)\delta$ which is inscrutable and contextual equivalent to $\Omega$ but normal for Plotkin. In the VSC, instead, it diverges:
\begin{center}
$ (\la\var\delta)(\vartwo\varthree)\delta \tom \delta \esub\var{\vartwo\varthree}\delta \tom \varfour\varfour\esub\varfour\delta \esub\var{\vartwo\varthree} \toeabs \delta\delta \esub\var{\vartwo\varthree} \tom \ldots$.
\end{center}
More generally, \emph{all} \cbv inscrutable terms diverge: the following characterization of \cbv (in)scrutability holds, analogous of the one for \cbn (\refthm{cbn-scrutability-characterization}) and due to \citet{accattoli+paolini-vsc}.
\begin{theorem}[VSC characterization of \cbv scrutability, \cite{accattoli+paolini-vsc}]
	\label{thm:cbv-scrutability-characterization}
A term $\tm$ is \cbv scrutable if and only if $\tm$ is $\tovsc$ (or, equivalently, $\tovscp$) terminating.
\end{theorem}
Despite the fact that the VSC makes $\Omega^L$ diverge as in \cbn, it does \emph{not} validate \cbn duplication nor \cbn erasure, as $(\la\var\vartwo)\Omega$ is $\tovsc$-divergent and $(\la\var \vartwo \var \var) (\varthree\varthree) \tom (\vartwo \var \var)\esub\var{\varthree\varthree} \not\tovsc \vartwo (\varthree\varthree)(\varthree\varthree)$.

\paragraph{Contextual Equivalence} Terms such as $\Omega^L$ are normal for Plotkin but divergent in the VSC, that is, the VSC and Plotkin's calculus have different notions of termination. One might then suspect that contextual equivalence in the VSC is not the same as in Plotkin's calculus. This is not the case, in fact, because the VSC behaves differently \emph{only on open terms}, while contextual equivalence is defined reducing closed terms only. The following result is due to \citet{DBLP:journals/pacmpl/AccattoliG22}.

\begin{proposition}[\cite{DBLP:journals/pacmpl/AccattoliG22}]
Two $\l$-terms without ES are contextual equivalent in Plotkin's calculus if and only if they are contextual equivalent in the VSC.
\end{proposition}

%\paragraph{Next} In the next section, we see a toy notion of normal form similarity for the VSC, to familiarize the reader with the proof technique for compatibility. After that, we shall rephrase in the VSC the benchmark equivalences discussed in \refsect{degrees} and finally define the actual notion of normal form similarity for the VSC we are interested in.