% !TEX root = main.tex

\section{Toy Similarity and Lassen's Method for the VSC}
\label{sect:toy}
In this section, we introduce a toy notion of similarity for the VSC based on the reduction $\tovscp$, the one that does not substitute variables. We denote this calculus with \VSCptxt  and, in this section, we use the notation $\valp$ to refer to abstractions. The aim is to provide a gentle introduction Lassen's variant \cite{lassen1999bisimulation} of Howe's method \cite{Howe1996method,DBLP:books/cu/12/Pitts12} for proving the compatibility of similarities, and to delay some of the technicalities that we shall need to address for the similarity we are really interested in.

\paragraph{From Small-Step to Big-Step.} Normal form similarities look at normal forms, and the crucial proof in Howe's method proceeds by induction on a big-step formulation of evaluation, where \emph{big-step} means that it relates a terminating term directly with its normal form, hiding the intermediate steps. Therefore, we need to reformulate the small-step reduction $\tm\tovscp^k\ntm$ where $\ntm$ is $\tovscp$-normal, in a big-step manner as $\tm \bsvscps \ntm$. 

For the technical development, we need to keep the information about the number $k$ of small steps, that is, we shall rather write $\tm \bsvscp k \ntm$. Such a quantitative information is needed both to prove the equivalence with small-step evaluation and for the crucial proof in the method. We also need the notion of inert substitutions contexts.
\begin{center}
	$\begin{array}{c@{\hspace{.5cm}}rcc}
	\textsc{ Inert Substitution Contexts} & \isctx & \grameq &  \ctxhole\mid \isctx\esub{\var}{\itm}
	\end{array}
	$\end{center}

\begin{definition}[Big-step \VSCptxt evaluation $\bsvscps$]
The big-step \VSCptxt evaluation predicate $\tm \bsvscp k \ntm$, read \emph{$\tm$ (\VSCptxt)-converges in $k$ steps to $\ntm$}, is defined as follows.
\begin{center}
	\input{figures/VSC-big-step-pratical-values}
\end{center}
\end{definition}

Notation: $\tm \bsvscps \ntm$ abbreviates \emph{there exists a $k$ such that $\tm \bsvscp k \ntm$}. Rule $(\bslasax)$ applies to both abstractions and variables ($\val = \valp$ or $\var$).
\begin{toappendix}
\begin{proposition}[Equivalence of small-step and big-step in \VSCptxt]
	\label{l:ss-bs-equivalence_vsc}
	$\tm \bsvscp k \ntm$ if and only if $\tm \tovscp^k \ntm$ with $\ntm$ is normal.
\end{proposition}
\end{toappendix}
%\begin{proof}
%	Full proof is detailed in the Appendix \ref{proof:proof-completeness-big-step-vsc-practical}.
%	
%	During this internship we developed two proofs of this proposition: one which is direct (that requires a double induction and is quite long) and one which is based on a complete subreduction which is closer to the big-step system approach. In the appendix we detail the second one, introducing a complete subreduction which has the same normal forms as $\tovsc$ and follows the same thinking as the big-step system.
%	
%\end{proof}
Let us stress an important point. We recall that $\tovscp$ is non-deterministic but diamond. The diamond property is here crucial, in order to make sense---at the big-step level---of the number of steps $k$, which for a diamond reduction does not depend on the reduction path to normal form.

\paragraph{Toy Normal Form Similarity} We adapt Sangiorgi's normal form similarity to the \VSCptxt. Since the language of terms has an additional constructor, the ES, there is one additional clause

\begin{definition}[\Naf simulations and similarity]
	Let $\relsym$ be a relation on $\l_{vsc}$-terms. $\relsym$ is a \naf simulation if $\relsym\subseteq\relnaf$, where $\tm \relnaf\tmp$ holds whenever $\tm,\tmp$ satisfy one of the following clauses:
	\begin{center}
		$\begin{array}{r@{\hspace{.3cm}}r@{\hspace{.3cm}}l@{\hspace{.3cm}}l@{\hspace{.3cm}}lll}
		\textup{(toy 1)} & &&\tm\bsvscpdiv & \ie ~ \text{has no} \tovscp \text{-normal form.}
		\\
		\textup{(toy 2)} & \tm \bsvscps \var  &\text{and}& \tmp \bsvscps \var
		\\
		\textup{(toy 3)} & \tm \bsvscps \la\var\tmfirst &\text{and}& \tmp \bsvscps \la\var\tmpfirst 
		& \text{with} ~ \tmfirst \rel \tmpfirst
		\\
		\textup{(toy 4)} & \tm \bsvscps \ntmONE \ntm &\text{and}& \tmp \bsvscps \ntmONEtwo \ntmtwo 
		& \text{with} ~ \ntmONE \rel \ntmONEtwo ~\text{and}~ \ntm \rel \ntmtwo
		\\
		\textup{(toy 5)} & \tm \bsvscps \ntm\esub\var\ntmONE &\text{and}& \tmp \bsvscps \ntmtwo\esub\var\ntmONEtwo
		& \text{with} ~ \ntmONE \rel \ntmONEtwo ~\text{and}~ \ntm \rel \ntmtwo
	\end{array}
	$\end{center}
		\Naf similarity, written $ \leqnaf $, is defined by coinduction as the largest \naf simulation, \ie it is the union of all \naf simulations.
	\end{definition}
		
	\paragraph{Making Inert Terms Explicit in the Clauses.} Cases (toy 4) and (toy 5) in the definition of toy simulations can be refined according to the grammar of \VSCptxt normal forms: for normal forms of the shape $\ntmONE\ntm$ the only possibility is that $\ntmONE$ is an inert term. Similarly, if $\ntm\esub\var\ntmONE$ is normal then $\ntmONE$ is inert. The two clauses are then refined as follows.
	\begin{center}
		$\begin{array}{r@{\hspace{.3cm}}r@{\hspace{.3cm}}l@{\hspace{.3cm}}l@{\hspace{.3cm}}lll}
		\text{(toy 4)} & \tm \bsvscps \itm \ntm &\textit{and}& \tmp \bsvscps \itmtwo \ntmtwo 
		& \textit{with} ~ \itm \rel \itmtwo ~\textit{and}~ \ntm \rel \ntmtwo
		\\
		\text{(toy 5)} & \tm \bsvscps \ntm\esub\var\itm &\textit{and}& \tmp \bsvscps \ntmtwo\esub\var\itmtwo
		& \textit{with} ~ \itm \rel \itmtwo ~\textit{and}~ \ntm \rel \ntmtwo
		\end{array}
		$\end{center}
	
\paragraph{(Howe-)Lassen's Method} Proving that a behavioral preorder $\precsim$ is compatible often cannot be done directly, that is, just by induction on the contextual closure. The idea of Howe's method is that, instead of proving compatibility of $\precsim$, one introduces a derived preorder $\howeop\precsim$ where the compatible closure is enforced in the definition, and then proves that $\precsim$ and $\howeop\precsim$ coincide. Howe introduced his method to deal with \emph{applicative} similarities \cite{Howe1996method}, Lassen adapted it for \emph{normal form} similarities \cite{lassen1999bisimulation}. The general idea is the same, but Lassen considers a different closure operation $\lassenop\precsim$.

\paragraph{Lassen's Closure.} The difficulty in proving directly that a similarity $\precsim$ is compatible comes from the applicative contextual closure, which may introduce a $\beta$-redex (when applying an abstraction to a term), that in turn can substitute over $\precsim$-related terms. The idea is to define the preorder $\lassenop\precsim$ as the compatible, substitutive, and reflexive closure of $\precsim$. 
In the case of \naf similarity, the definition of Lassen's closure needs an additional rule ($\scesub$) for the contextual closure with respect to ES.

\begin{definition}[Lassen closure]
The \emph{Lassen closure} $\lasrelsym$ of a relation $\relsym$ on terms is given by:
	\begin{center}
		\input{figures/RSC-lassen-for-naf}		
	\end{center}
\end{definition}
Note that rule ($\scesub$) does not constrain the terms $\tmrthree$ and $\tmrfour$ placed inside the ES, whereas rule ($\scsub$) does, because only practical values can be substituted in \VSCptxt.

\paragraph{Lassen's Closure Preserves Simulations} The proof of equivalence of $\leqnaf$ and $\lassenop\leqnaf$ reduces to prove that the closure operator $\lassenop\cdot$ preserves $\leqnaf$ simulations, that is, that $\lassenop\relsym$ is a \naf simulation if $\relsym$ is---it is often referred to as the \emph{main lemma} of the method. The proof is delicate and rests on two key intermediate properties. The first one concerns the evaluation level, and, when expressed at the big-step level, it is a sort of factorization property with respect to meta-level substitutions. In fact, it is nothing else but the substitutivity of small-step evaluation, rephrased at the big-step level.

\begin{proposition}[Small-step substitutivity]
	\label{l:stability_vsc}
	If $\tm\tovscp\tmp$ then $\tm\isubst\valp\var \tovscp \tmp\isubst\valp\var$
\end{proposition}

\begin{proof}
	By induction on $\tm\tovscp\tmp$ (induction on contexts), using the fact that a value where a variable is substituted by a value is still a value.
\end{proof}


\begin{lemma}[Big-step substitutivity]
	\label{l:splitting_vsc}
	If $\tm\isubst\valp\var \bsvscp k \ntm$ then there exist $k'$ and $\ntmtwo$ such that $ \tm \bsvscp {k'} \ntmtwo$ and $\ntmtwo\isubst\valp\var\bsvscp {k-k'} \ntm$.
\end{lemma}

\begin{proof}
If  $\tm\isubst\valp\var \bsvscp k \ntm$, then $ \tm \bsvscps \ntmtwo$ because if $\tm$ diverges then $\tm\isubst\valp\var$ diverges as well by substitutivity of $\tovscp$ {(\reflemma{stability_vsc})}.
	Then there exists $k'$ such that $\tm \bsvscp {k'} \ntmtwo$. Note that by substitutivity we have $ \tm\isubst\valp\var \tovscp^{k'} \ntmtwo\isubst\valp\var$, and so $\ntmtwo\isubst\valp\var\bsvscp {k-k'} \ntm$ because the reduction is diamond, hence all normalizing reduction sequences have the same length.
\end{proof}

%\begin{lemma}[Big-step substitutivity of $\bsvscpsym$]
%	\label{l:splitting_vsc}
%	Forall $\tm,\valp$,
%	$\tm\isubst\valp\var \bsvscp k \ntm \iff 
%	\exists k',\ntmtwo$ s.t. $ \tm \bsvscp {k'} \ntmtwo$ and $\ntmtwo\isubst\valp\var\bsvscp {k-k'} \ntm$
%\end{lemma}
%
%\begin{proof}
%	$(\Rightarrow)$ Suppose $\tm\isubst\valp\var \bsvscp k \ntm$, then $ \tm \bsvscps \ntmtwo$ because if it diverges then $\tm\isubst\valp\var$ diverges as well by substitutivity of $\tovscp$ {(\reflemma{stability_vsc})}.
%	Then there exists $k'$ such that $\tm \bsvscp {k'} \ntmtwo$. Note that by substitutivity we have $ \tm\isubst\valp\var \tovscp^{k'} \ntmtwo\isubst\valp\var$, and so $\ntmtwo\isubst\valp\var\bsvscp {k-k'} \ntm$ because the reduction is diamond, hence all normalizing reduction sequences have the same length.
%	
%	$(\Leftarrow)$ Suppose $ \tm \bsvscp {k'} \ntmtwo$ and $\ntmtwo\isubst\valp\var\bsvscp {k-k'} \ntm$.
%	By substitutivity {(\reflemma{stability_vsc})}, $ \tm\isubst\valp\var \tovscp^{k'} \ntmtwo\isubst\valp\var\tovscp^{k-k'}\ntm$. Then  $\tm\isubst\valp\var \bsvscp k \ntm$ by the equivalence of big-step and small-step evaluation ({\reflemma{ss-bs-equivalence_vsc}}).
%\end{proof}


%\paragraph{$\lasrel$ and $\lasrelnaf$ are equivalent on normal forms}
%The result for all terms is close to what we are trying to prove for the main \naf lemma we are trying to prove. Proving the equivalence for on normal forms will help for the proof.
%
%
%\begin{lemma}[Main \Naf Lemma]
%	\label{l:main-lemma-bis_vsc}
%	If $\relsym$ is a \naf simulation then
%	
%	$\tmrone\lasrel\tmrtwo, ~ \tmrone \bsvscp k \ntm \Rightarrow \tmrtwo\bsvscps \ntmtwo$ and $\ntm \lasrel \ntmtwo$
%	
%\end{lemma}

The second key intermediate property is the coherence of \naf simulations with respect to reduction and substitution.
\begin{toappendix}
\begin{proposition}[{Coherence of simulation, reduction, and substitution}]
\label{prop:naf-coherence}
Let $\rel$ be a \naf simulation, $\ntm \lasrelnaf \ntmtwo$, and $\valp\lasrelnaf\valptwo$.
\begin{enumerate}
\item \emph{Normal forms}: if $\ntm\isub\var\valp$ is $\tovscp$-normal then $\ntmtwo\isub\var\valptwo$ is $\tovscp$-normal and\\ $\ntm\isub\var\valp \lasrelnaf \ntmtwo\isub\var\valptwo$.
\item \emph{Steps}: if $\ntm\isub\var{\valp} \tovscp \tm$
	then $\ntm\isub\var{\valptwo}  \tovscp \tmtwo$ and $\tm \lasrel \tmtwo$.
\end{enumerate}
\end{proposition}
\end{toappendix}
{Note that the second point has $\lasrel$ rather than $\lasrelnaf$ in the conclusion. This is because in general $\tm$ and $\tmtwo$ are not normal. In the proof of the next proposition, it is shown that the normal forms of $\tm$ and $\tmtwo$ are in fact $\lasrelnaf$-related.}

We can now prove the crucial property of Lassen's closure.
\begin{toappendix}
\begin{proposition}
	\label{prop:main-lemma_vsc}
		Let $\relsym$ be a \naf simulation.
		\begin{enumerate}
		\item \emph{Technical auxiliary statement}: if $\tmrone\lasrel\tmrtwo$ and $\tmrone \bsvscp k \ntm$ then $\tmrtwo\bsvscps \ntmtwo$ and $\ntm \lasrelnaf \ntmtwo$.		
		\item \emph{Lassen's closure preserves \naf simulations}:  $\lassenop\relsym$ is a \naf simulation.
		\end{enumerate}
\end{proposition}
\end{toappendix}
\begin{proof} 
	\hfill
	\begin{enumerate}
	\item \emph{Sketch} (complete proof in Appendix \ref{chapter:proof-compatibility-naf}):	by induction on $(k,d)$ where $d$ is the size of the derivation of $\tmrone \lasrel \tmrtwo$. We proceed by case analysis on the last rule of the derivation $\tmrone \lasrel \tmrtwo$. Cases ($\sclift$), ($\scvar$), and ($\scabs$) are immediate by definition. The ($\scapp$) and ($\scesub$)  cases rely on a second case analysis (on the last rule of the $\tmrone \bsvscp k \ntm$ derivation). The sub-cases are routine and may depend on the ($\scsub$) rule. Case ($\scsub$) is the core of the proof. It starts by applying big-step substitutivity (\reflemma{splitting_vsc}) to $\tmrone = \tm\isub\var\valp$ and then, depending on whether the obtained $\ntmtwo\isubst\valp\var$ is normal, it applies the corresponding coherence property of \naf simulations with respect to evaluation (\refprop{naf-coherence}).
	\item Unfolding the statement one obtains exactly the statement of point 1.\qedhere
	\end{enumerate}
\end{proof}
Finally, we can use the preservation property to prove the redundancy of the closure, from which the compatibility and the soundness of \naf similarity follows.
\begin{theorem}[Compatibility and soundness of $\leqnaf$]
	\hfill
	\begin{enumerate}
	\item \emph{Redundancy of Lassen's closure}: $\leqnaf \,= \lassenop \leqnaf$.
	\item \Naf similarity is compatible and included in the \cbv contextual preorder $\leqcv$.
	\end{enumerate}
\end{theorem}

\begin{proof}
\hfill
\begin{enumerate}
\item By construction of $\lassenop\ctxhole$, $\leqnaf \subseteq \lassenop\leqnaf$ (by rule $\sclift$). Preservation of \naf simulations by Lassen's closure (\refprop{main-lemma_vsc}) and the fact that $\leqnaf$ is a \naf simulation give that $\lassenop\leqnaf$ is a \naf simulation. By definition, $\leqnaf$ is the maximal \naf simulation hence $\lassenop\leqnaf \subseteq \leqnaf$. 
\item Compatibility follows from point 1, because $\lassenop\leqnaf$ is compatible by definition. Inclusion in $\eqcv$ follows by \refprop{congruence-included-contextual-equivalence} and by adequacy of $\leqnaf$, which is trivial.\qedhere
\end{enumerate}
\end{proof}

	\paragraph{Toy Similarity Validates Scrutable Equivalence} The distinctive trait of \naf similarity with respect to naive and enf similarities is that it validates the scrutable equivalence $\equivscr$, that is, it identifies all \cbv inscrutable terms. The proof is immediate because of the characterization of inscrutability in the VSC (\refthm{cbv-scrutability-characterization}): inscrutable terms are exactly the $\tovscp$-diverging ones, which all fall in the first clause defining \naf similarity. In particular, $\Omega \eqnaf \Omega^L$.
	
	\begin{proposition}
	Toy similarity $\leqnaf$ validates scrutable equivalence $\equivscr$.
	\end{proposition}
	
	\paragraph{Toy Similarity is Useless} While $\leqnaf$ achieves the validation of $\equivscr$, it does not validate any other benchmark equivalence, and it cannot even prove that Curry's and Turing's fix-point combinators are equivalent, because for that one needs to be able to substitute variables, which is forbidden in the \VSCptxt, as its definition excludes rule $\toevar$. Therefore, in particular, there are terms that are \enf similar (or even only naively similar) but not toy similar. The two similarities are incomparable.
	
	Moggi's equivalences, as well as the shuffling and proof nets ones, are not validated by \naf similarity because they change the structure of the normal form, while $\leqnaf$ is \emph{rigid}: similar normal forms have to have the \emph{exact} same structure out of abstractions. 
	
	%\paragraph{Next} We shall then refine \Naf, adding the substitution of variables and the graphical equivalences, marrying its validation of scrutable equivalence with the other principles, thus obtaining a useful similarity. First, however, we need to re-understand the benchmark equivalences in the VSC.