% !TEX root = main.tex

\section{Plotkin's Call-by-Value and Open Terms}
\label{sect:plotkin}
Here we recall Plotkin's \cbv $\l$-calculus, and pay attention to some aspects that are often neglected, as they shall be relevant in the following sections. 

\paragraph{The \cbv $\l$-Calculus.} A \emph{value} $\val$ is a variable or an abstractions. At the rewriting level, we consider only weak evaluation, that is, out of abstractions. We define it in three variants, from left to right, from right to left, and in an unspecified order, which are discussed next.
\begin{center}
\begin{tabular}{c@{\hspace{.7cm}}c}
	$\begin{array}{r@{\hspace{.4cm}}rlll}
	\textsc{Terms} & \tm, \tmtwo, \tmthree & \grameq & \val \mid \tm\tmtwo 
	\\
	\textsc{Values} & \val  & \grameq  & \var \mid \la\var\tm

	\end{array}$
	
	&
	
	$\begin{array}{r@{\hspace{.4cm}}rlll}
	\textsc{(General) Contexts} & \ctx & \grameq &  \ctxhole\mid \tm\ctx\mid \ctx\tm \mid \la\var\ctx
	\\
	\textsc{Weak Contexts} & \wctx & \grameq &  \ctxhole\mid \tm\wctx\mid \wctx\tm
	\\
	\textsc{Left Contexts} & \lctx & \grameq &  \ctxhole\mid \val\lctx\mid \lctx\tm
	\\
	\textsc{Right Contexts} & \rctx & \grameq &  \ctxhole\mid \tm\rctx\mid \rctx\val
	\end{array}$
\end{tabular}
\end{center}

\begin{definition}[Reductions]
Let root $\betav$ reduction $\rtobv$ defined as $(\la\var\tm)\val \rtobv \tm\isub\var\val$. Then 
	$\betav$, weak, left (to right), and right (to left) reduction, noted $\tobv$, $\tow$, $\tolw$, and $\torw$, are defined as follows: if $\tm \rtobv \tmtwo$ then
	\begin{center}
		$\begin{array}{c@{\hspace{1cm}}c@{\hspace{1cm}}c@{\hspace{1cm}}c}
		\ctxp \tm \tobv \ctxp \tmtwo 
		&\wctxp \tm \tow \wctxp \tmtwo 
		&
		\lctxp \tm \tolw \lctxp \tmtwo 
		 &
		\rctxp \tm \torw \rctxp \tmtwo
		\end{array}
		$\end{center}
\end{definition}
It is standard that $\tolw$ and $\torw$ are deterministic and contained in $\tow$, which is non-deterministic but diamond, while $\tobv$ is non-deterministic and confluent but not diamond.

\paragraph{Closed Terms.} If terms are closed and evaluation is weak, which are a standard assumption in the study of functional languages, then call-by-value evaluation has some very nice properties, summed up by the next proposition.

\begin{proposition}
Let $\tm$ be a closed term.
\begin{enumerate}
\item $\tm$ is a weak/left/right normal forms if and only if $\tm$ is an abstraction.
\item On $\tm$, left and right reduction are full with respect to weak evaluation, that is, if $\tm \tow \tmtwo$ then there exist $\tmthree$ and $\tmfour$ such that $\tm \tolw \tmthree$ and $\tm \torw \tmfour$.
\end{enumerate}
\end{proposition}
Intuitively, left and right reduction are two equivalent ways of turning weak reduction into a deterministic reduction, on closed terms. 
In \cbv, contextual preorder $\leqcv$ is defined with respect to evaluation to a value, which can be equivalently expressed as termination of weak, left, or right reduction. Importantly, for $\leqcv$ one considers only the reduction of closed terms, as the definition of $\leqcv$ is based on contexts closing the terms to compare.

\paragraph{Open Terms, Stuck Redexes, and The Inequivalence of the Three Strategies.} As soon as one considers open terms, the good properties of the system break. The only ones which survive are the diamond property of weak reduction and the fact that left and right reduction are deterministic. But weak normal forms now have a complex shape, as there can be \emph{stuck redexes} such as $(\la\var\tm) (\vartwo\vartwo)$ which cannot be reduced because their argument is normal and not a value.

Stuck redexes unfortunately break the equivalence of left, right, and weak reduction: left, right, and weak normal forms are all different notions, because left and right reduction are no longer full with respect to weak reduction. For instance, $\tm \defeq \var\var(\Id\Id)$ is a left normal form which is not a weak/right normal form, because $\tm \tow \var\var\Id$, which is weak/right normal. Similarly, $\Id\Id(\var\var)$ is a right normal form which is not left/weak normal, and $\var\var(\Id\Id)(\var\var)$ is a left/right normal form which is not weak normal. Perhaps more worrying is the fact that stuck redexes introduce suspicious distinctions between contextually equivalent terms: $\Omega$ and $\Omega^L \defeq (\la\var\delta)(\vartwo\varthree)\delta$ are contextually equivalent, but the first one diverges while the second one is normal, because of the stuck redex.

%\paragraph{Improved Left and Right.} It is possible to recover the equivalence of left, right, and weak reduction by adopting less naive definitions of left and right contexts to define the corresponding reductions. Let $w$ denote a weak normal form (of which we omit the complex grammar). Considering the following variants on left and right contexts where values $\val$ have been replaced by $w$:
%\begin{center}
%	$\begin{array}{r@{\hspace{.4cm}}rlll}
%	\textsc{Improved Left Contexts} & \lctx^+ & \grameq &  \ctxhole\mid w\lctx^+\mid \lctx^+\tm
%	\\
%	\textsc{Improved Right Contexts} & \rctx^+ & \grameq &  \ctxhole\mid \tm\rctx^+\mid \rctx^+w
%	\end{array}$
%\end{center}
%The induced notions of improved left and improved right reduction are now equivalent to weak reduction. Eliminating the suspicious distinction between contextually equivalent terms instead requires to change the calculus, as we shall see in \refsect{vsc}.

\paragraph{On the Value of Variables} Another subtle aspect in the definition of \cbv is the notion of value. The $\rtobv$ root rule can be split in two root rules $\rtobabs$ and $\rtobvar$, depending on whether the substituted value is an abstraction or a variable, and all the defined reductions can be split accordingly. Note that, if terms are closed and evaluation is weak, then sub-rules based on $\rtobvar$ can never be applied, because arguments out of abstractions have to be closed, so they cannot be variables. This is one of the reasons why sometimes variables are not considered as values. Another reason is related to the efficiency of implementations, see \citet{DBLP:journals/iandc/AccattoliC17}. For us, variables are values and they are substituted, but in a later section we shall forbid them to be substituted.
