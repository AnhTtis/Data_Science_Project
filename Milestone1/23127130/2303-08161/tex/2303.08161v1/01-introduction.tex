% !TEX root = main.tex
% !TeX spellcheck = en_US
\section{Introduction}
The study of program equivalences for $\l$-calculi is an important topic where semantical and operational techniques meet. Properties of program equivalences are notoriously difficult to prove.  Even the equivalence of two terms might be challenging to establish, if the notion of equivalence is Morris' contextual equivalence \cite{morris1968lambda}, or some variant still quantifying over a class of contexts, such as Abramsky's applicative bisimilarity \cite{abramsky-lazy-90}. Another difficulty is the fact that properties of program equivalences are quite brittle, as they are not preserved by extensions of the calculus under study, nor by restrictions, and not even by changing the evaluation strategy within the same calculus.

It is well-known that applicative bisimilarity is fully abstract for contextual equivalence in the untyped call-by-name weak $\l$-calculus (where \emph{weak} stands for reduction only out of abstractions, which is standard in functional languages), as proved by Abramsky \cite{abramsky-lazy-90}, as well as in Plotkin's call-by-value weak $\l$-calculus, as proved by \citet{DBLP:journals/fuin/EgidiHR92} and \citet{DBLP:books/cu/12/Pitts12}. Therefore, one might be led to think that the call-by-name/call-by-value switch is quite robust in the weak setting, even if it is known that its robustness breaks in a probabilistic setting, as shown by \citet{DBLP:conf/popl/LagoSA14}. 

This paper stems from the observation that another natural program equivalence, Sangiorgi's \emph{normal form bisimilarity} \cite{SANGIORGI-normal-form-bisimulation} (shortened to nf-bisimilarity), behaves differently in call-by-name (shortened to \cbn) and call-by-value (\cbv), already in the untyped effect-free weak case. %By dissecting the problem, we develop a rich theory of \cbv nf-bisimilarities, quite more sophisticated than in \cbn, introducing some new bisimilarities along the way, and grounding our work in the recent analysis of \cbv semantics by \citet{DBLP:journals/pacmpl/AccattoliG22}. 

\paragraph{Normal Form Bisimilarity} Normal form bisimulations are program equivalences that, instead of comparing terms \emph{externally}, depending on how they behave \emph{in contexts}, compare them \emph{internally}, by looking at the structure of their (infinitary) \emph{normal forms}. A distinctive feature of nf-bisimulations is that they directly manipulate \emph{open terms}, to the point that Sangiorgi rather used to call them \emph{open bisimulations} in his seminal paper \cite{SANGIORGI-normal-form-bisimulation}.

It is known that Sangiorgi's \cbn nf-bisimilarity is not fully abstract for contextual equivalence, being sound but not complete. %, but it corresponds to another natural notion in the theory of the $\l$-calculus, the equivalence induced by \levy-Longo trees. 
 The failure of full abstraction is compensated by the fact that \cbn nf-bisimilarity is easier to establish than applicative similarity, because of the absence of quantification over arguments. Typically, it is easy to show that different fix-points combinators---which are the paradigmatic terms with infinitary normal forms---are nf-bisimilar, while it is hard to show that they are applicative bisimilar.

There exists a \cbv nf-bisimilarity, Lassen's \emph{enf bisimilarity} $\eqenf$ \cite{LassenEnf}, which---as Sangiorgi's---is  sound but not complete for \cbv contextual equivalence $\eqcv$. In \cbv, however, it is not so obvious that contextual equivalence should be the standard of reference, at least in the untyped, effect-free setting, because therein $\eqcv$ is \emph{cost-insensitive}: it equates terms such as $(\la\var\vartwo\var\var)\tm$ and $\vartwo\tm\tm$, for any $\tm$, also for terms $\tm$ that are not values. This is against the very idea of \cbv, of avoiding duplicating $\tm$ before having evaluated it. In richer \cbv settings with state or probability, contexts discriminate more, and those terms are separated, but in the pure case they are not. Enf bisimilarity, instead, distinguishes them already in the pure case. It is thus \emph{cost-sensitive}, and closer to \cbv intuition.

Anyway, the incompleteness of both \cbn and \cbv nf-bisimulations for the weak $\l$-calculus at first sight suggests that they are robust with respect to the \cbn/\cbv switch. In fact, they are \emph{not}. And enf bisimilarity, while cost-sensitive, is far from being a satisfying \cbv equivalence. To explain the issue, we need to take a semantical detour.

\paragraph{Solvability and Scrutability} The denotational semantics of the untyped \emph{strong} \cbn $\l$-calculus---the one of Barendregt's book \cite{Barendregt84}---is a well developed field built around the concept of \emph{solvable terms}, which are elegantly characterized in many different ways. In particular, the dual notion of \emph{unsolvable terms} captures the idea of idle programs which diverge in an unproductive way, sometimes called \emph{meaningless terms}. A key fact is that all unsolvable terms are contextually equivalent, when observing termination with respect to strong reduction.

In \cbv, there is a corresponding notion of \cbv (un)solvable terms but they are not contextually equivalent, and forcing their equivalence causes the equational theory to become \emph{inconsistent}, as pointed out by \citet{DBLP:journals/pacmpl/AccattoliG22}. The weak variant of \cbv unsolvable terms, called \emph{inscrutable terms} (or \emph{non-potentially-valuable} by Paolini and Ronchi della Rocca \cite{DBLP:journals/ita/PaoliniR99,parametricBook}) provides the right semantic foundation in \cbv. In particular, they are all contextually equivalent. %This is a strong sign that the semantics of \cbn and \cbn are inherently different.

Inscrutable terms exist also in \cbn \cite{parametricBook}, despite having received less attention. Pleasantly, they are all \cbn nf-bisimilar. If nf-bisimilarities were robust with respect to the weak \cbn/\cbv switch, Lassen's eager bisimilarity would equate \cbv inscrutable terms. Instead, it does not.

\paragraph{A \cbv Nf-Bisimilarity Equating Inscrutable Terms.} The motivation behind this work is the development of a \cbv nf-bisimilarity that equates \cbv inscrutable terms, aiming at refining Lassen's enf bisimilarity and matching Sangiorgi's at the same time. By using the \emph{value substitution calculus} (shortened to VSC), a \cbv $\l$-calculus due to Accattoli and Paolini \cite{accattoli+paolini-vsc,Accattoli-proofnets} and related to linear logic proof nets, we do build a \cbv nf-bisimilarity matching Sangiorgi's in capturing inscrutable terms. The obtained \emph{net bisimilarity} $\eqnet$ and the proof of its \emph{compatibility} (that is, its stability by context closure)---which is the challenging property to prove for bisimilarities---are the main contributions of this paper. Compatibility implies soundness with respect to contextual equivalence, and it is proved adapting Lassen's variant for nf-bisimilarities of Howe's method \cite{lassen1999bisimulation}. As it is often the case for nf-bisimilarities, ours is sound but not complete, and---as for enf bisimilarity---it is \emph{cost-sensitive}. 

The crafting of net bisimilarity is based on a sophisticated analysis of \cbv and the VSC. In particular, its definition compares normal forms modulo some equivalences induced by linear logic proof nets, whence the name \emph{net} bisimilarity. We actually go further, introducing a \emph{parametric} nf-bisimilarity, where such extra equivalences can be turned off and on at will---because some fail in extensions of \cbv with effects---thus defining a \emph{family} of \cbv nf-bisimilarity, all proved compatible via a single abstract proof. 

Our result is however more a new beginning than the end of the story: \net bisimilarity, indeed, is \emph{not} a refinement of Lassen's $\eqenf$. In fact, the two are \emph{incomparable}. Another detour is in order.

\paragraph{Two Orthogonal Extensions of Plotkin} 
It is well-known that Plotkin's \cbv $\l$-calculus is defective. Plotkin himself showed a shortcoming: the incompleteness of his continuation-passing style translation \cite{PLOTKIN1975}. To both solve the issue and modeling extensions with effects, Moggi extended Plotkin's calculus with equations corresponding to laws for monads \cite{Moggi88tech,DBLP:conf/lics/Moggi89}, in 1988. Lassen's eager bisimulation verifies these laws. In particular, it verifies the \emph{left identity law} $\Id \tm \equivlid \tm$, where $\Id=\la\var\var$. If $\tm$ is a value, the law is included in $\betav$-reduction, but Moggi extends it to \emph{every term} $\tm$.

Another issue of Plotkin's calculus is its inadequacy for dealing with \emph{open terms}. The problem was first studied by \citeauthor{DBLP:journals/ita/PaoliniR99} \cite{DBLP:journals/ita/PaoliniR99,DBLP:conf/ictcs/Paolini01,parametricBook} in 1999, and it was then extensively analyzed by Accattoli, Guerrieri, and co-authors during the last decade \cite{accattoli+paolini-vsc,shufflingcalculus,Accattoli-proofnets,accattoli+guerrieri-opencbv,Accattoli-Guerrieri-TypesFireballs,DBLP:journals/lmcs/GuerrieriPR17,DBLP:conf/ppdp/AccattoliCGC19,DBLP:journals/scp/AccattoliG19,DBLP:conf/lics/AccattoliCC21,DBLP:journals/corr/abs-2104-13979,DBLP:journals/pacmpl/AccattoliG22}. Also in this case, the solution amounts to extend Plotkin's calculus. There are many extensions that remove the issue with open terms, as shown by Accattoli and Guerrieri \cite{accattoli+guerrieri-opencbv}. Among these extensions, one stands out, the already mentioned VSC. In particular, it is the setting where \cbv solvability and scrutability have first been characterized and understood \cite{accattoli+paolini-vsc,DBLP:journals/pacmpl/AccattoliG22}, because they are affected by open terms and cannot be properly studied in Plotkin's calculus. Moreover, while the VSC extends Plotkin's calculus, the contextual equivalences of the two coincide, thus the extension is a conservative refinement \cite{DBLP:journals/pacmpl/AccattoliG22}. Moggi's left identity law, however, is not a rule of the VSC.%Additionally, the VSC has been used for studying abstract machines and cost models, as well as multi types and linear logic proof nets.

\paragraph{Normal Form Bisimulations By Value} We can finally outline the intricacies of \cbv nf-bisimulations:
\begin{itemize}
\item \emph{Enf $vs$ open terms}: enf bisimulations verify Moggi's left identity law but they do not equate inscrutable terms because they are based on Plotkin's calculus, which struggles with open terms. It is unclear, however, how to extend enf bisimulations as to equate inscrutable terms\footnote{It is easy to extend enf bisimilarity as to equate inscrutable terms in an \emph{ad-hoc} way, by using both Plotkin's calculus and the VSC in its definition, but we do not consider such a direction worth exploring.}, because they \emph{exploit} the issue with open terms in their definition. Therefore, removing the issue also somewhat forbids the definition itself of enf bisimulations. 
\item \emph{Net $vs$ left identity}: our net bisimulations equate inscrutable terms but do not verify the left identity law, as it is not a law of the VSC. Despite the simplicity of the law, it is unclear how to extend net bisimulations as to satisfy it. There are in principle two options: adding the law to the rewriting of the VSC or to the definition of the bisimulations. Both options however break  properties that are crucial for the proof that net bisimilarity is compatible.
\end{itemize}
The exploration of such a double \emph{cul-de-sac} is the other main contribution of the paper. We study two further program equivalences, a naive bisimilarity $\eqncbv$ and the program equivalence $\equivtype$ induced by a model, which are sort of the intersection and the union of enf and net bisimilarities.

\paragraph{Naive Bisimilarity $\eqncbv$ = No Inscrutable and No Left Identity} We blindly translate the definition of Sangiorgi's \cbn nf-bisimulations to \cbv, obtaining \emph{naive nf-bisimulations}, which are strictly weaker than both enf and net bisimulations, as they do not identify inscrutable terms nor validate the left identity law. Despite the literature considering enf bisimulations as the \cbv analogous of Sangiorgi's nf-bisimulations, our experiment shows that Lassen's actually have a crucial extra ingredient, which is what allows them to capture the left identity law. The experiment is instructive also because we show that naive bisimulations, despite their weakness, are enough to provide easy proofs of bisimilarity for fix-point combinators---Lassen's extra ingredient plays no role in that.

\paragraph{Type Equivalence $\equivtype$ = Inscrutable and Left Identity} At the other end of the spectrum, we investigate the program equivalence given by the equational theory of Ehrhard's \cbv relational model \cite{DBLP:conf/csl/Ehrhard12}. We call it \emph{type equivalence} because the model is presented as a multi type system (a variant of intersection types). Such a model was already extensively studied in connection with the VSC by Accattoli and Guerrieri \cite{Accattoli-Guerrieri-TypesFireballs,DBLP:journals/corr/abs-2104-13979,DBLP:journals/pacmpl/AccattoliG22}. Its equational theory does not have a presentation via nf-bisimulations, nor any other characterization, but it is nonetheless possible to study it via the multi type system. It turns out that type equivalence, similarly to nf-bisimilarities, is compatible and sound, but not complete for contextual equivalence, as it is cost-sensitive. It is not an easily usable equivalence, as it is based on a quantification over all possible typings for a term, but it provides interesting insights.

Our results are that both enf and net bisimilarities are \emph{included} in type equivalence. Therefore, the two bisimilarities are joinable. Since both are sound, they are obviously joinable in a cost-insensitive setting, as they are both included in contextual equivalence. Our results show that they are also joinable in a \emph{cost-sensitive} program equivalence, thus suggesting that a nf-bisimilarity joining the two might be possible. Crafting it, and especially proving that it is compatible, is left to future work.

%The semantics of the untyped \cbv Î»-calculus (CbV)
%is instead still in its infancy, because of some inherent difficulties but also because CbV solvable terms are less
%studied and understood than in \cbn. On the one hand, we show that a carefully crafted presentation
%of CbV allows us to recover many of the properties that solvability has in \cbn, in particular qualitative
%and quantitative characterizations via multi types. On the other hand, we stress that, in CbV, solvability plays
%a different role: identifying unsolvable terms as meaningless induces an inconsistent theory.





%
%functional programming
%
%untyped cbv
%
%proving inscrutable terms can be collapsed : three ways (genericity, model, bisimulation)
%
%we can work in the vsc weak contextual equivalence rather than plotkin's because they coincide

The following table sums up the situation.
\input{figures/recap-table-program-equivalences}


\paragraph{Related Work} Beyond the already cited papers, nf-bisimilarity is studied in variants and extensions of the $\l$-calculus by Lassen \cite{lassen1999bisimulation,DBLP:journals/entcs/Lassen06,DBLP:conf/lics/Lassen06}, \citet{DBLP:conf/csl/LassenL07,DBLP:conf/lics/LassenL08}, \citet{DBLP:conf/flops/BiernackiL12}, \citet{DBLP:conf/fossacs/BiernackiLP19}, and \citet{DBLP:journals/taosd/JagadeesanPR09}, and in relationship to game semantics by \citet{DBLP:conf/csl/LevyS14}, \citet{DBLP:conf/lics/JaberM21}, and \citet{DBLP:conf/csl/JaberS22}. The presence of state in \citet{DBLP:conf/birthday/StovringL09} makes nf-bisimilarity fully abstract (as it makes contextual equivalence cost-sensitive). Lassen's enf bisimilarity is studied with respect to $\eta$-equivalence by \citet{DBLP:journals/lmcs/BiernackiLP19}, extensions with effects by \citet{DBLP:conf/esop/LagoG19}, and the $\pi$-calculus by \citet{DBLP:journals/tcs/DurierHS22}. 

\cbv multi types are also used by Kesner and co-authors \cite{DBLP:conf/flops/BucciarelliKRV20,DBLP:conf/fscd/KesnerP22,DBLP:conf/csl/KesnerV22,DBLP:journals/pacmpl/ArrialGK23} and \citet{DBLP:conf/lfcs/Diaz-CaroMP13}.

A notion of \cbv B\"ohm tree, inducing a program equivalence similar to nf-bisimilarity is proposed by \citet{bohmtree-cbv}. Their equivalence is in between our naive and net bisimilarities. They conjecture that it characterizes type equivalence. Our results \emph{refute} such a conjecture: with respect to the benchmarks of \refsect{benchmarks}, their equivalence equates all \cbv inscrutable terms but it does not validate $\equivcom$ and $\equivexsthree$---which are validated by net bisimilarity---nor Moggi's left identity law $\equivlid$.

\paragraph{Proofs} Omitted proofs are in the Appendix.


