% !TEX root = main.tex

\section{Proof of Compatibility of Toy Similarity}
\label{chapter:proof-compatibility-naf}
In this section, we will prove the first part of Proposition \ref{prop:main-lemma_vsc}. 
We first prove that $\lasrel$ and $\lasrelnaf$ are equivalent on normal forms, which is somewhat the proposition we need to prove but only on normal forms.
Then we need to prove intermediate lemmas that are technicalities on the structure of terms, and Proposition \ref{prop:naf-coherence} (proven in Section \ref{section:lemmas-implicit-case-naf-proof}). Once these are proven, we can directly prove Proposition \ref{prop:main-lemma_vsc}.

We remind the reader that the letter $\ntm$ is always used only for normal forms and that for this calculus only abstractions are values (the letter $\valp$ only refers to abstractions). 
%\renewcommand{\tmrthree}{\adr{P}}
%\renewcommand{\tmrfour}{\adr{Q}}

\subsection{Proof of Proposition \ref{prop:main-lemma_vsc} but only on normal forms}
\label{section:lasrel-lasrelnaf-normal-forms}
In this section, we prove $\lasrel = \lasrelnaf$ is we restrict the relations to normal forms. One direction is easy (\reflemma{lasrelnaf-normal-forms-lasrel-left-to-right}), the other one relies on some sublemmas. The equivalence is only true if $\relsym$ is a \naf simulation.

\begin{lemma}
	\label{l:lasrelnaf-normal-forms-lasrel-left-to-right}
	If $\ntm\lasrelnaf\ntmtwo$ then $\ntm\lasrel\ntmtwo$.
\end{lemma}
\begin{proof}
	By case analysis on $\ntm = \var \mid \valp \mid \itm\ntm \mid \ntm\esub\var\itm$.
\end{proof}

To show the other direction of the equivalence (\reflemma{lasrelnaf-normal-forms-lasrel-right-to-left}), we use the two following lemmas.

\begin{lemma}
	\label{l:relnaf-to-lasrelnaf-on-normal}
If $\ntm\relnaf\ntmtwo$ then $\ntm\lasrelnaf\ntmtwo$. 
\end{lemma}

\begin{proof} By monotonicity of $\opnaf$.
%	Cases of $\ntm$.
%	\begin{itemize}
%		\item \emph{Variable}, that is, $\ntm = \var$. Then $\ntmtwo = \var$ and $\var\lasrelnaf\var$ by definition of \naf. 
%		\item \emph{Abstraction}, that is, $\ntm = \la\var\tm$. Then $\ntmtwo = \la\var\tmp$ with $\tm\rel \tmp$. Then $\tm\lasrel \tmp$ by rule $(\sclift)$. Then $\la\var \tm \lasrelnaf \la\var\tmp$ by definition of \naf. 
%		\item \emph{Applied inert}, that is, $\ntm = \itm\ntmONE$. Then $\ntmtwo = \itmtwo\ntmONEtwo$ with $\itm \rel \itmtwo$ and $\ntmONE \rel \ntmONEtwo$. By rule $(\sclift)$, $\itm \lasrel \itmtwo$  and $\ntmONE \lasrel \ntmONEtwo$. Then $\ntm =\itm\ntmONE \lasrelnaf \itmtwo\ntmONEtwo = \ntmtwo$ by definition of \naf. 
%		\item \emph{Substituted inert}, that is, $\ntm = \ntmONE\esub\var\itm$. Then $\ntmtwo = \ntmONEtwo\esub\var\itmtwo$ with $\itm \rel \itmtwo$ and $\ntmONE \rel \ntmONEtwo$. By rule $(\sclift)$, $\itm \lasrel \itmtwo$  and $\ntmONE \lasrel \ntmONEtwo$. Then $\ntm = \ntmONE\esub\var\itm \lasrelnaf \ntmONEtwo\esub\var\itmtwo = \ntmtwo$ by definition of \naf. 
%	\end{itemize}
\end{proof}

%\begin{lemma}
%	\label{l:relnaf-to-lasrel-on-normal}
%	If $\ntm\relnaf\ntmtwo$ then $\ntm\lasrel\ntmtwo $.
%\end{lemma}
%
%\begin{proof}
%	Cases of $\ntm$.
%	\begin{itemize}
%		\item \emph{Variable}, that is, $\ntm = \var$. Then $\ntmtwo = \var$ and $\var\lasrel\var$ by rule ($\scvar$).
%		\item \emph{Abstraction}, that is, $\ntm = \la\var\tm$. Then $\ntmtwo = \la\var\tmp$ with $\tm\rel \tmp$. Then $\tm\lasrel \tmp$ by rule $(\sclift)$. Then $\la\var \tm \lasrel \la\var\tmp$ by rule ($\scabs$).
%		\item \emph{Applied inert}, that is, $\ntm = \itm\ntmONE$. Then $\ntmtwo = \itmtwo\ntmONEtwo$ with $\itm \rel \itmtwo$ and $\ntmONE \rel \ntmONEtwo$. By rule $(\sclift)$, $\itm \lasrel \itmtwo$  and $\ntmONE \lasrel \ntmONEtwo$. Then $\ntm =\itm\ntmONE \lasrel \itmtwo\ntmONEtwo = \ntmtwo$ by rule ($\scapp$).
%		\item \emph{Substituted inert}, that is, $\ntm = \ntmONE\esub\var\itm$. Then $\ntmtwo = \ntmONEtwo\esub\var\itmtwo$ with $\itm \rel \itmtwo$ and $\ntmONE \rel \ntmONEtwo$. By rule $(\sclift)$, $\itm \lasrel \itmtwo$  and $\ntmONE \lasrel \ntmONEtwo$. Then $\ntm = \ntmONE\esub\var\itm \lasrel \ntmONEtwo\esub\var\itmtwo = \ntmtwo$ by rule ($\scesub$).
%	\end{itemize}
%\end{proof}

Notice that the next lemma already proves part of the conclusion of the first part of Proposition \ref{prop:naf-coherence}.


\begin{lemma}[Constrained Substitutivity of $\lasrelnaf$ on normal forms]
	\label{l:lasrelnaf-normal-forms-substitutive}
	If $\ntmONE \lasrelnaf \ntmTWO$, $\valp \lasrelnaf \valptwo$ and $\ntmONE\isub\var{\valp}$ and $\ntmTWO\isub\var{\valptwo}$ are $\tovscp$-normal then $\ntmONE\isub\var{\valp} \lasrelnaf \ntmTWO\isub\var{\valptwo}$.
\end{lemma}


\begin{proof}
	By case analysis on the shape of $\ntmONE$. Cases:
	\begin{itemize}
		\item $\ntmONE = \var$ and $\ntmTWO = \var$ then $\ntmONE\isub\var{\valp} = \valp \lasrelnaf \valptwo = \ntmTWO\isub\var{\valptwo}$.
		
		\item $\ntmONE = \vartwo$ and $\ntmTWO = \vartwo$ then $\ntmONE\isub\var{\valp} =  \vartwo \lasrelnaf \vartwo = \ntmTWO\isub\var{\valptwo}$.
		
		\item $\ntmONE = \la\vartwo\tm$ and $\ntmTWO = \la\vartwo\tmp$ with $\tm \lasrel \tmp$
		we have \[\infer{\tm\isub\var{\valp} \lasrel \tmp\isub\var{\valptwo}}{\tm \lasrel \tmp & \valp \lasrel \valptwo}\]
		hence by case (naf 3) $\ntmONE\isub\var{\valp} = \la\vartwo{\tm\isub\var{\valp}} \lasrelnaf  \la\vartwo{\tmp\isub\var{\valptwo}} = \ntmTWO\isub\var{\valptwo}$.
		
		
		\item $\ntmONE = \itmONEtwo\ntmONEtwo$ and $\ntmTWO = \itmTWOtwo\ntmTWOtwo$ with $\itmONEtwo \lasrel \itmTWOtwo$ and $\ntmONEtwo \lasrel \ntmTWOtwo$. 
		
		
		The hypothesis that $\ntmONE\isub\var\valp$ is normal is equivalent to $\itmONEtwo\isub\var\valp$ is an inert and $\ntmONEtwo\isub\var\valp$ is normal, and the hypothesis that $\ntmTWO\isub\var\valptwo$ is normal is equivalent to $\itmTWOtwo\isub\var\valptwo$ is an inert and $\ntmTWOtwo\isub\var\valptwo$ is normal.
		
		
		By \reflemma{lasrelnaf-normal-forms-lasrel-left-to-right},  $\itmONEtwo\isub\var{\valp} \lasrel \itmTWOtwo\isub\var{\valptwo}$ and $\ntmONEtwo\isub\var{\valp} \lasrel \ntmTWOtwo\isub\var{\valptwo}$. Hence $\ntmONE\isub\var{\valp} = \itmONEtwo\isub\var{\valp}\ntmONEtwo\isub\var{\valp} \lasrelnaf \itmTWOtwo\isub\var{\valptwo}\ntmTWOtwo\isub\var{\valptwo} = \ntmTWO\isub\var{\valptwo}$.
		
		
		%To conclude that $\ntmONE\isub\var\valp \lasrelnaf \ntmTWO\isub\var\valp$, what is only remaining is that $\itmONEtwo\isub\var\valp \lasrel \itmTWOtwo\isub\var\valptwo$ and  $\ntmONEtwo\isub\var\valp \lasrel \ntmTWOtwo\isub\var\valptwo$.
		
		We derive easily these facts: ($\valp\lasrelnaf\valptwo$ implies $\valp\lasrel\valptwo$ by \reflemma{lasrelnaf-normal-forms-lasrel-left-to-right})
		\[ \infer[\scsub]{\itmONEtwo\isub\var\valp \lasrel \itmTWOtwo\isub\var\valptwo}{\itmONEtwo \lasrel \itmTWOtwo & \valp \lasrel \valptwo} ~\text{and}~ \infer[\scsub]{\ntmONEtwo\isub\var\valp \lasrel \ntmTWOtwo\isub\var\valptwo}{\ntmONEtwo \lasrel \ntmTWOtwo & \valp \lasrel \valptwo}\]
		
		
		%	 By \ih we have $\itmONEtwo\isub\var{\valp} \lasrelnaf \itmTWOtwo\isub\var{\valptwo}$ and $\ntmONEtwo\isub\var{\valp} \lasrelnaf \ntmTWOtwo\isub\var{\valptwo}$. 
		%	 
		%	 \adr{Since $\ntmONE\isub\var{\valp}$ and $\ntmTWO\isub\var{\valptwo}$ are $\to$-normal, $\itmONEtwo\isub\var{\valp}$, $\itmTWOtwo\isub\var{\valptwo}$, $\ntmONEtwo\isub\var{\valp}$ and $\ntmTWOtwo\isub\var{\valptwo}$ all are $\to$-normal as well.}
		%	 
		%	 By \reflemma{lasrelnaf-normal-forms-lasrel-left-to-right},  $\itmONEtwo\isub\var{\valp} \lasrel \itmTWOtwo\isub\var{\valptwo}$ and $\ntmONEtwo\isub\var{\valp} \lasrel \ntmTWOtwo\isub\var{\valptwo}$. Hence $\ntmONE\isub\var{\valp} = \itmONEtwo\isub\var{\valp}\ntmONEtwo\isub\var{\valp} \lasrelnaf \itmTWOtwo\isub\var{\valptwo}\ntmTWOtwo\isub\var{\valptwo} = \ntmTWO\isub\var{\valptwo}$.
		%			
		
		
		
		
		\item $\ntmONE = \ntmONEtwo\esub\vartwo\itmONEtwo$ and $\ntmTWO = \ntmTWOtwo\esub\vartwo\itmTWOtwo$ with $\itmONEtwo \lasrel \itmTWOtwo$ and $\ntmONEtwo \lasrel \ntmTWOtwo$. 	The hypothesis that $\ntmONE\isub\var\valp$ is normal is equivalent to $\itmONEtwo\isub\var\valp$ is an inert and $\ntmONEtwo\isub\var\valp$ is normal and the hypothesis that $\ntmTWO\isub\var\valptwo$ is normal is equivalent to $\itmTWOtwo\isub\var\valptwo$ is an inert and $\ntmTWOtwo\isub\var\valptwo$ is normal.
		
		To conclude that $\ntmONE\isub\var\valp \lasrelnaf \ntmTWO\isub\var\valp$, what is only remaining is that $\itmONEtwo\isub\var\valp \lasrel \itmTWOtwo\isub\var\valptwo$ and  $\ntmONEtwo\isub\var\valp \lasrel \ntmTWOtwo\isub\var\valptwo$.
		
		We derive easily these facts: ($\valp\lasrelnaf\valptwo$ implies $\valp\lasrel\valptwo$ by \reflemma{lasrelnaf-normal-forms-lasrel-left-to-right})
		\[ \infer[\scsub]{\itmONEtwo\isub\var\valp \lasrel \itmTWOtwo\isub\var\valptwo}{\itmONEtwo \lasrel \itmTWOtwo & \valp \lasrel \valptwo} ~\text{and}~ \infer[\scsub]{\ntmONEtwo\isub\var\valp \lasrel \ntmTWOtwo\isub\var\valptwo}{\ntmONEtwo \lasrel \ntmTWOtwo & \valp \lasrel \valptwo}\]
		
	\end{itemize}
\end{proof}

\begin{lemma}
	\label{l:lasrelnaf-normal-forms-lasrel-right-to-left}
	If $\relsym$ is a \naf simulation.
	If $\ntm\lasrel\ntmtwo$ then $\ntm\lasrelnaf\ntmtwo$.
\end{lemma}

\begin{proof}
	By induction on the derivation $\ntm \lasrel \ntmtwo$. Cases of the last rule in the derivation of $\ntm\lasrel\ntmtwo$:
	\begin{itemize}
		\item \emph {$\scvar$}\[ \infer[\scvar]{\var \lasrel \var}{} \]
		then $\var \lasrelnaf \var$ by definition of \naf.
		\item \emph {$\scabs$} \[ \infer[\scabs]{\ntm = \la\var\tm \lasrel \la\var\tmp = \ntmtwo}{\tm \lasrel \tmp} \]
		then $\ntm \lasrelnaf \ntmtwo$ by definition of \naf with $\tm \lasrel \tmp$.
		\item \emph {$\sclift$} \[ \infer[\scabs]{\ntm \lasrel \ntmtwo}{\ntm \rel \ntmtwo} \]
		then since $\relsym$ is a \naf simulation $\ntm \relnaf \ntmtwo$, hence by \reflemma{relnaf-to-lasrelnaf-on-normal}  $\ntm \lasrelnaf \ntmtwo$.
		\item \emph {$\scapp$} \[ \infer[\scapp]{\ntm = \itmONE\ntmONE \lasrel \itmTWO\ntmTWO = \ntmtwo}{\itmONE \lasrel \itmTWO & \ntmONE \lasrel \ntmTWO} \]then $\ntm \lasrelnaf \ntmtwo$ by definition of \naf with $\itmONE \lasrel \itmTWO$ and $\ntmONE \lasrel \ntmTWO$.
		\item \emph {$\scesub$} \[ \infer[\scesub]{\ntm = \ntmONE\esub\var\itmONE \lasrel \ntmTWO\esub\var\itmTWO = \ntmtwo}{\ntmONE \lasrel \ntmTWO & \itmONE \lasrel \itmTWO} \] then $\ntm \lasrelnaf \ntmtwo$
		by definition of \naf with $\itmONE \lasrel \itmTWO$ and $\ntmONE \lasrel \ntmTWO$.
		\item \emph {$\scsub$} \[ \infer[\scsub]{\ntm = \ntmONE\isub\var\valp \lasrel \ntmTWO\isub\var\valptwo = \ntmtwo}{\ntmONE \lasrel \ntmTWO & \valp \lasrel \valptwo} \]
		by \ih we have $\ntmONE \lasrelnaf \ntmTWO$ and $\valp \lasrelnaf \valptwo$. By \reflemma{lasrelnaf-normal-forms-substitutive}, $\ntmONE\isub\var{\valp} \lasrelnaf \ntmTWO\isub\var{\valptwo}$.\qedhere
	\end{itemize}
\end{proof}


\subsection{Normal substituted terms characterization}
The two following lemmas are important to know a term behavior when a variable is substituted -- mainly for the ($\scsub$) case in the proof of Proposition \ref{prop:main-lemma_vsc}.

\begin{lemma}
	\label{l:normal-form-substituted}
	$\ntm\isub\var\valp$ is normal iff $\ntm \not = \evctxp{\isctxp\var\fire}$ and $\ntm \not  = \evctxp{\tm\esub\vartwo{\isctxp\var}}$
\end{lemma}

\begin{proof}
	($\Rightarrow$) By contraposition, $\ntm\isub\var\valp$ would not be normal in both cases.
	
	($\Leftarrow$) Suppose $\ntm\isub\var\valp$ is not normal, then find a contradiction by exposing where the reduction happens.
\end{proof}

\begin{lemma}
	$\itm\isub\var\valp$ is an inert term iff ($\itm$ is inert,) $\itm\isub\var\valp$ is normal and $\itm \not = \isctxp\var$
\end{lemma}

\begin{proof}
	($\Rightarrow$) Trivial.
	
	($\Leftarrow$) By induction on $\itm$ (using \reflemma{normal-form-substituted}).
\end{proof}

\subsection{Bottom-up lemmas for a top-down defined simulation}
These are intermediate lemmas that can be technical but do not carry much meaning for the proofs.
\reflemma{variable-inerts-stable-lasrelnaf} is essential to prove \reflemma{lasrelnaf-on-normal-subs_vsc} (one of the main sublemma for the ($\scsub$) case of the compatibility proof). \reflemma{abstraction-inerts-stable-lasrelnaf} is helpful for the compatibility proof and relating normal forms.


\paragraph{An induction principle on substitution lists.} The following \reflemma{lasrelnaf-inert-lists-induction} gives us an "induction principle" on $\isctx,\isctxtwo$ when $\isctxp\var \lasrelnaf \isctxtwop\var$ (or $\isctxp\valp \lasrelnaf \isctxtwop\valptwo$). This is quite clear when looking at how $\opnaf$ is defined (very constraining on the structure of normal forms) and because of the equivalence of $\lasrel$ and $\lasrelnaf$ on normal forms. The induction principle will facilitate proofs from now on.

\begin{lemma}
	\label{l:lasrelnaf-inert-lists-induction}
	If $\isctxp\var \lasrelnaf \isctxtwop\var$ (or $\isctxp\valp \lasrelnaf \isctxtwop\valptwo$) then either $\isctx,\isctxtwo =\ctxhole,\ctxhole$ or $\isctx,\isctxtwo = \isctxONE\esub\vartwo\itm,\isctxONEtwo\esub\vartwo\itmtwo$ with $\isctxONEp\var \lasrelnaf \isctxONEtwop\var$ (or $\isctxONEp\valp \lasrelnaf \isctxONEtwop\valptwo$) and $\itm \lasrelnaf \itmtwo$.
\end{lemma}

\begin{proof}
	By contradiction and case exhaustion, these are the only possibilities for $\isctxp\var \lasrelnaf \isctxtwop\var$ (or $\isctxp\valp \lasrelnaf \isctxtwop\valptwo$).
	\begin{itemize}
		\item If only one of the lists is empty: $\var \lasrelnaf \itm\esub\vartwo\itmtwo$ (or $\var \lasrelnaf \ntm\esub\vartwo\itmtwo$) is not possible given the definition of \naf.
		\item If $\isctx,\isctxtwo = \isctxONE\esub\vartwo\itm,\isctxONEtwo\esub\vartwo\itmtwo$ and $\neg(\itm\lasrelnaf\itmtwo)$, we again have $\neg (\ntm\esub\vartwo\itm \lasrelnaf \ntmtwo\esub\varthree\itmtwo)$.\qedhere
	\end{itemize}
\end{proof}


\begin{lemma}
	\label{l:variable-inerts-stable-lasrelnaf}
	If $\ntm \lasrelnaf \ntmtwo$ then ($\ntm =\isctxp\var$ $\iff$ $\ntmtwo = \isctxtwop\var$)
\end{lemma}

\begin{proof}
	Proof by induction on $\isctx,\isctxtwo$ using \ref{l:lasrelnaf-normal-forms-lasrel-left-to-right} and \ref{l:lasrelnaf-normal-forms-lasrel-right-to-left}.
\end{proof}

\begin{lemma}
	\label{l:abstraction-inerts-stable-lasrelnaf}
	If $\ntm \lasrelnaf \ntmtwo$ then ($\ntm =\isctxp{\la\var\tm}$ $\iff$ $\ntmtwo = \isctxtwop{\la\var\tmp}$)
\end{lemma}

\begin{proof}
	Proof by induction on $\isctx,\isctxtwo$ using \ref{l:lasrelnaf-normal-forms-lasrel-left-to-right} and \ref{l:lasrelnaf-normal-forms-lasrel-right-to-left}.
\end{proof}




\begin{lemma}
	\label{l:lasrel-stable-with-lists-subst}
	$\isctxp\var \lasrel \isctxtwop\var$, $\tm \lasrel \tmp$ and $\valp \lasrel \valptwo$ $\Rightarrow$ $\sctxp{\tm} \lasrel \sctxtwop{\tmp}$ with $\sctx \defeq \isctx\isub\var\valp$ and $\sctxtwo \defeq \isctxtwo\isub\var\valptwo$.
\end{lemma}

\begin{proof}
	$\isctxp\var$ and $\isctxtwop\var$ are normal so $\isctxp\var \lasrel \isctxtwop\var \Rightarrow \isctxp\var \lasrelnaf \isctxtwop\var$ (by lemma \ref{l:lasrelnaf-normal-forms-lasrel-right-to-left}).
	By induction on $\isctx$ ($\isctx$ and $\isctxtwo$ have same length because $\isctxp\var \lasrelnaf \isctxtwop\var$ and \reflemma{lasrelnaf-inert-lists-induction}).
	\begin{itemize}
		\item $\isctx,\isctxtwo = \ctxhole, \ctxhole$
		then \[ \tm \lasrel \tmp \]
		\item $\isctx,\isctxtwo = \isctxONE\esub\vartwo\itm, \isctxONEtwo\esub\vartwo\itmtwo$ we have $\itm \lasrel \itmtwo$ and $\isctxONEp\var \lasrel \isctxONEtwop\var$ by $\isctxp\var \lasrelnaf \isctxtwop\var$ 
		by \ih we get $\sctxONEp{\tm} \lasrel \sctxONEtwop{\tmp}$ where $\sctxONE \defeq \isctxONE\isub\var\valp$ and $\sctxONEtwo \defeq \isctxONEtwo\isub\var\valptwo$.
		Then:
		\[\infer[\scesub]{\sctxp{\tm} =\sctxONEp{\tm}\esub\vartwo{\itm\isub\var\valp} \lasrel \sctxONEtwop{\tmp}\esub\vartwo{\itmtwo\isub\var\valptwo}= \sctxtwop{\tm}}{\sctxONEp{\tm} \lasrel \sctxONEtwop{\tmp} & \infer{\itm\isub\var\valp \lasrel \itmtwo\isub\var\valptwo}{\itm \lasrel \itmtwo & \valp \lasrel \valptwo}}\]\qedhere
	\end{itemize}
\end{proof}

\begin{lemma}
	\label{l:lasrelnaf-values-isctx-decomposition}
	$\isctxp\valp \lasrelnaf \isctxtwop\valptwo \iff \valp \lasrelnaf \valptwo$ and $ \isctxp\var \lasrelnaf \isctxtwop\var$ ($\var$ is fresh)
\end{lemma}

\begin{proof}
	By induction on lists $\isctx, \isctxtwo$. (They are of the same size because of how \naf is defined - see \reflemma{lasrelnaf-inert-lists-induction})
	\begin{itemize}
		\item $\isctx,\isctxtwo =\ctxhole,\ctxhole$ then $\valp \lasrelnaf \valptwo \iff \valp \lasrelnaf \valptwo$ and $\var\lasrelnaf\var$ is always true by case (\naf 2).
		\item $\isctx,\isctxtwo =\isctxONE\esub\vartwo\itm,\isctxONEtwo\esub\vartwo\itmtwo$, then
		
		by case (\naf 5), $\isctxp\valp \lasrelnaf \isctxtwop\valptwo \iff \isctxONEp\valp \lasrel \isctxONEtwop\valptwo$ and $\itm \lasrel \itmtwo$ 
		
		by \reflemma{lasrelnaf-normal-forms-lasrel-right-to-left}, $\iff \isctxONEp\valp \lasrelnaf \isctxONEtwop\valptwo$ and $\itm \lasrel \itmtwo$
		
		by \ih, $\iff \isctxONEp\var \lasrelnaf \isctxONEtwop\var$, $\valp \lasrelnaf \valptwo$ and $\itm \lasrel \itmtwo$
		
		by \reflemma{lasrelnaf-normal-forms-lasrel-left-to-right}, $\iff \isctxONEp\var \lasrel \isctxONEtwop\var$, $\valp \lasrelnaf \valptwo$ and $\itm \lasrel \itmtwo$
		
		and finally by case (\naf 5) $\iff \isctxp\var=\isctxONEp\var\esub\vartwo\itm \lasrelnaf \isctxONEtwop\var\esub\vartwo\itmtwo= \isctxtwop\var$, $\valp \lasrelnaf \valptwo$.\qedhere
	\end{itemize}
\end{proof}

%\begin{lemma}
%	\label{l:lasrelnaf-normal-forms-isctx-decomposition}
%	$\ntm \lasrelnaf \ntmtwo$ and $ \isctxp\var \lasrelnaf \isctxtwop\var$ ($\var$ is fresh) $\Rightarrow \isctxp\ntm \lasrelnaf \isctxtwop\ntmtwo$
%\end{lemma}

%\begin{lemma}
%	\label{l:lasrel-normal-forms-isctx-decomposition}
%	$\ntm \lasrel \ntmtwo$ and $ \isctxp\var \lasrelnaf \isctxtwop\var$ ($\var$ is fresh) $\Rightarrow \isctxp\ntm \lasrel \isctxtwop\ntmtwo$
%\end{lemma}
%\begin{proof}
%	By induction on $\isctx,\isctxtwo$.
%\end{proof}

\begin{lemma}
	\label{l:lasrelnaf-normal-forms-isctx-decomposition}
	$\ntm \lasrelnaf \ntmtwo$ and $ \isctxp\var \lasrelnaf \isctxtwop\var$ ($\var$ is fresh) $\Rightarrow \isctxp\ntm \lasrelnaf \isctxtwop\ntmtwo$
\end{lemma}
\begin{proof}
	By induction on $\isctx,\isctxtwo$.
\end{proof}

\subsection{Coherence of simulation and evaluation}
\label{section:lemmas-implicit-case-naf-proof}
We divide Proposition \ref{prop:naf-coherence} into two lemmas: \reflemma{lasrelnaf-on-normal-subs_vsc} and \reflemma{lasrelnaf-not-normal-subs}. Notice that part of the conclusion for the first part of \refprop{naf-coherence} was already proven in \ref{l:lasrelnaf-normal-forms-substitutive}.
	
\gettoappendix{prop:naf-coherence}

\begin{lemma}
	\label{l:lasrelnaf-on-normal-subs_vsc}
	Let $\rel$ be an \naf simulation, $\ntm \lasrelnaf \ntmtwo$, and $\valp\lasrelnaf\valptwo$. If $\ntm\isub\var\valp$ is $\tovscp$-normal then $\ntmtwo\isub\var\valptwo$ is $\tovscp$-normal.
\end{lemma}

\begin{proof}
	By induction on normal forms $\ntm$ for which $\ntm\isub\var\valp$ is $\tovscp$-normal:
	\begin{itemize}
		\item \emph{Variable}. Two sub-cases:
		\begin{itemize}
			\item $\ntm= \var$ and so $\ntm\isub\var\valp = \valp$. Then $\ntmtwo = \var$ by case (\naf 2) and $\ntmtwo\isub\var\valptwo = \valptwo$, which is $\tovscp$-normal. 
			
			
			\item $\ntm= \vartwo$ and so $\ntm\isub\var\valp = \vartwo$. Then $\ntmtwo = \vartwo$ by case (\naf 2) and $\ntmtwo\isub\var\valptwo = \vartwo$, which is $\tovscp$-normal. 
		\end{itemize}
		
		\item \emph{Abstraction}, that is, $\ntm = \la\vartwo\tm$ and so $\ntm\isub\var\valp = \la\vartwo\tm\isub\var\valp$. Then $\ntmtwo= \la\vartwo\tmp$ with $\tm \lasrel \tmp$. We have that $\ntmtwo\isub\var\valptwo = \la\vartwo\tmp\isub\var\valptwo$, which is $\tovscp$-normal.
		
		\item \emph{Substituted Inert}, that is, $\ntm = \ntmONE\esub\vartwo\itmONE$ and so $\ntm\isub\var\valp = \ntmONE\isub\var\valp\esub\vartwo{\itmONE\isub\var\valp}$.
		$\ntm\isub\var\valp$ is normal is equivalent to $\itmONE\isub\var\valp$ is inert (\ie $\itmONE\isub\var\valp$ is normal and $\itmONE\not = \isctxp\var$) and $\ntmONE\isub\var\valp$ is normal -- else this substitution would be a redex.
		Then $\ntmtwo = \ntmONEtwo\esub\vartwo\itmONEtwo$ with $\itmONE \lasrel \itmONEtwo$ and $\ntmONE \lasrel \ntmONEtwo$, which implies $\itmONE \lasrelnaf \itmONEtwo$ and $\ntmONE \lasrelnaf \ntmONEtwo$ by \reflemma{lasrelnaf-normal-forms-lasrel-right-to-left}.
		By \ih we then have $\itmONEtwo\isub\var\valptwo$ is $\tovscp$-normal, $\ntmONEtwo\isub\var\valptwo$ is $\tovscp$-normal.
		
		We conclude by stating $\ntmtwo\isub\var\valptwo$ is $\tovscp$-normal :
		since $\itmONEtwo\isub\var\valptwo$ and $\ntmONEtwo\isub\var\valptwo$ are $\tovscp$-normal the only possibility which would trigger a $\toe$-step is that $\itmONEtwo = \isctxtwop\var$. But $\itmONE \lasrelnaf \itmONEtwo$, (by \reflemma{variable-inerts-stable-lasrelnaf}) would mean $\itmONE = \isctxp\var$ which is impossible since $\ntm\isub\var\valp = \ntmONE\isub\var\valp\esub\vartwo{\itmONE\isub\var\valp}$ is normal by assumption.
		
		
		\item \emph{Applied Inert}, that is, $\ntm = \itmONE\ntmONE$ and so $\ntm\isub\var\valp = {\itmONE\isub\var\valp}\ntmONE\isub\var\valp$.
		$\ntm\isub\var\valp$ is normal is equivalent to $\itmONE\isub\var\valp$ is inert (\ie $\itmONE\isub\var\valp$ is normal and $\itmONE\not = \isctxp\var$) and $\ntmONE\isub\var\valp$ is normal -- else this application would be a redex.
		Then $\ntmtwo = \itmONEtwo\ntmONEtwo$ with $\itmONE \lasrel \itmONEtwo$ and $\ntmONE \lasrel \ntmONEtwo$, which implies $\itmONE \lasrelnaf \itmONEtwo$ and $\ntmONE \lasrelnaf \ntmONEtwo$ by \reflemma{lasrelnaf-normal-forms-lasrel-right-to-left}.
		By \ih we then have $\itmONEtwo\isub\var\valptwo$ is $\tovscp$-normal, $\ntmONEtwo\isub\var\valptwo$ is $\tovscp$-normal.
		
		We conclude by stating $\ntmtwo\isub\var\valptwo$ is $\tovscp$-normal :
		since $\itmONEtwo\isub\var\valptwo$ and $\ntmONEtwo\isub\var\valptwo$ are $\tovscp$-normal the only possibility which would trigger a $\tom$-step is that $\itmONEtwo = \isctxtwop\var$. By $\itmONE \lasrelnaf \itmONEtwo$, (by \reflemma{variable-inerts-stable-lasrelnaf}) would mean $\itmONE = \isctxp\var$ which is impossible since $\ntm\isub\var\valp = {\itmONE\isub\var\valp}\ntmONE\isub\var\valp$ is normal by assumption.\qedhere
		
	\end{itemize}
\end{proof}

\begin{lemma} 
	\label{l:lasrelnaf-not-normal-subs}
	If $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$, $\valp \lasrel \valptwo$
	and $\ntm_\tmrone\isub\var{\valp} \tovscp \tmronep$
	then $\ntm_\tmrtwo\isub\var{\valptwo}  \tovscp \tmrtwop$ and $\tmronep \lasrel \tmrtwop$.
\end{lemma}

\begin{proof}
	(We write $\valp=\la\vartwo\tmfour$ and $\valptwo = \la\vartwo\tmfourp$ with $\tmfour \lasrel \tmfourp$ - using the fact that ($\valp \lasrel \valptwo \Rightarrow \valp \lasrelnaf \valptwo$) by \ref{l:lasrelnaf-normal-forms-lasrel-right-to-left}.)
	
	If $\ntm_\tmrone\isub\var{\valp} \tovscp \tmronep$ then $\ntm_\tmrone = \evctxp{\isctxp\var\fire}$ or $\ntm_\tmrone = \evctxp{\fire\esub\vartwo{\isctxp\var}}$ ($\evctx$ is the context where the reduction has been done).
	Show (by induction on $\evctx$) that $\tmronep \lasrel \tmrtwop$.
	\begin{itemize}
		\item $\evctx = \ctxhole$
		then $\ntm_\tmrone = \isctxp\var\fire$ or $\ntm_\tmrone = \fire\esub\vartwo{\isctxp\var}$, 
		\begin{itemize}
			\item \emph {$\ntm_\tmrone = \isctxp\var\fire$} by $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$ we have $\ntm_\tmrtwo = \isctxtwop\var\firetwo$ with $\isctxp\var \lasrel \isctxtwop\var$ and $\fire \lasrel \firetwo$. 
			Set $\sctx \defeq \isctx\isub\var\valp$ and $\sctxtwo \defeq \isctxtwo\isub\var\valptwo$.
			
			$\ntm_\tmrtwo\isub\var\valptwo = \sctxtwop\valptwo\firetwo\isub\var\valptwo\tovscp \sctxtwop{\tmfourp\esub\vartwo{\firetwo\isub\var\valptwo}} = \tmrtwop$
			
			We also have $\ntm_\tmrone\isub\var\valp \tovscp \sctxp{\tmfour\esub\vartwo{\fire\isub\var\valp}} = \tmronep$ and we can build the following derivation:
			\[ \infer[\scesub]{\tmfour\esub\vartwo{\fire\isub\var\valp} \lasrel \tmfourp\esub\vartwo{\firetwo\isub\var\valptwo}}{\tmfour \lasrel \tmfourp & \infer{\fire\isub\var\valp \lasrel \firetwo\isub\var\valptwo}{\fire \lasrel \firetwo & \valp \lasrel \valptwo}} \]
			and by \reflemma{lasrel-stable-with-lists-subst} we get
			\[ \tmronep = \sctxp{\tmfour\esub\vartwo{\fire\isub\var\valp}} \lasrel \sctxtwop{\tmfourp\esub\vartwo{\firetwo\isub\var\valptwo}} = \tmrtwop\]
			hence the result $\ntm_\tmrone\isub\var\valp \tovscp \tmronep$, $\ntm_\tmrtwo\isub\var\valptwo \tovscp \tmrtwop$ and $\tmronep \lasrel \tmrtwop$.
			
			
			\item \emph {$\ntm_\tmrone = \fire\esub\vartwo{\isctxp\var}$} by $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$ we have $\ntm_\tmrtwo = \firetwo\esub\vartwo{\isctxtwop\var}$ with $\isctxp\var \lasrel \isctxtwop\var$ and $\fire \lasrel \firetwo$. 
			
			Set $\sctx \defeq \isctx\isub\var\valp$ and $\sctxtwo \defeq \isctxtwo\isub\var\valptwo$.
			
			$\ntm_\tmrtwo\isub\var\valptwo = \firetwo\isub\var\valptwo\esub\vartwo{\sctxtwop\valptwo}\tovscp \sctxtwop{{\firetwo\isub\var\valptwo}\isub\vartwo\valptwo} = \tmrtwop$
			
			We also have $\ntm_\tmrone\isub\var\valp \tovscp \sctxp{{\fire\isub\var\valp}\isub\vartwo\valp} = \tmronep$ and we can build the following derivation:
			\[ \infer[\scsub]{{{\fire\isub\var\valp}\isub\vartwo\valp} \lasrel {{\firetwo\isub\var\valptwo}\isub\vartwo\valptwo}}{\infer{\fire\isub\var\valp \lasrel \firetwo\isub\var\valptwo}{\fire \lasrel \firetwo & \valp \lasrel \valptwo} & \valp \lasrel \valptwo} \]
			and by \reflemma{lasrel-stable-with-lists-subst} we get
			\[ \tmronep = \sctxp{{\fire\isub\var\valp}\isub\vartwo\valp} \lasrel \sctxtwop{{\firetwo\isub\var\valptwo}\isub\vartwo\valptwo} = \tmrtwop\]
			
			hence the result $\ntm_\tmrone\isub\var\valp \tovscp \tmronep$, $\ntm_\tmrtwo\isub\var\valptwo \tovscp \tmrtwop$ and $\tmronep \lasrel \tmrtwop$.
			
		\end{itemize}
		\item $\evctx = \tmtwo\evctxONE$ ($\tmtwo = \itm$ because $\ntm_\tmrone$ is normal) 	then $\ntm_\tmrone = \itm\evctxONEp\tmthree$ (where $\tmthree = \isctxp\var\firetwo$ or $\tmthree = \firetwo\esub\vartwo{\isctxp\var}$).
		Then by $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$, $\ntm_\tmrtwo = \itmtwo\ntmONE$ with $\itm \lasrel \itmtwo$ and $\evctxONEp\tmthree \lasrel \ntmONE$.
		$\evctxONEp\tmthree\isub\var\valp \tovscp \tm$ by hypothesis ($\ntm_\tmrone\isub\var\valp \tovscp \tmronep$ is in this case $\itm\isub\var\valp\evctxONEp\tmthree\isub\var\valp \tovscp \tm\fire\isub\var\valp$) and $\evctxONEp\tmthree \lasrelnaf \ntmONE$ (normal forms, apply lemma \ref{l:lasrelnaf-normal-forms-lasrel-right-to-left}), hence by \ih $\ntmONE\isub\var\valptwo \tovscp \tmp$ with $\tm \lasrel \tmp$
		\[\infer{\tmronep=\itm\isub\var\valp\tm \lasrel \itmtwo\isub\var\valptwo\tmp = \tmrtwop}{ \infer{\itm\isub\var\valp \lasrel \itmtwo\isub\var\valptwo}{\itm \lasrel \itmtwo & \valp \lasrel \valptwo} & \tm \lasrel \tmp}\]
		
		hence $\ntm_\tmrone\isub\var\valp \tovscp \tmronep$, $\ntm_\tmrtwo\isub\var\valptwo \tovscp \tmrtwop$ and $\tmronep \lasrel \tmrtwop$.
		
		\item $\evctx = \evctxONE\tmtwo$ ($\tmtwo = \fire$ because $\ntm_\tmrone$ is normal) then $\ntm_\tmrone = \evctxONEp\tmthree\fire$ (where $\tmthree = \isctxp\var\firetwo$ or $\tmthree = \firetwo\esub\vartwo{\isctxp\var}$).
		Then by $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$, $\ntm_\tmrtwo = \ntmONE\firep$ with $\fire \lasrel \firep$ and $\evctxONEp\tmthree \lasrel \ntmONE$.
		$\evctxONEp\tmthree\isub\var\valp \tovscp \tm$ by hypothesis ($\ntm_\tmrone\isub\var\valp \tovscp \tmronep$ is in this case $\evctxONEp\tmthree\isub\var\valp\fire\isub\var\valp \tovscp \tm\fire\isub\var\valp$) and $\evctxONEp\tmthree \lasrelnaf \ntmONE$ (normal forms, apply lemma \ref{l:lasrelnaf-normal-forms-lasrel-right-to-left}), hence by \ih $\ntmONE\isub\var\valptwo \tovscp \tmp$ with $\tm \lasrel \tmp$
		\[\infer{\tmronep=\tm\fire\isub\var\valp \lasrel \tmp\firep\isub\var\valptwo = \tmrtwop}{\tm \lasrel \tmp & \infer{\fire\isub\var\valp \lasrel \firep\isub\var\valptwo}{\fire \lasrel \firep & \valp \lasrel \valptwo}}\]
		
		hence $\ntm_\tmrone\isub\var\valp \tovscp \tmronep$, $\ntm_\tmrtwo\isub\var\valptwo \tovscp \tmrtwop$ and $\tmronep \lasrel \tmrtwop$.
		
		
		\item $\evctx = \tmtwo\esub\varthree\evctxONE$ ($\tmtwo = \fire$ because $\ntm_\tmrone$ is normal) then $\ntm_\tmrone = \fire\esub\varthree{\evctxONEp\tmthree}$ (where $\tmthree = \isctxp\var\firetwo$ or $\tmthree = \firetwo\esub\vartwo{\isctxp\var}$).
		Then by $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$, $\ntm_\tmrtwo = \firep\esub\varthree\ntmONE$ with $\fire \lasrel \firep$ and $\evctxONEp\tmthree \lasrel \ntmONE$.
		$\evctxONEp\tmthree\isub\var\valp \tovscp \tm$ by hypothesis ($\ntm_\tmrone\isub\var\valp \tovscp \tmronep$ is in this case \\ $\fire\isub\var\valp\esub\varthree{\evctxONEp\tmthree\isub\var\valp}\tovscp\fire\isub\var\valp\esub\varthree{\tm}$) and $\evctxONEp\tmthree \lasrelnaf \ntmONE$ (normal forms, apply lemma \ref{l:lasrelnaf-normal-forms-lasrel-right-to-left}), hence by \ih $\ntmONE\isub\var\valptwo \tovscp \tmp$ with $\tm \lasrel \tmp$
		\[\infer{\tmronep=\fire\isub\var\valp\esub\varthree\tm \lasrel \firep\isub\var\valptwo\esub\varthree\tmp = \tmrtwop}{ \infer{\fire\isub\var\valp \lasrel \firep\isub\var\valptwo}{\fire \lasrel \firep & \valp \lasrel \valptwo} & \tm \lasrel \tmp}\]
		
		hence $\ntm_\tmrone\isub\var\valp \tovscp \tmronep$, $\ntm_\tmrtwo\isub\var\valptwo \tovscp \tmrtwop$ and $\tmronep \lasrel \tmrtwop$.
		
		\item $\evctx = \evctxONE\esub\varthree\tmtwo$ ($\tmtwo = \itm$ because $\ntm_\tmrone$ is normal) then $\ntm_\tmrone = \evctxONEp\tmthree\esub\varthree{\itm}$ (where $\tmthree = \isctxp\var\firetwo$ or $\tmthree = \firetwo\esub\vartwo{\isctxp\var}$).
		Then by $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$, $\ntm_\tmrtwo = \ntmONE\esub\varthree\itmtwo$ with $\itm \lasrel \itmtwo$ and $\evctxONEp\tmthree \lasrel \ntmONE$.
		$\evctxONEp\tmthree\isub\var\valp \tovscp \tm$ by hypothesis ($\ntm_\tmrone\isub\var\valp \tovscp \tmronep$ is in this case\\ ${\evctxONEp\tmthree\isub\var\valp}\esub\varthree{\itm\isub\var\valp} \tovscp \fire\isub\var\valp\esub\varthree{\tm}$) and $\evctxONEp\tmthree \lasrelnaf \ntmONE$ (normal forms, apply lemma \ref{l:lasrelnaf-normal-forms-lasrel-right-to-left}), hence by \ih $\ntmONE\isub\var\valptwo \tovscp \tmp$ with $\tm \lasrel \tmp$
		\[\infer{\tmronep=\tm\esub\varthree{\itm\isub\var\valp}\lasrel \tmp\esub\varthree{\itmtwo\isub\var\valptwo} = \tmrtwop}{ \tm \lasrel \tmp &  \infer{\itm\isub\var\valp \lasrel \itmtwo\isub\var\valptwo}{\itm \lasrel \itmtwo & \valp \lasrel \valptwo}}\]
		
		hence $\ntm_\tmrone\isub\var\valp \tovscp \tmronep$, $\ntm_\tmrtwo\isub\var\valptwo \tovscp \tmrtwop$ and $\tmronep \lasrel \tmrtwop$.\qedhere
	\end{itemize}
\end{proof}


\subsection{Proof of Proposition \ref{prop:main-lemma_vsc}}
This subsection contains the main statement and its proof, relying on all the lemmas we have proved so far in this section.


\gettoappendix{prop:main-lemma_vsc}

\begin{proof}[Proof of (1)]
	By induction on $(k,d)$ where $d$ is the size of the derivation of $\tmrone \lasrel \tmrtwo$.
	
	\input{proofs/appendix-proof-compatibility-naf-lasrelnafversion}
\end{proof}
