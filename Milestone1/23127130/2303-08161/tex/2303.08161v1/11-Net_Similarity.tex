% !TEX root = main.tex
\section{Net Similarity for the Value Substitution Calculus}
\label{sect:net}
In this section, we finally define the normal form similarity for the VSC we are interested in, \emph{net similarity}, which extends $\leqnaf$ along two axes:
\begin{enumerate}
\item \emph{Variables}: allowing evaluation to substitute variables via $\toevar$, in order to prove the equivalence of Turing's and Curry's fix-point combinators, and 
\item \emph{Structural Equivalence}: allowing simulations to test terms modulo structural equivalence $\streq$, in order to avoid artificial distinctions of indistinguishable terms. 
\end{enumerate}
The problematic addition of the left identity equivalence $\equivlid$ is discussed at the end of the section.

\paragraph{Allowing Evaluation to Substitute Variables}
Adding $\toevar$ to $\tovscp$ we obtain the full reduction $\tovsc$. This fact changes the grammar of inert terms and normal forms, because a variable $\var$ is no longer an inert term and terms such as $\vartwo\esub\vartwo\var$ are no longer normal. The new grammar then is:
\begin{center}
	$\begin{array}{r@{\hspace{.5cm}}rlll}
	
	\textsc{ Inert Substitution Contexts} & \isctx & \grameq &  \ctxhole\mid \isctx\esub{\var}{\itm} 
	\\
	\textsc{Inert terms}  &
	\itm,\itmtwo & \grameq &  \isctxp\var\ntm\mid \itm\ntm\mid \itm\esub\var\itmtwo
	\\
	\textsc{$\tovsc$-normal forms}  &
	\ntm,\ntmtwo & \grameq &  \val\mid \itm\mid \ntm\esub\var\itmtwo
\end{array}
$\end{center}

Since the case $\isctxp\var\ntm$ is quite unpleasant to manage in proofs, we go one step further and consider normal forms modulo $\equivsone$, picking the $\equivsone$-representant of each normal form where the context $\isctx$ has been pushed out of the unpleasant case for inert terms. This can be done harmlessly because $\equivsone$ by itself verifies strong \emph{commutation} with respect to $\tovsc$ and the described representant can be easily described at the big-step level. 

\begin{lemma}
$\tm$ is $\tovsc$-normal if and only if $\tm \equivsone \ntm$ where $\ntm$ is given by the following grammar.
\begin{center}
	$\begin{array}{r@{\hspace{.5cm}}rlll}
		\textsc{Applicative Inert terms}  &
		\itmapp,\itmapptwo & \grameq &  \var\fire\mid \itmapp\fire
		\\
		\textsc{Inert terms}  &
		\itm,\itmtwo & \grameq &  \itmapp\mid \itm\esub\var\itmtwo
		\\
		\tovsc\textsc{-normal forms modulo $\equivsone$}  &
		\fire,\firetwo, \ntm & \grameq &  \val \mid \itm\mid \fire\esub\var\itmtwo
	\end{array}
	$\end{center}
\end{lemma}
Note the notion of applicative inert terms, which are specific inert terms where no substitutions can be pushed outward by $\equivsone$. 
Example: the $\tovsc$-normal form $\tm =\var\esub\var{\vartwo\vartwo}\varthree$ does not belong to grammar above, but $\tm \equivsone (\var\varthree)\esub\var{\vartwo\vartwo} = \ntm$ and $\ntm$ is described by the grammar.

\paragraph{Big-Step Evaluation} We then need to express evaluation to $\tovsc$-normal form modulo $\equivsone$ as a big-step predicate. For that, we re-define the inert substitution contexts, which at first sight are defined as before, except that the notion of inert term now has changed.
\begin{center}
	$\begin{array}{r@{\hspace{.5cm}}rlll}
		\textsc{Inert Substitution Contexts} & \isctx & \grameq &  \ctxhole\mid \isctx\esub{\var}{\itm} 
	\end{array}
	$\end{center}

\begin{definition}[Big-step evaluation $\bsvsct k$]
Big-step $\VSCmodulo$ evaluation $\tm \bsvsct k \ntm$ is given by:
\begin{center}
		\input{figures/VSC-big-step-extended}
\end{center}
\emph{Notation}: $\tm \bsvscts \fire$ abbreviates \emph{there exists a $k$ such that $\tm \bsvsct k \fire$}.
\end{definition}

 The given big-step system captures $\equivsone$ via the rules ($\bsvsctapvar$) and ($\bsvsctapi$): when applying an inert term / variable surrounded by an inert context $\isctx$ to a normal term $\ntm$, the context $\isctx$ is pushed out of the application, obtaining $\isctxp{\var\fire}$ and $\isctxp{\itmapp\fire}$ instead of $\isctxp{\var}\fire$ and $\isctxp{\itmapp}\fire$. As a result, the $\bsvsctsym$-normal forms are exactly those of the given grammar for $\tovsc$-normal forms modulo $\equivsone$.

	We prove this big-step system to be correct and complete with respect to small-step reduction. 	Importantly, substitutivity also smoothly adapts.
	\begin{toappendix}
	\begin{proposition}
		\label{l:ss-bs-equivalence_vsce}
		$\tm \bsvsct k \fire$ if and only if $\tm \tovsc^k \firep \equivsone \fire$ with $\firep$ normal.
	\end{proposition}
	\end{toappendix}
	
%	\begin{proof}
%		Similar to the one for the \VSCptxt big step system.
%	\end{proof}
	

	\begin{toappendix}
	\begin{proposition}[Substitutivity]
		\label{prop:substitutivity_vsce}
	\hfill
	\begin{enumerate}
	\item 
	\emph{Small-step}: if $\tm~\tovsc~\tmp$ then $\tm\isubst\val\var ~\tovsc~ \tmp\isubst\val\var$.
	\item 
	\emph{Big-step}: 	if $\tm\isubst\val\var \bsvsct k \ntm$ then $\exists$ $k'$ and $\ntmtwo$ such that $ \tm \bsvsct {k'} \ntmtwo$ and $\ntmtwo\isubst\val\var\bsvsct {k-k'} \ntm$.
	\end{enumerate}
\end{proposition}
\end{toappendix}

	\paragraph{Adding Structural Equivalence to Simulations, Parametrically} We are now going to refine the definition of \naf similarity by adding structural equivalence $\streq$. In fact, we are going to do something more general, in order to obtain a whole family of similarities. We abstract away structural equivalence $\streq$ as a more abstract notion of \emph{mirror equivalence} $\equivx$, defined by the properties of $\streq$ that are needed to prove that similarity modulo $\streq$ is compatible. Then, similarity is defined \emph{parametrically} in a mirror $\equivx$, and net similarity is obtained by taking $\streq$ as mirror. The terminology \emph{mirror} is meant to suggest that $\equivx$ can modify terms only in inessential ways.
	
\begin{definition}[Mirror]
A relation $\equivx$ is a \emph{mirror} for $\tovsc$ when:
\begin{enumerate}
\item \emph{Strong commutation}: if  $\tm \equivx\tmtwo$ and $ \tm \tovsc\tmp$ then $\tmtwo \tovsc\tmtwop$ and $\tmp\equivx\tmtwop$.

\item \emph{Substitutivity}: if $\tm\equivx\tmtwo$ then $\tm\isub\var\val \equivx \tmtwo\isub\var\val$ for all values $\val$.
\end{enumerate}
\end{definition}

\begin{definition}[Mirrored and \net similarities]
	Let $\relsym$ be relation and $\equivx$ be a mirror over VSC terms.	We say that $\relsym$ is a \emph{$\equivx$-mirrored (\nafex) simulation} if $\relsym\subseteq\relvscx$, where $\tm \relvscx\tmp$ holds whenever $\tm,\tmp$ satisfy one of the following clauses:
	\begin{center}
		$\begin{array}{r@{\hspace{.3cm}}r@{\hspace{.3cm}}l@{\hspace{.3cm}}l@{\hspace{.3cm}}lll}
		\textup{(\nafex 1)} & &&\tm\bsvsctdiv & \ie ~ \text{has no} \tovsc \text{-normal form.}
		\\
		\textup{(\nafex 2)} & \tm \bsvscts \var  &\text{and}& \tmp \bsvscts \var
		\\
		\textup{(\nafex 3)} & \tm \bsvscts \la\var\tmfirst &\text{and}& \tmp \bsvscts \la\var\tmpfirst 
		& \text{with} ~ \tmfirst \rel \tmpfirst
		\\
		\textup{(\nafex 4)} & \tm \bsvscts \ntmONE \ntmTWO &\text{and}& \tmp \bsvscts \ntmtwo \equivx \ntmONEtwo \ntmTWOtwo
		& \text{with} ~ \ntmONE \rel \ntmONEtwo ~\text{and}~ \ntmTWO \rel \ntmTWOtwo
		\\
		\textup{(\nafex 5)} & \tm \bsvscts \ntmONE\esub\var\ntmTWO &\text{and}& \tmp \bsvscts \ntmtwo \equivx \ntmONEtwo\esub\var\ntmTWOtwo
		& \text{with} ~ \ntmONE \rel \ntmONEtwo ~\text{and}~ \ntmTWO \rel \ntmTWOtwo
	\end{array}
	$\end{center}
		$\equivx$-Mirrored (\nafex) similarity , written $ \leqvscx $, is defined the largest $\equivx$-mirrored simulation.
		
		\Net simulations and \net similarity $\leqnet$ are defined as the $\equivx$-mirrored simulations and similarities with structural equivalence $\streq$ as mirror $\equivx$.
\end{definition}

As for \naf similarity, case (\nafex 4) and (\nafex 5) can be rewritten using the grammar of normal forms, which is useful for clarity in proofs (keep in mind here that inerts are not the same terms in VSCp and $\VSCmodulo$). For (\nafex 4), it actually splits in two:
	\begin{center}
		$\begin{array}{r@{\hspace{.3cm}}r@{\hspace{.3cm}}l@{\hspace{.3cm}}l@{\hspace{.3cm}}lll}
		
		\text{(\nafex 4a)} & \tm \bsvscts \var \ntm &\textit{and}& \tmp \bsvscts \var \ntmtwo 
		& \textit{with}~\ntm \rel \ntmtwo
		\\
		\text{(\nafex 4b)} & \tm \bsvscts \itmapp \ntm &\textit{and}& \tmp \bsvscts \itmapptwo \ntmtwo 
		& \textit{with} ~ \itmapp \rel \itmapptwo ~\textit{and}~ \ntm \rel \ntmtwo
		\\
		\text{(\nafex 5)} & \tm \bsvscts \ntm\esub\var\itm &\textit{and}& \tmp \bsvscts \ntmtwo\esub\var\itmtwo
	& \textit{with} ~ \itm \rel \itmtwo ~\textit{and}~ \ntm \rel \ntmtwo
	\end{array}
	$\end{center}

\paragraph{Compatibility} The compatibility proof for $\leqvscx$ follows the same structure of the one for $\leqnaf$ (in Appendix E). At the evaluation level, we have already seen that substitutivity holds also with the addition of the substitution of variables $\toevar$ and the equivalence $\equivsone$. At the level of the simulation, we need to refine the notion of Lassen closure, by adding rule $\mscequivx$ accounting for mirrors.
\begin{definition}[Mirrored Lassen closure]
Let the \emph{mirrored Lassen closure} $\mlasrelsym$ of $\relsym$ be:
	\begin{center}
		\input{figures/RSC-lassen-for-nafexstruct}		
	\end{center}
\end{definition}
Then the reasoning for compatibility---and in particular the coherence properties---smoothly adapts, using the mirror properties for rule $\mscequivx$ in the proof that the closure preserves mirrored simulations. In particular, strong commutation of $\equivx$ implies that it preserves normal forms and steps, that is, the coherence properties. Summing up, we obtain our main result.
\begin{toappendix}
\begin{theorem}[Compatibility and soundness of $\leqvscx$ and $\leqnet$]
	\label{thm:nafex-included-leqc}
Let $\equivx$ be a mirror.
	\begin{enumerate}
	\item \emph{Redundancy of the mirrored Lassen closure}: $\leqvscx \,= \mlassenop \leqvscx$.
	\item \Nafex similarity $\leqvscx$ is compatible and included in the \cbv contextual preorder $\leqcv$.
	\item \Net similarity $\leqnet$ is compatible and included in the \cbv contextual preorder $\leqcv$.
	\end{enumerate}
\end{theorem}
\end{toappendix}


\paragraph{Fixpoints and Benchmarks.} For any mirror $\equivx$, and in particular for $\equivx\defeq Id$ and $\equivx\defeq \streq$, one can show that Turing's and Curry's \cbv fixpoint combinators are \nafex bisimilar. The proof relies on exactly the same relation that for naive bisimilarity (\refprop{naive-fix-points-equiv}). As for \naf similarity, \nafex and net similarities validate scrutable equivalence $\equivscr$. It does not however validate $\eta_v$ equivalence, one has to change the case for abstractions to accommodate it, and it does not validate \cbn duplication, as for instance $(\vartwo\var\var)\esub\var{\varthree\Id}$ and $\vartwo(\varthree\Id)(\varthree\Id)$ are both $\tovsc$-normal but not $\streq$-equivalent. 


%\paragraph{Net similarity includes structural equivalence, and more}Naturally, structurally equivalent terms are net bisimilar. However net similarity is able to relate more, in the sense that it can equate terms the \emph{strong} normal forms of which are $\streq$-equivalent: 
%
%\begin{center}
%	$\ntm_1 = \la\var{(\la\vartwo(\la\varthree\tm)\tmtwo)\tmthree}\eqnet\la\var{(\la\varthree(\la\vartwo\tm)\tmthree)\tmtwo} = \ntm_2$ whereas $\ntm_1 \not \streq \ntm_2$
%\end{center}

%\adr{add example with infinite normal forms}

%Let $A \defeq \la\var{\tm\tmtwo\esub\varthree\tmthree\var}$ and $B \defeq \la\var{(\tm\tmtwo)\esub\varthree\tmthree\var}$. We can show that $\curryfix A \eqnet \curryfix B$.


\paragraph{Left Identity Is Not Validated By \Nafex} Analogously, \net similarity does not validate Moggi's $\equivlid$ rule, because $\var\esub\var{\vartwo\Id} \not \streq \vartwo\Id$. Therefore, \enf similarity is not included in \net similarity. About adding $\equivlid$, it is easy to define a \nafexp\equivlid bisimulation, but the current  compatibility proof does not go through, as $\equivlid$ is not a mirror for $\tovsc$ (in particular, it does not strongly commute with $\tovsc$) and the proof technique is not able (for now) to handle $\equivlid$ terms, as it breaks coherence for normal forms, that is, the fact that if  $\ntm\,\mlasrelsym \tm$ then $\tm$ is normal (and the symmetric statement).

One could also add $\equivlid$ as a reduction step in the calculus, but then the reduction is no longer diamond, and the diamond property (or at least the invariance of the number of steps to normal form) is essential in the current proof technique. It is thus unclear how to extend \net similarity as to validate $\equivlid$. That this should  somehow be possible is the topic of the next section.


\ignore{
\paragraph{Fixed point combinators are \nafex bisimilar.} As Lassen did with \enf bisimilarity, we can prove the equivalence of call-by-value versions of Curry's and Turing's fixed point combinators:

\[ \curryfix = \la\var{\curryfixaux\curryfixaux}\text{, where } \curryfixaux = \la\varthree{\var\la\vartwo{\varthree\varthree\vartwo}}\]
\[ \turingfix = (\la\varthree{\la\var{\var\la\vartwo{\varthree\varthree\var\vartwo}}})(\la\varthree{\la\var{\var\la\vartwo{\varthree\varthree\var\vartwo}}}) \]

To prove that they are \nafe bisimilar we build a bisimulation containing $\{(\curryfix,\turingfix)\}$.

\[ \relsym \defeq \{(\curryfix,\turingfix), (\la\var\curryfixaux\curryfixaux,\la\var{\var\la\vartwo{\turingfix\var\vartwo}}),(\curryfixaux\curryfixaux,{\var\la\vartwo{\turingfix\var\vartwo}}), \]\[ 
(\var\la\vartwo{\curryfixaux\curryfixaux\vartwo},{\var\la\vartwo{\turingfix\var\vartwo}}),(\var,\var),(\la\vartwo{\curryfixaux\curryfixaux\vartwo},\la\vartwo{\turingfix\var\vartwo}),\]
\[({\curryfixaux\curryfixaux\vartwo},{\turingfix\var\vartwo}),((\var\la\vartwo{\curryfixaux\curryfixaux\vartwo})\vartwo,({\var\la\vartwo{\turingfix\var\vartwo}})\vartwo),(\vartwo,\vartwo)\} \]

$\relsym \subseteq \opnafep{\relsym}$ by construction (we start with $(\curryfix,\turingfix)$ and we add to $\relsym$ what is needed for each element to satisfy one \nafe case), and sym(R) is a \nafe simulation as well, hence $\curryfix \nafebisim \turingfix$.

This relation is similar to the one defined by Lassen since those terms have "pure lambda-calculus" normal forms (nothing more can be done at the end with VSC and explicit substitutions).
}