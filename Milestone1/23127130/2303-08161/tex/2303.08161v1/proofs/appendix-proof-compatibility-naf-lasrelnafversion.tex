% !TEX root = main.tex

%%By induction on $(k,d)$ where $d=$ the size of the derivation of $\tmrone \lasrel \tmrtwo$.

By case analysis on the last rule of the derivation $\tmrone\lasrel \tmrtwo$.

The first 3 cases are identical to the last proof.
\begin{enumerate}
	\item \emph{Lifting}:
	\[ \infer[(\sclift) ]{\tmrone \lasrel \tmrtwo} {\tmrone \rel \tmrtwo}\text{ and }\tmrone\bsvscp k \ntm\]
	Since $\relsym$ is a \naf simulation, we have $\tmrone\relnaf\tmrtwo$ and $\tmrtwo \bsvscps \ntmtwo$ for some $\ntmtwo$ such that $\ntm\relnaf\ntmtwo$. Hence  $\ntm\lasrelnaf\ntmtwo$ by \reflemma{relnaf-to-lasrelnaf-on-normal} .
	
	%%%%%%%%%%%%
	\item \emph{Variables}:
	\[\infer[(\scvar) ]{\var \lasrel \var}	{} \text{ and } \var\bsvscp 0 \var\]
	
	hence the result ($\var\bsvscp 0 \var$) and $\var\lasrelnaf\var$ by definition of $\lasrelnafsym$.
	
	%%%%%%%%%%%%
	\item \emph{Abstraction}:
	\[\infer[(\scabs) ]{\la\var\tmrone \lasrel \la\var\tmrtwo} {\tmrone \lasrel \tmrtwo} \text{ and } \la\var\tmrone \bsvscp 0 \la\var\tmrone \]
	
	hence the result ($\la\var\tmrtwo \bsvscp 0 \la\var\tmrtwo$) and $\la\var\tmrone \lasrelnaf \la\var\tmrtwo$ by definition of $\lasrelnafsym$.
	%%%%%%%%%%%%
	\item \emph{Application}:
	\[ \infer[(sc.app) ] 
	{\tmrone\tmrthree  \lasrel  \tmrtwo\tmrfour} {\tmrone  \lasrel \tmrtwo & \tmrthree \lasrel \tmrfour } \text{ and }\tmrone\tmrthree \bsvscp k \ntm \]
	
	then, by case analysis on the last rule of the big-step derivation,
	\begin{enumerate}
		\item \emph{Applied inert}: 
		\[\infer{\tmrone\tmrthree \bsvscp {k+h} \itm\ntm}{
			\tmrone \bsvscp k \itm
			&
			\tmrthree \bsvscp h \ntm
		}\]
		
		by inductive hypothesis ($d$ strictly decreasing, first component not increasing) we obtain $\tmrtwo \bsvscps \itmtwo$ and $\tmrfour \bsvscps \ntmtwo$ with $\itm\lasrelnaf\itmtwo,~\ntm \lasrelnaf \ntmtwo$. In particular, by \reflemma{lasrelnaf-normal-forms-lasrel-left-to-right}, $\itm\lasrel\itmtwo,~\ntm \lasrel \ntmtwo$. Then:
		\[\infer{\tmrtwo\tmrfour \bsvscps \itmtwo\ntmtwo}{
			\tmrtwo \bsvscps  \itmtwo
			&
			\tmrfour \bsvscps \ntmtwo
		}\]
		and $\itm\ntm \lasrelnaf \itmtwo\ntmtwo$ by definition of $\lasrelnaf$ and $\itm\lasrel\itmtwo,~\ntm \lasrel \ntmtwo$.
		
%		\item \emph{Substitution of an inert}:
%		not applicable.
		
		
		\item \emph{$m$ step}:
		\[\infer{\tmrone\tmrthree \bsvscp {k+i+1} \isctxp\ntm}{
			\tmrone \bsvscp k \isctxp{\la\var\tmronep}
			&
			{\tmronep\esub\var\tmrthree} \bsvscp i \ntm
		}\]
		
		
		
		then by inductive hypothesis ($d$ strictly decreasing, first component non increasing) on $\tmrone$ we get
		$\tmrtwo\bsvscps \ntm_\tmrtwo$ with $\isctxp{\la\var\tmronep} \lasrelnaf \ntm_\tmrtwo$ ($\ntm_\tmrtwo = \isctxtwop{\la\var\tmrtwop}$ by  \reflemma{abstraction-inerts-stable-lasrelnaf}) \ie $\isctxp{\la\var\tmronep} \lasrelnaf \isctxtwop{\la\var\tmrtwop}$.
		
		
		By \reflemma{lasrelnaf-values-isctx-decomposition} we get $\isctxp{\var} \lasrelnaf \isctxtwop{\var}$ and $\la\var\tmronep\lasrelnaf \la\var\tmrtwop$ then $\tmronep\lasrel\tmrtwop$ by case (\naf 3)).
		
		Then:
		\[\infer{\tmronep\esub\var\tmrthree \lasrel \tmrtwop\esub\var\tmrfour}{\tmronep\lasrel\tmrtwop&\tmrthree\lasrel\tmrfour}\]
		
		since $\tmronep\esub\var\tmrthree \bsvscp i \ntm$ with $i < k+i+1$ we can apply the inductive hypothesis on the first component for $\tmronep\esub\var\tmrthree$ obtaining $\tmrtwop\esub\var\tmrfour \bsvscps  \ntmtwo$ for some $\ntmtwo$ such that $\ntm\lasrelnaf\ntmtwo$. Since $\isctxp{\var} \lasrelnaf \isctxtwop{\var}$ and $\ntm\lasrelnaf\ntmtwo$, by \reflemma{lasrelnaf-normal-forms-isctx-decomposition}, we get $\isctxp{\ntm} \lasrelnaf \isctxtwop{\ntmtwo}$.
		Last, note that $\tmrtwo\tmrfour\bsvscps\isctxtwop\ntmtwo$ by 
		\[\infer{\tmrtwo\tmrfour \bsvscps \isctxtwop\ntmtwo}{
			\tmrtwo \bsvscps \isctxtwop{\la\var\tmrtwop}
			&
			\tmrtwop\esub\var\tmrfour \bsvscps \ntmtwo
		}\]
		
%		
%		\item \emph{$e$ step}:
%		not applicable.
	\end{enumerate}
	
	\item \emph{Explicit Substitution}: 
	\[ \infer[(sc.esubst) ]{\tmrone\esub\var{\tmrthree} \lasrel \tmrtwo\esub\var{\tmrfour}} {\tmrone \lasrel \tmrtwo & \tmrthree \lasrel \tmrfour }\text{ and }\tmrone\esub\var{\tmrthree} \bsvscp k \ntm \]
	
	\begin{enumerate}
%		\item \emph{Applied inert}: not applicable.
		\item \emph{Substitution of an inert}:
		\[ \infer{\tmrone\esub\var\tmrthree \bsvscp {k+h} \ntm\esub\var\itm}{
			\tmrone \bsvscp k \ntm
			&
			\tmrthree \bsvscp h \itm
		} \]
		
		by inductive hypothesis ($d$ strictly decreasing, first component not increasing) we obtain $\tmrtwo \bsvscps \ntmtwo$ and $\tmrfour \bsvscps \itmtwo$ with $\itm\lasrelnaf\itmtwo,~\ntm \lasrelnaf \ntmtwo$. In particular, by \reflemma{lasrelnaf-normal-forms-lasrel-left-to-right}, $\itm\lasrel\itmtwo,~\ntm \lasrel \ntmtwo$. Then:
		\[\infer{\tmrtwo\esub\var\tmrfour \bsvscps \ntmtwo\esub\var\itmtwo}{
			\tmrtwo \bsvscps  \ntmtwo
			&
			\tmrfour \bsvscps \itmtwo
		}\]
		and $\ntm\esub\var\itm \lasrelnaf \ntmtwo\esub\var\itmtwo$ by definition of $\lasrelnafsym$.
		
%		\item \emph{m step}: not applicable.
		\item \emph{e step}: 		\[ \infer{\tmrone\esub\var{\tmrthree} \bsvscp {k+i+1} \isctxp\ntm}{
			\tmrthree \bsvscp k \isctxp{\la\vartwo\tmrthreep}
			&
			{\tmrone\isub\var{\la\vartwo\tmrthreep}} \bsvscp i \ntm
		} \]
		
		then by inductive hypothesis ($d$ strictly decreasing, first component non increasing) on $\tmrone$ and $\tmrthree$ we get
		$\tmrfour\bsvscps \ntm_\tmrfour$ with $\isctxp{\la\vartwo\tmrthreep} \lasrelnaf \ntm_\tmrfour$($\ntm_\tmrfour = \isctxtwop{\la\vartwo\tmrfourp}$ by  \reflemma{abstraction-inerts-stable-lasrelnaf}) \ie $\isctxp{\la\vartwo\tmrthreep} \lasrelnaf \isctxtwop{\la\vartwo\tmrfourp}$.
		
		By \reflemma{lasrelnaf-values-isctx-decomposition} we get $\isctxp{\var} \lasrelnaf \isctxtwop{\var}$ and $\la\vartwo\tmrthreep\lasrelnaf\la\vartwo\tmrfourp$ and in particular\\ $\la\vartwo\tmrthreep\lasrel\la\vartwo\tmrfourp$ by \ref{l:lasrelnaf-normal-forms-lasrel-left-to-right}.
		
		Then:
		\[\infer{\tmrone\isub\var{\la\vartwo\tmrthreep} \lasrel \tmrtwo\isub\var{\la\vartwo\tmrfourp}}{\tmrone\lasrel\tmrtwo&\la\vartwo\tmrthreep\lasrel\la\vartwo\tmrfourp}\]
		
		since $\tmrone\isub\var{\la\vartwo\tmrthreep} \bsvscp i \ntm$ with $i < k+i+1$ we can apply the inductive hypothesis on the first component for $\tmrone\isub\var{\la\vartwo\tmrthreep}$ obtaining $\tmrtwo\isub\var{\la\vartwo\tmrfourp} \bsvscps  \ntmtwo$ for some $\ntmtwo$ such that $\ntm\lasrelnaf\ntmtwo$. 
		Since $\isctxp{\var} \lasrelnaf \isctxtwop{\var}$ and $\ntm\lasrelnaf\ntmtwo$, by \reflemma{lasrelnaf-normal-forms-isctx-decomposition}, we get $\isctxp{\ntm} \lasrelnaf \isctxtwop{\ntmtwo}$.
		
		Last, note that $\tmrtwo\tmrfour\bsvscps\isctxtwop\ntmtwo$ by 
		\[\infer{\tmrtwo\tmrfour \bsvscps \isctxtwop\ntmtwo}{
			\tmrfour \bsvscps \isctxtwop{\la\vartwo\tmrfourp}
			&
			\tmrtwo\isub\var{\la\vartwo\tmrfourp} \bsvscps \ntmtwo
		}\]
		
	\end{enumerate}
	
	
	%%%%%%%%%%%%%
	\item \emph{Meta-level Substitution}: 
	\[ \infer[(sc.subst) ]{\tmrone\isub\var{\valp} \lasrel \tmrtwo\isub\var{\valptwo}} {\tmrone \lasrel \tmrtwo & \valp \lasrel \valptwo }\text{ and }\tmrone\isub\var{\valp} \bsvscp k \ntm \]
	then by applying Big-step substitutivity (\reflemma{splitting_vsc}), we obtain $\tmrone \bsvscp {k_1} \ntm_\tmrone$ and $\ntm_\tmrone\isub\var{\valp} \bsvscp {k_2} \ntm$ with $k=k_1+k_2$. Hence by inductive hypothesis ($d$ strictly decreasing, first component non increasing) $\tmrtwo\bsvscps\ntm_\tmrtwo$ and $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$. In particular, by \reflemma{lasrelnaf-normal-forms-lasrel-left-to-right}, $\ntm_\tmrone \lasrel \ntm_\tmrtwo$.
	We then have: 
	\[\infer{\ntm_\tmrone\isub\var{\valp} \lasrel \ntm_\tmrtwo\isub\var{\valptwo}} {\ntm_\tmrone \lasrel \ntm_\tmrtwo & \valp \lasrel \valptwo }\]
	
	%	Note that by \ih applied to $\valp \lasrel \valptwo $ and $\valp\bsvscps \valp$ (first component not increasing, second strictly decrasing) we obtain $\valp \lasrelnaf \valptwo$.
	
	Two cases.
	\begin{enumerate}
		
		
		\item \emph{$\tmrone$ is not normal}, that is, $k_1>0$ and $k_2<k$. Then by applying the induction hypothesis to $k_2$ (first component)  and $\ntm_\tmrone\isub\var{\valp}$ we obtain $\ntm_\tmrtwo\isub\var{\valptwo} \bsvscps \ntmtwo$ with $\ntm\lasrelnaf\ntmtwo$. We conclude using substitutivity of $\tovscp$ (\ref{l:stability_vsc}) that $\tmrtwo\isub\var{\valptwo} \tovscp^* \ntm_\tmrtwo\isub\var{\valptwo} \tovscp^* \ntmtwo$, hence via the equivalence between big and small steps (\ref{l:ss-bs-equivalence_vsc}), $\tmrtwo\isub\var{\valptwo} \bsvscps \ntmtwo$.
		
		
		\item \emph{$\tmrone$ is normal}, that is, $k_1=0$ and $k_2=k$. Then $\tmrone=\ntm_\tmrone$. Two sub-cases:
		\begin{itemize}
			\item \emph{$\tmrone\isub\var{\valp} = \ntm_\tmrone\isub\var{\valp}$ is also normal}
			
			
			Since we know that $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$ and $\valp \lasrel \valptwo $, we can apply \reflemma{lasrelnaf-on-normal-subs_vsc}, and obtain that $\ntm_\tmrtwo\isub\var{\valptwo}$ is $\tovscp$-normal and by \reflemma{lasrelnaf-normal-forms-substitutive}, $\tmrone\isub\var{\valp} \lasrelnaf \ntm_\tmrtwo\isub\var{\valptwo}$. It is only left to show that $\tmrtwo\isub\var{\valptwo} \bsvscps \ntm_\tmrtwo\isub\var{\valptwo}$, which follows from $\tmrtwo\bsvscps \ntm_\tmrtwo$, substitutivity of $\tovscp$ (\reflemma{stability_vsc}) and the fact that $\ntm_\tmrtwo\isub\var{\valptwo}$ is $\tovscp$-normal (and via \reflemma{ss-bs-equivalence_vsc}).
			
			\item   \emph{$\tmrone\isub\var{\valp} = \ntm_\tmrone\isub\var{\valp}$ is not normal}
			
			hence $\ntm_\tmrone\isub\var{\valp} \tovscp \tmronep \tovscp ^ {k-1} \ntm$ (the reduction is diamond, all reductions are of the same length, we pick any first step possible). Then by \reflemma{lasrelnaf-not-normal-subs} with $\ntm_\tmrone \lasrelnaf \ntm_\tmrtwo$, $\ntm_\tmrtwo\isub\var{\valptwo} \tovscp \tmrtwop$ with $\tmronep \lasrel \tmrtwop$.
			
			We can apply the inductive hypothesis to $\tmronep$ (first component is decreasing, as $k-1<k$) and we obtain $\tmrtwop \bsvscps \ntmtwo$ with $\ntm\lasrelnaf\ntmtwo$.
			The statement is then proved, since (using \reflemma{stability_vsc})
			$$\tmrtwo\isub\var{\valptwo} \tovscp^* \ntm_\tmrtwo\isub\var{\valptwo} \tovscp \tmrtwop \tovscp^* \ntmtwo$$ that is, $\tmrtwo\isub\var{\valptwo} \bsvscps \ntmtwo$ by \reflemma{ss-bs-equivalence_vsc}.\qedhere
			
		\end{itemize}
	\end{enumerate}
	
\end{enumerate}
