% !TEX root = main.tex

%%By induction on $(k,d)$ where $d=$ the size of the derivation of $\tmrone \mlasrel \tmrtwo$.

By case analysis on the last rule of the derivation $\tmrone\mlasrel \tmrtwo$.

\begin{enumerate}
	\item \emph{Lifting}:
	\[ \infer[(\sclift) ]{\tmrone \mlasrel \tmrtwo} {\tmrone \rel \tmrtwo}\text{ and }\tmrone\bslas k \ntm\]
	Since $\relsym$ is a \nafex simulation, we have $\tmrone\relnafex\tmrtwo$ and $\tmrtwo \bslass \ntmtwo$ for some $\ntmtwo$ such that $\ntm\relnafex\ntmtwo$. Hence  $\ntm\mlasrelnafex\ntmtwo$ by monotonicity of $\opnafex$.
	
	%%%%%%%%%%%%
	\item \emph{Variables}:
	\[\infer[(\scvar) ]{\var \mlasrel \var}	{} \text{ and } \var\bslas 0 \var\]
	
	hence the result ($\var\bslas 0 \var$) and by the definition of nafex, $\var \mlasrelnafex \var$.
	
	%%%%%%%%%%%%
	\item \emph{Abstraction}:
	\[\infer[(\scabs) ]{\la\var\tmrone \mlasrel \la\var\tmrtwo} {\tmrone \mlasrel \tmrtwo} \text{ and } \la\var\tmrone \bslas 0 \la\var\tmrone \]
	
	hence the result ($\la\var\tmrtwo \bslas 0 \la\var\tmrtwo$) and by the definition of nafex, $\la\var\tmrone \mlasrelnafex \la\var\tmrtwo$.
	%%%%%%%%%%%%
	\item \emph{Application}:
	\[ \infer[(sc.app) ] 
	{\tmrone\tmrthree  \mlasrel  \tmrtwo\tmrfour} {\tmrone  \mlasrel \tmrtwo & \tmrthree \mlasrel \tmrfour } \text{ and }\tmrone\tmrthree \bslas k \ntm \]
	
	then, by case analysis on the last rule of the big-step derivation,
	\begin{enumerate}
		\item \emph{Applied variable}: 
		\[\infer{\tmrone\tmrthree \bslas {k+h} \isctxp{\var\ntm}}{
			\tmrone \bslas k \isctxp\var
			&
			\tmrthree \bslas h \ntm
		}\]
		
		by inductive hypothesis ($d$ strictly decreasing, first component not increasing) we obtain $\tmrtwo \bslass \firep$ with $\isctxp{\var} \mlasrelnafex \firep$ (hence by \reflemma{values-fireballs-stable-lasrelnafex}, $\firep = \isctxtwop{\var}$)and $\tmrfour \bslass \ntmtwo$ with $\ntm \mlasrelnafex \ntmtwo$. Then:
		\[\infer{\tmrtwo\tmrfour \bslass \isctxtwop{\var\ntmtwo}}{
			\tmrtwo \bslass  \itmtwo = \isctxtwop{\var}
			&
			\tmrfour \bslass \ntmtwo
		}\]
		%Hence, by \reflemma{lasrelnafex-normal-forms-lasrel-left-to-right},  $\isctxp{\var} \mlasrel \isctxtwop\var$ and $\ntm \mlasrel \ntmtwo$. 
		By definition of nafex, and 
		%since $\isctxp{\var\ntm} \equivx \isctxp\var\ntm$ and $\isctxtwop{\var\ntmtwo} \equivx \isctxtwop\var\ntmtwo$, 
		by \reflemma{lasrelnafex-normal-forms-isctx-decomposition-2}
		we have $\isctxp{\var\ntm} \mlasrelnafex \isctxtwop{\var\ntmtwo}$.
		\item \emph{Applied inert}: 
		\[\infer{\tmrone\tmrthree \bslas {k+h} \isctxp{\itmappONE\ntm}}{
			\tmrone \bslas k \isctxp\itmappONE = \itm
			&
			\tmrthree \bslas h \ntm
		}\]
		
		by inductive hypothesis ($d$ strictly decreasing, first component not increasing) we obtain $\tmrtwo \bslass \itmtwo = \isctxtwop{\itmappONEtwo}$ (the $\tovsce$ normal form, and it is an inert by Corollary \ref{l:inerts-fireballs-stable-lasrelnafex}) and $\tmrfour \bslass \ntmtwo$ with $\itm\mlasrelnafex\itmtwo,~\ntm \mlasrelnafex \ntmtwo$. Then:
		\[\infer{\tmrtwo\tmrfour \bslass \isctxtwop{\itmappONEtwo\ntmtwo}}{
			\tmrtwo \bslass  \itmtwo = \isctxtwop{\itmappONEtwo}
			&
			\tmrfour \bslass \ntmtwo
		}\]
		%and by \reflemma{lasrel-inerts-separating-applicative-inerts-from-substitutions} applied on $\isctxp\itmappONE=\itm\mlasrel\itmtwo=\isctxtwop{\itmappONEtwo}$, $\itmappONE \mlasrel \itmappONEtwo$ and $\isctxp{\var} \mlasrel \isctxtwop{\var}$. Hence by ($\scapp$), $\itmappONE\ntm \mlasrel \itmappONEtwo\ntmtwo$. Finally, by \reflemma{lasrel-inerts-separating-applicative-inerts-from-substitutions}, 
		
		By \reflemma{lasrelnafex-normal-forms-isctx-decomposition-applied-inerts}, $\isctxp{\itmappONE\ntm} \mlasrelnafex \isctxtwop{\itmappONEtwo\ntmtwo}$.
		
		\item \emph{Substitution of an inert}:
		not applicable.
		
		
		\item \emph{$m$ step}:
		\[\infer{\tmrone\tmrthree \bslas {k+i+1} \isctxp\ntm}{
			\tmrone \bslas k \isctxp{\la\var\tmronep}
			&
			{\tmronep\esub\var\tmrthree} \bslas i \ntm
		}\]
		
		
		
		then by inductive hypothesis ($d$ strictly decreasing, first component non increasing) on $\tmrone$ we get
		$\tmrtwo\bslass \ntm_\tmrtwo$ with $\isctxp{\la\var\tmronep} \mlasrelnafex \ntm_\tmrtwo$ (hence by  \reflemma{values-fireballs-stable-lasrelnafex} $\ntm_\tmrtwo = \isctxtwop{\la\var\tmrtwop}$) \ie $\isctxp{\la\var\tmronep} \mlasrel \isctxtwop{\la\var\tmrtwop}$.
		
		Hence by \reflemma{lasrelnafex-normal-forms-lasrel-right-to-left}, $\isctxp{\la\var\tmronep} \mlasrelnafex \isctxtwop{\la\var\tmrtwop}$ and by \reflemma{lasrelnafex-values-isctx-decomposition} we get\\ $\isctxp{\var} \mlasrelnafex \isctxtwop{\var}$ and $\la\var\tmronep\mlasrelnafex \la\var\tmrtwop$ then $\tmronep\mlasrel\tmrtwop$ by case (nafex 3).
		
		Then:
		\[\infer{\tmronep\esub\var\tmrthree \mlasrel \tmrtwop\esub\var\tmrfour}{\tmronep\mlasrel\tmrtwop&\tmrthree\mlasrel\tmrfour}\]
		
		since $\tmronep\esub\var\tmrthree \bslas i \ntm$ with $i < k+i+1$ we can apply the inductive hypothesis on the first component for $\tmronep\esub\var\tmrthree$ obtaining $\tmrtwop\esub\var\tmrfour \bslass  \ntmtwo$ for some $\ntmtwo$ such that $\ntm\mlasrelnafex\ntmtwo$. Since $\isctxp{\var} \mlasrelnafex \isctxtwop{\var}$ and $\ntm\mlasrelnafex\ntmtwo$, by \reflemma{lasrelnafex-normal-forms-isctx-decomposition}, we get $\isctxp{\ntm} \mlasrelnafex \isctxtwop{\ntmtwo}$.
		Last, note that $\tmrtwo\tmrfour\bslass\isctxtwop\ntmtwo$ by 
		\[\infer{\tmrtwo\tmrfour \bslass \isctxtwop\ntmtwo}{
			\tmrtwo \bslass \isctxtwop{\la\var\tmrtwop}
			&
			\tmrtwop\esub\var\tmrfour \bslass \ntmtwo
		}\]
		
		
		\item \emph{$e$ step}:
		not applicable.
	\end{enumerate}
	
	\item \emph{Explicit Substitution}: 
	\[ \infer[(sc.esubst) ]{\tmrone\esub\var{\tmrthree} \mlasrel \tmrtwo\esub\var{\tmrfour}} {\tmrone \mlasrel \tmrtwo & \tmrthree \mlasrel \tmrfour }\text{ and }\tmrone\esub\var{\tmrthree} \bslas k \ntm \]
	
	\begin{enumerate}
		\item \emph{Applied inert}: not applicable.
		\item \emph{Substitution of an inert}:
		\[ \infer{\tmrone\esub\var\tmrthree \bslas {k+h} \ntm\esub\var\itm}{
			\tmrone \bslas k \ntm
			&
			\tmrthree \bslas h \itm
		} \]
		
		by inductive hypothesis ($d$ strictly decreasing, first component not increasing) we obtain $\tmrtwo \bslass \ntmtwo$ and $\tmrfour \bslass \itmtwo$ with $\itm\mlasrelnafex\itmtwo$ and $\ntm \mlasrelnafex \ntmtwo$. By \reflemma{lasrelnafex-normal-forms-lasrel-left-to-right},  $\itm\mlasrel\itmtwo$ and $\ntm \mlasrel \ntmtwo$. Then:
		\[\infer{\tmrtwo\esub\var\tmrfour \bslass \ntmtwo\esub\var\itmtwo}{
			\tmrtwo \bslass  \ntmtwo
			&
			\tmrfour \bslass \itmtwo
		}\]
		and $\ntm\esub\var\itm \mlasrelnafex \ntmtwo\esub\var\itmtwo$ by definition of nafex.
		
		\item \emph{m step}: not applicable.
		\item \emph{e step}: 		\[ \infer{\tmrone\esub\var{\tmrthree} \bslas {k+i+1} \isctxp\ntm}{
			\tmrthree \bslas k \isctxp{\valof{\tmrthree}}
			&
			\tmrone\isub\var{\valof{\tmrthree}}\bslas i \ntm
		} \]
		
		then by inductive hypothesis ($d$ strictly decreasing, first component non increasing) on $\tmrone$ and $\tmrthree$ we get
		$\tmrfour\bslass\tmrfourp$ with $\isctxp{\valof\tmrthree} \mlasrelnafex \tmrfourp$ (hence by \reflemma{values-fireballs-stable-lasrelnafex} $\tmrfourp = \isctxtwop{\valof\tmrfour}$) \ie $\isctxp{\valof\tmrthree} \mlasrelnafex \isctxtwop{\valof\tmrfour}$.
		Hence by \reflemma{lasrelnafex-values-isctx-decomposition} we get $\isctxp{\var} \mlasrelnafex \isctxtwop{\var}$ and ${\valof\tmrthree}\mlasrelnafex{\valof\tmrfour}$ \ie ${\valof\tmrthree}\mlasrel{\valof\tmrfour}$ by \ref{l:lasrelnafex-normal-forms-lasrel-left-to-right}.
		
		Then:
		\[\infer{\tmrone\isub\var{\valof\tmrthree} \mlasrel \tmrtwo\isub\var{\valof\tmrfour}}{\tmrone\mlasrel\tmrtwo& {\valof\tmrthree}\mlasrel{\valof\tmrfour}}\]
		
		since $\tmrone\isub\var{\valof\tmrthree} \bslas i \ntm$ with $i < k+i+1$ we can apply the inductive hypothesis on the first component for $\tmrone\isub\var{\valof\tmrthree}$ obtaining $\tmrtwo\isub\var{\valof\tmrfour} \bslass  \ntmtwo$ for some $\ntmtwo$ such that $\ntm\mlasrelnafex\ntmtwo$. 
		Since $\isctxp{\var} \mlasrelnafex \isctxtwop{\var}$ and $\ntm\mlasrelnafex\ntmtwo$, by \reflemma{lasrelnafex-normal-forms-isctx-decomposition}, we get $\isctxp{\ntm} \mlasrelnafex \isctxtwop{\ntmtwo}$.
		
		Last, note that $\tmrtwo\tmrfour\bslass\isctxtwop\ntmtwo$ by 
		\[\infer{\tmrtwo\tmrfour \bslass \isctxtwop\ntmtwo}{
			\tmrfour \bslass \isctxtwop{\valof\tmrfour}
			&
			\tmrtwo\isub\var{\valof\tmrfour} \bslass \ntmtwo
		}\]
		
	\end{enumerate}
	
	
	%%%%%%%%%%%%%
	\item \emph{Implicit Substitution}: 
	\[ \infer[(sc.subst) ]{\tmrone\isub\var{\valof\tmrthree} \mlasrel \tmrtwo\isub\var{\valof\tmrfour}} {\tmrone \mlasrel \tmrtwo & \valof\tmrthree \mlasrel \valof\tmrfour }\text{ and }\tmrone\isub\var{\valof\tmrthree} \bslas k \ntm \]
	then by applying the splitting lemma (\reflemma{splitting_vsce}), we obtain $\tmrone \bslas {k_1} \ntm_\tmrone$ and $\ntm_\tmrone\isub\var{\valof\tmrthree} \bslas {k_2} \ntm$ with $k=k_1+k_2$. Hence by inductive hypothesis ($d$ strictly decreasing, first component non increasing) $\tmrtwo\bslass\ntm_\tmrtwo$ and $\ntm_\tmrone \mlasrelnafex \ntm_\tmrtwo$, and by \ih $\valof\tmrthree \mlasrelnafex \valof\tmrfour $. By applying \reflemma{lasrelnafex-normal-forms-lasrel-left-to-right}, we have $\ntm_\tmrone \mlasrel \ntm_\tmrtwo$.
	We then have: 
	\[\infer{\ntm_\tmrone\isub\var{\valof\tmrthree} \mlasrel \ntm_\tmrtwo\isub\var{\valof\tmrfour}} {\ntm_\tmrone \mlasrel \ntm_\tmrtwo & \valof\tmrthree \mlasrel \valof\tmrfour }\]
	
	%	Note that by \ih applied to $\valof\tmrthree \mlasrel \valof\tmrfour $ and $\valof\tmrthree\bslass \valof\tmrthree$ (first component not increasing, second strictly decrasing) we obtain $\valof\tmrthree \mlasrelnafex \valof\tmrfour$.
	
	Two cases.
	\begin{enumerate}
		
		
		\item \emph{$\tmrone$ is not normal}, that is, $k_1>0$ and $k_2<k$. Then by applying the induction hypothesis to $k_2$ (first component)  and $\ntm_\tmrone\isub\var{\valof\tmrthree}$ we obtain $\ntm_\tmrtwo\isub\var{\valof\tmrfour} \bslass \ntmtwo$ with $\ntm\mlasrelnafex\ntmtwo$. We conclude using stability \ref{l:stability_vsce} and the equivalence between big and small steps, because $\tmrtwo\isub\var{\valof\tmrfour} \to^* \ntm_\tmrtwo\isub\var{\valof\tmrfour} \to^* \ntmtwo$.
		
		
		\item \emph{$\tmrone$ is normal}, that is, $k_1=0$ and $k_2=k$. Then $\tmrone=\ntm_\tmrone$. Two sub-cases:
		\begin{itemize}
			\item \emph{$\tmrone\isub\var{\valof\tmrthree} = \ntm_\tmrone\isub\var{\valof\tmrthree}$ is also normal}
			
			
			Since we know that $\ntm_\tmrone \mlasrelnafex \ntm_\tmrtwo$  and $\valof\tmrthree \mlasrelnafex \valof\tmrfour $, we can apply \reflemma{lasrelnafex-on-normal-subs_vsce}, and obtain that $\ntm_\tmrtwo\isub\var{\valof\tmrfour}$ is $\tovsce$-normal and by \reflemma{lasrelnafex-normal-forms-substitutive}, $\tmrone\isub\var{\valof\tmrthree} \mlasrelnafex \ntm_\tmrtwo\isub\var{\valof\tmrfour}$. It is only left to show that $\tmrtwo\isub\var{\valof\tmrfour} \bslass \ntm_\tmrtwo\isub\var{\valof\tmrfour}$, which follows from $\tmrtwo\bslass \ntm_\tmrtwo$, stability of reduction under substitution (\reflemma{stability_vsce}) and the fact that $\ntm_\tmrtwo\isub\var{\valof\tmrfour}$ is $\tovsce$-normal (plus the equivalence of small and big steps).
			
			\item   \emph{$\tmrone\isub\var{\valof\tmrthree} = \ntm_\tmrone\isub\var{\valof\tmrthree}$ is not normal}
			
			hence $\ntm_\tmrone\isub\var{\valof\tmrthree} \to \tmronep \to ^ {k-1} \ntm$ (the reduction is diamond, all reductions are of the same length, we pick any first step possible). Then by \reflemma{lasrelnafex-not-normal-subs} , $\ntm_\tmrtwo\isub\var{\valof\tmrfour} \to \tmrtwop$ with $\tmronep \mlasrel \tmrtwop$.
			
			We can apply the inductive hypothesis to $\tmronep$ (first component is decreasing, as $k-1<k$) and we obtain $\tmrtwop \bslass \ntmtwo$ with $\ntm\mlasrelnafex\ntmtwo$.
			The statement is then proved, since (using \reflemma{stability_vsce})
			$$\tmrtwo\isub\var{\valof\tmrfour} \to^* \ntm_\tmrtwo\isub\var{\valof\tmrfour} \to \tmrtwop \to^* \ntmtwo$$ that is, $\tmrtwo\isub\var{\valof\tmrfour} \bslass \ntmtwo$ by \reflemma{ss-bs-equivalence_vsce}.
			
		\end{itemize}
	\end{enumerate}

	\item \emph{Equivalent $X$} \[	\infer[\scequivx]{\tmrone \mlasrel \tmrtwop} {\tmrone \mlasrel \tmrtwo & \tmrtwo \equivx \tmrtwop} \text{ and }\tmrone \bslas k \ntm \]
	
	by \ih, $\tmrtwo \bslass \ntmtwo$ and $\ntm \mlasrelnafex \ntmtwo$.
	
	Since $\tmrtwo$ has a normal form and $\tmrtwo \equivx \tmrtwop$ then $\tmrtwop \bslass \ntmthree$ and $\ntmtwo \equivx \ntmthree$ by \refprop{equivx-is-a-strong-bisimulation}, hence $\ntm \mlasrelnafex \ntmthree$ by \refprop{relnafex-equivx-subseteq-relnafex}.
	
\end{enumerate}
