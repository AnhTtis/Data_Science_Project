% !TEX root = main.tex

\section{Proofs from \refsect{naive} (Naive CbV Bisimilarity)}
\label{chapter:proof-compatibility-naive}
In this section, we develop the proof of compatibility for the (weak) naive similarity, following Lassen's variant of Howe method for nf-bisimulations.

\subsection{Proof of Equivalence of Small-Step and Big-Step Operational Semantics} We prove the big-step evaluation predicate sound and complete with respect to the small-step operational semantics (Proposition \ref{l:ss-bs-equivalence_weak}).

\begin{lemma}
	\label{l:aux-ss-bs-equivalence}
	If $\tm\tow\tmp$ and $\tmp\bsw k \ntm$, then $\tm\bsw {k+1} \ntm$.
\end{lemma}

\begin{proof}
	Straightforward proof by structural induction.
\end{proof}


\gettoappendix{l:ss-bs-equivalence_weak}

\begin{proof}
	Trivial using \reflemma{aux-ss-bs-equivalence}.
\end{proof}

\subsection{Lemmas about normal forms and $\lasrel$ and $\lasrelncbv$}
Actually, before proving \refprop{main-lemma_naive} for all terms, we somehow need to prove it only on normal forms. More precisely, we show that $\lasrelsym$ and $\lasrelncbvsym$ coincide on normal forms (\reflemma{lasrelncbv-normal-forms-lasrel-left-to-right} and \reflemma{lasrelncbv-normal-forms-lasrel-right-to-left}).

\begin{lemma}
	\label{l:lasrelncbv-normal-forms-lasrel-left-to-right}
	If $\ntm\lasrelncbv\ntmtwo$ then $\ntm\lasrel\ntmtwo$.
\end{lemma}
\begin{proof}
	By case analysis on the shape of $\ntm$.
\end{proof}


Notice that the next lemma already proves part of the conclusion of the first part of Proposition \ref{prop:ncbv-coherence}.


\begin{lemma}[Constrained Substitutivity of $\lasrelncbv$ on normal forms]
	\label{l:lasrelncbv-normal-forms-substitutive}
	If $\ntm \lasrelncbv \ntmtwo$, $\val \lasrelncbv \valtwo$ and $\ntm\isub\var{\val}$ and $\ntmtwo\isub\var{\valtwo}$ are $\tow$-normal then $\ntm\isub\var{\val} \lasrelncbv \ntmtwo\isub\var{\valtwo}$.
\end{lemma}


\begin{proof}
	By case analysis on the shape of $\ntm$. Cases:
	\begin{itemize}
		\item $\ntm = \var$ and $\ntmtwo = \var$ then $\ntm\isub\var{\val} = \val \lasrelncbv \valtwo = \ntmtwo\isub\var{\valtwo}$.
		
		\item $\ntm = \vartwo$ and $\ntmtwo = \vartwo$ then $\ntm\isub\var{\val} =  \vartwo \lasrelncbv \vartwo = \ntmtwo\isub\var{\valtwo}$.
		
		\item $\ntm = \la\vartwo\tm$ and $\ntmtwo = \la\vartwo\tmp$ with $\tm \lasrel \tmp$
		we have \[\infer{\tm\isub\var{\val} \lasrel \tmp\isub\var{\valtwo}}{\tm \lasrel \tmp & \val \lasrel \valtwo}\]
		hence by case (ncbv 3) $\ntm\isub\var{\val} = \la\vartwo{\tm\isub\var{\val}} \lasrelncbv  \la\vartwo{\tmp\isub\var{\valtwo}} = \ntmtwo\isub\var{\valtwo}$.
		
		
		\item $\ntm = \ntmONE\ntmTWO$ and $\ntmtwo = \ntmONEtwo\ntmTWOtwo$ with $\ntmONE\lasrel\ntmONEtwo$ and $\ntmTWO\lasrel\ntmTWOtwo$. Also, by \reflemma{lasrelncbv-normal-forms-lasrel-left-to-right}, $\val\lasrel\valtwo$.
		
			\[ \infer[\scsub]{\ntmONE\isub\var\val \lasrel \ntmONEtwo\isub\var\valtwo}{\ntmONE\lasrel\ntmONEtwo & \val \lasrel \valtwo} ~\text{and}~ \infer[\scsub]{\ntmTWO\isub\var\val \lasrel \ntmTWOtwo\isub\var\valtwo}{\ntmTWO \lasrel \ntmTWOtwo & \val \lasrel \valtwo}\]
		
		
		Hence, as $\ntm\isub\var\val$ and $\ntm\isub\var\valtwo$ are normal forms, this concludes the proof.
		
		
		
		
	\end{itemize}
\end{proof}

\begin{lemma}
	\label{l:lasrelncbv-normal-forms-lasrel-right-to-left}
	If $\relsym$ is a naive simulation.
	If $\ntm\lasrel\ntmtwo$ then $\ntm\lasrelncbv\ntmtwo$.
\end{lemma}

\begin{proof}
	By induction on the derivation $\ntm \lasrel \ntmtwo$. Cases of the last rule in the derivation of $\ntm\lasrel\ntmtwo$:
	\begin{itemize}
		\item \emph {$\scvar$}\[ \infer[\scvar]{\var \lasrel \var}{} \]
		then $\var \lasrelncbv \var$ by definition of naive.
		\item \emph {$\scabs$} \[ \infer[\scabs]{\ntm = \la\var\tm \lasrel \la\var\tmp = \ntmtwo}{\tm \lasrel \tmp} \]
		then $\ntm \lasrelncbv \ntmtwo$ by definition of naive with $\tm \lasrel \tmp$.
		\item \emph {$\sclift$} \[ \infer[\scabs]{\ntm \lasrel \ntmtwo}{\ntm \rel \ntmtwo} \]
		then since $\relsym$ is a naive simulation $\ntm \relncbv \ntmtwo$, hence by monotonicity of $\ncbvfp\cdot$, $\ntm \lasrelncbv \ntmtwo$.
		\item \emph {$\scapp$} \[ \infer[\scapp]{\ntm = \ntmONE\ntmTWO \lasrel \ntmONEtwo\ntmTWOtwo = \ntmtwo}{\ntmONE \lasrel \ntmONEtwo & \ntmTWO \lasrel \ntmTWOtwo} \]then $\ntm \lasrelncbv \ntmtwo$ by definition of naive with $\ntmONE \lasrel \ntmONEtwo$ and  $\ntmTWO \lasrel \ntmTWOtwo$.
		\item \emph {$\scsub$} \[ \infer[\scsub]{\ntm = \ntmONE\isub\var\val \lasrel \ntmTWO\isub\var\valtwo = \ntmtwo}{\ntmONE \lasrel \ntmTWO & \val \lasrel \valtwo} \]
		by \ih we have $\ntmONE \lasrelncbv \ntmTWO$ and $\val \lasrelncbv \valtwo$. By \reflemma{lasrelncbv-normal-forms-substitutive}, $\ntmONE\isub\var{\val} \lasrelncbv \ntmTWO\isub\var{\valtwo}$.\qedhere
	\end{itemize}
\end{proof}

\subsection{Coherence of simulation, reduction and substitution}
The main difficulty in the proof of \refprop{main-lemma_naive} is the case of the ($\scsub$) rule. It is dealt with the following lemma, that states that substitution behaves nicely with the simulation and the reduction of the calculus.

\gettoappendix{prop:ncbv-coherence}

\begin{proof}
	\begin{enumerate}
		\item We only prove that $\ntmtwo\isub\var\valtwo$ is a normal form, the rest of the conclusion follows by \ref{l:lasrelncbv-normal-forms-substitutive}. By induction on $\ntm$.
		\begin{itemize}
			\item $\ntm=\vartwo$, then $\ntmtwo=\vartwo$ (since $\ntm\lasrelncbv\ntmtwo$), which is a normal form.
			\item $\ntm=\var$, then $\ntmtwo=\var$ (since $\ntm\lasrelncbv\ntmtwo$), hence the result.
			\item $\ntm=\la\vartwo\tm$, then $\ntmtwo=\la\vartwo\tmp$ with $\tm\lasrel\tmp$ (since $\ntm\lasrelncbv\ntmtwo$), we conclude since $\la\vartwo\tmp\isub\var\valtwo$ is a normal form.
			\item $\ntm = \ntmONE\ntmTWO$, then $\ntmtwo=\ntmONEtwo\ntmTWOtwo$ with $\ntmONE\lasrel\ntmONEtwo$ and $\ntmTWO\lasrel\ntmTWOtwo$. By \reflemma{lasrelncbv-normal-forms-lasrel-right-to-left}, $\ntmONE\lasrelncbv\ntmONEtwo$ and $\ntmTWO\lasrelncbv\ntmTWOtwo$. Hence we can apply the \ih and get that $\ntmONEtwo\isub\var\valtwo$ and $\ntmTWOtwo\isub\var\valtwo$ are normal forms. In fact, by a quick analysis, $\ntmONEtwo\ntmTWOtwo\isub\var\valtwo$ is a normal form (otherwise $\ntm\isub\var\val$ would not be normal).
		\end{itemize}
		\item By induction on $\ntm$. Note that the only possible shape for $\ntm$ is $\ntmONE\ntmTWO$, otherwise the substitution of a value does not imply a reduction step.
		
		\begin{itemize}
			\item $\ntmONE\isub\var\val$ is normal and $\ntmTWO\isub\var\val$ is normal. Then $\ntmONE\isub\var\val = \la\vartwo\tmrone$ and $\ntmTWO\isub\var\val = \val_1$.
			By Point 1, $\ntmONEtwo = \la\vartwo\tmrtwo$ and $\ntmTWOtwo=\val_2$ such that $\tmrone\lasrel\tmrtwop$ and $\val_1 \lasrel \val_2$ (by \ref{l:lasrelncbv-normal-forms-lasrel-left-to-right}). Hence, $\ntmtwo\isub\var\val \tow \tmrtwo\isub\vartwo{\val_2}$ and we conclude using the following derivation:
			\[\infer{\tmrone\isub\vartwo{\val_1} \lasrel  \tmrtwo\isub\vartwo{\val_2}}{\tmrone\lasrel\tmrtwo & \val_1 \lasrel \val_2}\]
			
			\item $\ntmONE\isub\var\val\tow\tm_1$ or $\ntmTWO\isub\var\val\tow\tm_1$.
			
			By \ih, $\ntmONEtwo\isub\var\valtwo\tow\tmtwo_1$ or $\ntmTWOtwo\isub\var\valtwo\tow\tmtwo_1$ such that $\tm_1\lasrel\tmtwo_1$, hence we find $\tmtwo$ easily in both cases, such that $\ntmtwo\isub\var\val \tow \tmtwo$ and $\tm\lasrel\tmtwo$.
		\end{itemize}
	\end{enumerate}
\end{proof}


\subsection{Lassen's closure preserves naive simulations}

Finally, we prove that the Lassen's closure of a naive simulation is a simulation.

\gettoappendix{prop:main-lemma_naive}
\begin{proof}
	
\input{proofs/proof-naive-is-compatible}
\end{proof}
