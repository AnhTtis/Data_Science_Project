% !TEX root = main.tex
% !TeX spellcheck = en_US
\section{Introduction}

The study of program equivalences for $\l$-calculi is an important topic where semantical and operational techniques meet. Properties of program equivalences are notoriously difficult to prove.  Even the equivalence of two terms might be challenging to establish, if the notion of equivalence is \citeauthor{morris1968lambda}' contextual equivalence \citeyearpar{morris1968lambda}, or some variant still involving a universal quantification, such as \citeauthor{abramsky-lazy-90}'s applicative bisimilarity \citeyearpar{abramsky-lazy-90}. Another difficulty is the fact that properties of program equivalences are brittle, as they are not preserved by extensions of the calculus under study, nor by restrictions, and not even by changing the evaluation strategy within the same calculus.

It is well-known that applicative bisimilarity is fully abstract for contextual equivalence in the untyped call-by-name weak $\l$-calculus (where \emph{weak} stands for reduction only out of abstractions, which is standard in functional languages) \cite{abramsky-lazy-90}, as well as in Plotkin's call-by-value weak $\l$-calculus \cite{DBLP:journals/fuin/EgidiHR92,DBLP:books/cu/12/Pitts12}. Therefore, one might be led to think that the call-by-name/call-by-value switch is quite robust in the weak setting, even if it is known that its robustness breaks in a probabilistic setting, as shown by \citet{DBLP:conf/popl/LagoSA14}. 

This paper stems from the observation that another natural program equivalence, \citeauthor{SANGIORGI-normal-form-bisimulation}'s \emph{normal form bisimilarity} \citeyearpar{SANGIORGI-normal-form-bisimulation} (shortened to nf-bisimilarity), behaves differently in call-by-name (shortened to \cbn) and call-by-value (\cbv), already in the untyped effect-free weak case. 


\paragraph{Normal Form Bisimilarity} Normal form bisimulations are program equivalences that, instead of comparing terms \emph{externally}, depending on how they behave \emph{in contexts}, compare them \emph{internally}, by looking at the structure of their (infinitary) \emph{normal forms}. A distinctive feature of nf-bisimulations is that they directly manipulate \emph{open terms}, to the point that \citeauthor{SANGIORGI-normal-form-bisimulation} rather used to call them \emph{open bisimulations} in his seminal paper \citeyearpar{SANGIORGI-normal-form-bisimulation}.

\cadr{It is known that Sangiorgi's}{Sangiorgi's} \cbn nf-bisimilarity is not fully abstract for contextual equivalence, being sound but not complete. %, but it corresponds to another natural notion in the theory of the $\l$-calculus, the equivalence induced by \levy-Longo trees. 
 The failure of full abstraction is compensated by the fact that \cbn nf-bisimilarity is easier to establish than applicative similarity, because of the absence of quantification over arguments. Typically, it is easy to show that different fix-points combinators---which are the paradigmatic terms with infinitary normal forms---are nf-bisimilar, while it is hard to show that they are applicative bisimilar.


There exists a \cbv nf-bisimilarity, \citeauthor{LassenEnf}'s \emph{enf bisimilarity} $\eqenf$ \citeyearpar{LassenEnf}\cadr{, which---as Sangiorgi's---is  sound but not complete for \cbv contextual equivalence $\eqcv$, and which is considered the \cbv nf-bisimilarity of reference.}{, which is considered the \cbv nf-bisimilarity of reference. Like Sangiorgi's, it is sound but not complete for \cbv contextual equivalence $\eqcv$.} It is not \cadr{the}{an} off-the-shelf adaptation of Sangiorgi's to \cbv, as it has an \emph{extra clause} about evaluation contexts, exploiting the well-known issues of Plotkin's \cbv $\l$-calculus with open terms; issues that are discussed at length by \citet{accattoli+guerrieri-opencbv,Accattoli-Guerrieri-TypesFireballs,DBLP:journals/pacmpl/AccattoliG22}. 

The incompleteness of both \cbn and \cbv nf-bisimulations for the weak $\l$-calculus at first sight suggests that they are robust with respect to the \cbn/\cbv switch. In fact, they are \emph{not}. \cadr{The ways in which the two bisimilarities are incomplete, indeed, are very different. }{The two bisimilarities are indeed incomplete for very different reasons.}

\paragraph{Incompleteness of Enf.} \cadr{There are in fact various ways in which enf bisimilarity is incomplete. We can mention at least the following four.}{Here are four important reasons why enf bisimilarity is incomplete.}
\begin{enumerate}
\item \emph{Eta}: \cadr{it}{enf bisimilarity} does not validate\cadr{ (the \cbv variant $\etav$ of) }{ $\etav$, the \cbv variant of }$\eta$-equivalence, even if Lassen himself shows how to \cadr{correct this aspect}{refine enf to correct this aspect}. 

\item \emph{\cbn duplication}: enf bisimilarity does not equate duplications of terms that are not \emph{by value}: terms such as $(\la\var\vartwo\var\var)\tm$ and $\vartwo\tm\tm$, are contextually equivalent for any $\tm$, also for terms $\tm$ that are \emph{not} values, while in general they are not enf bisimilar. In richer \cbv settings with state or probability, contexts discriminate more, and those terms are not contextually equivalent, but in the pure case they are. This aspect, referred here to as \emph{cost-sensitiveness}, is not necessarily a drawback, as it keeps the program equivalence closer to \cbv intuition. 

\item \emph{Commutation of (independent) $\letexp$s}: in the pure case---\cadr{as well as}{or} in \adr{the }presence of commutative effects---contextual equivalence validates the following commutation $\equivcom$ (presented with $\letexp$s for readability, but easily presentable without them, expanding $\letexp$s as $\beta$-redexes):
\begin{center}
$\letin\var\tmtwo{\letin\vartwo\tmthree\tm} \ \ \equivcom\ \ \letin\vartwo\tmthree{\letin\var\tmtwo\tm}$\ \ \ \  if $\var\notin\fv\tmthree$ and $\vartwo\notin\fv\tmtwo$.
\end{center}
Enf bisimulations do not equate these terms.

\item \emph{$\Omega$-terms/meaningless terms}: enf bisimilarity does not equate terms contextually equivalent to the paradigmatic looping/meaningless $\l$-term $\Omega$, referred here to as \emph{$\Omega$-terms}. This is connected to the mentioned issues of Plotkin's calculus with open terms, as they cause \emph{false normal forms}, that is, $\Omega$-terms that are normal. In \cbn, instead, all $\Omega$-terms diverge.
\end{enumerate}
Point 2 is acceptable, because a bisimilarity validating \cbn duplication in \cbv needs to go beyond comparing the structure of normal forms, as the example shows, thus necessarily departing from the format of nf-bisimilarities. Thus, we shall consider cost-sensitivity as \emph{inherent} to \cbv nf-bisimilarities, which need not be corrected.
Point 3 is specific to \cbv, because in \cbn $\letexp$s disappear during evaluation, while in \cbv with open terms they might end up in normal forms. It is thus disappointing that commuting $\letexp$s are not captured. More precisely, it would be desirable to have a notion of nf-bisimilarity where the validation of commuting $\letexp$s can be added/removed modularly, as to adapt to different \cbv settings (pure/(non-)commutative-effects). Point 4 is a stark difference between \cbv and \cbn, because Sangiorgi's bisimilarity \emph{does equate} the $\Omega$-terms of weak \cbn. 

\paragraph{$\Omega$-terms} The failure of enf bisimilarity with respect to $\Omega$-terms is relevant, as all natural denotational models and program equivalences identify $\Omega$-terms (of the modelled notion of evaluation). Roughly, different semantics are built by distinguishing various partitions of non-$\Omega$-terms, but they put all terms contextually equivalent to the idle loop $\Omega$ in the same class---indeed, what would be the advantage of partitioning them in classes? For strong \cbn evaluation, in particular, the equational identification of $\Omega$-terms is the concept around which \citeauthor{Barendregt84}'s classic book \citeyearpar{Barendregt84} is built (therein $\Omega$-terms are called \emph{unsolvable terms}, see \refsect{preliminaries}). 
 
\paragraph{Two Possible Approaches.} To overcome some of the mentioned incompleteness via a nf-bisimilarity, one can act on two different levels: \emph{changing the underlying calculus}, which provides the normal forms to compare, or \emph{changing the nf-bisimilarity}, that is, the notion of comparison. For instance, \citet{DBLP:conf/fossacs/BiernackiLP19} address the problem of $\Omega$-terms (called therein \emph{deferred diverging terms}) by providing an alternative definition of enf bisimilarity. Commuting $\letexp$s, however, do not seem to be capturable by a similar tweak of enf-bisimilarity, as the commutation does not behave well in Plotkin's \cbv \adr{ calculus}. At first sight, changing the underlying calculus is less viable, as in general it  changes the notion of contextual equivalence. %It is well known that there are extensions of Plotkin's calculus, with different notions of normal form but with the same notion of contextual equivalence, and where all $\Omega$-equivalent terms diverge.

\paragraph{The Value Substitution Calculus.} The starting point of this paper is the \emph{value substitution calculus} (shortened to VSC), a \cbv $\l$-calculus due to \citet{accattoli+paolini-vsc} and related to linear logic proof nets \cite{Accattoli-proofnets}. The VSC solves the issues  of Plotkin's calculus with open terms via an extension of the rewriting rules, while--crucially--retaining the same notion of contextual equivalence \cite{DBLP:journals/pacmpl/AccattoliG22}. Moreover, the proof nets inception of the calculus makes it easy to deal with the commutation of $\letexp$s, which can be modularly added via a notion of \emph{structural equivalence}, compatible  with the rewriting rules by design. Therefore, the VSC is a natural candidate for designing a \cbv nf-bisimilarity improving on some of the incompleteness of Lassen's by changing the underlying calculus.

\paragraph{Net Bisimilarity.} \cadr{By using}{Using} the VSC, we introduce a \cbv nf-bisimilarity validating the commutation of $\letexp$s and identifying $\Omega$-terms. The obtained \emph{net bisimilarity} $\eqnet$ and the proof of its \emph{compatibility} (that is, its stability by context closure)---the challenging property to prove for bisimilarities---are the main contributions of this paper. Compatibility implies soundness with respect to contextual equivalence, and it is proved adapting \citeauthor{lassen1999bisimulation}'s variant \citeyearpar{lassen1999bisimulation} for nf-bisimilarities of Howe's method. As it is often the case for nf-bisimilarities, ours is sound but not complete. In particular---as for enf bisimilarity---it is \emph{cost-sensitive}. 

The crafting of net bisimilarity rests on a sophisticated analysis of \cbv and the VSC. We start with the off-the-shelf adaptation of Sangiorgi's nf-bisimilarity to the VSC, \emph{without Lassen's extra clause}, as it is unclear how to adapt the clause to the VSC. We then refine the adaptation by comparing normal forms modulo the \adr{(proof nets)} structural equivalence of the VSC---which includes commuting $\letexp$s---whence the name \emph{net} bisimilarity. We actually go further, introducing a \emph{parametric} nf-bisimilarity, where parts of the structural equivalences can be turned off and on at will---because some (such as commuting $\letexp$s) fail in extensions of \cbv with non-commutative effects---thus defining a \emph{family} of \cbv nf-bisimilarities, all proved compatible via a \emph{single abstract proof}. 

Our result is however more a new beginning than the end of the story: \net bisimilarity, indeed, is \emph{not} a refinement of Lassen's $\eqenf$. In fact, the two are \emph{incomparable}, because \net bisimilarity is incomplete in yet some other ways, which are instead validated by Lassen's. %Another detour is in order.

\paragraph{Moggi's Laws} 
It is well-known that Plotkin's \cbv $\l$-calculus is defective, and not just because of open terms. Plotkin himself showed the incompleteness of his continuation-passing translation \cite{PLOTKIN1975}. To both solve the issue and modeling extensions with effects, Moggi extended Plotkin's calculus with equations corresponding to laws for monads \cite{Moggi88tech,DBLP:conf/lics/Moggi89}, that are sound for contextual equivalence. Lassen's enf bisimulations verify these laws, showing that it is possible to capture the laws in the notion of nf-bisimulation rather than by changing the underlying calculus. In particular, it is Lassen's extra clause that allows enf to capture Moggi's laws.%In particular, enf verifies the \emph{left identity law} $\Id \tm \equivlid \tm$, where $\Id=\la\var\var$. If $\tm$ is a value, the law is included in $\betav$-reduction, but Moggi extends it to \emph{every term} $\tm$. 

Moggi's laws, however, are not rules of the VSC, and are not captured by net bisimilarity. Additionally, it is unclear how to extend net bisimulations as to satisfy Moggi's laws. Once more, there are two options: extending the underlying calculus (the VSC) or the nf-bisimilarity ($\eqnet$). Both options however break  properties that are crucial for the proof that net bisimilarity is compatible. Another disappointing fact is that the addition of $\etav$ to net bisimilarity requires one of Moggi's laws, so it is also unclear how to add $\etav$ to net bisimulations.

%Another issue of Plotkin's calculus is its inadequacy for dealing with \emph{open terms}. The problem was first studied by \citeauthor{DBLP:journals/ita/PaoliniR99} \citeyearpar{DBLP:journals/ita/PaoliniR99,DBLP:conf/ictcs/Paolini01,parametricBook} in 1999, and it was then extensively analyzed by \citeauthor{Accattoli-proofnets}, \citeauthor{DBLP:journals/lmcs/GuerrieriPR17}, and co-authors during the last decade \citeyearpar{accattoli+paolini-vsc,shufflingcalculus,Accattoli-proofnets,accattoli+guerrieri-opencbv,Accattoli-Guerrieri-TypesFireballs,DBLP:journals/lmcs/GuerrieriPR17,DBLP:conf/ppdp/AccattoliCGC19,DBLP:journals/scp/AccattoliG19,DBLP:conf/lics/AccattoliCC21,DBLP:journals/corr/abs-2104-13979,DBLP:journals/pacmpl/AccattoliG22}. Also in this case, the solution amounts to \cadr{extend}{extending} Plotkin's calculus. There are many extensions that remove the issue with open terms, as shown by \citet{accattoli+guerrieri-opencbv}. Among these extensions, one stands out, the already mentioned VSC. In particular, it is the setting where \cbv solvability and scrutability have first been characterized and understood \cite{accattoli+paolini-vsc,DBLP:journals/pacmpl/AccattoliG22}, because they are affected by open terms and cannot be properly studied in Plotkin's calculus.  


%\paragraph{Normal Form Bisimulations By Value} We can finally outline the intricacies of \cbv nf-bisimulations:
%\begin{itemize}
%\item \emph{Enf $vs$ open terms}: enf bisimulations verify Moggi's left identity law but they do not equate inscrutable terms because they are based on Plotkin's calculus, which struggles with open terms. It is unclear, however, how to extend enf bisimulations as to equate inscrutable terms\footnote{It is easy to extend enf bisimilarity as to equate inscrutable terms in an \emph{ad-hoc} way, by using both Plotkin's calculus and the VSC in its definition, but we do not consider such a direction worth exploring.}, because they \emph{exploit} the issue with open terms in their definition. Therefore, removing the issue also somewhat forbids the definition itself of enf bisimulations. 
%\item \emph{Net $vs$ left identity}: our net bisimulations equate inscrutable terms but do not verify the left identity law, as it is not a law of the VSC. Despite the simplicity of the law, it is unclear how to extend net bisimulations as to satisfy it. There are in principle two options: adding the law to the rewriting of the VSC or to the definition of the bisimulations. Both options however break  properties that are crucial for the proof that net bisimilarity is compatible.
%\end{itemize}
\paragraph{Impasse and Beyond} Summing up, it seems that one cannot have the cake (a framework for nf-bisimilarity satisfying either commuting $\letexp$s and $\Omega$-terms, or Moggi's laws and $\etav$) and eat it too (extend the framework as to capture the missing half), or at least it is far from evident how to do it. The exploration of such an \emph{impasse} is the other main contribution of the paper. We study two further program equivalences, a naive bisimilarity $\eqncbv$ and the program equivalence $\equivtype$ induced by a model, which are sort of the intersection and the union of enf and net bisimilarities.

\paragraph{Naive Bisimilarity $\eqncbv$ = No Cake and No Eating} We consider the off-the-shelf adaptation of Sangiorgi's \cbn nf-bisimulations to 
Plotkin's \cbv, obtaining \emph{naive nf-bisimulations}, which are strictly weaker than both enf and net bisimulations, as they do not identify commuting $\letexp$s, $\Omega$-terms, Moggi's laws, nor $\etav$. The experiment is instructive because we show that naive bisimulations, despite their weakness, are enough to provide easy proofs of bisimilarity for fix-point combinators---Lassen's extra clause plays no role in that. Naive bisimilarity also gives us the opportunity to gently introduce the proof technique that we use for net bisimilarity.

\paragraph{Type Equivalence $\equivtype$ = Cake and Eating, Universally} At the other end of the spectrum, we investigate the program equivalence given by the equational theory of Ehrhard's \cbv relational model \cite{DBLP:conf/csl/Ehrhard12}. We call it \emph{type equivalence} because the model is presented as a multi type system (a variant of intersection types). Such a model was already extensively studied in connection with the VSC by \citet{Accattoli-Guerrieri-TypesFireballs,DBLP:journals/pacmpl/AccattoliG22}. Its equational theory does not have a presentation via nf-bisimulations, nor any other characterization, but it is nonetheless possible to study it via the multi type system. It turns out that type equivalence, similarly to nf-bisimilarities, is compatible and sound, but not complete for contextual equivalence, because it is cost-sensitive. It is not an easily usable equivalence, as it is based on a \emph{universal} quantification over the typings for a term, but it provides interesting insights.

Our results are that both enf and net bisimilarities are \emph{included} in type equivalence. Therefore, the two bisimilarities are joinable. Since both are sound, they are obviously joinable in a cost-insensitive setting, as they are both included in contextual equivalence. Our results show that they are also joinable in a \emph{cost-sensitive} program equivalence, thus suggesting that a nf-bisimilarity joining the two might be possible. Crafting it, and especially proving that it is compatible, is left to future work.

%The semantics of the untyped \cbv Î»-calculus (CbV)
%is instead still in its infancy, because of some inherent difficulties but also because CbV solvable terms are less
%studied and understood than in \cbn. On the one hand, we show that a carefully crafted presentation
%of CbV allows us to recover many of the properties that solvability has in \cbn, in particular qualitative
%and quantitative characterizations via multi types. On the other hand, we stress that, in CbV, solvability plays
%a different role: identifying unsolvable terms as meaningless induces an inconsistent theory.





%
%functional programming
%
%untyped cbv
%
%proving inscrutable terms can be collapsed : three ways (genericity, model, bisimulation)
%
%we can work in the vsc weak contextual equivalence rather than plotkin's because they coincide

The following table sums up the situation.
\input{figures/recap-table-program-equivalences}


\paragraph{Related Work} Beyond the already cited papers, nf-bisimilarity is studied in variants and extensions of the $\l$-calculus by \citet{lassen1999bisimulation,DBLP:journals/entcs/Lassen06,DBLP:conf/lics/Lassen06}, \citet{DBLP:conf/csl/LassenL07,DBLP:conf/lics/LassenL08}, \citet{DBLP:conf/flops/BiernackiL12} and \citet{DBLP:journals/taosd/JagadeesanPR09}, and in relationship to game semantics by \citet{DBLP:conf/csl/LevyS14}, \citet{DBLP:conf/lics/JaberM21}, and \citet{DBLP:conf/csl/JaberS22}. The presence of state in \cite{DBLP:conf/birthday/StovringL09,DBLP:conf/fossacs/BiernackiLP19} makes enf-like bisimilarities fully abstract (as it makes contextual equivalence cost-sensitive and commutation of $\letexp$s invalid). Lassen's enf bisimilarity is studied with respect to $\eta$-equivalence by \citet{DBLP:journals/lmcs/BiernackiLP19}, extensions with effects by \citet{DBLP:conf/esop/LagoG19}, and the $\pi$-calculus by \citet{DBLP:journals/tcs/DurierHS22}. 

\cbv multi types are also used by Kesner and co-authors \cite{DBLP:conf/flops/BucciarelliKRV20,DBLP:conf/fscd/KesnerP22,DBLP:conf/csl/KesnerV22,DBLP:journals/pacmpl/ArrialGK23} and \citet{DBLP:conf/lfcs/Diaz-CaroMP13}.

A notion of \cbv B\"ohm tree, inducing a program equivalence similar to nf-bisimilarity is proposed by \citet{bohmtree-cbv}. Their equivalence is in between our naive and net bisimilarities. They conjecture that it characterizes type equivalence. Our results \emph{refute} such a conjecture: with respect to the benchmarks of \refsect{benchmarks}, their equivalence equates all $\Omega$-terms but not commuting $\letexp$s---which are validated by net bisimilarity---nor Moggi's left identity law $\equivlid$.

Very recently, \citet{Nikos2023} introduced a \emph{complete} \cbv bisimilarity, presented as a \emph{nf-bisimilarity}. It is however different from Sangiorgi's and Lassen's, as Koutaval et al.'s bisimilarity considers more than the structure of normal forms, which---as already pointed out---is mandatory to validate \cbn duplication and be complete in \cbv. Their definition, indeed, is rather based on game semantics tools and environmental bisimulations. Moreover, it addresses the different setting of \cbv PCF, which is typed, and it is not clear whether the result smoothly adapts to the untyped pure \cbv $\l$-calculus.

%\adr{Add discussion related to fully abstract nf bisimulations LICS23}
%\adr{Untyped \cbv deals with divergence as a \emph{feature} of the language. Other syntax, as Call-by-Value PCF, are based on a simply-typed lambda-calculus and then add divergence, similar to how one would add an \emph{effect}. Techniques from operational game semantics have recently yielded a fully abstract nf-bisimulation for \cbv PCF \adr{cite LICS23}. It is unclear to us (and ongoing work) whether one could reach full abstraction using similar techniques in untyped \cbv lambda-calculus: types may guide the nf-bisimulation, not all untyped lambda-terms exists in PCF (e.g. $\la\var\var\var$), divergence is not introduced in the same way (PCF introduces divergence in a controlled way), etc.}

\paragraph{Proofs} Omitted proofs are in the additional material associated with this submission on HotCRP. In case of acceptance, a version of this paper with all proofs will be put on arXiv.org.


