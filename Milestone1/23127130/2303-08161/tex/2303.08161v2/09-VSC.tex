% !TEX root = main.tex

\section{Value Substitution Calculus}
\label{sect:vsc}
\input{figures/figure-vsc} 
Intuitively, the VSC is a \cbv $\lambda$-calculus extended with $\letexp$-expressions, as is common for \cbv $\l$-calculi such as \citeauthor{DBLP:conf/lics/Moggi89}'s one [\citeyear{Moggi88tech,DBLP:conf/lics/Moggi89}]. 
We do however replace a $\letexp$-expression $\letin\var\tmtwo\tm$ with a more compact  \emph{explicit substitution} (ES for short) notation $\tm\esub{\var}{\tmtwo}$, which binds $\var$ in $\tm$ and that has precedence over abstraction and application (that is, $\la\var\tm\esub\vartwo\tmtwo$ stands for $\la\var(\tm\esub\vartwo\tmtwo)$ and $\tm\tmthree\esub\vartwo\tmtwo$ for $\tm(\tmthree\esub\vartwo\tmtwo)$). Moreover, our $\letexp$/ES does not fix an order of evaluation between $\tm$ and $\tmtwo$, in contrast to many papers in the literature (\eg \citet{DBLP:journals/toplas/SabryW97,DBLP:journals/iandc/LevyPT03}) where $\tmtwo$ is evaluated first.

The reduction rules of VSC are slightly unusual as they use \emph{contexts} both to allow one to reduce redexes located in sub-terms, which is standard, \emph{and} to define the redexes themselves, which is less standard---these kind of rules is %sometimes 
called \emph{at a distance}. The rationale behind is that the rewriting rules are designed to mimic exactly cut-elimination on linear logic proof nets, via \citeauthor{DBLP:journals/tcs/Girard87}'s \citeyearpar{DBLP:journals/tcs/Girard87} \cbv translation $(A \Rightarrow B)^v = ! (A^v \multimap B^v)$ of intuitionistic logic into linear logic, see \citet{Accattoli-proofnets}.  


\paragraph{Root rewriting rules}
In VSC, 
there are two main rewrite rules, the \emph{multiplicative} one $\tom$ and the \emph{exponential} one $\toe$ (the terminology comes from the connection between VSC and linear logic), and both work \emph{at a distance}: they use contexts even in the definition of their \emph{root} rules (that is, before the contextual closure). Their definition is based on \emph{substitution contexts} $\sctx$, which are lists of~ES. 
In \Cref{fig:vsc}, the root rule $\rtom$ (resp. $\rtoe$) is assumed to be capture-free, so no free
 variable of $\tmtwo$ (resp. $\tm$) is captured by the substitution context $\sctx$ (by possibly $\alpha$-renaming on-the-fly). 


Examples: $(\la\var\vartwo)\esub\vartwo\tm\tmtwo \rtom \vartwo\esub\var\tmtwo\esub\vartwo\tm$ and $(\la\varthree\var\var)\esub\var{\vartwo\esub\vartwo\tm} \rtoe (\la\varthree\vartwo\vartwo)\esub\vartwo\tm$. An example with on-the-fly $\alpha$-renaming is $(\la\var\vartwo)\esub\vartwo\tm\vartwo \rtom \varthree\esub\var\vartwo\esub\varthree\tm$.

A key point is that $\beta$-redexes are decomposed via ES: the \emph{by-value} restriction is on ES-redexes, \emph{not} on $\beta$-redexes, because only values can be substituted.
The multiplicative rule
$\rtom$ fires a $\beta$-redex at a distance and generates an  ES even when the argument is not a value.
	The \cbv discipline is entirely encoded in the exponential rule $\toe$ (see \Cref{fig:vsc}): it can fire an  ES performing a substitution only when its argument is a \emph{value} (\ie a variable or an abstraction) up to a list of ES. This means that only values can be duplicated or erased.

\paragraph{Rewriting Rules} \cadr{We close the root rules by evaluation contexts $\evctx$, which allow reduction everywhere but under abstractions.}{We define weak reduction, noted $\tovsc$, to be the closure of the root rules by evaluation contexts which allow reduction everywhere but under lambdas.} In other papers about the VSC \cite{accattoli+paolini-vsc,accattoli+guerrieri-opencbv,DBLP:conf/lics/AccattoliCC21,DBLP:journals/pacmpl/AccattoliG22}, where other contextual closures are also considered, they are called \emph{weak} or \emph{open} contexts. \cadr{In this work, we only consider weak reduction, noted $\tovsc$.  Examples: }{Examples:}

\adr{\begin{center}
$\begin{array}{r@{\hspace{.1cm}}r@{\hspace{.1cm}}l@{\hspace{.5cm}} r@{\hspace{.1cm}}r@{\hspace{.1cm}}l}
		\tm \esub\var{(\la\vartwo\tmtwo)\esub\varthree\tmthree \tmfour}
		& \tom &\tm \esub\var{\tmtwo\esub\vartwo\tmfour\esub\varthree\tmthree}
		&
		\tm (\var\var) \esub\var{\vartwo\esub\varthree\tmtwo} & \toe & \tm (\vartwo\vartwo)\esub\varthree\tmtwo
		\\[2pt]
		((\var\var) \esub\var{\la\vartwo\varthree} \tm)\esub\varfour\tmtwo 
		& \toe & ((\la\vartwo\varthree) (\la\vartwo\varthree) \tm)\esub\varfour\tmtwo
		&
		\la\varthree (\var\var) \esub\var{\la\vartwo\varthree} & \not\toe&  \la\varthree(\la\vartwo\varthree) \la\vartwo\varthree
\end{array}$
\end{center}
}
\paragraph{Diamond}The $\tovsc$ reduction is non-deterministic, as for instance:
\begin{center}
$\delta (\delta \Id) \ \lRew{\expoabs}\  \vartwo\esub\vartwo\delta (\delta \Id) \ \tom \ \vartwo\esub\vartwo\delta((\var\var)\esub\var\Id).$
\end{center}
It is however more than confluent, it is diamond.
\begin{proposition}[Diamond, \cite{accattoli+paolini-vsc}]
\label{prop:vsc-diamond}
$\tovsc$ is diamond.
\end{proposition}

We now investigate normal forms for terms in the VSC, which admit a, quite complex, inductive description via \emph{inert terms}.

\paragraph{Inert Terms and Normal Forms} 
\cbv is about \emph{values}, and, if terms are closed, normal forms are abstractions. In going beyond the closed setting,  a finer and more general view is required. Normal forms (for $\tovsc$) are given by mutual induction with the notions of \emph{inert term} and \emph{inert substitution contexts}, as in \Cref{fig:vsc}. 
Inert substitution contexts are lists of ESs where the content of every ES is an inert, ensuring that none of the ESs can fire a $\toe$-redex (as inerts are exactly normal forms which are not of the shape $\sctxp\val$).

Examples: $\la\var\vartwo$ is a normal form 
as an abstraction, while $\vartwo(\la\var\var)$, $\var\vartwo$, and $(\varthree(\la\var\var))(\varthree\varthree) (\la\vartwo(\varthree\vartwo))$ are normal forms as inert terms. The grammars also allow to have ES containing inert terms around abstractions and applications: $(\la\var\vartwo)\esub\vartwo{\varthree\varthree}$ is a normal form and $\var\esub\var{\vartwo(\la\var\var)}\vartwo$ is an inert term. One of the key points of inert terms is that they have a \emph{free} head variable (in particular they are open). Inert terms are the \cbv equivalent of \cbn neutral terms. In  
\cite{DBLP:conf/icfp/GregoireL02}, inert terms are called \emph{accumulators}, and normal forms are  called \emph{values}.
Some papers about the VSC adopt a restricted version of the $\tovsc$ reduction, where variables are not values and thus cannot be substituted by the $\toe$-rule. The restriction induces slightly different notions of normal forms (often called \emph{fireballs}) and inert terms (still called \emph{inert terms}), but the difference does not change the main properties of the VSC, as discussed in \cite{DBLP:journals/pacmpl/AccattoliG22}.

\begin{proposition}[Normal forms, \cite{accattoli+paolini-vsc} ]
$\tm$ is $\tovsc$-normal if and only if $\tm$ is a $\ntm$-term as defined in \Cref{fig:vsc}.
\end{proposition}

\paragraph{$\Omega$-Equivalence} One of the features of the VSC is that it solves the issues of Plotkin's calculus with respect to \cbv $\Omega$-terms. Consider the $\Omega$-term $\Omega^L =  (\la\var\delta)(\vartwo\varthree)\delta$ which is contextually equivalent to $\Omega$ but normal for Plotkin. In the VSC, instead, it diverges:
\begin{center}
$ (\la\var\delta)(\vartwo\varthree)\delta \tom \delta \esub\var{\vartwo\varthree}\delta \tom \varfour\varfour\esub\varfour\delta \esub\var{\vartwo\varthree} \toeabs \delta\delta \esub\var{\vartwo\varthree} \tom \ldots$.
\end{center}
More generally, \emph{all} \cbv $\Omega$-terms diverge: the following characterization of \cbv $\Omega$ holds, analogous to the one for \cbn (\refthm{cbn-scrutability-characterization}) and obtained composing the diverging characterization of \cbv inscrutable terms due to \citet{accattoli+paolini-vsc} with an easy proposition (in \refapp{app-vsc}) showing that \cbv inscrutable terms and \cbv $\Omega$-terms coincide.

\begin{toappendix}
\begin{theorem}[VSC diverging characterization of $\Omega$-terms]
	\label{thm:cbv-scrutability-characterization}
$\tm$ is a \cbv $\Omega$-term if and only if $\tm$ is $\tovsc$ diverging.
\end{theorem}
\end{toappendix}
Despite the fact that the VSC makes $\Omega^L$ diverge as in \cbn, it does \emph{not} validate \cbn duplication nor \cbn erasure, as $(\la\var\vartwo)\Omega$ is $\tovsc$-divergent and $(\la\var \vartwo \var \var) (\varthree\varthree) \tom (\vartwo \var \var)\esub\var{\varthree\varthree} \not\tovsc \vartwo (\varthree\varthree)(\varthree\varthree)$.

\paragraph{Contextual Equivalence} Terms such as $\Omega^L$ are normal for Plotkin but divergent in the VSC, that is, the VSC and Plotkin's calculus have different notions of termination. One might then suspect that contextual equivalence in the VSC is not the same as in Plotkin's calculus. This is not the case, in fact, because the VSC behaves differently \emph{only on open terms}, while contextual equivalence is defined reducing \emph{closed terms} only. %The following result is due to \citet{DBLP:journals/pacmpl/AccattoliG22}.


\begin{proposition}[\cite{DBLP:journals/pacmpl/AccattoliG22}]
Two $\l$-terms without ES are contextual equivalent in Plotkin's calculus if and only if they are contextual equivalent in the VSC.
\end{proposition}
