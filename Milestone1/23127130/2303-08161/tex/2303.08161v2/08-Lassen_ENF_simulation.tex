% !TEX root = main.tex

\section{Lassen's Eager Normal Form Simulation}
\label{sect:enf}
The \cbv nf-simulation of reference in the literature is due to Lassen \cite{LassenEnf}.  Lassen's simulation is interesting because it is not defined by simply changing the notion of reduction in Sangiorgi's. Lassen indeed exploits stuck redexes in open terms, and defines a simulation that \emph{unstucks} them, a mechanism which we shall refer to as \emph{stop-and-go}. 
%\adr{Lassen considers \emph{left evaluation}: let $\bswlefts $ and $\bswleftdiv$ be big-step termination and divergence with respect to left \cbv reduction $\tolw$.}

\paragraph{Grammar of Left Normal Forms} Lassen's similarity is built using \emph{left reduction} $\tolw$. The starting point is the observation that, despite the limits of left reduction, it admits a description of its normal forms via left contexts which is extremely simple and elegant.
\begin{lemma}[Unique decomposition, \cite{LassenEnf}]
\label{l:las-unique-dec}
	Any (possibly open) term is either a value or admits a unique decomposition $\levctxp{\val\valtwo}$. In particular, left normal forms can be described as follows:
	\begin{center}
	$\begin{array}{c@{\hspace{.5cm}}rcc}
	\textsc{Left normal forms}  &
	\ntm,\ntmtwo & \grameq &  \val\mid \levctxp{\var\val}
	\end{array}
	$\end{center}

\end{lemma}



The simple structure of left normal forms is then used by Lassen to define eager nf-simulation. The crucial clause is the fourth one, which realizes the stop-and-go mechanism. \emph{Notation}: let $\bswlefts $ and $\bswleftdiv$ be big-step termination and divergence with respect to left \cbv reduction $\tolw$.

\begin{definition}[\Enf simulation, \cite{LassenEnf}]
	A relation $\relsym$ is an \emph{eager normal form (\enf) simulation} if $\relsym\subseteq\relenf$, where $\tm \relenf\tmp$ holds whenever $\tm,\tmp$ satisfy one of the following clauses:
	\begin{center}
		$\begin{array}{r@{\hspace{.3cm}}r@{\hspace{.3cm}}l@{\hspace{.3cm}}l@{\hspace{.3cm}}lll}
		\textup{(enf 1)} & &&\tm\bswleftdiv & \ie ~ \text{has no} \tolw \text{-normal form.}
		\\
		\textup{(enf 2)} & \tm \bswlefts \var  &\text{and}& \tmp \bswlefts \var
		\\
		\textup{(enf 3)} & \tm \bswlefts \la\var\tmfirst &\text{and}& \tmp \bswlefts \la\var\tmpfirst 
		& \text{with} ~ \tmfirst \rel \tmpfirst
		\\
		\textup{(enf 4)} & \tm \bswlefts \levctxp{\var\val}  &\text{and}& \tmp \bswlefts \levctxtwop{\var\valtwo} 
		&
		\textup{with} ~ \val\rel\valtwo ~ \text{and}  ~ \levctxp{\varthree}\rel\levctxtwop{\varthree} 
		\\
		&& &&\text{where} ~ \varthree ~ \text{is not free in} ~ \levctx ~ \text{or} ~ \levctxtwo
		\end{array}
		$\end{center}
	\emph{\Enf similarity}, written $ \leqenf $, is defined by co-induction as the largest \enf simulation, that is, it is the union of all \enf simulations. We say that $\tm$ is \emph{\enf similar} to $\tmp$ if $\tm \leqenf \tmp$.
\end{definition}

\paragraph{Stop-and-Go, Double Task, and Left Identity.} The stop-and-go clause (enf 4) cleverly does two tasks at the same time, subsuming clause (nai 4) of naive similarity in a bottom-up way and capturing the left identity equivalence $\equivlid$. 

About (nai 4), consider for instance comparing $\tm \defeq \var\vartwo\varfour$ with itself via enf simulations. Clause (enf 4) reduces it to compare $\varthree\varfour$ and $\vartwo$ with themselves, since $\tm = \lctxp{\var\vartwo}$ with $\lctx\defeq \ctxhole\varfour$. Then, it reduces the first one to compare $\varthree'$ and $\varfour$ with themselves. In contrast, (nai 4) (or Sangiorgi's (cbn 4)) proceeds \emph{top-down}, by splitting $\var\vartwo\varfour$ into $\var\vartwo$ and $\varfour$, and then splitting $\var\vartwo$.

About the left identity equivalence, consider showing that $\tm \defeq \Id(\var\var)$ and $\tmtwo\defeq \var\var$ are enf similar. Evaluation is stuck on $\tm$, that is, it \emph{stops} because $\var\var$ is not a value. Note that $\tm$ has shape $\lctxp{\var\val}$ with $\lctx=\Id\ctxhole$ and $\val=\var$. The idea is that a term $\tmtwo$ that is $\leqenf$-similar to $\tm$ has to get stuck as well, or anyway decompose in a similar way. Now, $\tmtwo$ is not stuck, because there are no blocked redexes, but it has nonetheless shape $\lctxtwop{\var\valtwo}$ by taking $\lctxtwo = \ctxhole$ and $\valtwo = \var$. The comparison between $\tm$ and $\tmtwo$ is then reduced to compare the two pairs $\lctxp\varthree = \Id \varthree$ and $\lctxtwop\varthree=\varthree$, and $\val=\var$ and $\valtwo=\var$. The second pair trivially matches, because the identity relation is an enf simulation. About the first pair, note that $\Id\varthree$ is no longer stuck, that is, it can \emph{go}. And for the next round of comparison (of $\Id\varthree$ and $\varthree$) we have to first $\tolw$ reduce the terms, so that $\Id\varthree \tolw \varthree$ and thus also the first pair trivially matches.

Summing up, the enf simulation relating $\Id(\var\var)$ and $\var\var$ is the following  simulation $\relsym$: \[\relsym =\{(\Id(\var\var),\var\var), (\var,\var), (\Id\varthree,\varthree), (\varthree,\varthree)\}\]
This is  just an instance, but the following more general result holds.
\begin{proposition}[Enf bisimilarity validates left identity]
$\Id \tm \eqenf \tm$ for any term $\tm$.
\end{proposition}


\paragraph{Left/Right/Weak Non-Equivalent Variants} Replacing left reduction with right reduction, one obtains a unique decomposition lemma such as \reflemma{las-unique-dec} with respect to right contexts, and, accordingly, a notion of \emph{right Lassen similarity}---let us denote it with $\leqrenf$. It turns out that $\leqenf$ and $\leqrenf$ are different, incomparable similarities. For instance, $\Omega$ and $\Omega (\var\var)$ are enf bisimilar (because they are both $\tolw$-divergent) but not renf bisimilar, because $\leqrenf$ stops on $\Omega (\var\var)$ which is $\torw$ normal. Similarly, $\Omega$ and $\var\var\Omega $ are not enf bisimilar while they are renf bisimilar.

Replacing left reduction with weak reduction is instead problematic for another reason. Since $\tow$ is non-deterministic, the unique decomposition lemma (\reflemma{las-unique-dec}) fails for it. It is not clear then what would be the right definition of weak enf similarity, as the stop-and-go clause can be generalized in more than one way. An appropriate definition for weak enf similarity, as a generalization, should include terms related by enf similarity. However, it is also unclear (to us) how to prove the compatibility of some of such generalizations (we tried but failed\footnote{The definitions we can come up with for weak enf similarities that could be compatible are not able to relate as much terms as enf similarity does.}). 

The next paragraphs discuss the principles that are (in)validated by enf similarity.


\paragraph{$\beta_v$-Conversion}\cadr{
From the definition of $\leqenf$, it immediately follows that enf bisimilarity contains the $\rtobv$ root rule, that is, that if $\tm \rtobv \tmtwo$ then $\tm\eqenf \tmtwo$, simply because $\tm$ and $\tmtwo$ have the same left normal form. Since $\eqenf$ is a compatible equivalence relation, it turns out that $\eqenf$ contains the whole of $\betav$-conversion $=_{\betav}$, thus it contains left reduction as well as weak and right reductions.}{As for naive similarity, enf similarity contains $\beta_v$-conversion, thus it contains left reduction as well as weak and right reductions.}

\begin{proposition}[$\betav$-conversion is validated by enf bisimilarity]
If $\tm =_{\betav} \tmtwo$ then $\tm \eqenf \tmtwo$.
\end{proposition}

\paragraph{Curry and Turing fix-Point Combinators are Enf Bisimilar.} \cadr{It is easy to check that the relation $\relsym$ proving the naive similarity of Curry's and Turing's \cbv fix-point combinators is also a \enf bisimulation.}{The relation $\relsym$ proving that $\curryfix \eqncbv \turingfix$ is not an enf bisimulation. Nonetheless, it is easy to build an enf bisimulation that relates Curry's and Turing's \cbv fix-point combinators.} The fact that those combinators are naive bisimilar means that the \emph{\cadr{unstacking}{unstucking}} aspect of the stop-and-go clause plays no role for their equivalence. 

\begin{proposition}
$\curryfix \eqenf \turingfix$, that is, Curry's and Turing's fix-points are enf bisimilar.
\end{proposition}

\paragraph{$\Omega$-Equivalence} Enf bisimilarity does not validate the $\Omega$-equivalence $\equivomv$. For instance, the same counter-example used for naive similarity works for enf, as we have $\Omega \leqenf \Omega^L$ but $\Omega^L \not\leqenf \Omega$. In fact, $\eqenf$ equates some $\Omega$-terms that are separated by $\eqncbv$ and vice-versa. For instance, let $\delta_3 \defeq \la\var\var\var\var$. The $\Omega$-term $\Omega_3 \defeq \delta_3\delta_3$ is divergent. We have that $\Omega^L_3 \defeq (\la\var\delta_3)(\vartwo\varthree)\delta_3$ is enf bisimilar to $\Omega^L$, because they stop similarly and then both go to diverge. They are instead unrelated with respect to $\leqncbv$, because when compared as normal forms they do not have the same structure. For the vice-versa, consider $\var\var\Omega$ and $\Omega$, which are equated by $\eqncbv$ but separated by $\eqenf$, because $\var\var\Omega$ is left normal but weak divergent. 

\begin{proposition}
Enf bisimilarity does not validate $\Omega$-equivalence $\equivomv$.
\end{proposition}

 The issue of enf with $\equivomv$ concerns clause (enf 1), as left diverging terms are a strict subset of \cbv $\Omega$-terms. To solve it, as usual, there are two options, changing the calculus or the nf-bisimilarity. 
 \citet{DBLP:conf/fossacs/BiernackiLP19} change the nf-bisimilarity, extending (enf 1) to all \emph{deferred diverging terms}, which correspond exactly to their (\cbv+ state) $\Omega$-terms. Their approach does not address the reason why $\Omega$-terms are not equated (namely, the stuck normal forms of Plotkin's \cbv), it only circumvents it, and it does not help when that \cadr{reasons}{reason} affects other aspects such as commuting $\letexp$s (which happens when one of the two $\letexp$s is blocked deep under a stuck redex). Addressing the reason and removing stuck normal forms amounts in fact to \cadr{change}{changing} the calculus. In \refsect{net}, we shall introduce a nf-bisimilarity smoothly validating both $\equivomv$ and commuting $\letexp$s, as it is built on an extension of Plotkin's calculus not suffering from stuck normal forms.


\paragraph{Further Equivalences.} The next proposition sums up the benchmarks for enf.
\begin{toappendix}
\begin{proposition}
\label{prop:enf-validation-of-equivalences}
Enf bisimilarity validates Moggi's equivalences, the left-to-right restrictions of the proof nets equivalences, but it does not validate $\etav$, all of the unrestricted proof nets equivalences, nor \cbn duplication.
\end{proposition}
\end{toappendix}
 Enf similarity does not validate $\etav$, since $\var$ and $\la\vartwo\var\vartwo$ are handled by different clauses in the definition of $\leqenf$. It can however be adapted to validate $\etav$, see \cite{LassenEnf,lassen+strovring-bisimilarity-eta,DBLP:journals/lmcs/BiernackiLP19}. 
About Moggi's equivalences, we have already discussed the left identity. Enf similarity validates all the other ones. Note that in \citeyearpar{LassenEnf} \citeauthor{LassenEnf} claims that enf validates $\equiv_{exrad}$ \adr{(defined in \refsect{benchmarks}) }which is actually false, it only validates $\equiv_{rad}$ (in fact $\equiv_{exrad}$ does not correspond to Moggi's usual right decomposition rule, it shall be motivated by proof nets in \refsect{benchmarks-vsc}). Proofs of the validations are easy, one only needs to write the right relation (the identity relation $\cup$ the equivalence to validate) and show that it is indeed an \enf bisimulation.


The validation of the left-to-right restricted versions of the proof nets equivalences ($\equivsone$ and a restricted version of $\equivexsthree$) is an easy contribution of this paper. 
Simple inspections show that enf does not validate the (order-unspecified) proof nets equivalences $\equivexsthree$ and $\equivcom$, nor \cbn duplication. Consider now renf bisimilarity, the right variant of enf. With respect to proof nets equivalences, it has a sort of dual behavior: it  does not validate $\equivsone$ but instead validates the right-to-left proof nets equivalences ($\equivexsthree$ and a restricted version of $\equivsone$).
