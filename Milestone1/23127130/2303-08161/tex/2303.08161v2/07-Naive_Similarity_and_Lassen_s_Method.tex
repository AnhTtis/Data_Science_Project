% !TEX root = ../main.tex

\section{Compatibility and Lassen's method for naive bisimilarity}
\label{sect:naive-compatibility}
In this section, we prove compatibility for the naive bisimilarity introduced in the previous section. The aim is to provide a gentle introduction to \citeauthor{lassen1999bisimulation}'s variant \citeyearpar{lassen1999bisimulation} of Howe's method \cite{Howe1996method,DBLP:books/cu/12/Pitts12} for proving the compatibility of similarities, and to delay some of the technicalities that we shall need to address for the similarity we are really interested in.

We prove compatibility for weak naive similarity, but the proof technique easily adapts to left and right naive similarity.

\paragraph{From Small-Step to Big-Step.} Nf-similarities look at normal forms, and the crucial proof in Howe's method proceeds by induction on a big-step formulation of evaluation, where \emph{big-step} means that it relates a terminating term directly with its normal form, hiding the intermediate steps. Therefore, we need to reformulate the small-step reduction $\tm\tow^k\ntm$ where $\ntm$ is $\tow$-normal, in a big-step manner as $\tm \bsws \ntm$. 

For the technical development, we need to keep the information about the number $k$ of small steps, that is, we shall rather write $\tm \bsw k \ntm$. Such a quantitative information is needed both to prove the equivalence with small-step evaluation and for the crucial proof in the method. 

\begin{definition}[Big-step weak evaluation $\bsws$]
The big-step weak evaluation predicate $\tm \bsw k \ntm$, read \emph{$\tm$ (weak)-converges in $k$ steps to  a normal form $\ntm$}, is defined as follows.
\begin{center}
	\input{figures/weak-big-step}
\end{center}
\end{definition}

Notation: $\tm \bsws \ntm$ abbreviates \emph{there exists a $k$ such that $\tm \bsw k \ntm$}.
\begin{toappendix}
\begin{proposition}[Equivalence of small-step and big-step in weak]
	\label{l:ss-bs-equivalence_weak}
	$\tm \bsw k \ntm$ if and only if $\tm \tow^k \ntm$ with $\ntm$ normal.
\end{proposition}
\end{toappendix}
%\begin{proof}
%	Full proof is detailed in the Appendix \ref{proof:proof-completeness-big-step-vsc-practical}.
%	
%	During this internship we developed two proofs of this proposition: one which is direct (that requires a double induction and is quite long) and one which is based on a complete subreduction which is closer to the big-step system approach. In the appendix we detail the second one, introducing a complete subreduction which has the same normal forms as $\tovsc$ and follows the same thinking as the big-step system.
%	
%\end{proof}
Let us stress an important point. We recall that $\tow$ is non-deterministic but diamond. The diamond property is here crucial, in order to make sense---at the big-step level---of the number of steps $k$, which for a diamond reduction does not depend on the reduction path to normal form.

\ignore{DELETE, not needed
\begin{toappendix}
	\begin{lemma}
		\label{l:grammar-nf-weak-cbv}
	$\tm$ is $\tow$-normal if and only if there exists $\ntm$, given by the following grammar, $\tm = \ntm$.
	\begin{center}
		$\begin{array}{r@{\hspace{.5cm}}rlll}
		\textsc{Inert terms}  &
		\itm,\itmtwo & \grameq &  \var\val \mid \val\itm \mid \itm\ntm
		\\
		{\tow}\textsc{-normal forms}  &
		\ntm,\ntmtwo & \grameq &  \val \mid \itm
		\end{array}
		$\end{center}
\end{lemma}
\end{toappendix}

		
	\paragraph{Making Inert Terms Explicit in the Clauses.} Case (nai 4) in the definition of naive simulations can be refined according to the grammar of weak normal forms: for normal forms of the shape $\ntmONE\ntmTWO$, there are three different possibilities, $\var\val$, $\val\itm$ or $\itm\ntm$.  The clause can then be equivalently replaced by the three different following clauses.
	\begin{center}
		$\begin{array}{r@{\hspace{.3cm}}r@{\hspace{.3cm}}l@{\hspace{.3cm}}l@{\hspace{.3cm}}lll}
		\text{(nai 4a)} & \tm \bsws \var\val &\textit{and}& \tmp \bsws \var\valtwo
		& \textit{with} ~ \val \rel \valtwo
		\\
		\text{(nai 4b)} & \tm \bsws \val\itm &\textit{and}& \tmp \bsws \valtwo\itmtwo
		& \textit{with} ~ \val \rel \valtwo ~\textit{and}~ \itm \rel \itmtwo
		\\
			\text{(nai 4c)} & \tm \bsws \itm \ntm &\textit{and}& \tmp \bsws \itmtwo \ntmtwo 
		& \textit{with} ~ \itm \rel \itmtwo ~\textit{and}~ \ntm \rel \ntmtwo
		\end{array}
		$\end{center}}
	
\paragraph{(Howe-)Lassen's Method} Proving that a behavioral preorder $\precsim$ is compatible often cannot be done directly, that is, just by induction on the contextual closure. The idea of Howe's method is that, instead of proving compatibility of $\precsim$, one introduces a derived preorder $\howeop\precsim$ where the compatible closure is enforced in the definition, and then proves that $\precsim$ and $\howeop\precsim$ coincide. \citeauthor{Howe1996method} introduced his method \citeyearpar{Howe1996method} to deal with \emph{applicative} similarities, \citeauthor{lassen1999bisimulation} adapted it \citeyearpar{lassen1999bisimulation} for \emph{normal form} similarities. The general idea is the same, but Lassen considers a different closure operation $\lassenop\precsim$.

\paragraph{Lassen's Closure.} The difficulty in proving directly that a similarity $\precsim$ is compatible comes from the applicative contextual closure, which may introduce a $\beta$-redex (when applying an abstraction to a term), that in turn can substitute over $\precsim$-related terms. The idea is to define the preorder $\lassenop\precsim$ as the compatible, substitutive, and reflexive closure of $\precsim$. 
%In the case of naive similarity, the definition of Lassen's closure needs an additional rule ($\scesub$) for the contextual closure with respect to ES.

\begin{definition}[Lassen closure]
The \emph{Lassen closure} $\lasrelsym$ of a relation $\relsym$ on terms is given by:
	\begin{center}
		\input{figures/RSC-lassen-for-naive}		
	\end{center}
\end{definition}
Note rule ($\scsub$): only values can be substituted, as this is Call-by-Value's mantra.

\paragraph{Lassen's Closure Preserves Simulations} The proof of equivalence of $\leqncbv$ and $\lassenop\leqncbv$ reduces to proving that the closure operator $\lassenop\cdot$ preserves $\leqncbv$ simulations, that is, that $\lassenop\relsym$ is a naive simulation if $\relsym$ is---it is often referred to as the \emph{main lemma} of the method. The proof is delicate and rests on two key intermediate properties. The first one concerns the evaluation level, and, when expressed at the big-step level, it is a sort of factorization property with respect to meta-level substitutions. In fact, it is nothing else but the substitutivity of small-step evaluation, rephrased at the big-step level.

\begin{proposition}[Small-step substitutivity]
	\label{l:stability_weak}
	If $\tm\tow\tmp$ then $\tm\isubst\val\var \tow \tmp\isubst\val\var$
\end{proposition}

\begin{proof}
	By induction on $\tm\tow\tmp$ (induction on contexts).
\end{proof}


\begin{lemma}[Big-step substitutivity]
	\label{l:splitting_weak}
	If $\tm\isubst\val\var \bsw k \ntm$ then there exist $k'$ and $\ntmtwo$ such that $ \tm \bsw {k'} \ntmtwo$ and $\ntmtwo\isubst\val\var\bsw {k-k'} \ntm$.
\end{lemma}

\begin{proof}
If  $\tm\isubst\val\var \bsw k \ntm$, then $ \tm \bsws \ntmtwo$ because if $\tm$ diverges then $\tm\isubst\val\var$ diverges as well by substitutivity of $\tow$ {(\reflemma{stability_weak})}.
	Then there exists $k'$ such that $\tm \bsw {k'} \ntmtwo$. Note that by substitutivity we have $ \tm\isubst\val\var \tow^{k'} \ntmtwo\isubst\val\var$, and so $\ntmtwo\isubst\val\var\bsw {k-k'} \ntm$ because the reduction is diamond, hence all normalizing reduction sequences have the same length.
\end{proof}

%\begin{lemma}[Big-step substitutivity of $\bswsym$]
%	\label{l:splitting_vsc}
%	Forall $\tm,\val$,
%	$\tm\isubst\val\var \bsw k \ntm \iff 
%	\exists k',\ntmtwo$ s.t. $ \tm \bsw {k'} \ntmtwo$ and $\ntmtwo\isubst\val\var\bsw {k-k'} \ntm$
%\end{lemma}
%
%\begin{proof}
%	$(\Rightarrow)$ Suppose $\tm\isubst\val\var \bsw k \ntm$, then $ \tm \bsws \ntmtwo$ because if it diverges then $\tm\isubst\val\var$ diverges as well by substitutivity of $\tow$ {(\reflemma{stability_vsc})}.
%	Then there exists $k'$ such that $\tm \bsw {k'} \ntmtwo$. Note that by substitutivity we have $ \tm\isubst\val\var \tow^{k'} \ntmtwo\isubst\val\var$, and so $\ntmtwo\isubst\val\var\bsw {k-k'} \ntm$ because the reduction is diamond, hence all normalizing reduction sequences have the same length.
%	
%	$(\Leftarrow)$ Suppose $ \tm \bsw {k'} \ntmtwo$ and $\ntmtwo\isubst\val\var\bsw {k-k'} \ntm$.
%	By substitutivity {(\reflemma{stability_vsc})}, $ \tm\isubst\val\var \tow^{k'} \ntmtwo\isubst\val\var\tow^{k-k'}\ntm$. Then  $\tm\isubst\val\var \bsw k \ntm$ by the equivalence of big-step and small-step evaluation ({\reflemma{ss-bs-equivalence_vsc}}).
%\end{proof}


%\paragraph{$\lasrel$ and $\lasrelncbv$ are equivalent on normal forms}
%The result for all terms is close to what we are trying to prove for the main naive lemma we are trying to prove. Proving the equivalence for on normal forms will help for the proof.
%
%
%\begin{lemma}[Main naive Lemma]
%	\label{l:main-lemma-bis_vsc}
%	If $\relsym$ is a naive simulation then
%	
%	$\tmrone\lasrel\tmrtwo, ~ \tmrone \bsw k \ntm \Rightarrow \tmrtwo\bsws \ntmtwo$ and $\ntm \lasrel \ntmtwo$
%	
%\end{lemma}

The second key intermediate property is the coherence of naive simulations with respect to reduction and substitution.
\begin{toappendix}
\begin{proposition}[{Coherence of simulation, reduction, and substitution}]
\label{prop:ncbv-coherence}
Let $\rel$ be a naive simulation, $\ntm \lasrelncbv \ntmtwo$, and $\val\lasrelncbv\valtwo$.
\begin{enumerate}
\item \emph{Normal forms}: if $\ntm\isub\var\val$ is $\tow$-normal then $\ntmtwo\isub\var\valtwo$ is $\tow$-normal and\\ $\ntm\isub\var\val \lasrelncbv \ntmtwo\isub\var\valtwo$.
\item \emph{Steps}: if $\ntm\isub\var{\val} \tow \tm$
	then $\ntmtwo\isub\var{\valtwo}  \tow \tmtwo$ and $\tm \lasrel \tmtwo$.
\end{enumerate}
\end{proposition}
\end{toappendix}
{Note that the second point has $\lasrel$ rather than $\lasrelncbv$ in the conclusion. This is because in general $\tm$ and $\tmtwo$ are not normal. In the proof of the next proposition, it is shown that the normal forms of $\tm$ and $\tmtwo$ are in fact $\lasrelncbv$-related.}

We can now prove the crucial property of Lassen's closure.
\begin{toappendix}
\begin{proposition}
	\label{prop:main-lemma_naive}
		Let $\relsym$ be a naive simulation.
		\begin{enumerate}
		\item \emph{Technical auxiliary statement}: if $\tmrone\lasrel\tmrtwo$ and $\tmrone \bsw k \ntm$ then $\tmrtwo\bsws \ntmtwo$ and $\ntm \lasrelncbv \ntmtwo$.		
		\item \emph{Lassen's closure preserves naive simulations}:  $\lassenop\relsym$ is a naive simulation.
		\end{enumerate}
\end{proposition}
\end{toappendix}
\begin{proof} 
	\hfill
	\begin{enumerate}
	\item \emph{Sketch} (complete proof in Appendix \ref{chapter:proof-compatibility-naive} of the additional material on HotCRP):	by induction on $(k,d)$ where $d$ is the size of the derivation of $\tmrone \lasrel \tmrtwo$. We proceed by case analysis on the last rule of the derivation $\tmrone \lasrel \tmrtwo$. Cases ($\sclift$), ($\scvar$), and ($\scabs$) are immediate by definition. Case ($\scapp$) relies on a second case analysis (on the last rule of the $\tmrone \bsw k \ntm$ derivation). The sub-cases are routine and may depend on the ($\scsub$) rule. Case ($\scsub$) is the core of the proof. It starts by applying big-step substitutivity (\reflemma{splitting_weak}) to $\tmrone = \tm\isub\var\val$ and then, depending on whether the obtained $\ntmtwo\isubst\val\var$ is normal, it applies the corresponding coherence property of naive simulations with respect to evaluation (\refprop{ncbv-coherence}).
	\item Unfolding the statement one obtains exactly the statement of point 1.\qedhere
	\end{enumerate}
\end{proof}
Finally, we can use the preservation property to prove the redundancy of the closure, from which the compatibility and the soundness of naive similarity follows.
\begin{theorem}[Compatibility and soundness of $\leqncbv$]
	\hfill
	\begin{enumerate}
	\item \emph{Redundancy of Lassen's closure}: $\leqncbv \,= \lassenop \leqncbv$.
	\item Naive similarity is compatible and included in the \cbv contextual preorder $\leqcv$.
	\end{enumerate}
\end{theorem}

\begin{proof}
\hfill
\begin{enumerate}
\item By construction of $\lassenop\ctxhole$, $\leqncbv \subseteq \lassenop\leqncbv$ (by rule $\sclift$). Preservation of naive simulations by Lassen's closure (\refprop{main-lemma_naive}) and the fact that $\leqncbv$ is a naive simulation give that $\lassenop\leqncbv$ is a naive simulation. By definition, $\leqncbv$ is the maximal naive simulation hence $\lassenop\leqncbv \subseteq \leqncbv$. 
\item Compatibility follows from point 1, because $\lassenop\leqncbv$ is compatible by definition. Inclusion in $\eqcv$ follows by \refprop{congruence-included-contextual-equivalence} and by adequacy of $\leqncbv$, which is trivial.\qedhere
\end{enumerate}
\end{proof}
