\begin{algorithm}
\footnotesize
    \caption{$k$-SALSA}
    \label{alg:overall}
    \textbf{Input:} Private dataset $X=(x_1,\dots,x_n)$, auxiliary dataset $X_0$ for GAN model training, integer $k>1$ (assume $n = mk$ for integer $m$ without loss of generality), number of iterations $T$, loss ratio parameter $\lambda$ \\
    \textbf{Output:} Synthetic dataset $\tilde{X}$ of size $m$ with $k$-anonymity

    \begin{algorithmic}[1]
        \State Train a GAN generator $G$ and a GAN inversion encoder $E$ on $X_0$
        \State Obtain latent code $w_i = E(x_i)$ for each $i\in [n]$ and let $W=\{w_i\}_{i=1}^n$
        \State $(C_1,\dots,C_m)= \textsf{SameSizeClustering}(W, k)$  \Comment{$C_j\subset W$, $|C_j|=k$, $|C_j\cap C_{j'\neq j}|=0$, $\forall j$}
      
        \State Initialize $\tilde{X} = \emptyset$
        \For {each cluster $j\in [m]$}
        \State Let $C_j = (w_1',\dots,w_k')$, and $x_i'$ the original image of $w_i'$ for each $i$
        \State Compute $w_0 = \frac{1}{k} \sum_{i=1}^{k} w'_i$ and generate $x_0 = G(w_0)$
        \State Initialize $w_\text{avg}^{(0)} = w_0$
        \For {each iteration $t \in [T]$}
            \State Generate $x_\text{avg}^{(t-1)} = G(w_\text{avg}^{(t-1)})$
            \State Compute content loss $\mathcal{L}_\text{content}(x_0, x_\text{avg}^{(t-1)})$ using Eq.~\ref{eq:loss-content} 
            \State Compute local style alignment loss $\mathcal{L}_\text{style}((x'_1,\dots,x'_k), x_\text{avg}^{(t-1)})$ using Eq.~\ref{eq:loss-style}
            \State Compute total loss $\mathcal{L}_\text{total}=\lambda \mathcal{L}_\text{content}+(1-\lambda)\mathcal{L}_\text{style}$
            \State Update $w_{\text{avg}}^{(t)}$ using $w_{\text{avg}}^{(t-1)}$ and the gradient $\nabla_{w_\text{avg}^{(t-1)}} \mathcal{L}_\text{total}$
        \EndFor
        \State Add $G(w_{\text{avg}}^{(T)})$ to $\tilde{X}$
        \EndFor
    \State    \Return $\tilde{X}$

    \end{algorithmic}
\end{algorithm}
