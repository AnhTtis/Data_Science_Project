\makeatletter
\makeatother

\SetKwComment{Comment}{/* }{ */}

\SetArgSty{textnormal}

\begin{algorithm}
    \small
    \SetAlgoLined
    \DontPrintSemicolon
    \SetKwInput{KwInput}{Given}
    \KwInput{
    \begin{itemize}
        \item Target BD, Observations, Actions:  $BD, O, A$
        \item Causal Transformer model (GPT) $Transformer$
        \item Embedding layers for each modality: $E_{BD}, E_O, E_A$
        \item Time step embedding layer $E_t$
        \item Linear action prediction layer $Pred_A$
        \item Episode length $T$
    \end{itemize}
    }
    
    \texttt{\\}
    \tcp{QDT model}
    \textbf{def} $QDT(BD, O, A, t)$:\;
        \Indp \tcp{Compute inputs embeddings}
        timestep\_emb = $E_t(t)$\;
        BD\_emb = $E_{BD}(BD) + $ timestep\_emb\;
        O\_emb = $E_O(O) + $ timestep\_emb\;
        A\_emb = $E_A(A) + $ timestep\_emb\;

        %\texttt{\\}
        \tcp{Interleave inputs as $(BD, O_1, A_1 , ... , BD, O_T)$}
        inputs\_emb = interleave(BD\_emb, O\_emb, A\_emb)
   
        %\texttt{\\}
        \tcp{Use the transformer to process inputs}
        hidden\_states = $Transformer$(inputs\_emb)

        %\texttt{\\}
        \tcp{Predict actions}
        return $Pred_A$(hidden\_states)

    \texttt{\\}
    \Indm \tcp{Training loop}
    \tcp{Dims: (batch\_size, $T$ , dim)}
    \For{$(BD, O, A , t)$ \textbf{in} dataloader}{
    A\_preds = $QDT(BD, O, A, t)$\;
    loss = mean((A\_preds - A)**2)\;
    optimizer.zero\_grad(); loss.backward(); optimizer.step()
    }

    \texttt{\\}
    \tcp{Evaluation loop (autoregressive generation)}
    $BD$ = generate\_target\_BD( )\;
    $BD, O, A, t,$ done = [$BD$], [env.reset( )], [ ], [$1$] , False\;
    \While{not done}{
        \tcp{Sample next action}
        action = $QDT(BD, O, A, t)$[$t$]\;
        new\_O, done = env.step(action)\;
        \tcp{Append new elements to sequence}
        $BD = BD +$[$BD$]\;
        $O, A, t$ = $O$+[new\_O], $A$+[action] , $t$+[len($BD$)]
        

    }    

    \caption{Quality-Diversity Transformer}
    \label{alg:QDT}
\end{algorithm}