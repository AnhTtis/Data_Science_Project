
% hack for fixing ``Too many math alphabets used in version normal.''
% error on pdfLaTeX
% cf. https://tex.stackexchange.com/a/243541/91665
\newcommand{\hmmax}{0}
\newcommand{\bmmax}{0}
\usepackage{amssymb}

\usepackage{amsmath,amsthm}
\usepackage{mathtools}
\usepackage{iftex}

% Math and main text font nonsense
\ifxetex
  \usepackage{microtype}
  \usepackage{unicode-math}
  \setmathfont{STIXTwoMath-Regular.otf}
  %\setmainfont[
  %  BoldFont={STIXTwoText-Bold.otf}, 
  %  ItalicFont={STIXTwoText-Italic.otf},
  %  BoldItalicFont={STIXTwoText-BoldItalic.otf}]{STIXTwoText-Regular.otf}
  \setmainfont{Times New Roman}

  %% \setmathfont{TeX Gyre Schola Math}
  %% %%% Scale down!
  %% \setmathfont[range=\mathit/greek,Scale=.8]{TeX Gyre Schola Math}
  %% %%% Circumvent a bug in unicode-math
  %% \setmathfont[range=\int]{TeX Gyre Schola Math}

  %\setmainfont{TeX Gyre Schola}[Scale=0.93] % Text
  % Math: mix of Erewhon and Schola
  %% \setmathfont{Erewhon Math}
  %% \setmathfont{TeX Gyre Schola Math}[Scale=0.93,
  %%    range={up/{latin,Latin,num}, it/{latin,Latin,num},
  %%           bfup/{latin,Latin,num}, bfit/{latin,Latin,num}}]

  \newcommand{\mathmat}[1]{\mathbfit{#1}}
  \newcommand{\mathvec}[1]{\mathbfit{#1}}
  \newcommand{\mathvecgreek}[1]{\mathbfit{#1}}
  \newcommand{\mathmatgreek}[1]{\mathbfit{#1}}
  
  \newcommand{\boldupright}[1]{\symbfup{#1}}

  \newcommand{\mathrv}[1]{\mathsfit{#1}}
  \newcommand{\mathrvvec}[1]{\mathbfsfit{#1}}
  \newcommand{\mathrvgreek}[1]{\mathsfit{#1}}
  \newcommand{\mathrvvecgreek}[1]{\mathbfsfit{#1}}
  \usepackage{fontspec}
\else
  \usepackage[notext,lcgreekalpha]{stix2}
  \usepackage{times}
  \usepackage{textcomp}

  \newcommand{\mathmat}[1]{\mathbfit{#1}}
  \newcommand{\mathvec}[1]{\mathbfit{#1}}
  \newcommand{\mathvecgreek}[1]{\mathbfit{#1}}
  \newcommand{\mathmatgreek}[1]{\mathbfit{#1}}
  
  \newcommand{\boldupright}[1]{\mathbf{#1}}

  \newcommand{\mathrv}[1]{\mathsfit{#1}}
  \newcommand{\mathrvvec}[1]{\mathbfsfit{#1}}
  \newcommand{\mathrvgreek}[1]{\mathsfit{#1}}
  \newcommand{\mathrvvecgreek}[1]{\mathbfsfit{#1}}
\fi

\usepackage[backgroundcolor=blue!20!white,bordercolor=white]{todonotes}
\newcommand\todoerror[2][]{\todo[backgroundcolor=red,textcolor=white,caption={2do},#1]{#2}}

\usepackage{booktabs,threeparttable,arydshln}
\usepackage{multirow}
\usepackage{nicematrix}

\usepackage[algo2e, ruled]{algorithm2e}

\usepackage{pgfplots}
\pgfkeys{/pgfplots/tuftelike/.style={
  semithick,
  tick style={major tick length=3pt,minor tick length=1.5pt,semithick,black},
  xtick align=outside,
  ytick align=outside,
  separate axis lines,
  axis x line*=bottom,
  axis x line shift=3pt,
  axis y line*=left,
  axis y line shift=3pt,
  }
  }
  
\usepackage{proof-at-the-end}

\declaretheoremstyle[
    %spaceabove=0\topsep,
    %spacebelow=0\topsep,
    bodyfont=\normalfont\itshape,
]{theoremsty}

\declaretheorem[name=Theorem,    style=theoremsty]{theorem}
\declaretheorem[name=Theorem,    style=theoremsty]{framedtheorem}
\declaretheorem[name=Proposition,style=theoremsty]{proposition}
\declaretheorem[name=Corollary,  style=theoremsty]{corollary}
\declaretheorem[name=Lemma,      style=theoremsty]{lemma}
\declaretheorem[name=Theorem,    style=theoremsty, numbered=no]{theorem*}
\declaretheorem[name=Proposition,style=theoremsty, numbered=no]{proposition*}
\declaretheorem[name=Corollary,  style=theoremsty, numbered=no]{corollary*}
\declaretheorem[name=Lemma,      style=theoremsty, numbered=no]{lemma*}

\declaretheoremstyle[
    %spaceabove=0\topsep,
    %spacebelow=0\topsep,
    bodyfont=\normalfont,
]{normalsty}
\declaretheorem[name=Remark,    style=normalsty]{remark}
\declaretheorem[name=Definition,style=normalsty]{definition}
\declaretheorem[name=Assumption,style=normalsty]{assumption}
\declaretheorem[name=Remark,    style=normalsty, numbered=no]{remark*}
\declaretheorem[name=Definition,style=normalsty, numbered=no]{definition*}
\declaretheorem[name=Assumption,style=normalsty, numbered=no]{assumption*}

\newenvironment{proofsketch}{%
  \renewcommand{\proofname}{Proof Sketch}\proof%
  \renewcommand{\qedsymbol}{}%
  }{\endproof}

\usepackage[many]{tcolorbox}
%\newtheorem{framedtheorem}{Theorem}[section]
\tcolorboxenvironment{framedtheorem}{
  colback=blue!5!white,
  boxrule=0pt,
  boxsep=1pt,
  left=2pt,right=2pt,top=2pt,bottom=2pt,
  %borderline west={2pt}{0pt}{blue!75!black},
  oversize=2pt,
  sharp corners,
  before skip=\topsep,
  after skip=\topsep,
}

\usepackage{url}
\usepackage[bookmarksopen=true,bookmarks=true,colorlinks=true,backref=page]{hyperref}
% \usepackage{hyperref}
\usepackage[noabbrev, capitalise, nameinlink]{cleveref}

\renewcommand*{\backref}[1]{}
\renewcommand*{\backrefalt}[4]{({\footnotesize%
    \ifcase #1 Not cited.%
          \or page~#2%
          \else pages #2%
    \fi%
    })}
\renewcommand*{\backreftwosep}{\backrefsep}
\renewcommand*{\backreflastsep}{\backrefsep}  

\definecolor{linkcolor}{HTML}{005D5D}
\definecolor{citecolor}{HTML}{00539A}
\hypersetup{colorlinks={true},linkcolor=linkcolor,citecolor=citecolor}

\crefname{assumption}{Assumption}{Assumption}

\newtheorem{subassumption}{Assumption\normalfont}[assumption]
\renewcommand{\thesubassumption}{\theassumption\alph{subassumption}}

%% \newenvironment{assumption*}
%%  {\ifnum\value{subassumption}=0 \stepcounter{assumption}\fi\subassumption}
%%  {\endsubassumption}
%% \newenvironment{assumption+}[1]
%%  {\renewcommand{\thesubassumption}{#1}\subassumption}
%%  {\endsubassumption}

\crefname{framedtheorem}{Theorem}{Theorems}
\crefname{framedproposition}{Proposition}{Propositions}
\crefname{framedlemma}{Lemma}{Lemmas}

\makeatletter
\def\adl@drawiv#1#2#3{%
        \hskip.5\tabcolsep
        \xleaders#3{#2.5\@tempdimb #1{1}#2.5\@tempdimb}%
                #2\z@ plus1fil minus1fil\relax
        \hskip.5\tabcolsep}
\newcommand{\cdashlinelr}[1]{%
  \noalign{\vskip\aboverulesep
           \global\let\@dashdrawstore\adl@draw
           \global\let\adl@draw\adl@drawiv}
  \cdashline{#1}
  \noalign{\global\let\adl@draw\@dashdrawstore
           \vskip\belowrulesep}}
\makeatother

\pgfkeys{/prAtEnd/global custom defaults/.style={
    % proof at the end,
    end,
    restate,
    %debug,
    %% text link={\textit{Proof.} See page~\pageref{proof:prAtEnd\pratendcountercurrent} of the \textit{supplementary material}.},
    %text link={\textit{Proof.} The proof is in the \textit{supplementary material}.
    text proof={Proof},
    %text link section, 
    text link={\textit{Proof.} See the \hyperref[proof:prAtEnd\pratendcountercurrent]{\textit{full proof}} in~\cref{proof:prAtEnd\pratendcountercurrent}.}
  }
}

\def\code#1{\texttt{#1}}
\DeclareMathOperator*{\minimize}{minimize}
\DeclareMathOperator*{\maximize}{maximize}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min} 

\newcommand*\xbar[1]{%
  \hbox{%
    \vbox{%
      \hrule height 0.6pt % The actual bar
      \kern0.33ex%         % Distance between bar and symbol
      \hbox{%
        \kern-0.1em%      % Shortening on the left side
        \ensuremath{#1}%
        \kern-0.1em%      % Shortening on the right side
      }%
    }%
  }%
} 

\newcommand{\E}[1]{\mathbb{E}\left[ #1 \right]}
\newcommand{\Esub}[2]{\mathbb{E}_{#1}\left[ #2 \right]}
\newcommand{\V}[1]{\mathbb{V}\left[ #1 \right]}
\newcommand{\Vsub}[2]{\mathbb{V}_{#1}\left[ #2 \right]}
\newcommand{\Cov}[1]{\mathrm{Cov}\left( #1 \right)}
\newcommand{\Covsub}[2]{\mathrm{Cov}_{#1}\left( #2 \right)}
\newcommand{\Corr}[1]{\mathrm{Corr}\left( #1 \right)}

\newcommand{\Df}[2]{D_{f}(#1, #2)}
\newcommand{\DKL}[2]{D_{\mathrm{KL}}(#1, #2)}
\newcommand{\DChi}[2]{D_{\ch^2}(#1, #2)}
\newcommand{\norm}[1]{{\left\lVert #1 \right\rVert}}
\newcommand{\abs}[1]{{\left| #1 \right|}}
\newcommand{\DTV}[2]{{d_{\mathrm{TV}}\left(#1, #2\right)}}

\newcommand{\vX}{\mathrv{X}}
\newcommand{\vY}{\mathrv{Y}}
\newcommand{\vZ}{\mathrv{Z}}

\newcommand{\va}{\mathvec{a}}
\newcommand{\vb}{\mathvec{b}}
\newcommand{\vc}{\mathvec{c}}
\newcommand{\vd}{\mathvec{d}}
\newcommand{\ve}{\mathvec{e}}
\newcommand{\vf}{\mathvec{f}}
\newcommand{\vg}{\mathvec{g}}
\newcommand{\vh}{\mathvec{h}}
\newcommand{\vi}{\mathvec{i}}
\newcommand{\vj}{\mathvec{j}}
\newcommand{\vk}{\mathvec{k}}
\newcommand{\vl}{\mathvec{l}}
\newcommand{\vm}{\mathvec{m}}
\newcommand{\vn}{\mathvec{n}}
\newcommand{\vo}{\mathvec{o}}
\newcommand{\vp}{\mathvec{p}}
\newcommand{\vq}{\mathvec{q}}
\newcommand{\vr}{\mathvec{r}}
\newcommand{\vs}{\mathvec{s}}
\newcommand{\vt}{\mathvec{t}}
\newcommand{\vu}{\mathvec{u}}
\newcommand{\vv}{\mathvec{v}}
\newcommand{\vw}{\mathvec{w}}
\newcommand{\vx}{\mathvec{x}}
\newcommand{\vy}{\mathvec{y}}
\newcommand{\vz}{\mathvec{z}}
\newcommand{\valpha}{\mathvecgreek{\alpha}}
\newcommand{\veta}{\mathvecgreek{\eta}}
\newcommand{\vmu}{\mathvecgreek{\mu}}
\newcommand{\vtheta}{\mathvecgreek{\theta}}
\newcommand{\vlambda}{\mathvecgreek{\lambda}}
\newcommand{\vsigma}{\mathvecgreek{\sigma}}
\newcommand{\vgamma}{\mathvecgreek{\gamma}}
\newcommand{\vxi}{\mathvecgreek{\xi}}
\newcommand{\vzeta}{\mathvecgreek{\zeta}}

\newcommand{\rva}{\mathrv{a}}
\newcommand{\rvb}{\mathrv{b}}
\newcommand{\rvc}{\mathrv{c}}
\newcommand{\rvd}{\mathrv{d}}
\newcommand{\rve}{\mathrv{e}}
\newcommand{\rvf}{\mathrv{f}}
\newcommand{\rvg}{\mathrv{g}}
\newcommand{\rvh}{\mathrv{h}}
\newcommand{\rvi}{\mathrv{i}}
\newcommand{\rvj}{\mathrv{j}}
\newcommand{\rvk}{\mathrv{k}}
\newcommand{\rvl}{\mathrv{l}}
\newcommand{\rvm}{\mathrv{m}}
\newcommand{\rvn}{\mathrv{n}}
\newcommand{\rvo}{\mathrv{o}}
\newcommand{\rvp}{\mathrv{p}}
\newcommand{\rvq}{\mathrv{q}}
\newcommand{\rvr}{\mathrv{r}}
\newcommand{\rvs}{\mathrv{s}}
\newcommand{\rvt}{\mathrv{t}}
\newcommand{\rvu}{\mathrv{u}}
\newcommand{\rvv}{\mathrv{v}}
\newcommand{\rvw}{\mathrv{w}}
\newcommand{\rvx}{\mathrv{x}}
\newcommand{\rvy}{\mathrv{y}}
\newcommand{\rvz}{\mathrv{z}}
\newcommand{\rvA}{\mathrv{A}}
\newcommand{\rvB}{\mathrv{B}}
\newcommand{\rvC}{\mathrv{C}}
\newcommand{\rvD}{\mathrv{D}}
\newcommand{\rvE}{\mathrv{E}}
\newcommand{\rvF}{\mathrv{F}}
\newcommand{\rvG}{\mathrv{G}}
\newcommand{\rvH}{\mathrv{H}}
\newcommand{\rvI}{\mathrv{I}}
\newcommand{\rvJ}{\mathrv{J}}
\newcommand{\rvK}{\mathrv{K}}
\newcommand{\rvL}{\mathrv{L}}
\newcommand{\rvM}{\mathrv{M}}
\newcommand{\rvN}{\mathrv{N}}
\newcommand{\rvO}{\mathrv{O}}
\newcommand{\rvP}{\mathrv{P}}
\newcommand{\rvQ}{\mathrv{Q}}
\newcommand{\rvR}{\mathrv{R}}
\newcommand{\rvS}{\mathrv{S}}
\newcommand{\rvT}{\mathrv{T}}
\newcommand{\rvU}{\mathrv{U}}
\newcommand{\rvV}{\mathrv{V}}
\newcommand{\rvW}{\mathrv{W}}
\newcommand{\rvX}{\mathrv{X}}
\newcommand{\rvY}{\mathrv{Y}}
\newcommand{\rvZ}{\mathrv{Z}}
\newcommand{\rveta}{\mathrvgreek{\eta}}
\newcommand{\rvlambda}{\mathrvgreek{\lambda}}
\newcommand{\rvepsilon}{\mathrvgreek{\epsilon}}

\newcommand{\rvva}{\mathrvvec{a}}
\newcommand{\rvvb}{\mathrvvec{b}}
\newcommand{\rvvc}{\mathrvvec{c}}
\newcommand{\rvvd}{\mathrvvec{d}}
\newcommand{\rvve}{\mathrvvec{e}}
\newcommand{\rvvf}{\mathrvvec{f}}
\newcommand{\rvvg}{\mathrvvec{g}}
\newcommand{\rvvh}{\mathrvvec{h}}
\newcommand{\rvvi}{\mathrvvec{i}}
\newcommand{\rvvj}{\mathrvvec{j}}
\newcommand{\rvvk}{\mathrvvec{k}}
\newcommand{\rvvl}{\mathrvvec{l}}
\newcommand{\rvvm}{\mathrvvec{m}}
\newcommand{\rvvn}{\mathrvvec{n}}
\newcommand{\rvvo}{\mathrvvec{o}}
\newcommand{\rvvp}{\mathrvvec{p}}
\newcommand{\rvvq}{\mathrvvec{q}}
\newcommand{\rvvr}{\mathrvvec{r}}
\newcommand{\rvvs}{\mathrvvec{s}}
\newcommand{\rvvt}{\mathrvvec{t}}
\newcommand{\rvvu}{\mathrvvec{u}}
\newcommand{\rvvv}{\mathrvvec{v}}
\newcommand{\rvvw}{\mathrvvec{w}}
\newcommand{\rvvx}{\mathrvvec{x}}
\newcommand{\rvvy}{\mathrvvec{y}}
\newcommand{\rvvz}{\mathrvvec{z}}
\newcommand{\rvvlambda}{\mathrvvecgreek{\lambda}}
\newcommand{\rvveta}{\mathrvvecgreek{\eta}}
\newcommand{\rvvepsilon}{\mathrvvecgreek{\epsilon}}
\newcommand{\rvvzeta}{\mathrvvecgreek{\zeta}}

\newcommand{\mA}{\mathmat{A}}
\newcommand{\mB}{\mathmat{B}}
\newcommand{\mC}{\mathmat{C}}
\newcommand{\mD}{\mathmat{D}}
\newcommand{\mE}{\mathmat{E}}
\newcommand{\mF}{\mathmat{F}}
\newcommand{\mG}{\mathmat{G}}
\newcommand{\mH}{\mathmat{H}}
\newcommand{\mI}{\mathmat{I}}
\newcommand{\mJ}{\mathmat{J}}
\newcommand{\mK}{\mathmat{K}}
\newcommand{\mL}{\mathmat{L}}
\newcommand{\mM}{\mathmat{M}}
\newcommand{\mN}{\mathmat{N}}
\newcommand{\mO}{\mathmat{O}}
\newcommand{\mP}{\mathmat{P}}
\newcommand{\mQ}{\mathmat{Q}}
\newcommand{\mR}{\mathmat{R}}
\newcommand{\mS}{\mathmat{S}}
\newcommand{\mT}{\mathmat{T}}
\newcommand{\mU}{\mathmat{U}}
\newcommand{\mV}{\mathmat{V}}
\newcommand{\mW}{\mathmat{W}}
\newcommand{\mX}{\mathmat{X}}
\newcommand{\mY}{\mathmat{Y}}
\newcommand{\mZ}{\mathmat{Z}}
\newcommand{\mSigma}{\mathmatgreek{\Sigma}}
\newcommand{\mPhi}{\mathmatgreek{\Phi}}

\newcommand{\inner}[2]{\left\langle #1, #2 \right\rangle}
\newcommand{\ind}[1]{\mathds{1}_{#1}}

