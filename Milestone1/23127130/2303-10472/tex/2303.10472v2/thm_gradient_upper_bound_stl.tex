
  
\begin{theoremEnd}[\keylemmaproofoption,category=upperboundlemma]{lemma}\label{eq:lemma_stl_entropy_term_variance}
  Let \(V\) denote the expected squared norm of the derivative of \(\log \varphi\) such that \(
  V =
  \norm{
    \nabla \log \varphi\left( \vu \right)
  }_2^2.
  \)
  Then,
  \begin{align*}
    \mathbb{E} {\lVert
      \nabla \log q_{\gamma}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2
    \leq
    2 \, V \left( \mathrm{H}\left(\varphi\right) - \mathrm{H}\left(q_{\vlambda}\right) \right).
  \end{align*}
\end{theoremEnd}
\begin{proofEnd}
  \begin{alignat}{2}
    &\mathbb{E} {\lVert
      \nabla \log q_{\vgamma}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2 \, \Big\lvert_{\vgamma = \vlambda}
    \nonumber
    \\
    &\;=
    \mathbb{E} \norm{
      \frac{\partial}{\partial \vz}\left( \log \varphi\left( \mC^{-1}\left( \vz - \vm \right) \right) - \log \abs{\mC} \right)
    }_2^2 \, \Big\lvert_{\vz = \vt_{\vlambda}\left(\vu\right)}
    \nonumber
    \\
    &\;=
    \mathbb{E} {\lVert
      \mC^{-\top} \nabla \log \varphi\left( \mC^{-1}\left( \vt_{\vlambda}\left(\vu\right) - \vm \right) \right)
    \rVert}_2^2
    \nonumber
    \\
    &\;=
    \mathbb{E} {\lVert
      \mC^{-\top} \nabla \log \varphi\left( \vu \right)
    \rVert}_2^2
    \nonumber
    \\
    &\;\leq
    {\lVert
      \mC^{-\top}
    \rVert}^2_{2}
    \,
    \mathbb{E}
    {\lVert
       \nabla \log \varphi\left( \vu \right)
    \rVert}_2^2
    \nonumber
    \\
    &\;\leq
    {\lVert
      \mC^{-\top}
    \rVert}^2_{\mathrm{F}}
    \,
    \mathbb{E}
    {\lVert
       \nabla \log \varphi\left( \vu \right)
    \rVert}_2^2
    \nonumber
    \\
    &\;=
    V\,
    {\lVert
      \mC^{-1}
    \rVert}_{\mathrm{F}}^2
    \label{eq:lemma_stl_entropy_term_variance_eq1}
  \end{alignat}

  Now, for location-scale families, the entropy of \(q_{\vlambda}\) follows as
  \begin{alignat*}{2}
    \mathrm{H}\left(q_{\vlambda}\right) 
    &=
    \mathrm{H}\left(\varphi\right) 
    +
    \log \abs{\mC}
    \\
    &=
    \mathrm{H}\left(\varphi\right) 
    -
    \frac{1}{2}
    \log \abs{\mC^{-\top} \mC^{-1}}
    \\
    &=
    \mathrm{H}\left(\varphi\right) 
    -
    \frac{1}{2}
    \sum_{i=1}^d \log \sigma_i\left(\mC^{-\top} \mC^{-1}\right),
\shortintertext{and applying the inequality \(-x \leq -\log x\),}
    &\geq
    \mathrm{H}\left(\varphi\right) 
    -
    \frac{1}{2}
    \sum_{i=1}^d \sigma_i\left(\mC^{-\top} \mC^{-1}\right)
    \\
    &=
    \mathrm{H}\left(\varphi\right) 
    -
    \frac{1}{2}
    \mathrm{tr}\left(\mC^{-\top} \mC^{-1}\right)
    \\
    &=
    \mathrm{H}\left(\varphi\right) 
    -
    \frac{1}{2}
    {\lVert \mC^{-1} \rVert}_{\mathrm{F}}^2.
  \end{alignat*}

  Utilizing this in \cref{eq:lemma_stl_entropy_term_variance_eq1},
  \begin{alignat*}{2}
    \mathbb{E} {\lVert
      \nabla \log q_{\vgamma}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2 \, \Big\lvert_{\vgamma = \vlambda}
    &\leq
    V\,
    {\lVert
      \mC^{-1}
    \rVert}_{\mathrm{F}}^2
    \\
    &\leq
    2 \, V \left( \mathrm{H}\left(\varphi\right) - \mathrm{H}\left(q_{\vlambda}\right) \right).
  \end{alignat*}

  \todo[inline]{
    The following bound based on the trace might be tighter.
  \begin{alignat*}{2}
    &\mathbb{E} \norm{
      \mC^{-\top} \nabla \log \varphi\left( \vu \right)
    }_2^2
    \\
    &\;=
    \mathbb{E} \,
    \nabla \log \varphi^{\top}\left( \vu \right)
    \mC^{-1} \mC^{-\top}
    \nabla \log \varphi\left( \vu \right)
    \\
    &\;=
    \mathbb{E} \mathrm{tr}\left(
      \nabla \log \varphi^{\top}\left( \vu \right)
      \mC^{-1} \mC^{-\top}
      \nabla \log \varphi\left( \vu \right)
    \right)
    \\
    &\;=
    \mathrm{tr}\left(
    \mathbb{E} 
      \nabla \log \varphi\left( \vu \right)
      \nabla \log \varphi^{\top}\left( \vu \right)
      \mC^{-1} \mC^{-\top}
    \right).
  \end{alignat*}
  
  Notice that 
  \begin{align*}
    \mathbb{E} 
      \nabla \log \varphi\left( \vu \right)
      \nabla \log \varphi^{\top}\left( \vu \right)
  \end{align*}
  is in fact similar to a Fisher information matrix.
  (Here, the derivative is with respect to the input instead of the parameters.
  So this is technically not a Fisher information matrix.)
  We can use the information identity to see that
  \begin{align*}
    \mathbb{E} 
    \nabla \log \varphi\left( \vu \right)
    \nabla \log \varphi^{\top}\left( \vu \right)
    =
    \mH_{\log \varphi}.
  \end{align*}
  But since each component of \(\varphi\) is \(i.i.d.\), the Hessian matrix is a diagonal matrix.

  \begin{alignat*}{2}
    &\mathbb{E} {\lVert
      \nabla \log q_{\vgamma}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2 \, \Big\lvert_{\vgamma = \vlambda}
    \\
    &\;=
    \mathrm{tr}\left(
    \mathbb{E} 
      \nabla \log \varphi\left( \vu \right)
      \nabla \log \varphi^{\top}\left( \vu \right)
      \mC^{-1} \mC^{-\top}
    \right)
    \\
    &\;=
    \mathrm{tr}\left(
      \mH_{\log \varphi}
      \mC^{-1} \mC^{-\top}
    \right)
  \end{alignat*}
  If we assume some properties about \(\mH_{\log \varphi}\) then maybe?
  }
\end{proofEnd}

\begin{theoremEnd}[\theoremproofoption,category=upperboundtheoremstl]{theorem}
  Let \(f\) be a function satisfying \cref{assumption:L_smoothness,assumption:quadratic_growth}.
  Then, the variance of the \(M\)-sample gradient estimator is bounded below as
  \begin{align*}
    \mathbb{E}\norm{\rvvg\left(\vlambda\right)}_2^2
    \leq
    2 A \left( F\left(\vlambda\right) - F^* \right)
    + B \norm{ \nabla F\left(\vlambda\right) }_2^2
    + C,
  \end{align*}
  where \(F^* = \inf_{\vlambda \in \Lambda} F\left(\vlambda\right)\), for the finite constants
  \[
  A = \frac{L^2 \, \left(d + \kappa\right)}{M},\;
  B = \frac{M-1}{M},\;
  \;\text{and}\;
  C = \frac{L^2 \, \left(d + \kappa\right)}{K} F^*.
  \]
\end{theoremEnd}
\begin{proofsketch}
  We apply the Parallelogram Law 
  \[
  \norm{\va - \vb}_2^2 = 2 \, \norm{\va}^2_2 + 2\,\norm{\vb}^2_2 - \norm{\va + \vb}_2^2 \leq 2\,\norm{\va}^2_2 + 2\,\norm{\vb}^2_2
  \] as
  \begin{alignat*}{2}
    &\mathbb{E}{\lVert
      \nabla f\left(\vt_{\vlambda}\left(\vu\right)\right)
      - \nabla \log q_{\vgamma}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2
    \\
    &\,=
    2 \, \mathbb{E} \norm{
      \nabla f\left(\vt_{\vlambda}\left(\vu\right)\right)
    }
    +
    2 \, \mathbb{E} {\lVert
      \nabla \log q_{\vlambda}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2 
    \\
    &\quad-
    \underbrace{
    \mathbb{E}{\lVert
      \nabla f\left(\vt_{\vlambda}\left(\vu\right)\right) 
      +
      \nabla \log q_{\vgamma}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}^2_2
    }_{\text{control variate effect}}
    \\
    &\,\leq
    2 \, \mathbb{E} \norm{
      \nabla f\left(\vt_{\vlambda}\left(\vu\right)\right)
    }
    +
    2 \, \mathbb{E} {\lVert
      \nabla \log q_{\vlambda}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2.
  \end{alignat*}
  Note, that this step makes the bound looser than the ``regularized'' form estimator, which opposes the previous observation that the STL estimator achieves superior variance reduction in practice~\citep{roeder_sticking_2017, geffner_using_2018, agrawal_advances_2020}.

  This mismatch, however, is to be expected.
  The bounds we are establishing are ``worst case'' bounds, and the worst case performance of the STL estimator is known to be worse than the regularized form estimator.
  The advantage of the STL estimator is only realized when \(q_{\vlambda}\) and \(f\) becomes strongly correlated, acting as a control variate.
  In this case, the control variate effect appears as \(\norm{ \nabla_{\vlambda} f + \nabla_{\vlambda} \log q_{\vgamma} }\) being large, tightening the bound.
\end{proofsketch}
\begin{proofEnd}
  We first start from the definition of variance,
  \begin{alignat*}{2}
    &\mathbb{E} \norm{\vg_M }^2_2
    \\
    &\;=
    \mathrm{tr}\,\V{ \vg_M } + \norm{\mathbb{E} \vg}^2_2,
\shortintertext{following the definition in \cref{eq:def_gradient_M_est},}
    &\;=
    \mathrm{tr}\,\V{ \frac{1}{M} \sum_{m=1}^M \vg_m } + \norm{ \nabla F\left(\vlambda\right) }^2_2
\shortintertext{and then the definition in \cref{eq:def_gradient_m_est},}
    &\;=
    \mathrm{tr}\,\V{
      \frac{1}{M} \sum_{m=1}^M \frac{\partial }{\partial \vlambda} \Big( f\left(\vt_{\vlambda}\left(\rvvu_m\right)\right) - \log q_{\vgamma}\left(\vt_{\vlambda}\left(\rvvu_m\right) \right) \Big)
    } \Bigg\lvert_{\vgamma = \vlambda}
    \\
    &\;\quad+ \norm{ \nabla F\left(\vlambda\right) }^2_2,
\shortintertext{by the linearity of variance,}
    &\;=
    \frac{1}{M} \mathrm{tr}\,\V{
      \frac{\partial }{\partial \vlambda} \Big( f\left(\vt_{\vlambda}\left(\rvvu_m\right)\right) - \log q_{\vgamma}\left(\vt_{\vlambda}\left(\rvvu_m\right) \right) \Big)
    } \, \Big\lvert_{\vgamma = \vlambda}
    \\
    &\;\quad+ \norm{ \nabla F\left(\vlambda\right) }^2_2
    \\
    &\;=
    \frac{1}{M} \mathbb{E}\norm{
      \frac{\partial }{\partial \vlambda} \Big( f\left(\vt_{\vlambda}\left(\rvvu_m\right)\right) - \log q_{\vgamma}\left(\vt_{\vlambda}\left(\rvvu_m\right) \right) \Big)
    }_2^2 \, \Big\lvert_{\vgamma = \vlambda}
    \\
    &\;\quad+ \norm{ \nabla F\left(\vlambda\right) }^2_2,
\shortintertext{applying \cref{thm:general_variational_gradient_norm_identity},}
    &\;\leq
    \frac{1}{M} \mathbb{E}{\lVert
      \nabla f\left(\vt_{\vlambda}\left(\rvvu\right)\right)
      - \nabla \log q_{\vlambda}\left(\vt_{\vlambda}\left(\rvvu_m\right)\right)
    \rVert}_2^2 \left(1 + \norm{\rvvu}_2^2\right)
    \\
    &\;\quad+ \norm{ \nabla F\left(\vlambda\right) }^2_2
  \end{alignat*}

  We know apply the inequality \(\norm{\va - \vb}_2^2 \leq 2\,\norm{\va}^2_2 + 2\,\norm{\vb}^2_2\) as
  \begin{alignat*}{2}
    &\mathbb{E}{\lVert
      \nabla f\left(\vt_{\vlambda}\left(\vu\right)\right)
      - \nabla \log q_{\vgamma}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2
    \\
    &\,=
    2 \, \mathbb{E} \norm{
      \nabla f\left(\vt_{\vlambda}\left(\vu\right)\right)
    }
    +
    2 \, \mathbb{E} {\lVert
      \nabla \log q_{\vlambda}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2 
    \\
    &\quad-
    \underbrace{
    \mathbb{E}{\lVert
      \nabla f\left(\vt_{\vlambda}\left(\vu\right)\right) 
      +
      \nabla \log q_{\vgamma}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}^2_2
    }_{\text{control variate effect}}
    \\
    &\,\leq
    2 \, \mathbb{E} \norm{
      \nabla f\left(\vt_{\vlambda}\left(\vu\right)\right)
    }
    +
    2 \, \mathbb{E} {\lVert
      \nabla \log q_{\vlambda}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2.
  \end{alignat*}

  Due to \cref{eq:lemma_stl_entropy_term_variance}, 
  \begin{alignat*}{2}
    &\mathbb{E} {\lVert
      \nabla \log q_{\vgamma}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2 \, \Big\lvert_{\vgamma = \vlambda}
    \\
    &\;=
    2 \, V \left( \mathrm{H}\left(\varphi\right) - \mathrm{H}\left(q_{\vlambda}\right) \right)
    \\
    &\;=
    2 \, V \left( \mathbb{E}f\left(\vt_{\vlambda}\left(\rvvu\right)\right) - \mathrm{H}\left(q_{\vlambda}\right) - \mathbb{E}f\left(\vt_{\vlambda}\left(\rvvu\right)\right) + \mathrm{H}\left(\varphi\right) \right)
    \\
    &\;=
    2 \, V \left( F\left(\vlambda\right)  - \mathbb{E}f\left(\vt_{\vlambda}\left(\rvvu\right)\right) + \mathrm{H}\left(\varphi\right) \right)
    \\
    &\;\leq
    2 \, V \left( F\left(\vlambda\right) - f^* + \mathrm{H}\left(\varphi\right) \right).
  \end{alignat*}

  \begin{alignat*}{2}
    &\mathbb{E} \norm{\vg_M }^2_2
    \\
    &\;\leq
    \frac{1}{M} \mathbb{E}{\lVert
      \nabla f\left(\vt_{\vlambda}\left(\rvvu\right)\right)
      - \nabla \log q_{\vlambda}\left(\vt_{\vlambda}\left(\rvvu_m\right)\right)
    \rVert}_2^2 \left(1 + \norm{\rvvu}_2^2\right)
    \\
    &\;\quad+ \norm{ \nabla F\left(\vlambda\right) }^2_2
    \\
    &\;\leq
    \frac{1}{M} \left(
    2 \, \mathbb{E} \norm{
      \nabla f\left(\vt_{\vlambda}\left(\vu\right)\right)
    }_2^2
    +
    2 \, \mathbb{E} {\lVert
      \nabla \log q_{\vlambda}\left(\vt_{\vlambda}\left(\vu\right)\right)
    \rVert}_2^2
    \right)
    \\
    &\;\quad+ \norm{ \nabla F\left(\vlambda\right) }^2_2
    \\
    &\;\leq
    \frac{1}{M} \Bigg(
    \frac{2\,L^2 }{\mu} \left(d + \kappa\right) \left(  F\left(\vlambda\right) - h\left(\vlambda\right) - f^* \right)
    \\
    &\quad\quad+
    2 \, V \left( F\left(\vlambda\right) - f^* + \mathrm{H}\left(\varphi\right) \right)
    \Bigg)
    \\
    &\;\quad+ \norm{ \nabla F\left(\vlambda\right) }^2_2
  \end{alignat*}
\end{proofEnd}

%%% Local Variables:
%%% TeX-master: "main"
%%% End:
