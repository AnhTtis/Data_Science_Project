
\title{\LARGE \bf Indoor experimental validation of MPC-based trajectory tracking \\for a quadcopter via a flat mapping approach 
}

% \author{\IEEEauthorblockN{Huu-Thinh DO}
% \IEEEauthorblockA{\textit{Univ.\ Grenoble Alpes,}
% \textit{Grenoble INP}\\
% LCIS, F-26000, Valence, France \\
% huu-thinh.do@lcis.grenoble-inp.fr}
% \and
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \IEEEauthorblockN{Ionela PRODAN}
% \IEEEauthorblockA{\textit{Univ.\ Grenoble Alpes,}
% \textit{Grenoble INP}\\
% LCIS, F-26000, Valence, France \\
% ionela.prodan@lcis.grenoble-inp.fr}
% % \and
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % \IEEEauthorblockN{Florin STOICAN}
% % \IEEEauthorblockA{
% % \textit{Politehnica University of Bucharest}\\
% % ACSE, Bucharest, Romania \\
% % florin.stoican@upb.ro}
% % \and
% % \IEEEauthorblockN{4\textsuperscript{th} Given Name Surname}
% % \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
% % \textit{name of organization (of Aff.)}\\
% % City, Country \\
% % email address or ORCID}
% % \and
% % \IEEEauthorblockN{5\textsuperscript{th} Given Name Surname}
% % \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
% % \textit{name of organization (of Aff.)}\\
% % City, Country \\
% % email address or ORCID}
% % \and
% % \IEEEauthorblockN{6\textsuperscript{th} Given Name Surname}
% % \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
% % \textit{name of organization (of Aff.)}\\
% % City, Country \\
% % email address or ORCID}
% }
% \title{\LARGE \bf
% Preparation of Papers for IEEE Sponsored Conferences \& Symposia*
% }
\author{Huu Thinh DO$^{1}$ and Ionela PRODAN$^{1}$
\thanks{$^{1}${Univ.\ Grenoble Alpes,}
{Grenoble INP},
LCIS, F-26000, Valence, France
\tt\small \{huu-thinh.do, ionela.prodan\}
@lcis.grenoble-inp.fr}
}
\maketitle

\begin{abstract}
Differential flatness has often been used to provide diffeomorphic transformations of non-linear dynamics, with the goal of reaching  a linear controllable system with endogenous dynamic feedback. This greatly simplifies the control synthesis step since in the flat output space, the dynamic appears in canonical form (as a chain of integrators).  The caveat is that mapping constraints from the original to the flat space often leads to nonlinear constraints. In particular, the alteration of the feasible input set greatly hinders the subsequent calculations. 
In this paper, we particularize the problem for the case of the quadcopter dynamics and investigate the deformed, via the flat transformation, input constraint set. An optimization-based procedure will achieve a non-conservative, linear, inner-approximation of the non-convex, flat-output  derived, input constraint set. Consequently, a receding horizon problem (linear in the flat space) is easily solved and, via the inverse flat mapping, provides a feasible input to the original, nonlinear, quadcopter dynamics. Experimental validation and comparisons confirm the benefits of the proposed approach and show promise for other class of flat systems.
% Differential flatness has always been a significant tool to construct the diffeomorphism transforming a non-linear system into a linear controllable one together with an endogenous dynamic feedback. Ideally, without any constraints, this transformation will facilitate the control design since in the new flat output coordinates, the system is described in canonical form (or chains of integrators). However, practically, the controller construction is usually hindered by the altered constraint set via such coordinate change. In this paper, we investigate the case of the quadcopter model with the deformation of the input constraint set after such flatness-based input transformation. Then, an optimization-based approximation procedure will be introduced to achieve a non-conservative linear representation of the input in the flat space and guarantee the constraint satisfaction in the original coordinates. Next, with those stepping-stones, an MPC controller is constructed with the linearized dynamics employing a quadratic cost and linear constraints. Experimental validation is also provided to confirm the applicability of the proposed contributions. 
\end{abstract}

\begin{keywords}
Differential flatness, unmanned aerial vehicle, quadcopter, feedback linearization, constraints, model predictive control.
\end{keywords}
% \begin{IEEEkeywords}
% Differential flatness, quadcopter, feedback linearization, constraints, model predictive control.
% \end{IEEEkeywords}

\section{Introduction}
In the context of the global contagious pandemic in recent years, unmanned aerial vehicles (UAV), and particularly multicopters, have received remarkable attention thanks to their mobility and a wide range of applications in transportation and delivery. Although these systems have been widely investigated for decades \cite{hua2009control,formentin2011flatness,freddi2011feedback}, the question of optimally improving the tracking performance is still open due to their strong nonlinearity and the presence of physical constraints.

In order to tackle the issue, several control approaches have been proposed \cite{cowling2007prototype,freddi2011feedback,nguyen2020stability}. We concentrate our attention to Model Predictive Control (MPC) since it has the ability of computing control inputs by simultaneously ensuring constraints satisfaction and optimal performance. 
% Namely, this strategy allows one to obtain a model-based prediction for the system's behavior in a finite horizon, hence computing the optimal solution in real-time subject to operating constraints. 
In the literature, there are various approaches for implementing MPC in real-time multicopter applications. For example, one approach is to directly consider the nonlinear dynamics and design a nonlinear controller \cite{nguyen2020stability}. However, in practice, solving a nonlinear optimization problem requires a high computation demand. Thus, apart from applying MPC in a nonlinear setting, the dynamics is usually governed by exploiting its model inversion given by differential flatness \cite{fliess1995flatness}.
Indeed, the quadcopter system is 
famously known to accept a special representation through differential flatness (i.e., all its states and inputs are algebraically expressed in terms of a flat output and a finite number of its derivatives).
Based such property, one method is to exploit that \textit{flat representation} to construct an integral curve (or a  solution of the system's differential equation) by parameterizing the flat output in time with a sufficient smoothness. Then along such curve, the nonlinear dynamics is approximated by linear time varying models 
and employed in a linear MPC setting \cite{prodan2015predictive}. 
Expectedly, this method provides a computational advantage thanks to the approximated linear model while the convexity of the input constraint is preserved. Yet, one direct shortcoming is that the model is based on an approximation, leading to the sensitivity of the controller to uncertainties. Furthermore, in the context of exact linearization, the nonlinear dynamics can be typically linearized in closed-loop using a linearization law taken from the relation between the flat output and the inputs \cite{do_ifac_cao, greeff2018flatness}, making the stability more straightforward to analyze. However, the drawback is that, during the linear control design in the new coordinates, the constraint set will be altered, leading to a nonlinear or even non-convex set. This phenomenon is often dealt by online prediction \cite{kandler2012differential}, conservative offline approximation \cite{lu2017constrained,nguyen2020stability,mueller2013model} or constraint satisfying feedforward reference trajectory \cite{sun2022comparative}. 

This paper addresses the challenges and benefits of synthesizing a controller within the flat space of a multicopter using its feedback linearizable properties. Since in the new space coordinates, the input constraints are convoluted, we formulate a zonotopic-based inner approximation of the constraints. We then employ a classical MPC tracking for the feedback linearized system, which shows good performances in practice and with respect to the existing literature. Hence, the main contributions are highlighted in the following:

\begin{itemize}
    \item using the system's differential flatness properties, deduce the input transformation which linearizes the system in closed-loop and 
    describe the corresponding constraints in the new coordinates;
    \item propose an optimization-based procedure to
    find a maximum inscribed inner approximation of the aforementioned altered constraint set by adopting the technique of rescaling zonotopes \cite{ioan2019navigation};
    \item design an MPC-based controller for the preceding multicopter linear dynamics and experimentally validate it using the Crazyflie 2.0 platform in comparison with the piece-wise affine approach \cite{prodan2015predictive} and other existing results in the literature.
\end{itemize}

The remaining parts of the paper are structured as follows.
Section \ref{sec:sys_description} presents the system's dynamics together with its corresponding input sets, both before and after the closed-loop linearization through flatness. By exploiting the convexity of the new constraint set, a zonotopic-based approximation procedure is provided in Section \ref{sec:zono_app}. The effectiveness of the proposed approach is experimentally validated in Section \ref{sec:exp}. Finally, Section \ref{sec:conclude} draws the conclusions and discusses some future directions.

\emph{Notation:} Upper-case letters will refer to the matrices with appropriate dimension. Let $\boldsymbol I_n$ and $\boldsymbol 0_{n}$
% and $\boldsymbol 0_n$ 
denote the identity and zero matrix of dimension $(n\times n)$, respectively. Then vectors are represented by bold letters (e.g. $\boldsymbol \bu, \, \boldsymbol x$). Next, $\text{diag}(\cdot)$ denotes the diagonal matrix created by the employed components, while
 $\|\bx\|_Q$ denotes the weighted norm $\sqrt{\bx^\top Q \bx}$. For discrete system, $\bx_k$ denotes the value of $\bx$ at time step $k$. The superscript ``$\mathrm{ref}$'' represents the reference signal (e.g, $\bx^\mathrm{ref}$). Furthermore, $\partial\mathcal{X}$ and $\text{int}(\mathcal{X})$ respectively denote the boundary and the interior of the set $\mathcal{X}$. Finally, $\text{ConvHull}(\cdot)$ denotes the convex hull operation.
 
%  \section{Preliminaries}
%  \subsection{Differential flatness}
%   \subsection{Zonotopes}
 \section{System description and input constraints formulation in the flat output space}
 \label{sec:sys_description}
 In this section, we briefly present the well-known quadcopter model together with its flat characterization, which later leads to the input transformation law linearizing the model in closed-loop. Next, as a result of the variable change, the input constraint of the quadcopter is transformed into a different non-convex set which then is replaced by a convex alternative \cite{nguyen2017reliable,nguyen2018effective}.
 \vspace{-0.2cm}
 \subsection{Flat characterization of quadcopter model}
Let us recall the  quadcopter translational dynamics:
\begin{equation}
\begin{aligned}
	\bbm\ddot x \\ \ddot y \\ \ddot z \ebm&=\left[\begin{array}{c}
		T(\cos \phi \sin \theta \cos \psi+\sin \phi \sin \psi) \\
		T(\cos \phi \sin \theta \sin \psi-\sin \phi \cos \psi) \\
		T\cos \phi \cos \theta -g
	\end{array}\right]
	\triangleq h_\psi(\bu),
\end{aligned}
	\label{eq:drone_dyna}
\end{equation} 
where $x,\, y,\, z$ are the positions of the drone, $\psi$ denotes the yaw angle (which is assumed to be constant), $g$ is the gravitational acceleration and $\bu=[T \,\;\phi \,\;\theta]^\top\in\R^3$ collects the inputs. Finally,  $\mathcal{U}$ denotes the input constraint set, which is described
as:
\be 
\mathcal{U}=\{\bu :0\leq T\leq T_{max},\; |\phi|\leq \phi_{max},\;|\theta|\leq \theta_{max}\}
\label{eq:orginal_input_constr}
\ee
% $\mathcal{U}=\{\bu:0\leq T\leq T_{max},\; |\phi|\leq \phi_{max},\;|\theta|\leq \theta_{max}\}$ 
where $T_{max}$ and $\theta_{max},\phi_{max}\in \left( 0;\dfrac{\pi}{2}\right)$ are, respectively, the upper bound of the normalized thrust $T$ the angles $|\phi|,|\theta|$.

In order to compensate the nonlinearity one typical solution is to construct its flat representation \cite{fliess1995flatness}, i.e, parameterizing all the system variables with a special output, which is called \textit{flat output}, together with a finite number of its derivatives. Then, based on such model inversion, one can define a coordinate change associated with a dynamic feedback linearizing the system in closed-loop. Indeed, this quadcopter model is well-known to be differentially flat\cite{nguyen2017reliable}, and its common flat representation is as follows:
\begin{subequations}
	\begin{align}
x&=\sigma_1, y=\sigma_2, z=\sigma_3,\label{eq:flat_repa}  \\
T&=\sqrt{\ddot\sigma_1^2+\ddot\sigma_2^2+(\ddot\sigma_3+g)^2},\label{eq:flat_repb} \\
\phi&=\arcsin{\left({(\ddot\sigma_1\sin{\psi}-\ddot\sigma_2\cos{\psi})}/{T}\right)},\label{eq:flat_repc} \\
\theta&=\arctan{\left({(\ddot\sigma_1\cos{\psi}+\ddot\sigma_2\sin{\psi})}/{(\ddot\sigma_3+g)}\right)},\label{eq:flat_repd}
	\end{align}
	\label{eq:flat_rep}
\end{subequations}
% \be
% \begin{aligned}
% x&=\sigma_1, y=\sigma_2, z=\sigma_3  \\
% T&=\sqrt{\ddot\sigma_1^2+\ddot\sigma_2^2+(\ddot\sigma_3+g)^2} \\
% \phi&=\arcsin{\left({(\ddot\sigma_1\sin{\psi}-\ddot\sigma_2\cos{\psi})}/{T}\right)} \\
% \theta&=\arctan{\left({(\ddot\sigma_1\cos{\psi}+\ddot\sigma_2\sin{\psi})}/{(\ddot\sigma_3+g)}\right)}
% \end{aligned}
% \ee 
with the  flat output $\bsig=[\sigma_1,\sigma_2,\sigma_3]^\top\triangleq[x\,\,y\,\,z]^\top$. 

Next, by exploiting \eqref{eq:flat_repa}-\eqref{eq:flat_repc}, we employ an input transformation which is compactly written as $\bu=\varphi_\psi(\bv)$ and detailed in \eqref{eq:linearization}. In the mapping, $\bv=[v_1,v_2,v_3]^\top$ collects the input the new coordinates, called the \textit{flat output space}.
\begin{subequations}
	\begin{align}
T&=\sqrt{v_1^2+v_2^2+(v_3+g)^2},\label{eq:linearization_a} \\
\phi&=\arcsin{\left({(v_1\sin{\psi}-v_2\cos{\psi})}/{T}\right)},\label{eq:linearization_b} \\
\theta&=\arctan{\left({(v_1\cos{\psi}+v_2\sin{\psi})}/{(v_3+g)}\right)},\label{eq:linearization_c}
	\end{align}
\label{eq:linearization}
\end{subequations}
%
% or compactly: $\bu=\varphi_\psi(\bv)$ where $\bv=[v_1,v_2,v_3]^\top$ denotes the input the new coordinates, denoted as the \textit{flat space}.
Then under the condition of $v_3\geq-g$ and the input change \eqref{eq:linearization}, the system \eqref{eq:drone_dyna} is transformed into:
\vspace{-0.2cm}
\be 
\ddot \bsig =\bv, \text{ with } \bsig,\bv \in\R^3.
\label{eq:fbL}
\vspace{-0.12cm}
\ee 
Ideally, without constraints, the system now can be controlled by closing the loop for the trivial system \eqref{eq:fbL}.
However, as a consequence of the input transformation \eqref{eq:linearization}, the constraint $\mathcal{U}$ in \eqref{eq:orginal_input_constr} becomes geometrically altered. Hence, it is of paramount importance to analyze the constraint's alternation to construct a suitable controller for \eqref{eq:fbL}. Indeed, hereinafter, we pave the way towards the flatness-based MPC (FB-MPC) design for the constrained linear system \eqref{eq:fbL} by constructing the corresponding input constraint set for $\bv$ in the new flat output space. 

A general overview of the proposed control scheme for quadcopter reference tracking is in Fig. \ref{fig:scheme}. In details, with the reference deduced from the parameterization of the flat output and the measured feedback signal, the FB-MPC controller computes the necessary input $\bv$ to compensate the error based on the linear model \eqref{eq:fbL} and the input constraint set in the flat output space. Then the new input $\bv$ will be mapped back to the original coordinates as $\bu$ using the transformation \eqref{eq:linearization}. Finally, the control signal $\bu$ is then sent to the drone, ensuring the tracking performance.
\vspace{-0.3cm}
\begin{figure}[htbp]
    \centering
    \resizebox{0.475\textwidth}{!}{\input{Tex_code/tikz_code_fig/control_scheme_ECC2023}}
    \caption{Flatness-based MPC control scheme}
    \label{fig:scheme}
\end{figure}
\vspace{-0.25cm}
\subsection{Input constraint characterization in the flat output space}
As aforementioned, the input constraints are complicated when using the change of variable \eqref{eq:linearization}. 
Let us denote the new constraint set for $\bv$, as:
\be 
\mathcal{V}=\left\{
\bv\in\R^3\;|\;\varphi_\psi(\bv)\in\mathcal{U}
\right\}.
\label{eq:constraint_in_v}
\ee 
\begin{rem}
It is worth noting that one of the motivations to construct such a set in the flat output space lies on the structural property of the mapping $\varphi^{-1}_\psi(\bv)$. Indeed, since the function $\varphi_\psi(\bv)$ is continuous and continuously invertible ($\varphi^{-1}_\psi(\bu)=h_\psi(\bu)$), it describes a homeomorphism which is known to map the interior and boundary of a set, respectively, to its image's interior and boundary i.e, $\varphi^{-1}_\psi(\mathrm{int}(\mathcal{U}))=\mathrm{int}(\varphi^{-1}_\psi(\mathcal{U}));\varphi^{-1}_\psi(\partial\mathcal{U})=\partial(\varphi^{-1}_\psi(\mathcal{U}))$. Hence, under this mapping,  some geometrical properties of $\mathcal{U}$ (e.g, compactness and connectedness) are preserved in $\mathcal{V}$, encouraging us for a later-mentioned inner approximation.
\end{rem}
\begin{figure}
    \centering
    \includegraphics[scale = 0.5]{pics/ECC23/Draft_V_Vtilde_v2.pdf}
    \caption{Constraint sets for the input $\bv$ in the flat space (left) and the constraint set $\mathcal{U}$ in the original space (right).}
    \label{fig:Draft_V_Vtilde}
\end{figure}

Regardless, by a counterexample, it can be shown that $\mathcal{V}$ in \eqref{eq:constraint_in_v} is indeed non-convex. Indeed, the two vectors $\bv_\pm=h_\psi([T_{max},\pm\phi_{max}, \pm\theta_{max}]^\top) \in \mathcal{V}$ but $(\bv_+ + \bv_-)/2\notin \mathcal{V}$. Additionally, $\mathcal{V}$ appears to be impractical since it is constructed with the knowledge of the $\psi$ angle, which in real applications, will certainly be time-varying due to disturbances. For these reasons, let us consider the following subset of $\mathcal{V}$, denoted as $\Tilde{\mathcal{V}}$:
\be 
\begin{aligned}
    \Tilde{\mathcal{V}}=\Big\{\bv\in \R^3:  \bbm {v_1^2+v_2^2+(v_3+g)^2} -T_{max}^2\\
    % \sqrt{\dfrac{v_1^{2}+v_2^{2}}{v_1^{2}+v_2^{2}+(v_3+g)^{2}}}-  \sin\epsilon_{max} 
    v_1^2+v_2^2- (v_3^2+g)^2 \tan^2\epsilon_{max} 
    \ebm    \leq 0, &\\ 
    \epsilon_{max}\triangleq\min(\theta_{max},\phi_{max}) \text{ and } v_3\geq-g\Big\}&
    \end{aligned}
    \label{eq:constraint_convex}
\ee 
\begin{prop}
The set $\Tilde{\mathcal{V}}$ in \eqref{eq:constraint_convex} is convex and $\Tilde{\mathcal{V}}\subset {\mathcal{V}}$ with $\mathcal{V}$ as in \eqref{eq:constraint_in_v}. 
\label{prop:tVc}
\end{prop}

\begin{proof}
First, to show that $\Tilde{\mathcal{V}}\subset {\mathcal{V}}$, from \eqref{eq:linearization}, by using Cauchy-Schwarz inequality, we can construct the upper bounds for the roll and pitch angles $\phi,\theta$ as follows:
\begin{subnumcases}
{
 \label{eq:thinhset}
}
 |\sin\phi|\leq \sqrt{{(v_1^{2}+v_2^{2})}/{\left(v_1^{2}+v_2^{2}+(v_3+g)^{2}\right)}},
 & \label{eq:thinhseta} 
 \\
|\tan\theta| \leq \sqrt{{(v_1^2+v_2^2)}/{(v_3+g)^2}}.
& \label{eq:thinhsetb}
\end{subnumcases}
After some trigonometric transformations, we can see that the right-hand side of both \eqref{eq:thinhseta} and \eqref{eq:thinhsetb} represent the same angle, defined as $\epsilon_0(\bv) \triangleq \arctan \left(\sqrt{{(v_1^2+v_2^2)}/{(v_3+g)^2}}\right)$. Then, \eqref{eq:thinhset} yields:
\be 
|\sin\phi|\leq \sin{\epsilon_0(\bv)}\text{ and } 
|\tan\theta| \leq \tan{\epsilon_0(\bv)}
\label{eq:thinhset_short}
\ee 
Then, with $|\phi|,|\theta|<\pi/2$ as in \eqref{eq:orginal_input_constr} and by imposing $\epsilon_0(\bv)\leq \epsilon_{max}$, we have $|\phi|,|\theta|\leq (\theta_{max},\phi_{max})$. Furthermore, if $\bv\in\Tilde{\mathcal{V}}$, then $\bv\in {\mathcal{V}}$. More detail for the trigonometric transformation can be found in \cite{nguyen2018effective}.
The 
convexity of  $\Tilde{\mathcal{V}}$ in \eqref{eq:constraint_convex} can be shown by analyzing an intersection of the two following convex sets: a ball of radius $T_{max}$ and a convex cone defined by the two inequalities $v_1^2+v_2^2- (v_3^2+g)^2 \tan^2\epsilon_{max}\leq 0$, $v_3\geq -g$. The illustration of $\mathcal{V}$ and $\Tilde{\mathcal{V}}$ is depicted in Fig. \ref{fig:Draft_V_Vtilde}. 
\end{proof}

Up to this point, the constrained control (also illustrated in Fig 1) is reduced to governing the linear system \eqref{eq:fbL}, under the convex constraints $\bv\in \Tilde{\mathcal{V}}$ as in \eqref{eq:constraint_convex}, illustrated in Fig. \ref{fig:Draft_V_Vtilde}. However, in order to exploit more the advantage of this linear dynamics, it would be computationally beneficial if the set $\Tilde{\mathcal{V}}$ can be approximated by linear constraints,  hence making the system more straight forward to control. In the literature, there exist several efforts to conservatively approximate the quadcopter constraints by a box-type set \cite{mueller2013model,greeff2018flatness,nguyen2020stability}. In the succeeding section, by parameterizing a family of zonotopes, an optimization problem will be introduced to achieve a tractable representation for $\tilde{\mathcal{V}}$.
% \vspace{-0.15cm}
%
%
 \section{Input constraints approximation \\in the flat output space}
 \label{sec:zono_app}
As discussed above, the idea of maximally approximating the set is to inflate a geometrical object and achieve the largest volume inscribed. Typically, ellipsoids are utilized via the well known \textit{maximal ellipsoid inscribed problem}\cite{boyd2004convex} with the explicit representation of the volume as the cost function. However, with ellipsoidal sets, very few advantages can be of use both geometrically and computationally if employed in the MPC setting. Therefore, here we exploit the benefits of zonotopic sets for which we also have an explicit formula for their volume and preserve the linearity of the constraints' representation.
% alternatively, let us introduce in this section the employment of zonotopes from which we can also have an explicit formula for the volume, then by imposing such sets inside $\Tilde{\mathcal{V}}$, an optimization problem can be formulated to achieve agreeable results.
\vspace{-0.1cm}
\subsection{Zonotope parameterization}
Let us first introduce the definition of a zonotope.
\begin{definition} 
In $\mathbb R^d$, given a \textit{center} point $c$ and a collection of $n_g$ vectors $\{g_1,...,g_{n_g}\}$, then $\mathcal{Z}(G,c)$ is called a \textit{zonotope} and can be described as \cite{mcmullen1971zonotopes}:
\be 
\mathcal{Z}(G,c)=\{c+\textstyle\sum_{i=1}^{n_g}\beta_ig_i:|\beta_i|\leq 1\},
\label{eq:zono_def}
\ee 
with $G=[g_1,g_2,...,g_{n_g}]$ gathering all the \textit{generators} $g_i$. A zonotope is, indeed, a centrally symmetric polytope.
\end{definition}
Consequently, the following properties can be established.
Consider the following set $\mathbf E(\mathcal{Z}(G,c)) $ defined as:
\be
\begin{aligned}
\boldsymbol E (\mathcal{Z}(G,c))=\big\{\bx=c+G\bbm\alpha_1, 
...,
% \\ \vdots \\ 
\alpha_{n_g} \ebm^\top:&\\
\,\alpha_i \in \{-1,1\}, i\in\{1,...,n_g\}
\big\}
&
\end{aligned}
\label{eq:list_ver}
\ee 

Then, it was shown in \cite{mcmullen1971zonotopes} that the set $\mathbf E(\mathcal{Z}(G,c)) $ in \eqref{eq:list_ver} is a finite
subset of $\mathcal{Z}(G,c)$ and contains all of its vertices. Then, consequently, the inclusion $\mathcal{Z}(G,c)\subseteq \mathcal{X}$, where $\mathcal{X}$ is an arbitrary convex set, holds if and only if $\forall\bx\in\mathbf E(\mathcal{Z}(G,c)), \bx\in \mathcal{X}$. 

 Furthermore, as  proposed in \cite{ioan2019navigation}, consider a family of parameterized zonotopes: 
 \be 
 \mathcal{Z}(G\Delta,c)=\{c+\textstyle\sum_{i=1}^{n_g}\beta_i\delta_ig_i:|\beta_i|\leq 1\},
 \label{eq:zono_parameterized}
 \ee 
where $G$ is a given generator matrix and $\Delta=\text{diag}(\delta)$ denotes a diagonal matrix of which diagonal is collected in $\delta=[\delta_1,...,\delta_{n_g}]\in\R^{n_g}$. 
 Then its volume is explicitly written as:
%  \footnote{I have no idea how to drag $\delta_k$ closer to $\prod$ in \eqref{eq:vol}}:
\be 
\mathcal{C }(\delta)=\sum_{1\leq k_1<...<k_d\leq n_g} \left| \det(G^{k_1...k_d})\right| \prod_{\mathclap{{k\in\{k_1,...,k_d\}}}}\delta_k
\label{eq:vol}
\ee 
where $G^{k_1...k_d}\in \mathbb R^{d\times d}$ denotes the matrix formed by horizontally stacking the $k_l$-th column, $l\in\{1,...,d\}$, of G together. 

Using the above tools, we propose in the next subsection a zonotopic inner-approximation for the set $\tilde{\mathcal{V}}$ in \eqref{eq:constraint_convex}.
% With these apparatus, in the next subsection, let us define a maximization problem for a zonotope inscribed in a convex set, particularly in this case as $\tilde{\mathcal{V}}$.
% \vspace{-0.1cm}
\begin{figure}[htbp]
    \centering
    \includegraphics[scale=0.4]{pics/ECC23/zono_ex.pdf}
    \caption{Approximation of the set $\mathcal{X}=\{(x_1,x_2)\in\R^2:x_2\geq 2x_1-2,x_1^2+x_2^2\leq 25\}$ using \eqref{eq:opt_new_drone} with different choices of $\bx_0$ and $G=\bI_2$. The green area denotes the convex hull of all resulted sets.}
    \label{fig:zono_ex}
\end{figure}
\vspace{-0.25cm}

\subsection{Constraints approximation in the flat output space}
In here, we construct a general optimization problem to find the largest zonotope from the family of $\mathcal{Z}(G\Delta,c)$ as in \eqref{eq:zono_parameterized} constrained in the convex set ${\mathcal{X}}\subset\R^d$.
 \begin{subequations}
% \vspace{-0.75cm}
% \rule{0pt}{20pt}
	\begin{align}
		&(\delta,c)^*     =\underset{                     
		\delta,c 
		}{\arg\operatorname{max}}\;
		\mathcal{C }(\delta)
		,\label{eq:opt_new_drone_a}\\
	\text{s.t } &  \bx\in \mathcal{X}\,\forall \bx \in \mathbf E(\mathcal{Z}(G\cdot\text{diag}(\delta),c))
\label{eq:opt_new_drone_b}\\
&\bx_0 \in \mathcal{Z}(G\cdot\text{diag}(\delta),c) \label{eq:opt_new_drone_c}
	\end{align}
	\label{eq:opt_new_drone}
	\vspace{-0.03cm}
\end{subequations}
where $\mathcal{Z}(G,c)\subset\R^d$  denotes the zonotope formed by the given $n_g$ generators in $G\in\R^{d\times n_g}$ centered at $c$; $\delta=[\delta_1,...,\delta_{n_g}]\in\R^{n_g}$ is a scaling factor which magnifies the original zonotope $\mathcal{Z}(G,c)$ while $\mathcal{C }(\delta)$ denotes the volume of the zonotope $\mathcal{Z}(G\Delta,c)$ computed as in \eqref{eq:vol} with $\Delta\triangleq\text{diag}(\delta)$. Next, $\mathbf E (\mathcal{Z}(G\Delta,c))$ is the \textit{finite} subset of $\mathcal{Z}(G\Delta,c)$ containing all its vertices, which can be enumerated as in \eqref{eq:list_ver}. This condition \eqref{eq:opt_new_drone_b} will ensure that the zonotope will be inscribed in the set $\mathcal{X}$.  Finally, $\bx_0$ is a chosen interior point of $\mathcal{X}$. This constraint is to ensure the resulted set can be expanded into any direction. More specifically, since zonotopes are symmetric, it is impossible for them to expand freely in the volume $\mathcal{X}$. Therefore, progressively adding the condition \eqref{eq:opt_new_drone_c} helps us obtain several zonotopes reaching to its specific ``corners". Then the final approximated set can be constructed by computing the convex hull of all the zonotopes resulting from those choices of  $\bx_0$. A small example for a convex subset $\mathcal{X}$ of $\R^2$ can be found in Fig. \ref{fig:zono_ex} with some choices of $\bx_0$.

% (in our case, we progressively choose all $N_0$ values of $\bv_0\in\mathbb{V}$ as in \eqref{eq:N0}).
% D:\PhD_data\MATLAB\Projects\Quadrotor_project\MATLAB\Quadrotor\Input_constraints_relax\Small_ball\zono_approx_hovering_constraint_multi_N0


\begin{rem}
It is noteworthy that the semi-definite condition \eqref{eq:opt_new_drone_b} is straightforward to construct, compared to the existing  semi-infinite programming formula proposed in \cite{faiz2001trajectory} in the same context of exploiting flatness properties for enlarging polytopes $( \bx\in\mathcal{X}\,\forall \bx\in \mathcal{Z}(G\Delta,c))$. However, it also comes with a shortcoming: the computational cost (the number of constraints in \eqref{eq:opt_new_drone}) rises exponentially with the number of generators, $n_g$, since the number of elements in $\mathbf E(\mathcal{Z}(G\Delta,c))$  is $2^{n_g}$. This drawback is indeed burdensome, especially for high dimensional sets, because one needs a sufficiently large number of generators in order to have a good basis zonotope $\mathcal{Z}(G,c)$  to scale with $\delta$.
\end{rem}

% \begin{algorithm}[H]
% \caption{$\tilde{\mathcal{V}} $ construction }\label{alg:zono_approx}
% \begin{algorithmic}[1]
% \Require $G,V_0$
% \Ensure  The approximation set 
% \end{algorithmic}
% \end{algorithm}
% \begin{figure}[!t]
%  \removelatexerror
%   \begin{algorithm}[H]
%   \caption{multiobjective DE}
%   initialize population $P = \left \{ X_{1}, ... , X_{N} \right \} $\;
%   \For( \emph{Evolutionary loop}){$g := 1$ to $G_{max}$}
%   {
%       Do things \;
%       Trim the population to size $N$ using nondominated sorting and diversity estimation \;
%   }
%   \end{algorithm}
% \end{figure}


Briefly, our approximation procedure can be summarized as in Algorithm \ref{alg:zono_approx},
where $\mathbb{X}$ is a user-defined set containing all the points $\bx_0$ needed to be included in the zonotopes.
\begin{algorithm}[hbt!]
\caption{${\mathcal{X}} $ approximation procedure}
\label{alg:zono_approx}
\KwIn{$G,\mathbb{X}$}
\KwOut{The approximation set $\mathcal{S}_v$ of  ${\mathcal{X}}$ }
$k \gets 1$\;
\For{$\bx_0$ \textbf{in} $\mathbb{X}$}
{
Solve \eqref{eq:opt_new_drone} for $(\delta,c)$\;
$\mathcal{S}_v^k \gets \mathcal{Z}(G\Delta,c)$\;
$k \gets k+1$\;
}
$\mathcal{S}_v\gets \text{ConvHull}\left\{
\mathcal{S}_v^1,...,\mathcal{S}_v^{N_0}
\right\} $ 
\end{algorithm}
\vspace{-0.25cm}
% \vspace{-0.025cm}
% \vspace{-0.275cm}
% \vspace{-0.2cm}
% \vspace{-0.8cm}
% Regardless, beside $\mathbf E(\mathcal{Z}(G\Delta,c))$, one needs to define the collections of point $\bv_0$ belonging to the resulting zonotope, then each  value of $\bv_0$ and the solution from \eqref{eq:opt_new_drone} lead to a zonotope. The final approximated set then will be the convex hull of all those zonotopes which is also inscribed in $\Tilde{\mathcal{V}}$ due to its convexity property.
 \subsection{Simulation result}
 Particularly applying Algorithm \ref{alg:zono_approx} with $\mathcal{X}\triangleq\tilde{\mathcal{V}}$ as in \eqref{eq:constraint_convex}, let us propose the set $\mathbb{X}\triangleq\mathbb{V}$ constructed as in \eqref{eq:N0} and denote the final set as $\mathcal{S}_v$.
 \be
\begin{aligned}
\mathbb{V}=\big\{ \bv\in\R^3: \bv=[0,0,1]^\top((1-{k}/{N_0})T_{max}-g), &\\
k\in\{0,...,N_0-1\}\big\}.&
\end{aligned}
\label{eq:N0}
\ee
 For illustration, let us depict two scenarios where we choose $N_0=2$ and $N_0=25$ for \eqref{eq:N0}. With Algorithm \ref{alg:zono_approx}, the simulation result, its specification and parameters setup are provided in Fig. \ref{fig:First_and_last_Zono_pp_NT_eq_box},
%  \ref{fig:First_and_last_Zono__project_pp}, 
Fig. \ref{fig:Vol_ineq} and Table \ref{tab:First_and_last_Zono_pp}, respectively.
%  \vspace{-0.4cm}
 \begin{figure}[htbp]
    \centering
    \includegraphics[scale = 0.42]{pics/ECC23/First_and_last_Zono_pp_NT_greff.pdf}
    \caption{Approximated constraint sets for the new input $\bv$}
    \label{fig:First_and_last_Zono_pp_NT_eq_box}
\end{figure}

Furthermore, for comparison, we consider the constraint set for quadcopter proposed in \cite{nguyen2020stability} which is constructed as follows:
\be
% \begin{aligned}
\mathcal P_v=\{\bv\in \R^3: |v_i|\leq \bar v_{ip}\}\\
\ee
$$
\text{s.t }\begin{cases}
\bar v_{3p}<g; \,\bar v_{1p}^2+\bar v_{2p}^2\leq(-\bar v_{3p}+g)^2\tan^2\epsilon_{max}&\\
\sqrt{\bar v_{1p}^2+\bar v_{2p}^2+(\bar v_{3p}+g)^2}\leq T_{max}.&
\end{cases}
$$
% \end{aligned}
% \ee 
\begin{table}[htbp]
     \centering
     \caption{Parameters setup for $\Tilde{\mathcal{V}}$ approximation}
     \begin{tabular}{|c|c|}
     \hline
         Symbols & Values   \\ \hline \hline
         $g$  &  9.81    $m/s^2$\\ \hline
        % $T_{max}$  &  2g  $m/s^2$   \\ \hline
                $T_{max}$  &   $2  g\;m/s^2$   \\ \hline

        $\theta_{max}, \phi_{max}$  &  0.1745  $rad$ $(10^o)$   \\ \hline
        $G$  &  $\bbm 1 & 0 & 0 & 0 & 0
        \\ 0&1&0&1&-1\\
        0&0&1&2&2\ebm$   \\ \hline
        $\bar v_{1p}=\bar v_{2p}=\bar v_{3p}$  &  1.0875\\ \hline
        $[\bar v_{1b},\bar v_{2b},\bar v_{3b}]$  &  $[0.815,0.815,3.270]$\\ \hline
     \end{tabular}
     \label{tab:First_and_last_Zono_pp}
 \end{table}
 
 It is also notable to point out that, with our method, the approximated origin-centered constraint set proposed in \cite{mueller2013model,greeff2018flatness} can be similarly found by employing \eqref{eq:opt_new_drone} with $G=\bI_3$, denoted as $\mathcal{B}_v=\{\bv\in\R^3:|v_i|\leq\bar v_{ib}\}$. The illustration of the sets are shown in Fig. \ref{fig:First_and_last_Zono_pp_NT_eq_box} and the parameters' numerical values and specifications are given in Table \ref{tab:First_and_last_Zono_pp} and \ref{tab:result_spec}.
%  \begin{rem}
%  As can be seen from Fig. \ref{fig:Vol_ineq} 
% %  and Fig. \ref{fig:First_and_last_Zono__project_pp}
%  , with regard to the volume of the approximated set $\mathcal{S}_v$, few differences can be found between the two choices of $N_0$. However, the number of inequalities increases significantly with $N_0$. This will cause the computation time to grow if the set is exploited in optimization-based problems.
%  \end{rem}
 
  \begin{table}[htbp]
     \centering
     \caption{Result specifications for $\Tilde{\mathcal{V}}$ approximation}
     \begin{tabular}{|l|c|c|c|c|}
     \hline
          & $\mathcal{S}_v,N_0=2$  &$\mathcal{S}_v,N_0=25$  & $\mathcal{P}_v$& $\mathcal{B}_v$\\ \hline \hline
        Volume& 122.57  &  125.27   &10.29&17.39\\ \hline
      No. of vertices&  28    &226&8&8\\ \hline
        No. of inequalities&  20  &216& 6&6\\ \hline
     \end{tabular}
     \label{tab:result_spec}
 \end{table}
\vspace{-0.42cm}
% Vol_ineq.pdf
 \begin{figure}[htbp]
    \centering
    \includegraphics[scale = 0.5]{pics/ECC23/Vol_ineq.pdf}
    \caption{Specifications of $\mathcal{S}_v$ with respect to $N_0$ as in \eqref{eq:N0}}
    \label{fig:Vol_ineq}
\end{figure}
 
As depicted in Fig. \ref{fig:First_and_last_Zono_pp_NT_eq_box}, our approach provide an improved approximation for the input $\bv$, in comparison with other propositions. Prior to this point, the ingredients for an MPC design in the new coordinates are complete. More precisely, the system now can be governed by controlling its image in the flat space as in \eqref{eq:fbL} together with the corresponding input constraint $\mathcal{S}_v$ constructed. Therefore, in the next section, let us validate the results via different scenarios within the MPC settings.

 \section{Experimental validation with MPC}
 \label{sec:exp}
 In fact, to demonstrate the practical viability of our proposition, we first present the MPC synthesis utilizing the aforementioned model and constraints in the flat space, and then we implement it using the Crazyflie 2.0 nano-quadcopter with various flight scenarios.
%   In fact, to show applicability of our proposition in practice, we first present the MPC synthesis exploiting the afore-presented model and constraints in the flat space, then implement it using Crazyflie 2.0 nano-quadcopter with different scenarios of trajectories. 
 \subsection{MPC setup}
 Firstly, let $\bxi=[\sigma_1,\sigma_2,\sigma_3,\dot\sigma_1,\dot\sigma_2,\dot\sigma_3]^\top$ denotes the state vector of the system. Then applying Runge-Kutta (4th order) discretization method 
%  (with sampling time $T_s$) 
 to \eqref{eq:drone_dyna} yields:
 \be 
 \bxi_{k+1}=A\bxi_{k} + Bh_\psi(\bu_k)\triangleq f_d(\bxi_k,\bu_k),
 \label{eq:discrete}
 \ee 
 with $A=\bbm\bI_3 &T_s \bI_3\\ \boldsymbol 0_3 & \bI_3 \ebm $, $B=[T_s^2\bI_3/2,\;T_s\bI_3]^\top$ and the sampling time $T_s$. Next, let us introduce the following controllers employed for the validation and comparison.
 \begin{itemize}
     \item Flatness-based MPC (FB): by applying $\bu_k=\varphi_\psi(\bv_k)$ as in \eqref{eq:linearization}, the system now can be controlled with the linear dynamics: 
     $     \bxi_{k+1}=A\bxi_k+B\bv_k
     $, subject to the new input constraint $\bv_k\in\mathcal{S}_v$ with $N_0=2$. The online optimization problem now is written as:
\vspace{-0.2cm}
     \be
\begin{aligned}
&\underset{\bv_{k},...,\bv_{k+N_p-1}}{\arg \min } \textstyle\sum_{i=0}^{N_p-1} \Big(\left\|\bxi_{i+k}-\bxi_{i+k}^\mathrm{ref}\right\|_{Q}^{2}   \\[-1.2ex]
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;+\left\|\bv_{i+k}-\bv_{i+k}^\mathrm{ref}\right\|_{R}^{2}\Big)
\end{aligned}
\label{eq:opti_prob_FB}
\ee 
\vspace{-0.4cm}
$$\text{s.t :}
\begin{cases}
\bxi_{i+k+1}=A\bxi_{i+k}+B\bv_{i+k}, &\\
\bv_{i+k} \in {\mathcal{S}_v}, \, i\in\{0,1,...,N_p-1\}&
\end{cases}$$\vspace{-0.4cm}
     \item Piece-Wise Affine MPC (PWA):  For comparison, this method is adopted from \cite{prodan2015predictive} with the linearization of the model along the trajectory. 
     More specifically, after choosing $N_l$ points along reference the trajectory, we approximate \eqref{eq:discrete} exploiting Taylor expansion as: $\bxi_{k+1}=A_j\bxi_{k}+B_j\bu_k+R_j$, with $A_j=\left.{\partial f_d}/{\partial\bxi}\right|_{\bxi_j,\bu_j}$, $B_j=\left.{\partial f_d}/{\partial\bxi}\right|_{\bxi_j,\bu_j}$ and $R_j=f_d(\bxi_j,\bu_j)-A_j\bxi_j-B_j\bu_j$, where $\bxi_j,\bu_j$ respectively denote the $j$-th state and input in the collection of $N_l$ points equidistantly chronologically taken from the nominal reference trajectory . Then $A_j,B_j$ and $R_j$ are flexibly chosen according to the closest reference point.
\vspace{-0.17cm}
     \be
\begin{aligned}
&\underset{\bu_{k},...,\bu_{k+N_p-1}}{\arg \min } \textstyle\sum_{i=0}^{N_p-1} \Big(\left\|\bxi_{i+k}-\bxi_{i+k}^\mathrm{ref}\right\|_{Q}^{2}   \\[-1.2ex]
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;+\left\|\bu_{i+k}-\bu_{i+k}^\mathrm{ref}\right\|_{R}^{2}\Big)
\end{aligned}
\label{eq:opti_prob_PWA}
\ee 
\vspace{-0.17cm}
$$\text{s.t :}
\begin{cases}
\bx_{i+k+1}=A_j\bxi_{i+k}+B_j\bu_{i+k} + R_j\\
\bu_{i+k} \in {\mathcal{U}}, \, i\in\{0,1,...,N_p-1\}
\end{cases}$$\vspace{-0.35cm}
 \end{itemize}
 
 
 Moreover, to identify benefits and drawbacks of each method, let us provide some scenarios of trajectories. In those trajectories, the flat output $\bsig$ will be parameterized in time, which leads to the complete nominal reference of the system thanks to the representation \eqref{eq:flat_rep}. In details, the trajectories are described as:
 \begin{itemize}
     \item \textit{Reference 1} (Ref. 1): The trajectory was adopted from the energetically optimal B-spline parameterized curve (order 8)\cite{prodan2019necessary,do2021analysis} passing the way-points $w_k$ at $t_k\,(s)$:
     \begin{align}
 & \begin{aligned}
     w_k\in
                \Bigg\{\begin{bmatrix}
                0\\0 \\3.5
                \end{bmatrix},
                \begin{bmatrix}
                3\\-3 \\4
                \end{bmatrix},
                \begin{bmatrix}
                6\\0\\7.5
                \end{bmatrix},
    %   \qquad \qquad 
       \begin{bmatrix}
                6\\3 \\8
                \end{bmatrix},
                \begin{bmatrix}
                3\\6 \\8
                \end{bmatrix},
                \begin{bmatrix}
                0\\6 \\8
                \end{bmatrix}
                &
                \\
                \begin{bmatrix}
                -3\\3 \\8
                \end{bmatrix},
                \begin{bmatrix}
                -3\\0 \\5
                \end{bmatrix},
                \begin{bmatrix}
                0\\0 \\3.5
                \end{bmatrix}\Bigg\}\times 10^{-1}
                [m]
  \end{aligned}& \nonumber \\
&t_k=(k-1)\times 30/8, k\in\{1,2,...,9\}.\nonumber
\end{align}
With this reference, the curve's parameters are chosen such that all the states and inputs respect their constraints, giving a favorable reference for not only the states but the inputs to follow.
\item \textit{Reference 2} (Ref. 2): To increase the trajectory's aggressiveness, in this reference, set points are given under sequences of step functions, hence reducing the amount of information given to the controllers. 

\item \textit{Reference 3} (Ref. 3): Next, we adopt the circular trajectory and the MPC setup given in \cite{greeff2018flatness} as:
% \be 
$$
\begin{aligned}
&\sigma_{1\,\mathrm{ref}(t)}=0.5\cos\omega t, \sigma_{2\,\mathrm{ref}(t)}=0.5\sin\omega t\\
&\sigma_{3\,\mathrm{ref}(t)}=0.3(m), \omega=0.3\pi.
\end{aligned}
$$
% \ee 
\item \textit{Reference 4} (Ref. 4): Finally, we adapt the arbitrary sinusoidal trajectory given in \cite{garcia2017modeling}, describing as:
% \be
$$
\begin{aligned}
&\sigma_{1\,\mathrm{ref}(t)}=0.5\cos\omega t, \sigma_{2\,\mathrm{ref}(t)}=0.5\sin\omega t\\
&\sigma_{3\,\mathrm{ref}(t)}=0.5\sin 0.5 \omega t + 0.2(m), \omega=\pi/15.
\end{aligned}
$$
% \ee 
 \end{itemize}
 Illustration of the reference trajectories are given in Fig. \ref{fig:traj4}. 
%   \begin{figure}[htbp]
%      \centering
%      \includegraphics[scale=0.486]{pics/ECC23/pos4.pdf}
%      \caption{ Four proposed references}
%      \label{fig:pos4}
%  \end{figure}
  \begin{figure}[htbp]
     \centering
     \includegraphics[scale=0.5]{pics/ECC23/traj4_ver2.pdf}
     \caption{ Four proposed references (time parameterization)}
     \label{fig:traj4}
 \end{figure}
 \vspace{-0.4cm}
 \subsection{Experimental results and discussion}
%   \subsubsection{Sce. 1  }
 The experiments are carried out with a system of 8 \textit{Qualisys} motion capture cameras to extract the position of the drone. Next the control signal $\bu$ is computed in a station computer, then applied to the drone by sending the desired control $T,\phi,\theta,\psi$ via the Crazyflie PA radio USB dongle. During the experiment, the desired $\psi$ angle will be set as 0. The parameters employed in the experiments are listed in Table \ref{tab:paras}. 
 \begin{figure*}[htbp]
     \centering
     \includegraphics[scale=0.525]{pics/ECC23/track_error4ref_ver2.pdf}
     \caption{Crazyflie tracking error with flatness-based MPC and PWA-MPC (4 references) with $e_q=q_{\mathrm{ref}}-q,\;q\in\{x,y,z\}$}
     \label{fig:trackerror_v2}
 \end{figure*}
 
 Computationally, the sampling times were chosen according to the execution time with different trajectories. It can be noticed that with the well constructed Ref. 1, the input references $\bv_{k\,\mathrm{ref}}, \bu_{k\,\mathrm{ref}}$ can be nominally defined
 for the system's dynamics, hence speeding up the search for the optimal solutions in both methods. Consequently, the sampling time can be chosen only as $T_s=0.1s$. In contrast, as can be seen from Fig. \ref{fig:Comptime_4ref}, the remaining three trajectories demand much higher time for the initial search, hence making the requirement for the sampling become notably higher $(\geq 0.2s)$.

\begin{table}[htbp]
  \centering
  \caption{Control parameters for the proposed scenarios}
    \begin{tabular}{|c|l|l|l|r|r|}
    \hline
         &      & \multicolumn{1}{l|}{Q} & \multicolumn{1}{l|}{R}  & $T_s$ &$N_p$\\
    \hline
    \multirow{2}[1]{*}{Ref.1} & FB   & $\text{diag}(35\bI_2,50,5\bI_3)$     & $\bI_3$ & \multirow{2}[1]{*}{0.1} & \multirow{2}[1]{*}{20}\\
\cline{2-4}         & PWA  & $\text{diag}(35\bI_2,50,5\bI_3)$     &  $\text{diag}(5,75\bI_2)$ &&\\
    \hline
    \multirow{2}[1]{*}{Ref.2} & FB   & $\text{diag}(50\bI_3,5\bI_3)$      &  $5\bI_3$ &\multirow{2}[1]{*}{0.25}&\multirow{2}[1]{*}{20}\\
\cline{2-4}         & PWA  &    $\text{diag}(50\bI_3,5\bI_3)$   & $\text{diag}(5,75\bI_2)$ & &\\
    \hline
    \multirow{2}[1]{*}{Ref.3} & FB   &   $\text{diag}(180\bI_3,10\bI_3)$    &   $5\bI_3$ &\multirow{2}[1]{*}{0.2}&\multirow{2}[1]{*}{10}\\
\cline{2-4}         & PWA  &  $\text{diag}(50\bI_3,5\bI_3)$     & $\text{diag}(5,80\bI_2)$ & &\\
    \hline
    \multirow{2}[1]{*}{Ref.4} & FB   &  $\text{diag}(90\bI_3,5\bI_3)$     &  $5\bI_3$  &\multirow{2}[1]{*}{0.25}&\multirow{2}[1]{*}{20} \\
\cline{2-4}         & PWA  &    $\text{diag}(35\bI_2,50,5\bI_3)$   & $\text{diag}(5,75\bI_2)$ & &\\
    \hline
    \end{tabular}%
  \label{tab:paras}%
\end{table}%
   \begin{figure}[htbp]
     \centering
     \includegraphics[scale=0.5]{pics/ECC23/Comptime_4ref_ver2.pdf}
     \caption{Computation time used for different references}
     \label{fig:Comptime_4ref}
 \end{figure}
In terms of performance, Fig. \ref{fig:BarRMS} and \ref{fig:trackerror_v2} show the root-mean-square and the tracking errors of the two controllers, respectively, in four different aforementioned references. As expected, although requiring more computation time, the FB-MPC can be considered better while being put next to the well-known PWA-MPC with centimeters of tracking error. 
 
In details, one shortcoming of FB-MPC is that it demands slightly more execution time than the PWA-MPC in practice. This can be explained by showing the complexity of the optimization problems. Particularly, both \eqref{eq:opti_prob_PWA} and \eqref{eq:opti_prob_FB} are quadratic programming problems. However, the constraint set $\mathcal{S}_v$ is computationally complex, compared to $\mathcal{U}$ with more vertices or inequalities. The effect can also be seen in Fig. \ref{fig:BarRMS} with a roughly constant gap in computation time necessary for the two methods. 
However, since PWA-MPC depends on the approximation of the model along the trajectory, its efficiency will be reliant on the reference's quality, hence making the method more vulnerable to uncertainty than our proposed FB-MPC. Indeed, while with Ref. 1, both controllers achieve fairly good tracking (See Fig. \ref{fig:BarRMS}),
with Ref. 2, large oscillations in tracking error are observed with PWA-MPC compared to that of the FB-MPC, see Fig. \ref{fig:trackerror_v2}. Moreover, despite being constructed via an approximated input constraint, the FB-MPC always shows an equivalently reliable performance without saturating the input, in comparison with the PWA-MPC, as shown in Fig. \ref{fig:Imput_sig_v2}.
 \begin{figure}[htbp]
     \centering
     \includegraphics[scale=0.6]{pics/ECC23/barRMS_time_and_error_ver2.pdf}
   \caption{Root-mean-square of tracking errors and computation time of the two controllers with different types of references (the values of tracking errors and computation times are distinguished, respectively, by the subscript $e$ and $t$ under the name of the corresponding controller).}
     \label{fig:BarRMS}
 \end{figure}
 
   \begin{figure}[htbp]
     \centering
     \includegraphics[scale=0.5]{pics/ECC23/Imput_sig_4ref_ver2.pdf}
     \caption{Input signals with their constraints (black dashed line).}
     \label{fig:Imput_sig_v2}
 \end{figure}
 
Finally, thanks to the fact that there is no approximation in our control model, the performance in the proposed Flatness-based MPC surpasses its approximation-based contestant in \cite{garcia2017modeling} with Ref. 3. Besides, although being constructed in the similar framework of flatness-based MPC, with Ref. 4, our improved performance is apparent as a result of the less conservative constraint set $\mathcal{S}_v$ as opposed to the box-type constraint in \cite{greeff2018flatness}.

 \section{Conclusion}
 \label{sec:conclude}
 This paper presented a reliable flatness-based MPC design for the quadcopter system by introducing an efficient approximation for the input constraint set in the flat space. The validation demonstrates the advantages of the proposed contributions compared to related works carried out either by approximating the dynamics in the input/state space or approximating the constraints in the flat space. In short, by replacing the original nonlinear dynamics, with a linear one in the flat output coordinates, the quadcopter control design is significantly facilitated. As future work, we attempt to adapt the same procedure to other classes of flat systems, where the constraints may be more geometrically distorted after the transformation.




