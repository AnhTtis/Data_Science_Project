\section{Critical Assessment of Assumptions}
\label{sec:critical}
% General motivation for the critical assessment 
In the following, we use the t-test described in the previous section as an example to critically assess the validity of the assumptions used in HCI. We note, that some of the metrics shown in \mbox{Table \ref{tab:family}} are based on assumptions similar as those of the t-test. For example the assumed noise distribution in forward modelling techniques defines the  maximum likelihood expression which is the basis for the calculation of the detection map. Thus, although our analysis is based on the t-test, some aspects discussed in this paper might be of general interest. 
%
Apart from the assumptions used in HCI, some implementation details can have a non-negligible effect on the results. One example is the placement of the apertures in the residual image. We cover this aspect in \mbox{Appendix \ref{sec:rotation}} and focus our discussion on the two main assumptions of the t-test: the independence and the Gaussianity of the residual noise. 

% The description of the dataset here
Throughout the rest of this paper we compute our results based on a \mbox{$L'$-dataset} of \mbox{$\beta$ Pictoris} taken with the AGPM coronagraph \citep{delacroixLaboratoryDemonstrationMidinfrared2013} and NACO \citep{roussetNAOSFirstAO2003} at the VLT. The dataset is the same as the one used in \cite{mawetFUNDAMENTALLIMITATIONSHIGH2014}. The planet \mbox{$\beta$ Pictoris b} was removed by insertion of a negative fake planet. More details on the data can be found in \cite{absilSearchingCompanionsAU2013}. Our data pre-processing routine uses the \texttt{python} library PynPoint given in \cite{stolkerPynPointModularPipeline2019}. The final stack of pre-processed frames consists of 29681 images.

% Aspect 2: Independence ------------------------------------------------------------------------
\subsection{Independence}
\label{sec:independence}
A central assumption of the t-test is that $\mathcal{X}$ and $\mathcal{Y}$ are drawn independently. This means that all noise values have to be uncorrelated with respect to all other noise values and the signal. 
%
% Different noise for different instruments
Depending on the observing strategy, instrument, wavelength and data reduction, the noise characteristics of HCI observations can be fundamentally different. For example, observations at 3-5$\mu m$ are often dominated by the thermal background noise whereas observations at shorter wavelength 1-2.5 $\mu m$ are more affected by speckles \citep{hunzikerPCAbasedApproachSubtracting2018}. The noise type also affects the spatial correlations in the data. While some noise sources such as photon noise are independent on a pixel-to-pixel level, the planet signal and speckle noise will follow the shape of the telescopes PSF. 
%
If the noise is dominated by speckles and the pixel size is smaller than the width of the PSF, neighboring pixel are not independent. Some methods listed in \mbox{Table \ref{tab:family}} compute their noise statistics directly on pixel values while assuming independence. In the presence of speckle noise these methods will not provide accurate FPF estimates.

% Figure about independence
\begin{figure}[t]
	\epsscale{1.}
	\plotone{03_Independence.pdf}
	\caption{Violations of the independence assumption in the presence of speckle noise. The top two images illustrate the two cases described in the text. The pixel $A$ and $B$ are separated by 1 FWHM. We use the unsaturated PSF of the NACO dataset to display the speckle. The plots below give one dimensional profiles of the two cases, cut along the white dashed lines. The shaded areas highlight the information contributing to the aperture averages $A'$ and $B'$.}
	\label{fig:independence}
\end{figure}
%
Compared to an analysis directly on the pixels, the use of apertures suggest that $\mathcal{X}$ and $\mathcal{Y}$ are independent. A careful investigation, however, reveals that this impression is incorrect. Let us consider two pixel $A$ and $B$ together with a speckle on the detector (compare \mbox{Figure \ref{fig:independence}}). If the two pixel are distant by less than \mbox{1 FWHM} they will be partly correlated as both are influenced by the same speckle. This is the case if the speckle is located at $A$ (case 1) or between $A$ and $B$ (case 2). Therefore, if we calculate aperture averages $A'$ and $B'$ around $A$ and $B$ respectively, they will always be based on non-independent pixel values.
%
If we use apertures we implicitly filter the residual image with a box filter which has the shape of the aperture. Consequently, the length of the spatial correlations increases and with it the risk for a violation of the independence assumption.

We therefore propose to use the pixel values at the positions $A$ and $B$ directly instead of apertures for datasets in the speckle dominated regime. The separation between $A$ and $B$ should be chosen according to the expected spatial correlation length in the data. 
%
As bad seeing conditions or poor adaptive optics performance can influence the shape of the PSF, we space $A$ and $B$ by one FWHM and do not use the theoretical size of $\lambda /D$. The FWHM can be calculated by fitting a 2D Gaussian or Moffat to the unsaturated PSF \citep{stolkerPynPointModularPipeline2019}. The FWHM for the $\beta$ Pictoris dataset is 4.2 pixel and slightly larger than the theoretical size in $\lambda /D$ \cite[see also][]{jensen-clemNewStandardAssessing2017}. We note, that spacing $A$ and $B$ by one FWHM does not guarantee that their values are completely independent (compare case 2). But their values will be less dependent compared to the values of $A'$ and $B'$.
%
In addition to speckles other effects might influence the spatial dependencies in the data. A common example for this is the wind-driven halo discussed in \citep{cantalloubeWinddrivenHaloHighcontrast2020}. In such cases high-pass spatial filtering can be used to recover the spatial independence of the noise. The use of low-pass filters such as the Gaussian blur \citep{absilSearchingCompanionsAU2013}, however, exacerbates the independence problem. 
%
We further note, that in reality the spatial correlations can deviate from the shape of the PSF e.g. due to data post-processing. An empirical analysis on this topic is given in \mbox{Appendix \ref{sec:Correlation}}. 

In the background-dominated regime the use of apertures might be preferable over the use of spaced pixels. Since, the photon noise occurs on a pixel-by-pixel basis it is not problematic with respect to the independence. But, the signal estimate based on the brightest pixel is prone to statistical fluctuations and biases such as hot pixels. The choice whether apertures or spaced pixel are used should be taken on a case by case basis which is why our \texttt{python} package \texttt{applefy} provides an implementation of both.

Future work should further investigate more sophisticated alternatives to the use of spaced pixel including explicit models of the pixel-to-pixel dependencies \citep[compare e.g.][]{golombPlanetEvidencePlanetNoise2021}. 

% Aspect 3: The noise is not Gaussian. --------------------------------------------------------------
\subsection{The assumption of Gaussian noise}
\label{sec:non_gaussian_noise}
% The Gaussian assumption
The t-test assumes that the noise and the signal average $\overline{\mathcal{X}}, \overline{\mathcal{Y}}$ follow a normal distribution. This assumption is usually justified by the use of observing strategies such as ADI \citep{maroisAngularDifferentialImaging2006}, which average many individual observations. In this way, a temporal sequence of sufficiently i.i.d observations will yield a residual image with normal distributed noise by virtue of the central limit theorem (CLT) \citep{maroisConfidenceLevelSensitivity2008, mawetFUNDAMENTALLIMITATIONSHIGH2014}. In addition, the use of data post-processing techniques, such as a PSF subtraction with PCA, have demonstrated to considerably improve the normality of residuals \citep{amaraPYNPOINTImageProcessing2012, soummerDETECTIONCHARACTERIZATIONEXOPLANETS2012, cantalloubeDirectExoplanetDetection2015}. 
%
Despite the frame averaging and data post-processing, residual noise of real observations can still deviate from Gaussian. In \mbox{Figure \ref{fig:residual_statistics}} we use Q-Q plots\footnote{Q-Q plots are a statistical tool to compare the quantiles of two distributions with each other. For a detailed explanation, see \cite{pairetSTIMMapDetection2019} and references therein.}
 to compare the noise of the \mbox{$\beta$ Pictoris} dataset with normally distributed noise. 
%
\begin{figure}[t]
\epsscale{1.15}
\plotone{04_Residual_statistics.pdf}
\caption{Deviations from the normal distribution in HCI residuals. The top two images show residual images for the {$\beta$ Pictoris} dataset: Left with classical median ADI \citep{maroisAngularDifferentialImaging2006}; right with full-frame PCA and 20 components. Below Q-Q plots are given to study the noise statistic of the pixel values inside the shaded areas at \mbox{1 FWHM}, \mbox{4 FWHM} and \mbox{8 FWHM}. The Q-Q plot compares the observed pixel values with normal distributed noise. A perfect match of observations and normal distribution would result in points exclusively on the grey diagonal line. We note, that the pixel values extracted from the shaded areas are not independent. The shown Q-Q plots only provide indicative evidence for the type of residual noise. But, they are not a proof for or against Gaussian distributed noise. A discussion on the topic can be found in \mbox{Appendix \ref{sec:testing_gaussian}}.
%The grey line shows the best fit between observed and theoretical noise using a Theilâ€“Sen linear regression \citep{theil1950rank,sen1968estimates}. $R^2$ is the coefficient of determination.
}
\label{fig:residual_statistics}
\end{figure}
%
At 1 FWHM and 8 FWHM \mbox{(labels 1 \& 8)} we notice that the noise for large values is above the diagonal line of the Q-Q plot. This implies that bright pixel are more frequent in the data than we expect from Gaussian noise. Similar noise statistics were previously observed by \cite{maroisConfidenceLevelSensitivity2008,cantalloubeDirectExoplanetDetection2015,pairetSTIMMapDetection2019}. At 4 FWHM \mbox{(labels 4a and 4p)} we observe the opposite behavior: large values are less frequent in our data compared to the normal distribution.
%
A measure for these deviations is the coefficient of determination $R^2$ that is the Pearson correlation between the paired sample quantiles. See \cite{pairetSTIMMapDetection2019} for the definition and detailed explanation. The closer $R^2$ is to 1, the better the observed noise can be explained by Gaussian noise. As suggested by the results shown in \mbox{Figure \ref{fig:residual_statistics}} the use of PCA partially mitigates the problem of non-Gaussian noise. Nevertheless, the noise is still not perfectly normal.

% Why is the deviation a problem?
In the presence of noise which has a high probability of large values to occur, the probability that we observe a large value of $T$ (\mbox{Equation \ref{eq:SNR}}) that is caused by the noise increases. Consequently, $p(T = t | H_0)$  will no longer follow a t-distribution and the interpretability of the test statistic $T$ w.r.t. the FPF is lost. That is, we can still calculate values for $T$, but we no longer know which detection uncertainty they are associated with. Depending on the type of noise, different values of $T_{\text{obs}}$ might be required to reject $H_0$. This is especially problematic as noise characteristics can change from dataset to dataset. If we ignore potential violations of the Gaussian assumption, we under- or over-estimate the detection uncertainty. 
%
% What are the limits for n vs 1 -> infinity?
% Why does the problem still matter at large separations / CLT does not help
For many applications outside HCI, the t-test is robust to slightly non-Gaussian data given a large sample size. As the sample size increases the average values of $\overline{\mathcal{X}},\overline{\mathcal{Y}}$ will be Gaussian thanks to the CLT. In HCI, we cannot take advantage of this effect as $\mathcal{Y}$ always contains a single observation. For small separations, where speckle noise is most important, the sample size of $\mathcal{X}$ is also limited.
%
How strong is the effect of non-Gaussian noise on the detection uncertainty? Is a comparison between datasets or instruments with different noise characteristics still possible? 
