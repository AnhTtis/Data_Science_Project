\section{A Set Theoretic Perspective on Walking: $\delta$-Robustness}
\label{sec: uncertainguard}

This section provides the key formulation of robustness considered throughout this paper---that of $\delta$-robustness.  The core concept behind this definition is stability in and of itself is not a sufficiently rich concept to capture robustness, since it is purely local.  Thus, we define a set-theoretic notion of robustness leveraging the Poincar\'e map. 



\begin{figure}[tb]
    \centering
    \includegraphics[width=\linewidth]{Figures/motivation_figure.pdf}
    \caption{Demonstration of a periodic orbit with $\max |\lambda(D P(x^*))| < 1$ (illustrated on the left) not being robust to variations in the guard condition (for this example, the ground height was increased by 1cm), while a periodic orbit with a larger $\lambda_{\max}$ (illustrated on the right) is comparatively more robust.}
    \label{fig: motivation}
\end{figure}

\newsec{Motivation}
Practically, the stability of periodic orbits can be analyzed by evaluating the eigenvalues of the Poincar\'e return map linearized around the fixed point. Specifically, if the magnitude of the eigenvalues of $DP(x^*) = \frac{\partial P}{\partial x}(x^*)$ is less than one (i.e. $\max |\lambda (DP(x^*))| < 1$), then the fixed point is stable \cite{perko2013differential,morris2005restricted,wendel2010rank}. 
% Note that in this process, the eigenvalues corresponding to states known to be nonperiodic, such as the horizontal position of the floating base frame. 
Since it is often difficult to compute the Poincar\'e map analytically, it is commonly numerically approximated.  By applying small perturbations to each state and forward simulating one step to obtain $P(x^*+\delta )$ which is then used to construct each row of the Jacobian successively.  This implicitly implies that the Poincar\'e map is robust to $\delta$ perturbations---as long as $\delta$ is sufficiently small.   Yet, this small amount of robustness inherent in stable gaits is often confounded with the eigenvalues themselves.  That is, it is sometimes assumed that the magnitude of the eignevalues of the Poincar\'e map say something deeper about the broader robustness of the periodic orbit to perturbations.  This is not the case, as the following example illustrates. 


    
% \begin{remark}
%     Orbits $\O$ with lower $\lambda_{\max}$ are regarded as being \textit{more stable} than orbits with higher $\lambda_{\max}$ since they are more contractive around the fixed point.
% \end{remark}

% However, since the Poincar\'e map is evaluated at the fixed point, this notion of stability is only valid locally. This means that while this tool is useful for checking the stability of periodic orbits, it is no longer insightful for systems with uncertain guard events or disturbances that push the system away from the fixed point. 

% \subsection{Simulation Example}
% \blue{Take two gaits, with one gait having a smaller eigenvalues than the other. Show that in the presence of uncertain terrain, the "more stable gait" fails, while the other one doesn't.}

\begin{example}
Consider a 5-link bipedal robot shown in Figure \ref{fig: uncertainguard}.  To illustrate how the eigenvalues associated with the linearization fail to tell the whole story, we will consider the robustness of these gaits to differing ground height conditions.  
As illustrated in Figure \ref{fig: motivation}, the classic Poincar\'e analysis does not accurately reflect the robustness of periodic orbits to local disturbances in the guard condition. That is, the gait with the smaller maximum eigenvalue (magnitude) is more fragile to changing ground heights. 
%In this work, we will instead propose tools for discussing the stability of walking (described by either periodic and nonperiodic orbits) from a set-theoretic perspective. This will then allow us to introduce tools for analyzing the stability of walking away from the fixed point.
\end{example}


\newsec{Set-Based Robustness}
% Next, we will extend the notion of set-stable walking to include uncertain guard conditions. 
We now formulate a notion of robustness of the extended Poincar\'e map to uncertain guard conditions. 
Specifically, we consider the general guard (as defined in \cite{hamed2016exponentially}) for some $d \in \R$,
\begin{align}
    S_d &= \{x\in \mathcal{X} \mid h(x) = d, ~\dot h(x) < 0\},
    \label{eq: heightguard}
\end{align}
with $d \in \mathbb{D}$ and $\mathbb{D} := [d^-,d^+] \subset \R$ for some $d^- < 0 < d^+$. Using this general guard definition, the previous guard \eqref{eq: zeroguard} is now denoted as $S_0$.  Under the assumption that $S_d \subset D$ for all $d \in \mathbb{D}$, we have a corresponding hybrid system: 
\begin{numcases}{\mathcal{H}_d  = }
\dot{x} = f_{\rm cl}(x) := f(x) + g(x) k(x) & $x \in D \setminus S_d$, \label{eq: continuousd}
\\
x^+ = \Delta(x^-) & $x^- \in S_d$, \label{eq: discreted}
\end{numcases}

% It is important to note that the typical assumptions made for systems considering $\S_0$ still apply for systems considering $\S_d$ with $d \not= 0$. Mainly,
% \begin{enumerate}
%     \item The continuous-time dynamical system \eqref{eq: continuous} is continuous on $\X$ for any guard condition $S_{d}$
%     \item The solution to \eqref{eq: continuous} from any initial condition $x_0 \in \Delta(S_d)$ is unique and depends continuously on $x_0$ for any guard condition $S_{d}$
%     \item The function $h: \X \to \R$ is differentiable such that for every $s \in S_d$, $\frac{\partial h}{\partial s}(x) \not= 0$ for any $d \in \mathbb{D}$
% \end{enumerate}

The extended time-to-impact function $T_e: \bar{\X} \times \mathbb{D} \to \R^+$ is then defined similarly to the time-to-impact function, with the exception that it is specific to the guard $S_d$:
\begin{align}
    T_e(x_0,d) := \inf\{ t \geq 0 \mid \varphi_t(x_0) \in S_d \}.
\end{align}
Note here that $T_e$ is well-defined for the neighborhood $\bar{\X}$ satisfying:
$$\bar{\X} := \{x \in \X \mid 0 < T_e(x,d) < \infty, \dot{h}(x) < 0, \forall d \in \mathbb{D}\}.$$
Using this extended time-to-impact function, we can define the extended Poincar\'e map, $P_{d}: \bar{S} \to S_d$:
\begin{align}
    P_{d}(x^-) := \varphi_{T_e(\Delta(x^-),d)}(\Delta(x^-)),
\end{align}
that is well-defined for the open set $\bar{S} := \Delta^{-1}(\bar{X})$.
% Note that this extended Poincar\'e map is well-defined and continuous in a neighborhood around $x_{k-1}$ (\red{can prove in Appendix by extending Lemma 3 in \cite{grizzle2001asymptotically}}). In other words, the Poincar\'e map is defined as $P_{d_k}: \widetilde{S}_{d_{k-1}} \to S_{d_k}$ with $\widetilde{S}_{d_{k-1}} := \Delta^-(\widetilde{\X})$ for $\widetilde{X} := \{x \in \X \mid 0 < T_e(x,d_k) < \infty \}$. 

% Also note that the extended Poincar\'e map for some interval range $d \in [d^-,d^+] \in \R$ can also be interpreted as a set-valued Poincar\'e map:
% \begin{align}
% \P_{[d^-,d^+]}(x):= \{ P_d(x) \mid \forall d \in [d^-,d^+]\}
% \label{eq: setvaluedP}
% \end{align}

% We are now prepared for the following definition:
\begin{definition}  
Let $\O$ be a periodic orbit with fixed point $P_0(x^*) = x^*$ corresponding to the guard condition $\S_0$ as in \eqref{eq: heightguard}. The orbit $\O$ is \textbf{$\delta$-robust} to $d \in [d^-_{\delta},d^+_{\delta}] \in \mathbb{D} \subset \R$ if there exists a $\delta > 0$ such that:
\begin{align*}
    P_d(x) \subseteq \B_{\delta}(x^*), ~\forall d \in [d^-_{\delta},d^+_{\delta}], \forall x \in \B_{\delta}(x^*)
\end{align*}
with the bounds on $d$ implicitly determined by: 
$$
d^-_{\delta} = \inf_{x \in B_{\delta}(x^*)} h(x), \qquad 
d^+_{\delta} = \sup_{x \in B_{\delta}(x^*)} h(x).
$$
% \begin{align*}
%     d^-_{\delta} := \inf\{ h(x) \mid x \in \B_{\delta}(x^*)\}, \\
%     d^+_{\delta} := \sup \{h(x) \mid x \in \B_{\delta}(x^*)\}.
% \end{align*}
\label{def: deltarobust}
\end{definition}

\begin{theorem} 
Let $\O$ be a periodic orbit with a fixed point $x^* \in \S_0$ such that $P_0(x^*) = x^*$. If $x^*$ is an exponentially stable equilibrium point of $x_{k+1} = P_0(x_k)$, then there $\exists \delta > 0$, s.t. $\O$ is $\delta$-robust to $d \in [d^-_{\delta},d^+_{\delta}]$.
\end{theorem}
\begin{proof}
Following the conditions on exponential stability as defined in Theorem. \ref{def: expstability}, since $\O$ has an exponentially stable equilibrium point, then $\exists \delta' > 0$,  $i \in \mathbb{N}_{\geq 0}$, such that for all $x \in \B_{\delta'}(x^*)$,such that $P_0^i(x) \in \B_{\delta'}(x^*)$.

Similarly to the proof of Theorem 1 in \cite{grizzle2001asymptotically}, there must exist some non-zero interval $t \in [T_e(x,d^+),T_e(x,d^-)]$ with $d^+ > 0$ and $d^- < 0$ during which $\dot{h}(\varphi_t(x)) < 0$. 

Furthermore, we can select $d^+$ and $d^-$ sufficiently small, such that $\{\varphi_{T_e(x,d^+)}(x),\varphi_{T_e(x,d^+)}(x)\} \in \B_{\delta'}(x^*)$. Therefore, $\{P_{d^-}(x),P_{d^+}(x)\} \in \B_{\delta}(x^*)$. 

Next, since $\varphi_t(x_0)$ is unique and depends continuously on $x_0$, and since $P_d(x) = P_0(x)$ for $d = 0$ lies in the interior of the segment $\varphi_t(x)$ for $t \in [T_e(x,d^+),T_e(x,d^-)]$, then again we can choose $d^+$ and $d^-$ sufficiently small such that
$$ \|P_d(x) - P_0\| \leq \max \{\|P_{d^-}(x) - P_0(x)\|,\|P_{d^+}(x) - P_0(x)\| \}.$$

Finally, let $\delta > 0$ be defined as the ball such that:
\begin{align*}
    d^- = \inf\{h(x) \mid \forall x \in \B_{\delta}(x^*)\}, \\
    d^+ = \sup\{h(x) \mid \forall x \in \B_{\delta}(x^*)\}.
\end{align*}
Then for any $d \in [d^-,d^+]$, $P_d(x) \in \B_{\delta}(x^*)$, $\forall x \in \B_{\delta}(x^*)$.
\red{STILL IN PROGRESS...}
\end{proof}

\newpage
\subsection{Question: How do we check $\delta$-robustness given $\O$?}

Consider the following discrete-time dynamical system, dependent on a specific guard height:
\begin{align}
    x_{k+1} = P_{d_k}(x_k)
    \label{eq: discretetime}
\end{align}
for some $d_k \in [d^-,d^+] \in \R$ denoting the guard height specific to step $k \in \mathbb{Z}^+$ such that $x_{k+1} \in S_{d_k}$.

\begin{lemma}
    Consider the discrete-time system \eqref{eq: discretetime}. If $\forall x_0 \in \B_{\delta}(x^*)$, $P_{d_k}(x_0) \in \B_{\delta}(x^*)$, then $x_{k+1} \in \B_{\delta}(x^*)$, $\forall k \in \mathbb{Z}^+$.
    \label{lemma: recursiveset}
\end{lemma}
\begin{proof}
    The lemma can be proven via recursion. Let $x_1 := P_{d_k}(x_0)$. Applying the set-valued Poincar\'e return map to $x_1$ yields $x_2 := P_{d_k}(x_1)$. Per the assumption, $x_1 \in \B_{\delta}(x^*)$. Therefore, given that $\forall x \in \B_{\delta}(x^*)$, $P_{d_k}(x) \in \B_{\delta}(x^*)$, then since $x_1 \in \B_{\delta}(x^*)$, $x_2 \in \B_{\delta}(x^*)$. Applying this $k \in \mathbb{Z}^+$ times will eventually yield that $x_{k+1} \in \B_{\delta}(x^*)$.
\end{proof}

Since the specific guard condition $d_k$ assigned to step $k$ is unknown, we will use a set-based Poincar\'e map to denote the collection of Poincar\'e return maps for all guard conditions contained within the set $\B_{\delta}(x^*)$:
\begin{align}
    \P_{\delta}(x) := \{P_d(x) \mid \forall d \in [d^-_{\delta},d^+_{\delta}]\}.
\end{align}
Thus, the discrete-time dynamical system for any guard condition $S_d$ with $d \in [d^-_{\delta},d^+_{\delta}]$ is denoted as the expanding set:
\begin{align}
    \bm{X}_{k+1} := \P_{\delta}(x_k).
    \label{eq: setDiscrete}
\end{align}

Using this set-based notion of a discrete-time dynamical system, we propose the following theorem:
\begin{theorem}
    Consider the discrete-time barrier function, $H_{\delta}: \X \to \R$, defined as $H_{\delta}(x):= \delta^2 - \|x - x^*\|^2 \geq 0$. If the following condition is satisfied: 
    $$\min \{H_{\delta}(\bm{X}_{1})\} \geq (1-\gamma)H_{\delta}(x_0), \quad \gamma \in (0,1],$$
    for all $x_0 \in \B_{\delta}(x^*)$, then the periodic orbit $\O$ is $\delta$-robust.
\end{theorem}
\begin{proof}
     Given some $\delta > 0$, with corresponding $\{d^-_{\delta},d^+_{\delta}\} \in \R$ per Definition \ref{def: deltarobust}, then the set $\B_{\delta}(x^*)$ is a 0-superlevel set of the continuously differentiable function $H_{\delta}: \X \to \R$ satisfying: 
    \begin{align*}
        \B_{\delta}(x^*) := \{x \in \X \mid H_{\delta}(x) \geq 0\} \\
        \partial \B_{\delta}(x^*) := \{x \in \X \mid H_{\delta}(x) = 0 \}
    \end{align*}
    
    Per Proposition 4 of \cite{agrawal2017discrete}, the discrete-time system \eqref{eq: discretetime}, for a specific choice of $d_k \in [d^-_{\delta},d^+_{\delta}]$, is forward-set invariant with respect to the set $\B_{\delta}(x^*)$ if $H_{\delta}$ satisfies the following conditions for all $x_0 \in \B_{\delta}(x^*)$:
    \begin{enumerate}
        \item $H_\delta(x_0) \geq 0$,
        \item $H_{\delta}(P_{d_k}(x_k))-H_{\delta}(x_k) \geq -\gamma H_{\delta}(x_k)$, \\$\forall k \in \mathbb{Z}^+$, $0 < \gamma \leq 1$,
    \end{enumerate}
    where the second condition can be rewritten as $H_{\delta}(P_{d_k}(x_k)) \geq (1-\gamma) H_{\delta}(x_k)$.

    Using Lemma \ref{lemma: recursiveset}, $P_{d_k}(x_k) \in \B_{\delta}(x^*)$ for all $k \in \mathbb{Z}^+$ if $P_{d_k}(x_0) \in \B_{\delta}$ for all $x_0 \in \B_{\delta}(x^*)$. Thus, we only need to check the second condition for some set $x_0 \in \B_{\delta}(x^*)$:
    $$H_{\delta}(P_{d_k}(x_0)) \geq (1-\gamma)H_{\delta}(x_0), ~0 < \gamma \leq 1.$$ Lastly, the above condition can be checked for all $d_k \in [d^-_{\delta},d^+_{\delta}]$ by ensuring that the smallest condition $$\min_{d \in \mathbb{D}}\{H_{\delta}(P_{d}(x))\} \geq (1-\gamma)H_\delta(x), $$ is satisfied. 
    Thus, the condition $$\min \{H_{\delta}(\bm{X}_{k})\} \geq (1-\gamma)H_{\delta}(x_0), \quad \gamma \in (0,1],$$ for all $x_0 \in \B_{\delta}(x^*)$ enforces that 
    $\bm{X}_{k+1} = \P_{\delta}(x_k)$ is forward set invariant with respect to the set $\B_{\delta}(x^*)$. This is equivalent to the statement that $ P_d(\B_{\delta}(x^*)) \subseteq \B_{\delta}(x^*), ~\forall d \in [d^-_{\delta},d^+_{\delta}]$. Therefore, per Definition \ref{def: deltarobust}, $\O$ is $\delta$-robust to $d \in [d^-_{\delta},d^+_{\delta}]$.
\end{proof}

% \begin{theorem}
%     If $ H_{\delta}(P_{d_k}(x_k)) \geq \gamma H_{\delta}(x_k)$ for all $x_k \in \B_{\delta}(x^*)$, then $\O$ is $\delta$-robust and the discrete-time system \eqref{eq: discretetime} is exponentially stable.
% \end{theorem}
% \begin{proof}
%     \red{?}
% \end{proof}


% We can use sample-based approach:
% \begin{enumerate}
%     \item Starting with a small $\delta > 0$, fix $\delta > 0$ and sample the boundary of $\B_{\delta}(x^*)$ (i.e. $s_i \sim \partial \B_{\delta}(x^*))$)
%     \item Observe the flow $\varphi_t(\Delta(s_i))$ $\forall s_i \in samples$
%     \item The set-valued Poincar\'e map is equal to a portion of this flow: $$ \P_{[d^-,d^+]}:=\{ \varphi_t(\Delta(s_i)) \mid t \in [T_e(\Delta(s_i),d^+),T_e(\Delta(s_i),d^-)]\}$$ \red{Note: This currently assumes that $\dot{h}<0$ for $h \in [d^-,d^+]$}
%     \item If $\P_{[d^-,d^+]}(s_i) \in \B_{\delta}(x^*)$ for the selected $\delta > 0$, then increase $\delta$ and repeat the process. If not, then the orbit $\O$ is $\delta$-robust to $d \in [d^-,d^+]$.
% \end{enumerate}

\newsubsec{Probablistic Verification Approach}
It is important to recognize that verifying the condition $\min \{H_{\delta}(\bm{X}_{1})\} \geq (1-\gamma)H_{\delta}(x_0)$ for all $x_0 \in \B_{\delta}(x^*)$ is computationally infeasible. This is especially true for systems in which the Poincar\'e map is not available explicitly. Thus, we will instead use sampling methods to verify $\delta$-robustness with probabilistic guarantees. 

% Mainly, we will transform the problem into the following uncertain program:
% \begin{align}
%     \delta^* = &\argmax_{\delta > 0} \delta \\
%     &\text{s.t. } H_{\delta}(P_{d_k}(x_k)) \geq H_{\delta}(x_k), ~ 
% \end{align}

As outlined in \cite{akella2022barrier}, the certification of barrier functions can be probabilistic verified using sampling methods. First, we will introduce the method for verifying that a given periodic orbit is $\delta$-robust, for a given $\delta$. This algorithm is provided in Algorithm \ref{alg: givendelta}, and is outlined as follows.

\begin{algorithm}[tb]
\caption{Probabilistic Verification of Lemma 1}\label{alg: givendelta}
\begin{algorithmic}[1]
\Procedure{Given $\delta > 0$}{}
% {$\delta > 0$, $d^-_{\delta} := \inf\{h(x) \mid \B_{\delta}(x^*)\}$, $d^+_{\delta} := \sup\{h(x) \mid \B_{\delta}(x^*)\}$}
\State $x' \sim U(\B_{\delta}(x^*))$
\State Forward simulate $\P_{\delta}(x') \rightarrow \bm{X}_{1}$
\If {$\min \{H_{\delta}(\bm{X}_{1})\} \geq (1-\gamma)H_{\delta}(x_0)$, $0 < \gamma \leq 1$} 
  \State $r_i = 1$
\Else
    \State $r_i = 0$
\EndIf 
\State Repeat sampling $r_i \to \{r_j\}^N_{j=1}$
\State Find minimum $r_j \to r^*_N$
\State Compute $\Prob_{\pi_r}^N[\Prob_{\pi_r}[r \geq r^*_N] \geq 1 - \varepsilon] \geq 1 - (1-\varepsilon)^N$
\EndProcedure
\end{algorithmic}
\end{algorithm}

%%% THIS SECTION NEEDS WORK
-----

Let $r$ be a random variable with an associated probability distribution $\pi_r$. To formalize this distribution, we define the indicator function $\bm{1}_x$


We can as such define the probability of sampling $r$ as the probability of sampling an initial condition $x \in \B_{\delta}(x^*)$ such that the corresponding set-valued Poincar\'e map $\P_{\delta}(x)$ is contained within the set $\B_{\delta}(x^*)$. As stated before, this condition is equivalent to the barrier function condition $\min \{H_{\delta}(\P_{\delta}(x))\} \geq (1-\gamma)H_{\delta}(x)$, for some $0 < \gamma \leq 1$.

In Algorithm \ref{alg: givendelta}, it is assumed that $\delta > 0$ is given. Then, by sampling $x' \in \B_{\delta}(x^*)$ with a uniform distribution over $\B_{\delta}(x^*)$, we can implicitly define the probability distribution function $\pi_r$ for the random variable $r$.

-----

To identify the largest $\delta > 0$ such that $\O$ is $\delta$-robust, consider the following optimization problem
\begin{align}
    \label{eq: optdelta}
    (\delta^*, \gamma^*) = &\argmax_{\delta > 0,\gamma \in (0,1]} \gamma \\
    &\text{s.t. } \min \{H_{\delta}(\bm{X}_{1})\} \geq (1-\gamma)H_{\delta}(x_0) \notag \\
    & \quad \forall x_0 \in \B_{\delta}(x^*) \notag
\end{align}

Again, we can use sampling to probabilistically identify $\delta^*$ and $\gamma^*$ using Algorithm \ref{alg: maxdelta}.

\begin{algorithm}[tb]
\caption{Probabilistic Approach to \eqref{eq: optdelta}}\label{alg: maxdelta}
\begin{algorithmic}[1]
\Procedure{}{}
% {$\delta > 0$, $d^-_{\delta} := \inf\{h(x) \mid \B_{\delta}(x^*)\}$, $d^+_{\delta} := \sup\{h(x) \mid \B_{\delta}(x^*)\}$}
\State $\delta' \sim U(\Omega)$
\State Verify $r^*_N \geq 0$ given $\delta'$ using Alg. \ref{alg: givendelta}
\If {$r^*_N \geq 0$}
    \State Add $\delta'$ to $\{\delta_j\}^N_{j=1}$
\Else
    \State Reject $\delta'$
\EndIf
\State $\max\{\delta_j\}^N_{j=1} \rightarrow \delta^*_N$
\State Compute $\Prob_{\pi_{\delta}}^N[\Prob_{\pi_{\delta}}[\delta \leq \delta^*_N] \geq 1 - \varepsilon] \geq 1 - (1-\varepsilon)^N$
\EndProcedure
\end{algorithmic}
\end{algorithm}


%%%%% OLD STUFF!! 
% \subsection{Theoretical Guarantees using Stochastic Processes}

% The discrete-time dynamical system in the presence of uncertain impact events can be considered as a stochastic system:
% $$ x_{k+1} = P_d$$

% Our definition for Hybrid Set Invariant walking can now be extended to the following:
% \begin{definition} 
%     A hybrid system $\H\C$ with a periodic orbit $\O$ is defined as \textit{Robustly Hybrid Set Invariant} if there exists some set $\D := \{x^-_i \in S \oplus S_d \mid \forall d \in [-\gamma,\gamma]\}$ such that $P_d(x^-_i) \in \D$ for all $x^-_i \in \D$ and for all $d \in [-\gamma, \gamma]$. .
% \end{definition}

% \subsection{Proving that an orbit $\O$ is Robustly HSI}
% Let $H$ denote the trajectory of the guard condition $h(x)$ (in our case the vertical position of the swing foot relative to the stance foot) computed by:
% $$ H(x_0,d) := \{ h(\varphi_t(x_0) \mid 0 \leq t \leq T_{e}(x_0,d)\} \in \R.$$ 

% \begin{assumption}
%     We assume that for $x_0 = \Delta(x^*)$, there exists some $\{T_h,h_{\max}\} \in \R^+$ such that the flow of the system $\varphi_t(x_0)$ evolves such that:
%     \begin{small}
%     \begin{numcases}{}
%         h(\varphi_t(x_0)) < h_{\max}, ~\dot{h}(\varphi_t(x_0)) > 0 & $0 \leq t < T_h$, \notag \\
%         h(\varphi_t(x_0)) = h_{\max}, ~\dot{h}(\varphi_t(x_0)) = 0 & $t = T_h$, \notag  \\
%         h(\varphi_t(x_0)) < h_{\max}, ~\dot{h}(\varphi_t(x_0)) < 0 & $T_h < t < T_e(x_0,-\gamma)$, \notag \\
%         h(\varphi_t(x_0)) = -\gamma, ~\dot{h}(\varphi_t(x_0)) < 0 & $t = T_e(x_0,-\gamma)$. \notag
%     \end{numcases}
%     \end{small}
%     \label{assump: swingfoot}
% \end{assumption}

% \begin{figure}
%     \centering
%     \includegraphics[width=\linewidth]{Figures/swingfoot.pdf}
%     \caption{Example Swing Foot Trajectory Satisfying Assumption \ref{assump: swingfoot}.}
%     \label{fig: swingfootassump}
% \end{figure}

% \begin{lemma}
%     Let $H(x_0,-\gamma)$ be a trajectory of the continuous guard condition $h(x) \in \R$ that satisfies Assumption \ref{assump: swingfoot}. If $h_{\max} \geq \gamma$, then %if $h(\varphi_t(\Delta(x^*))) \in \R^+$ is monotonically decreasing for all $t \in [T_h, T_e(x_0,-\gamma)]$, and  then 
%     $$T_e(\Delta(x^*),\gamma) \leq T_e(\Delta(x^*),0) \leq T_e(\Delta(x^*),-\gamma).$$ 
%     \label{lemma: orderedtime}
% \end{lemma}
% \begin{proof}
%     Per assumption \ref{assump: swingfoot}, the evaluation of the guard condition is $h(\varphi_t(x_0)) = \{h_{\max},-\gamma\}$ for $t = \{T_h, T_e(x_0,-\gamma)\}$. Additionally, we know that $h(\varphi_t(x_0))$ is monotonically decreasing in the interval $t \in (T_h,T_e(x_0,-\gamma))$ due to the assumption that in this range, $\dot{h}(\varphi_t(x_0)) < 0$. Thus, by the intermediate value theorem, we know that there must exist some $\{T_e(x_0,\gamma),T_e(x_0,0)\} \in (T_h,T_e(x_0,-\gamma))$ such that $\{h(\varphi_{T_e(x_0,0)}(x_0)),h(\varphi_{T_e(x_0,\gamma)}(x_0)) \} \in (h(\varphi_{T_h}(x_0)), h(\varphi_{T_e(x_0,-\gamma)}(x_0)))$. Additionally, since $h$ is monotonically decreasing in $t \in (T_h,T_e(x_0,-\gamma))$, then $h(\varphi_t(x_0)) = \gamma$ will occur at time $T_e(x_0,\gamma)$ before the height will reach $h(\varphi_t(x_0)) = 0$ at time $T_e(x_0,0)$. Thus, $T_e(x_0,\gamma) \leq T_e(x_0,0) \leq T_e(\Delta(x^*),-\gamma)$. 
% \end{proof}

% For ease of notation, we will denote the flow of our system between the guards $S_{\gamma}$ and $S_{-\gamma}$ as:
% \begin{align}
%     \varphi^*_t(x_0) := \{ \varphi_t(x_0) \mid T_e(x_0,\gamma) \leq t \leq T_e(x_0,-\gamma) \}.
% \end{align}
% \begin{lemma}
%     Consider a periodic orbit $\O$ with a fixed point $x^* \in \S_0$ satisfying $P_{0,0}(x^*) = x^*$. Assuming that $H(x_0,-\gamma)$ satisfies the properties of Assumption \ref{assump: swingfoot} for $x_0 = \Delta(x^*)$ and enforcing $h_{\max} \geq \gamma$, then the following holds:
%     \begin{align}
%         \{T_e(x_0,\gamma),T_e(x_0,-\gamma)\} = \argmax_{t \in R^+} \|\varphi^*_t(x_0) - x^*\|
%     \end{align}
% \end{lemma}
% \begin{proof}
% It is known that $h: \X \to \R$ is continuous with $\dot{h} < 0$ for $t \in [T_e(x_0,\gamma),T_e(x_0,-\gamma)]$. It is also known that the arguments of $h$ (i.e. $\varphi_t(x_0) \in \X$) are also continuous. Thus, since $\|\varphi^*_t(x_0) - x^*\| = 0$ lies in the interior of $t \in [T_e(x_0,\gamma),T_e(x_0,-\gamma)]$ (using the ordering of $T_e(x_0,\gamma) \leq T_e(x_0,0) \leq T_e(\Delta(x^*),-\gamma)$ from Lemma \ref{lemma: orderedtime}), then $h(x)$ must take its largest values at the boundary of the set ($t =\{T_e(x_0,\gamma),T_e(x_0,-\gamma)\}$).
% \end{proof}

% \red{Next, we will assume that the continuous-time flow of some periodic orbit $\O$ satisfies the following assumption. Note that we later prove that this assumption is true for certain bipedal systems.}
% \begin{assumption}
%     Assume that given a periodic orbit $\O$ with a fixed point $P_0(x^*) = x^*$, then $\varphi^*(\Delta(x^*))$ evolves such that for $x_0 := \Delta(x^*) \in \Delta(\S_0)$:
%     \begin{align}
%         \{T_e(x_0,\gamma),T_e(x_0,-\gamma)\} = \argmax_{t \in R^+} \|\Delta(\varphi^*_t(x_0)) - \Delta(x^*)\|
%     \end{align}
%     \label{assumption: maxTreset}
% \end{assumption}

% \begin{lemma}
%     (For systems with one degree of underactuation) If the following is true: 
%     $$\{T_e(x_0,\gamma),T_e(x_0,-\gamma)\} = \argmin_{t \in R^+} \|\Delta(\varphi^*_t(x_0)) - \Delta(x^*)\|, $$
%     then the following is also true:
%     \begin{align}
%         \{T_e(x_0,\gamma),T_e(x_0,-\gamma)\} = \argmin_{t \in R^+} \|P_{i}(\varphi^*_t(x_0)) - x^*\|, \notag \\
%         ~\forall i \in [-\gamma, \gamma]
%     \end{align}
%     \label{lemma: maxTpointcare}
% \end{lemma}
% \begin{proof}
%     \red{? Need to make an argument about the flow $\varphi_t(x_0)$.... I think this also relies on the assumption that you have only one degree of underactuation plus some assumption about your closed loop system (maybe an ISS assumption about $\O$)}
% \end{proof}

% \begin{theorem}
%     Let $\O := \{\varphi_t(\Delta(x^*)) \mid 0 \leq t \leq T_e(\Delta(x^*),0) \}$ be a periodic orbit with a fixed point $x^*\in\S_0$ such that $P_{0,0}(x^*) = x^*$. Also, assume that $H(\Delta(x^*),-\gamma)$ satisfies Assumption \ref{assump: swingfoot}. Denote an early and late impact state associated with the flow $\varphi_t(\Delta(x^*))$ as:
%     \begin{align*}
%         x_e &:= \{\varphi_t(\Delta(x^*)) \in \X \mid t = T_e(\Delta(x^*),\gamma)\}, \\
%         x_l &:= \{\varphi_t(\Delta(x^*)) \in \X \mid t = T_e(\Delta(x^*),-\gamma)\}.
%     \end{align*}
%     Additionally, denote the Poincar\'e return map associated with the Poincar\'e sections $S_{\gamma}$ and $S_{-\gamma}$ as:
%     \begin{align*}
%         P_e(x) := \{ \varphi_{t}(\Delta(x)) \mid t = T_e(\Delta(x),\gamma) \}, \\
%         P_l(x) := \{ \varphi_{t}(\Delta(x)) \mid t = T_e(\Delta(x),-\gamma) \}
%     \end{align*}
%     The orbit $\O$ is \textit{Robustly Hybrid Set Invariant} for the set $\D := \textup{conv}(\{P_e(x_e),P_e(x_l),P_l(x_e),P_l(x_l)\})$ if:
%     \begin{align*}
%         \varphi_t(x_0) \in \D, ~&\forall t \in [T_e(x_0,\gamma),T_e(x_0,-\gamma)], \\
%         &\forall x_0 \in \{P_e(x_e),P_e(x_l),P_l(x_e),P_l(x_l)\}
%     \end{align*}
% \end{theorem}
% \begin{proof}
%     For $\D := \textup{conv}(\{P_e(x_e),P_e(x_l),P_l(x_e),P_l(x_l)\})$, the orbit $\O$ is Robustly HSI if $P_d(x^-_i) \in \D$ for all $d \in [-\gamma,\gamma]$ and for all $x^-_i \in \D$.
%     Following Lemma \ref{lemma: maxTpointcare}, we know that the Poincar\'e map error is maximized for the flow $\varphi_t(x_0)$ evaluated at $t = \{T_e(x_0,\gamma),T_e(x_0,-\gamma)\}$. Thus, it suffices to check the Poincar\'e return map of $x_e$ and $x_l$....
%     By ensuring that the flow $\varphi^*_t(x_0)$ remains within the convex hull of $\D$, then any point within the convex set must also return to $\D$. Thus, $P_d(\D) \in \D$ for any $d \in [-\gamma, \gamma]$.
%     % Furthermore, these pre-impact states will yield the largest subsequent error for the set of states $\D := \{P_e(x_e),P_e(x_l), P_l(x_e), P_l(x_l)\}$. Finally, 
% \end{proof}
