% \begin{algorithm}[tb]
% \caption{Algorithmic Approach to \eqref{eq: optdelta}}\label{alg: optdelta}
% \begin{algorithmic}[1]
% % {$\delta > 0$, $d^-_{\delta} := \inf\{h(x) \mid \B_{\delta}(x^*)\}$, $d^+_{\delta} := \sup\{h(x) \mid \B_{\delta}(x^*)\}$}
% \State \small{$\delta  = 0$, $\chi_0 = 1$, $N$ = number of samples, $\{\Delta \delta, \Delta \chi\} \in \R^+$ = user-defined update parameters, $\chi_{\max} \in \R^+$ = maximum $\chi$}
% \Procedure{TestDelta}{$\delta$, $\chi_{\delta}$}
% \For {$i = [1,\dots,N]$}
% \State Sample $x' = x - x^*$ such that $\|x'\| = \chi_{\delta} \delta $
% \If {\small{$V(\P(x',d)) - V(x') \leq -k\|x'\|^2, ~\forall d \in [-\delta,\delta]$}}
%     \State Repeat TestDelta($\delta + \Delta\delta$,$1$) 
% \Else
%     \If {$\chi_{\delta} >= \chi_{\max}$}
%         \State Terminate with $\delta^* = \delta-\Delta\delta$, $\chi^* = \chi_{\delta^*}$
%     \Else 
%         \State Repeat TestDelta($\delta$,$\chi_{\delta} + \Delta\chi$)
%     \EndIf
% \EndIf
% \EndFor
% \EndProcedure
% \end{algorithmic}
% \end{algorithm}

\section{Algorithmic Verification of $\delta$-Robustness 
% with Application to Robotic Walking
}

\begin{figure}[tb]
    \centering
    \includegraphics[width=\linewidth]{Figures/alg_results.pdf}
    \vspace{-0.6cm}
    \caption{Results of the algorithmic approach to Opt. \eqref{eq: optdelta} for the gaits shown in Fig. \ref{fig: motivation} with the maximum allowable $\chi$ set to $50$. As shown, the gaits were determined to be $\delta$-robust for $\delta^* = 0$ and $\delta^*=6$mm, respectively.}
    \label{fig: algresults}
    \vspace{-0.4cm}
\end{figure}

This section seeks to answer the question: How do we check $\delta$-robustness of a given periodic orbit $\O$?  To answer this question we derive conditions for $\delta$-robustness through the use of robust Lyapunov functions (as introduced in the previous section).  
In particular, we will synthesize an optimization framework for verifying $\delta$-robustness. 

\newsec{Problem Setup}  
% We begin by setting the stage for the proposed verification technique.   In particular, 
Assume the existence of a stable periodic orbit $\O$ and so $x_{k+1} = \P (x_k, 0)$ has an exponentially stable fixed point $x^*$.  For simplicity we will take $x^* = 0$ (achieved via the simple coordinate transformation $x \mapsto x - x^*$).  As a result, the linearization: 
$$
x_{k + 1} = A x_k  := D\P(0,0) x_k
$$
is exponentially stable. Next, the Lyapunov matrix $P = P^T > 0$ is obtained by solving the discrete-time Lyapuov equation: 
$$
A^T P A - P = - Q
$$
for $Q = Q^T > 0$.   The end result is that the discrete-time Lyapunov function $V(x) = x^T P x$ satisfies:
\begin{align}
\label{eqn:lyap1lin}
    \lambda_{\min}(P) \| x  \|^2 \leq V(x)  & \leq \lambda_{\max}(P)  \|   x \|^2  \\
  V(A x) - V(x) &  \leq - \lambda_{\min}(Q) \|  x  \|^2. 
  \label{eqn:lyap2lin}
\end{align}
and thereby establishes exponential stability of the linear system (and the nonlinear system locally).  Unlike stability, it is not guaranteed that this Lyapunov function can be used to establish robustness.  Yet we will use it as a ``guess'' for a robust Lyapunov function in order to develop an algorithm to establish the robustness of a given gait $\O$. 

\newsec{Optimization Problem}  Recall that the invariant set used to establish $\delta$ robustness was defined in Lemma \ref{lem:levelset}, namely $\Omega_{r(\delta)}$.  In this case: 
$$
\Omega_{r(\delta)} = \{ x \in \R^n | V(x) = x^T P x \leq r(\delta) := k_2 (\chi \delta) ^c \}.
$$
Per the proof of Lemma \ref{lem:levelset} we therefore have:
$$
B_{r_1}(0) \subset \Omega_{r(\delta)}  \subset B_{r_2}(0), 
$$
with:
$$
r_1 := \chi \delta, \qquad  r_2 := \left(\frac{\lambda_{\max}(P)}{\lambda_{\min}(P)}\right)^{\frac{1}{2}} \chi \delta. 
$$
Then with the goal of finding the largest $\delta^* > 0$ such that $\O$ is $\delta$ robust, we formulate the following optimization problem: 
\begin{align}
    \label{eq: optdelta}
    (\delta^*,\chi^*) = \argmax_{\delta, \chi > 0} & ~ \delta \\
    \text{s.t. }  & V(\P(x,d)) - V(x)  \leq - k\|  x   \|^2  \notag \\
                  & \quad \forall ~ r_1  < \| x \| < r_2 , \quad \forall ~  d \in [-\delta,\delta], \notag
\end{align}
where $k \in (0,1)$ is a user-defined variable, and we take $Q = I$ (wherein $\lambda_{\min}(Q) = 1$) to remove decision variables.  
%
This optimization problem can be solved algorithmically by slowly increasing $\chi$ for each candidate $\delta$ and checking the Lyapunov condition in \eqref{eq: optdelta} for random samples $x \in B_{r_1}(0)$. 

\begin{figure}[tb]
    \centering
    \includegraphics[width=\linewidth]{Figures/lyapunov_condition.pdf}
    \vspace{-0.6cm}
    \caption{Illustration of the Lyapunov condition in \eqref{eq: optdelta} for 100 random samples $x \in B_{r_1}(0)$ with $d \sim U(-6\textrm{mm},6\textrm{mm})$. As shown, the Lyapunov condition is satisfied for the gait identified as being $\delta$-robust for $\delta = 6$mm with $\chi = 34$ (the corresponding ISS bound is illustrated in Fig. \ref{fig: issresults}).}
    \label{fig: lyapcondition}
\end{figure}

\begin{figure}[tb]
    \centering
    \includegraphics[width=\linewidth]{Figures/ISSResults.pdf}
    \vspace{-0.6cm}
    \caption{Verification of $\delta$-robustness for $\delta^* = 6$mm and $\chi^* = 34$ (selected based on the algorithm results shown in Fig. \ref{fig: algresults}). As shown in the figure, Gait 1 was not $\delta$-robust while Gait 2 was $\delta$-robust with $M$, $\gamma$, and $\alpha$ defined using the relationships derived in Theorem \ref{thm:main} and $V(x) = x^TPx$.}
    \label{fig: issresults}
    \vspace{-0.4cm}
\end{figure}

We demonstrate this algorithmic approach for each of the two gaits illustrated in Fig. \ref{fig: motivation} with the results\footnote{The implementation of the algorithm, as well as its application towards evaluating the $\delta$-robustness of bipedal walking gaits, is provided in the repository: \url{https://github.com/maegant/deltaRobustness.git}} provided in Fig. \ref{fig: algresults}. As expected, the second gait illustrated in Fig. \ref{fig: motivation} and Fig. \ref{fig: exampleissbound} was verified to be $\delta$-robust, with $\delta^* = 6$mm. A visualization of the Lyapunov condition for 100 random samples of $x \in B_{r_1}(0)$ is provided in Fig. \ref{fig: lyapcondition} with the corresponding ISS bound illustrated in Fig. \ref{fig: issresults}. 






























% ---------------------------------------------
\begin{comment}
\textcolor{red}{Maegan: I think the optimization problem in \eqref{eq: optdelta} lends itself easier to be put into an algorithm.  In particular, you could perhaps simplify to only checking equality on with $r_1$: 
\begin{align}
    \label{eq: optdeltaguess}
    (\delta^*,\chi^*) = \argmax_{\delta, \chi > 0} & ~ \delta \\
    \text{s.t. }  & V(\P(x,d)) - V(x)  \leq - \|  x   \|^2  \notag \\
                  & \quad \forall \| x \| = \chi \delta, \quad \forall  d \in [-\delta,\delta] \notag
\end{align}
This, of course, becomes only an optimization problem of $\delta$ if you set $\chi = 1$:
\begin{align}
    \label{eq: optdeltaguess2}
    \delta^* = \argmax_{\delta  > 0} & ~ \delta \\
    \text{s.t. }  & V(\P(x,d)) - V(x)  \leq - \|  x   \|^2  \notag \\
                  & \quad \forall \| x \| =  \delta, \quad \forall  d \in [-\delta,\delta] \notag
\end{align}
although I am not sure if this is reasonable---we might need $\chi$ to scale $x$ relative to the disturbances. 
}
\end{comment}




% \newsec{Optimization Problem Old}  Given $\delta > 0$, let: 
% $$
% r(\delta) := \max\{ r \geq 0 ~ | ~ \Omega_r \subset S_{[-\delta,\delta]}\}
% $$
% where here $\Omega_r = \{ x \in \R^n | V(x) \leq r\}$ is the Lyapunov level set of $V(x) = x^T P x$.  Then with the goal of finding the largest $\delta^* > 0$ such that $\O$ is $\delta$ robust, we formulate the following optimization problem: 
% \begin{align}
%     \label{eq: optold}
%     \delta^* = \argmax_{\delta > 0} & ~ \delta \\
%     \text{s.t. }  & V(\P(x,d)) - V(x)  \leq - \|  x   \|^2  + \frac{1}{2} |d|^2  \notag \\
%                   & \quad \forall x \in \Omega_{r(\delta)}, \quad  d \in [-\delta,\delta] \notag
% \end{align}
% where here we take $Q = I$ (wherein $\lambda_{\min}(Q) = 1$) and $\sigma = 1$ to remove decision variables. 
% %We can, moreover, take $Q = I$ wherein $\lambda_{\min}(Q) = 1$.
% Finally, note that implicit in this formulation is that $\P(x,d)$ is well defined for all $x \in \Omega_{r(\delta)}$ and $d \in [-\delta,\delta]$, wherein it follows that $\Omega_{r(\delta)} \subset B_{\rho}(0)$.  




% Then begin by considering a function $V : \R^n \to \R$ satisfying: 
% $$
% k_1 \| x - x^* \|^2 \leq V(x) \leq k_2 \| x - x^*  \|^2, 
% $$
% for $k_1,k_2 > 0$.  Than to 
