\clearpage
\section{Approximation Error of Neural Network} \label{appendix_approximation_error_NN}
We show that in a function class $\gF$ with sufficient capacity, there exists at least one element $\hat f\in \gF$ such that $R(\hat f)$ is small.
In particular, we are interested in the function class of neural networks.

We will focus on the case where the domain is the torus $\X = \Pi^d$, i.e. a $d$ dimensional box with size $L$ endowed with the periodic boundary condition. For the simplicity of notations, we denote the underlying velocity by $\bar f_t = \gA[\bar \rho_t]$, where the operator $\gA$ is defined in \eqref{eqn_operator_A}.

In the following, we focus on the Coulomb case where $K$ is defined in \eqref{eqn_coulomb_interaction}. The Biot-Savart case (\ref{eqn_nse}) can be treated similarly.
\begin{proof}[Proof of Theorem \ref{thm_approximation_error_NN}]
	In \eqref{eqn_pathwise_reformulation}, we showed that for any hypothesis velocity $f$, the \EINN\ loss $R(f)$ admits the trajectory-wise reformulation:
	\begin{equation}
		R(f) = \int_\X \ud \vx_0 \bar \rho_0(\vx) \int_0^T \ud t\|\delta^f_t\circ X^f_t(\vx_0)\|^2,
	\end{equation}
	where we recall the definition of $\delta^f_t$ in \eqref{eqn_perturbation}. 
    Note that, as a general principle, in this proof, we will use the superscript to emphasize the dependence on a velocity $f$, e.g. the flow map $X^f_t$.
	
	From Assumption \ref{ass_appendix_approximation} we know that there exists $\hat f\in\gF$ such that $\|\bar f - \hat f\|_{W^{2,\infty}(\X)} \leq \epsilon$.
	In the following, we show that $R(\hat f)$ is small.
	
	Define 
	\begin{equation}
		A^f_\vx(t) \defi \int_0^t \|\delta_s^f\circ X_s^f(\vx)\|^2 \ud s.
	\end{equation}
	We have
	\begin{equation}
		R(f) = \int_\X A_\vx^f(T) \ud \bar \rho_0(\vx).
	\end{equation}
	Recall that $\bar f$ denotes the underlying velocity and hence $\delta_t^{\bar f} \equiv 0$ and $\rho_t^{\bar f} \equiv \bar \rho_t$,
	where we recall that $\rho_t^{\bar f}$ is the solution to the continuity equation (\ref{eqn_CE}) with velocity field $\bar f$.
	We can bound
	\begin{align}
		\notag \frac{\partial}{\partial t}A^{\hat f}_x(t) =&\ \|\delta_t^{\hat f}\circ X_t^{\hat f}(\vx)\|^2 = \|\delta_t^{\hat f}\circ X_t^{\hat f}(\vx) - \delta_t^{\bar f}\circ X_t^{\bar f}(\vx)\|^2 \\
		\notag \leq&\ 4\|\left(\hat f_t\circ X_t^{\hat f} - \bar f_t\circ X_t^{\bar f}\right)(\vx)\|^2 + 4\|\left(\nabla V\circ X_t^{\hat f} - \nabla V\circ X_t^{\bar f}\right)(\vx)\|^2 \\
		\notag &\ + 4\|\left((K\ast \rho_t^{\hat f})\circ X_t^{\hat f} - (K\ast \bar \rho_t)\circ X_t^{\bar f}\right)(\vx)\|^2 + 4\nu^2\|\left(\nabla \log \rho_t^{\hat f}\circ X_t^{\hat f} - \nabla \log \bar \rho_t\circ X_t^{\bar f}\right)(\vx)\|^2\\
		= &\ \textcircled{1} + \textcircled{2} + \textcircled{3} + \textcircled{4}. \label{eqn_appendix_decomposition_A}
	\end{align}
	We will bound each term on the R.H.S. individually.
	The following lemmas will be useful:
	\begin{lemma} \label{lemma_appendix_Lipschitz_X_t_f}
		For two Lipschitz continuous velocity field $f_1, f_2 \in \gC^1(\X)$, we have for any $t\in[0, T]$
		\[
		\|X_t^{f_1}(\vx) - X_t^{f_2}(\vx)\|^2 \leq A_1(T)\|f_1 - f_2\|^2_{\gL^\infty(\X)}.
		\]
	\end{lemma}
    \begin{proof}
        Denote $\vx^i(t) = X_t^{f_i}(\vx_0)$ for $i = 1, 2$.
        \begin{align*}
            \frac{\ud }{\ud t}\|\vx^1(t) - \vx^2(t)\|^2 \leq&\ \|\vx^1(t) - \vx^2(t)\|^2 + \|f_1(t, \vx^1(t)) - f_2(t, \vx^2(t))\|^2\\
            \leq &\ C \|\vx^1(t) - \vx^2(t)\|^2 + \|f_1(t, \vx^2(t)) - f_2(t, \vx^2(t))\|^2 \\
            \leq &\ C \|\vx^1(t) - \vx^2(t)\|^2 + \|f_1 - f_2\|^2_{\gL^\infty(\X)}.
        \end{align*}
        Using the Gr\"onwall's inequality, we have the result.
    \end{proof}
	\begin{lemma} \label{lemma_appendix_Lipschitz_X_t}
		Suppose that $f\in \gC^1$ is Lipschitz continuous. We have that $X_t^f$ is an $A_2(T)$-Lipschitz continuous map. 
		For $f \in \gL^\infty(\X)$, we have $\|X_t^f(\vx)\|^2 \leq \|x\|^2 + t\|f\|^2_{\gL^\infty}$.
	\end{lemma}
    \begin{proof}
        Denote $\vx^i(t) = X_t^{f}(\vx^i_0)$ for $i = 1, 2$.
        \begin{align*}
            \frac{\ud }{\ud t}\|\vx^1(t) - \vx^2(t)\|^2 \leq&\ \|\vx^1(t) - \vx^2(t)\|^2 + \|f(t, \vx^1(t)) - f(t, \vx^2(t))\|^2\\
            \leq &\ C\|\vx^1(t) - \vx^2(t)\|^2.
        \end{align*}
        Using the Gr\"onwall's inequality, we have that $X_t^f$ is Lipschitz continuous.
        % Further, denote $\vx(t) = X_t^{f}(\vx_0)$. We have
        % \begin{align*}
        %     \frac{\ud }{\ud t}\|\vx(t)\|^2 \leq \|\vx(t)\|^2 + \|f(t, \vx(t))\|^2 \leq C\|\vx(t)\|^2.
        % \end{align*}
        % Using the Gr\"onwall's inequality, we have that $X_t^f$ is linearly bounded.
    \end{proof}
	\begin{lemma}
		For $f \in \gC^2(\X)$, suppose that $\nabla (\udiv  f)\in \gL^\infty(\X)$ and $\gJ_f \in \gL^\infty(\X)$. 
        Further suppose that the initial distribution $\bar \rho_0$ satisfies $\nabla \log \bar \rho_0 \in \gL^\infty(\X)$.
        We have that $\nabla \log \rho_t^f\circ X_t^f \in \gL^\infty(\X)$.
	\end{lemma}
    \begin{proof}
        Denote $\vx(t) = X_t^{f}(\vx_0)$. From \eqref{eqn_dynamics_of_score}, we have
        \begin{equation}
           \frac{\ud }{\ud t} \|\nabla \log \rho_t^f(\vx(t))\|^2 \leq C (1+\|\nabla \log \rho_t^f(\vx(t))\|^2).
        \end{equation}
        Using the Gr\"onwall's inequality, we have $\|\nabla \log \rho_t^f(\vx(t))\|^2 < \infty$ for $\vx_0 \in \X$.
    \end{proof}
	\paragraph{Bounding \textcircled{1} in \eqref{eqn_appendix_decomposition_A}}
	We have
	\begin{align*}
		\notag &\ \|\left(\hat f_t\circ X_t^{\hat f} - \bar f_t\circ X_t^{\bar f}\right)(\vx)\| \\
		\leq &\ \|\left(\hat f_t\circ X_t^{\hat f} - \bar f_t\circ X_t^{\hat f}\right)(\vx)\| + \|\left(\bar f_t\circ X_t^{\hat f} - \bar f_t\circ X_t^{\bar f}\right)(\vx)\| \\
		\leq &\ \epsilon + \epsilon \cdot \| X_t^{\hat f}(\vx) - X_t^{\bar f}(\vx)\| \leq C_1(T) \epsilon.
	\end{align*}
	\paragraph{Bounding \textcircled{2} in \eqref{eqn_appendix_decomposition_A}}
	We have from Assumption \ref{ass_appendix_approximation} and Lemma \ref{lemma_appendix_Lipschitz_X_t_f}
	\begin{align*}
		\|\left(\nabla V\circ X_t^{\hat f} - \nabla V\circ X_t^{\bar f}\right)(\vx)\| \leq C_2(T) \epsilon.
	\end{align*}
	\paragraph{Bounding \textcircled{3} in \eqref{eqn_appendix_decomposition_A}}
	Bounding \textcircled{3} in \eqref{eqn_appendix_decomposition_A} requires a more sophisticated analysis which is the major technical challenge of this proof. 
	For the simplicity of notations, for a fixed $x$ and $y$, denote $\hat \vx(t) = X_t^{\hat f}(\vx)$, $\bar \vx(t) =  X_t^{\bar f}(\vx)$, $\hat \vy(t) = X_t^{\hat f}(\vy)$, $\bar \vy(t) =  X_t^{\bar f}(\vy)$. For any $\epsilon'$ which is to be determined later, we have
	\begin{align}
		\notag &\ \|\left((K\ast \rho_t^{\hat f})\circ X_t^{\hat f} - (K\ast \bar \rho_t)\circ X_t^{\bar f}\right)(\vx)\|^2
		= \| \int_\X K(\hat \vx(t) - \hat \vy(t)) - K(\bar \vx(t) - \bar \vy(t)) \ud \bar \rho_0(\vy)\|^2\\
		\tag{\textcircled{A}}\leq &\ 2\| \int_{\|\hat \vx(t) - \hat \vy(t)\|\leq \epsilon'} K(\hat \vx(t) - \hat \vy(t)) - K(\bar \vx(t) - \bar \vy(t)) \ud \bar \rho_0(\vy)\|^2\\
		\tag{\textcircled{B}} &\ + 2\| \int_{A_2(T)L\geq \|\hat \vx(t) - \hat \vy(t)\|\geq \epsilon'} K(\hat \vx(t) - \hat \vy(t)) - K(\bar \vx(t) - \bar \vy(t)) \ud \bar \rho_0(\vy)\|^2.
	\end{align}
	Note that the upper bound on $\|\hat \vx(t) - \hat \vy(t)\|$ in \textcircled{B} comes from Lemma \ref{lemma_appendix_Lipschitz_X_t} and the facts that $\X = \Pi^d$ is bounded with size $L$.
	To bound \textcircled{A}, we have
	\begin{align*}
		&\ \| \int_{\|\hat \vx(t) - \hat \vy(t)\|\leq \epsilon'} K(\hat \vx(t) - \hat \vy(t)) - K(\bar \vx(t) - \bar \vy(t)) \ud \bar \rho_0(\vy)\| \\
		\leq &\  \int_{\|\hat \vx(t) - \hat \vy(t)\|\leq \epsilon'} \|K(\hat \vx(t) - \hat \vy(t))\| + \|K(\bar \vx(t) - \bar \vy(t))\| \ud \bar \rho_0(\vy)\\
		= &\ \int_{\|\hat \vx(t) - \hat \vy(t)\|\leq \epsilon'} \frac{1}{\|\hat \vx(t) - \hat \vy(t)\|^{d-1}} + \frac{1}{\|\bar \vx(t) - \bar \vy(t)\|^{d-1}} \ud \bar \rho_0(\vy) = \textcircled{C} + \textcircled{D}.
	\end{align*}
	We can bound \textcircled{C} by
	\begin{align}
		&\ \int_{\|\hat \vx(t) - \hat \vy(t)\|\leq \epsilon'} \frac{1}{\|\hat \vx(t) - \hat \vy(t)\|^{d-1}} \ud \bar \rho_0(\vy) = \int_{\|\hat \vx(t) - y\|\leq \epsilon'} \frac{1}{\|\hat \vx(t) - y\|^{d-1}} \ud \rho^{\hat f}_t(\vy) \leq \|\rho^{\hat f}_t\|_{\infty}\cdot \epsilon',
	\end{align}
	where in the above inequality we remove the singular term by using transforming to the polar coordinate system.
	To bound \textcircled{D}, we pick $\epsilon' = dA_1(T)\epsilon$, so that Lemma \ref{lemma_appendix_Lipschitz_X_t_f} implies 
	\begin{equation*}
		\{ y\in\X | \|\hat \vx(t) - \hat \vy(t)\|\leq \epsilon'\} \subseteq \{y\in\X | \|\bar \vx(t) - \bar \vy(t)\|\leq \frac{d+2}{d}\epsilon'\},
	\end{equation*}
	and consequently
	\begin{equation}
		\int_{\|\hat \vx(t) - \hat \vy(t)\|\leq \epsilon'} \frac{1}{\|\bar \vx(t) - \bar \vy(t)\|^{d-1}} \ud \bar \rho_0(\vy) \leq \int_{\|\bar \vx(t) - \bar \vy(t)\|\leq 2\epsilon'} \frac{1}{\|\bar \vx(t) - \bar \vy(t)\|^{d-1}} \ud \bar \rho_0(\vy) \leq \frac{d+2}{d} \|\rho^{\hat f}_t\|_{\infty}\cdot \epsilon'.
	\end{equation}
	To bound \textcircled{B}, note that
	\begin{equation}
		\nabla K(\vx) = \frac{1}{\|x\|^{d+2}}(\|x\|^2 I - d\cdot x\otimes x) \Rightarrow \|\nabla K(\vx)\|\leq \frac{d}{\|x\|^{d}}.
	\end{equation}
	Denote $\vz(t) = \min(\|\hat \vx(t) - \hat \vy(t)\|, \|\bar \vx(t) - \bar \vy(t)\|)$.
%	and define
%	\begin{equation}
%		\tilde X_t = \begin{cases}
%			X_t^{\hat f} &\text{if}\quad  \|\hat \vx(t) - \hat \vy(t)\| \leq \|\bar \vx(t) - \bar \vy(t)\| \\
%			X_t^{\bar f} &\text{otherwise}
%		\end{cases}
%	\end{equation}
	Recall the choice of $\epsilon' = dA_1(T)\epsilon$.
	Using Lemma \ref{lemma_appendix_Lipschitz_X_t_f}, we have that 
	\begin{equation*}
%		\{ y\in\X | \|\hat \vx(t) - \hat \vy(t)\|\geq \epsilon'\} \subseteq \{y\in\X | \|\vz(t)\|\geq \frac{d-2}{d}\epsilon'\}.
		\|\vz(t)\| \geq \frac{d-2}{d} \|\hat \vx(t) - \hat \vy(t)\|.
	\end{equation*}
	
	
%	Using the triangle inequality, we have
%	\begin{align}
%		&\ \| \int_{\|\hat \vx(t) - \hat \vy(t)\|\geq \epsilon'} K(\hat \vx(t) - \hat \vy(t)) - K(\bar \vx(t) - \bar \vy(t)) \ud \bar \rho_0(\vy)\| \\
%		\leq &\ \int_{\|\hat \vx(t) - \hat \vy(t)\|\geq \epsilon'} \|K(\hat \vx(t) - \hat \vy(t)) - K(\bar \vx(t) - \bar \vy(t))\| \ud \bar \rho_0(\vy)\\
%		\leq &\ 2\epsilon' d\int_{\|\vz(t)\|\geq .5\epsilon'} \frac{1}{\|\vz(t)\|^{d}} \ud \bar \rho_0(\vy) = 2\epsilon' d \max \{\|\rho^{\hat f}_t\|_{\infty}, \|\bar \rho_t\|_{\infty}\} \int_{\|z\|\geq .5\epsilon'} \frac{1}{\|z\|^d} \ud z \\
%		=&\ 2\epsilon' d \max \{\|\rho^{\hat f}_t\|_{\infty}, \|\bar \rho_t\|_{\infty}\} \ln (\|\vz(t)\|_\infty/\epsilon')
%	\end{align}

	Using the triangle inequality, we have
	\begin{align*}
		&\ \| \int_{A_2(T)L \geq\|\hat \vx(t) - \hat \vy(t)\|\geq \epsilon'} K(\hat \vx(t) - \hat \vy(t)) - K(\bar \vx(t) - \bar \vy(t)) \ud \bar \rho_0(\vy)\| \\
		\leq &\ \int_{A_2(T)L \geq\|\hat \vx(t) - \hat \vy(t)\|\geq \epsilon'} \|K(\hat \vx(t) - \hat \vy(t)) - K(\bar \vx(t) - \bar \vy(t))\| \ud \bar \rho_0(\vy)\\
		\leq &\ 2\epsilon' d\int_{A_2(T)L \geq\|\hat \vx(t) - \hat \vy(t)\|\geq \epsilon'} \frac{1}{\|\vz(t)\|^{d}} \ud \bar \rho_0(\vy) \\
		\leq &\ 2\epsilon' d\int_{A_2(T)L \geq\|\hat \vx(t) - \hat \vy(t)\|\geq \epsilon'} (\frac{d}{d-2})^d\frac{1}{\|\hat \vx(t) - \hat \vy(t)\|^{d}} \ud \bar \rho_0(\vy) \\
		\leq &\ 2e\epsilon' d \|\rho^{\hat f}_t\|_{\infty} \int_{A_2(T)L \geq \|\hat \vx(t) - y\|\geq .5\epsilon'} \frac{1}{\|y\|^d} \ud y \\
		=&\ 2e\epsilon' d \|\rho^{\hat f}_t\|_{\infty} \ln (A_2(T)L/\epsilon').
	\end{align*}

	Combining the bounds of \textcircled{A} and \textcircled{B}, we have that 
	\begin{equation}
		\textcircled{3} \leq C_3(T) (\epsilon \ln\frac{1}{\epsilon})^2.
	\end{equation}
	\paragraph{Bounding \textcircled{4} in \eqref{eqn_appendix_decomposition_A}}
	Denote $\hat \vx(t) = X_t^{\hat f}(\vx)$ and $\bar \vx(t) =  X_t^{\bar f}(\vx)$.
	Define
	\begin{equation}
		B_\vx(t) \defi \|\left(\nabla \log \rho_t^{\hat f}\circ X_t^{\hat f} - \nabla \log \bar \rho_t\circ X_t^{\bar f}\right)(\vx)\|^2 = \|\nabla \log \rho_t^{\hat f}(\hat{\vx}(t)) - \nabla \log \bar \rho_t(\bar{\vx}(t))\|^2.
	\end{equation}
	Computing its dynamics
	\begin{equation}
		\frac{\ud }{\ud t} B_\vx(t) \leq B_\vx(t) + \|\frac{\ud }{\ud t}\left(\nabla \log \rho_t^{\hat f}(\hat{\vx}(t)) - \nabla \log \bar \rho_t(\bar{\vx}(t))\right)\|^2
	\end{equation}
	Recall \eqref{eqn_dynamics_of_score}. We have that 
	\begin{equation}
		\frac{\ud }{\ud t} \nabla \log \rho_t^{\hat f}(\hat \vx(t)) = - \nabla  \left(\nabla \cdot \hat f_{t}(\hat \vx(t))\right) -   \left(\gJ_{\hat f_{t}}(\hat \vx(t))\right)^\top \nabla \log \rho_{t}^{\hat f}(\hat \vx(t)),
	\end{equation}
	\begin{equation}
		\frac{\ud }{\ud t} \nabla \log \rho_t^{\bar  f}(\bar  \vx(t)) = - \nabla  \left(\nabla \cdot \bar  f_{t}(\bar  \vx(t))\right) -   \left(\gJ_{\bar  f_{t}}(\bar  \vx(t))\right)^\top \nabla \log  \rho_{t}^{\bar  f}(\bar  \vx(t)),
	\end{equation}
	and hence
	\begin{align*}
		&\ \|\frac{\ud }{\ud t}\left(\nabla \log \rho_t^{\hat f}(\hat{\vx}(t)) - \nabla \log \bar \rho_t(\hat{\vx}(t))\right)\|^2 \\
		\leq &\ 2\|\nabla  \left(\nabla \cdot \hat f_{t}(\hat \vx(t))\right) - \nabla  \left(\nabla \cdot \bar  f_{t}(\bar  \vx(t))\right)\|^2 
		 + 2\|\left(\gJ_{\hat f_{t}}(\hat \vx(t))\right)^\top \nabla \log \rho_{t}^{\hat f}(\hat \vx(t)) - \left(\gJ_{\bar  f_{t}}(\bar  \vx(t))\right)^\top \nabla \log  \rho_{t}^{\bar  f}(\bar  \vx(t))\|^2 \\
		= &\ \textcircled{E} + \textcircled{F}.
	\end{align*}
	We now bound these two terms individually. To bound \textcircled{E},
	\begin{align*}
		&\ \|\nabla  \left(\nabla \cdot \hat f_{t}(\hat \vx(t))\right) - \nabla  \left(\nabla \cdot \bar  f_{t}(\bar  \vx(t))\right)\| \\
		\leq &\ \|\nabla  \left(\nabla \cdot \hat f_{t}(\hat \vx(t))\right) - \nabla  \left(\nabla \cdot \hat  f_{t}(\bar  \vx(t))\right)\| + \|\nabla  \left(\nabla \cdot \hat f_{t}(\bar \vx(t))\right) - \nabla  \left(\nabla \cdot \bar  f_{t}(\bar  \vx(t))\right)\| \leq \epsilon + LA_1(T)\epsilon.
	\end{align*}
	To bound \textcircled{F}
	\begin{align*}
		&\ \|\left(\gJ_{\hat f_{t}}(\hat \vx(t))\right)^\top \nabla \log \rho_{t}^{\hat f}(\hat \vx(t)) - \left(\gJ_{\bar  f_{t}}(\bar  \vx(t))\right)^\top \nabla \log  \rho_{t}^{\bar  f}(\bar  \vx(t))\|^2\\
		\leq &\ 2\|\left(\left(\gJ_{\hat f_{t}}(\hat \vx(t))\right)^\top - \left(\gJ_{\bar  f_{t}}(\bar  \vx(t))\right)^\top\right) \nabla \log  \rho_{t}^{\hat  f}(\hat  \vx(t))\|^2 + 2\|\left(\gJ_{\bar f_{t}}(\bar \vx(t))\right)^\top \left(\nabla \log \rho_{t}^{\hat f}(\hat \vx(t)) - \nabla \log  \rho_{t}^{\bar  f}(\bar  \vx(t))\right)\|^2\\
		\leq &\ 2(1 + LA_1(T))^2\epsilon^2 + 2L^2 B_x(t).
	\end{align*}
	Consequently, using Gr\"onwall's inequality, we have that
	\begin{equation}
		\textcircled{4} \leq C_4(T)\epsilon^2.
	\end{equation}


	Combining all the estimations for \textcircled{1} to \textcircled{4}, we have that
	\begin{equation}
		R(\hat f) \leq C(T) \epsilon^2 (\ln \frac{1}{\epsilon})^2,
	\end{equation}
	for some constant $C(T)$ independent of $\epsilon.$
\end{proof}
