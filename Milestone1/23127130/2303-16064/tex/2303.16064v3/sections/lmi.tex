\section{Finite Moment Program}
\label{sec:lmi}

This section will apply the moment-\ac{SOS} hierarchy of \acp{SDP} to develop upper-bounds of \eqref{eq:var_meas_soc} and \eqref{eq:peak_cvar_meas}.



% This section will upper-bound \eqref{eq:var_meas_soc} utilizing a converging hierarchy of \acp{SDP} of increasing size. 

% Such an approach will require the following assumptions

\subsection{Review of Moment-SOS Hierarchy}

Refer to \cite{lasserre2009moments} for a more complete introduction to concepts reviewed in this subsection.
Letting $\bm = \{\bm_\alpha\}_{\alpha\in\N^n} \in \R^{\N^n}$ be a multi-indexed vector, we can define a Riesz linear functional  $L_\bm: \ \R[x] \rightarrow \R$ as
% All content from this subsection is referenced from \cite{lasserre2009moments}.
% For any multi-indexed sequence $\bm = \{\bm_\alpha\}_{\alpha\in\N^n} \in \R^{\N^n}$, we define the Riesz functional $L_\bm: \ \R[x] \rightarrow \R$ as follows:
\begin{subequations}
\begin{equation}
\label{eq:riesz}
    \begin{array}{ccc}
      p(x) = \sum\limits_{\alpha\in\N^n} p_\alpha x^\alpha & \longmapsto & \textstyle L_\bm p = \sum\limits_{\alpha\in \N^n} p_\alpha \bm_\alpha.
    \end{array}
\end{equation}
%  \R[x] & \longrightarrow & \R \\


For any measure $\mu \in \Mp{X}$ and multi-index $\alpha \in \N^n$, the $\alpha$-moment of $\mu$ is $\bm_\alpha = \inp{x^\alpha}{\mu}$. The infinite-dimensional moment sequence $\bm = \{\bm_\alpha\}_{\alpha \in \N^n}$ is related to the linear functional $L_\bm$ by
% Let $\mu \in \Mp{X}$ be a measure. The $\alpha$-moment of $\mu$ for $\alpha \in \N^n$ is $\bm_\alpha = \inp{x^\alpha}{\mu}$. The collection of moments $\bm = \{\bm_\alpha\}_{\alpha \in \N^n}$ is a moment sequence and has the following property:
\begin{equation}
    \label{eq:momriesz}
    \forall p \in \R[x], \quad L_\bm p = \inp{p}{\mu}.
\end{equation}
\end{subequations}





%Corresponding to a moment sequence $\bm$, there exists a unique Riesz linear functional $L_\bm$ that acts on polynomials $g(x)=\sum_{\alpha\in \N^n} g_\alpha x^\alpha \in \R[x]$ with,
%\begin{equation}
%\label{eq:riesz}
%    \textstyle L_\bm g(x) = L_\bm \sum_{\alpha\in \N^n} g_\alpha x^\alpha = \sum_{\alpha\in \N^n} g_\alpha \bm_\alpha.
%\end{equation}

%A moment matrix $\M[x]$ is an infinite-dimensional matrix indexed by $(\alpha, \beta) \in \N^n$ under the relation $\M[x]_{\alpha, \beta} = \bm_{\alpha + \beta}$. A necessary condition for an infinite moment sequence $\tilde{\bm}$ to have a \textit{representing measure} $\mu \in \Mp{X}$ such that $\tilde{\bm}_\alpha = \inp{x^\alpha}{\mu}$ is $\M[x] \succeq 0$.





% A key result to build the moment-SOS hierarchy is the characterization of sequences $\bm$ that correspond to moment sequences, i.e. such that \eqref{eq:momriesz} holds for some $X \subset \R^n$ and some $\mu \in \Mp{X}$:

Given a moment sequence $\bm \in \R^{\N^n}$  and a polynomial $h \in \R[x]$, a localizing bilinear functional can be defined by $L_{h \bm}: \R[x] \times \R[x] \longrightarrow \R$ by
\begin{equation}
    L_{h\bm} = (p,q) \longmapsto L_\bm(hpq).
\end{equation}

The cone of polynomials $\R[x]$ can be treated as a vector space with a linear basis $(e_i)_{i\in\N}$ (e.g. $e_i(x) = x^{\alpha_i}$ with $\{\alpha_i\}_{i\in\N} = \N^n$ and a monomial ordering $|\alpha_i| < |\alpha_j| \Rightarrow i<j$). The bilinear functional $L_{h \bm}$ has a representation as a quadratic form operating on an infinite-size localizing matrix $\M[h\bm]$ with $\M[h\bm] = (L_\bm(h \, e_i \, e_j))_{i,j \in \N}$. The expression for $\M[h\bm]$ when $\{e_j\}$ is the set of ordered monomials leads to
\begin{equation}
    \label{eq:repmat}
    \M[h\bm]_{i,j} 
    = L_\bm(h x^{\alpha_i} x^{\alpha_j})
    = \sum_{\beta\in\N^n} h_\beta \bm_{\alpha_i+\alpha_j+\beta}.
\end{equation}


% For $\bm \in \R^{\N^n}$ and $h \in \R[x]$, we define the localizing bilinear functional $L_{h \bm}: \R[x] \times \R[x] \longrightarrow \R$ by
% \begin{subequations}
% \begin{equation}
%     L_{h\bm} = (p,q) \longmapsto L_\bm(hpq).
% \end{equation}
% Equipping $\R[x]$ with a linear basis $(e_i)_{i\in\N}$ (e.g. $e_i(x) = x^{\alpha_i}$ with $\{\alpha_i\}_{i\in\N} = \N^n$, an ordering of monomials such that $|\alpha_i| < |\alpha_j| \Rightarrow i<j$) yields an infinite size matrix representation of $L_{h\bm}$, which we call the localizing matrix $\M[h\bm] = (L_\bm(h \, e_i \, e_j))_{i,j \in \N}$. For instance, if $h(x) = \sum_{\beta\in\N^n} h_\beta x^\beta$, using a basis of monomials with nondecreasing degrees yields, for all $i,j \in \N$
% \begin{equation}
%     \label{eq:repmat}
%     \M[h\bm]_{i,j} 
%     = L_\bm(h x^{\alpha_i} x^{\alpha_j})
%     = \sum_{\beta\in\N^n} h_\beta \bm_{\alpha_i+\alpha_j+\beta}.
% \end{equation}
% \end{subequations}

\Iac{BSA} set $\K = \{x \mid h_k(x) \geq 0: \ k = 1..N_c\}$ is a set defined by a finite number of bounded-degree polynomial inequality constraints $h_k(x) \geq 0$.
We refer to any set $\K$ that has $h_1(x) = 1$ and $h_{N_c} = R - \norm{x}_2^2$ with $R>0$ as satisfying `ball constraints,' and note that such an $R>0$ can be chosen for any compact set. 
For any set obeying ball constraints, then there exists a representing measure $\mu$ for the sequence of numbers (pseudomoments) $\bm$ if each localizing matrix is \ac{PSD}:
\begin{equation}
    \label{eq:truncputinar}
    \forall \N, k=1..N_c, \quad \M[h_k\bm] \succeq 0.
\end{equation}

For a finite $d \in \N$, a sufficient condition for \eqref{eq:truncputinar} to hold is that the upper-left corner of $\M[h_k \bm]$ containing moments up to degree $2d$ (expressed as $\M_d[h_k \bm]$) is \ac{PSD}. The truncated matrix  $\M_d[h_k\bm]$ represents the bilinear operator $L_{h \bm}$ in the finite-dimensional vector space $\R[x]_{\leq d}$, and has size $\binom{n+d}{d}$ when $\{e_i\}$ is a monomial basis.


We will define the degree-$d$ block-diagonal matrix composed of localizing matrices for constraints of $\K$ as
% For notational convenience, we define the block diagonal synthetic matrix
\begin{equation}
    \M_d[\K\bm] = \mathrm{diag}(\M_{d-\lceil d_k/2 \rceil} [h_k \bm])_{k=1..N_c}. \label{eq:block_synthetic}
\end{equation}



The moment-\ac{SOS} hierarchy is the process of raising the degree $d$ to $\infty$ while imposing that the matrix in \eqref{eq:block_synthetic} is \ac{PSD}. 


% is the top left block of size $\binom{n+d}{d}$ of $\M[h_k\bm]$, which corresponds to the matrix representation of $L_{h\bm}$ in the finite dimensional space $\R[x]_{\leq d}$.









% \Iac{BSA} set is a set defined by a finite number of bounded-degree inequality constraints such as $\K = \{x \mid h_k(x) \geq 0: \ k = 1..N_c\}$.
% %The localizing matrix associated with constraint polynomial  $g_k(x) = \sum_{\gamma \in \R^n} g_{k \gamma} x^\gamma$ with respect to the moment sequence $\bm$ is $\M[g_k x]_{\alpha, \beta} = \sum_{\gamma \in \R^n} g_{k \gamma} \bm_{\alpha+\beta+\gamma}$. The notation $\M[\K x]$ will refer to the block-diagonal matrix formed by $\M[x]$ and $\M[g_k x]$ for $k=1..N_c$.
% Assuming ``ball constraints'' $h_1(x) = 1$ and $h_{N_c}(x) = R - \norm{x}_2^2$ (this can always be enforced if $\K$ is compact in $\R^n$, up to adding redundant constraints), $\bm \in \R^{\N^n}$ has a representing measure $\mu \in \Mp{\K}$ such that \eqref{eq:momriesz} holds if, for all $k = 1..N_c$, the bilinear functional $L_{h_k\bm}$ is positive semidefinite, i.e.
% \begin{subequations} \label{eq:putinar}
% \begin{equation}
%     \label{eq:infputinar}
%     \forall p \in \R[x], k = 1..N_c, \quad L_\bm(h_kp^2) \geq 0.
% \end{equation}
% or, equivalently,
% \begin{equation}
%     \label{eq:truncputinar}
%     \forall d \in \N, k=1..N_c, \quad \M_d[h_k\bm] \succeq 0.
% \end{equation}
% where $\M_d[h_k\bm]$ is the top left block of size $\binom{n+d}{d}$ of $\M[h_k\bm]$, which corresponds to the matrix representation of $L_{h\bm}$ in the finite dimensional space $\R[x]_{\leq d}$.
% \end{subequations}

% %Assuming that the set $\{g_k(x)\}_{k=1}^{N_c}$ satisfies an \textit{Archimedean} condition (slightly stronger than compactness), then there exists a representing measure $\bm \in \M[\K]$ corresponding to an infinite moment sequence $\tilde{\bm}$ if $\M[\K] \succeq 0$. For every compact set $\K$, there exists an $R>0$ such that $\{x \mid \norm{x}_2^2 \leq R\} \subseteq \K$. Adjoining the constraint polynomial $R-\norm{x}_2^2 \geq 0$ to the \ac{BSA} set $\K$ will result in an Archimedean set. 

% For notational convenience, we define the block diagonal synthetic matrix
% \begin{equation}
%     \M_d[\K\bm] = \mathrm{diag}(\M_{d-\lceil d_k/2 \rceil} [h_k \bm])_{k=1..N_c}
% \end{equation}
% where $d_k = \deg(h_k)$. This synthetic matrix has two important properties, deduced from \eqref{eq:repmat} and \eqref{eq:truncputinar}:
% \begin{itemize}
%     \item it exactly involves all the terms $\bm_\alpha$ for $|\alpha| \leq 2d$
%     \item \eqref{eq:putinar} holds if and only if $\M_d[\K\bm] \succeq 0$ for all $d \in \N$.
% \end{itemize}

% %The order-$d$ truncation of a moment matrix $\M[x]$ is the $\binom{n+d}{d}$-sized \ac{PSD} matrix $\M_d[x]$ containing moments up to degree $2d$ (assuming the monomial basis for $x$ is used). If the constraint polynomial $g_k(x)$ has degree $d_k$, then the submatrix of the localizing matrix $\M[g_k x]$ containing moments of up to degree $2d$ is of order $d-\ceil{d_k/2}$ and has size $\binom{n+d-\ceil{d_k/2}}{d-\ceil{d_k/2}}$. 
% The process of increasing the degree $d \rightarrow \infty$ when posing \ac{PSD} constraints on $\M_d[\K\bm]$ is called the moment-\ac{SOS} hierarchy.
% % The order-$d$ truncation of a localizing matrix $\M[g_k x]$ also contains moments of degree $2d$, and therefore is indexed according to multi-indices up to degree $d - d_k$
% % Assume that each constraint polynomial $g_k$ has degree $d_k$.

\subsection{Chance-Peak Moment Setup}

% {Matteo: the degree bounds did not match, so I modified them accordingly.}

We require polynomial-structuring assumptions in order to approximate \eqref{eq:var_meas_soc} and \eqref{eq:peak_cvar_meas} using the moment-\ac{SOS} hierarchy:

\begin{itemize}
    \item[A8] The sets $X_0$ and $X$ are both \ac{BSA} with ball constraints.
    \item[A9] The generator $\Lie$ satisfies $\forall v \in \R[t, x], \ \Lie v \in \R[t, x]$.
    \item[A10] The objective function $p(x)$ is also polynomial.
\end{itemize}

% Let $\bm^0$ be the moment sequence associated to the fixed initial measure $\mu_0 \in \Mp{X_0}$. 
Let $(\bm, \bm^\tau)$ be pseudomoments for the optimization variables $(\mu, \mu_\tau)$. For each $\alpha \in \N^n$ and $\beta \in \N$ producing the monomial $x^\alpha t^\beta$, we define the operator $\mathcal{D}_{\alpha \beta}$ as the moment expression for the generator $\Lie$ with
\begin{equation}
    \label{eq:dyn_mom}
    \mathcal{D}_{\alpha \beta}(\bm, \bm^\tau) =
        \bm^\tau_{\alpha\beta} - L_\bm(\Lie(x^\alpha t^\beta)).
\end{equation}

We further define a dynamics degree $D$ as a function of the degree $d$ such that 
\begin{align}
    \deg x^\alpha t^\beta \leq 2d \implies \deg \Lie x^\alpha t^\beta \leq 2D.
\end{align}

% In the rest of this section, we will assume that $2 d \geq \deg p$.

% \urg{old below}

% Given an initial measure $\mu_0 \in \Mp{X_0}$, let $(\bm, \bm^\tau)$ be moment sequences corresponding to the measures $(\mu, \mu_\tau)$ respectively. For each monomial $x^\alpha t^\beta$ with $\alpha \in \N^n, \beta \in \N$, define the operator $\mathcal{D}_{\alpha \beta}(\bm, \bm^\tau)$ as the moment counterpart of the operator involved in Dynkin's formula \eqref{eq:dynkin}
% \begin{equation}
%     \label{eq:dyn_mom}
%     \mathcal{D}_{\alpha \beta}(\bm, \bm^\tau) =
%         \bm^\tau_{\alpha\beta} - L_\bm(\Lie(x^\alpha t^\beta)).
% \end{equation}

%\begin{align}
%\label{eq:dyn_mom}
%    \inp{x^\alpha}{\mu_0} \delta_{\beta 0} + \inp{\Lie( x^\alpha t^\beta)}{\mu} - \inp{x^\alpha t^\beta}{\mu_\tau} &= 0.
%\end{align}

% Define the dynamics degree $D$ as 
% \begin{equation}
%     D= d + \lceil \max(\deg f-1, 2 \deg g - 2)/2 \rceil.
% \end{equation}
% so that for $(\alpha,\beta) \in \N^{n+1}$, $$|\alpha| + \beta \leq 2d \Rightarrow \deg(\Lie(x^\alpha t^\beta)) \leq 2D.$$
% %The expression $\mathcal{D}_{\alpha \beta}$ exactly involves the moments up to degree $2d$.

\subsection{Tail-Bound Moment Program}



\begin{prob}
For any $d \in \N$ such that $2d \geq \deg p$, the order-$d$ \ac{LMI} in pseudomoments to upper-bound \eqref{eq:var_meas_soc} given $\mu_0$ is
% The order-$d$ moment\ac{LMI}
% For $d \geq \deg(p)$, the order-$d$ moment \ac{LMI} that upper-bounds problem \eqref{eq:var_meas_soc}, given $\mu_0$ is
\begin{subequations}
\label{eq:chance_lmi}
\begin{align}
    p^*_{r, d} = & \max \quad r {c} +  L_{\bm^\tau} p  \label{eq:chance_lmi_obj} \\
    & {c} \in \R, \bm \in \R^{^{\binom{2D+n+1}{n+1}}}, \bm^\tau \in \R^{^{\binom{2d+n+1}{n+1}}} \notag \\
    &\mathcal{D}_{\alpha \beta}(\bm, \bm^\tau) = \delta_{\beta 0} \langle x^\alpha , \mu_0\rangle \notag \\
    & \qquad \forall (\alpha, \beta) \in \N^{n+1} \quad \text{s.t.} \quad |\alpha|+\beta \leq 2d \label{eq:chance_lmi_flow}\\
    & {y}= [1-L_{\bm^\tau}(p^2), \ 2 {c}, \ 2 L_{\bm^\tau}p] \\
    & ({y}, 1 + L_{\bm^\tau}(p^2)) \in {\mathbb{L}}^3 \label{eq:var_lmi_con_soc}\\
    &\M_d[([0, T] \times X)\bm^\tau] \succeq 0 \label{eq:lmitau} \\
    &\M_D[([0, T] \times X)\bm] \succeq 0, \label{eq:lmiocc}
\end{align}
\end{subequations}
\end{prob}
in which the Kronecker symbol $\delta_{\beta 0}$ is $1$ if $\beta = 0$ and is $0$ otherwise.
Constraint \eqref{eq:chance_lmi_flow} is a finite-dimensional truncation of the infinite-dimensional martingale relation \eqref{eq:var_meas_lie_soc}.

% \urg{old below}
% where $\delta_{\beta 0}$ denotes the Kronecker symbol that is $1$ if $\beta = 0$ and $0$ otherwise. Note that constraint  \eqref{eq:chance_lmi_flow} is a finite-dimensional truncation of the infinite-dimensional \eqref{eq:var_meas_lie_soc}.

We now prove that all optimization variables of \eqref{eq:var_meas_soc} are bounded in order to prove convergence of \eqref{eq:chance_lmi} as $d\rightarrow \infty$.


\begin{lem}
\label{lem:moment_bound}
The variables $(\mu, \mu_\tau, {c})$ in any feasible solution of \eqref{eq:var_meas_soc} are bounded under A1-A7.
\end{lem}
\begin{proof}
A measure is bounded if all of its moments are bounded (finite). A sufficient condition for boundedness of measures to hold is if the measure is supported on a compact set and that it has finite mass. Compact support of $(\mu, \mu_\tau)$ is ensured by A1. Substitution of $v(t, x) = 1$ into \eqref{eq:var_meas_lie_soc} leads to $\inp{1}{\mu_\tau}=\inp{1}{\mu_0} = 1$ by A4-5. The moments $\inp{p}{\mu_\tau}$ and $\inp{p^2}{\mu_\tau}$ are therefore finite under A1 and A3, which implies that $c$ is bounded as well.
Applying $v(t, x) = t$ yields $\inp{1}{\mu} \leq \inp{t}{\mu_\tau} \leq T$, which implies that $\inp{1}{\mu}$ is finite by A5. All variables are therefore bounded. 



% \urg{old below}
% A sufficient condition for a measure to be bounded (in the sense that all moments are bounded) is that it has finite mass and is supported on a compact set. Compactness of $[0, T] \times X$ holds by A1. Assumption A4 imposes that $\inp{1}{\mu_0} = 1$. By substituting $v(t, x) = 1$ \eqref{eq:var_meas_lie_soc}, it holds that $\inp{1}{\mu_\tau}=\inp{1}{\mu_0} = 1$. Performing the same step with $v(t, x)= t$ yields $T \geq \inp{t}{\mu_\tau} = \inp{1}{\mu}$.
% It therefore holds that $\inp{p}{\mu_\tau}$ and $\inp{p^2}{\mu_\tau}$ are bounded. The \ac{SOC} constraint \eqref{eq:var_meas_con_soc} ensures that ${c}$ is finite, demonstrating that all variables are bounded.
\end{proof}