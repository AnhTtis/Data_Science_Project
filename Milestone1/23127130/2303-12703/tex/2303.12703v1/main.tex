
\documentclass[usenames,dvipsnames]{article} % For LaTeX2e
\usepackage{iclr2023_conference,times}


\input{matts_preamble}
\input{matts_maths_commands}
\input{causal_graphs}

\usepackage{hyperref}
\usepackage{url}
\usepackage{wrapfig}

\newcommand{\ma}[1]{ \textcolor{BrickRed}{[Matt: #1]} }
\newcommand{\CZ}[1]{ \textbf{\textcolor{blue}{[CZ: #1]}} }
\newcommand{\cz}[1]{ \textbf{\textcolor{blue}{#1}} }
\newcommand{\CM}[1]{ \textbf{\textcolor{green}{[CM: #1]}} }
\newcommand{\cm}[1]{ {\textcolor{green}{#1}} }
\newcommand{\modelname}{N-ADMG}

\newcommand{\rev}[1]{\textcolor{blue}{#1}}

\title{Causal Reasoning in the Presence of Latent Confounders via Neural ADMG Learning}

\iclrfinalcopy


\author{Matthew Ashman$^{2*}$, Chao Ma$^1$\thanks{ Equal contribution. This work is done when Matthew Ashman was an intern at Microsoft Research.}, Agrin Hilmkil$^1$, Joel Jennings$^1$, Cheng Zhang$^1$  \\
$^1$Microsoft Research Cambridge \quad $^2$University of Cambridge\\
\texttt{mca39@cam.ac.uk }, \texttt{\{chaoma,agrinhilmkil,joeljennings,chezha\}@microsoft.com} 
}

\newcommand{\fix}{\marginpar{FIX}}
\newcommand{\new}{\marginpar{NEW}}


\begin{document}


\maketitle

\begin{abstract}
Latent confounding has been a long-standing obstacle for causal reasoning from observational data. One popular approach is to model the data using acyclic directed mixed graphs (ADMGs), which describe ancestral relations between variables using directed and bidirected edges. However, existing methods using ADMGs are based on either linear functional assumptions or a discrete search that is complicated to use and lacks computational tractability for large datasets. In this work, we further extend the existing body of work and develop a novel gradient-based approach to learning an ADMG with non-linear functional relations from observational data. We first show that the presence of latent confounding is identifiable under the assumptions of bow-free ADMGs with non-linear additive noise models. With this insight, we propose a novel neural causal model based on autoregressive flows for ADMG learning. This not only enables us to determine complex causal structural relationships behind the data in the presence of latent confounding, but also estimate their functional relationships (hence treatment effects) simultaneously. We further validate our approach via experiments on both synthetic and real-world datasets, and demonstrate the competitive performance against relevant baselines.


\end{abstract}


\section{Introduction}
\label{sec:intro}


Learning causal relationships and estimating treatment effects from observational studies is a fundamental problem in causal machine learning, and has important applications in many areas of social and natural sciences \citep{judea2010introduction, spirtes2010introduction}. They enable us to answer questions in causal nature; for example, \textit{what is the effect on the expected lifespan of a patient if I increase the dose of $X$ drug?} However, many existing methods of causal discovery and inference overwhelmingly rely on the assumption that all necessary information is available. This assumption is often untenable in practice. Indeed, an important, yet often overlooked, form of causal relationships is that of latent confounding; that is, when two variables have an unobserved common cause \citep{verma1990equivalence}. If not properly accounted for, the presence of latent confounding can lead to incorrect evaluation of causal quantities of interest \citep{pearl2009causal}.


Traditional causal discovery methods that account for the presence of latent confoundings, such as the fast causal inference algorithm (FCI) \citep{spirtes2000causation} and its extensions \citep{colombo2012learning, claassen2013learning, chen2021causal}, rely on uncovering an equivalence class of acyclic directed mixed graphs (ADMGs) that share the same conditional independencies. Without additional assumptions, however, these methods might return uninformative results as they cannot distinguish between members of the same Markov equivalence class \citep{bellot2021deconfounded}. More recently, causal discovery methods based on structural causal models (SCMs) \citep{pearl1998graphs} have been developed for latent confounding \citep{nowzohour2017distributional, wang2020causal, maeda2020rcd, maeda2021causal, bhattacharya2021differentiable}. By assuming that the causal effects follow specific functional forms, they have the advantage of being able to distinguish between members of the same Markov equivalence class \citep{glymour2019review}. Yet, existing approaches either rely on restrictive linear functional assumptions \citep{bhattacharya2021differentiable, maeda2020rcd, bellot2021deconfounded}, and/or discrete search over the discrete space of causal graphs \citep{maeda2021causal} that are computationally burdensome and unintuitive to use. As a result, modeling non-linear causal relationships between variables in the presence of latent confounders in a scalable way remains an outstanding task.


In this work, we seek to utilize recent advances in differentiable causal discovery \citep{ zheng2018dags, bhattacharya2021differentiable} and neural causal models \citep{lachapelle2019gradient, morales2022simultaneous, geffner2022deep} to overcome these limitations. Our core contribution is to extend the framework of differentiable ADMG discovery for linear models \citep{bhattacharya2021differentiable} to non-linear cases using neural causal models. This enables us to build scalable and flexible methods capable of discovering non-linear, potentially confounded relationships between variables and perform subsequent causal inference. Specifically, our contributions include:


\begin{enumerate}[leftmargin=!, labelindent=0pt]
    \item \textbf{Sufficient conditions for ADMG identifiability with non-linear SCMs (Section \ref{sec:structural_identifiability}).} We assume:  i) the functional relationship follows non-linear additive noise SCM; ii) the effect of observed and latent variables do not modulate each other, and iii) all latent variables confound a pair of non-adjacent observed nodes. Under these assumptions, the underlying ground truth ADMG causal graph is identifiable. This serves as a foundation for designing ADMG identification algorithms for flexible, non-linear SCMs based on deep generative models.

    \item \textbf{A novel gradient-based framework for learning ADMGs from observational data (Section \ref{sec:\modelname}).} Based on our theoretical results, we further propose Neural ADMG Learning (\modelname), a neural autoregressive-flow-based model capable of learning complex non-linear causal relationships with latent confounding. \modelname\ utilizes variational inference to approximate posteriors over causal graphs and latent variables, whilst simultaneously learning the model parameters via gradient-based optimization. This is more efficient and accurate than discrete search methods, allowing us to replace task-specific search procedures with general purpose optimizers.
    
    \item \textbf{Empirical evaluation on synthetic and real-world datasets (Section \ref{sec:experiments}).} We evaluate \modelname\ on a variety of synthetic and real-world datasets, comparing performance with a number of existing causal discovery and inference algorithms. We find that \modelname\ provides competitive or state-of-the-art results on a range of causal reasoning tasks.
\end{enumerate}


\section{Related Work}
\label{sec:related_work}

\paragraph{Causal discovery with latent confounding.} Constraint-based causal discovery methods in the presence of latent confounding have been well-studied \citep{spirtes2000causation, zhang2008completeness, colombo2012learning, claassen2013learning,chen2021causal}. Without further assumptions, these approaches can only identify a Markov equivalence class of causal structures \citep{spirtes2000causation}.  When certain assumptions are made on the data generating process in the form of SCMs \citep{pearl1998graphs}, additional constraints can help identify the true causal structure. In the most general case, additional non-parametric constraints have been identified \citep{verma1990equivalence, shpitser2014introduction, evans2016graphs}. Further refinement can be made through the assumption of stricter SCMs. For example, in the linear Gaussian additive noise model (ANM) case, \cite{nowzohour2017distributional} proposes a score-based approach for finding an equivalent class of bow-free acyclic path diagrams. Both \cite{maeda2020rcd} and \cite{wang2020causal} develop Independence tests based approach for linear non-Gaussian ANM case, with \cite{maeda2021causal} extending this to more general cases. 


\paragraph{Differentiable characterization of causal discovery.} All aforementioned approaches employ a search over a discrete space of causal structures, which often requires task-specific search procedures, and imposes a computational burden for large-scale problems. More recently, \citep{zheng2018dags} proposed a differentiable constraint on directed acyclic graphs (DAG), and frames the graph structure learning problem as a differentiable constrained optimization task in the absence of latent confounders. This is further generalized to the latent confounding case \citep{bhattacharya2021differentiable} through differentiable algebraic constraints that characterize the space of ADMGs. Nonetheless, this work is limited in that it only considers linear Gaussian ANMs.



\section{Background}
\label{sec:background}
\subsection{Structural Causal Models in the Absence of Latent Confoundings}
\label{subsec:background/SCMs}
Unlike constraint-based approaches such as the PC algorithm, SCMs capture the asymmetry between causal direction through functional assumptions on the data generating process, and have been central to many recent developments in causal discovery \citep{glymour2019review}. . Given a directed acyclic graph (DAG) $G$ on nodes $\{1, \ldots, D\}$, SCMs describe the random variable $\bfx = (x_1, \ldots, x_D)$ by $x_i = f_i(\bfx_{\text{pa}(i; G)}, \epsilon_i)$, where $\epsilon_i$ is an exogenous noise variable that is independent of all other variables in the model, $\text{pa}(i; G)$ denotes the set of parents of node $i$ in $G$, and $f_i$ describes how $x_i$ depends on its parents and the noise $\epsilon_i$. We focus on additive noise SCMs, commonly referred to as additive noise models (ANMs), which take the form
\begin{equation}
    \label{eq:anm}
    x_i=f_i(\bfx_{\text{pa}(i; G)}, \epsilon_i) = f_i(\bfx_{\text{pa}(i; G)}) + \epsilon_i, \quad \text{or} \quad \bfx = f_G(\bfx) + \*\epsilon \quad \text{in vector form.}
\end{equation}
This induces a joint observation distribution $p_{\theta}(\bfx^n | G)$, where $\theta$ denotes the parameters for functions $\{f_i\}$. Under the additive noise model in \Cref{eq:anm}, the DAG $G$ is identifiable assuming causal minimality and no latent confounders \citep{peters2014causal}.

\subsection{Graphical Representation of Latent Confounders Using ADMGs}
\label{subsec:background/latent_confounders}



One of the most widely-used graphical representations of causal relationships involving latent confounding is the so-called acyclic directed mixed graph
(ADMGs). ADMGs are an extension of DAGs, that contain both directed edges ($\rightarrow$) and bidirected edges ($\leftrightarrow$) between variables. More concretely, the directed edge $x_i \rightarrow x_j$ indicates that $x_i$ is an ancestor of $x_j$, and the bidirected edge $x_i \leftrightarrow x_j$ indicates that $x_i$ and $x_j$ share a common, unobserved ancestor \citep{richardson2002ancestral, tian2002general}. 
%
An ADMG $G$ over a collection of $D$ variables $\bfx = (x_1, \ldots, x_D)$ can be described using two binary adjacency matrices: $G_D \in \R^{D\times D}$, for which an entry of 1 in position $(i, j)$ indicates the presence of the directed edge $x_i \rightarrow x_j$, and $G_B \in \R^{D\times D}$, for which an entry of 1 in position $(i, j)$ indicates the presence of the bidirected edge $x_i \leftrightarrow x_j$. Throughout this paper, we will use the graph notation $G$ to indicate the tuple $G = \{G_D, G_B\}$. When using ADMGs to represent latent confounding, causal discovery amounts to learning the matrices $G_D$ and $G_B$. 

Similar to a DAG, an SCM can be specified to describe the causal relationships implied by an ADMG through the so-called \emph{magnification} process. As formulated in \citep{pena2016learning}, whenever a bidirected edge $x_i \leftrightarrow x_j$ is present according to $G_B$ in an ADMG, we will explicitly add a latent node $u_m$ to represent the latent parent (confounder) of $x_i \leftrightarrow x_j$. Then, the SCM of $x_i$ can be written as $\bfx$ by $x_i = f_i(\bfx_{\text{pa}(i; G_D)}, \bfu_{\text{pa}(i; G_B)}) + \epsilon_i$, where $\bfu_{\text{pa}(i; G_B)}$ denotes the latent parents of $x_i$ in the set of all latent nodes $\bfu = (u_1, \ldots, u_M)$ added in the magnification process. In compact form, we can write:
\begin{equation}
    \label{eq:admg_anm}
    [\bfx, \bfu] = f_G(\bfx,\bfu) + \*\epsilon.
\end{equation}
The `magnified SCM' will serve as a practical device for learning ADMGs in this paper. Similar to DAGs, magnified SCMs induce an observational distribution on $\bfx$, denoted by $p_{\theta}(\bfx^n ; G)$. Note that given an ADMG, the magnified SCM is not unique as latent variables may be shared. For example, $x_1 \leftrightarrow x_2$, $x_2 \leftrightarrow x_3$, $x_3 \leftrightarrow x_1$ can be magnified as both $\{x_1 \leftarrow u_1 \rightarrow x_2, x_2 \leftarrow u_2 \rightarrow x_3, x_3 \leftarrow u_3 \rightarrow x_1\}$ and $\{u_1 \rightarrow x_1, u_1 \rightarrow x_2, u_1 \rightarrow x_3 \}$. Therefore, ADMG identifiability does not imply the structural identifiability of the magnified SCM. In this paper, we focus on ADMG identifiability.


\subsection{Dealing with Graph Uncertainty} \label{subsec: graph_uncertainty}
Additive noise SCMs only guarantee DAG identifiability in the limit of infinite data. In the finite data regime, there is inherent uncertainty in the causal relationships. The Bayesian approach to causal discovery accounts for this uncertainty in a principled manner using probabilistic modeling \citep{heckerman2006bayesian}, in which one's belief in the true causal graph is updated using Bayes' rule. This approach is grounded in causal decision theory, which states that rational decision-makers maximize the expected utility over a probability distribution representing their belief in causal graphs \citep{soto2019choosing}. We can model the causal graph $G$ jointly with observations $\bfx^1, \ldots, \bfx^N$ as
\begin{equation}
    p_{\theta}(\bfx^1, \ldots, \bfx^N, G) = p(G) \prod_{n=1}^N p_{\theta}(\bfx^n | G)
\end{equation}
where $\theta$ denotes the parameters of the likelihood relating the observations to the underlying causal graph. In general, the posterior distribution $p_{\theta}(G | \bfx^1, \ldots, \bfx^N)$ is intractable. One approach to circumvent this is variational inference \citep{jordan1999introduction, zhang2018advances}, in which we seek an approximate posterior $q_{\phi}(G)$ that minimises the KL-divergence $\KL{q_{\phi}(G)}{p_{\theta}(G | \bfx^1, \ldots, \bfx^N)}$. This can be achieved through maximization of the evidence lower bound (ELBO), given by 
\begin{equation}
    \mcL_{\textrm{ELBO}} = \sum_{n=1}^N\Exp{q_{\phi}(G)}{\log p_{\theta}(\bfx^n | G)} - \KL{q_{\phi}(G)}{p(G)}.
\end{equation}
An additional convenience of this approach is that the ELBO serves as a lower bound to the marginal log-likelihood $p_{\theta}(\bfx^1, \ldots, \bfx^N)$, so it can also be maximized with respect to the model parameters $\theta$ to find the parameters that approximately maximize the likelihood of the data \citep{geffner2022deep}.


\section{Establishing ADMGs Identifiability Under Non-linear SCMs}
\label{sec:structural_identifiability}
To build flexible methods that are capable of discovering causal relationships under the presence of latent confounding, we first need to establish the identifiability of ADMGs under non-linear SCMs. 
The concept of structural identifiability of ADMGs is formalized in the following definition: 
\begin{defi}[ADMG structural identifiability]
    For a distribution $p_{\theta}(\bfx; G)$, the ADMG $G = \{G_D, G_B\}$ is said to be structurally identifiable from $p_{\theta}(\bfx; G)$ if there exists no other distribution $p_{\theta'}(\bfx; G')$ such that $G \neq G'$ and $p_{\theta}(\bfx; G) = p_{\theta'}(\bfx; G')$.
\end{defi}

Assuming that our model is correctly specified and $p_{\theta^0}(\bfx; G^0)$ denotes the true data generating distribution, then ADMG structural identifiability guarantees that if we find some $p_{\theta}(\bfx; G) = p_{\theta^0}(\bfx; G^0)$ (by e.g., maximum likelihood learning), we can recover $G = G^0$. In this section, we seek to establish sufficient conditions under which the ADMG identifiability is satisfied. Let $\bfx = (x_1, \ldots, x_D)$ be a collection of observed random variables, and $\bfu = (u_1, \ldots, u_M)$ be a collection of unobserved (latent) random variables. Our first assumption is that data generating process can be expressed as a specific non-linear additive noise SCM, in which the effect of the observed and latent variables do not modulate each other, see the functional form below:
\begin{assumption}
    \label{assumption:non-linear_anm}
    We assume that the data generating process takes the form
    \begin{equation}
    \label{eq: non-linear_anm}
        [\bfx, \bfu]^{\top} = f_{G_D, \bfx}(\bfx; \theta) + f_{G_B, \bfu}(\bfu; \theta) + \*\epsilon
    \end{equation}
    where each element of $\*\epsilon$ is independent of all other variables in the model and $\theta$ denotes the parameters of the non-linear functions $f_{G_D, \bfx}$ and $f_{G_B, \bfu}$.
\end{assumption}

This assumption is one of the elements that separate us from previous work of \citep{bhattacharya2021differentiable, maeda2020rcd} (linearity is assumed) and \citep{maeda2021causal} (effects are assumed to be fully decoupled, $x_i = \sum_m f_{im}(x_m \in \bfx_{\text{pa}(i; G_D)}) + \sum_k g_{ik}(u_k \in \bfu_{\text{pa}(i; G_B)}) + \epsilon_i$). As discussed in \Cref{subsec:background/latent_confounders}, the discovery of an ADMG between observed variables amounts to the discovery of their ancestral relationships. Therefore, the mapping between ADMGs and their magnified SCMs is not one-to-one, which might cause issues when designing causal discovery methods using SCM-based approaches. To further simplify the underlying latent structure (without losing too much generality), our second assumption assumes that every latent variable is a parent-less common cause of a pair of non-adjacent observed variables:
\begin{assumption}[Latent variables confound pairs of non-adjacent observed variables]
    \label{assumption:confounders}
    For each latent variable $u_k$ in the data generating process, there exists a non-adjacent pair $x_i$ and $x_j$ that is unique to $u_k$, such that $x_i \leftarrow u_k \rightarrow x_j$.
\end{assumption}
Arguments for \Cref{assumption:confounders} are made by \citep{pearl1992statistical}, who show that this family of causal graphs is very flexible, and can produce the same conditional independencies amongst the observed variables in any given causal graph. Therefore, it has been argued that without loss of  generality, we can assume latent variables to be exogenous, and have exactly two non-adjacent children.
\footnote{Meanwhile, \cite{evans2016graphs} show that this graph family cannot induce all possible observational distributions. In \Cref{app:latent_structural_identfiability} we show that in the linear non-Gaussian ANM case there exist certain constraints on marginal distributions that cannot be satisfied under \Cref{assumption:confounders}. Nonetheless, we could not derive such constraints for the non-linear case.}  This assumption also implies that we can specify a magnified SCM to the ADMG as shown in \Cref{subsec:background/latent_confounders}, which allows us to evaluate and optimize the induced likelihood later on.

Given \Cref{assumption:non-linear_anm,assumption:confounders}, we now provide three lemmas which allow us to identify the ADMG matrices, $G_D$ and $G_B$. These lemmas extend the previous results in \cite{maeda2021causal} under our new assumptions above. Note that all $g_i$ and $g_j$ functions in the lemmas denote functions satisfying the residual faithfulness condition (\cite{maeda2021causal}), as detailed in \Cref{app:lemmas}.

\begin{lem}[Case 1]
    \label{lem:bidirected}
    Given \Cref{assumption:non-linear_anm,assumption:confounders}, then ${[G_B]}_{i,j} = 1$ and ${[G_D]}_{i,j} = 0$ if and only if
    \begin{equation}
        \label{eq:dependent_residuals}
        \forall g_i, g_j, \ [(x_i - g_i(\bfx_{-i}) \cancel{\indep} (x_j - g_j(\bfx_{-j})].
    \end{equation}
\end{lem}
\begin{lem}[Case 2]
    \label{lem:no_edge}
    Given \Cref{assumption:non-linear_anm,assumption:confounders}, then ${[G_B]}_{i,j} = 0$ and ${[G_D]}_{i,j} = 0$ if and only if
    \begin{equation}
        \label{eq:no_cause}
        \exists g_i, g_j, \ [(x_i - g_i(\bfx_{-(i, j)}) \indep (x_j - g_j(\bfx_{-(i, j)}))].
    \end{equation}
\end{lem}
\begin{lem}[Case 3]
    \label{lem:directed}
    Given \Cref{assumption:non-linear_anm,assumption:confounders}, then ${[G_B]}_{i,j} = 0$ and ${[G_D]}_{i,j} = 1$ if and only if
    \begin{equation}
        \label{eq:causal_dependence}
        \forall g_i, g_j, \ [(x_i - g_i(\bfx_{-(i, j)}) \cancel{\indep} (x_j - g_j(\bfx_{-j})]
    \end{equation}
    \begin{equation}
        \label{eq:causal_independence}
        \exists g_i, g_j,\  [(x_i - g_i(\bfx_{-i}) \indep (x_j - g_j(\bfx_{-(i, j)}))]
    \end{equation}
\end{lem}

Since each case leads to mutually exclusive conditional independence/dependence constraints,  for any $p_{\theta}(\bfx; G)$ specified under the assumptions above, there cannot exist some $p_{\theta'}(\bfx; G')$ such that $G \neq G'$ and $p_{\theta}(\bfx; G) = p_{\theta'}(\bfx; G')$, thus structural identifiability is satisfied. This gives our ADMG identifiability result:

\begin{proposition}[Identifiability of ADMGs under non-linear SCMs] Assume \Crefrange{assumption:non-linear_anm}{assumption:confounders} hold. Then,  $G_D$ and $G_B$ are identifiable for the data generating process specified in \Cref{eq: non-linear_anm}. 

\end{proposition}

Whilst theoretically we could test for these conditions stated in \Crefrange{lem:bidirected}{lem:directed} directly, a more efficient approach is to use differentiable maximum likelihood learning. Assuming the model is correctly specified, then ADMG identifiability ensures the maximum likelihood estimate recovers the true graph in the limit of infinite data (\Cref{subsec: consistency}). Hence, we can design the ADMG identification algorithms via maximum likelihood learning.

\section{Neural ADMG Learning}
\label{sec:\modelname}

Whilst we have outlined sufficient conditions under which the underlying ADMG causal structure can be identified, this does not directly provide a framework through which causal discovery and inference can be performed. In this section, we seek to formulate a practical framework for gradient-based ADMG identification. Three challenges that remain are:
\begin{enumerate*}
    \item How can we parameterize the magnified SCM models for ADMG to enable learning flexible causal relationships?
    \item How can we optimise our model in the space of ADMG graphs as assumed in \Cref{sec:structural_identifiability}?
    \item How do we learn the ADMG causal structure efficiently, whilst accounting for the missing data ($\bfu$) and graph uncertainties in the finite data regime?
    % \item How to perform causal inference in the presence of latent confounders?
\end{enumerate*}
In this section, we present Neural ADMG Learning (\modelname), a novel framework that addresses all three challenges.

\subsection{Neural Auto-regressive Flow Parameterization} \label{subsec: nadmg_parameterization}
We assume that our model used to learn ADMGs from data is correctly specified. That is, it can be written in the same magnified SCM form as in \Cref{eq: non-linear_anm}: 
\begin{equation}
    \label{eq: n-admg}
    [\bfx, \bfu]^{\top} = f_{G_D, \bfx}(\bfx; \theta) + f_{G_B, \bfu}(\bfu; \theta) + \*\epsilon.
\end{equation}

Following \cite{khemakhem2020variational}, we factorise the likelihood $p_{\theta}(\bfx^n, \bfu^n | G)$ induced by \Cref{eq: n-admg} in an autoregressive manner. We can rearrange \Cref{eq: n-admg} as
\begin{equation}
    \*\epsilon  = \bfv - f_{G_D, \bfx}(\bfx; \theta) - f_{G_B, \bfu}(\bfu; \theta) := g_{\tilde{G}}(\bfv; \theta) = \bfv - f_{\tilde{G}}(\bfv ; \theta)
\end{equation}
 where $\bfv = (\bfx, \bfu) \in \R^{D + M}$, and $\tilde{G}$ is the magnified adjacency matrix on $\bfv$, defined as  $\tilde{G}_{i,j} \in \{0, 1\}$ if and only if $v_i \rightarrow v_j$. This allows us to express the likelihood as
\begin{equation}
    p_{\theta}(\bfv^n | G) = p_{\*\epsilon}(g_{\tilde{G}}(\bfv^n; \theta)) = \prod_{i=1}^{D + M} p_{\epsilon_i}(g_{\tilde{G}}(\bfv^n; \theta)_i).
\end{equation}
Note that we have omitted the Jacobian-determinant term as it is equal to one since $\tilde{G}$ is acyclic \citep{mooij2011causal}. Following \cite{geffner2022deep}, we adopt an efficient, flexible parameterization for the functions $f_i$ taking the form (consistent with \Cref{assumption:non-linear_anm})
\begin{equation}
    \label{eq:likelihood}
    f_i(\bfv) = \xi_{1, i} \left( \sum_{v_j \in \bfx}^{D} \tilde{G}_{j,i} \ell_j(v_j)\right) +  \xi_{2, i} \left(\sum_{v_j \in \bfu}^{M} \tilde{G}_{j,i} \ell_j(v_j)\right)
\end{equation}
where $\xi_{1, i}$, $\xi_{2, i}$ and $\ell_i$ ($i = 1, ..., D+M$) are MLPs. A na{\"i}ve implementation would require training $3(D+M)$ neural networks. Instead, we construct these MLPs so that their weights are shared across nodes as $\xi_{1, i}(\cdot) = \xi_{1, i}(\bfe_i, \cdot)$, $\xi_{2, i}(\cdot) = \xi_{2, i}(\bfe_i, \cdot)$ and $\ell_i(\cdot) = \ell(\bfe_i, \cdot)$, with $\bfe_i\in\mathbb{R}^{D+M}$ a trainable embedding that identifies the output and input nodes respectively.



\subsection{ADMG Learning via Maximizing Evidence Lower Bound}
Our ADMG identifiability theory in \Cref{sec:structural_identifiability} suggests that the ground truth ADMG graph can, in principle, be recovered via maximum likelihood learning of $p_\theta(\bfx|G)$. However, the aforementioned challenges remain: given a finite number of observations $\bfx^1, \ldots, \bfx^N$, how do we deal with the corresponding missing data $\bfu^1, \ldots, \bfu^N$ while learning the ADMG? How do we account for graph uncertainties and ambiguities in the finite data regime? To address these issues, \modelname \ takes a Bayesian approach toward ADMG learning. Similar to \Cref{subsec: graph_uncertainty},  we may jointly model the distribution over the ADMG causal graph $G$, the observations $\bfx^1, \ldots, \bfx^N$, and the corresponding latent variables $\bfu^1, \ldots, \bfu^N$, as
\begin{equation}
\label{eq:prob_model}
    p_{\theta}(\bfx^1, \bfu^1, \ldots, \bfx^N, \bfu^N, G) = p(G) \prod_{n=1}^N p_{\theta}(\bfx^n, \bfu^n | G)
\end{equation}
where $p_{\theta}(\bfx^n, \bfu^n | G)$ is the neural SCM model specified in \Cref{subsec: nadmg_parameterization}, $\theta$ denotes the corresponding model parameters, and $p(G)$ is some prior distribution over the graph. Our goal is to learn both the model parameters $\theta$ and an approximation to the posterior $q_{\phi}(\bfu^1, \ldots, \bfu^N, G) \approx p_{\theta}(\bfu^1, \ldots, \bfu^N, G | \bfx^1, \ldots, \bfx^N)$. This can be achieved jointly using the variational inference framework \citep{zhang2018advances, kingma2013auto}, in which we maximize the evidence lower bound (ELBO) $\mcL_{\textrm{ELBO}}(\theta, \phi) \leq \sum_n \log p_\theta(\bfx^n )$ given by
\begin{equation}
    \label{eq:elbo}
    \begin{aligned}
    \mcL_{\textrm{ELBO}}(\theta, \phi) &= \Exp{q_{\phi}(G)}{\sum_{n=1}^N \Exp{q_{\phi}(\bfu^n | G)}{\log p_{\theta}(\bfx^n | \bfu^n, G)}} - \KL{q_{\phi}(G)}{p(G)} \\
    &\ - \Exp{q_{\phi}(G)}{\sum_{n=1}^N \KL{q_{\phi}(\bfu^n | \bfx^n, G))}{p_{\theta}(\bfu^n | G)}}.
    \end{aligned}
\end{equation}

In the following sections, we describe our choice of the graph prior $p(G)$, and approximate posterior $q_{\phi}(\bfu^1, \ldots, \bfu^N, G) = \prod_n q_\phi (\bfu^n|\bfx^n, G) q_\phi(G)$. We will also demonstrate that maximizing $\mcL_{\textrm{ELBO}}(\theta, \phi)$ recovers the true ADMG causal graph in the limit of infinite data. See \Cref{subsec: consistency}.

\subsection{Choice of Prior Over ADMG Graphs}
As discussed in \Cref{subsec:background/latent_confounders}, the ADMG $G$ can be parameterized by two binary adjacency matrices, $G_D$ whose entries indicate the presence of a directed edge, and $G_B$ whose edges indicate the presence of a bidirected edge. As discussed in \Cref{sec:structural_identifiability}, a necessary assumption for structural identifiability is that each latent variable is a parent-less confounder of a pair of non-adjacent observed variables. This further implies that the underlying ADMG must be bow-free (both a directed and a bidirected edge cannot exist between the same pair of observed variables). This constraint can be imposed by leveraging the bow-free constrain penalty introduced by  \cite{bhattacharya2021differentiable},
\begin{equation}
    \label{eq:bowfree_constraint}
    h(G_D, G_B) = \operatorname{trace}\left(e^{G_D}\right) - D + \operatorname{sum}\left(G_D \circ G_B\right)
\end{equation}
which is non-negative and zero only if $(G_D, G_B)$ is a bow-free ADMG. As suggested in \cite{geffner2022deep}, we implement the prior as
\begin{equation}
    \label{eq: graph_prior}
    p(G) \propto \exp \left(-\lambda_{s1} \|G_D\|^2_F - \lambda_{s2} \|G_B\|^2_{F} - \rho h(G_D, G_B)^2 - \alpha h(G_D, G_B)\right)
\end{equation}
where the coefficients $\alpha$ and $\rho$ are increased whilst maximizing $\mcL_{\textrm{ELBO}}(\theta, \phi)$, following an augmented Lagrangian scheme \citep{nemirovski1999optimization}. Prior knowledge about the sparseness of the graph is introduced by penalizing the norms $\|G_D\|^2_F$ and $\|G_B\|^2_F$ with scaling coefficients $\lambda_{s1}$ and $\lambda_{s2}$. 

\subsection{Choice of Variational Approximation}
We seek to approximate the intractable true posterior $p_{\theta}(\bfu^1, \ldots, \bfu^N, G | \bfx^1, \ldots, \bfx^N)$ using the variational distribution $q_{\phi}(\bfu^1, \ldots, \bfu^N, G)$. We assume the following factorized approximate posterior
\begin{equation}
    q_{\phi}(\bfu^1, \ldots, \bfu^N, G) = q_{\phi}(G) \prod_{n=1}^N q_{\phi}(\bfu^n | \bfx^n).
\end{equation}
For $q_{\phi}(G)$, we use a product of Bernoulli distributions for each potential directed edge in $G_D$ and bidirected edge in $G_B$. For $G_D$, edge existence and edge orientation are parameterized separately using the ENCO parameterization \citep{lippe2021efficient}. For $q_{\phi}(\bfu^n | \bfx^n)$, we apply amortized VI as in VAE literature \citep{kingma2013auto}, where $q_{\phi}(\bfu^n | \bfx^n)$ is parameterized as a Gaussian distribution whose mean and variance is determined by passing the $\bfx^n$ through an inference MLP . 

\subsection{Maximizing $\mcL_{\textrm{ELBO}}(\theta, \phi)$ Recovers the Ground Truth ADMG} \label{subsec: consistency}
In \Cref{sec:structural_identifiability}, we have proved the structural identifiability of ADMGs. In this section, we further show that under certain assumptions, maximizing $\mcL_{\textrm{ELBO}}(\theta, \phi)$ recovers the true ADMG graph (denoted by $G^0$) in the infinite data limit.  This result is stated in the following proposition:

\begin{proposition}[Maximizing $\mcL_{\textrm{ELBO}}(\theta, \phi)$ recovers the ground truth ADMG] \label{prop: 2} Assume that:
\begin{itemize}[leftmargin=*]
  \setlength\itemsep{0pt}
    \item \Cref{assumption:non-linear_anm,assumption:confounders} (hence the identifiability of ADMGs) holds for the model $p_\theta(\bfx; G)$.
    
    \item The model is correctly specified  ($\exists \theta^*$ such that $p_{\theta^*}(\bfx;G^0)$ recovers the data-generating process).
    
    \item Regularity condition: for all $\theta$ and $G$ we have  $\mathbb{E}_{p(\bfx;G^0)}\left[\vert\log p_\theta(\bfx;G)\vert\right]<\infty$.
    \item The variational family of $q_\phi (\bfu|\bfx, G)$ is flexible enough, i.e., it contains $p_\theta(\bfu|\bfx, G)$. 
\end{itemize}

Then, the solution $(\theta',q'_\phi({G}))$ that maximizes $\mcL_{\textrm{ELBO}}(\theta, \phi)$ satisfies $q'_\phi({G})=\delta({G}={G}^0)$.

\end{proposition}

The proof of \Cref{prop: 2} can be found in \Cref{app: prop_2}, which justifies performing causal discovery by maximizing ELBO of the \modelname\ model. Once the model has been trained and the ADMG has been recovered, we can use the \modelname\ to perform causal inference as detailed in \Cref{app:estimating_te}.


\section{Experiments}
\label{sec:experiments}
We evaluate \modelname\ in performing both causal discovery and causal inference on a number of synthetic and real-world datasets. Note that we run our model \emph{both with and without the bow-free constraint, identified as N-BF-ADMG (our full model) and N-ADMG (for ablation purpose)}, respectively. We compare the performance of our model against five baselines: DECI \citep{geffner2022deep} (which we refer to as N-DAG for consistency), FCI \citep{spirtes2000causation}, RCD \citep{maeda2020rcd}, CAM-UV \citep{maeda2021causal}, and DCD \citep{bhattacharya2021differentiable}.  We evaluate the causal discovery performance using F1 scores for directed and and bidirected adjacency. The expected values of these metrics are reported using the learned graph posterior (which is deterministic for RCD, CAM-UV, and DCD). Causal inference is evaluated using the expected ATE as described in \Cref{app:estimating_te}. We evaluate the causal inference performance of the causal discovery benchmarks by fixing $q(G)$ to either deterministic or uniform categorical distributions on the learned causal graphs, then learning a non-linear flow-based ANM by optimizing \Cref{eq:elbo} in an identical manner to \modelname. A full list of results and details of the experimental set-up are included in \Cref{app:experiments}. Our implementation will be available at \texttt{https://github.com/microsoft/causica}.

\subsection{Synthetic Fork-Collider Dataset}
\label{subsec:fork_collider}
We construct a synthetic fork-collider dataset consisting of five nodes (\Cref{fig:ground_true_fork_collider}). The data-generating process is a non-linear ANM with Gaussian noise. Variable pairs $(x_2, x_3)$, and $(x_3, x_4)$ are latent-confounded, whereas $(x_4, x_5)$ share a observed confounder. We evaluate both causal discovery and inference performances. For discovery, we evaluate F-score measure on both $G_D$ and $G_B$. For causal inference, we choose $x_4$ as the treatment variable taking and $x_2$, $x_3$ and $x_5$ as the response variables, and evaluate ATE RMSE to benchmark performance. It is therefore crucial that discovery methods do not misidentify latent confounded variables as having a direct cause between them, as this would result in biased ATE estimates.

\begin{figure}
\begin{subfigure}{0.33\columnwidth}
    \centering
    \begin{tikzpicture}[thick,scale=0.8, every node/.style={scale=0.8}]
        \node[state] (x3) at (0, 0) {$x_3$};
        \node[state] (x2) [above =of x3, xshift=9mm] {$x_2$};
        \node[state] (x4) [right =of x3] {$x_4$};
        \node[state] (x5) [right =of x4] {$x_5$};
        \node[state] (x1) [above =of x4, xshift=9mm] {$x_1$};
        
        \path[bidirected] (x2) edge (x3);
        \path[bidirected] (x3) edge (x4);
        \path (x1) edge (x4);
        \path (x1) edge (x5);
    \end{tikzpicture}
    \caption{Ground truth.}
    \label{fig:ground_true_fork_collider}
\end{subfigure}
\begin{subfigure}{0.33\columnwidth}
    \centering
    \begin{tikzpicture}[thick,scale=0.8, every node/.style={scale=0.8}]
       \node[state] (x3) at (0, 0) {$x_3$};
        \node[state] (x2) [above =of x3, xshift=9mm] {$x_2$};
        \node[state] (x4) [right =of x3] {$x_4$};
        \node[state] (x5) [right =of x4] {$x_5$};
        \node[state] (x1) [above =of x4, xshift=9mm] {$x_1$};
        
        \path[bidirected] (x2) edge (x3);
        \path[bidirected] (x3) edge (x4);
        \path (x1) edge (x4);
        \path (x1) edge (x5);
        \path (x5) edge (x4);
    \end{tikzpicture}
    \caption{N-BF-ADMG.}
    \label{fig:csuite_causal_graph_nbfadmg}
\end{subfigure}
\begin{subfigure}{0.33\columnwidth}
    \centering
    \begin{tikzpicture}[thick,scale=0.8, every node/.style={scale=0.8}]
        \node[state] (x3) at (0, 0) {$x_3$};
        \node[state] (x2) [above =of x3, xshift=9mm] {$x_2$};
        \node[state] (x4) [right =of x3] {$x_4$};
        \node[state] (x5) [right =of x4] {$x_5$};
        \node[state] (x1) [above =of x4, xshift=9mm] {$x_1$};
        
        \path[bidirected] (x2) edge (x3);
        \path[bidirected] (x3) edge (x4);
        \path (x1) edge (x3);
        \path (x1) edge (x4);
        \path (x1) edge (x5);
        \path (x2) edge[bend right=60] (x3);
        \path (x4) edge[bend right=60] (x3);
        \path (x5) edge (x4);
    \end{tikzpicture}
    \caption{ \modelname \ (no constraint).}
\end{subfigure}

\begin{subfigure}{0.33\columnwidth}
    \centering
    \begin{tikzpicture}[thick,scale=0.8, every node/.style={scale=0.8}]
        \node[state] (x3) at (0, 0) {$x_3$};
        \node[state] (x2) [above =of x3, xshift=9mm] {$x_2$};
        \node[state] (x4) [right =of x3] {$x_4$};
        \node[state] (x5) [right =of x4] {$x_5$};
        \node[state] (x1) [above =of x4, xshift=9mm] {$x_1$};
        
        \path[bidirected] (x3) edge (x4);
        \path (x4) edge (x5);
    \end{tikzpicture}
    \caption{ RCD.}
\end{subfigure}
\begin{subfigure}{0.33\columnwidth}
    \centering
    \begin{tikzpicture}[thick,scale=0.8, every node/.style={scale=0.8}]
        \node[state] (x3) at (0, 0) {$x_3$};
        \node[state] (x2) [above =of x3, xshift=9mm] {$x_2$};
        \node[state] (x4) [right =of x3] {$x_4$};
        \node[state] (x5) [right =of x4] {$x_5$};
        \node[state] (x1) [above =of x4, xshift=9mm] {$x_1$};
        
        \path[bidirected] (x2) edge (x3);
        \path[bidirected] (x2) edge (x4);
        \path[bidirected] (x2) edge (x5);
        \path[bidirected] (x3) edge (x4);
        \path (x3) edge[bend left=60] (x5);
    \end{tikzpicture}
    \caption{DCD.}
\end{subfigure}
\begin{subfigure}{0.33\columnwidth}
    \centering
    \begin{tikzpicture}[thick,scale=0.8, every node/.style={scale=0.8}]
        \node[state] (x3) at (0, 0) {$x_3$};
        \node[state] (x2) [above =of x3, xshift=9mm] {$x_2$};
        \node[state] (x4) [right =of x3] {$x_4$};
        \node[state] (x5) [right =of x4] {$x_5$};
        \node[state] (x1) [above =of x4, xshift=9mm] {$x_1$};
        
        \path[bidirected] (x3) edge (x4);
        \path (x1) edge (x4);
        \path (x1) edge (x5);
        \path (x2) edge (x3);
    \end{tikzpicture}
    \caption{ CAM-UV.}
    \label{fig:csuite_causal_graph_camuv}
\end{subfigure}
    \caption{ADMG identification results on fork-collider dataset.}
    \label{fig:csuite_causal_graph}
\end{figure}


\setlength{\tabcolsep}{3pt}
\begin{wraptable}{r}{0.57\textwidth}
\vspace{-0.44cm} 
    \centering
    \small
    \caption{Causal discovery and inference results for the fork-collider dataset. The table shows the mean and standard error results across five different random seeds.}
    \begin{tabular}{lrrr}
        \toprule
        \textsc{\textbf{Method}} & \textsc{$G_D$ Fscore} & \textsc{$G_B$ Fscore} & \textsc{ATE RMSE} \\
        \midrule
        N-BF-ADMG-G & 0.64 (0.06) & \textbf{0.93 (0.07)} &\textbf{ 0.022 (0.003)} \\
        N-ADMG-G & 0.49 (0.02)  & \textbf{0.99 (0.00)} & 0.239 (0.067) \\
        N-DAG-G & 0.50 (0.00) & 0.00 (0.00) & \textbf{0.046 (0.025)}  \\
        FCI & 0.00 (0.00) & 0.75 (0.00) & 0.072 (0.015) \\
        RCD & 0.00 (0.00) & 0.54 (0.00) & 0.206 (0.029) \\
        CAM-UV & \textbf{0.80 (0.00)} & 0.67 (0.00) & \textbf{0.017 (0.003)} \\
        DCD & 0.00 (0.00) & 0.67 (0.00) & 0.208 (0.064) \\
        \bottomrule
    \end{tabular}
    \label{tab:csuite_results}
    \vspace{-8pt}
\end{wraptable}

\Cref{fig:csuite_causal_graph_nbfadmg}-\ref{fig:csuite_causal_graph_camuv} visualizes the causal discovery results of different methods, and \Cref{tab:csuite_results} summarizes both discovery and inference metrics. While no methods can fully recover the ground truth graph, our method N-BF-ADMG-G and CAM-UV achieved the best overall performance. N-BF-ADMG-G and N-ADMG-G on average are able to recover all bidirected edges from the data, while CAM-UV can only recover half of the latent variables. Without the bow-free constraint, N-ADMG-G discovers a directed edge from $x_4$ to $x_3$, which results in poor ATE RMSE performance. On the other hand, DAG-based method (N-DAG-G) is not able to deal with latent confounders, resulting in the poor f-scores in both $G_D$ and $G_B$. Linear ANM-based methods (RCD and DCD) perform significantly worse than other methods, resulting in 0 f-scores for directed matrices and largest ATE errors. This demonstrates the necessity for introducing non-linear assumptions. 


\subsection{Random Confounded ER Synthetic Dataset}
\label{subsec:er_sf}
We generate synthetic datasets from ADMG extension of \textit{Erd\H{o}s-R\'enyi} (ER) graph model \citep{lachapelle2019gradient}. We first sample random ADMGs from ER model, and simulate each variable using a randomly sampled nonlinear ANM. Latent confounders are then removed from the training set. See \Cref{app: er} for details. We consider the number of nodes, directed edges and latent confounders triplets $(d, e, m) \in \{(4, 6, 2), (8, 20, 6), (12, 50, 10)\}$. The resulting datasets are identified as \textbf{ER}$(d, e, m)$. \Cref{fig:er_causal_discovery} compares the performance of \modelname\ with the baselines. All variants of \modelname\ outperform the baselines for most datasets, highlighting its effectiveness relative to other methods (even those that employ similar assumptions). Similar to the fork-collider dataset, we see that methods operating under the assumption of linearity perform poorly when the data-generating process is non-linear. It is worth noting that even when the exogenous noise of \modelname\ is misspecified, its still exceeds that of other methods in most cases. This robustness is a desirable property as in many settings the form of exogenous noise is unknown.

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{er_causal_discovery_plot_4.png}
    \caption{Causal discovery results for synthetic ER datasets. For readability, the \modelname\ results are connected with lines. The figure shows mean results across five randomly generated datasets.}
    \label{fig:er_causal_discovery}
\end{figure}

\subsection{Infant Health and Development Program (IHDP) Dataset}
For the real-world datasets, we evaluate treatment effect estimation performances on infant health and development program data (IHDP). This dataset contains measurements of both infants and their mother during real-life data collected in a randomized experiment. The main task is to estimate the effect of home visits by specialists on future cognitive test scores of infants, where the ground truth outcomes are simulated as in \citep{hill2011bayesian}. To make the task more challenging, additional confoundings are introduced by removing a subset (non-white mothers) of the treated population. More details can be found in \Cref{app: ihdp}. We first perform causal discovery to learn the underlying ADMG of the dataset, and then perform causal inference. Since the true causal graph is unknown, we evaluate the causal inference performance of each method by estimating the ATE RMSE.

Apart from the aforementioned baselines, here we introduce four more methods: PC-DWL (PC algorithm for discovery, DoWhy \citep{sharma2021dowhy} linear adjustment for inference); PC-DwNL (PC for discovery, DoWhy double machine learning for inference); N-DAG-G-DwL (N-DAG Gaussian for discovery, linear adjustment for inference); and N-DAG-S-DwL (N-DAG Spline for discovery, linear adjustment for inference). Results are summarized in \Crefrange{fig: ihdp_g}{fig: ihdp_dowhy}. Generally, models with non-Gaussian exogenous assumptions tend to have lower ATE estimation errors; while models with linear assumptions (RCD and DCD) have the worst ATE RMSE. Interestingly, the DoWhy-based plug-in estimators tend to worsen the performances of SCM models. However, regardless of the assumptions made on exogenous noise, our method (N-BF-ADMG-G and N-BF-ADMG-S) consistently outperforms all other baselines with the same noise.  It is evident that for causal inference in real-world datasets, the ability of N-BF-ADMG to handle latent confoundings and nonlinear causal relationships becomes very effective. 

\begin{figure}[h]
    \begin{subfigure}{0.3\columnwidth}
        \includegraphics[width=\textwidth]{ihdp_results_gaussian_plot3.png}
        \caption{Gaussian exogenous noise.}
        \label{fig: ihdp_g}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.3\columnwidth}
        \includegraphics[width=\textwidth]{ihdp_results_spline_plot3.png}
        \caption{Spline exogenous noise.}
        \label{fig: ihdp_s}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.3\columnwidth}
        \includegraphics[width=\textwidth]{ihdp_results_dowhy_plot3.png}
        \caption{DoWhy baselines.}
        \label{fig: ihdp_dowhy}
    \end{subfigure}
    \caption{Causal inference results for the IHDP dataset. The figure shows mean $\pm$ standard error results across five random initialisations.}
    \label{fig:ihdp_causal_inferenc}
\end{figure}

\section{Conclusion And Future Work}

In this work, we proposed Neural ADMG Learning (\modelname), a novel framework for gradient-based causal reasoning in the presence of latent confounding for nonlinear SCMs. We established identifiability theory for nonlinear ADMGs under latent confounding, and proposed a practical ADMG learning algorithm that is both flexible and efficient. In future work, we will further extend our framework on how to more general settings (e.g., the effect from observed and latent variables can modulate in certain forms; latent variables can confound adjacent variables; etc), and how to improve certain modelling choices such as variational approximation qualities over both causal graph and latent variables

\section*{Reproducibility Statement}
A number of efforts have been made/will be made for the sake of reproducibility. First, we open source our package in our github page \texttt{github.com/microsoft/causica/tree/v0.0.0}. In addition, in this paper we included clear explanations of any assumptions and a complete proof of the claims in the Appendix, as well as model settings and hyperparameters. All datasets used in this paper are either publicly available data, or synthetic data whose generation process is described in detail. 




\bibliography{bibliography}
\bibliographystyle{iclr2023_conference}

\appendix

\newpage

\begin{center}
{\huge APPENDIX}
\end{center}


\section{Proof of \Crefrange{lem:bidirected}{lem:directed}}
\label{app:lemmas}

First we describe the residual faithfulness condition inherited from \citep{maeda2021causal} in our \Crefrange{lem:bidirected}{lem:directed}:

\begin{defi}[Residual faithfulness condition] \label{def: residual}
 We say that nonlinear functions $g_i, g_j$ satisfies the residual faithfulness condition, if: for any two arbitrary subset of $\bfx$, denote by $M$ and $N$, when both $(x_i - g_i(M))$ and $(x_i - g_j(M))$ have terms involving the same exogenous noise $\epsilon_k$, then $(x_i - g_i(M))$ and $(x_i - g_j(M))$ are mutually dependent.
\end{defi}


Next, we provide the proof for \Crefrange{lem:bidirected}{lem:directed} in \Cref{sec:structural_identifiability}. To prove those lemmas, we need the help of the following lemma, which extends Lemma A in \citep{maeda2021causal}, except we don't assume any form for $g_i$ other than non-linearity.
\begin{lem}
    \label{lem:a}
    Let $s(x_i)$ denote an arbitrary function of $x_i$. The residual of $s(x_i)$ regressed onto $\bfx_{- i}$ cannot be independent of $\epsilon_i$:
    \begin{equation}
        \forall g_i,\ [s(x_i) - g_i(\bfx_{- i}) \cancel{\indep} \epsilon_i].
    \end{equation}
\end{lem}
\begin{proof}
Assume that $[s(x_i) - g_i(\bfx_{- i}) \indep \epsilon_i]$ holds, then $\bfx_{- i}$ must contain at least one descendent of $x_i$ as it must have dependence on the noise $\epsilon_i$ to cancel effect of $\epsilon_i$ in $s(x_i)$. We can express $g_i(\bfx_{- i})$ as $u_i(\*\epsilon)$.  Since $g_i$ operates on variables defined by non-linear transformations of the exogenous noise terms, we cannot express $u_i$ as $a_i(\*\epsilon_{- i}) + b_i(\epsilon_i)$. $\bfx_{- i}$ contains a descendent of $x_i$, so $\*\epsilon_{- i}$ includes at least one noise term $\epsilon_k$ that satisfies $x_i \indep \epsilon_k$ (i.e. is not in $x_i$). Thus, terms containing $\epsilon_i$ cannot be fully removed from $s(x_i) - g_i(\bfx_{- i})$ and so $[s(x_i) - g_i(\bfx_{- i}) \indep \epsilon_i]$ does not hold.
\end{proof}

\subsection{Proof of \Cref{lem:bidirected}}
\begin{proof}

Define $g_i$ and $g_j$ as $g_i(\bfx_{- i}) = f_{i, \bfx}(\textbf{pa}_{\bfx}(i)) + g'_i(\bfx_{- i})$ and $g_j(\bfx_{- j}) = f_{j, \bfx}(\textbf{pa}_{\bfx}(j)) + g'_i(\bfx_{- j})$ respectively. Then, \Cref{eq:dependent_residuals} becomes equivalent to 
\begin{equation}
    \forall g'_i, g'_j,\ [(f_{i, \bfu}(\textbf{pa}_{\bfu}(i)) + \epsilon_i - g'_i(\bfx_{- i}) \cancel{\indep} (f_{j, \bfu}(\textbf{pa}_{\bfu}(j)) + \epsilon_j - g'_j(\bfx_{- j})].
\end{equation}

Given \Cref{lem:a} and following the same arguments as in \cite{maeda2021causal}, this is equivalent to
\begin{equation}
    (f_{i, \bfu}(\textbf{pa}_{\bfu}(i)) + \epsilon_i) \cancel{\indep} (f_{j, \bfu}(\textbf{pa}_{\bfu}(j)) + \epsilon_j).
\end{equation}
Since $\epsilon_i \indep \epsilon_j$, we have
\begin{equation}
    (f_{i, \bfu}(\textbf{pa}_{\bfu}(i)) \cancel{\indep} \epsilon_j) \lor (n_i \cancel{\indep} f_{j, \bfu}(\textbf{pa}_{\bfu}(j))) \lor (f_{i, \bfu}(\textbf{pa}_{\bfu}(i)) \cancel{\indep} f_{j, \bfu}(\textbf{pa}_{\bfu}(j))).
\end{equation}
The first implies the existence of an unobserved mediator between $x_j$ and $x_i$, the second implies the existence of an unobserved mediator between $x_i$ and $x_j$, and the third implies the existence of an unobserved confounder. Given the assumption of latent variables being confounders and minimality, this indicates the presence of a latent confounder and no direct cause between $x_i$ and $x_j$. 
\end{proof}

\subsection{Proof of \Cref{lem:no_edge}}
\begin{proof}
When \Cref{eq:no_cause} holds, \Cref{eq:dependent_residuals} does not. Thus, there is no unobserved confounder between $x_i$ and $x_j$. Assume that $x_j$ is a direct cause of $x_i$, and that \Cref{eq:no_cause} is satisfied for $g_i$ and $g_j$. $x_i$ contains a nonlinear function of $\epsilon_j$ that cannot be removed by $g_i(\bfx_{- (i, j)})$, thus $(x_i - g_i(\bfx_{- (i, j)})) \cancel{\indep} \epsilon_j$. Similarly, $(x_j - g_j(\bfx_{- (i, j)})) \cancel{\indep} \epsilon_i$. Thus, we have $[(x_i - g_i(\bfx_{-(i, j)}) \cancel{\indep} (x_j - g_j(\bfx_{-(i, j)}))]$ which contradicts our initial assumption. The same arguments apply when $x_i$ is a direct cause of $x_j$, implying that there can be no causal relationship between $x_i$ and $x_j$.
\end{proof}

\subsection{Proof of \Cref{lem:directed}}
\begin{proof}
When \Cref{eq:causal_independence} holds, \Cref{eq:dependent_residuals} does not and so there is no latent confounder between $x_i$ and $x_j$. When $\Cref{eq:causal_dependence}$ holds, \Cref{eq:no_cause} does not hold and so there is a direct causal relationship between $x_i$ and $x_j$. 

Assume that $x_j$ is a direct cause of $x_i$. Define $g_1(\bfx_{- i}) = f_{i, \bfx}(\textbf{pa}_{\bfx}(i))$ and $g_2(\bfx_{- (i, j)}) = f_{j, \bfx}(\textbf{pa}_{\bfx}(j))$, giving $x_i - g_i(\bfx_{- i}) = f_{i, \bfu}(\textbf{pa}_{\bfu}(i)) + \epsilon_i$ and $x_j - g_j(\bfx_{- (i, j)}) = f_{j, \bfu}(\textbf{pa}_{\bfu}(j)) + \epsilon_j$. When there is no latent confounder, $f_{i, \bfu}(\textbf{pa}_{\bfu}(i)) \indep f_{j, \bfu}(\textbf{pa}_{\bfu}(j))$. Thus, $(f_{i, \bfu}(\textbf{pa}_{\bfu}(i)) + \epsilon_i) \indep (f_{j, \bfu}(\textbf{pa}_{\bfu}(j)) + \epsilon_j)$ hods and \Cref{eq:causal_independence} is satisfied.

Now, assume that $x_i$ is a direct cause of $x_j$. Using \Cref{lem:a}, we have
\begin{equation}
    \forall g_i,\ [(x_i - g_i(\bfx_{- i}) \cancel{\indep} \epsilon_i].
\end{equation}
Similarly, since $x_j$ is a function of $x_i$ we also have
\begin{equation}
    \forall g_j,\ [(x_j - g_j(\bfx_{- (i, j)}) \cancel{\indep} \epsilon_i].
\end{equation}
Collectively, this implies
\begin{equation}
    \forall g_i, g_j,\ [(x_i - g_i(\bfx_{- i}) \cancel{\indep} (x_j - g_j(\bfx_{- i, j})]
\end{equation}
which contradicts \Cref{eq:causal_independence}. Thus, if \Cref{eq:causal_independence} is satisfied then $x_j$ is a direct cause of $x_i$.
\end{proof}


\section{Proof of \Cref{prop: 2}} \label{app: prop_2}
To prove \Cref{prop: 2}, we need the following lemma:
\begin{lem}\label{lemma: prior negeligible}
Assume a variational distribution $q_\phi(G)$ over a space of graphs $\mathcal{G}_\phi$, where each graph $G\in \mathcal{G}_\phi$ has a non-zero associated weight $w_\phi(G)$. With the soft prior $p(G)$ defined as \Cref{eq: graph_prior} and bounded $\lambda_1, \lambda_2, \rho,\alpha$, we have
\begin{equation}
    \lim_{N\rightarrow \infty}\frac{1}{N}\mathrm{KL}[q_\phi(G)\Vert p(G)] = 0.
\end{equation}
\end{lem}


\begin{proof}
This directly follows from Lemma 1 of \citep{geffner2022deep}.
\end{proof}

Now we can proceed to prove \Cref{prop: 2}:


\begin{proof}
For \modelname, in the infinite data limit $\mcL_{\textrm{ELBO}}$ becomes
\begin{equation}
    \begin{aligned}
    &\lim_{N \rightarrow \infty}\frac{1}{N} \sum_{n=1}^N \Exp{q_{\phi}(G)q(\bfu_n | G)}{\log p_{\theta}(\bfx_n, \bfu_n | G)} - \frac{1}{N}\sum_{n=1}^N H[q(\bfu_n | \bfx_n, G)] - \underbrace{\frac{1}{N}\KL{q(G)}{p(G)}}_{\rightarrow 0} \\
    &= \lim_{N \rightarrow \infty}\frac{1}{N} \sum_{n=1}^N  \sum_{G \in \mathcal{G}_\phi} w_\phi(G) \Exp{q(\bfu|\bfx, G)} {\log p_{\theta}(\bfx_n | \bfu_n, G)} - \frac{1}{N}\sum_{n=1}^N \Exp{q(G)}{\KL{q(\bfu_n | \bfx_n G)}{p(\bfu_n | \bfx_n, G)}}.
    \end{aligned}
\end{equation}
where the zeroing of the KL divergence follows from \Cref{lemma: prior negeligible}. Given fixed $\theta$, the optimal posterior $q^*(\bfu_n | \bfx_n, G)$ satisfies $q^*(\bfu_n | \bfx_n, G) = p_{\theta}(\bfu_n | \bfx_n, G)$ due to the flexibility assumption. Thus,
\begin{equation}
\begin{aligned}
& \lim_{N \rightarrow \infty} \mcL_{\textrm{ELBO}}(\theta, \phi, q^*(\bfu_n | \bfx_n, G)) \\
    = & \lim_{N \rightarrow \infty}\frac{1}{N} \sum_{n=1}^N  \sum_{G \in \mathcal{G}_\phi} w_\phi(G)  {\log p_{\theta}(\bfx_n | G)} \\
    = & \int p(\bfx;G^0)\sum_{G\in \mathcal{G}_\phi}w_\phi(G)\log p_\theta(\bfx|G)d\bfx 
\end{aligned}
\end{equation}
where $p(\bfx;G^0)$ denotes the data generation distribution with the ground truth ADMG, $G^0$. Let $(\theta^*, G^*) = \arg \max \int p(\bfx;G^0) \log p_\theta(\bfx|G)d\bfx$ be the MLE solution. Since $\sum_{G\in\mathcal{G}_\phi} w_\phi(G)=1$, $w_\phi(G)>0$, we have
\begin{align*}
    \sum_{G\in\mathcal{G}_\phi}w_\phi(G)\mathbb{E}_{p(\bfx;G^0)}\left[\log p_\theta(\bfx|G)\right]\leq \mathbb{E}_{p(\bfx;G^0)}\left[\log p_{\theta^*}(\bfx;G^*)\right]
\end{align*}
with the optimal value of $\sum_{G\in\mathcal{G}_\phi}w_\phi(G)\mathbb{E}_{p(\bfx;G^0)}\left[\log p_\theta(\bfx|G)\right]$ is achieved  when every graph $G\in\mathcal{G}_\phi$ and associated parameter $\theta_G$ satisfies 
\begin{equation}
    \mathbb{E}_{p(\bfx;G^0)}\left[\log p_{\theta_G}(\bfx|G)\right] = \mathbb{E}_{p(\bfx;G^0)}\left[\log p_{\theta^*}(\bfx|G^*)\right].
    \label{eq: prop_2_proof_condition}
\end{equation}
Since the model is correctly specified, the MLE solution $(\theta^*, G^*)$ satisfies
\[
\mathbb{E}_{p(\bfx;G^0)}\left[\log p_{\theta^*}(\bfx|G^*)\right] = \mathbb{E}_{p(\bfx;G^0)}\left[\log p(\bfx;G^0)\right]
\]
Therefore, condition \Cref{eq: prop_2_proof_condition} implies for every graph $G' \in\mathcal{G}_\phi$, $G' = G^0$ under the regularity condition; or equivalently, $\mathcal{G}_\phi = \{G' = G^0 \}$. This proves our statement that $q'_\phi({G})=\delta({G}={G}')$, where ${G}'={G}^0$. 

\end{proof}

\section{Estimating Treatment Effects}
\label{app:estimating_te}
For all experiments we consider, the causal quantity of interest we wish to estimate is the expected average treatment effect (ATE), $\Exp{q_{\phi}(G)}{\text{ATE}(\bfa, \bfb | G)}$, where the expectation is taken with respect to our learned posterior over causal graphs $q_{\phi}(G)$:
\begin{equation}
    \label{eq:ate}
    \Exp{q_{\phi}(G)}{\text{ATE}(\bfa, \bfb | G)} = \Exp{q_{\phi}(G)}{\Exp{p(\bfx_Y | \text{do}(\bfx_T = \bfb), G)}{\bfx_Y} - \Exp{p(\bfx_Y | \text{do}(\bfx_T = \bfb), G)}{\bfx_Y}}.
\end{equation}
This requires samples from $p(\bfx_Y | \text{do}(\bfx_T = \bfb), G) = p(\bfx_Y | \bfx_T = \bfb, G_{\text{do}(\bfx_T)})$, where $G_{\text{do}(\bfx_T)}$ is the `mutilated' graph obtained by removing incoming edges into $\bfx_T$. We can achieve this by simulating the learnt SCM on $G_{\text{do}(\bfx_T)}$ whilst keeping $\bfx_T = \bfb$ fixed. Note that $q_{\phi}(\bfu | \bfx)$ is not used to estimate the ATE; it suffices to sample $\bfu$ from the prior distribution, $p(\bfu)$. In our setting, the inference MLP $q_{\phi}(\bfu | \bfx)$ is only used as a means through which the likelihood of the data can be evaluated efficiently, and thus model parameters learned. This is in a similar spirit to VAEs \citep{kingma2013auto}.

\section{Related Work On Causal Inference Under Latent Confounding}

Attempting to perform causal inference in the presence of latent confounding can lead to biased estimates \citep{pearl2012measurement}. Whilst the observed data distribution may still be identifiable, estimating causal effects are not \citep{spirtes2000causation}. A recent string of work has made progress in the case where the effects of multiple interventions are being estimated \citep{tran2017implicit, ranganath2018multiple, wang2019blessings, damour2019on}. An alternative approach is to assume identifiability of the joint distribution over both latent and observed variables given just the observations. \cite{louizos2017causal} point out that there are many cases in which this is possible \citep{khemakhem2020variational, kingma2013auto}. Nevertheless, all these methods assume the underlying causal graph is known. More recently, \cite{mohammad2021calculus} argue that a DAG latent variable model trained on data can be used for down-stream causal inference tasks even if its parameters are non-identifiable, as long as the query can be identified from the observed variables according to the do-calculus. 


\section{Additional Discussions on Structural Identifiability of Latent Variables}
\label{app:latent_structural_identfiability}

In \Cref{subsec:background/latent_confounders}, we argued that the identifiability of ADMG does not imply the structural identifiability of the magnified SCM. In this section, we will present more discussions on certain identifiability of latent structures (of magnified SCMs). In general, these examples demonstrate that for linear non-Gaussian ANMs the structure of latent variables can be refined beyond the assumption of latent confounders acting between pairs of non-adjacent observed variables, whilst the same techniques cannot achieve the same for non-linear ANMs.

\subsection{Determining Causal Structure Amongst Latent Variables}
Recently, \cite{cai2019triad} demonstrated that it is possible to discover the structure amongst latent variables using their so-called Triad constraints. Their method is limited to the linear non-Gaussian ANM case. In this section, we demonstrate that an analogous constraint isn't available for non-linear ANMs.
\begin{figure}[h]
    \centering
    \begin{subfigure}[b]{0.45\textwidth}
    \centering
    \begin{tikzpicture}
        \node[state] (u1) at (0,0) {$u_1$};
        \node[state] (u2) [right =of u1] {$u_2$};
        \node[state] (xi) [below =of u1] {$x_i$};
        \node[state] (xj) [below =of u2] {$x_j$};
        \node[state] (xk) [right =of xj] {$x_k$};
        
        \path (u1) edge node[above] {$f_{12}$} (u2);
        \path (u1) edge node[left] {$f_{1i}$} (xi);
        \path (u2) edge node[left] {$f_{2j}$} (xj);
        \path (u2) edge node[right] {$f_{2k}$} (xk);
    \end{tikzpicture}
    \caption{}
    \label{fig:triad1}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.45\textwidth}
    \centering
    \begin{tikzpicture}
        \node[state] (u1) at (0,0) {$u_1$};
        \node[state] (u2) [right =of u1] {$u_2$};
        \node[state] (xi) [below =of u1] {$x_i$};
        \node[state] (xj) [below =of u2] {$x_j$};
        \node[state] (xk) [right =of xj] {$x_k$};
        
        \path (u2) edge node[above] {$f_{21}$} (u1);
        \path (u1) edge node[left] {$f_{1i}$} (xi);
        \path (u2) edge node[left] {$f_{2j}$} (xj);
        \path (u2) edge node[right] {$f_{2k}$} (xk);
    \end{tikzpicture}
    \caption{}
    \label{fig:triad2}
    \end{subfigure}
    \caption{The two possible latent variable structures considered by \cite{cai2019triad}.}
\end{figure}

Consider the causal graphs shown in \Cref{fig:triad1} and \Cref{fig:triad2}.
\begin{lem}[Linear non-Gaussian identifiability]
In the linear non-Gaussian ANM case, \Cref{eq:triad_constraint} is satisfied only for the causal graph shown in \Cref{fig:triad2}. In the non-linear ANM case, \Cref{eq:triad_constraint} is not satisfied for either \Cref{fig:triad1} or \Cref{fig:triad2}.
\begin{equation}
\label{eq:triad_constraint}
    \exists g,\quad x_i - g(x_j) \indep x_k
\end{equation}
\end{lem}
\begin{sproof}
For the causal graph in \Cref{fig:triad1}, \Cref{eq:triad_constraint} is equivalent to
\begin{equation}
    \exists g\quad f_{1i}(u_1) + \epsilon_i - g(f_{2j}(f_{12}(u_1), u_2), \epsilon_j) \indep f_{2k}(f_{12}(u_1), u_2) + \epsilon_k.
\end{equation}
On the right, we have some function of the latent variables $u_1$ and $u_2$, $f_{2k}(f_{12}(u_1), u_2)$. On the left, we have some function of the same noise terms, $f_{1i}(u_1) - g(f_{2j}(f_{12}(u_1), \epsilon_j)$. To remove $u_1$ from both sides, we require $g$ to be non-zero and so a term including $u_2$ is still present. To remove $u_2$, we again require $g$ to be non-zero and so a term including $u_1$ is still present. Thus, \Cref{eq:triad_constraint} is not satisfied in either the linear non-Gaussian or non-linear ANM case.

For the causal graph in \Cref{fig:triad2}, \Cref{eq:triad_constraint} is equivalent to
\begin{equation}
    \exists g\quad f_{1i}(f_{21}(u_2), u_1) + \epsilon_i - g(f_{2j}(u_2) + \epsilon_j) \indep f_{2k}( u_2) + \epsilon_k.
\end{equation}
In the linear case, we can construct a linear $g$ to remove $u_2$ fom the left side so that \Cref{eq:triad_constraint} holds (i.e.\ $g = \frac{f_{1i}f_{21}}{f_{2j}}$). In the non-linear case, $u_1$ and $u_2$ are coupled in the leftmost term and cannot be removed by a term involving $u_2$ and $\epsilon_j$. Hence, \Cref{eq:triad_constraint} is violated.
\end{sproof}

\subsection{Determining the Number of Latent Confounders}
Here, we consider whether the number of latent confounders can be determined in the non-linear ANM case. \Cref{lem:triple_confounded} shows that in the linear non-Gaussian case, the number of latent confounders acting between a triplet of confounded observed variables can be determined (by verifying certain constraints on marginal distributions on observed variables), whilst the same approach cannot be used in the non-linear ANM case.

Consider the two causal graphs shown in \Cref{fig:triple_confounded1} and \Cref{fig:triple_confounded2}.
\begin{lem}[Linear non-Gaussian identifiability]
\label{lem:triple_confounded}
In the linear non-Gaussian ANM case, \Cref{eq:triple_confounded} is satisfied only for the causal graph shown in \Cref{fig:triad2}. In the non-linear ANM case, \Cref{eq:triple_confounded} is not satisfied for either \Cref{fig:triad1} or \Cref{fig:triad2}.
\begin{equation}
\label{eq:triple_confounded}
    \exists g,\quad x_i - g(x_j) \indep x_k.
\end{equation}
\end{lem}
\begin{sproof}
For \Cref{fig:triple_confounded2}, \Cref{eq:triple_confounded} is equivalent to
\begin{equation}
    \exists g \quad f_i(u) + \epsilon_i - g(f_j(u) + \epsilon_j) \indep f_k(u) + \epsilon_k.
\end{equation}
In the linear non-Gaussian case, it is straightforward to set $g = \frac{f_i}{f_j}$ to remove the common noise term $u$ from the left term and make the two sides independent. In the non-linear case, when $f_i \neq f_j$ the common noise term $u$ cannot be removed from the left as $g$ must be non-linear, and thus produces a term that involves both $u$ and $\epsilon_j$. 
For \Cref{fig:triple_confounded1}, \Cref{eq:triple_confounded} is equivalent to
\begin{equation}
    \exists g \quad f_i(u_1, u_2) + \epsilon_i - g(f_j(u_1, u_3) + \epsilon_j) \indep f_k(u_2, u_3) + \epsilon_k.
\end{equation}
$u_2$ cannot be removed from the left, and so \Cref{eq:triple_confounded} does not hold in either the linear non-Gaussian or non-linear case.
\end{sproof}

\begin{figure}[h]
    \centering
    \begin{subfigure}[b]{0.45\textwidth}
    \centering
    \begin{tikzpicture}
        \node[state] (1) {$u_1$};
        \node[state] (2) [right =of 1] {$u_2$};
        \node[state] (3) [right =of 2] {$u_3$};
        \node[state] (4) [below =of 1] {$x_i$};
        \node[state] (5) [below =of 2] {$x_j$};
        \node[state] (6) [below =of 3] {$x_k$};
    
        \path (1) edge node[left] {$f_{1i}$} (4);
        \path (1) edge node[right] {$f_{1j}$} (5);
        \path (2) edge node[left] {$f_{2i}$} (4);
        \path (2) edge node[right] {$f_{2k}$} (6);
        \path (3) edge node[left] {$f_{3j}$} (5);
        \path (3) edge node[right] {$f_{3k}$} (6);
    \end{tikzpicture}
    \caption{}
    \label{fig:triple_confounded1}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.45\textwidth}
    \centering
    \begin{tikzpicture}
        \node[state] (1) {$x_i$};
        \node[state] (2) [right =of 1] {$x_j$};
        \node[state] (3) [right =of 2] {$x_k$};
        \node[state] (4) [above =of 2] {$u$};
        
        \path[state] (4) edge node[left] {$f_{i}$} (1);
        \path[state] (4) edge node[left] {$f_{j}$} (2);
        \path[state] (4) edge node[right] {$f_{k}$} (3);
        
    \end{tikzpicture}
    \caption{}
    \label{fig:triple_confounded2}
    \end{subfigure}
    \caption{Two possible latent structures that confound each pair of variables $x_i$, $x_j$ and $x_k$.}
\end{figure}

\section{Optimisation Details}
\label{app:experiments}

\subsection{Optimisation Details for \modelname}
As discussed in \Cref{sec:\modelname}, we gradually increase the prior hyperparameters $\rho$ and $\alpha$ throughout training. This is done using the augmented Lagrangian procedure for optimisation \citep{}. The optimisation process interleaves two steps: 1) optimise the objective for fixed values of $\rho$ and $\alpha$ for a certain number of steps; and ii) update the values of $\rho$ and $\alpha$. Steps i) and ii) and ran until convergence, or the maximum number of optimisation steps is reached. We describe these two steps in more detail below.

\paragraph{Step i).} The objective is optimised for some fixed vales of $\rho$ and $\alpha$ using Adam \citep{}. We use a learning rate of $10^{-3}$ for the model parameters and $5\times 10^{-3}$ for the variational parameters. We optimise the objective for a maxmimum of 5000 steps or until convergence (we stop early if the loss does not improve for 1500 optimisation steps, moving to step ii)). During training, we reduce the learning rate by a factor of 10 if the training loss does not improve for 1000 steps a maximum of two times. If we reach the condition a third time, we assume optimisation has converged and move to step ii). We apply annealing to the KL-divergence between the approximate posterior and prior over the latent variables. The annealing contant is fixed for each step i), and increased linearly over the first optimisation loops.

\paragraph{Step ii).} We initialise $\rho = 1$ and $\alpha = 0$. At the beginning of step i) we measure the DAG / bow-free penalty $P_1 = \Exp{q_{\phi}(G)}{h(G)}$. At the beginning of step ii), we measure this penalty again, $P_2 = \Exp{q_{\phi}(G)}{h(G)}$. If $P_2 < P_1$, we leave $\rho$ unchanged and update $\alpha \leftarrow \alpha + \rho P_2$. Otherwise, if $P_2 \geq 0.65 P_1$, we leave $\alpha$ unchanged and update $\rho \leftarrow 10 \rho$. We repeat the steps i) to ii) a maximum of 30 times or until convergence (measured as $\alpha$ or $\rho$ reaching some max value which we set to $10^3$ for both).

\subsection{Additional Hyperparameters}
\paragraph{Prior Hyperparameters.} We use the sparsity inducing prior hyperparameters $\lambda_{s, 1} = \lambda_{s, 2} = 5$. 

\paragraph{ELBO approximation.} We construct an approximation to the ELBO in \Cref{eq:elbo} using a single sample from the approximate posteriors. For evaluating the gradients of the ELBO we use the Gumbel softmax method with a hard forward pass and soft backward pass with temperature of 0.25.

\paragraph{Neural network architectures.} The functions $\xi_1$, $\xi_2$ and $\ell$ used in the likelihood and the inference network used to parameterise $q_{\phi}(\bfu | \bfx)$ are all two hidden layer MLPs with 80 hidden units per hidden layer. 

\paragraph{Non-Gaussian noise model.}
For the non-Gaussian noise model 

\paragraph{ATE estimation.} For ATE estimation we compute expectations by drawing 1000 graphs from the learnt posterior, and for each graph we draw two samples of $\bfx_Y$ for a total of 2000 samples which we used to form a Monte Carlo estimate.

\section{Dataset Details}
\label{app:dataset_details}
\subsection{Synthetic Fork-Collider Dataset}
We constructed a 2000 sample synthetic dataset with the causal structure shown in \Cref{fig:csuite_causal_graph} by sampling from the following SEM:
\begin{equation}
    \begin{aligned}
    [u_1,\ u_2,\ \epsilon_1,\ \epsilon_2,\ \epsilon_3,\ \epsilon_4,\ \epsilon_5]^T &\sim \shortNormal{\*0}{\bfI} \\
    x_1 &= \epsilon_1 \\
    x_2 &= \sqrt{6} \exp(-u_1^2) + 0.1 \epsilon_2 \\
    x_3 &= \sqrt{6} \exp(-u_1^2) + \sqrt{6} \exp(-u_2^2) + 0.2 \epsilon_3 \\
    x_4 &= \sqrt{6} \exp(-u_2^2) + \sqrt{6} \exp(-x_1^2) + 0.1 \epsilon_4 \\
    x_5 &= \sqrt{6} \exp(-x_1^2) + 0.1 \epsilon_5.
    \end{aligned}
\end{equation}
Variables $u_1$ and $u_2$ are latent confounders acting on variable pairs $x_2$ and $x_3$, and $x_3$ and $x_4$, respectively.

\subsection{Latent confounded ER Dataset} \label{app: er}

We generate synthetic datasets from ADMG extension of \textit{Erd\H{o}s-R\'enyi} (ER) graph model \citep{lachapelle2019gradient, zheng2020learning}. An \textbf{ER}$(d, e, m)$ dataset is generated according the following procedures:
\begin{enumerate}[leftmargin=*]
    \item Generate a $d \times d$ directed adjacency matrix $G_D$ of a ADMG from \textit{Erd\H{o}s-R\'enyi} (ER) graph model, whose expected directed edges equal to $e$; 
    \item Simulate $d \times d$ bidirected adjacency matrix $G_B$ via random Bernoulli sampling, whose expected number equals to $m$;
    \item Simulate exogenous noises $\epsilon_i$ from a zero mean Gaussian distribution with standard deviation of 0.1;
    \item Simulate latent variables $\bfu$ from a zero mean Gaussian distribution with standard deviation of 0.1;
    \item Simulate each observed variable as $x_i = f_i(\bfx_{\text{pa}(i; G_D)}) + g_i( \bfu_{\text{pa}(i; G_B)}) + \epsilon_i$, where $f_i, g_i$ are randomly sampled nonlinear functions of the form:
    $y = \bfw^T\ e^{-\bfx^2}$.
    \item Remove $\bfu$ from the sampled dataset.
\end{enumerate}

\subsection{IHDP Dataset Details}
\label{app: ihdp}
% \textbf{IHDP} \citep{hill2011bayesian}.
This dataset contains measurements of both infants (birth weight, head circumference, etc.) and their mother (smoked cigarettes, drank alcohol, took drugs, etc) during real-life data collected in a randomised experiment. The main task is to estimate the effect of home visits by specialists on future cognitive test scores of infants. The outcomes of treatments are simulated artificially as in \cite{hill2011bayesian}; hence the outcomes of both treatments (home visits or not) on each subject are known. Note that for each subject, our models are only exposed to only one of the treatments; the outcomes of the other potential/counterfactual outcomes are hidden from the mode, and are only used for the purpose of ATE evaluation. To make the task more challenging, additional confoundings are manually introduced by removing a subset (non-white mothers) of the treated children population. In this way we can construct the IHDP dataset of 747 individuals with 6 continuous covariates and 19 binary covariates. We use 10 replicates of different simulations based on setting B (log-linear response surfaces) of \cite{hill2011bayesian}, which can downloaded from \url{https://github.com/AMLab-Amsterdam/CEVAE}. We use a 70\%/30\% train-test split ratio. Before training our models, all continuous covariates are normalised.

\section{Run Time Comparison}
Here, we compare the run time of N-BF-ADMG and CAM-UV on a synthetically generated \textbf{ER}(12, 50, 10) dataset. The results are shown in \Cref{fig:runtime_results}. N-BF-ADMG is trained using 30k epochs to ensure convergence, whose run time can be further reduced via early stopping etc. The results in \Cref{fig:runtime_results} highlight that methods based on continuous optimisation (N-BF-ADMG) offer a significant improvement in run time relative to methods based on conditional independency tests (CAM-UV) for large datasets. In combination with the results in the main paper, this shows the empirical validity of deep learning approach for identifying ADMGs that scales to larger dataset, without sacrificing accuracy. 

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{runtime_plot.png}
    \caption{Run time results for N-BF-ADMG and CAM-UV on a 12 variable synthetic ER dataset. The figure shows mean results $\pm$ standard deviation across five randomly generated datasets.}
    \label{fig:runtime_results}
\end{figure}

\end{document}
