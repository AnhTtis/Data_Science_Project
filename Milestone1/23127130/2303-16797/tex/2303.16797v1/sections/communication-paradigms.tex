In this section, we first describe a structure and building blocks of a general \gls{ris}-aided communication paradigm that is applicable to a large number of potential systemic and algorithmic realizations. Then, we use the general paradigm to describe two particular transmission strategies and their respective systemic and algorithmic modules. %parameters for when data communication is taking place. 
We analyze their performance in terms of the expected \gls{snr} and \gls{se} while describing the errors eventually occurring during their operation.% the optimization of the transmission parameters.

\subsection{General paradigm structure}
Throughout the remainder of the paper, we assume that the system operates based on frames with duration, $\tau$, shorter than the channel coherence time, \emph{i.e.}, the channel coefficients are assumed to be constant -- or change negligibly -- over the duration of the frame. The channel coherence time is considered to be estimated beforehand and hence known at the beginning of each frame. 
Within each frame, a \gls{ris}-aided communication paradigm
can be divided into four main phases, namely \emph{``Setup''}, \emph{``Algorithmic''}, \emph{``Acknowledgement''}, and \emph{``Payload''}, described in the following. We note that there could be access algorithms in which some of these phases may not be present; however, the mentioned four phases set a basis for a sufficiently general framework that can be used, in principle, to design other schemes where some of the steps are merged or omitted.

% Before proceeding in describing the two possible implementations of the protocol, we illustrate a simple mechanism for the detection of the end of the channel coherence frame. As stated before, we assume that the channel changes in a negligibly during the frame duration. Therefore, the RIS configuration and the user's transmission power are the only factors that affect the received \gls{snr} at the \gls{bs}. In the payload phase, the \gls{ris} configuration does not change and the \gls{bs} is assumed to know the average user's transmit power. Therefore, a running average of the received \gls{snr} can be kept by the \gls{bs}. When the running average is observed to differ substantially from the average \gls{snr} at the beginning of the payload phase, it is safe to assume that the channel coherence frame is at its end. At this point, the \gls{bs} re-sends the control information initializing the Setup phase of the next frame.

\paragraph*{Setup} 
The communication procedure starts with the Setup phase; it is typically initiated by the \gls{bs} and relies on control signaling to notify the \gls{ris} and the scheduled \gls{ue} about the start of the new round of transmissions, \emph{i.e.}, a frame. It is assumed that the \gls{risc} loads the \gls{ctrl} configuration at the beginning of this phase. The duration of this phase is denoted with $\tau\set < \tau$ and it depends on the type of available \gls{cc}. Although not considered in this paper, the Setup phase can also incorporate the random access phase as an intermediate step where the scheduling and resource allocation needs of the \glspl{ue} are determined.

\paragraph*{Algorithmic} 
After the Setup is performed, the Algorithmic phase starts. In general, this phase encompasses all the processes and computations that are needed to optimize the data transmission taking place later on. This phase has a duration $\tau\alg < \tau$ that depends on the choice of the employed communication paradigm.
Apart from the evaluation of an appropriate \gls{ris} configuration enabling the data transmission, other objectives could be to determine the transmission parameters for the \gls{ue}, and/or \gls{bs} beamforming, etc. To tackle these objectives, some form of sensing of the wireless environment is required, typically enabled by the transmission of pilot sequences.
The specifications of those pilots, \emph{i.e.} their number, design, whether they are transmitted in the \gls{ul} or \gls{dl}, whether feedback is available, etc., are implementation- and system-defined.
The computational nodes of the system (usually, the \gls{bs}) use the collected pilot signals and invoke pre-defined algorithms to determine the aforementioned transmission parameters to be used in the Payload phase. The outcome of these algorithms might be affected by different types of \emph{algorithmic errors} that might prevent the system to perform as expected, and thus should be taken into account when analyzing the overall performance.

\paragraph*{Acknowledgement}
The Acknowledgement phase starts once the Algorithmic phase ends; during this phase, the \gls{ris} configuration chosen needs to be communicated to the \gls{risc}, which in turn commands the \gls{ris} to load the specified phase shifts. Additionally, some further control signaling may occur between the \gls{bs} and the \gls{ue} as a final check before the data transmission, for example, to set the \gls{mcs}. It is implied that the \gls{risc} loads the \gls{ctrl} configuration at the beginning of this phase. Similar to the Setup phase, the Acknowledgement phase duration $\tau\ack < \tau$, depends on the type of \gls{cc} used.

\paragraph*{Payload}
The payload phase is the last one, during which the actual data transmission takes place, which is in the \gls{ul} for this work. This phase spans a duration $\tau\pay < \tau$ until the end of the channel coherence frame. This phase may or may not include the feedback at the end; this aspect is not considered in this paper.

%\paragraph*{Paradigms overview}
In the following subsections, we describe two state-of-the-art paradigms for \gls{ris}-aided communications employing different approaches for the Algorithmic phase. The first is the \emph{\gls{oce}}, which follows a standard multiplexing transmission: the \gls{ue}'s \gls{csi} is evaluated at the \gls{bs}, which then uses this information to compute the \gls{ris}' optimal configuration and the corresponding achievable data rate. The \gls{bs} sends the optimal configuration to the \gls{risc}, which loads it to the \gls{ris} surface, while the \gls{ue} is instructed to transmit the data using the stipulated \gls{mcs}. The second approach is the \emph{\gls{bsw}}, which was formally defined as a communication paradigm in~\cite{An2022}, but already used in previous works (\emph{e.g.}, ~\cite{Croisfelt2022randomaccess}). This paradigm resembles the concept of diversity transmission. Here the \gls{bs} does not spend time figuring out the best configuration to improve the quality of the \gls{ue}-\gls{dc} and does not tune the transmission rate; it instead applies a best-effort strategy, as in every diversity-oriented transmission. Specifically, the \gls{bs}
instructs the \gls{risc} to sweep through a set of predefined configurations -- \emph{the configuration codebook} -- and hopes that at least one will satisfy a target \gls{kpi} \emph{a priori} specified for the transmission (\emph{e.g.}, a minimum \gls{snr} to support a predefined rate). Fig.~\ref{fig:RIS-frames} shows the data exchange diagrams of the two paradigms comprised of \gls{cc} messages, configuration loading, processing operations, and data transmission. Based on these, a detailed description of the two paradigms is given in the following sections. The details on the design and reliability of the messages being sent through the \glspl{cc} are given in Sect.~\ref{sec:ris-control}.

\begin{figure*}[tbh]
    \centering
    \begin{subfigure}[t]{0.48\linewidth}
        \centering
        \includegraphics[width=\textwidth]{figs/frame-oce.pdf}
        \caption{\gls{oce} paradigm.}
        \label{fig:RIS-oce}
    \end{subfigure}
    ~
    \begin{subfigure}[t]{0.48\linewidth}
        \centering
        \includegraphics[width=\textwidth]{figs/frame-bsw.pdf}
        \caption{\gls{bsw} paradigm.}
        \label{fig:RIS-bsw}
    \end{subfigure} 
    \caption{Data exchange diagram of the two \gls{ris}-aided communication paradigms. Signals traveling through \gls{ris}-\gls{cc}, \gls{ue}-\gls{cc}, and \gls{ue}-\gls{dc} are represented by solid \textcolor{red}{red}, solid \textcolor{blue}{blue} and solid black lines, respectively. \gls{risc} to \gls{ris} commands are indicated with dashed black lines. \gls{bs} operations are in \texttt{monospaced font}.}
    \label{fig:RIS-frames}
\end{figure*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\Glsfirst{oce}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:communication-paradigms:oce}
For this communication paradigm, the \gls{bs} needs to obtain the \gls{csi} for the \gls{ue} in order to optimize the \gls{ris} configuration. The necessary measurements can be collected through the transmission of pilot sequences from the \gls{ue}. During the Setup phase, the \gls{bs} informs the other entities that the procedure is starting: the \gls{ue} is informed through the \gls{ue}-\gls{cc} to prepare to send pilots. To solve the indeterminacy of the $N$ path \gls{ce} problem because of the presence of the \gls{ris}~\cite{Wang2020}, the \gls{ris} is instructed to sweep through a common codebook of configurations during the Algorithmic phase called \emph{channel estimation codebook} and denoted as $\mc{C}\oce \subseteq \mc{C}$. To change between the configurations in the channel estimation codebook, the \gls{bs} needs to send only a single control message to the \gls{risc} since the \gls{ris} sweeps following the order stipulated by the codebook.
During the Algorithmic phase, the \gls{ue} sends replicas of its pilot sequence subject to different RIS configurations to let each of them experience a different propagation environment. After a sufficient number of samples is received, the \gls{bs} can estimate the \gls{csi} and {compute the optimal \gls{ris}'s configuration}. Then, the Acknowledgement phase starts, in which the \gls{bs} informs the \gls{ue} over the \gls{ue}-\gls{cc} to start sending data by using the ctrl configuration\footnote{We remark that the ctrl configuration is automatically loaded after the Algorithmic phase ends, due to the idle state of the \gls{ris}. Another approach is loading the optimal configuration evaluated in the Algorithmic phase also to send the control information toward the \gls{ue}; nevertheless, the \gls{risc} needs to be informed previously by a specific control message by the \gls{bs}. We do not consider this approach to keep the frame structure of the two paradigms similar and the analysis complexity at the minimum, simplifying the presentation of Sect.~\ref{sec:ris-control}.} and, subsequently, the \gls{bs} informs the \gls{risc} over the \gls{ris}-\gls{cc} to load the optimal configuration. Finally, the Payload phase takes place.

%
%\RK{We need to clarify this part. A minor inconsistency is that since you just determined the optimal configuration for the \gls{ue}, why would you use the "control configuration". But I think maybe we can streamline the idea in general. If the protocol has a well-defined structure (i.e. it is clear when \gls{ue}-\gls{bs} and \gls{bs}-RIS communication occurs), then RIS automatically loads the control configuration for those timeslots.}

%As we are striving for a general \gls{ce} framework, we consider the strategy proposed by~\cite{Wang2020}, which is simple enough to yield an analytical formulation of the estimation error. The procedure occurs as follows: First, the \gls{ris} elements are turned off, so that the \gls{bs} can get an estimate of the direct channel; second, the \gls{bs} carries out the \gls{ce} for a single, typical \gls{ue}; finally, the other \glspl{ue} transmit pilots and the \gls{bs} estimates their channels by exploiting the fact that they are scaled versions of the typical \gls{ue}'s channel. Due to the aim of the paper, the scenario at hand, and the channel model, we focus only on the second phase, where the \gls{bs} estimates the channel coefficients of a single \gls{ue}. \RK{I think this paragraph can be removed completely. We are introducing something just to say we won't be doing it anyway. If the analytical method for estimating error based on~\cite{Wang2020} is used, we can just reference the paper later}%More specifically, the \gls{bs} aims to estimate $N$ channel coefficients associated with the equivalent channel observed at the \gls{bs} after reflection.
%The replicas of the \gls{ue} pilot sequences are designed to be proportional to the number of \gls{ris} elements $N$ for an accurate \gls{ce}. Also,
%\vc{To the \gls{ce} be able to capture the additional spatial dimension from the \gls{ris}, a}
%Accordingly, the 
%set of configurations $\mc{C}\oce$, also named as \emph{codebook}, must be designed, where %to let this estimation be successful~\cite{He2020}. Note that 
%the knowledge of such a codebook is shared by \gls{risc} and the \gls{bs}, assuming that a setup phase has taken place to deploy the \gls{ris} in the network.

% \vc{I think the first and second paragraphs could be better mixed. I commented on some stuff on the code that I think was repeated.}

\subsubsection*{Performance Analysis}
We now present the \gls{ce} procedure and analyze its performance in connection to the cardinality of the employed codebook $C\oce = |\mc{C}\oce|$. The method employed can be seen as a simplification of the method proposed in~\cite{Wang2020}. Let us start with the pilot sequence transmission and processing. %Every pilot sequence is made up of $p$ complex symbols. Hence, 
We denote a single pilot sequence as $\bm{\psi} \in \mathbb{C}^{p}$, spanning $p$ symbols and having $\lVert \bm{\psi} \rVert^2 = p$. Every time a configuration from the codebook is loaded at the \gls{ris}, the \gls{ue} sends a replica of the sequence $\bm{\psi}$ towards the \gls{bs}. When configuration $c\in\mc{C}\oce $ is loaded, the following signal is received at the \gls{bs}:
\begin{equation} \label{eq:oce:replica}
    \mb{y}_c\T  = \sqrt{\rho_u} \bm{\phi}_c\T \mb{z}_d  \, \bm{\psi}\T + \tilde{\mb{w}}_c\T \in\mathbb{C}^{1 \times p},
\end{equation}
where $\bm{\phi}_c$ denotes the phase-shift profile vector of the configuration $c\in\mc{C}\oce$, $\rho_u$ is the transmit power, and $\tilde{\mb{w}}_c\sim \mc{CN}(0, \sigma_b^2 \mb{I}_p)$ is the \gls{awgn}. The received symbol is then correlated with the pilot sequence and normalized by $\sqrt{\rho_u} p$, obtaining
\begin{equation} \label{eq:oce:pilotprocess}
    y_c  = \frac{1}{\sqrt{\rho_u} p}\mb{y}_c\T \bm{\psi}^* = \bm{\phi}_c\T \, \mb{z}_d + w_c \in\mathbb{C},
\end{equation}
where $w_c\sim\mc{CN}(0, \frac{\sigma_b^2}{p \rho_u})$ is the resulting \gls{awgn}\footnote{The consideration of dividing the pilot transmission over configurations over small blocks of $p$ symbols basically serves three purposes: $i$) from the hardware point of view, it might be difficult to change the phase-shift profile of a \gls{ris} within the symbol time, $ii$) to reduce the impact of the noise, and $iii$) to have the possibility of separating up to $p$ \gls{ue}'s data streams, if the pilots are designed to be orthogonal to each other~\cite{massivemimobook}.}. 
% \fs{The noise is reduced with this assumption
% \begin{equation}
% \begin{aligned}
%     \E{w} &= \frac{1}{\sqrt{\rho_u} p} \sum_{i=1}^p \psi_c^* \E{w_c} = 0 \\
%     \E{|w|^2} &= \frac{1}{\rho_u p^2} \E{\sum_{i=1}^p \psi_c^* w_c w_c^* \psi_c} + \frac{1}{\rho_u p} \E{\sum_{i=1}^p \sum_{j \neq i}^p \psi_c^* w_c w_j^* \psi_j} \\
%     & =  \frac{1}{\rho_u p^2} \sum_{i=1}^p \psi_c^* \E{w_c w_c^*} \psi_c + \frac{1}{\rho_u p^2} \sum_{i=1}^p \sum_{j \neq i}^p \psi_c^* \underbrace{\E{w_c w_j^*}}_{\E{w_c}\E{w_j^*} = 0} \psi_j \\
%     &= \frac{\sigma_b^2}{\rho_u p^2} \sum_{i=1}^p \psi_c^* \psi_c =  \frac{\sigma_b^2}{\rho_u p^2} \underbrace{\bm{\psi}\H \bm{\psi}}_{\lVert\bm{\psi}\rVert^2 = p} = \frac{\sigma_b^2}{\rho_u p}.
% \end{aligned}
% \end{equation}
% }
The pilot transmissions and the processing in eq.~\eqref{eq:oce:pilotprocess} are repeated for all configurations, $\forall c\in\mc{C}\oce$. The resulting signal $\mb{y}\in\mathbb{C}^{C\oce} = [y_1, y_2, \dots, y_{C\oce}]\T$ can be written in the following form:
\begin{equation} \label{eq:oce:signal}
    \mb{y}= \mb{\Theta}\T \mb{z}_d + \mb{w},
\end{equation}
where $\bm{\Theta} = [\bm{\phi}_1, \bm{\phi}_2, \dots, \bm{\phi}_{C\oce}]\in\mathbb{C}^{N\times C\oce }$ is the matrix containing all the configurations employed and $\mb{w} = [w_1, \dots, w_{C\oce}]\T \in\mathbb{C}^{C\oce \times 1}$ is the noise term. For the sake of generality, we will assume that there is no prior information about the channel distribution at the \gls{bs}. Therefore, we cannot estimate separately $\mb{h}_d$ and $\mb{g}_d$, but only the equivalent channel $\mb{z}_d$. 
%Indeed, we can rewrite the eq.~\eqref{eq:oce:signal} as
%each component of~\eqref{eq:oce:signal} as
% \begin{equation}
%     y_c = \sum_{n=1}^{N} \phi_{n,c} \underbrace{h^{*}_{n} g_{n}}_{z_{n}} + w = \sum_{n=1}^{N} \phi_{n,c} {z_{n}} + w
% \end{equation}
% and the overall signal is
% \begin{equation} \label{eq:oce:signal2}
    % \mb{y} = \bm{\Theta}\T \mb{z} + \mb{w}
% \end{equation}
% where $\mb{z}=[z_{1},z_{2},\dots,z_{N}]\T = \mb{h} \odot \mb{g}\in\mathbb{C}^{N \times{1}}$ is the equivalent channel. 
It is possible to show that a necessary (but not sufficient) condition to perfectly estimate the channel coefficients is that $C\oce\geq{N}$~\cite{Wang2020}. Indeed, we want to have a linearly independent set of equations, which can be obtained by constructing the configuration codebook for \gls{ce} to be at least rank $N$. As an example, we can use the \gls{dft} matrix, \emph{i.e.}, $[\bm{\Theta}]_{n,i} = e^{-j2\pi \frac{(n-1) (c-1)}{C\oce}}$, $n=\{1, \dots, N\}$, $c\in\mc{C}\oce$,
% \begin{equation}
%     \bm{\Theta} =
%     \begin{bmatrix}
%         1 & 1 & 1 & \cdots & 1 \\
%         1 & \omega & \omega^2 & \cdots & \omega^{(C_{\mathrm{OCE}}-1)} \\
%         1 & \omega^2 & \omega^2 & \cdots & \omega^{2(C_{\mathrm{OCE}}-1)} \\
%         \vdots & \vdots & \vdots & \ddots & \vdots \\
%         1 & \omega^{N-1} & \omega^{2(N-1)} & \cdots &\omega^{(N-1)(C_{\mathrm{OCE}}-1)},
%     \end{bmatrix}
% \end{equation}
% where $\omega=e^{-j 2\pi / C_{\mathrm{OCE}}}$ 
with $\bm{\Theta}^* \bm{\Theta}\T = C\oce \mb{I}_{N}$. Considering that the parameter vector of interest is deterministic, the least-squares estimate~\cite{Kay1997} yields
\begin{equation}
    \hat{\mb{z}}_d=\dfrac{1}{C\oce} \bm{\Theta}^* \mb{y} = \mb{z}_d + \mb{n},
\end{equation}
where $\mb{n}\sim\mc{CN}(0, \frac{\sigma_b^2}{p \rho_u C\oce } \mb{I}_N)$ and whose performance is proportional to $1/C\oce$.
%$ Remark: the higher the cardinality of the codebook, the better the \gls{ce} performance.
% \fs{In fact:
% \begin{equation}
%     \begin{aligned}
%     \E{\frac{1}{C\oce} \bm{\Theta}^* \mb{w}} &= 0 \\
%     \E{(\frac{1}{C\oce} \bm{\Theta}^* \mb{w})( \frac{1}{C\oce} \bm{\Theta}^* \mb{w})\H} &= \frac{1}{C\oce^2} \bm{\Theta}^* \E{\mb{w} \mb{w}\H} \bm{\Theta}\T  = \frac{\sigma_b^2}{\rho_u p C\oce} \mb{I}_N
%     \end{aligned}
% \end{equation}}
%
Based on the estimated equivalent channel, the \gls{bs} can obtain the configuration $\bm{\phi}_\star$ that maximizes the instantaneous \gls{snr} of the typical \gls{ue} as follows 
\begin{equation}
    \begin{aligned}
        \bm{\phi}_\star &= \max_{\phi}\left \{ \lvert \bm{\phi}\T \hat{\mb{z}}_d \rvert^2 \, \big| \, \lVert\bm{\phi}\rVert^2 = N \right\},
    \end{aligned}
\end{equation}
which turns out to provide the intuitive solution of setting $(\bm{\phi}_\star)_n=e^{-j\angle{(\hat{\mb{z}}_d)_n}}$, $\forall n = \{1, \dots, N\}$. Finally, the \gls{ul} estimated \gls{snr} at the \gls{bs} results
\begin{equation}
    \hat{\gamma}\oce = \frac{\rho_u}{\sigma_b^2} |\bm{\phi}_\star\T \hat{\mb{z}}_d|^2.
\end{equation}
Based on the estimated \gls{snr}, the \gls{se} of the data communication can be adapted to be the maximum achievable, \emph{i.e.},
\begin{equation} \label{eq:oce:se}
    \eta\oce = \log_2(1 + \hat{\gamma}\oce).
\end{equation}

\subsubsection*{Algorithmic errors}
For the \gls{oce} paradigm, a communication outage occurs in the case of an \emph{overestimation error}, \emph{i.e.}, if the selected \gls{se} $\eta\oce$ is higher than the actual channel capacity leading to an unachievable communication rate~\cite{Shannon1949}. The probability of this event is
\begin{equation} \label{eq:oce:ae1}
    p_\mathrm{ae} = \mc{P} \left[\eta\oce = \log(1 + \hat{\gamma}\oce) \ge \log_2\left(1+ \gamma\oce \right) \right],
\end{equation}
where $\gamma\oce = \frac{\rho_u}{\sigma_b^2} |\bm{\phi}_\star\T \mb{z}_d|^2$ is the actual \gls{snr} at the \gls{bs}. Eq.~\eqref{eq:oce:ae1} translates to the condition
\begin{equation} \label{eq:oce:ae2}
    p_\mathrm{ae} = \mc{P}\left[\hat{\gamma}\oce \ge \gamma\oce\right] = \mc{P}\left[ |\bm{\phi}_\star\T \mb{z}_d + \bm{\phi}_\star\T \mb{n}|^2 \ge  |\bm{\phi}_\star\T \mb{z}_d|^2 \right].
\end{equation}
A formal analysis of eq.~\eqref{eq:oce:ae2} depends on the channel model of $\mb{z}_d$, and, hence, on making a prior assumption on the scenario at hand. To keep the analysis general, we resort to numerical methods to evaluate the impact of the \gls{oce} algorithmic error.
%Nevertheless, we found experimentally that the impact of the noise on the \gls{snr} estimation is generally negligible for this paradigm, as shown in Fig.~\ref{fig:snrcdf} where the \gls{cdf} of the estimated $\hat{\gamma}\oce$ and actual \gls{snr} ${\gamma}\oce$ are presented.  This finding is justified by the fact that the noise power is proportional to $1/C\oce$ where $C\oce \ge N$ as described in Section~\ref{sec:communication-paradigms:oce}. %Therefore, considering the generally high number of \gls{ris} elements deployed, the impact of the noise results is negligible. Because of that, we assume that the algorithmic error for the \gls{oce} paradigm is $p_\mathrm{ae} \approx 0$ in the remainder of the paper.

\subsection{\Glsfirst{bsw}}\label{sec:communication-paradigms:bsw}
In the Setup phase, the \gls{bs} commands the start of a new frame by signaling to the \gls{ris} and the \gls{ue}. During the Algorithmic phase, a \emph{beam sweeping process} and the configuration selection are performed. The beam-sweeping process comprises the \gls{ue} sending reference signals, while the \gls{bs} commands the \gls{ris} to change its configuration at regular time periods accordingly to a set of common configurations, labeled as the \emph{beam-sweeping codebook} and denoted by the symbol $\mc{C}\bsw \subseteq \mc{C}$. The \gls{bs} receives the reference signals that are used to measure the \gls{ue}'s \gls{kpi}. Again, a single \gls{bs} control message received by the \gls{risc} is enough to trigger the whole sweeping process. At the end of the beam-sweeping process, the \gls{bs} selects a configuration satisfying the target \gls{kpi}. During the Acknowledgment phase, the \gls{bs} informs the \gls{ue} over the \gls{ue}-\gls{cc} to prepare to send data by using the ctrl configuration and informs the \gls{risc} through the \gls{ris}-\gls{cc} to load the selected configuration. Finally, the Payload phase takes place. % \RK{Maybe it would be good to provide some intuition behind different codebooks for beam-sweeping and \gls{ce} optimization.}

We consider that the beam-sweeping process occurring in the Algorithmic phase may make use of i) a \emph{fixed} or ii) a \emph{flexible} frame structure. The former is based on a fixed number of configurations in the beam-sweeping codebook: the beam-sweeping process ends after the last configuration in the codebook is loaded. The latter allows stopping the beam-sweeping earlier, as soon as a \gls{kpi} value measured is above the target one. Enabling the flexible structure method requires that the \gls{bs} makes the \gls{kpi} measurements on-the-fly; moreover, resources on the \gls{ue}-\gls{cc} need to be reserved to promptly communicate to the \gls{ue} to stop sending pilot sequences when the target \gls{kpi} is met, modifying the organization of the overall frame. A detailed description of these differences and the impact on the \glspl{cc} design are given in Sect.~\ref{sec:ris-control}.

\subsubsection*{Performance analysis}
In order to study the beam sweeping performance, let us assume that the target \gls{kpi} is a target \gls{snr} $\gamma_0$ measured at the \gls{bs} from the average \gls{rss}. Therefore, in this case we have a fixed \gls{se} defined \emph{a priori} given by
\begin{equation} \label{eq:bsw:se}
    \eta\bsw = \log_2(1 + \gamma_0),
\end{equation}
and we aim to find a configuration from the codebook that supports such \gls{se}. Let us then analyze the system by starting from the pilot sequence transmission and processing. As before, every pilot sequence consists of $p$ symbols\footnote{The pilot sequences for \gls{oce} and \gls{bsw} can be different and have different lengths. In practice, they should be designed and optimized for each of those approaches, which is beyond the scope of this paper. The same notation to denote the length of the pilot sequence in both paradigms is used for simplicity.}. Once again, we denote a single sequence as $\bm{\psi} \in \mathbb{C}^{p}$ having $\lVert\bm{\psi} \rVert^2 = p$. After the \gls{ris} has configuration $c\in\mc{C}\bsw $ loaded, the \gls{ue} sends a replica of the sequence $\bm{\psi}$; the following signal is obtained at the \gls{bs}:
\begin{equation} \label{eq:bsw:replica}
    \mb{y}_c\T  = \sqrt{\rho_u} \bm{\phi}_c\T \mb{z}_d \bm{\psi}\T + \tilde{\mb{w}}_c\T \in\mathbb{C}^{1 \times p},
\end{equation}
which has the same formulation of eq.~\eqref{eq:oce:replica}, where $\bm{\phi}_c$ now denotes the configuration $c \in \mc{C}\bsw$. The received signal is then correlated with the pilot symbol and normalized by $p$, obtaining
\begin{equation} \label{eq:bsw:pilotprocess}
    y_c  = \frac{1}{p}\mb{y}_c\T \bm{\psi}^* = \sqrt{\rho_u} \bm{\phi}_c\T \mb{z}_d + w_c \in\mathbb{C},
\end{equation}
where $w_c\sim\mc{CN}(0, \frac{\sigma_b^2}{p})$ is the resulted \gls{awgn}.
The \gls{snr} provided by the configuration can be estimated by taking the absolute square of the sample and dividing it by the (known) noise variance as
\begin{equation} \label{eq:bsw:gammahat}
    \hat{\gamma}_c = \frac{|y_c|^2}{\sigma_b^2} = \underbrace{\frac{\rho_u}{\sigma_b^2} |\bm{\phi}_c\T \mb{z}_d|^2 }_{\gamma_c} + 2 \Re\left\{ \frac{\sqrt{\rho_u}}{\sigma_b^2} \bm{\phi}_c\T \mb{z}_d\, w_c\right\} + \frac{|w_c|^2}{\sigma_b^2},
\end{equation}
where $|w_c|^2 / \sigma_b^2 \sim \mathrm{Exp}(p)$.
It is worth noting that the estimated \gls{snr} is affected by the exponential error generated by the noise, but also by the error of the mixed product between the signal and the noise, whose \gls{pdf} depends on the \gls{pdf} of $\mb{z}_d$. Based on eq.~\eqref{eq:bsw:gammahat}, we can select the best configuration $c^\star\in\mc{C\bsw}$ providing the target \gls{kpi}. In the following, we discuss the selection of the configuration for the two different frame structures.

\paragraph{Fixed frame} When the frame has a fixed structure, the sweeping procedure ends after the \gls{ris} sweeps through the whole codebook. In this case, we can measure the \glspl{kpi} for all the configurations in the codebook. Then, the configuration selected for the payload phase is set to be the one achieving the highest estimated \gls{snr} among the ones satisfying the target \gls{kpi} $\gamma_0$, that is,
\begin{equation} \label{eq:bsw:cstar:fixed}
    c^\star = \argmax_{c\in\mc{C}\bsw} \{\hat{\gamma}_c \,|\, \hat{\gamma}_c \ge \gamma_0\}.
\end{equation}
As before, if no configuration achieves the target \gls{kpi}, the communication is not feasible and we run into an outage event.

\paragraph{Flexible frame} When the frame has a flexible structure, the end of the sweeping process is triggered by the \gls{bs} when the measured \gls{kpi} reaches the target value.
A simple on-the-fly selection method involves testing if the estimated \gls{snr} is greater than the target $\gamma_0$; \emph{i.e.}, after eq.~\eqref{eq:bsw:gammahat} is obtained for configuration $c\in\mc{C}\bsw$, we set
\begin{equation} \label{eq:bsw:cstar:flexible}
    c^\star = c \iff \hat{\gamma}_c \ge \gamma_0.
\end{equation}
As soon as $c^\star$ is found, the \gls{bs} communicates to both \gls{ris} and \gls{ue} that the Payload phase can start, otherwise, the sweeping process continues until a configuration is selected. In case the whole codebook $C\bsw$ is tested and no configuration satisfies condition~\eqref{eq:bsw:cstar:flexible}, the communication is not feasible and we run into an outage event.

\subsubsection*{Algorithmic errors}
For the \gls{bsw} paradigm, a communication outage occurs when no configuration in the beam sweeping codebook satisfies the target \gls{kpi}, and in the case of overestimation error, which now occurs if the selected configuration provides an actual \gls{snr} lower than the target one, knowing that the estimated \gls{snr} was higher. 
These events are mutually exclusive, and hence their probability results in
\begin{equation} \label{eq:bsw:ae}
\begin{aligned}
    p_\mathrm{ae} &= \mc{P} \left[ \gamma_{c^\star} \le \gamma_0 | \hat{\gamma}_{c^\star} > \gamma_0 \right] + \mc{P}\left[ \hat{\gamma}_{c} \le \gamma_0, \, \forall c\in\mc{C}\bsw \right]  \\
    &= \mc{P} \left[ \hat{\gamma}_{c^\star} - \gamma_0 \le  \frac{|w_{c^\star}|^2}{\sigma_b^2} + 2 \Re\left\{ \frac{\sqrt{\rho_u}}{\sigma_b^2} \bm{\phi}_{c^\star}\T \mb{z}_d\, w_c\right\} \right] + \mc{P}\left[ \hat{\gamma}_{1} \le \gamma_0, \dots, \hat{\gamma}_{C\bsw} \le \gamma_0  \right],
\end{aligned}    
\end{equation}
where $\gamma_{c^\star} = \frac{\rho_u}{\sigma_b^2} | \bm{\phi}_{c^\star}\T \mb{z}_d|^2$ is the actual \gls{snr}, and $\hat{\gamma}_{c^\star} - \gamma_0  > 0$.
By applying Chebychev inequality, the overestimation probability term in~\eqref{eq:bsw:ae} can be upper bounded by
\begin{equation} \label{eq:bsw:oebound}
     \mc{P} \left[ \hat{\gamma}_{c^\star} - \gamma_0 \le  \frac{|w_{c^\star}|^2}{\sigma_b^2} + 2 \Re\left\{ \frac{\sqrt{\rho_u}}{\sigma_b^2} \bm{\phi}_{c^\star}\T \mb{z}_d\, w_c\right\} \right] \le \frac{\E{\frac{|w_{c^\star}|^2}{\sigma_b^2} + 2 \Re\left\{ \frac{\sqrt{\rho_u}}{\sigma_b^2} \bm{\phi}_{c^\star}\T \mb{z}_d\, w_c\right\}}}{\hat{\gamma}_{c^\star} - \gamma_0} = \frac{p^{-1}}{\hat{\gamma}_{c^\star} - \gamma_0}.
\end{equation}
From eq.~\eqref{eq:bsw:oebound}, we infer that the higher the gap between $\hat{\gamma}_{c^\star}$ and $\gamma_0$, the lower the probability of error.
The \gls{bsw} employing the fixed structure generally has a higher value of ${\hat{\gamma}_{c^\star} - \gamma_0}$ than the one with the flexible structure due to the use of the $\argmax$ operator to select the configuration $c^\star$. Therefore, the fixed structure is generally more robust to overestimation errors. 
%From eqs.~\eqref{eq:bsw:ae} and~\eqref{eq:bsw:oebound}, we note that the fixed structure is more robust to overestimation errors. Indeed, the higher the gap between $\hat{\gamma}_{c^\star}$ and $\gamma_0$, the lower the probability of error. 
On the other hand, the evaluation of the probability that no configuration in the beam sweeping codebook satisfies the target \gls{kpi} requires the knowledge of the \gls{cdf} of the estimated \gls{snr}, whose analytical expression is channel model dependent and generally hard to obtain.
\begin{comment}
By assuming \gls{iid} measures of the \gls{snr} values, the probability that no configuration in the beam sweeping codebook satisfies the target \gls{kpi} is
\begin{equation} \label{eq:bsw:outageiid}
     \mc{P}\left[ \hat{\gamma}_{1} \le \gamma_0, \dots, \hat{\gamma}_{C\bsw} \le \gamma_0  \right] = \prod_{c\in\mc{C}\bsw} \mc{P}\left[ \hat{\gamma}_{c} \le \gamma_0\right] = \left[F_{\hat{\gamma}_1}(\gamma_0)\right]^{C\bsw},
\end{equation}
where $F_{\hat{\gamma}_c}(\gamma_0)$ is the \gls{cdf} of $\hat{\gamma}_c$.
Remark that the assumption of \gls{iid} $\hat{\gamma}_c$ measurements is an oversimplification, considering that the propagation environment is in general spatially correlated. %Hence, the configuration codebook should be specifically designed to have \gls{iid} $\hat{\gamma}_c$ measurements, which, in turn, depends on the channel model of $\mb{z}_d$. On the other hand, 
On the other hand, when considering completely correlated measurements, we obtain
\begin{equation} \label{eq:bsw:outagecorr}
     \mc{P}\left[ \hat{\gamma}_{1} \le \gamma_0, \dots, \hat{\gamma}_{C\bsw} \le \gamma_0  \right] = \mc{P}\left[ \hat{\gamma}_{1} \le \gamma_0 \right] = F_{\hat{\gamma}_1}(\gamma_0).
\end{equation}
In a real environment, the actual outage probability will be in the range given by eqs.~\eqref{eq:bsw:outageiid} and~\eqref{eq:bsw:outagecorr}. In any case, both eqs.~\eqref{eq:bsw:outageiid} and~\eqref{eq:bsw:outagecorr} depend on the \gls{cdf} of the estimated \gls{snr}, whose analytical expression is channel model dependent and generally hard to obtain. From the equations, we can infer that the more spatially correlated is the channel in the environment, the lower the outage probability. \fs{To say more than this is complicated.}
\end{comment}
Also in this case, we resort to numerical simulations to evaluate the impact of the \gls{bsw} algorithmic errors.

\subsection{Trade-offs in different paradigms} % and algorithmic errors}
\label{sec:paradigms:comment}

The two \gls{ris}-aided communication paradigms can be seen as a generalization of the \emph{fixed rate} and \emph{adaptive rate} transmission approaches. Essentially, the \gls{se} of the \gls{oce} is adapted to the achievable rate under the optimal configuration (see eq.~\eqref{eq:oce:se}) obtaining the so-called multiplexing transmission, while the \gls{se} of the \gls{bsw} is set \emph{a priori} according to the target \gls{kpi} (see eq.~\eqref{eq:bsw:se}) obtaining a diversity transmission. Comparing eqs.~\eqref{eq:oce:se} and~\eqref{eq:bsw:se} under the same environmental conditions, we have that 
\begin{equation}
    \eta\bsw \le \eta\oce,
\end{equation}
where the price to pay for the higher \gls{se} of the \gls{oce} paradigm is the increased overhead. Indeed, for the \gls{oce}, an accurate \gls{csi} is needed for a reliable rate adaptation, which generally translates into a higher number of sequences to be transmitted by the \gls{ue} compared to \gls{bsw}. Furthermore, after the pilot transmission, additional time and processing are required to determine the optimal configuration of the \gls{ris}. As a consequence, the \gls{se} of data transmission alone cannot be considered a fair metric of comparison, as it does not take into account the overheads generated by the communication paradigms. In the next section, we will introduce the impact of the control channel and give the main metric of the comparison.

\begin{comment}
Before analyzing the overall performance, we briefly investigate the \emph{algorithmic errors}, \emph{i.e.}, the errors that can happen during the Algorithmic phase of the paradigms. For both paradigms, an \emph{overestimation event} occurs if there is an error in the estimation of the communication \gls{snr} that leads to transmit employing an unachievable \gls{se}, \emph{i.e.}, an \gls{se} higher than the channel capacity~\cite{Shannon1949}. When considering the \gls{bsw} paradigm, a further outage event occurs if no configuration in the beam sweeping codebook provides the target \gls{kpi}, which depends on the codebook design and environmental conditions. In the following, we formally define the algorithmic error for the two communication paradigms.


\paragraph{\gls{oce} algorithmic error}
The probability %A communication outage occurs in the case 
of an overestimation error %, if the selected \gls{se} is higher than the actual channel capacity, 
%with probability
is
\begin{equation} \label{eq:oce:ae1}
    p_\mathrm{ae} = \mc{P} \left[\eta\oce = \log(1 + \hat{\gamma}\oce) \ge \log_2\left(1+ \gamma\oce \right) \right],
\end{equation}
where $\gamma\oce = \frac{\rho_u}{\sigma_b^2} |\bm{\phi}_\star\T \mb{z}_d|^2$ is the actual \gls{snr} at the \gls{bs}. Eq.~\eqref{eq:oce:ae1} translates to the condition
\begin{equation} \label{eq:oce:ae2}
    p_\mathrm{ae} = \mc{P}\left[\hat{\gamma}\oce \ge \gamma\oce\right] = \mc{P}\left[ |\bm{\phi}_\star\T \mb{z}_d + \bm{\phi}_\star\T \mb{n}|^2 \ge  |\bm{\phi}_\star\T \mb{z}_d|^2 \right].
\end{equation}
The analysis of eq.~\eqref{eq:oce:ae2} depends on the channel model of $\mb{z}_d$, and hence on making a prior assumption on the scenario at hand. Nevertheless, we found experimentally that the impact of the noise on the \gls{snr} estimation is generally negligible for this paradigm, as shown in Fig.~\ref{fig:snrcdf} where the \gls{cdf} of the estimated $\hat{\gamma}\oce$ and actual \gls{snr} ${\gamma}\oce$ are presented. 
This finding is justified by the fact that the noise power is proportional to $1/C\oce$ where $C\oce \ge N$ as described in Section~\ref{sec:communication-paradigms:oce}. %Therefore, considering the generally high number of \gls{ris} elements deployed, the impact of the noise results is negligible.
Because of that, we assume that the algorithmic error for the \gls{oce} paradigm is $p_\mathrm{ae} \approx 0$ in the remainder of the paper.


\fs{After a few manipulations, we can write
\begin{equation}
\begin{aligned}
    &|\bm{\phi}_\star\T \mb{n}|^2 + 2  \Re\{\bm{\phi}_\star\T \mb{z} \, \bm{\phi}_\star\T \mb{n}\} = |\tilde{n}|^2 + \underbrace{\Re\{\tilde{n}\}}_x \underbrace{2 \sum_{n=1}^N \Re\{\phi_n z_n\}}_{a} - \underbrace{\Im\{\tilde{n}\}}_y \underbrace{2 \sum_{n=1}^N \Im\{\phi_n z_n\}}_{b} = \\
    &=  x^2 + y^2 + x a - y b \ge 0,
\end{aligned}
\end{equation} 
where $\tilde{n} \sim \mc{CN}(0, \sigma_n^2)$ with $\sigma_n^2 = \frac{\sigma_b^2 N}{p \rho_u C\oce}$ and $x,y \sim \mc{N}(0, \sigma_n^2 / 2)$. The above is the equation of an ellipse in $\mathbb{R}^2$, whose canonical form can be written as
\begin{equation}
    \left(x + \frac{a}{2}\right)^2 + \left(y - \frac{y}{2}\right)^2 \ge \frac{a^2 + b^2}{4}.
\end{equation}
The probability of this event can be rewritten as
\begin{equation}
\begin{aligned}
    &\mc{P}\left[\left(x + \frac{a}{2}\right)^2 + \left(y - \frac{b}{2}\right)^2 \ge \frac{a^2 + b^2}{4} \right] = 1 - \mc{P}\left[\left(x + \frac{a}{2}\right)^2 + \left(y - \frac{y}{2}\right)^2 \le \frac{a^2 + b^2}{4} \right] \\
    & = 1 - \mc{P}\left[\tilde{x}^2 + \tilde{y}^2 \le \frac{a^2 + b^2}{2 \sigma_n^2}\right],
\end{aligned}
\end{equation}
where $\tilde{x} \sim \mc{N}(\frac{a}{2}, 1)$, $\tilde{y}\sim \mc{N}(-\frac{b}{2}, 1)$ and $\tilde{x}^2 + \tilde{y}^2 = \xi \sim \chi_2^2\left(\frac{a^2 + b^2}{4}\right)$, \emph{i.e.}, noncentral chi-squared distributed with two degrees of freedom.
Therefore, the following probability is
\begin{equation}
    \mc{P}\left[\hat{\gamma}\oce \ge \gamma\oce | \mb{z} \right] = Q_1\left(\frac{\sqrt{a^2 + b^2}}{2}, \sqrt{\frac{a^2 + b^2}{2 \sigma_n^2}} \right),
\end{equation}
where $Q_1(\cdot, \cdot)$ is the Marcum Q-function of order 1. In theory, we could also obtain the overall probability through the law of total probability, \emph{i.e.},
\begin{equation}
    \mc{P}\left[\hat{\gamma}\oce \ge \gamma\oce \right] = \int_{-\infty}^{\infty} \cdots \int_{-\infty}^{\infty} Q_1\left(\frac{\sqrt{a^2 + b^2}}{2}, \sqrt{\frac{a^2 + b^2}{2 \sigma_n^2}} \right) p_{\mb{Z}}(\mb{z}) \diff \mb{z},
\end{equation}
where $p_{\mb{Z}}(\mb{z})$ is the \gls{pdf} of $\mb{z}$. On the other hand, we can evaluate the \gls{pdf} of $a$ and $b$ based on some assumption of $\mb{z}$ to simplify a bit the evaluation.}


\paragraph{\gls{bsw} algorithmic error}
For this case, an outage occurs when no configuration in the beam sweeping codebook satisfies the target \gls{kpi} or in the case of overestimation error. %, \emph{i.e.}, if the selected configuration provided an actual \gls{snr} lower than the target one, even if the estimated \gls{snr} was higher. 
These events are mutually exclusive, and hence their probability results in
\begin{equation} \label{eq:bsw:ae}
\begin{aligned}
    p_\mathrm{ae} &= \mc{P} \left[ \gamma_{c^\star} \le \gamma_0 | \hat{\gamma}_{c^\star} > \gamma_0 \right] + \mc{P}\left[ \hat{\gamma}_{c} \le \gamma_0, \, \forall c\in\mc{C}\bsw \right]  \\
    &= \mc{P} \left[ \hat{\gamma}_{c^\star} - \gamma_0 \le  \frac{|w_{c^\star}|^2}{\sigma_b^2} + 2 \Re\left\{ \frac{\sqrt{\rho_u}}{\sigma_b^2} \bm{\phi}_{c^\star}\T \mb{z}_d\, w_c\right\} \right] + \mc{P}\left[ \hat{\gamma}_{1} \le \gamma_0, \dots, \hat{\gamma}_{C\bsw} \le \gamma_0  \right],
\end{aligned}    
\end{equation}
where $\gamma_{c^\star} = \frac{\rho_u}{\sigma_b^2} | \bm{\phi}_{c^\star}\T \mb{z}_d|^2$, and $\hat{\gamma}_{c^\star} - \gamma_0  > 0$. We now further analyze each term individually. By applying Chebychev inequality, the overestimation probability term in~\eqref{eq:bsw:ae} can be upper bounded by
\begin{equation} \label{eq:bsw:oebound}
     \mc{P} \left[ \hat{\gamma}_{c^\star} - \gamma_0 \le  \frac{|w_{c^\star}|^2}{\sigma_b^2} + 2 \Re\left\{ \frac{\sqrt{\rho_u}}{\sigma_b^2} \bm{\phi}_{c^\star}\T \mb{z}_d\, w_c\right\} \right] \le \frac{\E{\frac{|w_{c^\star}|^2}{\sigma_b^2} + 2 \Re\left\{ \frac{\sqrt{\rho_u}}{\sigma_b^2} \bm{\phi}_{c^\star}\T \mb{z}_d\, w_c\right\}}}{\hat{\gamma}_{c^\star} - \gamma_0} = \frac{p^{-1}}{\hat{\gamma}_{c^\star} - \gamma_0}.
\end{equation}
From eq~\ref{eq:bsw:oebound}, we infer that the higher the gap between $\hat{\gamma}_{c^\star}$ and $\gamma_0$, the lower the probability of error.
The \gls{bsw} employing the fixed structure generally has a higher value of ${\hat{\gamma}_{c^\star} - \gamma_0}$ than the one with the flexible structure due to the use of the $\argmax$ operator to select configuration $c^\star$. Therefore, the fixed structure is generally more robust to overestimation errors. 
%From eqs.~\eqref{eq:bsw:ae} and~\eqref{eq:bsw:oebound}, we note that the fixed structure is more robust to overestimation errors. Indeed, the higher the gap between $\hat{\gamma}_{c^\star}$ and $\gamma_0$, the lower the probability of error. 
By assuming \gls{iid} measures of the \gls{snr} values, the probability that no configuration in the beam sweeping codebook satisfies the target \gls{kpi} is
\begin{equation} \label{eq:bsw:outageiid}
     \mc{P}\left[ \hat{\gamma}_{1} \le \gamma_0, \dots, \hat{\gamma}_{C\bsw} \le \gamma_0  \right] = \prod_{c\in\mc{C}\bsw} \mc{P}\left[ \hat{\gamma}_{c} \le \gamma_0\right] = \left[F_{\hat{\gamma}_1}(\gamma_0)\right]^{C\bsw},
\end{equation}
where $F_{\hat{\gamma}_c}(\gamma_0)$ is the \gls{cdf} of $\hat{\gamma}_c$.
Remark that the assumption of \gls{iid} $\hat{\gamma}_c$ measurements is an oversimplification, considering that the propagation environment is in general spatially correlated. Hence, the configuration codebook should be specifically designed to have \gls{iid} $\hat{\gamma}_c$ measurements, which, in turn, depends on the channel model of $\mb{z}_d$. On the other hand, the other extreme case is considering completely correlated measurements, obtaining
\begin{equation} \label{eq:bsw:outagecorr}
     \mc{P}\left[ \hat{\gamma}_{1} \le \gamma_0, \dots, \hat{\gamma}_{C\bsw} \le \gamma_0  \right] = \mc{P}\left[ \hat{\gamma}_{1} \le \gamma_0 \right] = F_{\hat{\gamma}_1}(\gamma_0).
\end{equation}
In a real environment, the actual outage probability will be in the range given by eqs.~\eqref{eq:bsw:outageiid} and~\eqref{eq:bsw:outagecorr}. In any case, both eqs.~\eqref{eq:bsw:outageiid} and~\eqref{eq:bsw:outagecorr} depend on the \gls{cdf} of the estimated \gls{snr}, whose analytical expression is hard to obtain. Different from before, the noise has an impact on the estimation of the \gls{snr} as shown in Fig.~\ref{fig:snrcdf}, where the gap between the actual and the estimated \gls{snr} \glspl{cdf} is clearly visible. In the remainder of the paper, the probability of no configuration satisfying the target \gls{kpi} for the \gls{bsw} will be evaluated through numerical simulations.

% \begin{figure}
%     \centering
%     \input{tikz/cdf_snr}
%     \caption{\gls{cdf} of the actual and estimated \gls{snr} for the communication paradigms under study. The parameters set for this experiment are given in Sect.~\ref{sec:results}.}
%     \label{fig:snrcdf}
% \end{figure}

\end{comment}