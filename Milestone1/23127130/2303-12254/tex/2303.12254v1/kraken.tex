%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{}

%\documentclass[acmsmall]{acmart}\settopmatter{}
%\documentclass[acmsmall]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%\documentclass[acmsmall]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
\documentclass[nonacm=true,format=acmsmall]{acmart}\settopmatter{}
%\documentclass[dvipsnames,nonacm=true,format=sigconf,anonymous=false,review=false]


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{ICFP} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2023}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption

%% based on http://cgswords.github.io/latex-semantics/
%% Many thanks for the help typesetting!
%%\usepackage{amsmath, listings, bcprules, amsthm, amssymb, xspace, stmaryd}
\usepackage{amsmath, listings}
\usepackage{csvsimple}
\usepackage{xstring}
\usepackage{graphicx}
\graphicspath{ {./images/} }
\usepackage[ruled,vlined,linesnumbered,commentsnumbered]{algorithm2e}
\usepackage{xcolor}
\usepackage{float}
\usepackage{verbatim}
\usepackage{longtable}
\usepackage{multirow, multicol}
\usepackage{subfiles}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}


\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
\lstset{style=mystyle}

\newcommand{\alt}{~~|~~}
\newcommand{\comp}[1]{\llbracket #1 \rrbracket}
\newcommand{\inlineexp}[1]{
  {\footnotesize
  \[\begin{array}{l}
    #1
  \end{array}\]}}
\newcommand{\inlineexpa}[2]{
  {\footnotesize
  \[\begin{array}{#1}
    #2
  \end{array}\]}}

\newcommand{\krakenSpace} {\textit{Kraken} }
\newcommand{\kraken} {\textit{Kraken}}

\newcommand{\lamdefe} [2]     {\lambda #1.~#2}

\newcommand{\falsev}          {\mathsf{false}}
\newcommand{\truev}           {\mathsf{true}}

\newcommand{\Ctxt}            {\mathcal{E}}
\newcommand{\InCtxt}  [1]     {\Ctxt[#1]}


\newcommand{\ssosredex}       {\rightarrow}
\newcommand{\ctxtreduce}      {\mapsto}
\newcommand{\sstep}    [3] [] {#2 &\ssosredex&  #3 &\textsc{#1}}
\newcommand{\ctxtstep} [3] [] {#2 &\ctxtreduce& #3 &\textsc{#1}}

\newcommand{\subst}    [3] {#3 [#2 / #1]}

\newcommand{\kenv}     [3] {\langle \langle #1~|#2,~#3 \rangle \rangle}

\newcommand{\kprim}    [2] {\langle #1~\textbf{#2} \rangle}
%\newcommand{\kcomb}    [6] {\langle \textbf{comb} ~ #1 ~ #2 ~ #3 ~ #4 ~ #5 ~ #6\rangle}
\newcommand{\kcomb}    [5] {\langle \textbf{comb} ~ #1 ~ #2 ~ #3 ~ #4 ~ #5\rangle}
\newcommand{\keval}    [2] {[\text{eval} ~ #1 ~ #2]}
\newcommand{\kcombine} [3] {[\text{combine} ~ #1 ~ #2 ~ #3 ]}


\newcommand{\kmrk}        [5] {#1\{#2~#3~#4~#5\}}
\newcommand{\kmks}        [3] {\kmrk{#1}{#2}{#3}{\emptyset}{\emptyset}}
%\newcommand{\kmkd}        [1] {\kmrk{#1}{h}{PI}{\emptyset}{\emptyset}}
\newcommand{\kpeval}      [5] {[\text{peval} ~ #1 ~ #2 ~ #3 ~ #4 ~ #5]}
\newcommand{\kpevals}     [2] {\kpeval{#1}{#2}{ES}{f}{UHs}}
%\newcommand{\kunval}      [1] {[\text{uneval} ~ #1]}
\newcommand{\kpvthen}     [3] {[\text{vthen}~#1~#2~#3]}

\newcommand{\kpcombines}  [3] {[\text{pcombine}~{#1}~{#2}~{#3}~{ES}~{UHs}]}
\newcommand{\kpcombined}  [3] {[\text{pcombined}~{#1}~{#2}~{#3}~{ES}~{UHs}]}
\newcommand{\kpunders}    [4] {[\text{punder}~{#1}~{#2}~{#3}~{ES}~{UHs}~{#4}]}
\newcommand{\kpdropred}   [2] {\text{drop\_extra\_eval}(#1~#2~ES~UHs)}



\newcommand{\kmark}   [1] {\text{mark}(#1)}
\newcommand{\kmkd}    [2] {/#1/#2}
\newcommand{\kval}        {\mathsf{val}}
\newcommand{\kfresh}      {\mathsf{freshCall}}
\newcommand{\katt}    [2] {\mathsf{atmdCall}~#1~#2}
\newcommand{\kunval}  [1] {\text{unval}(#1)}
\newcommand{\kprog}   [1] {\text{neededIDs}(#1)}
\newcommand{\kuprog}  [1] {\text{upperIDs}(#1)}
\newcommand{\kiprog}  [1] {\text{resumeForms}(#1)}
%                                        T  E envSet currentlyExecuting
\newcommand{\kpval}     [4] {[\text{peval} ~ #1 ~ #2 ~ #3 ~ #4]}
\newcommand{\kpcombine} [5] {[\text{combine} ~ #1 ~ #2 ~ #3 ~ #4 ~ #5]}
\newcommand{\kunder}    [5] {[\text{under} ~ #1 ~ #2 ~ #3 ~ #4 ~ #5]}

\begin{document}
%% Title information
\title[Kraken]{Practical compilation of fexprs using partial evaluation}
                                        %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
\subtitle{Fexprs can performantly replace macros in purely-functional Lisp}
                                        %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{Nathan Braswell}
%\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\affiliation{
  \position{PhD Student}
  \department{School of Computer Science}       %% \department is recommended
  \institution{Georgia Institute of Technology} %% \institution is required
  \city{Atlanta}
  \state{GA}
  \country{United States}                    %% \country is recommended
}
\email{nathan.braswell@gtri.gatech.edu}      %% \email is recommended

\author{Sharjeel Khan}
%\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\affiliation{
  \department{School of Computer Science}       %% \department is recommended
  \institution{Georgia Institute of Technology} %% \institution is required                 %% \country is recommended
  \city{Atlanta}
  \state{GA}
  \country{United States}                    %% \country is recommended
}
\email{smkhan@gatech.edu}      %% \email is recommended

\author{Santosh Pande}
%\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\affiliation{
  \department{School of Computer Science}       %% \department is recommended
  \institution{Georgia Institute of Technology} %% \institution is required                 %% \country is recommended
  \city{Atlanta}
  \state{GA}
  \country{United States}                    %% \country is recommended
}
\email{santosh.pande@cc.gatech.edu}      %% \email is recommended


%% Author with two affiliations and emails.
%\author{First2 Last2}
%\authornote{with author2 note}          %% \authornote is optional;
                                        %%% can be repeated if necessary
%\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
%\affiliation{
  %\position{Position2a}
  %\department{Department2a}             %% \department is recommended
  %\institution{Institution2a}           %% \institution is required
  %\streetaddress{Street2a Address2a}
  %\city{City2a}
  %\state{State2a}
  %\postcode{Post-Code2a}
  %\country{Country2a}                   %% \country is recommended
%}
%\email{first2.last2@inst2a.com}         %% \email is recommended
%\affiliation{
  %\position{Position2b}
  %\department{Department2b}             %% \department is recommended
  %\institution{Institution2b}           %% \institution is required
  %\streetaddress{Street3b Address2b}
  %\city{City2b}
  %\state{State2b}
  %\postcode{Post-Code2b}
  %\country{Country2b}                   %% \country is recommended
%}
%\email{first2.last2@inst2b.org}         %% \email is recommended

%Notes from meeting 2022-11-04:
% Bring out 2 key contributions in introduction
%   - new online partial evaluation
%   - optimizations enabled by semantics
% Beef up optimization sections
% benchmark with & without the different ones being on
% Talk about the type inference and how effective it is
% log and show percentage of inlined primitives?
% log and show number of lazy environments avoided
%     - get amount of memory bloat avoided
% log closure inlining, before/after
%
% Add some high-level pseudocode to help with understanding partial evaluation
% and an overview of where it really helps with optimizations
%
% Show when they can be statically removed (when used as macros!)
%
%- (me state) - compare vs macro impl in Chez
%
%Elaborate hygiene + first-class benefits
% macro(x) (x+x) and return intrinsic __arctan examples
%Professor thinks this should really be elaborated - double-check vs POPL reviewer introduction criticism
% this kinda goes with my and macro example
% specify online partial evaluation being online binding time, which we still do statically at compile time

%write based on abstract
% Our new type of partial evaluation which enables partial evalaution of f-exprs and our following optimizations

% Justify benchmarks
% qualitative discussion of f-exprs/macro use in benchmarks
% "well known? benchmarks for functional languages"
% "to demonstrate power of f-eprs have rewritten in Kraken"
%
% Find citations for macro programming being hard to debug/error prone
% "we believe our approach makes debuggability much better based on our personal experience and here is how"


% MY PLAN
%   - Add overview partial eval pseudocode
%   -   Finish explanation text, referring back to pseudocode
%   - Add examples using calculus
%   - Evaluation statistics (number vs time)
%   -   Lazy Environments
%   -   Y-Combinator elimination
%   -   Primitive Inlining
%   -   Closure Inlining
%   - Introduction - hygine example to go with and example
%   -   specify "online" partial evaluation and explain


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
%In this work we devise an online partial evaluator and compiler backend supporting first-class, partially symbolic environments specifically focused on evaluating away f-exprs that behave like macros in order to show that a functional Lisp based on F-expressions (f-exprs) can be approximately as efficient and at least as expressive as one based on macros.
%  Macros are a common part of Lisp languages but it is difficult to create a powerful, safe, and intuitive macro system due to the complexities of controlling hygiene as well as macro's second-class nature.
%The resulting macro systems tend to be complex and resulting programs quite difficult to debug.

%% COMMENTS - Santosh : Can you simplify the writing in the following paragraph - break down into smaller sentences and easy flow
%% Made a run at it, thank you!
Macros are a common part of Lisp languages, and one of their most lauded features.
Much research has gone into making macros both safer and more powerful resulting in developments in multiple areas, including maintaining hygiene, and typed program staging \cite{rompf2013optimizing}.
However, macros do suffer from various downsides, including being second-class. Particularly egregious for eager functional programming, they are unable to be passed to higher-order functions or freely composed.

  Fexprs, as reformulated by John Shutt \cite{shutt2010fexprs}, provide a first-class and more powerful alternative to macros that meshes well with pure functional programming.
 Unfortunately, naive execution of fexprs is much slower than macros due to re-executing unoptimized operative combiner code at runtime that, in a macro-based language, would have been expanded and then optimized at compile time.
To show that fexprs can be practical replacements for macros, we formulate a small purely functional fexpr based Lisp, \kraken, with an online partial evaluation and compilation framework that supports first-class, partially-static-data environments and can completely optimize away fexprs that are used and written in the style of macros.
We show our partial evaluation and compilation framework produces code that is more than 70,000 times faster than naive interpretation due to the elimination of repeated work and exposure of static information enabling additional optimization.
  In addition, our \krakenSpace compiler performs better compared to existing interpreted languages that support fexprs, including improving on NewLisp's~\cite{mueller2018newlisp} fexpr performance by 233x on one benchmark.

  % All code available at \url{https://github.com/limvot/kraken}
  %(Code publically available but URL redacted for blind review)
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008.10011009.10011012</concept_id>
<concept_desc>Software and its engineering~Functional languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10011007.10011006.10011041</concept_id>
<concept_desc>Software and its engineering~Compilers</concept_desc>
<concept_significance>500</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~Functional languages}
\ccsdesc[500]{Software and its engineering~Compilers}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{partial evaluation, Vau, F-exprs, fexprs, WebAssembly} %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle

\input{texes/intro}
\input{texes/overview}
\input{texes/base}
\input{texes/partialevaluation}
\input{texes/optimizations}
\input{texes/evaluation}
\input{texes/relatedwork}
\input{texes/conclusion}


% \section{Future Work}
% \begin{itemize}
%     \item{} Reference Counting overhead\\ 
%       Implement Perceus reference counting.
%     \item{} Type-check and bounds-check hoisting and elimination
%     \item{} Implement a more powerful "overlay" language using f-expressions, Racket-style, that implements a strong type system (along the lines of "Type systems as macros" \cite{chang2017type} and "Dependent type systems as macros" \cite{chang2019dependent}) and Algebraic Effects (a la \cite{xie2021generalized}).
% \end{itemize}


%% Acknowledgments
%\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  %This material is based upon work supported by the
  %\grantsponsor{GS100000001}{National Science
    %Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  %No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  %No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  %conclusions or recommendations expressed in this material are those
  %of the author and do not necessarily reflect the views of the
  %National Science Foundation.
%\end{acks}


%% Bibliography
\bibliography{bibfile}

\input{texes/appendix}

\end{document}
