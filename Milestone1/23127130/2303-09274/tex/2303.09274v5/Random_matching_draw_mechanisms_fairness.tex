\pdfoutput=1
\documentclass[12pt]{article}
\usepackage[utf8]{inputenc}
% UK hyphenation
\usepackage[british]{babel}
% Copyable pdf
\usepackage{cmap}
% Font
\usepackage{lmodern}

%\usepackage{pdf14}

\usepackage{amssymb, amsmath, amsthm}
\usepackage[a4paper,top=25mm,bottom=25mm,left=25mm,right=25mm]{geometry}
%\usepackage{etex}
\usepackage{ragged2e}

\usepackage{authblk} % for headings
\usepackage{pifont}
\usepackage{graphicx}
\usepackage[dvipsnames,svgnames,table]{xcolor}
\usepackage[figuresright]{rotating}
\usepackage{xtab} % tackle the long tables
\usepackage{longtable} % tackle the long tables
\usepackage{multirow}
\usepackage{footnote}
\usepackage[stable]{footmisc}
\usepackage{chngpage} % allows for temporary adjustment of side margins
\usepackage{pdflscape} % landscape environment
\usepackage{tocbibind} % includes everything in ToC

\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\pgfplotsset{every tick label/.append style={font=\footnotesize}}
\usepackage{setspace}
%\doublespacing

\makesavenoteenv{tabular}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{threeparttable} % [flushleft]
\usepackage[referable]{threeparttablex} % footnotes in tabu
\newcolumntype{R}{>{\raggedleft\arraybackslash}X}
\newcolumntype{L}{>{\raggedright\arraybackslash}X}
\newcolumntype{C}{>{\centering\arraybackslash}X}
\newcolumntype{A}{>{\columncolor{gray!25}}C}
\newcolumntype{a}{>{\columncolor{gray!25}}c}

% Tabulator in itemize environment 
\newlength{\tablen}
\newcommand\tabbox[2][\tablen]{\makebox[#1][l]{#2}}

\usepackage{dcolumn} % alignment to decimal points
\newcolumntype{.}{D{.}{.}{-1}}

\usepackage{tikz}
\usetikzlibrary{arrows, calc, matrix, patterns, positioning, trees}
\usepackage[semicolon]{natbib}
\usepackage[hyphens]{url}
\usepackage{hyperref} % [hidelinks]
\hypersetup{
  colorlinks   = true,    		% Colours links instead of ugly boxes
  urlcolor     = blue,    		% Colour for external hyperlinks
  linkcolor    = blue,			% Colour of internal links
  citecolor    = ForestGreen,		  	% Colour of citations
}
\usepackage{microtype}
\usepackage[justification=centering]{caption} % [justification=centering]

% Captions of subtables and subfigures
\usepackage[labelformat=simple]{subcaption}
\renewcommand\thesubfigure{\alph{subfigure}}
\DeclareCaptionLabelFormat{parenthesis}{(#2)}
\captionsetup[subfigure]{labelformat=parenthesis,font+=small,list=false}
\makeatletter
\renewcommand\p@subfigure{\arabic{figure}.}
\makeatother

\renewcommand\thesubtable{\alph{subtable}}
\DeclareCaptionLabelFormat{parenthesis}{(#2)}
\captionsetup[subtable]{labelformat=parenthesis,font+=small,list=false}
\makeatletter
\renewcommand\p@subtable{\arabic{table}.}
\makeatother

\usepackage{alphalph}
\renewcommand*{\thesubfigure}{\alphalph{\value{subfigure}}}

% Pgfplot common legend
\newenvironment{customlegend}[1][]{%
	\begingroup
        % inits/clears the lists (which might be populated from previous
        % axes):
	\csname pgfplots@init@cleared@structures\endcsname
	\pgfplotsset{#1}%
    }{%
	% draws the legend:
	\csname pgfplots@createlegend\endcsname
	\endgroup
    }%
    % makes \addlegendimage available (typically only available within an
    % axis environment):
\def\addlegendimage{\csname pgfplots@addlegendimage\endcsname}

\usepackage{enumitem}

% felsorolasok behuzasa
\setlist[itemize]{leftmargin=2.5\parindent}
\setlist[enumerate]{leftmargin=2.5\parindent}

\theoremstyle{plain}
\newtheorem{assumption}{Assumption}%[section]
\newtheorem{conjecture}{Conjecture}[section]
\newtheorem{corollary}{Corollary}[section]
\newtheorem{lemma}{Lemma}[section]
\newtheorem{proposition}{Proposition}%[section]
\newtheorem{result}{Result}
\newtheorem{theorem}{Theorem}%[section]

\theoremstyle{definition}
\newtheorem{axiom}{Axiom}[section]
\newtheorem{condition}{Condition}[section]
\newtheorem{definition}{Definition}[section]
\newtheorem{example}{Example}%[section]
\newtheorem{observation}{Observation}%[section]
\newtheorem{problem}{Problem}[section]

\theoremstyle{remark}
\newtheorem{notation}{Notation}[section]
\newtheorem{remark}{Remark}%[section]

\newcommand{\aproof}{\hfill{\ding{111}}}

% Sakk elemzeshez kell
\newcommand{\down}{\textcolor{BrickRed}{\rotatebox[origin=c]{270}{\ding{212}}}}
\newcommand{\up}{\textcolor{PineGreen}{\rotatebox[origin=c]{90}{\ding{212}}}}

\def\keywords{\vspace{.5em} % Add keywords
{\noindent \textit{Keywords}: }}
\def\endkeywords{\par}

\def\AMS{\vspace{.5em} % Add keywords
{\noindent \textbf{\emph{MSC} class}: }}
\def\endAMS{\par}

\def\JEL{\vspace{.5em} % Add keywords
{\noindent \textbf{\emph{JEL} classification number}: }}
\def\endJEL{\par}

\title{Random matching in balanced bipartite graphs: \\ The (un)fairness of draw mechanisms used in sports}
\author{\href{https://sites.google.com/view/laszlocsato}{L\'aszl\'o Csat\'o}\thanks{~E-mail: \emph{laszlo.csato@sztaki.hun-ren.hu}} }
\affil{Institute for Computer Science and Control (SZTAKI) \\
Hungarian Research Network (HUN-REN) \\
Laboratory on Engineering and Management Intelligence \\
Research Group of Operations Research and Decision Systems}
\affil{Corvinus University of Budapest (BCE) \\
Institute of Operations and Decision Sciences \\
Department of Operations Research and Actuarial Sciences}
\affil{Budapest, Hungary}
\date{\today}

\renewcommand\Affilfont{\small}

\def\Dedication{
{\noindent
``\emph{In these circumstances, any non-random assignment of resources is likely to be asymmetric and perceived as unfair. Randomization can restore symmetry, and thus a measure of fairness.}''\footnote{~Source: \citet[p.~585]{BudishCheKojimaMilgrom2013}.}
}}
\def\endDedication{\par}

\begin{document}

\newgeometry{top=25mm,bottom=25mm,left=25mm,right=25mm}
\maketitle
\thispagestyle{empty}
\Dedication

\begin{abstract}
\noindent
%The draw of some knockout tournaments, such as the UEFA Champions League, requires finding a perfect matching in a balanced bipartite graph. The problem becomes challenging if there are draw constraints: the two field-proven procedures used in sports are known to be non-uniformly distributed, which threatens the fairness of the draw. Therefore, we compare the biases of both transparent mechanisms, each of them having two forms, for reasonable subsets of balanced bipartite graphs up to 16 nodes. The UEFA Champions League Round of 16 draw is verified to apply the best design among the four available options. However, considerable scope remains to improve the performance of the known randomisation procedures.
The draw of some knockout tournaments requires finding a perfect matching in a balanced bipartite graph. The problem becomes challenging with draw constraints: the two field-proven procedures used in sports are known to be non-uniformly distributed (the feasible matchings are not equally likely), which may threaten fairness. We compare the biases of both mechanisms, each of them having two forms, for reasonable subsets of balanced bipartite graphs up to 16 nodes. A mechanism is found to dominate all others in the draw of quarterfinals under reasonable restrictions. The UEFA Champions League Round of 16 draw is verified to apply the best design among the four available options between the 2003/04 and 2023/24 seasons. However, considerable scope remains to improve the performance of these randomisation procedures, especially because they tend to distort the probabilities in the same direction and roughly with the same magnitude.
\end{abstract}

\keywords{bipartite graph; constrained assignment; fairness; mechanism design; sports}

\AMS{62-08, 90-10, 90B90, 91B14}
% Computational methods for problems pertaining to statistics
% Mathematical modeling or simulation for problems pertaining to operations research and mathematical programming
% Case-oriented studies in operations research
% Social Choice

\JEL{C44, C63, Z20}
% Operations Research, Statistical Decision Theory
% Computational Techniques, Simulation Modeling 
% Sports Economics, General

\clearpage
\restoregeometry

\section{Introduction} \label{Sec1}

The knockout competition is one of the basic tournament formats \citep{DevriesereCsatoGoossens2024, ScarfYusofBilbao2009, SziklaiBiroCsato2022}. If the brackets are not predetermined, then two sets of teams should often be paired randomly against each other. Other constraints can be formulated by the organiser to avoid repeated matchups and ensure geographic diversity. Perhaps the most famous example is the UEFA Champions League Round of 16 draw, where the eight group winners and the eight runners-up qualifying from the group stage have been matched against each other between the 2003/04 and 2023/24 seasons. The assignment has not been allowed to contain any pair of teams coming from the same group or national association.

This leads to a well-known mathematical problem: finding a perfect matching in a balanced bipartite graph \citep{HopcroftKarp1973, TanimotoItaiRodeh1978}. In order to guarantee the fairness of the draw, any team needs to play against any other team with the same probability as if a perfect matching would be chosen randomly. Otherwise, a team will get stronger opponents in expected terms and might feel cheated.

In theory, the required property can be easily achieved by either choosing uniformly from the set of all valid assignments (if the number of nodes is relatively small), or using a uniform rejection sampler (that produces a random perfect matching of the associated complete bipartite graph, which is repeated until the matching satisfies all constraints).
However, these fair algorithms have at least two weaknesses:
(1) the drama or entertainment value of the draw would be lost; and
(2) all stakeholders should ``trust'' the computer to sample correctly, while their interests are often opposed.
Even though the first issue can be solved via a Metropolis or swap algorithm \citep{KlossnerBecker2013, RobertsRosenthal2024}, transparency remains a challenging requirement. It would be impossible to detect fraud and prevent conspiracy theories if a computer generates a perfect matching that is said random but certainly favours some teams at the expense of others. 

Therefore, the draw mechanism should also be perceived and understood as fair by all participants, which necessitates to verify all calculations at least \emph{ex-post}. For instance, a mistake was recognised in the 2021/22 UEFA Champions League Round of 16 draw, and the whole process was repeated three hours later \citep{Guyon2021d}.

According to our knowledge, two field-proven draw procedures exist in the realm of sports that can be used to choose a random perfect matching in a balanced bipartite graph.
The first, applied in European club football competitions, is called here the Drop mechanism. The second, applied in the group draw of various tournaments, including the FIBA Basketball World Cup and the FIFA World Cup, is called the Skip mechanism.
In addition, both the Drop and Skip mechanisms have two forms depending on the side of the bipartite graph where they start, similar to the well-known Gale--Shapley algorithm.

Naturally, there is no ``free lunch'' and all these transparent draw procedures are unfair, i.e., the feasible outcomes are not equally likely. Previous literature has analysed the distortions of the Drop \citep{Kiesl2013, KlossnerBecker2013, BoczonWilson2023} and the Skip \citep{Csato2024g, RobertsRosenthal2024} mechanism in different settings. However, they have \emph{never} been compared, which will be presented in the current paper. Since analytical calculations are cumbersome and should be done separately for each graph, our study is mainly limited to simulation results, analogous to the papers listed above.
%Nonetheless, we investigate a relatively large set of balanced bipartite graphs up to 16 nodes, which is also a crucial extension compared to the extant literature.

Our main contributions are as follows:
\begin{itemize}
\item
The smallest bipartite graph is found for which the two mechanisms are unfair (Proposition~\ref{Prop1});
\item
The Skip mechanism is proved to dominate the Drop mechanism in a draw of quarterfinals under reasonable restrictions (Theorem~\ref{Theo1});
%\item
%Sufficient conditions are provided for the fairness of the Drop and Skip mechanisms (Section~\ref{Sec54});
\item
The mechanism used for the UEFA Champions League Round of 16 draw is documented to be the best option among the four known transparent and field-proven procedures (Section~\ref{Sec55}; Results~\ref{Result1} and \ref{Result2});
\item
The four draw mechanisms are demonstrated to distort the probabilities in the same direction and roughly with the same magnitude (Observation~\ref{Obs5}).
\end{itemize}
Consequently, if the draw constraints are analogous to the restrictions applied in the UEFA Champions League, the Skip mechanism is certainly the best choice for the draw of quarterfinals but the Drop mechanism stochastically dominates it for the draw of the Round 16. Section~\ref{Sec53} gives a potential explanation: increasing the number of teams without additional draw restrictions decreases the bias of the Drop mechanism more rapidly than the bias of the Skip mechanism (Observation~\ref{Obs2}).

Furthermore, we substantially refine existing results on the UEFA Champions League Round of 16 draw. \citet{BoczonWilson2023} and \citet{KlossnerBecker2013} have not identified the advantage of the Drop mechanism over the Skip mechanism since not considering the latter. Both \citet[Footnote~33]{BoczonWilson2023} and \citet[Footnote~19]{KlossnerBecker2013} suggest that the difference between the Standard and Reversed Drop mechanisms is slight and uninteresting, which is debated in Sections~\ref{Sec55} and \ref{Sec56}. 
%In contrast to \citet[Footnote~19]{KlossnerBecker2013}, the effect of the draw order (the difference between the two forms of the Drop mechanism) turns out to be non-negligible (Section~\ref{Sec56});
%In contrast to \citet[p.~3482]{BoczonWilson2023}, the potential gain from a fairness-optimal randomisation is far from being marginal in certain instances (Section~\ref{Sec56}).

What are the lessons of our study for practitioners, such as tournament organisers?
Usually, more than one transparent randomisation procedure exists for a given allocation or assignment problem. It is advised to consider all field-proven solutions and choose the most appropriate lottery for the given setting after analysing their performance with respect to various theoretical properties such as fairness.

This is important even if the effect sizes found seem to be small at first glance. First, the biases can imply quite substantial financial differences: in the UEFA Champions League Round of 16 draw, the expected revenue of some teams is usually changed by more than 10 thousand euros in almost every season because of the distortions \citep{KlossnerBecker2013}. Second, changing the draw procedure to a better field-proven alternative has essentially no price, thus, it is worth implementing independently of the extent of improvement.

\section{Related literature} \label{Sec2}

Our paper is connected to two distinct lines of literature: the theory of random allocation mechanisms and fairness in tournament design.

The \emph{assignment problem}, widely discussed in the field of market design, aims to allocate indivisible objects among agents such that any agent receives exactly one object, and monetary transfers are prohibited. Examples include assigning of jobs to workers or time slots to users of a common good. Using a lottery is a straightforward trick for guaranteeing fairness: the random priority mechanism draws a random ordering of the agents from the uniform distribution and lets them successively choose an object \citep{AbdulkadirougluSonmez1998}. However, while uniform draw is traditionally used in sports as will turn out in Section~\ref{Sec3}, the policy of choosing the opponents is rarely applied \citep{Guyon2022a, HallLiu2024, LunanderKarlsson2023}.

\citet{HyllandZeckhauser1979} and \citet{BogomolnaiaMoulin2001} have developed an alternative solution to random assignment by directly identifying an expected assignment matrix that contains the probabilities with which the agents should get the objects.
\citet{BudishCheKojimaMilgrom2013} expand this theory to a much wider class of matching and assignment environments to accommodate multi-unit allocations and various real-world constraints, such as different quotas.
\citet{BoczonWilson2023} verify the power of this market design tool in the normative assessment of the UEFA Champions League Round of 16 draw.

The second approach, finding a procedure to reproduce an expected assignment matrix is natural in our setting since the ideal probabilities under uniform distribution can be easily calculated by a uniform rejection sampler \citep{RobertsRosenthal2024}. Indeed, \citet{BoczonWilson2023} conclude that the design of the UEFA Champions League Round of 16 draw is near-optimal and some reasonable variants of it are unable to reduce unfairness. However, they do not consider the Skip mechanism at all, which will be done in the following. Furthermore, the two variants of the Drop mechanism have the same level of fairness according to \citet[Footnote~33]{BoczonWilson2023} but this is a simplification according to Sections~\ref{Sec55} and \ref{Sec56}.
% Footnotes 31 and 33

The draw of sports tournaments has been analysed in operational research and statistics, too. Before \citet[Proposition~2]{BoczonWilson2023}, the non-uniformity of the Drop mechanism has already been demonstrated by \citet{Guyon2014a, Kiesl2013, KlossnerBecker2013, WallaceHaigh2013}.
%Even though the distortions in the probabilities seem to be marginal, these small biases may change the expected revenue of some teams by more than 10 thousand euros due to the substantial amount of prize money \citep{KlossnerBecker2013}.
Thus, \citet{RobertsRosenthal2024} have proposed various algorithms that guarantee uniform distribution---but they are more difficult to implement and understand than the Drop and Skip mechanisms.

Since draw constraints can be used in tournaments to achieve certain strategic goals such as minimising the threat of unfair behaviour \citep{Csato2022a}, the number and complexity of these conditions are expected to increase in the future. Section~\ref{Sec32} will bring some evidence for this development, which probably increases the role of the draw procedure. 

Random matching in a balanced bipartite graph makes sense only if at least one valid assignment exists. That can be checked by Hall's marriage theorem as shown by \citet{Kiesl2013} and \citet{WallaceHaigh2013} for the UEFA Champions League Round of 16 draw.
%\citet[Chapter~3.6]{Haigh2019} reviews this result as an application of mathematics in everyday life.

Finally, in contrast to the assignment problem in market design, the preferences of teams are ignored in sports competitions (and in our paper, too) since the organiser does not want to maximise welfare but approximate uniform distribution, guaranteeing the equal probability of all outcomes. An alternative interpretation can be that the teams have the same preference ordering on the set of their possible opponents because, for example, the strength of any team is given by a real number, which is common knowledge.

\section{Randomisation procedures used in sports} \label{Sec3}

It is a common problem in sports to divide a set of contestants into groups. The allocation is often subject to some rules, such as the existence of seeding pots to guarantee balancedness \citep{LalienaLopez2019, LaprePalazzolo2023}, and different criteria that ensure geographical diversity for increasing attractiveness \citep{Guyon2015a}. The seeding pots themselves do not imply any challenge since balls representing the teams can be drawn sequentially from urns associated with the seeding pots, which ensures uniform distribution. However, the presence of other constraints makes some assignments invalid, and the draw procedure should produce an admissible matching. According to our knowledge, two draw mechanisms are used in practice to that end. They are presented in Sections~\ref{Sec31} and \ref{Sec32}, respectively.

\subsection{The UEFA Champions League Round of 16 draw and the Drop mechanism} \label{Sec31}

The UEFA Champions League is the most prestigious European football club competition. Teams can qualify primarily based on the results of the domestic leagues in the previous year. Since the 1997/98 season, multiple entrants are allowed from the top national leagues.

The Champions League has been organised in the same format between the 2003/04 and 2023/24 seasons: a group stage played in eight home-away round-robin groups, where the top two teams qualify for the knockout stage.
In the Round of 16, the eight group winners and the eight runners-up are divided into eight mutually disjoint pairs subject to the following restrictions:
\begin{itemize}
\item
\emph{Bipartite constraint}: a group winner should play against a runner-up;
\item
\emph{Group constraint}: teams from the same group are not allowed to be paired;
\item
\emph{Association constraint}: clubs from the same country cannot be matched.
\end{itemize}
The first restriction reduces the number of valid assignments to $8! = 40{,}320$ as every outcome can be represented by a permutation of the eight groups.
The second restriction means that only a derangement (a permutation without a fixed point, where no element appears in its original position) is allowed, which decreases the number of feasible solutions to $!8 = \lfloor 8! / e + 1/2 \rfloor = 14{,}833$ \citep{KlossnerBecker2013} (the number of derangements of an $n$-element set is denoted by $!n$).
Finally, the impact of the association constraint depends on the identity of the teams, and no simple combinatorial formula exists to determine the number of possible draw outcomes. For instance, there have been $10{,}595$ feasible assignments in the 2023/24 season, but only $3{,}876$ in the 2022/2023 season.
%Even though the restrictions substantially reduce the number of possible matchings, there are still thousands of them.

UEFA has used the following mechanism in the Round of 16 draw:
\begin{itemize}
\item
Eight balls containing the names of the eight runners-up are placed in a bowl;
\item
A ball is drawn from the bowl, and the team drawn plays at home in match 1;
\item
The computer shows which group winners are eligible to play as the visiting team in match 1;
\item
Balls representing these teams are placed in another bowl;
\item
A ball is drawn from the second bowl to complete the pairing for match 1;
\item
The above procedure is repeated for the remaining matches.
\end{itemize}
The computer may indicate that only one group winner is allowed to play as the visiting team when this team is automatically assigned to the match.

In the following, this procedure will be called the \emph{Drop mechanism}.
It has two forms, depending on the side of the bipartite graph where it is started: UEFA draws the runner-up first, but the group winner can also be drawn first.

The Drop mechanism is more complicated than it seems at first glance because it should be checked not only whether draw conditions apply for the runner-up chosen at the moment, but also whether draw conditions are anticipated to apply for the teams still to be drawn. Let us see an illustration.

\begin{table}[t!]
  \centering
  \caption{Teams playing in the 2012/13 UEFA Champions League Round of 16}
  \label{Table1}
    \rowcolors{1}{gray!20}{}
    \begin{tabularx}{0.9\textwidth}{cLlLl} \toprule \hiderowcolors
    \multirow{2}[0]{*}{Group} & \multicolumn{2}{c}{Runner-up} & \multicolumn{2}{c}{Group winner} \\
          & Club  & Country & Club  & Country \\ \bottomrule \showrowcolors
    A     & Porto & Portugal & Paris Saint-Germain & France \\
    B     & Arsenal & England & Schalke 04 & Germany \\
    C     & Milan & Italy & M\'alaga & Spain \\
    D     & Real Madrid & Spain & Borussia Dortmund & Germany \\
    E     & Shakhtar Donetsk & Ukraine & Juventus & Italy \\
    F     & Valencia & Spain & Bayern M\"unchen & Germany \\
    G     & Celtic Glasgow & Scotland & Barcelona & Spain \\
    H     & Galatasaray & Turkey & Manchester United & England \\ \bottomrule
    \end{tabularx}
\end{table}

\begin{example} \label{Examp1} \citep{KlossnerBecker2013}
The participants of the 2012/13 UEFA Champions League Round of 16 are shown in Table~\ref{Table1}.
The draw happened as follows:
\begin{enumerate}
\item
The runner-up Galatasaray was drawn first. Its eligible opponents were all teams except for Manchester United owing to the group constraint. Out of the seven group winners, Schalke 04 was drawn.
\item
The runner-up Celtic Glasgow was drawn second. Its possible opponents were all teams except for Schalke 04 (already drawn), and Barcelona (group constraint). Out of the six group winners, Juventus was drawn.
\item
The runner-up Arsenal was drawn third. Its admissible opponents were all teams except for Schalke 04, Juventus (already drawn), and Manchester United (association constraint). The group constraint was ineffective. Out of the five group winners, Bayern M\"unchen was drawn.
\item
The runner-up Shakhtar Donetsk was drawn fourth. Its eligible opponents were all teams except for Schalke 04, Juventus, and Bayern M\"unchen (already drawn). Out of the five remaining group winners, Borussia Dortmund was drawn.
\item
The runner-up Milan was drawn fifth. The computer indicated that it should be paired with Barcelona, hence, no draw was carried out.
\end{enumerate}
Does this indicate a flaw? Naturally not. Four group winners (Paris Saint-Germain, M\'alaga, Barcelona, Manchester United) remained to be drawn. M\'alaga was prohibited by the group constraint. If Milan had played against the French or English team, then three pairings would have been left with four Spanish clubs (Real Madrid, Valencia, M\'alaga, Barcelona), and the association constraint would have been violated.

However, two (Real Madrid, Valencia) out of the three remaining runners-up still could have faced either Paris Saint-Germain or Manchester United. Therefore, the draw was not finished in the fifth round after Milan was drawn.
\end{example}

The same algorithm is used in other UEFA club competitions, too. The UEFA Cup Round of 32 draw was organised with both the association and the group constraints from 2004/05 until its last 2008/09 season \citep{UEFA2004}. The competition was renamed to UEFA Europa League and retained both restrictions in the Round of 32 draw until the 2020/21 season \citep{UEFA2009b, Csato2022d}. Between the 2021/22 and 2023/24 seasons, both the UEFA Europa League and the UEFA Europa Conference League contained knockout round play-offs contested by 16 teams as well as the Round of 16, where the association constraint applied but the group constraint was not considered \citep{UEFA2021e, UEFA2021d}.

A live probability calculator for the UEFA club competitions in the 2023/24 season, based on the Drop mechanism, is available at \url{https://julienguyon.github.io/UEFA-draws/}.
\citet{GuyonMeunier2023} summarise the mathematical background of the calculator.

\subsection{The traditional algorithm for restricted group draw: the Skip mechanism} \label{Sec32}

The FIFA World Cup is intended to contain geographically diverse groups since at least 1990. However, the draw of the 1990 \citep{Jones1990}, 2006 \citep{RathgeberRathgeber2007}, and 2014 \citep{Guyon2015a} tournaments were seriously unfair. Hence, the French mathematician \emph{Julien Guyon} has proposed using the Drop mechanism for the FIFA World Cup draw \citep{Guyon2014a} (this recommendation is missing from the published version of \citet{Guyon2015a}). FIFA has heard the message and adopted a similar, credible and transparent draw procedure \citep{Guyon2018d}: the team drawn is assigned to the first available slot in alphabetical order as indicated by the computer, meaning that a free slot may be ``skipped''. Let us see an illustration.

\begin{example}
Take the 2012/13 UEFA Champions League Round of 16 draw with the teams presented in Table~\ref{Table1}. Assume that the runners-up are drawn first in the order Galatasaray, Celtic Glasgow, Arsenal, Shakhtar Donetsk, Milan, Real Madrid, Porto, and Valencia. After the urn of the runners-up is emptied, the draw continues with the urn of the group winners.
\begin{enumerate}
\item
Schalke 04 is drawn first and matched with Galatasaray.
\item
Juventus is drawn second and assigned to Celtic Glasgow.
\item
Manchester United is drawn third and matched with Shakhtar Donetsk (the association constraint applies to Arsenal).
\item
Bayern M\"unchen is drawn fourth and assigned to Arsenal, which has had no opponent before.
\item
Borussia Dortmund is drawn fifth and matched with Porto.
\end{enumerate}
Why does Borussia Dortmund skip both Milan and Real Madrid? The situation is analogous to Example~\ref{Examp1}. Three group winners (Paris Saint-Germain, M\'alaga, Barcelona) remain to be drawn. If Milan plays against Borussia Dortmund, then three pairings will be left with four Spanish teams, and the association constraint will be violated. Furthermore, Real Madrid is not allowed to play against Borussia Dortmund due to the group constraint.
\end{example}

This procedure will be called the \emph{Skip mechanism}.

It is used more extensively than the Drop mechanism, including the following competitions:
\begin{itemize}
\item
FIBA Basketball World Cup: 2019 \citep{FIBA2019}, 2023 \citep{FIBA2023};
\item
FIFA World Cup: 2018 \citep{FIFA2017c}, 2022 \citep{FIFA2022a};
\item
European qualifiers for the FIFA World Cup: 2018 \citep{UEFA2015f}, 2022 \citep{UEFA2020c}, 2026 \citep{FIFA2024};
\item
UEFA Euro qualifying: 2016 \citep{UEFA2014b}, 2020 \citep{UEFA2018d}, 2024 \citep{UEFA2022e};
\item
UEFA Nations League: 2018/19 \citep{UEFA2018b}, 2020/21 \citep{UEFA2020d}, 2022/23 \citep{UEFA2021i}, 2024/25 \citep{UEFA2024a}.
\end{itemize}
Interestingly, the set of constraints has somewhat evolved over the years. For example, the 2016 UEFA Euro qualifying draw and the draw of the European qualifiers for the 2018 FIFA World Cup contained only some prohibited clashes and required five teams to be drawn into larger groups, while the 2020 UEFA Euro qualifying draw applied restrictions due to host nations, prohibited clashes, winter venue, and excessive travel.

Naturally, the Skip mechanism has as many variants as the possible orders of the pots \citep{Csato2024g}. It usually starts with the pot containing the strongest teams, although the European qualifiers for the 2018 FIFA World Cup and the UEFA Nations League until 2022/23 have followed a reversed order. For bipartite graphs, the Skip mechanism has two different forms.

\section{Methodology} \label{Sec4}

In the following, the methodology of our study is detailed.
Section~\ref{Sec41} presents the basic mathematical notions connected to the setting. Section~\ref{Sec42} overviews the graphs on which the draw mechanisms described in Section~\ref{Sec43} are investigated. Last but not least, Section~\ref{Sec44} discusses the comparison metrics.

\subsection{Preliminaries} \label{Sec41}

The nodes of a bipartite graph can be divided into two disjoint and independent sets $U$ and $V$ such that every edge is between a node in $U$ and a node in $V$. A bipartite graph is called \emph{balanced} if $|U| = |V| = n$. A \emph{perfect matching} is an independent edge set of size $n$.

For every bipartite graph $G$, the set of prohibited pairs, that is, the complement of graph $G$ will be considered. There are two kinds of constraints: \emph{pair constraints} and \emph{type constraints}.
Each node in $U$ has a pair in $V$ and vice versa, and it might not be allowed for the perfect matching to contain these $n$ edges called pair constraints.
Furthermore, every node has a type, which is different from the type of its pair. Type constraints imply that the perfect matching cannot contain any edge between two nodes of the same type.

In the complement of a graph $G$, the degree sequence of the set $U$ ($V$) lists the degrees of nodes in $U$ ($V$) in a non-increasing order.
Without loss of generality, the degree sequence of the set $U$ is assumed \emph{not} to be lexicographically smaller than the degree sequence of the set $V$ in the complement of any balanced bipartite graph $G$.
In all figures, nodes of $U$ will be on the left-hand side, while nodes of $V$ on the right-hand side. However, set $U$ contains the groups winners and set $V$ consists of the runners-up for the historical UEFA Champions League seasons.

\subsection{The choice of balanced bipartite graphs} \label{Sec42}

Three kinds of balanced bipartite graphs are investigated.
The first set consists of all graphs for $n=4$, both with and without pair constraints. The impact of adding one or two pairs of nodes with no additional type constraints will also be evaluated.
The second set is provided by the 21 historical UEFA Champions League seasons between 2003/04 and 2023/24.
The third set contains the graph corresponding to the 2017/18 Champions League Round of 16 (where set $U$ contains the runners-up since their degree sequence is lexicographically higher), and seven graphs of the same pattern.

\input{Figure1_n=4_all_cases}

For $n = 4$, Figure~\ref{Fig1} presents the 31 possible graphs $G_{1}$--$G_{31}$ with pair constraints if the type of each node and its pair is different.
The last four graphs ($G_{28}$--$G_{31}$) have valid assignments only if $n \geq 5$.
These graphs may represent the draw of quarterfinals in a sports tournament, where four group winners and four runners-up should be matched such that teams from the same group cannot play against each other and no group contains more than one team of each type.

\input{Figure2_n=4_all_cases_noG}

For $n = 4$, Figure~\ref{Fig2} presents all the 20 possible graphs $H_{1}$--$H_{31}$ without pair constraints. Their labelling follows the graphs $G_{1}$--$G_{31}$, for instance, $H_{12-14}$ can be obtained from either $G_{12}$, or $G_{13}$, or $G_{14}$ by removing the pair constraints. %$H_{32}$--$H_{34}$ have no such pair---but they have no valid assignments, too.
These graphs may represent the draw of quarterfinals in a sports tournament, where four group winners and four runners-up should be matched such that teams from the same group are allowed to play against each other but no group contained more than one team from each type.

\input{Figure3_highly_unfair_graphs}

Finally, Figure~\ref{Fig3} shows eight graphs, all representing possible outcomes in the UEFA Champions League Round of 16. From at most two national associations, five clubs can play in the group stage: five German (Spanish) teams have participated in the 2022/23 (2023/24) season.

\subsection{Draw mechanisms analysed} \label{Sec43}

The \emph{Uniform mechanism} is uniformly distributed over the set of perfect matchings, it chooses one matching randomly.

The \emph{Standard Drop mechanism} is the Drop mechanism starting from the set $V$ (nodes on the right-hand side), while the \emph{Reversed Drop mechanism} is the Drop mechanism starting from the set $U$ (nodes on the left-hand side). These names follow the convention of UEFA that starts the Drop mechanism on the side of the runners-up.

The \emph{Standard Skip mechanism} is the Skip mechanism starting from the set $U$ (nodes on the left-hand side), while the \emph{Reversed Skip mechanism} is the Drop mechanism starting from the set $V$ (nodes on the right-hand side).

\subsection{Quantifying unfairness} \label{Sec44}

The (un)fairness of the draw mechanisms will be evaluated by focusing on the probability of matching two nodes. Let $p_{ij}$ be the ideal probability that nodes $i$ and $j$ are matched under the Uniform mechanism, and $p_{ij}^M$ be the probability of this event if mechanism $M$ is used to obtain a feasible assignment. Two fairness distortion measures for mechanism $M$ are introduced as follows:
\begin{equation} \label{eq_AFD}
\mathit{AFD}(M) = 100 \cdot \frac{\sum_{i,j} \left| p_{ij} - p_{ij}^M \right|}{\sum_{i,j} \# \left\{ p_{ij} > 0 \right\}},
\end{equation}
\begin{equation} \label{eq_MFD}
\mathit{MFD}(M) = 100 \cdot \max_{i,j} \left| p_{ij} - p_{ij}^M \right|,
\end{equation}
where $\sum_{i,j} \# \left\{ p_{ij} > 0 \right\}$ is the number of pairs with a positive probability.

$\mathit{AFD}$ is called \emph{average fairness distortion} and $\mathit{MFD}$ is called \emph{maximal fairness distortion}. Obviously, $\mathit{AFD}$ allows the draw mechanism to compensate for the increased unfairness regarding a particular pair of nodes with a reduction in other pairs, while this is not possible under $\mathit{MFD}$. Furthermore, the value of $\mathit{MFD}$ has a more straightforward interpretation: how much is the probability of a potential pair changed by mechanism $M$ compared to the uniform draw \emph{in the worst case}.
The multiplier 100 in formulas~\eqref{eq_AFD} and \eqref{eq_MFD} means that both fairness distortions can be interpreted as a percentage.

The maximum of $\sum_{i,j} \# \left\{ p_{ij} > 0 \right\}$ is $n(n-1)$, which is reached if the type constraint is ineffective. However, this has never happened in the UEFA Champions League, where the denominator varies between 43 (2019/20) and 54 (2023/24).

Note that not only the Uniform mechanism may be undistorted. However, if a draw procedure implies that each team has the same probability to play against any of its possible opponents as under the Uniform mechanism, no team can effectively argue against this draw procedure.

Two draw procedures $M_1$ and $M_2$ are said to \emph{coincide} for graph $G$ if $p_{ij}^{M_1} = p_{ij}^{M_2}$ for every $i \in U$ and $j \in V$.

For $n \leq 6$ (Sections~\ref{Sec51}--\ref{Sec53}), we compute the exact probabilities via complete enumeration.
If $n=8$ (Sections~\ref{Sec55} and \ref{Sec56}), the draw mechanisms are simulated $N = 10^8$ times, which leads to 95 percent confidence intervals smaller than $\pm 0.00015$ \citep[Proposition~4]{BoczonWilson2023}. This upper bound takes into account that a conservative estimate for the assignment probability is 0.5 rather than 0.25 since the probability of Barcelona versus Chelsea is 43.75\% in the 2017/18 UEFA Champions League Round of 16.

\citet{BoczonWilson2023} use a more complicated quantification of fairness that computes the average absolute difference in the match likelihoods across all valid pairwise comparisons. Consequently, their distortion metric equals zero only in the absence of draw constraints, and increases with the number of restricted pairs. On the other hand, both $\mathit{AFD}$ and $\mathit{MFD}$ are zero for the Uniform mechanism.

\section{Results} \label{Sec5}

This section presents our findings.
Section~\ref{Sec51} identifies the smallest balanced bipartite graph for which the Drop and Skip mechanisms are unfair.
Section~\ref{Sec52} presents the distortions for the graphs displayed in Figures~\ref{Fig1} and \ref{Fig2}.
Section~\ref{Sec53} analyses the same graphs after adding one or two pairs of nodes without further type constraints.
Based on these calculations, Section~\ref{Sec54} provides sufficient conditions for the fairness of these draw procedures.
Section~\ref{Sec55} examines the graphs provided by the 21 historical Champions League seasons, while Section~\ref{Sec56} discusses the graphs shown in Figure~\ref{Fig3}.

\subsection{The unfairness of the draw mechanisms: a minimal example} \label{Sec51}

The first statement uncovers the simplest case when the draw mechanisms used in sports are distributed non-uniformly. The calculation is not especially interesting, but it clearly reveals why the derivation of general analytical results is close to impossible.

\begin{proposition} \label{Prop1}
Assume that $n \leq 3$.
The Standard Drop, Reversed Drop, Standard Skip, and Reversed Skip mechanisms coincide and they are \emph{unfair} for only one particular graph.
\end{proposition}

\input{Figure4_n=3_unfair_graph}

\begin{proof}
All bipartite graphs with $n \leq 3$ have been checked via complete enumeration. The unique graph for which unfairness emerges is shown in Figure~\ref{Fig4}.
In the case of all draw mechanisms, we compute the probability of nodes $a$ and $B$ being matched.

\emph{Uniform mechanism}: There are $3! = 6$ assignments in the absence of the constraints. Both the first (nodes $a$ and $A$) and the second (nodes $b$ and $B$) type constraints exclude $2! = 2$ assignments, respectively. However, $1! = 1$ among them is counted twice, thus, the number of valid assignments equals $3$. Nodes $a$ and $B$ are matched in $2! = 2$ assignments, the corresponding probability is $2/3$.

\emph{Drop mechanism}:
Five cases will be distinguished with respect to the draw order of the nodes in $U$:
\begin{itemize}
\item
Node $a$ is drawn first (this event has a chance of $1/3$):
Node $a$ has two possible pairs ($B$ and $C$), $B$ is chosen with a probability of $1/2$.
\item
Node $a$ is drawn second and node $b$ is drawn first (this event has a chance of $1/6$):
Node $b$ has two possible pairs ($A$ and $C$). \\
If $b$ is assigned to $A$, node $a$ has two possible pairs ($B$ and $C$) among the remaining nodes, $B$ is chosen with a probability of $1/2$. \\
If $b$ is assigned to $C$, node $a$ has only one possible pair ($B$) among the remaining nodes.
\item
Node $a$ is drawn second and node $b$ is drawn third (this event has a chance of $1/6$):
Node $c$ has three possible pairs. \\
If $c$ is assigned to $A$, node $a$ has two possible pairs ($B$ and $C$) among the remaining two nodes. However, $b$ cannot be assigned to $B$, hence, $B$ is chosen with a probability of $1$. \\
If $c$ is assigned to $B$, node $a$ cannot be matched with $B$. \\
If $c$ is assigned to $C$, node $a$ has only one possible pair ($B$) among the remaining two nodes.
\item
Node $a$ is drawn third and node $b$ is drawn first (this event has a chance of $1/6$):
Node $b$ has two possible pairs ($A$ and $C$). \\
If $b$ is assigned to $A$, node $c$ has two possible pairs ($B$ and $C$) among the remaining two nodes. Thus, the probability that $a$ is paired with $B$ equals $1/2$. \\
If $b$ is assigned to $C$, node $c$ has two possible pairs ($A$ and $B$) among the remaining two nodes. However, $a$ cannot be assigned to $A$, hence, the probability that $a$ is paired with $B$ equals $1$.
\item
Node $a$ is drawn third and node $b$ is drawn second (this event has a chance of $1/6$):
Node $c$ has three possible pairs. \\
If $c$ is assigned to $A$, node $b$ has only one possible pair ($C$) among the remaining two nodes, and node $a$ will certainly be matched with $B$. \\
If $c$ is assigned to $B$, node $a$ cannot be matched with $B$. \\
If $c$ is assigned to $C$, node $b$ has only one possible pair ($A$) among the remaining two nodes, and node $a$ will certainly be matched with $B$.
\end{itemize}
Consequently, the probability that node $a$ is assigned to node $B$ equals
\begin{align*}
\frac{1}{3} \cdot \frac{1}{2} + \frac{1}{6} \cdot \left( \frac{1}{2} \cdot \frac{1}{2} + \frac{1}{2} \cdot 1 \right) + \frac{1}{6} \cdot \left( \frac{1}{3} \cdot 1 + \frac{1}{3} \cdot 0 + \frac{1}{3} \cdot 1 \right) + \frac{1}{6} \cdot \left( \frac{1}{2} \cdot \frac{1}{2} + \frac{1}{2} \cdot 1 \right) + \\
+ \frac{1}{6} \cdot \left( \frac{1}{3} \cdot 1 + \frac{1}{3} \cdot 0 + \frac{1}{3} \cdot 1 \right) = \frac{1}{6} + \frac{1}{8} + \frac{1}{9} + \frac{1}{8} + \frac{1}{9} = \frac{23}{36}.
\end{align*}

\emph{Skip mechanism}:
Six cases will be distinguished with respect to the draw order of the nodes in $U$, each of them having a chance of $1/6$ to occur:
\begin{itemize}
\item
Node $a$ is drawn first and node $b$ is drawn second:
Node $B$ will be assigned to node $a$ if
(a) node $B$ is drawn first from $V$; or
(b) node $A$ is drawn first and node $B$ is drawn second from $V$ (because node $A$ ``skips'' node $a$). \\
This has a probability of $1/2$ because the nodes in $V$ have $3! = 6$ permutations.
\item
Node $a$ is drawn first and node $b$ is drawn third:
Node $B$ will be assigned to node $a$ if
(a) node $B$ is drawn first from $V$; or
(b) node $A$ is drawn first (when node $A$ ``skips'' node $a$). \\
This has a probability of $2/3$.
\item
Node $a$ is drawn second and node $b$ is drawn first:
Node $B$ will be assigned to node $a$ if
(a) node $B$ is drawn first from $V$ (because $B$ cannot matched with $b$); or
(b) node $B$ is drawn second from $V$; or
(c) node $C$ is drawn first and node $B$ is drawn third from $V$ (when node $A$ ``skips'' node $a$ and is assigned to node $c$). \\
This has a probability of $5/6$ since only the permutation $(A,C,B)$ is not appropriate.
\item
Node $a$ is drawn second and node $b$ is drawn third:
Node $B$ will be assigned to node $a$ if
(a) node $B$ is drawn second from $V$; or
(b) node $B$ is drawn third from $V$ (when the node drawn second from $V$ ``skips'' node $a$). \\
This has a probability of $2/3$.
\item
Node $a$ is drawn third and node $b$ is drawn first:
Node $B$ will be assigned to node $a$ if
(a) node $B$ is drawn second and node $A$ is drawn third from $V$ (when node $B$ ``skips'' node $c$); or
(b) node $B$ is drawn third from $V$. \\
This has a probability of $1/2$.
\item
Node $a$ is drawn third and node $b$ is drawn second:
Node $B$ will be assigned to node $a$ if
(a) node $B$ is drawn second from $V$ (when node $B$ ``skips'' node $b$); or
(b) node $B$ is drawn third from $V$. \\
This has a probability of $2/3$.
\end{itemize}
Consequently, the probability that node $a$ is assigned to node $B$ equals
\begin{align*}
\frac{1}{6} \cdot \left( \frac{1}{2} + \frac{2}{3} + \frac{5}{6} + \frac{2}{3} + \frac{1}{2} + \frac{2}{3} \right) = \frac{1}{6} \cdot \frac{23}{6} = \frac{23}{36}.
\end{align*}
The Standard and Reversed forms of the Drop and Skip mechanisms coincide since the sets $U$ and $V$ are exchangeable in the bipartite graph shown in Figure~\ref{Fig4}.
\end{proof}

\begin{table}[t!]
  \centering
  \caption{Assignment matrices for the balanced bipartite graph with six nodes in Figure~\ref{Fig4}}
  \label{Table2}
  
\begin{subtable}{\textwidth}
  \centering
  \caption{Uniform mechanism: Probabilities for all pairs of nodes}
  \label{Table2a}
    \rowcolors{1}{}{gray!20}
    \begin{tabularx}{0.6\textwidth}{l CCC} \toprule \hiderowcolors
          & A     & B     & C \\ \bottomrule \showrowcolors
    a     &  2/3  & 0     &  1/3 \\
    b     & 0     &  2/3  &  1/3 \\
    c     &  1/3  &  1/3  &  1/3 \\ \toprule
    \end{tabularx}
\end{subtable}

\vspace{0.25cm}
\begin{subtable}{\textwidth}
  \centering
  \caption{Drop and Skip mechanisms: Probabilities for all pairs of nodes}
  \label{Table2b}
    \rowcolors{1}{}{gray!20}
    \begin{tabularx}{0.6\textwidth}{l CCC} \toprule \hiderowcolors
          & A     & B     & C \\ \bottomrule \showrowcolors
    a     &  23/36 & 0       &  13/36 \\
    b     & 0       &  23/36 &  13/36 \\
    c     &  13/36 &  13/36 &   5/18 \\ \toprule
    \end{tabularx}
\end{subtable}
\end{table}

\begin{example} \label{Examp3}
The assignment matrices for the graph shown in Figure~\ref{Fig4} are given in Table~\ref{Table2}. Therefore,
\[
\mathit{AFD} = 100 \cdot \left( 2 \cdot \left\lvert \frac{2}{3} - \frac{23}{36} \right\rvert + 4 \cdot \left\lvert \frac{1}{3} - \frac{13}{36} \right\rvert + \left\lvert \frac{1}{3} - \frac{5}{18} \right\rvert \right) \cdot \frac{1}{7} = \frac{100}{7} \cdot \frac{8}{36} = 3 \frac{11}{63}.
\]
The maximal distortion occurs for nodes $c$ and $C$:
\[
\mathit{MFD} = 100 \cdot \left\lvert \frac{1}{3} - \frac{5}{18} \right\rvert = 5\frac{5}{9}.
\]
\end{example}

\begin{remark} \label{Rem1}
Section~\ref{Sec56} will present a graph corresponding to a possible UEFA Champions League season ($n=8$), for which maximal fairness distortion exceeds the value derived in Example~\ref{Examp3}.
\end{remark}

Although Proposition~\ref{Prop1} is mainly a theoretical result, it might have practical relevance. For example, the play-offs of the 2024 UEFA European Championship qualifying tournament have determined the last three national teams that can play in the European Championship. While the play-offs contain three independent paths with four participants each, an alternative structure could be to organise two knockout rounds with pairing constraints. Then the assignment in the second knockout round may be given in Figure~\ref{Fig4}, when all the four draw mechanisms have the same level of unfairness.

\subsection{The case of eight nodes: Draw of quarterfinals} \label{Sec52}

\input{Figure5_n=4_unfairness}

Figure~\ref{Fig5} presents unfairness for all balanced bipartite graphs with eight nodes such that no node could have the same type as its pair: Figure~\ref{Fig5a} if the pair constraints are effective (graphs in Figure~\ref{Fig1}), while Figure~\ref{Fig5b} if there are only type constraints (graphs in Figure~\ref{Fig2}).

In the presence of pair constraints (Figure~\ref{Fig5a}), both the Drop and Skip mechanisms are fair for 20 graphs and unfair for seven graphs ($G_2$, $G_4$, $G_5$, $G_8$, $G_{11}$, $G_{13}$, $G_{20}$). The absolute and maximal differences are quite high, the probability of matching two nodes can differ by at least five percentage points for all these seven graphs. The ranking of the graphs by the two measures is different, the worst case is $G_4$ for $\mathit{AFD}$ but $G_2$ for $\mathit{MFD}$.

\begin{theorem} \label{Theo1}
For a balanced bipartite graph with eight nodes, pair and type constraints such that pair and type constraints cannot coincide:
\begin{itemize}
\item
The two versions (Standard and Reversed) of the Drop and Skip mechanisms, respectively, coincide;
\item
The Skip mechanism dominates the Drop mechanism as it is less distorted for graph $G_2$.
\end{itemize}
\end{theorem}

The bipartite graphs considered in Theorem~\ref{Theo1} describe all possible scenarios in a hypothetical draw of quarterfinals according to the rules of the UEFA Champions League. Therefore, it is highly relevant for tournament organisers: any such draw should be carried out by the Skip mechanism.

If pair constraints are removed (Figure~\ref{Fig5b}), then both the Drop and Skip mechanisms are fair for 14 graphs and unfair for the remaining six graphs ($H_{3-5}$, $H_{6-8}$, $H_{12-14}$, $H_{15-16}$, $H_{18-20}$, $H_{21-22}$). Since the Drop mechanism is less unfair for graph $H_{18-20}$ and the Skip mechanism is less unfair for graph $H_{6-8}$, neither of them is preferred to the other. However, the Reversed Drop mechanism is fairer than the Standard Drop mechanism. The absolute and maximal distortions are generally lower compared to the graphs with pair constraints.

\begin{observation} \label{Obs1}
For a balanced bipartite graph with eight nodes and type constraints such that no node has the same type as its pair, the Reversed Drop mechanism is fairer than the Standard Drop mechanism according to both measures $\mathit{AFD}$ and $\mathit{MFD}$ due to graph $H_{12-14}$.
\end{observation}

%In contrast to Result~\ref{Result1}, the Reversed Drop mechanism does not dominate the Standard Drop mechanism on the set of bipartite graphs described in Result~\ref{Result2} as it is more distorted for some pairs of nodes.

There is no analogous relation for the Skip mechanism: the Reversed Skip mechanism is less unfair for graph $H_{12-14}$ but it is worse for graph $H_{15-16}$.

\subsection{Increasing the number of nodes} \label{Sec53}

\input{Figure6_n=5_unfairness}

\input{Figure7_n=6_unfairness}

In order to get more insight into the draw mechanisms, Figures~\ref{Fig6} and \ref{Fig7} uncover their unfairness if one pair and two pairs of nodes are added (without further type constraints), respectively, to the previous graphs with $n=4$.

Under pair constraints, the Drop and Skip mechanisms are fair for six graphs if $n=5$ but only for two graphs if $n=6$. Neither the Drop nor the Skip mechanism is better than the other. The draw order has a surprising effect: for graph $G_{11}$ and $\mathit{MFD}$, the Reversed Drop mechanism has a higher unfairness by 2.2\% compared to the Standard version if $n=5$, but a lower unfairness by 6\% if $n=6$. Thus, merely adding a pair of nodes without type constraints can change the optimal draw order. Analogously, for graph $G_{26}$, the Reversed Skip mechanism is less fair according to both measures than the Standard Skip mechanism if $n=5$, but their order is changed if $n=6$.
Maximal unfairness exceeds 8(\%) for graph $G_{22}$ if $n=5$, which indicates a quite serious problem. However, the absolute distortions are not worse than in Example~\ref{Examp1}.

Adding a pair of nodes without type constraints does not necessarily improve fairness. For example, the unfairness of our mechanisms for graph $G_{18}$ is at least quintupled if $n=6$ compared to $n=5$, although the number of valid assignments increases from 10 to 93.

For the graphs without pair constraints (Figures~\ref{Fig6b} and \ref{Fig7b}), the Drop and Skip mechanisms are fair for five and unfair for the remaining 15 graphs. Among the latter, the Reversed Drop mechanism is usually better than the Standard version, for instance, its average fairness distortion is the same for nine graphs and is lower for six graphs. However, in the case of graph $H_{26}$, $\mathit{MFD}$ favours the Standard Drop mechanism for both $n=5$ and $n=6$. Similarly, the Reversed Skip mechanism is usually less unfair than the Standard Skip mechanism.

Regarding the two main draw mechanisms, we have a more robust finding.

\begin{proposition} \label{Prop2}
For a balanced bipartite graph with 10 or 12 nodes, and type constraints affecting at most four pairs of nodes such that no node has the same type as its pair, the Reversed (Standard) Drop mechanism is fairer than the Reversed (Standard) Skip mechanism according to both measures $\mathit{AFD}$ and $\mathit{MFD}$.
\end{proposition}

In the examples without pair constraints, having an additional unconstrained pair of nodes generally reduces the level of unfairness, except if the draw mechanisms are fair only due to the symmetry of the underlying graph such as $H_{9-10}$. However, this cannot explain the higher maximal fairness distortion of the Standard Skip mechanism for graph $H_{15-16}$ if $n$ is increased from 4 to 5.

Figures~\ref{Fig5}--\ref{Fig7} suggest an interesting pattern on the role of $n$.

\begin{observation} \label{Obs2}
If type constraints affect at most four pairs of nodes such that no node has the same type as its pair, then a higher number of nodes increases the advantage of the Drop mechanism with respect to fairness, independently of the presence of pair constraints.
\end{observation}

According to Observation~\ref{Obs2}, having more nodes without additional constraints seems to reduce the unfairness of the Drop mechanism more rapidly than the unfairness of the Skip mechanism.

\subsection{Sufficient conditions for fairness} \label{Sec54}

The calculations in Sections~\ref{Sec52} and \ref{Sec53} allow us to formulate sufficient conditions for the fairness of the draw procedures.

\begin{proposition} \label{Prop3}
The Drop and the Skip mechanisms are fair if one of the following conditions holds:
\begin{itemize}
\item
There is only one valid matching (graphs $G_{18}$, $G_{19}$, $G_{21}$, $G_{23}$--$G_{27}$ if $n=4$);
\item
There are no type constraints (graphs $G_1$ and $H_1$);
\item
There are no pair constraints and the type constraints affect only one node on one side of the bipartite graph (graphs $H_2$, $H_{11}$, $H_{28}$);
\item
The balanced bipartite graph can be decomposed into two unconnected balanced bipartite graphs such that the complement of the first subgraph is complete and the draw mechanism is fair for the second subgraph (graphs $G_3$ and $H_{23}$).
\end{itemize}
\end{proposition}

\subsection{Graphs given by the UEFA Champions League Round of 16} \label{Sec55}

\input{Figure8_UEFA_CL_Drop_Skip}

Figure~\ref{Fig8} compares the distortions of the Drop and Skip mechanisms for the 21 graphs given by the historical UEFA Champions League seasons between 2003/04 and 2023/24. The officially used Drop mechanism is fairer in all cases according to $\mathit{AFD}$. This robust result almost holds with respect to maximal fairness distortion, too, except for the Standard Drop and Standard Skip mechanisms in the 2014/15 season (where the Reversed Drop is the best option).

\input{Table3_fairness_distortion_heatmap_CL2022}

Unsurprisingly, the level of unfairness strongly depends on the set of constraints, $\mathit{AFD}$ varies between 0.051(\%) and 0.363(\%) for the Drop mechanism and can exceed 0.5(\%) for the Skip mechanism. The difference are even higher for $\mathit{MFD}$, the two disadvantageous outliers are the 2017/18 and the 2022/23 seasons. As an illustration, the distortions in the 2022/23 season are presented in Table~\ref{Table3}. The highest absolute bias affects the match Bayern M\"unchen versus Liverpool, which is above 2.7\% for all draw mechanisms that imply a lower probability than the Uniform draw. It can also be seen that the distortions follow the same patterns, the four mechanisms usually change the probabilities in the same direction and roughly with the same magnitude.

Nonetheless, the performance of the Drop and Skip mechanisms is relatively similar, it is impossible to achieve a fundamental improvement by any draw procedure if the constraints have an unfavourable structure. This finding sheds new light on \citet[Result~2]{BoczonWilson2023}: they would probably have concluded that each of the four field-proven mechanisms comes quantitatively close to a constrained-best.

The situation is more obvious after removing the pair constraints (Figure~\ref{Fig8b}), when the superiority of the Drop mechanism becomes undeniable. Both procedures would have been entirely fair in 2003/04 and 2023/24 due to the third condition of Proposition~\ref{Prop3}. However, the Drop mechanism can decrease the average fairness distortion of the Skip mechanism from about 0.445(\%) to below 0.2(\%) for the graph corresponding to the 2013/14 season, which provides an interesting example because the distortions are much lower---0.057(\%) for the Drop and 0.163(\%) for the Skip---with the eight additional pair constraints. On the other hand, the worst maximal fairness distortions are again associated with the 2017/18 and the 2022/23 seasons as in Figure~\ref{Fig8a}.

\begin{result} \label{Result1}
The Drop mechanism is (almost) always better than the Skip mechanism for the graphs corresponding to the historical draws of the UEFA Champions League Round of 16.
\end{result}

In particular, the cumulated $\mathit{MFD}$ ($\mathit{AFD}$) over the 21 seasons is smaller by 40.5\% (39.7\%) under the Standard Drop mechanism than under the Standard Skip mechanism.

\input{Figure9_UEFA_CL_draw_order}

Figure~\ref{Fig9} focuses on the effect of the draw order. As expected, the difference between the Standard and Reversed versions is more moderated than the difference between the Drop and Skip mechanisms. The Skip mechanism is almost insensitive to the draw order, and removing the pair constraints also diminishes the role of the draw order.

In the presence of draw constraints, the Standard Drop mechanism seems to be better than the Reversed Drop. This is quite remarkable for the 2017/18 season, where the Standard Drop decreases both measures of unfairness by approximately 30\% compared to the Reversed Drop. The issue will be further investigated in Section~\ref{Sec56}.

Note that both the Standard and the Reversed Drop mechanisms have the same chance to be fairer than the other version from a purely mathematical point of view: the assumption in Section~\ref{Sec41} that the degree sequence of the set $U$ is not lexicographically smaller is arbitrary. In other words, if the Reversed Drop is preferred for a balanced bipartite graph but sets $U$ and $V$ are exchanged, then the Standard Drop becomes preferred.

\begin{table}[t!]
  \centering
  \caption{Associations with more than one team \\ in the UEFA Champions League Round of 16}
  \label{Table4}
\centerline{
\begin{threeparttable}
    \rowcolors{1}{gray!20}{}
    \begin{tabularx}{1.2\textwidth}{r CCC CCC CCC CCC CCC CCC} \toprule \hiderowcolors
    \multirow{2}[0]{*}{Season} & \multicolumn{3}{c}{England} & \multicolumn{3}{c}{France} & \multicolumn{3}{c}{Germany} & \multicolumn{3}{c}{Italy} & \multicolumn{3}{c}{Portugal} & \multicolumn{3}{c}{Spain} \\
          & 1    & 2    & $\Delta$  & 1    & 2    & $\Delta$  & 1    & 2    & $\Delta$  & 1    & 2    & $\Delta$  & 1    & 2    & $\Delta$  & 1    & 2    & $\Delta$ \\  \bottomrule \showrowcolors
    2003/04 & 3     & 0     & 3     & 2     & 0     & 2     & 0     & 2     & $-$2    & 2     & 0     & 2     & 0     & 1     & $-$1    & 1     & 3     & $-$2 \\
    2004/05 & 2     & 2     & 0     & 2     & 0     & 2     & 1     & 2     & $-$1    & 3     & 0     & 3     & 0     & 1     & $-$1    & 0     & 2     & $-$2 \\
    2005/06 & 2$^\ast$ & 1     & 0$^\ast$     & 1     & 0     & 1     & 0     & 2     & $-$2    & 3     & 0     & 3     & 0     & 1     & $-$1    & 2     & 1     & 1 \\
    2006/07 & 4     & 0     & 4     & 1     & 1     & 0     & 1     & 0     & 1     & 1     & 2     & $-$1    & 0     & 1     & $-$1    & 1     & 2     & $-$1 \\
    2007/08 & 2     & 2     & 0     & 0     & 1     & $-$1    & 0     & 1     & $-$1    & 2     & 1     & 1     & 1     & 0     & 1     & 3     & 0     & 3 \\
    2008/09 & 2     & 2     & 0     & 0     & 1     & $-$1    & 1     & 0     & 1     & 2     & 1     & 1     & 1     & 1     & 0     & 1     & 3     & $-$2 \\
    2009/10 & 3     & 0     & 3     & 1     & 1     & 0     & 0     & 2     & $-$2    & 1     & 2     & $-$1    & 0     & 1     & $-$1    & 3     & 0     & 3 \\
    2010/11 & 3     & 1     & 2     & 0     & 2     & $-$2    & 2     & 0     & 2     & 0     & 3     & $-$3    & 0     & 0     & 0     & 2     & 1     & 1 \\
    2011/12 & 2     & 0     & 2     & 0     & 2     & $-$2    & 1     & 1     & 0     & 1     & 2     & $-$1    & 1     & 0     & 1     & 2     & 0     & 2 \\
    2012/13 & 1     & 1     & 0     & 1     & 0     & 1     & 3     & 0     & 3     & 1     & 1     & 0     & 0     & 1     & $-$1    & 2     & 2     & 0 \\
    2013/14 & 2     & 2     & 0     & 1     & 0     & 1     & 2     & 2     & 0     & 0     & 1     & $-$1    & 0     & 0     & 0     & 3     & 0     & 3 \\
    2014/15 & 1     & 2     & $-$1    & 1     & 1     & 0     & 2     & 2     & 0     & 0     & 1     & $-$1    & 1     & 0     & 1     & 3     & 0     & 3 \\
    2015/16 & 2     & 1     & 1     & 0     & 1     & $-$1    & 2     & 0     & 2     & 0     & 2     & $-$2    & 0     & 1     & $-$1    & 3     & 0     & 3 \\
    2016/17 & 2     & 1     & 1     & 1     & 1     & 0     & 1     & 2     & $-$1    & 2     & 0     & 2     & 0     & 2     & $-$2    & 2     & 2     & 0 \\
    2017/18 & 4     & 1     & 3     & 1     & 0     & 1     & 0     & 1     & $-$1    & 1     & 1     & 0     & 0     & 1     & $-$1    & 1     & 2     & $-$1 \\
    2018/19 & 1     & 3     & $-$2    & 1     & 1     & 0     & 2     & 1     & 1     & 1     & 1     & 0     & 1     & 0     & 1     & 2     & 1     & 1 \\
    2019/20 & 2     & 2     & 0     & 1     & 1     & 0     & 2     & 1     & 1     & 1     & 2     & $-$1    & 0     & 0     & 0     & 2     & 2     & 0 \\
    2020/21 & 3     & 0     & 3     & 1     & 0     & 1     & 2     & 2     & 0     & 1     & 2     & $-$1    & 0     & 1     & $-$1    & 1     & 3     & $-$2 \\
    2021/22 & 3     & 1     & 2     & 1     & 1     & 0     & 1     & 0     & 1     & 1     & 1     & 0     & 0     & 2     & $-$2    & 1     & 2     & $-$1 \\
    2022/23 & 3     & 1     & 2     & 0     & 1     & $-$1    & 1     & 3     & $-$2    & 1     & 2     & $-$1    & 2     & 0     & 2     & 1     & 0     & 1 \\
    2023/24 & 2     & 0     & 2     & 0     & 1     & $-$1    & 2     & 1     & 1     & 0     & 3     & $-$3    & 0     & 1     & $-$1    & 4     & 0     & 4 \\ \toprule
    Average & \multicolumn{3}{c}{1.19} & \multicolumn{3}{c}{0} & \multicolumn{3}{c}{0.05} & \multicolumn{3}{c}{$-$0.19} & \multicolumn{3}{c}{$-$0.38} & \multicolumn{3}{c}{0.67} \\ \bottomrule
	\end{tabularx}
\begin{tablenotes} \footnotesize
\item
\emph{Notes}: Column 1 shows the number of group winners; Column 2 shows the number of runners-up; Column $\Delta$ shows the difference between the number of group winners and runners-up.
\item
The last row shows the average of Column $\Delta$ for each country.
\item
The number of exclusions for any national association equals the number of group winners times the number of runners-up. The only exception is the 2005/06 season when Chelsea and Liverpool both qualified from Group G, thus, the number of constraints due to England is one rather than two. In addition, a Russian group winner could not have played against a Ukrainian runner-up in 2015/16.
\end{tablenotes}
\end{threeparttable}
}
\end{table}

However, this nice symmetry disappears in the UEFA Champions League, where the two sides are given by the group winners and the runner-up, and the type constraints are implied by the national associations of the clubs.
According to Table~\ref{Table4}, six leagues have had more than one club qualified for the Round of 16 in at least one year between 2003/04 and 2023/24. Due to England and, to a lesser extent, Spain, there are usually more group winners in these countries than runners-up. Consequently, the set $U$ is more likely to correspond to the runners-up when, on the basis of Figure~\ref{Fig9a}, the Standard Drop procedure is better, that is, the draw needs to start on the side of the runners-up.

\begin{result} \label{Result2}
For the graphs corresponding to the historical draws of the UEFA Champions League Round of 16, the official UEFA draw mechanism is expected to be fairer than its variant that draws the group winners first.
\end{result}

Result~\ref{Result2} can be illustrated by the finding that the cumulated $\mathit{MFD}$ ($\mathit{AFD}$) over the 21 seasons is smaller by 10.9\% (3.3\%) under the official mechanism than under its version where the group winners are drawn first.

According to Results~\ref{Result1} and \ref{Result2}, UEFA has chosen the best randomisation procedure among the four field-proven alternatives. This substantially refines the main result of \citet{BoczonWilson2023} about the near-optimality of the official UEFA draw mechanism, which is not only closely fair but also outperforms all reasonable field-proven variants. Naturally, previous studies \citep{BoczonWilson2023, KlossnerBecker2013} have not identified the advantage of the Drop mechanism over the Skip mechanism since not considering the latter, while both \citep[Footnote~33]{BoczonWilson2023} and \citet[Footnote~19]{KlossnerBecker2013} suggest that the difference between the Standard and Reversed Drop mechanisms is slight and uninteresting.

\subsection{Graphs with highly concentrated constraints} \label{Sec56}

The Reversed Drop mechanism is the most unfair among the historical Champions League seasons in 2017/18, when the difference between the Standard and Reversed forms is the highest, too. The associated bipartite graph is $I_1$ in Figure~\ref{Fig3}. We have created seven further graphs having a similar structure, which are also shown in Figure~\ref{Fig3}. All of them contain at least one node with four (except for $I_3$) or two nodes with three ($I_3$) type constraints.

\input{Figure10_high_unfairness}

As can be seen in Figure~\ref{Fig10}, the draw mechanisms are relatively unfair for these instances. The maximal error is above 4 for three graphs, $I_2$, $I_4$, and $I_5$.

\input{Table5_fairness_distortion_heatmap_graph_I_4}

Table~\ref{Table5} presents the distortions for graph $I_4$, which coincide for the Standard and Reversed variants of the two main mechanisms since the sets $U$ and $V$ are exchangeable.
The implied $\mathit{MFD}$ is worrying because the nodes with five restrictions have three possible nodes to be assigned to them, thus, every reasonable assignment rule should match these two nodes with at least a probability of $1/3$. Consequently, a na\"ive upper bound of maximal fairness distortion is $61.76 - 33.33 \approx 28.4$(\%), and the Drop mechanism is unable to reduce this value by more than 71\%. Furthermore, the value of $\mathit{MFD}$ exceeds the worst maximal fairness distortion for all graphs considered in Section~\ref{Sec52} (see Figure~\ref{Fig5}), that is, the Round of 16 draw can be less fair than a potential draw of quarterfinals under the same rules.

\begin{observation} \label{Obs3}
The Drop mechanism does not come quantitatively close to the best possible lottery for certain bipartite graphs, which represent possible UEFA Champions League seasons and have some nodes with a high number of type constraints on both sides.
\end{observation}

Observation~\ref{Obs3} somewhat contradicts \citet[Result~3]{BoczonWilson2023} that the Drop procedure continues to be close to a constrained-best if (i) the number of constraints; (ii) the likely location of the constraints in the graph; and (iii) the number of nodes in the graph is shifted. The explanation is straightforward: randomly creating the set of exclusions will result in a graph similar to $I_2$, $I_4$, or $I_5$ with only a small probability, and averaging the biases over hundreds of such instances covers the poor performance for some particular graphs.

Figure~\ref{Fig10} reinforces the message of Section~\ref{Sec55}.
First, the Drop mechanism is clearly fairer compared to the Skip mechanism, it has a lower absolute fairness distortion by about 30--40\% for our balanced bipartite graphs with 16 nodes. In addition, the draw order has a more moderated impact on the Skip mechanism.
Second, the two versions of the Drop mechanism can substantially differ from each other, the distortion of the Reversed Drop mechanism is smaller by at least 17\% for the three ``unfavourable'' graphs of $I_1$, $I_2$, and $I_5$. Furthermore, the $\mathit{MFD}$ of the Standard Drop mechanism is above 3.2(\%) for graph $I_6$ but remains below 2(\%) under the Reversed Drop, implying a decrease of over 40\%.

\begin{observation} \label{Obs4}
The draw order of the Drop mechanism sometimes has a non-negligible effect on the level of unfairness.
\end{observation}

According to \citet[Footnote~19]{KlossnerBecker2013}, the probabilities of the UEFA procedure would change \emph{slightly} if group winners were drawn first and only then matched with suitable runners-up. Observation~\ref{Obs4} shows that it is a rough conclusion and may be true only for the Skip mechanism.

Last but not least, Tables~\ref{Table3} and \ref{Table5} imply suggest a general pattern that is reinforced by a thorough study of distortions.

\begin{observation} \label{Obs5}
The for draw mechanisms (Standard/Reversed Drop, Standard/Reversed Skip) do no fundamentally differ in the sense that they usually change the probabilities under the Uniform draw in the same direction and roughly with the same magnitude.
\end{observation}

It requires further research whether Observation~\ref{Obs5} holds for other randomisation procedures or not.

\section{Conclusions} \label{Sec6}

Our paper has compared the basic randomisation procedures used in sports competitions to divide some teams into groups in the presence of draw constraints. Since uniform distribution over all valid assignments should be sacrificed for the sake of transparency, it is crucial to know which variant (Standard or Reversed) of what mechanism (Drop or Skip) performs the best in a given setting. Therefore, we have evaluated their unfairness for selected sets of balanced bipartite graphs with two kinds of restrictions. According to our results, the UEFA Champions League Round of 16 draw has adopted the least unfair transparent field-proven algorithm. On the other hand,
(1) this is not the optimal choice in every setting, for instance, for a draw of quarterfinals under the same rules; and
(2) there remains a non-negligible scope to find fairer randomisation procedures, especially since they tend to distort the probabilities in the same direction and roughly with the same magnitude.

There are several promising directions for future research. First, the reason for the difference between the Drop and Skip mechanisms has not been fully explored, although the difficulty of the problem has hopefully been highlighted. Second, these draw procedures are worth analysing in further cases. The advantage of the Drop mechanism in bipartite graphs suggests that it might be a competitive option for the FIFA World Cup draw---however, having groups with more than two teams increases the complexity of the potential constraints.
Last but not least, in contrast to \citet{BoczonWilson2023}, we think tournament organisers should continue the quest for fairer but transparent lotteries since all previous proposals \citep{Guyon2014a, KlossnerBecker2013, RobertsRosenthal2024} have different weaknesses.

\section*{Acknowledgements}
\addcontentsline{toc}{section}{Acknowledgements}
\noindent
This paper could not have been written without my \emph{father} (also called \emph{L\'aszl\'o Csat\'o}), who has helped to code the simulations in Python. \\
%We are grateful to \emph{Dries Goossens}, \emph{Alex Krumer}, \emph{Frits C.~R.~Spieksma}, and \emph{Stephan Westphal} for useful advice. \\
Eight anonymous colleagues and \emph{Ilia Tsetlin} have provided valuable comments and suggestions on earlier drafts. \\
The research was supported by the National Research, Development and Innovation Office under Grant FK 145838 and the J\'anos Bolyai Research Scholarship of the Hungarian Academy of Sciences.

\bibliographystyle{apalike}
\bibliography{All_references}

\end{document}