%\begin{proof}
  We show a stronger statement of the form:

  Let $(t,s) \red[\gname] (u,q)$. If $\Phi \tr \seqi{\Gam}{(t,s)}{\ctype}{(b,m,d)}$, $\Gam$ is tight,  and ($\ctype$ is tight or $\neg \isvalue{t}$), then $\Phi' \tr \seqi{\Gam}{(u,q)}{\ctype}{(b',m',d)}$, where $\gname =\beta$ implies $b' = b - 1$ and $m' = m$, while  $\gname \in \{\getname, \setname\}$ implies $b'=b$ and $m' = m - 1$.

  We proceed by induction on $(t,s) \ra (u,q)$: 
  \begin{itemize}
    \item Case $(t,s) = ((\lam x.p) v,s) \redbeta (p \subs{x}{v}, s) = (u,q)$. Let $\Phi_{(\lam x.p) v}$ be the sub-derivation for $(\lam x.p) v$ in $\Phi$. Assume that $\Phi_{(\lam x.p)v}$ ends with rule (\ruleAppPTwo). Then $v$ must be assigned type $\comptype{\stype}{\tneutral \tim \stype}$, which is not possible by~\cref{lem:comp-values-not-neutral}. Let $\Phi_0$ be the following derivation:
    \[ \begin{prooftree}
      \hypo{\Phi_p \tr \seqi{\Gam_{\lam x.p}; x : \M}{p}{\comptype{\stype}{\ctype}}{(b_p,m_p,d_p)}}
        \infer1[(\ruleLam)]{\seqi{\Gam_{\lam x.p}}{\lam x.p}{\M \ta (\comptype{\stype}{\ctype})}{(b_p,m_p,d_p)}}
        \hypo{\Phi_v \tr \seqi{\Gam_v}{v}{\M}{(b_v,m_v,d_v)}}
        \infer1[(\ruleLift)]{\seqi{\Gam_v}{v}{\tcomptype{\stype}{\M}{\stype}}{(b_v,m_v,d_v)}}
        \infer2[(\ruleApp)]{\seqi{\Gam_{\lam x.p}+\Gam_v}{(\lam x.p)v}{\comptype{\stype}{\ctype}}{(1+b_v+b_p,m_v+m_p,d_v+d_p)}}
    \end{prooftree} \]
    $\Phi_{(\lam x.p) v}$ must end with rule ($\ruleApp$) and $\Phi$ must be of the following form:
    \[ \begin{prooftree}
        \hypo{\Phi_0}
        \hypo{\Phi_s \tr \seqi{\Del}{s}{\stype}{(b_s,m_s,d_s)}}
        \infer2[(\ruleConf)]{\seqi{\Gam_{\lam x.p}+ \Gam_v + \Del}{((\lam x.p)v, s)}{\ctype}{(1+b_v+b_p+b_s,m_v+m_p+m_s,d_v+d_p+d_s)}}
    \end{prooftree} \]
    where  $\Gam = \Gam_{\lam x.p}+ \Gam_v + \Del$,  $b = 1+ b_v + b_p + b_s$, $m = m_v + m_p + m_s$, and $d = d_v + d_p + d_s$. By~\cref{lem:comp-subs-antisubs}.\ref{lem:comp-subs}, there exists $\Phi_{p \subs{x}{v}} \tr \seqi{\Gam_{\lam x.p} +\Gam_v}{p \subs{x}{v}}{\comptype{\stype}{\ctype}}{(b_v+b_p,m_v+m_p,d_v+d_p)}$, therefore we can build $\Phi_{(p\subs{x}{v},s)}$ as follows:
    \[ \begin{prooftree}
        \hypo{\Phi_{p \subs{x}{v}} \tr \seqi{\Gam_{\lam x.p}+\Gam_v}{p \subs{x}{v}}{\comptype{\stype}{\ctype}}{(b_v+b_p,m_v+m_p,d_v+d_p)}}
        \hypo{\Phi_s \tr \seqi{\Del}{s}{\stype}{(b_s,m_s,d_s)}}
        \infer2[(\ruleConf)]{\seqi{\Gam_{\lam x.p} + \Gam_v + \Del}{(p \subs{x}{v}, s)}{\ctype}{(b_v+b_p+b_s,m_v+m_p+m_s,d_v+d_p+d_s)}}
    \end{prooftree} \]
    We can finally conclude since the first counter is equal to $b-1$, while the second and third remain the same.
  \item Case $(t,s) = (vp,s) \ra (vp',q) = (u,q)$, such that $(p,s) \ra (p',q)$. Then we have three cases for the type derivation $\Phi_p$ of $p$ inside $\Phi$: 
    \begin{itemize}
      \item Case $\Phi_p$ ends with ($\ruleApp$). Let $\Phi_0$ be the following derivation:
      \[ \begin{prooftree}
        \hypo{\Phi_v \tr \seqi{\Gam_v}{v}{\M \ta (\comptype{\stype'}{\ctype})}{(b_v,m_v,d_v)}}
            \hypo{\Phi_p \tr \seqi{\Gam_p}{p}{\tcomptype{\stype}{\M}{\stype'}}{(b_p,m_p,d_p)}}
            \infer2[(\ruleApp)]{\seqi{\Gam_v + \Gam_p}{vp}{\comptype{\stype}{\ctype}}{(1+b_v+b_p,m_v+m_p,d_v+d_p)}}
      \end{prooftree} \]
      $\Phi$ must be of the following form:
        \[ \begin{prooftree}
            \hypo{\Phi_0}
            \hypo{\Phi_s \tr \seqi{\Del}{s}{\stype}{(b_s,m_s,d_s)}}
            \infer2[(\ruleConf)]{\seqi{\Gam_v + \Gam_p + \Del}{(vp, s)}{\kappa}{(1+b_v+b_p+b_s,m_v+m_p+m_s,d_v+d_p+d_s)}}
        \end{prooftree} \]
        where $\Gam = \Gam_v + \Gam_p + \Del$ is tight, $b = 1+b_v+b_p+b_s$, $m = m_v+m_p+m_s$, and $s = d_v+d_p+d_s$. Therefore, we can build the following derivation for $(p,s)$:
        \[ \begin{prooftree}
            \hypo{\Phi_p \tr \seqi{\Gam_p}{p}{\tcomptype{\stype}{\M}{\stype'}}{(b_p,m_p,d_p)}}
            \hypo{\Phi_s \tr \seqi{\Del}{s}{\stype}{(b_s,m_s,d_s)}}
            \infer2[(\ruleConf)]{\seqi{\Gam_p + \Del}{(p,s)}{\conftype{\M}{\stype'}}{(b_p+b_s,m_p+m_s,d_p+d_s)}}
        \end{prooftree} \]
        Since $\Gam$ is tight, then $\Gam_p + \Del$ is tight. Moreover, $(p,s) \ra (p',q)$ implies that $\neg \isvalue{p}$. Then we can apply the \ih, and thus there exists a derivation for $(p',q)$ that must be of the following form:
        \[ \begin{prooftree}
            \hypo{\Phi_{p'} \tr \seqi{\Gam_{p'}}{p'}{\tcomptype{\stype''}{\M}{\stype'}}{(b_{p'},m_{p'},d_{p'})}}
            \hypo{\Phi_q \tr \seqi{\Del_q}{q}{\stype''}{(b_q,m_q,d_q)}}
            \infer2[(\ruleConf)]{\seqi{\Gam_{p'} + \Del_q}{(p',q)}{\conftype{\M}{\stype'}}{(b_{p'}+b_q,m_{p'}+m_q,d_{p'}+d_q)}}
        \end{prooftree} \]
        where $\Gam_{p'} + \Del_q = \Gam_p + \Del$ is tight,  and the counters are related properly. Let $\Phi_0$ be the following derivation:
        \[ \begin{prooftree}
          \hypo{\Phi_v \tr \seqi{\Gam_v}{v}{\M \ta \comptype{\stype'}{\ctype'}}{(b_v,m_v,d_v)}}
            \hypo{\Phi_{p'} \tr \seqi{\Gam_{p'}}{p'}{\tcomptype{\stype''}{\M}{\stype'}}{(b_{p'},m_{p'},d_{p'})}}
            \infer2[(\ruleApp)]{\seqi{\Gam_v+\Gam_{p'}}{vp'}{\comptype{\stype''}{\ctype'}}{(1+b_v+b_{p'},m_v+m_{p'},d_v+d_{p'})}}
        \end{prooftree} \]
        We can build $\Phi_{(u,q)}$ as follows:
        \[ \begin{prooftree}
            \hypo{\Phi_0}
            \hypo{\Phi_q \tr \seqi{\Del_q}{q}{\stype''}{(b_q,m_q,d_q)}}
            \infer2[(\ruleConf)]{\seqi{\Gam_v + \Gam_{p'} + \Del_q}{(vp', q)}{\ctype'}{(1+b_v+b_{p'}+b_q,m_v+m_{p'}+m_q,d_v+d_{p'}+d_q)}}
        \end{prooftree} \]
        where $\Gam_{p'} + \Gam_v + \Del_q = \Gam_v + \Gam_p + \Del = \Gam$, $b' = 1+b_v+b_{p'}+b_q$, $m' = m_v+m_{p'}+m_q$, and $d' = d_v+d_{p'}+d_q$. We can conclude since the counters are related properly according to the \ih.  
        \item Case $\Phi_p$ ends with (\ruleAppPOne) or (\ruleAppPTwo). These two cases are very similar to the previous case.
      \end{itemize}
      \item Case $(t,s) = (\get{l}{x}{p},s) \ra (p \subs{x}{v},s) = (u,q)$, where $s \equivstate \upd{l}{v}{s'}$. Let $\Phi_0$ be the following derivation:
      \[ \begin{prooftree}
        \hypo{\Phi_{p} \tr \seqi{\Gam_{p}}{p}{\comptype{\stype}{\ctype}}{(b_p,m_p,d_p)}}
        \infer1[(\ruleGet)]{\seqi{\Gam_{p} \sm x}{\get{l}{x}{p}}{\comptype{\conj{(l : \Gam_{p}(x))} \splus \stype}{\ctype}}{(b_p,1+m_p,d_p)}}
      \end{prooftree} \]
      $\Phi$ must be of the following form:
        \[ \begin{prooftree}
        \hypo{\Phi_0}
          \hypo{\Phi_{s} \tr \seqi{\Del}{s}{\conj{(l : \Gam_{p}(x))} \splus  \stype}{(b_s,m_s,d_s)}}
          \infer2[(\ruleConf)]{\seqi{(\Gam_{p} \sm x) + \Del}{(\get{l}{x}{p}, s)}{\kap}{(b_p+b_s,1+m_p+m_s,d_p+d_s)}}
        \end{prooftree} \] 
        where $\Gam = (\Gam_{p} \sm x) + \Del$ is tight, $b = b_p + b_s$, $m = 1+ m_p + m_s$, and  $d = d_p + d_s$. Since $\Phi_{s} \tr \seqi{\Del}{s}{\conj{(l : \Gam_{p}(x))} \splus \stype}{(b_s,m_s,d_s)}$, then~\cref{lem:split-values-stores}.\ref{lem:split-state} gives $s \equivstate \upd{l}{v_0}{s'_0}$, but we necessarily have $v_0 = v$ and $s'_0 = s'$. Moreover, the lemma also gives $\Phi_v \tr \seqi{\Del_v}{v}{\Gam_{p}(x) \sqcup \stype(l)}{(b_v,m_v,d_v)}$ and $\Phi_{s'} \tr \seqi{\Del_{s'}}{s'}{\stype'}{(b_{s'},m_{s'},d_{s'})}$, where $\conj{(l : \Gam_{p}(x))} \splus \stype = \conj{(l : \Gam_{p}(x) \sqcup \stype(l))};\stype'$, $\Del = \Del_v + \Del_{s'}$, $b_s=b_v + b_{s'}$, $m_s=m_v + m_{s'}$, and $d_s=d_v + d_{s'}$. Thus, by~\cref{lem:split-values-stores}.\ref{lem:com-split-values} there exist $\Phi^1_v \tr \seqi{\Del^1_v}{v}{\Gam_{p}(x)}{(b^1_v,m^1_v,d^1_v)}$ and $\Phi^2_v \tr \seqi{\Del^2_v}{v}{\stype(l)}{(b^2_v,m^2_v,d^2_v)}$, such that $\Del_v = \Del^1_v + \Del^2_v$, $b_v = b^1_v+b^2_v$, $m_v = m^1_v+m^2_v$, and $d_v = d^1_v+d^2_v$. From $\Phi_{p} \tr \seqi{\Gam_{p}}{p}{\comptype{\stype}{\ctype}}{(b_p,m_p,d_p)}$ and $\Phi^1_v \tr \seqi{\Del^1_v}{v}{\Gam_{p}(x)}{(b^1_v,m^1_v,d^1_v)}$, we obtain $\Phi_{p \subs{x}{v}} \tr \seqi{(\Gam_{p} \sm x) +\Del^1_v}{p\subs{x}{v}}{\comptype{\stype}{\ctype}}{(b_p+b^1_v,m_p+m^1_v,d_p+d^1_v)}$, by~\cref{lem:comp-subs-antisubs}.\ref{lem:comp-subs}. We now construct an alternative type derivation for $s$ of the form:
        \[ \begin{prooftree}
            \hypo{\Phi^2_v \tr  \seqi{\Del^2_v}{v}{\stype(l)}{(b^2_v,m^2_v,d^2_v)}}
            \hypo{\Phi_{s'} \tr \seqi{\Del_{s'}}{s'}{\stype'}{(b_{s'},m_{s'},d_{s'})}}
            \infer2[(\ruleUpd)]{\seqi{\Del^2_v+ \Del_{s'}}{\upd{l}{v}{s'}}{\conj{(l:\stype(l))};\stype'}{(b^2_v+b_{s'},m^2_v+m_{s'},d^2_v+d_{s'})}}
        \end{prooftree} \]
        Let $q = s= \upd{l}{v}{s'}$ and let $\Phi_q$ be this new derivation above. Notice also that $\stype = \conj{(l:\stype(l))}; \stype'$. Then we can construct $\Phi'$ as follows:
        \[ \begin{prooftree}
            \hypo{\Phi_{p\subs{x}{v}}}
            \hypo{\Phi_q}
            \infer2[(\ruleConf)]{\seqi{(\Gam_{p} \sm x) + \Del^1_v + \Del^2_v + \Del_{s'}}{(p \subs{x}{v}, s)}{\kap}{(b,m,d)}}
        \end{prooftree} \]
        Notice that the type environment of the conclusion is $(\Gam_{p} \sm x) + \Del^1_v + \Del^2_v + \Del_{s'} = (\Gam_{p} \sm x) + \Del_v + \Del_{s'} = (\Gam_{p} \sm x) + \Del = \Gam $, and the counters are as expected.
        \item Case $(t,s) = (\set{l}{v}{p},s) \ra (p, \upd{l}{v}{s}) = (u,q)$. Let $\Phi_0$ be the following derivation:
        \[ \begin{prooftree}
          \hypo{\Phi_{v} \tr \seqi{\Gam_v}{v}{\M}{(b_v,m_v,d_v)}}
            \hypo{\Phi_{p} \tr \seqi{\Gam_{p}}{p}{\comptype{\conj{(l : \M)}; \stype}{\ctype}}{(b_p,m_p,d_p)}}
            \infer2[(\ruleSet)]{\seqi{\Gam_v + \Gam_{p}}{\set{l}{v}{p}}{\comptype{\stype}{\ctype}}{(b_v+b_p,1+m_v+m_p,s_v+s_p)}}
        \end{prooftree} \]
        $\Phi$ must be of the following form:
        \[ \begin{prooftree}
          \hypo{\Phi_0}    
            \hypo{\Phi_{s} \tr \seqi{\Gam_{s}}{s}{\stype}{(b_s,m_s,d_s)}}
            \infer2[(\ruleConf)]{\seqi{(\Gam_v + \Gam_{p}) + \Gam_{s}}{(\set{l}{v}{p}, s)}{\kap}{(b_v+b_p+b_s,1+m_v+m_p+m_s,d_v+d_p+d_s)}}
        \end{prooftree} \]
        where  $\Gam = (\Gam_v + \Gam_{p}) + \Gam_{s}$ is tight, $b = b_v+b_p+b_s$, $m=1+m_v+m_p+m_s$ and $d=d_v+d_p+d_s$. Therefore, we can build $\Phi_{\upd{l}{v}{s}}$ as follows:
        \[ \begin{prooftree}
          \hypo{\Phi_{v} \tr \seqi{\Gam_v}{v}{\M}{(b_v,m_v,d_v)}}
          \hypo{\Phi_{s} \tr \seqi{\Gam_{s}}{s}{\stype}{(b_s,m_s,d_s)}}
          \infer2[(\ruleUpd)]{\seqi{\Gam_v + \Gam_{s}}{\upd{l}{v}{s}}{\conj{(l : \M)}; \stype}{(b_v+b_s,m_v+m_s,d_v+d_s)}}
        \end{prooftree} \]
        Assume And we can build $\Phi'$ as follows:
        \[ \begin{prooftree}
            \hypo{\Phi_{p} \tr \seqi{\Gam_{p}}{p}{\comptype{\conj{(l : \M)}; \stype}{\ctype}}{(b_p,m_p,d_p)}}
            \hypo{\Phi_{\upd{l}{v}{s}}}
            \infer2[(\ruleConf)]{\seqi{\Gam_{p} + (\Gam_v + \Gam_{s})}{(p, \upd{l}{v}{s})}{\kap}{(b_v+b_v+b_s,m_v+m_v+m_s,d_v+d_v+d_s)}}
        \end{prooftree} \]
        Notice that the type environment of the conclusion is $\Gam_{p} + (\Gam_v + \Gam_{s}) = \Gam$, and the counters are as expected.
    \end{itemize}
%\end{proof}
