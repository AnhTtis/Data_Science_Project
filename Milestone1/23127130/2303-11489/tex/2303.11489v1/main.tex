%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%2345678901234567890123456789012345678901234567890123456789012345678901234567890
%        1         2         3         4         5         6         7         8

\documentclass[letterpaper,10pt, journal,twoside]{IEEEtran}  % Comment this line out if you need a4paper

%\documentclass[a4paper, 10pt, conference]{ieeeconf}      % Use this line for a4 paper

\IEEEoverridecommandlockouts                              % This command is only needed if 
% you want to use the \thanks command

%\overrideIEEEmargins                                      % Needed to meet printer requirements.

% See the \addtolength command later in the file to balance the column lengths
% on the last page of the document

\usepackage{amsmath,amssymb,color,cite}%,showkeys}
% The following packages can be found on http:\\www.ctan.org
%\usepackage{graphics} % for pdf, bitmapped graphics files
%\usepackage{epsfig} % for postscript graphics files
%\usepackage{mathptmx} % assumes new font selection scheme installed
%\usepackage{times} % assumes new font selection scheme installed
%\usepackage{amsmath} % assumes amsmath package installed
%\usepackage{amssymb}  % assumes amsmath package installed
\usepackage{graphicx}
\usepackage{subfigure}

\usepackage{latexsym}
\usepackage{algorithm}
\usepackage{algpseudocode}


\makeatletter
\algnewcommand{\LineComment}[1]{\Statex \hfill \(\triangleright\) #1}
\makeatother

\usepackage{verbatim}
\usepackage{cite}
%\usepackage{showkeys}
\usepackage[english]{babel}
%\usepackage[latin1]{inputenc}
%\usepackage{enumerate}
%\usepackage[intlimits]{amsmath}
\usepackage{amsmath,amsthm}

%% Enumerate environment
\renewcommand{\theenumi}{(\roman{enumi})}
\renewcommand{\labelenumi}{\theenumi}


\usepackage{pgf}
\usepackage{pgfplots,tikz}
\usetikzlibrary{tikzmark}
\usepackage[font=footnotesize]{caption}
%\usepackage{subcaption}
\usepackage{arydshln}

\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsbsy}
\usepackage{bm}
\usepackage{bbm}

\newcommand{\marginJC}[1]{\marginpar{\color{red}\tiny\ttfamily#1}}
\newcommand{\marginJE}[1]{\marginpar{\color{blue}\tiny\ttfamily#1}}
\newcommand{\marginSL}[1]{\marginpar{\color{magenta}\tiny\ttfamily#1}}
\newcommand{\margin}[1]{\marginpar{\color{orange}\tiny\ttfamily#1}}


\renewcommand{\algorithmicrequire}{\textbf{Input: }}
\renewcommand{\algorithmicensure}{\textbf{Output: }}

\DeclareMathOperator{\len}{length}
\DeclareMathOperator{\bcard}{bcard}
\DeclareMathOperator{\rbcard}{rbcard}
\DeclareMathOperator{\cbcard}{cbcard}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\col}{col}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\bdiag}{blockdiag}
\DeclareMathOperator{\spn}{span}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\trace}{tr}
\DeclareMathOperator{\card}{card}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\inte}{int}
\DeclareMathOperator{\clo}{cl}
\DeclareMathOperator{\rint}{rint}
\DeclareMathOperator{\conv}{conv}
\DeclareMathOperator{\cone}{cone}
\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\graph}{gr}
\DeclareMathOperator{\dis}{dis}
\DeclareMathOperator{\Real}{Re}
\DeclareMathOperator{\Imag}{Im}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

\newcommand{\abs}[1]{\ensuremath{| #1 |}}
\newcommand{\norm}[1]{\ensuremath{\| #1 \|}}

% Procend
\newcommand\oprocendsymbol{\hbox{$\bullet$}}
\newcommand\oprocend{\relax\ifmmode\else\unskip\hfill\fi\oprocendsymbol}
\def\eqoprocend{\tag*{$\bullet$}}

\let\leq\leqslant
\let\geq\geqslant
\let\emptyset\varnothing

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\R}{\mathbb R}
\newcommand{\N}{\mathbb N}
\newcommand{\bT}{\mathbb T}
%     \calA
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\calA}{\ensuremath{\mathcal{A}}}
\newcommand{\calB}{\ensuremath{\mathcal{B}}}
\newcommand{\calC}{\ensuremath{\mathcal{C}}}
\newcommand{\calD}{\ensuremath{\mathcal{D}}}
\newcommand{\calE}{\ensuremath{\mathcal{E}}}
\newcommand{\calF}{\ensuremath{\mathcal{F}}}
\newcommand{\calG}{\ensuremath{\mathcal{G}}}
\newcommand{\calH}{\ensuremath{\mathcal{H}}}
\newcommand{\calI}{\ensuremath{\mathcal{I}}}
\newcommand{\calJ}{\ensuremath{\mathcal{J}}}
\newcommand{\calK}{\ensuremath{\mathcal{K}}}
\newcommand{\calL}{\ensuremath{\mathcal{L}}}
\newcommand{\calM}{\ensuremath{\mathcal{M}}}
\newcommand{\calN}{\ensuremath{\mathcal{N}}}
\newcommand{\calO}{\ensuremath{\mathcal{O}}}
\newcommand{\calP}{\ensuremath{\mathcal{P}}}
\newcommand{\calQ}{\ensuremath{\mathcal{Q}}}
\newcommand{\calR}{\ensuremath{\mathcal{R}}}
\newcommand{\calS}{\ensuremath{\mathcal{S}}}
\newcommand{\calT}{\ensuremath{\mathcal{T}}}
\newcommand{\calU}{\ensuremath{\mathcal{U}}}
\newcommand{\calV}{\ensuremath{\mathcal{V}}}
\newcommand{\calW}{\ensuremath{\mathcal{W}}}
\newcommand{\calX}{\ensuremath{\mathcal{X}}}
\newcommand{\calY}{\ensuremath{\mathcal{Y}}}
\newcommand{\calZ}{\ensuremath{\mathcal{Z}}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


 \newcounter{todocounter}
 \setcounter{todocounter}{-1}

 \usepackage[colorinlistoftodos]{todonotes}
 \newcommand{\todoinr}[2][]{\stepcounter{todocounter}\todo[prepend,inline,color=red!40, linecolor=orange!250,caption={{\bf \thetodocounter}}]{\begin{minipage}{\textwidth-10pt} \small#2\end{minipage}}}
% \newcommand{\todoinyc}[2][]{\stepcounter{todocounter}\todo[prepend,inline,color=yellow!40, linecolor=orange!250,caption={{ \thetodocounter}}]{\begin{minipage}{\textwidth-10pt} \small#2\end{minipage}}}

% \newcommand{\todoinb}[2][]{\stepcounter{todocounter}\todo[inline,color=black!20, linecolor=orange!250,caption={}]{\begin{minipage}{\textwidth-10pt} \small#2\end{minipage}}}

% \newcommand{\todoiny}[1]{\todo[inline,color=yellow!40, linecolor=orange!250,caption={}]{\begin{minipage}{\textwidth-10pt} \small#1\end{minipage}}}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}

\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}

\theoremstyle{definition}
\newtheorem{assumption}{Assumption}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}{Example}
\newtheorem{problem}{Problem}

%\renewcommand{\baselinestretch}{0.99}
\allowdisplaybreaks

\title{Data-driven mode detection and stabilization of unknown
  switched linear systems\thanks{A preliminary version of this work
    appeared as~\cite{JE-SL-SM-JC:22-cdc} at the IEEE Conference on
    Decision and Control.}}

\author{Jaap Eising${}^*$ \quad Shenyu Liu${}^*$ \quad Sonia
  Mart\'{\i}nez \quad Jorge Cort\'{e}s\thanks{${}^*$Both authors
    contributed equally. Jaap Eising, Sonia Mart\'{\i}nez, and Jorge
    Cort\'{e}s are with the Department of Mechanical and Aerospace
    Engineering, University of California, San Diego,
    \texttt{\{jeising,soniamd,cortes\}@ucsd.edu}. Shenyu Liu is with
    the School of Automation, Beijing Institute of Technology, China,
    \texttt{shenyuliu@bit.edu.cn}.} }

\begin{document}

\maketitle
	
\begin{abstract}
  This paper considers the stabilization of unknown switched linear
  systems using data.  Instead of a full system model, we have access
  to a finite number of trajectories of each of the different modes
  prior to the online operation of the system.  On the basis of
  informative enough measurements, formally characterized in terms of
  linear matrix inequalities, we design an online switched controller
  that alternates between a mode detection phase and a stabilization
  phase.  Since the specific currently-active mode is unknown, the
  controller employs the most recent online measurements to determine
  it by implementing computationally efficient tests that check
  compatibility with the set of systems consistent with the
  pre-collected measurements.  The stabilization phase applies the
  stabilizing feedback gain corresponding to the identified active
  mode and monitors the evolution of the associated Lyapunov function
  to detect switches. When a switch is detected, the controller
  returns to the mode-detection phase.  Under average dwell- and
  activation-time assumptions on the switching signal, we show that
  the proposed controller guarantees an input-to-state-like stability
  property of the closed-loop switched system. Various simulations illustrate
  our results.
\end{abstract}
% Lack of need to identify modes is attractive (we still need to
% detect it)

% Data informativity for specific task -- e.g., informativity tailored
% to specific goal.

% Made more challenging by the fact that, in switched system, we do
% not know what specific mode is generating the data.

\section{Introduction}
Switched linear systems have long been of interest to the systems and
control community. Such systems consist of several modes and a logic
rule which governs the switching between them.  Many real-world
applications are naturally modeled as switched systems, where the
plant switches modes due to design specifications, recurrent
environmental effects, human behavior, or a combination of
thereof. From a dynamic perspective, switched linear systems exhibit
far more complex behavior than linear systems and this makes
the design of stabilizing controllers and their analysis challenging.
Most design approaches build on the model-based paradigm, where a
model of the system and each of its modes is available to solve the
stabilization problem.  In practice, this often requires considerable
modeling effort through system identification.  Motivated by these
observations, we adopt an online approach based on data
informativity to synthesize a controller that jointly deals with the
(partial) identification and (robust) stabilization of the unknown switched
system.

\emph{Literature review:} The control of switched systems is a
well-studied field, the complexity of which requires a wide range of
stabilization and analysis techniques, see
e.g.,~\cite{DL:03,HL-PJA:09}. These include system matrix-based
methods~\cite{DC-LG-YL-YW:05,YS:11switched}, common Lyapunov
functions~\cite{MH-FF-GD:13,DZ-LA-JD-QZ:18}, or methods based on
multiple Lyapunov functions~\cite{MSB:98,JG-PC:06,PC-JG-AA:08}, to
name a few. One relevant benefit of Lyapunov-based methods is that
they provide simple criteria to detect unknown switches, as inspired
by e.g.,~the literature on fault
detection~\cite{MTR-AQK-GM-MA:16,LL-SXD-YN-JQ:22} or state
estimation~\cite{XZ-HL-JZ-HL:15} of switched systems.  These works
usually require a precise model of the modes of the switched
system. In order to address uncertainties in the model, several works
have employed robust and adaptive techniques for stabilization.  For
instance,~\cite{HL-PJA:07,LIA-US:13} develops a stabilizing controller
of the switched system regardless of the realization of certain
parameters within a given range.  The work~\cite{SY-BDS-SB:17}
proposes an alternative approach to the same problem based on adaptive
controllers. Another relevant angle is the use of switched controllers
in~\cite{BDOA-TSB-FDB-JH-DL-ASM:00} for robustly stabilizing
non-switched systems.

Robust and adaptive methods still rely on a nominal model and, as
such, require some type of system identification. To circumvent this,
and leverage the development of new computation and data acquisition
methods, there is a growing adoption of data-driven techniques. A
number of different types of switched systems, distinguished by the
type of switching signal, have been the focus of such efforts. The
works~\cite{CZ-MG-JZ:19,AK:20arXiv} consider switched systems without
external inputs where the controlling element is the switching signal
itself. At the other side of the
spectrum,~\cite{TD-MS:18,TD-MS:20,ZW-GOB-RMJ:21arXiv} focus on finding
feedback control laws that stabilize a switched linear system under
arbitrary and unknown switching signals. This requires that the modes
of the system can be simultaneously uniformly stabilized, a
particularly strong assumption. Recent
work~\cite{VB-SF:20,XW-JS-GW-FA-JC:2022} has also explored the
data-based design of switching controllers.

The aforementioned works are based on extending known model-based
methods to the data-driven setup. An alternative approach that has
recently gained traction is based on Willems' fundamental
lemma~\cite{JCW-PR-IM-BLMDM:05}.
Within this broader context, the work~\cite{MR-CDP-PT:22} proposes a
stabilizing controller for an unknown switched system, which is found
only on the basis of noiseless measurements of the currently active
mode of the system. Our treatment here leverages the informativity
approach to data-driven control, as introduced in
\cite{HJVW-JE-HLT-MKC:20} and recently extended in
\cite{HJVW-MKC-JE-HLT:22,JE-JC:23-tac}. In simple terms, this method
characterizes the set of systems that are compatible with collected
data, and produces a robust controller that stabilizes \textit{all}
the systems in this class. Within this framework, the
work~\cite{MB-SG-JC:22} considers the problem of data-driven
stabilization in the situation where the switching signal is
determined by the controller.

\emph{Statement of contributions:} We consider the problem of
stabilizing a switched system subject to an unknown switching signal
and whose modes are unmodeled.
Given that the switching signal is unknown, we require all modes to be
stabilizable.  Using the informativity framework, we first use
pre-collected measurements to determine separate robust stabilizing
feedback gains for each mode. Our online stabilizing controller design
employs online data to switch between a \textit{mode detection phase}
and a \textit{stabilization phase}. In the former, we use the most
recent online measurements to uniquely determine the mode of the
system currently active. We provide an algorithm that, for each time
instance, applies bounded inputs to excite the system and evaluates if
the new measurements obtained are compatible with the set of systems
consistent with the pre-collected measurements of the assumed active
mode. If this is not the case, then the assumed mode is not currently
active. We ensure the computational efficiency of this test by
providing conservative, but efficient, outer approximations to relax
the testing of non-emptyness of the intersection of convex sets.  Once
the active mode is determined, the controller switches to the
stabilization phase, which applies the corresponding stabilizing
feedback gain and monitors the evolution of the associated Lyapunov
function to detect switches. When a switch is detected, the controller
returns to the mode-detection phase.  We study the practical stability
of the closed loop of the unknown system under the proposed online
switched controller and show that, under average dwell- and
activation-time assumptions on the switching signal, it enjoys an
input-to-state-like stability property. In particular, when
measurements are noiseless, the closed loop is asymptotically stable.
% the system does not switch while it is detecting the active
% mode. Moreover, we assume average dwell time (ADT) and average
% activation time (AAT) conditions for the mode detection phase. Under
% these conditions, the closed loop satisfies an input-to-state-like
% stability property.

We have presented preliminary results of this work in the conference
article~\cite{JE-SL-SM-JC:22-cdc}, where we only considered the case of
noiseless data and established practical stability of the closed-loop
system.
% and introduces the basic ideas behind the controller design.
The consideration in the present treatment of noisy measurements
requires significant extensions to all the ingredients of the
approach, a complete generalization of the results for the
initialization step, and an entirely new set of techniques for mode
detection. These, along with refinements in the choice of bounded
inputs to excite the system, lead to stronger practical stability
results, yielding in the noiseless case asymptotic stability of the
closed-loop system.  The stronger stability results obtained here are
illustrated in a novel set of % more extensive and insightful
simulation results.

% \emph{Organization:} The paper is structured as
% follows. Section~\ref{sec:notion} introduces necessary background and
% provides the problem statement.  Section~\ref{sec:initialization}
% describes the initialization step and introduces theoretical notions
% related to data informativity. These notions also play a key role in
% Section~\ref{sec:MD}, where we consider the problem of determining the
% currently active mode using online measurements.
% Section~\ref{sec:stabilization} discusses the stabilization phase of
% the controller and the criteria for detecting switches.  With all the
% pieces in place, we introduce the online switched controller design in
% Section~\ref{sec:osc}, where we also characterize its stabilization
% properties.  Section~\ref{sec:simulation} provides illustrative
% simulations and Section~\ref{sec:conclusion} gathers our concluding
% remarks.

\section{Problem formulation}\label{sec:notion}

Consider\footnote{Throughout the paper, we use the following
  notation. We denote by $\N$ and $\R$ the sets of non-negative
  integer and real numbers, respectively. We let $\R^{n\times m}$
  denote the space of $n\times m$ real matrices. For any
  $M\in\R^{n\times m}$, $\Vert M\Vert$ denotes the standard
  2-norm. For $P\in\R^{n\times n}$, $P\succeq 0$ (resp. $P\succ 0$)
  denotes that $P$ is positive semi-definite (resp. definite).} a
discrete-time switched linear system with $p$ modes of the form
\begin{equation}\label{def:sys}
  x(t+1)=\hat{A}_{\sigma(t)}x(t)+\hat{B}_{\sigma(t)}u(t) +w(t),
\end{equation}
where $x(t)\in\R^n$ is the state, $u(t)\in\R^m$ is the control input,
and $w(t)\in\mathbb{R}^n$ is a noise signal. Here,
$\sigma:\N\rightarrow\calP:=\{1,2,\cdots,p\}$ is the switching signal. For
all $i\in\calP$, the matrices $\hat{A}_i$ and $\hat{B}_i$ are in
$\mathbb{R}^{n\times n}$ and $\mathbb{R}^{n\times m}$, respectively.

We are interested in finding a stabilizing controller for this system
on the basis of measurements. To be precise, we assume that the
dimensions $n$, $m$ and the number of modes $p$ are known, but that
the precise dynamics of the modes are not available for design, that
is, for each mode $i\in\calP$, the matrices $\hat{A}_i$ and $\hat{B}_i$ are
unknown. To offset this lack of knowledge, we have access to a finite
set of measurements of the state and input trajectories. These
measurements correspond to an unknown, but bounded noise signal.
Specifically, we assume that, before the online operation of the
system, we perform an \textit{initialization} step, where we obtain
measurements of each of the individual modes (but this data is not
necessarily enough to identify the dynamics of each separate mode).
After this, once the system is running, we have access to
\textit{online} measurements of the currently active mode. Our goal
is formalized as follows.

\begin{problem}[Online switched controller design]\label{problem}
  Given initialization and online measurements, design a control law
  $u:\N\rightarrow\R^m$ such that the resulting interconnection
  \eqref{def:sys} is guaranteed to satisfy the following
  \emph{input-to-state stability} (ISS)-like property: there exist
  constants $c>0,\zeta\in(0,1)$ and $r\geq0$ (depending on a bound on
  the noise) such that
  \begin{equation}\label{ISS-estimate_0}
    \norm{x(t)}\leq c \, \zeta^t\norm{x(0)}+r ,
  \end{equation}
  for all initial states $x(0)\in\R^n$ and all time $t\in\N$.
\end{problem}

We consider this problem in both the absence and presence of bounded
noise. Moreover, we consider two different cases regarding the
switching signal. At first, we consider the situation where the
controller is aware \textit{when} the systems switches modes, but not
to which mode. After this, we explore the situation where the
switching signal is completely unknown, but where we make certain
regularity assumptions on the \textit{dwell time}, that is, the
frequency of switches.

In order to solve Problem~\ref{problem}, we employ the following
multi-pronged approach. Since unique models for each of the modes
cannot necessarily be determined, we employ the concept of
\textit{data informativity} to formulate conditions under which the
initialization measurements guarantee the existence of a stabilizing
feedback controller for each of the modes. Based on this, our switched
controller operates in two phases. In the \textit{mode detection
  phase}, the controller selects inputs that allow us to determine the
active mode. In general this requires less measurements than fully
identifying the system. In fact, in the absence of noise, a bound on
the required number of steps can be guaranteed by a suitable choice of
inputs. Once the active mode is identified, the controller switches to
the \textit{stabilization phase}, where the controller found in the
initialization step corresponding to the mode is applied.

\section{Initialization step}\label{sec:initialization}

We begin our analysis with the initialization step, where we consider
the problem of finding stabilizing controllers from pre-collected
measurements of the system. To formalize the notion of informativity,
we require some notation. For simplicity of exposition, we first
consider a single linear system, then shift our focus to switched
systems.

Consider measurements of the state and input signals $x$ and $u$ of a
system
\[
  x(t+1) = \hat{A}x(t) + \hat{B}u(t) +w(t),
\] 
on the time interval $\{0,\ldots, T\}$. We define matrices
\begin{align*}
  X 	&:=\begin{bmatrix}x(0) & \cdots & x(T) \end{bmatrix},\\ 
  X_- 	&:=\begin{bmatrix}x(0) & \cdots & x(T-1) \end{bmatrix},\\ 
  X_+ 	&:=\begin{bmatrix}x(1) & \cdots & x(T) \end{bmatrix},\\ 
  U_-	&:=\begin{bmatrix}u(0) & \cdots & u(T-1)\end{bmatrix},\\
  W_-	&:=\begin{bmatrix}w(0) & \cdots & w(T-1)\end{bmatrix}.
\end{align*}
We assume that the state and input measurements $(U_-,X)$ are known,
but that the noise signal is unknown.  However, the noise satisfies
\begin{equation}\label{eq:noise model}
  \begin{bmatrix}
    I_n \\ W_-^\top\end{bmatrix}^\top \begin{bmatrix} \Pi_{11} &
    \Pi_{12} \\ \Pi_{21} &
    \Pi_{22} \end{bmatrix} \begin{bmatrix} I_n \\
    W_-^\top\end{bmatrix} \geq 0,
\end{equation}
where $\Pi_{11}\in\mathbb{R}^{n\times n}$ and
$\Pi_{22}\in\mathbb{R}^{T\times T}$ are symmetric, and
$\Pi_{12}=\Pi_{21}^\top\in\mathbb{R}^{n\times T}$. Such noise models
arise in many applications and are amenable to technical analysis, see
e.g.~\cite{HJVW-MKC-JE-HLT:22}. Throughout the paper, we assume
$\Pi_{22}<0$ and $\Pi_{11}- \Pi_{12}\Pi_{22}^{-1}\Pi_{21}\geq
0$. These assumptions guarantee that the set of matrices $W_-$ for
which \eqref{eq:noise model} holds is nonempty and
bounded~\cite[Theorem 3.2]{HJVW-MKC-JE-HLT:22}.

\begin{remark}[Noiseless measurements]\label{rem:noiseless}
  A special case of the previous is the case where $\Pi_{22}=-I_T$,
  $\Pi_{12}=0$, and $\Pi_{11}=0$. In this case, the matrix $W_-$
  satisfies \eqref{eq:noise model} if and only if $W_-=0$, that is,
  the measurements are without noise. % As we show in the remainder of
  % the paper, the situation without noise reveals a number of important
  % differences as compared the situation with noise.
  \oprocend
\end{remark}

We can now define the set of systems \textit{consistent} with the
measurements, as
\begin{equation*}%\label{def:Sigma}
  \Sigma(U_-,X) := \big\{(A,B)
  :X_+ = AX_- +  BU_- +W_- \, \text{w/} \, \eqref{eq:noise model} \big\}. 
\end{equation*}
Clearly, since the measurements satisfy the noise model and are
collected from the true system, we know that $(\hat{A},\hat{B})$ is
contained in the set $\Sigma(U_-,X)$. If we now define the matrix
\begin{equation}\label{def:N}
  N := \begin{bmatrix} I_n\!\!
    &X_+\\0\!\!&-X_-\\0\!\!&-U_-
  \end{bmatrix}\!\!\begin{bmatrix} \Pi_{11} & \!\!\Pi_{12} \\ \Pi_{21}
    & \!\!\Pi_{22} \end{bmatrix}\!\!\begin{bmatrix} I_n
    \!\!&X_+\\0\!\!&-X_-\\0\!\!&-U_-
  \end{bmatrix}^\top,
\end{equation}
it is straightforward to conclude that the set $\Sigma(U_-,X)$ can be
equivalently represented as 
\begin{equation}\label{eq:Sigma as QMI}
  \Sigma(U_-,X) =\bigg \lbrace
    (A,B) \mid \begin{bmatrix} I_n \\ A^\top \\
      B^\top \end{bmatrix}^\top N \begin{bmatrix} I_n \\
      A^\top\\B^\top \end{bmatrix}\geq 0 \bigg\rbrace.
\end{equation}
We are interested in characterizing properties of the true system
based on the measurements. However, the set $\Sigma(U_-,X)$ might
contain other systems in addition to the true one. This means, for
instance, that we can only conclude that a feedback gain $K$
stabilizes the true system if this gain stabilizes any system whose
system matrices are in $\Sigma(U_-,X)$. We are interested in
determining when the available data is informative enough to allow us
to accomplish this.

\begin{definition}[Informativity for uniform
  stabilization]\label{def:informativity for uniform stabilization}
  The data $(U_-,X)$ is \textit{informative for uniform stabilization
    by state feedback with decay rate} $\lambda\in(0,1)$ if there
  exist $K\in\R^{m\times n}$ and $P\in\R^{n\times n}, P\succ 0$ such
  that
  \begin{equation}\label{eqn:informativity for uniform stabilization}
    (A+BK)^\top P (A+BK)\prec\lambda P , \quad\forall (A,B)\in\Sigma(U_-,X).
  \end{equation}
\end{definition}

Let $\tilde V(x):=x^\top Px$ and consider the closed loop of any
system consistent with the data and the controller $u=Kx$. Then, if
the data is informative,
\begin{align}\label{eq:decay-rate}
  \tilde V(x(t+1))
  % & =x(t+1)^\top P x(t+1)
  % \\
  % & = x(t)^\top (A+BK)^\top P(A+BK) x(t)
  % \\
    & \leq \lambda x(t)^\top P x(t)=\lambda \tilde V(x(t)),
\end{align}	
for all $t \in \N$. This means that, even if the matrices $(A,B)$ can
not be identified uniquely from the measurements, the feedback gain
$K$ stabilizes the system with Lyapunov function $\tilde V$ and decay
rate $\lambda$.

To determine whether the data $(U_-,X)$ is informative, we can exploit
the fact that \eqref{eq:Sigma as QMI} and \eqref{eqn:informativity for
  uniform stabilization} are quadratic matrix inequalities in $A$ and
$B$. The following result
extends~\cite[Theorem~5.1.(a)]{HJVW-MKC-JE-HLT:22}, which essentially
considers the special case $\lambda=1$, to reduce the problem to that
of finding matrices $K$ and $P$ that satisfy a \emph{linear matrix
  inequality} (LMI).

\begin{theorem}[Conditions for informativity for uniform
  stabilization]\label{thm:common_K}
  The data $(U_-,X)$ is informative for uniform stabilization by state
  feedback with decay rate $\lambda$ if and only if there exist
  $Q\in\R^{n\times n}$, with $Q\succ 0$, $L\in\R^{m\times n}$ and $\beta>0$ such that
  \begin{equation}\label{eqn:common_K_LMI}
    \small\begin{bmatrix}
      \!\lambda Q\!-\!\beta I_n\!\!\!\!\!& 0 & 0 &0\\0&0&0 &Q\\0&0&0&L\\0&Q&\! L^\top\!\!\! &Q
    \end{bmatrix}-\begin{bmatrix} I_n\!\! &X_+\\0\!\!&\!-X_-\\0\!\!&\!-U_-\\0\!\!&0
    \end{bmatrix}\!\!\!\!\begin{bmatrix} \Pi_{11} & \!\!\Pi_{12} \\ \Pi_{21} & \!\!\Pi_{22} \end{bmatrix}\!\!\!\!\begin{bmatrix} I_n \!\!&X_+\\0\!\!&\!-X_-\\0\!\!&\!-U_-\\0\!\!&0
\end{bmatrix}^\top\!\!\!\!\succeq 0.
\normalsize
  \end{equation}
  Moreover, the matrices $K:=LQ^{-1}$ and $P:=Q^{-1}$
  satisfy~\eqref{eqn:informativity for uniform stabilization}.
\end{theorem}

% Note that the feasibility of this inequality is a necessary and
% sufficient condition for the data $(U_-,X)$ to be informative for
% uniform stabilization with decay rate $\lambda$ by state feedback.
The proof of Theorem~\ref{thm:common_K} is given in the appendix.  The
characterization given in this result provides the backbone of the
initialization step for our controller design.  As noted in the
problem formulation, we have access to measurements of each of the
modes in the initialization step.  We denote the measurements
corresponding to mode $i\in\calP$ by $(U_-^i,X^i)$. We consider the
corresponding matrices $U_-^i$, $X^i$ and a noise model given
by~$\Pi^i$. Since we are interested in stabilizing the unknown
switched system regardless of the switching signal, this implies that,
each of the modes must be stabilizable. This motivates the following
assumption.

\begin{assumption}[Initialization step]\label{ass:ass_on_data-I}
  Let $\lambda\in (0,1)$.  For each mode $i\in\calP$, the data
  $(U_-^i,X^i)$ is informative for uniform stabilization by state
  feedback with decay rate $\lambda$.
\end{assumption}

We denote by $K_i$ the feedback corresponding to $(U_-^i,X^i)$
obtained from Theorem~\ref{thm:common_K}. The corresponding Lyapunov
matrix is denoted by $P_i$. This means that we have (potentially)
different feedback and Lyapunov matrices for each mode, but that the
decay rate is uniform for all modes $i\in\calP$. Note that the choice
of a common decay rate across the modes does not introduce
conservatism, since if \eqref{eqn:informativity for uniform
  stabilization} holds for $\lambda$, it also holds for any
$\bar{\lambda}$ with $\lambda\leq \bar{\lambda}<1$.

\section{Mode detection phase}\label{sec:MD}

After the initialization step, we consider the situation where the
unknown system is in operation and additional \textit{online}
measurements, denoted by
$(U^{\textnormal{on}}_-,X^{\textnormal{on}})$, are collected. To be
precise, we consider measurements that are collected sequentially from
the system when it dwells in a single, unknown mode. As before, we let
$\Sigma(U^{\textnormal{on}}_-, X^{\textnormal{on}})$ denote the set of
all systems compatible with the online measurements. To simplify the
exposition, we introduce for each $i\in\calP$ the following shorthand
notation,
\[
  \Sigma^i := \Sigma(U^i_-,X^i), \quad \Sigma^{\textnormal{on}} :=
  \Sigma(U^{\textnormal{on}}_-, X^{\textnormal{on}}).
\]
We assume that the systems dwells in a single mode, and that we
collect the online measurements sequentially. As such, after $\ell$
time instances, we can write
\[
  \Sigma^{\textnormal{on}} = \bigcap_{t=0}^{\ell-1}
  \Sigma^{\textnormal{on}}_t,
\]
where $\Sigma^{\textnormal{on}}_t$ is the set of systems consistent
with the measurements collected at time instance $t$.

Our goal is to stabilize the switched system.  To do this, we could
simply test whether the online measurements
$(U^{\textnormal{on}}_-, X^{\textnormal{on}})$ are informative for
uniform stabilization with decay rate~$\lambda$.  However, the
initialization data gives us additional information that can be
exploited: we know that the true system is contained in
$\Sigma^i\cap\Sigma^{\textnormal{on}}$ for at least one $i\in\calP$.
If we could uniquely determine which of the $p$ different systems has
generated the online measurements
$(U_-^{\textnormal{on}},X^{\textnormal{on}})$, we can then apply the
stabilizing controller found in the initialization step.  The notion
of data compatibility plays a key role in achieving this goal.

\begin{definition}[Data compatibility]
  The data pairs $(U_-^1,X^1)$ and $(U_-^2,X^2)$ are
  \textit{compatible} if there exists a system that is consistent with
  both, that is, $\Sigma^1\cap\Sigma^2\neq\emptyset$.
\end{definition}

\begin{figure}
  \centering
  \begin{tikzpicture}[scale=0.85]
    % left hand
    % \scope
    % \clip (-2,-2) rectangle (2,2)
    % (1,0) circle (1);
    % \fill (0,0) circle (1);
    % \endscope
    % % right hand
    % \scope
    % \clip (-2,-2) rectangle (2,2)
    % (0,0) circle (1);
    % \fill (1,0) circle (1);
    % \endscope
    % outline
    \filldraw[color=black, fill=black, fill opacity=0.2] (2,3) circle (1.2) (2,3)  node [opacity=1] {$\Sigma^1$}
    (5,2) circle (1.2) (5,2)  node [opacity=1] {$\Sigma^2$}
    (7.5,4) circle (1.2) (7.5,4)  node [opacity=1] {$\Sigma^3$};
    \filldraw[blue, opacity=0.25]  (5,3.5) circle (2);
    \filldraw[blue, opacity=0.25]  (5,3.5) circle (1.5);
    \filldraw[blue, opacity=0.25]  (5,3.5) circle (1) (5,3.5) node [black, opacity=1] {$\Sigma^{\textnormal{on}}$};
    \draw (0,0.5) rectangle (10,6) (1.5,5.5) node {$\R^{n\times n}\times \R^{n\times m}$};
  \end{tikzpicture}
  \caption{Graphical interpretation of the mode detection
    scheme. Initially, $\Sigma^{\textnormal{on}}$ intersects the sets
    corresponding to three different modes.  As more data are
    collected, $\Sigma^{\textnormal{on}}$ decreases in size (cf.
    darker blue disks). When enough data are available,
    $\Sigma^{\textnormal{on}}$ eventually becomes compatible only with
    mode 2. Note that we do not need $\Sigma^{\textnormal{on}}$ to
    shrink into a singleton (system identification) before reaching
    unique compatibility.}\label{fig:mode_detection}
\end{figure}

% \todoinr{Later: change the algorithm such that either (1) the
% online data is compatible with only one mode \textit{or} (2) we have
% $\Sigma^{\textrm{on}}\subseteq \Sigma^i$ for some $i$. In the latter
% case, we can simply apply the controller corresponding to mode
% $i$. Of course, denoting the obvious things with $N^i$ and $M^i$, it
% makes little sense to check whether $Z(N^{on})\subseteq Z(N^i)$ over
% just checking $Z(N^{on})\subseteq Z(M^i)$.As such, we can check
% whether $\Sigma^{on}$ can be stabilized with any of the $K_i's$.}

We are interested in determining the active mode of the system from
the online measurements.

\begin{definition}[Informativity for mode detection]
  Given initialization data $\{(U_-^i,X^i)\}_{i\in\calP}$, the online
  measurements $(U_-^{\textnormal{on}},X^{\textnormal{on}})$ are
  \emph{informative for mode detection} if
  $(U_-^{\textnormal{on}},X^{\textnormal{on}})$ and $(U_-^i,X^i)$ are
  compatible for exactly one $i\in\calP$.
\end{definition}

In order for the mode detection phase to be successful, we assume that
the initialization data are pairwise incompatible.

\begin{assumption}[Initialization step
  --cont'd]\label{ass:ass_on_data-II}
  The data $\{(U_-^i,X^i)\}_{i\in\calP}$ are such that $(U^i_-,X^i)$
  and $(U^j_-,X^j)$ are incompatible for each pair $i\neq j \in\calP$.
\end{assumption}

Since the online measurements are generated by precisely one of the
modes $i\in\calP$, there must be at least one $i\in\calP$ such that
$(U_-^{\textnormal{on}},X^{\textnormal{on}})$ and $(U_-^i,X^i)$ are
compatible. By assuming that the initial data are pairwise
incompatible, we can conclude that once $\Sigma^{\textnormal{on}}$
becomes sufficiently ``small'', the mode $i$ corresponding to the data
$(U_-^i,X^i)$ which are compatible with
$(U_-^{\textnormal{on}},X^{\textnormal{on}})$ must be
unique. Figure~\ref{fig:mode_detection} provides a graphical
illustration.

\subsection{Mode detection for noiseless data}
First, we consider the system without noise, that is, $w(t)=0$. The
following result characterizes compatibility in this case.

\begin{lemma}[Conditions for noiseless data compatibility]\label{lem:exact dis}
  Noiseless data $(U_-^1,X^1)$ and $(U_-^2,X^2)$ are compatible if and
  only if
  \begin{equation}\label{eq:kernel}
    \ker
    \begin{bmatrix}
      X^1_-&X^2_-\\U^1_-&U^2_-
    \end{bmatrix}
    \subseteq  
    \ker \begin{bmatrix}X^1_+&X^2_+\end{bmatrix}. 
  \end{equation}
\end{lemma}
\begin{proof}
  Since $W_-^1=W_-^2=0$, the data are compatible if and only if there
  exists $A$ and $B$ such that: $X^1_+ = AX^1_-+BU_-^1$ and
  $X^2_+ = AX^2_-+BU_-^2$. Equivalently, we have
  \[
    \begin{bmatrix}X^1_+&X^2_+\end{bmatrix} = \begin{bmatrix} A&
      B \end{bmatrix} \begin{bmatrix}
      X^1_-&X^2_-\\U^1_-&U^2_- \end{bmatrix}.
  \]
  The existence of such $\begin{bmatrix} A&B \end{bmatrix}$ is
  equivalent to \eqref{eq:kernel}.
\end{proof}

This result provides a test to check whether the online measurements
are compatible with the initialization data. At each step, the idea is
to evaluate whether the online data are compatible with precisely one
mode of the system. This iterative procedure raises the question of
how to select the input to the unknown system appropriately at each
step.  In other words, we are interested in \textit{generating} online
data such that, after a bounded number of steps,
$\Sigma(U_-^{\textnormal{on}},X^{\textnormal{on}})$ becomes small
enough for the data to be informative for mode detection. Formally,
the problem is to find a time horizon $T^{\textnormal{on}}$ and inputs
$u^{\textnormal{on}}(0),\ldots,
u^{\textnormal{on}}(T^{\textnormal{on}}-1)$ such that the
corresponding online data
$(U_-^{\textnormal{on}},X^{\textnormal{on}})$ are informative for mode
detection.

To obtain such inputs, we adapt the experiment design method
of~\cite{HJVW:21}. When each of the modes $(\hat{A}_i,\hat{B}_i)$ of the system
are controllable, \cite[Theorem~1]{HJVW:21} gives a construction for
inputs $u^{\textnormal{on}}(0),\ldots, u^{\textnormal{on}}(n+m-1)$
such that the corresponding set
$\Sigma(U_-^{\textnormal{on}},X^{\textnormal{on}})$ is a
singleton. Assume
\[
  \rank \begin{bmatrix}
    X^{\textnormal{on}}_-\\U^{\textnormal{on}}_- \end{bmatrix}\neq
  n+m.
\]
Now, either $x(t)\not\in\im X^{\textnormal{on}}_-$, in which case,
take $u(t)$ equal to $0$. In the other case, \cite[Theorem~1]{HJVW:21}
shows that there exist $\eta,\xi$ such that $\eta\neq 0$ and
\[
  \begin{bmatrix} \xi\\\eta \end{bmatrix}\in\ker\begin{bmatrix}
    X^{\textnormal{on}}_-\\U^{\textnormal{on}}_- \end{bmatrix}^\top .
\] 
Now, by taking any $u(t)\in\R^m$ such that
$\xi^\top x(t)+\eta^\top u(t)\neq 0$, it can be shown that
\[
  \rank \begin{bmatrix}
    X^{\textnormal{on}}_-\\U^{\textnormal{on}}_- \end{bmatrix}<
  \rank \begin{bmatrix} X^{\textnormal{on}}_- & x(t)
    \\U^{\textnormal{on}}_- & u(t) \end{bmatrix}.
\]
Note that, without loss of generality, we can choose $u(t)$ such that
$\norm{u(t)}\leq c\norm{x(t)}$ for any $c>0$.

Clearly, after $n+m$ repetitions, this procedure results in a data
matrix which has full row rank. This implies that
$\Sigma(U_-^{\textnormal{on}},X^{\textnormal{on}})$ is a singleton. As
such, under Assumption~\ref{ass:ass_on_data-II}, the measurements up
to $T^{\textnormal{on}}=n+m$ are guaranteed to be informative for mode
detection. This provides a worst-case bound as, in general, mode
detection is achieved with far fewer measurements than those required
for system identification.

\begin{algorithm}[htb!]
  \caption{Mode detection for noiseless
    data}\label{alg:mode_detection}
  % \caption{Each time instance of the mode detection algorithm for
  % noiseless
  % data}\label{alg:mode_detection}
  \algorithmicrequire
  $\calP_{\textrm{match}},\{U^i_-,X^i\}_{i\in\calP},U^{\textnormal{on}}_-,X^{\textnormal{on}},c$
  \\
  \algorithmicensure $\calP_{\textrm{match}},U^{\textnormal{on}}_-,X^{\textnormal{on}}
%  ,f_{\textup{done}}
$
  \begin{algorithmic}[1]
    	\If{$U_-^{\textnormal{on}}\neq []$ and $x(t)\in\im X^{\textnormal{on}}_-\setminus \{0\}$ }\label{step:mode_detection_start} 
	   		\State Pick $\begin{bmatrix}\xi\\\eta\end{bmatrix}\in\ker\begin{bmatrix} X^{\textnormal{on}}_-\\U^{\textnormal{on}}_-
    	\end{bmatrix}^\top$ with $\eta\neq 0$\label{step:mode_detection_critical}
    		\State Let $u(t)\in\R^m$ be such that \label{step:mode_detection_bound}
    		\[\norm{u(t)}\leq c\norm{x(t)} \textrm{ and } \xi^\top x(t)+\eta^\top u(t)\neq 0\] \LineComment{Choose the next input}
    	\Else
    		\State $u(t)\gets 0$
    	\EndIf\label{step:mode_detection_end}
 		\State Get the next state $x(t+1)$
 		
  		\State $U_-^{\textnormal{on}}\gets \begin{bmatrix}U_-^{\textnormal{on}}&u(t) \end{bmatrix}$                         
		\State $X^{\textnormal{on}}\gets \begin{bmatrix} X^{\textnormal{on}}& x(t+1)
\end{bmatrix}$ \Comment{Append the online data}
  \If{$x(t+1)=0$} \label{step:x0 start}
  \Comment{System stable for any feedback}
  \State $\calP_{\textnormal{match}} = \{1\}$     \label{step:x0 end}
  \Else
  \For{$i\in\calP_{\textrm{match}}$}  
    \If{the inclusion \eqref{eq:kernel} is violated}  \LineComment{Data are incompatible with mode $i$}
    \State $\calP_{\textrm{match}}=\calP_{\textrm{match}}\backslash\{i\}$ \Comment{Eliminate mode $i$}
    \EndIf
    \EndFor 
    \EndIf
%    \If{$|\calP_{\textrm{match}}|=1$}\LineComment{Mode is detected if only one matches}
%    \State $f_{\textup{done}}=1$
%    \Else
%    \State $f_{\textup{done}}=0$
%    \EndIf
  \end{algorithmic}
\end{algorithm}
Algorithm~\ref{alg:mode_detection} formalizes the mode detection
procedure for noiseless data.
% This algorithm requires as input the
% aforementioned data and a list of possible modes
% $\calP_{\textnormal{match}}$. In practice we start by taking
% $\calP_{\textnormal{match}}=\calP$, that is, we assume that any mode
% could be active. Then each iteration of
% Algorithm~\ref{alg:mode_detection} generates a new online measurement
% by choosing a bounded input consistent with the aforementioned
% experiment design method of~\cite{HJVW:21} in Step
% \ref{step:mode_detection_start} to Step \ref{step:mode_detection_end}.
% After applying this input and measuring the resulting state, we update
% the data matrices. 
Note that if, at any point of the algorithm, the state satisfies
$x(t)=0$ (step \ref{step:x0 start}), then choosing $u(t)=0$ stabilizes any linear
system, and therefore specifically all modes of the system. As such,
we can apply any of the feedback gains $K_i$. We enforce this by
setting $\calP_{\textnormal{match}}$ equal to any of the
modes. Otherwise, the algorithm checks whether \eqref{eq:kernel} is
violated for each of the modes remaining in
$\calP_{\textnormal{match}}$, in which case the corresponding mode is
discarded.  If $|\calP_{\textrm{match}}|\neq 1$, the algorithm should
be repeated and another online measurement collected.  If
$|\calP_{\textrm{match}}|=1$, the active mode detection is identified.
% Lastly, the variable $f_{\textup{done}}$ is toggled to 1 if the
% unique active mode is detected. If instead $f_{\textup{done}}$
% remains equal to 0, this algorithm is ran again.

\begin{corollary}[Algorithm~\ref{alg:mode_detection} terminates in a
  finite number of repetitions]\label{cor:at-most-n+m}
  Suppose that for each mode $i\in\calP$ the matrix pair
  $(\hat{A}_i,\hat{B}_i)$ is controllable and that
  Assumptions~\ref{ass:ass_on_data-I} and~\ref{ass:ass_on_data-II}
  hold.  Let $\calP_{\textnormal{match}}=\calP$ and
  $X^{\textnormal{on}} = [x(0)]$.  Execute Algorithm~1 iteratively,
  updating $\calP_{\textrm{match}}$ and
  $(U^{\textnormal{on}}_-,X^{\textnormal{on}})$ at every step.  Then
  $|\calP_{\textrm{match}}|=1$ after at most $n+m$
  iterations. Moreover, the online data
  $(U^{\textnormal{on}}_-,X^{\textnormal{on}})$ are either informative
  for mode detection or such that $x(T^{\textnormal{on}})=0$.
\end{corollary}

\subsection{Mode detection for noisy data}
As in the noiseless case, testing whether
$\Sigma^i\cap\Sigma^{\textnormal{on}}\neq \emptyset$ amounts to
checking non-emptiness of the intersection of two convex sets. This
needs to be done online, during the collection of measurements, and
hence requires to be resolved in time with the evolution of the
system. In the noiseless case, the fact that the convex sets under
consideration were affine made solving the problem online feasible by
employing Lemma~\ref{lem:exact dis}. However, this is no longer the
case in the presence of noise. Therefore, to be able to test for
(in)compatibility in an online fashion, here we develop a number of
conservative, but more computationally efficient, methods.  Our
exposition first shows how to over-approximate the sets of compatible
systems by spheres. This allows us to provide simple tests for
incompatibility after a single measurement.  After this, we also
propose methods to deal with sequential measurements.

\paragraph*{Outer approximation of set of consistent systems on the
  basis of measurements}
For simplicity of exposition, we first deal with a single true linear
system and a single set of measurements $(U_-,X)$.  Moreover, to
further ease the notation, we assume in the remainder of the paper
that the noise models are given in the form of a bound on the energy
of the noise, that is, $W_-W_-^\top \leq Q$, with $Q=Q^\top\geq 0$. In
particular, this implies
\begin{equation}\label{eq:noise model restricted}
  \Pi
  := \begin{bmatrix} \Pi_{11} & \Pi_{12} \\ \Pi_{12}^\top &
    \Pi_{22} \end{bmatrix} = \begin{bmatrix} Q & 0 \\ 0 &
    -I_{T} \end{bmatrix}.
\end{equation} 
Noise models of this form are very versatile. Depending on the choice
of $Q$, we can model for instance, the assumption of a signal-to-noise
ratio by taking $Q= \gamma X_-X_-^\top$. The noise model also captures
the case of exact measurements ($Q=0$).

Assuming that $\begin{bmatrix} X_-\\U_-\end{bmatrix}$ has full row rank, we
define the \textit{center} $Z$ of the set $\Sigma= \Sigma(U_-,X)$ of
consistent systems, given as in \eqref{eq:Sigma as QMI}, by
\begin{equation}\label{eq:centre}
  Z := X_+\begin{bmatrix} X_- \\
    U_- \end{bmatrix}^\dagger,
\end{equation}
where $M^\dagger$ denotes the Moore-Penrose inverse of a matrix
$M$. Let $\lambda_{\min}(M)$ and $\lambda_{\max}(M)$ denote the
smallest and largest eigenvalue of $M$ respectively, and define the
\textit{radius} $r$ of $\Sigma$ as
\begin{equation}\label{eq:radius}
  r:=
  \sqrt{\frac{\lambda_{\max}(Q)}{\lambda_{\min}\left(\begin{bmatrix}
          X_-\\U_-\end{bmatrix}\begin{bmatrix}
          X_-\\U_-\end{bmatrix}^\top\right)}}.
\end{equation} 
The following result provides an outer approximation of the
set~$\Sigma$.

\begin{lemma}[Outer approximation of set of consistent
  systems]\label{lem:bounded}
  Suppose that $\Pi$ is given by~\eqref{eq:noise model restricted} and
  $\begin{bmatrix} X_-\\U_-\end{bmatrix}$ has full row rank. Then
  $\Sigma\subseteq B^r(Z) = \left\lbrace (A,B) \mid
    \norm{\begin{bmatrix} A& B\end{bmatrix}-Z} \leq r\right\rbrace$,
  where $Z$ is the center~\eqref{eq:centre} and $r$ is the
  radius~\eqref{eq:radius} of~$\Sigma$.
\end{lemma}
\begin{proof}
  By definition $(A,B)\in\Sigma$ if and only if
  \[
    \left(X_+ - \begin{bmatrix} A& B\end{bmatrix}\begin{bmatrix}
        X_-\\U_-\end{bmatrix}\right) \left(X_+ - \begin{bmatrix} A&
        B\end{bmatrix}\begin{bmatrix}
        X_-\\U_-\end{bmatrix}\right)^\top \leq Q.
  \] 
  This implies that 
  \[
    \left(\begin{bmatrix} A& B\end{bmatrix}-Z \right) \begin{bmatrix}
      X_-\\U_-\end{bmatrix}\begin{bmatrix} X_-\\U_-\end{bmatrix}^\top
    \left(\begin{bmatrix} A& B\end{bmatrix}-Z \right)^\top \leq Q.
  \] 
  Since $\begin{bmatrix} X_-\\U_-\end{bmatrix}$ has full row rank, the
  matrix
  $\begin{bmatrix} X_-\\U_-\end{bmatrix}\begin{bmatrix}
    X_-\\U_-\end{bmatrix}^\top$ is positive definite. Moreover, for
  any matrix $M\in\mathbb{R}^{n\times n}$ such that $M\geq 0$, we have
  $\lambda_{\min}(M)I_n \leq M \leq \lambda_{\max}(M)I_n$. This implies
  that
  \[
    \left(\begin{bmatrix} A& B\end{bmatrix}-Z \right)
    \left(\begin{bmatrix} A& B\end{bmatrix}-Z \right)^\top \leq r^2 I_n,
  \]
  and hence we $\norm{\begin{bmatrix} A& B\end{bmatrix}-Z}^2 \leq r^2$
  for any $(A,B)\in\Sigma $.
\end{proof}

Conversely, if $\begin{bmatrix} X_-\\U_-\end{bmatrix}$ does not have
full row rank, then the corresponding set $\Sigma$ is unbounded, and
there does not exist any $r$ and $Z$ such
that~$\Sigma\subseteq B^r(Z)$.

\paragraph*{Conservative tests for incompatibility using outer approximations}

Here we describe how to leverage the outer approximation on the set of
systems consistent with some given measurements to determine data
incompatibility.  Given the initialization data, we define the
distance between $\Sigma^i$ and $\Sigma^j$ for $i,j\in\calP$ by
\[
  d_{ij} := \min_{\substack{(A_i,B_i)\in\Sigma^i \\
      (A_j,B_j)\in\Sigma^j}} \norm{\begin{bmatrix} A_i-A_j &
      B_i-B_j \end{bmatrix} } .
\]
Since the sets $\Sigma^i$ are closed by definition, the measurements
$(U^i_-,X^i)$ and $(U^j_-,X^j)$ are incompatible if and only if
$d_{ij}>0$. This distance can be determined from the initialization
data and computed in the initialization step.  We can give an
alternative, more computationally efficient test under the additional
assumption that the matrices
$\begin{bmatrix} X^i_-\\U^i_-\end{bmatrix}$ have full row rank. In
this case, we can use Lemma~\ref{lem:bounded} to efficiently bound the
distance between $\Sigma^i$ and $\Sigma^j$ from below. We denote by
$Z_i$ and $r_i$, respectively, the center and radius of $\Sigma^i$,
for each $i \in \calP$.  Then, we have
\begin{equation}
  d_{ij} \geq \norm{Z_i-Z_j}^2 -r_i-r_j. 
\end{equation} 
This can be used to formulate an efficient method of verifying
Assumption~\ref{ass:ass_on_data-II} as follows.

\begin{corollary}[Ensuring Assumption~\ref{ass:ass_on_data-II} holds]
  Suppose that $\Sigma^i\subseteq B^{r_i}(Z_i)$ for all $i\in
  \calP$. If $ \norm{Z_i-Z_j}^2 >r_i+r_j $, for all $i\neq j$, then
  Assumption~\ref{ass:ass_on_data-II} holds.
\end{corollary}

The same idea can be used for the case of online measurements
$(U_-^{\textnormal{on}},X^{\textnormal{on}})$. Recall that these are
collected sequentially, giving rise to
$\Sigma^{\textnormal{on}} = \bigcap_{t=0}^{T^{\textnormal{on}}-1}
\Sigma^{\textnormal{on}}_t$.  Since the ultimate goal of checking for
incompatibility is to determine the active mode of the switched
system, after collecting each measurement, we face the dichotomy of
already using the information or wait for the additional one provided
by subsequent measurements. As a first step towards resolving this
dichotomy, we develop a computationally efficient test to check for
compatibility with a single set~$\Sigma^{\textnormal{on}}_t$
determined by a \emph{single} measurement.
% One approach would be to collect a large number of
% measurements and then test for (in)compatibility. Given that we are
% interested in determining the active mode in a small number of
% steps, we instead choose to focus on an approach where we collect a
% \textit{single} measurement at each time instance and then perform
% a computationally efficient test.

In the single measurement case, the noise model~\eqref{eq:noise model
  restricted} takes the form $w(t)w(t)^\top\leq q^2I_n$, or
equivalently, $\norm{w(t)}\leq q$. Then,
\begin{equation}\label{eq:def Sigonj}
  \Sigma^{\textnormal{on}}_t = \{
  (A,B) \mid \norm{ \begin{bmatrix} A &
      B \end{bmatrix}\left(\!\begin{smallmatrix} x(t)\\
        u(t) \end{smallmatrix}\!\right) -x(t+1)}\leq q \}.
\end{equation}
The following result provides a sufficient condition for incompatibility
with~$\Sigma^{\textnormal{on}}_t$.

\begin{lemma}[Scalar test for incompatibility with single online
  measurement] \label{lem:dist for compatibility}
  Let $\Sigma\subseteq B^r(Z)$ for some $r$ and $Z$. For 
  $\Sigma^{\textnormal{on}}_t$  as in~\eqref{eq:def Sigonj}, if
  \begin{equation}\label{eq:condition spheres}
    \norm{Z \left(\!\begin{smallmatrix} x(t)\\
          u(t) \end{smallmatrix}\!\right) - x(t+1) } >
    q+r\norm{\!\left(\!\begin{smallmatrix} x(t)\\
          u(t) \end{smallmatrix}\!\right)\!},
  \end{equation}
  then $\Sigma\cap\Sigma^{\textnormal{on}}_t =\emptyset$.
\end{lemma} 
\begin{proof}
  Suppose that \eqref{eq:condition spheres} holds and let
  $\bar{Z}\in\Sigma$. We show that
  $\bar{Z}\not\in\Sigma^{\textnormal{on}}_t$.  From the triangle
  inequality, we have
  \begin{align*}
    &\hspace{-1em} \norm{\bar{Z} \left(\!\begin{smallmatrix} x(t)\\
          u(t) \end{smallmatrix}\!\right) - x(t+1) } \\&\geq \norm{Z
    \left(\!\begin{smallmatrix} x(t)\\ u(t) \end{smallmatrix}\!\right)
    - x(t+1) } - \norm{(\bar{Z}-Z)\left(\!\begin{smallmatrix} x(t)\\
        u(t) \end{smallmatrix}\!\right)\!}.
  \end{align*}
  Since, by assumption $\bar{Z}\in B^r(Z)$, we can write
  \[
    \norm{(\bar{Z}-Z)\left(\!\begin{smallmatrix} x(t)\\
          u(t) \end{smallmatrix}\!\right)\!}\leq
    r\norm{\!\left(\!\begin{smallmatrix} x(t)\\
          u(t) \end{smallmatrix}\!\right)\!}.
  \]
  Combining this with~\eqref{eq:condition spheres}, we obtain
  \[
    \norm{\bar{Z} \left(\!\begin{smallmatrix} x(t)\\
          u(t) \end{smallmatrix}\!\right) - x(t+1) } > q,
  \]
  and hence  $\bar{Z}\not\in\Sigma^{\textnormal{on}}_t$ as claimed.
\end{proof}

This result allows to check incompatibility by means of a scalar
condition, instead of finding the intersections of two quadratic sets
in~$\mathbb{R}^{n\times(n+m)}$.  As a further benefit, we can apply
the previous reasoning to efficiently determining when a
\textit{chosen} input is guaranteed to resolve the incompatibility
problem.

\begin{corollary}[Choosing inputs for incompatibility]\label{cor:input
    design}
  Let $\Sigma^{\textnormal{on}}_t$ be as in \eqref{eq:def Sigonj} and
  suppose that $\Sigma^i\subseteq B^{r_i}(Z_i)$ for all
  $i\in\calP$. Let $i\neq j\in\calP$ and $x(t)\in\mathbb{R}^n$. If
  $u(t)$ is such that
  \begin{equation}\label{eq:input design}
    \norm{ (Z_i-Z_j)\left(\!\begin{smallmatrix} x(t)\\
          u(t) \end{smallmatrix}\!\right)}
    >(r_i+r_j)\norm{\left(\!\begin{smallmatrix} x(t)\\
          u(t) \end{smallmatrix}\!\right)}+2q ,
  \end{equation}
  then at most one of
  $\Sigma^i\cap\Sigma^{\textnormal{on}}_t\neq \emptyset$ or
  $\Sigma^j\cap\Sigma^{\textnormal{on}}_t\neq \emptyset$ holds.
\end{corollary} 

Interestingly, the condition in Corollary~\ref{cor:input design} can be
met wherever the effect of the input on the systems in $\Sigma_i$ and
$\Sigma_j$ is `different enough'. Formally, if
\begin{equation}\label{eq:sufficient input design}
  \norm{(Z_i-Z_j)\begin{bmatrix} 0\\ I_m \end{bmatrix}}
  >
  r_1+r_2,
\end{equation}
then, for any $x(t)$, there exists a large enough $u(t)$ for
which~\eqref{eq:input design} holds, allowing to discard at least one
of the systems.  Equipped with these results, one can generalize
Algorithm~\ref{alg:mode_detection} to noisy data by first outer approximating the
sets of systems compatible with the initialization data
$\{\Sigma_i\}_{i \in \calP}$ using Lemma~\ref{lem:bounded} and then
(assuming that \eqref{eq:sufficient input design} holds for each pair)
designing inputs guaranteed to eliminate at least one mode from
consideration at each step, using Corollary~\ref{cor:input design}. The
corresponding mode detection scheme takes at most $p$ steps. Instead
of formalizing this procedure, we will take full advantage of the
information provided by multiple measurements at once.

\paragraph*{Considering incremental measurements}
Treating online measurements separately may prove restrictive. In
fact, the true system is not just contained in each
$\Sigma^{\textnormal{on}}_t$, but in their intersection
$\Sigma^{\textnormal{on}} = \bigcap_{t=0}^{T^{\textnormal{on}}-1}
\Sigma^{\textnormal{on}}_t$.  To address this, we develop here results
dealing with intersections of such sets. In order to circumvent the
computational complexity associated with considering increasing
numbers of intersections of quadratic sets, we overestimate them with
a single set, which leads to conservative, more computationally
efficient tests.  We employ a set representation of the
form~\eqref{eq:Sigma as QMI}, that is, we have for each
$t=0,\ldots,T^{\textnormal{on}}-1$,
\[
  \Sigma^{\textnormal{on}}_t =
  \Bigg \{ (A,B) \mid
  \begin{bmatrix}
    I_n \\
    A^\top
    \\
    B^\top
  \end{bmatrix}^\top
  N^{\textnormal{on}}_t
  \begin{bmatrix}
    I_n \\
    A^\top\\B^\top
  \end{bmatrix}
  \geq 0 \Bigg \},
\]
for some $N^{\textnormal{on}}_t$ given in the form of \eqref{def:N},
with a corresponding noise model~\eqref{eq:noise model
  restricted}. Given $\alpha_0,\ldots,\alpha_{T^{\textnormal{on}}-1}\geq 0$, we
denote the vector $\alpha := ( \alpha_0\cdots\alpha_{T^{\textnormal{on}}-1})^\top$
and define
$ N^{{\textnormal{on}}}(\alpha) := \sum_{t=0}^{T^{\textnormal{on}}-1}\alpha_t
N^{\textnormal{on}}_t $. Similarly, we let $N^i$ be the matrices
corresponding to the initialization sets $\Sigma^i$, and define
$ N^{i,{\textnormal{on}}}(\alpha) := N^i+
N^{\textnormal{on}}(\alpha)$, for each $i\in\calP$.  Consider the sets
\begin{align*}
  \Sigma^{\textnormal{on}}(\alpha)
  &:= \Bigg \{ (A,B)
    \mid \begin{bmatrix} I_n \\ A^\top
      \\ B^\top \end{bmatrix}^\top
  N^{{\textnormal{on}}}(\alpha)
  \begin{bmatrix}
    I_n
    \\
    A^\top
    \\
    B^\top
  \end{bmatrix}
  \geq 0 \Bigg \},
  \\
  \Sigma^{i,\textnormal{on}}(\alpha)
  &:=
    \Bigg \{ (A,B)
    \mid \begin{bmatrix}
      I_n \\
      A^\top \\
      B^\top
    \end{bmatrix}^\top
  N^{i,{\textnormal{on}}}(\alpha)
  \begin{bmatrix}
    I_n
    \\
    A^\top\\B^\top
  \end{bmatrix}
  \geq 0 \Bigg \}.
\end{align*}
Note that, if a number of quadratic matrix inequalities are satisfied,
then so is any nonnegative combination of them. Therefore, for any
$\alpha_0,\ldots,\alpha_{T^{\textnormal{on}}-1}\geq 0$,
\[
  \Sigma^{\textnormal{on}} \subseteq \Sigma^{\textnormal{on}}(\alpha)
  \textrm{ and } \Sigma^i\cap\Sigma^{\textnormal{on}} \subseteq
  \Sigma^{i,\textnormal{on}}(\alpha).
\]
This provides over-approximations of $ \Sigma^{\textnormal{on}}$ and
$ \Sigma^i\cap\Sigma^{\textnormal{on}}$ in terms of such nonnegative
combinations, allowing us to state the following result.

\begin{lemma}[Parameterized condition for incompatibility with online
  measurements]\label{lem:suff cond for incompatibility}
  Given online measurements
  $(U_-^{\textnormal{on}},X^{\textnormal{on}})$ and $i \in \calP$, if
  there exist $\alpha_0,\ldots,\alpha_{T^{\textnormal{on}}-1}\geq 0$
  such that either
  \begin{enumerate}
  \item\label{item:para 1} $\Sigma^i\cap\Sigma^{ \textnormal{on}}(\alpha)= \emptyset$
    or
  \item\label{item:para 2} $\Sigma^{i, \textnormal{on}}(\alpha)= \emptyset$,
  \end{enumerate}
  then $\Sigma^i\cap\Sigma^{\textnormal{on}}=\emptyset$.
\end{lemma}

This result allows us to test intersections of multiple quadratic sets
for emptiness in terms of a parametrized intersection of either two
such sets using Lemma~\ref{lem:suff cond for
  incompatibility}\ref{item:para 1}, or even one,
using Lemma~\ref{lem:suff cond for incompatibility}\ref{item:para 2}. 
The following result provides a way to efficiently test for
the latter.

\begin{lemma}[Spectral test for incompatibility with online
  measurements]
  Given initialization data $\{(U_-^i,X^i)\}_{i \in \calP}$ and online
  measurements $(U_-^{\textnormal{on}},X^{\textnormal{on}})$, suppose
  $\begin{bmatrix} X_-^i\\U_-^i\end{bmatrix}$ has full row rank for
  $i\in\calP$.  For any $i\ in \calP$ and
  $\alpha_0,\ldots,\alpha_{T^{\textnormal{on}}-1}\geq 0$,
  $\Sigma^{i, \textnormal{on}}(\alpha)\neq \emptyset$ if and only if
  $N^{i,\textnormal{on}}(\alpha)$ has precisely $n+m$ negative
  eigenvalues. Equivalently, given
  \[
    N^{i,{\textnormal{on}}}(\alpha) =
    \begin{bmatrix}
      \bar{N}_{11} & \bar{N}_{12} \\ \bar{N}_{21} & \bar{N}_{22}
    \end{bmatrix},
  \]
  then $\Sigma^{i, \textnormal{on}}(\alpha)\neq \emptyset$ if and only
  if $\bar{N}_{11} -\bar{N}_{12}\bar{N}_{22}^{-1}\bar{N}_{21}\geq 0$.
\end{lemma}
\begin{proof}
  Given that $\bar{N}_{22}<0$ by construction, the statement follows
  from~\cite[Thm. 3.2]{HJVW-MKC-JE-HLT:22}.
\end{proof}

One can use either criteria in Lemma~\ref{lem:suff cond for
  incompatibility} to generalize Algorithm~\ref{alg:mode_detection} to
noisy data in a way that integrates the information provided by
multiple measurements at once. Next, we formalize this using
Lemma~\ref{lem:suff cond for incompatibility}\ref{item:para 1}, where
we take $\alpha = \mathbbm{1} \in \mathbb{R}^{T^{\textnormal{on}}}$,
the vector of all ones.  Recall that, during online operation, we
collect single measurements, with each noise sample satisfying
$\norm{w(t)} \leq q$, for some $q>0$. The set
$\Sigma^{\textnormal{on}}_t$ is then described by~\eqref{eq:def
  Sigonj}.  Consider
\[
  N^{\textnormal{on}}(\mathbbm{1}) = \begin{bmatrix} I_n\!\!
    &X_+\\0\!\!&-X_-\\0\!\!&-U_-
  \end{bmatrix}
  \!\!
  \begin{bmatrix}
    q^2T^{\textnormal{on}}I_n & 0 \\ 0&
    -I_{T^{\textnormal{on}}}
  \end{bmatrix}
  \!\!
  \begin{bmatrix}
    I_n \!\!&X_+\\0\!\!&-X_-\\0\!\!&-U_-
  \end{bmatrix}^\top .
\]
Using the Schur complement, we can conclude that
$(A,B) \in\Sigma^{\textnormal{on}}(\mathbbm{1})$ if and only if
\[
  \begin{bmatrix} q^2 T^{\textnormal{on}} I &
    X^{\textnormal{on}}_+-AX^{\textnormal{on}}_--BU^{\textnormal{on}}_-
    \\
    (X^{\textnormal{on}}_+-AX^{\textnormal{on}}_--BU^{\textnormal{on}}_-)^\top&
    I
  \end{bmatrix}\geq0.
\]
A similar LMI can be obtained to check for whether
$(A,B) \in\Sigma^i$, leading to the following result.

\begin{corollary}[LMI test for incompatibility with online
  measurements]\label{cor:noisy stuff}
  Given online single measurements obtained sequentially, with each
  noise sample satisfying $\norm{w(t)} \leq q$, for some $q>0$, let
  $i \in \calP$ and assume the initialization data $(U_-^i,X^i)$ has
  noise model~\eqref{eq:noise model restricted} with $Q^i = q^2T_i I$.
  If there are no matrices $A$ and $B$ that satisfy simultaneously
  \begin{subequations}\label{noisy_LMI}
    \begin{align}
        \begin{bmatrix}
        q^2T^iI_n&X^i_+-AX^i_--BU^i_-
        \\
        (X^i_+-AX^i_--BU^i_-)^\top& I_{T^i}
      \end{bmatrix}\! & \geq \! 0,
      \\
      \begin{bmatrix}
        q^2T^{\textnormal{on}}I_n&X^{\textnormal{on}}_+-AX^{\textnormal{on}}_--B
        U^{\textnormal{on}}_-
        \\
        (X^{\textnormal{on}}_+-AX^{\textnormal{on}}_--BU^{\textnormal{on}}_-)^\top&
        I_{T^{\textnormal{on}}}
      \end{bmatrix} \! & \geq \! 0, 
    \end{align}
  \end{subequations}
  then the data are incompatible, that is,
  $\Sigma^i\cap\Sigma^{\textnormal{on}}=\emptyset$.
\end{corollary}

\begin{algorithm}[htb!]
  \caption{Mode detection for noisy data}\label{alg:mode_detection_2}
  % \caption{Each time instance of the mode detection algorithm for noisy data}\label{alg:mode_detection_2}
  \algorithmicrequire
  $\calP_{\textrm{match}},\{U^i_-,X^i\}_{i\in\calP},U^{\textnormal{on}}_-,
  X^{\textnormal{on}},c,q$
  \\
  \algorithmicensure
  $\calP_{\textrm{match}},U^{\textnormal{on}}_-,X^{\textnormal{on}}
%  ,f_{\textup{done}}
$
  \begin{algorithmic}[1]           
    % \If{$T^\textnormal{on}\geq t_{\max}$}\LineComment{Maximal online data length}
    % \State $f_{\textup{done}}=1$
    % \Else
    \State Pick a random $u(t)\in\R^m$ such that $\norm{u(t)}\leq c\norm{x(t)}$
    \State Get the next state $x(t+1)$
    \State
    $U_-^{\textnormal{on}}\gets \begin{bmatrix}U_-^{\textnormal{on}}&u(t)\end{bmatrix}$                          
    \State
    $X^{\textnormal{on}}\gets \begin{bmatrix}X^{\textnormal{on}}&
      x(t+1)\end{bmatrix}$ \Comment{Append the data} 
    \For{$i\in\calP_{\textrm{match}}$}  
    \If{the pair of LMIs \eqref{noisy_LMI} is infeasible }                         \LineComment{Data are incompatible with mode $i$}
    \State $\calP_{\textrm{match}}=\calP_{\textrm{match}}\backslash\{i\}$ \Comment{Eliminate mode $i$}
    \EndIf
    \EndFor 
%    \If{$|\calP_{\textrm{match}}|=1$}\LineComment{Mode is detected if only one matches}
%    \State $f_{\textup{done}}=1$
%    \Else
%    \State $f_{\textup{done}}=0$
%    \EndIf
    % \EndIf
  \end{algorithmic}
\end{algorithm}

Algorithm~\ref{alg:mode_detection_2} presents a mode detection
procedure that employs these LMI conditions (instead of the kernel
condition \eqref{eq:kernel} in Algorithm~\ref{alg:mode_detection}) to
check for incompatibility. Also, the inputs at each step of the
algorithm are chosen randomly.

\section{Stabilization phase and detecting
  switches}\label{sec:stabilization}

Having solved the mode detection problem, here we turn our attention
to the stabilization phase.  At the start of this phase, we know the
mode the system is operating in. Therefore, we simply apply the controller computed in the
initialization step, see Section~\ref{sec:initialization},
\begin{align*}
  u=K_ix ,  
\end{align*}
where $i \in \calP$ is the currently active mode.  The controller
remains in the stabilization phase until a switch in the mode of the
system is detected.  As mentioned in the problem formulation,
in Section~\ref{sec:notion}, we consider two scenarios:
\begin{itemize}
\item the switching signal is partially known: the controller is aware
  of when the system switches modes, yet it does not know which mode
  the system has switched into;
\item the switching signal is completely unknown: this means that the
  controller needs to implement a mechanism to detect whether a switch
  has occurred.
\end{itemize}
In either case, once a switch has been detected, to determine the
current active mode, the controller will switch back to the mode
detection phase described in Section~\ref{sec:MD}.

Here we describe a procedure to detect switches in the system mode in
the second scenario above. This consists of monitoring the evolution
of the Lyapunov function, $V_i(x)=x^\top P_i x$, computed in the
initialization step, cf. Section~\ref{sec:initialization}, associated
with the currently active mode $i \in \calP$.  From the triangle
inequality and~\eqref{eqn:informativity for uniform stabilization},
when the system is operating in mode $i$ with the feedback control
$u=K_ix$, and under the noise bound $\norm{w(t)}\leq q$, we have
\begin{align}
  V_i&(x(t+1))=\norm{P_i^{\frac{1}{2}}((\hat{A}_i+\hat{B}_iK_i)x(t)+w(t))}
       \nonumber
  \\
  %	&\leq \norm{P_i^{\frac{1}{2}}(A_i+B_iK_i)x(t)}+\norm{P_i^{\frac{1}{2}}w(t)}\\
  %	&=\sqrt{x(t)^\top(A_i+B_iK_i)^\top P_i(A_i+B_iK_i)x(t)}+\norm{P_i^{\frac{1}{2}}w(t)}\\
  %	&\leq \sqrt{\lambda x(t)^\top P_ix(t)}+\norm{P_i^{\frac{1}{2}}}\norm{w(t)}\\
  %	&\leq \sqrt{\lambda}\norm{P_i^{\frac{1}{2}}x(t)}+\lambda_{\max}(P_i^{\frac{1}{2}})q\\
     &\leq\sqrt{\lambda}V_i(x(t))+\lambda_{\max}(P_i^{\frac{1}{2}})q .
       \label{what_to_obey}
\end{align}
The contrapositive of this statement reads as follows: if the
inequality does \textit{not} hold, then the system cannot be operating
in mode~$i$.  We employ it to detect when the system has switched
between modes, that is, the controller switches to the mode detection
phase whenever
\begin{equation}\label{eq:switch detection}
  V_i(x(t+1))> \sqrt{\lambda}V_i(x(t))+\lambda_{\max}(P_i^{\frac{1}{2}})q.
\end{equation}
Note that the system~\eqref{def:sys} may switch between modes while
the inequality \eqref{what_to_obey} is still preserved. In this case,
the controller applies the controller corresponding to the previously
detected mode, and the mode of the system and the mode of the
controller become desynchronized. As our ensuing technical analysis
shows, this does not affect the stability properties of the
closed-loop system.
% given the fact that \eqref{what_to_obey} holds.
% This means that the Lyapunov function decreases at the rate $\lambda$
% regardless of this desynchronization.


\section{Stabilization via online switched controller}\label{sec:osc}

In this section, we describe our online switched controller design and
establish the asymptotic convergence properties of the resulting
closed-loop switched system.


\subsection{Switched controller design}\label{sec:controller}
Our controller combines the mode detection and the stabilization
phases into a single design, formalized in
Algorithm~\ref{alg:controller_1}, for the case of noisy data and an
unknown switching signal. Next, we provide an intuitive description of
the pseudocode language:
\begin{quote}
  \emph{Informal description:} The algorithm assumes an initialization
  step satisfying Assumptions~\ref{ass:ass_on_data-I}
  and~\ref{ass:ass_on_data-II} has been performed. The algorithm
  starts in the mode detection phase, indicated by the variable
  $S_{\textrm{phase}}$. During this phase,
  Algorithm~\ref{alg:mode_detection_2} is executed for each iteration
  until mode detection is successful (signaled by
  $f_{\textup{done}}=1$). The variable $\sigma_d$ is then taken to be
  the active mode of the system. Next, the algorithm switches to the
  stabilization phase (signaled by $S_{\textrm{phase}}=1$).  During
  this phase, the control input $u(t)=K_{\sigma_d}x(t)$ is applied
  until \eqref{eq:switch detection} holds. This marks the detection of
  a mode switch, which leads the controller to go back to the mode
  detection phase (by toggling $S_{\textrm{phase}}$ to $0$). In the
  meantime, $U_-^{\textnormal{on}}$ and $X^{\textnormal{on}}$ are reset to
  record the new online data.
\end{quote}

\begin{algorithm}[htb!]
  \caption{Data-driven online switched feedback controller for noisy
    data with unknown switching signal}\label{alg:controller_1}
  \algorithmicrequire $\calP,\{U^i_-,X^i,K_i,P_i\}_{i\in\calP},\lambda,c,q$
  %\algorithmicensure $$
  \begin{algorithmic}[1]
%  \State $p_{\max,i}\gets\lambda_{\max}(P_i^{\frac{1}{2}})$
    \State $\calP_{\textrm{match}}\gets\calP$
    %
  \State $S_{\textrm{phase}}$ $\gets 0$ \Comment{Initialize to mode detection phase}
  % \State Pick initial mode $\sigma_d\in\calP$
  %
  \State $X^{\textnormal{on}}\gets x(0)$
  %
  \State $U_-^{\textnormal{on}}\gets []$
  \Comment{Initialize online data}
  %
  \While{the system \eqref{def:sys} is running}
  %
  \If{$S_{\textrm{phase}}$ $=0$}                    \Comment{Mode
    detection phase}
  % 
  \State\label{step: algorithm} Run Algorithm~\ref{alg:mode_detection_2} to update $U^{\textnormal{on}}_-$, $X^{\textnormal{on}}$, and $\calP_{\textrm{match}}$
  % $f_{\textup{done}}$
  % \If{$f_{\textup{done}}=1$}
  \If{$|\calP_{\textrm{match}}|=1$}
  %
  \State Pick
  $\sigma_d\in\calP_{\textrm{match}}$ \label{step:mode_to_switch}
  \Comment{Set the controller mode}
  % 
  \State $S_{\textrm{phase}}$ $\gets 1$                \LineComment{Change controller to stabilization phase}
  % \Else   \If{$\calP_{\textrm{match}}=\emptyset$}
%  \State Terminate with error      \Comment{The case when the online data is incompatible with all initialization data}
%  \EndIf
  \EndIf    
  \Else   \Comment{Stabilization phase}
  \State Apply control $u(t)=K_{\sigma_d}x(t)$ %\Comment{Apply the control with mode $\sigma$}
  \State Obtain the next state $x(t+1)$
  \If{\eqref{eq:switch detection} holds} \label{step:switch detec}   \Comment{Quit stabilization phase}
 \State $U_-^{\textnormal{on}}\gets u(t)$ \Comment{Reset the online data}
 \State $X^{\textnormal{on}}\gets \begin{bmatrix} x(t)&x(t+1)\end{bmatrix}$                 
 \State $\calP_{\textrm{match}}\gets\calP$	\Comment{Reset $\calP_{\textnormal{match}}$}
 \State $S_{\textrm{phase}}$ $\gets 0$             \LineComment{Change controller to mode detection phase}
 \EndIf
 \EndIf
    \State $t\gets t+1$                     \Comment{Update the time}
    \EndWhile
  \end{algorithmic}
\end{algorithm}

Note that the closed-loop system is stable when the controller is in
its stabilization phase. However, during the mode detection phase, the
effect of the controller on the system might be destabilizing because
of the potential mismatch with the system mode.  Therefore,
determining overall stability properties of the
form~\eqref{ISS-estimate_0} relies critically on the switching
behavior, both of the system and the controller.

\begin{remark}[Data-driven online switched feedback controller for
  noiseless data and known switching signal]
  Algorithm~\ref{alg:controller_1} requires minor modifications in (i)
  the noiseless case or (ii) when the switching signal is known. For
  (i), one replaces Algorithm~\ref{alg:mode_detection_2} in
  Step~\ref{step: algorithm} with Algorithm~\ref{alg:mode_detection}
  and takes $q=0$ when evaluating~\eqref{eq:switch detection} in
  Step~\ref{step:switch detec}.  For (ii), one replaces the check in
  Step~\ref{step:switch detec} by the condition
  $\sigma(t+1)\neq\sigma(t)$. \oprocend
\end{remark}

\begin{remark}[Appending the online data to initialization
  measurements]\label{rem:appending}
  Once the mode detection phase is successful, we know that the
  gathered online measurements were generated by the active mode
  $i\in\calP_{\textnormal{match}}$. This raises the possibility of
  incorporating such online data to the initialization measurements
  corresponding to the mode $i\in\calP_{\textnormal{match}}$.
  % that is, we add a command
  % $\Sigma^i \leftarrow
  % \Sigma^i\cap\Sigma^{\textnormal{on}}$.
  Intuitively, this would decrease the size of the set $\Sigma^i$,
  which means that future mode detection phases would require fewer
  online measurements at the cost of having the controller keep
  previous measurements in its memory. \oprocend
\end{remark}

\subsection{Average dwell- and activation-time of switching
  signal}\label{sec:dwell}

In this section, we introduce some assumptions on the switching
frequency of the signal $\sigma$ in order to establish stability
guarantees for the closed-loop system.
% Note that the behavior of the closed-loop system depends on both the
% switching signal $\sigma$ of the system \eqref{def:sys}, but also on
% the switches of the controller, as given by
% Algorithm~\ref{alg:controller_1}.

\begin{assumption}[Properties of the switching signal of the
  controller]\label{ass:detection_after_exercution}
  Let $\bT^m:=\{t_1^m,t_2^m,\cdots\}$ be the ordered set consisting of
  the initial time instants of each mode detection phase. Similarly,
  let $\bT^s:=\{t_1^s,t_2^s,\cdots\}$ correspond to the time instants
  when the stabilization phase starts.  Assume
  \begin{enumerate}
  \item\label{itm:asump 1} the system does not switch while the
    controller is in the mode detection phase;
    % that is, 
    % \[t_1^m<t_1^s<t_2^m<t_2^s<\cdots.\]
  \item\label{itm:asump adt} let $N(t_a,t_b)$ be the total number of
    mode detection phases over the time interval $[t_a,t_b)$, that is,
    $ N(t_a,t_b):= |[t_a,t_b)\cap \bT^m|$. There exists $\tau$ and
    $N_0\geq 1$ such that
    \begin{equation}\label{ADT_condition}
      N(t_a,t_b) \leq N_0+\frac{t_b-t_a}{\tau} ,\quad\forall t_a,t_b\in
      \N, t_a< t_b;
    \end{equation}
    
  \item\label{itm:asump aat} let $M(t_a,t_b)$ be the total time spent
    in mode detection phases over the time interval $[t_a,t_b)$,
    that is, $M(t_a,t_b):=\sum_{t=t_a}^{t_b-1}{\mathbf 1}(t)$, where
    \[
      \mathbf 1 (t):=\begin{cases} 1& \mbox{ if }t\in [t_i^m,t_i^s)
        \mbox{ for some }i\in\N,
        \\
	0&\mbox{ otherwise. }
      \end{cases}
    \] 
    Then, there exists $\eta\in[0,1]$ and $T_0\geq 0$ such that
    \begin{equation}\label{AAT_condition}
      M(t_a,t_b)\leq T_0+\eta(t_b-t_a)\quad\forall t_a,t_b\in \N, t_a< t_b.
    \end{equation}
  \end{enumerate}
\end{assumption}

%We discuss next
%Assumption~\ref{ass:detection_after_exercution}. 
Recall that by
construction, the controller alternates between the mode detection
phase and the stabilization phase. In other words, the elements in
$\bT^m$ and $\bT^s$ are ordered such that
\[
  t_1^m<t_1^s<t_2^m<t_2^s<\ldots
\]
Now, statement~\ref{itm:asump 1} ensures that the collected online
measurements correspond to a single active mode.  From
Corollary~\ref{cor:at-most-n+m}, the time length of each mode
detection phase for noiseless data is bounded above by $n+m$. In
simulations, we have observed that regardless of whether the data are
noisy or noiseless, the mode detection phase is much shorter than this
upper bound.  This means that, as long as the unknown switching signal
does not switch too frequently, statement~\ref{itm:asump 1} holds in
general.

Statement~\ref{itm:asump adt} is an \emph{average dwell-time} (ADT)
condition~\cite{JPH-AM:99} on the mode detection phase. Its
interpretation is that, on average, the controller is switched to the
mode detection phase no more than once per $\tau$ time
instances. Clearly, this condition holds if $\tau$ is relatively
large, or equivalently, if the controller switches infrequently.

Finally, statement~\ref{itm:asump aat} is an \emph{average
  activation-time} (AAT) condition~\cite{MM-DL:12} on the mode
detection phase. Its interpretation is that, on average, the
controller dwells in the mode detection phase for at most a fraction
$\eta$ of the total time. Thus statement~\ref{itm:asump aat} holds if
the mode detection phase is, on average, relatively short when
compared to the stabilization phase. This holds if either the mode
detection phase is short or the system switches infrequently.

\begin{remark}[Relationship with switching of the system]
  Note that Assumption~\ref{ass:detection_after_exercution}(ii) and
  (iii) are formulated for the switching signal $\sigma_d$ associated
  to the controller. However, this is directly related to the
  switching signal $\sigma$ of the system. In fact, let
  \begin{equation*}
    \bT:=\{t\in\N\backslash\{0\}:\sigma(t)\neq\sigma(t-1)\},
  \end{equation*}
  denote the set of time instances at which a system switch occurs. If
  the controller has access to these time instances, then
  $\bT=\bT^m$. Instead, if the switching signal $\sigma$ is unknown,
  this will not be the case in general.  Nevertheless, by definition,
  a switch in the controller mode $\sigma_d$ can occur only if a
  switch in $\sigma$ has occurred.  (and in fact, switches in $\sigma$
  that do not lead to a violation of the
  condition~\eqref{what_to_obey} do not give rise to a switch in
  $\sigma_d$).  This means that, as long as statement~\ref{itm:asump
    1} holds, the switching of the controller is infrequent if the
  system~\eqref{def:sys} switches infrequently.
  % This means that
  % statements \ref{itm:asump adt} and \ref{itm:asump aat} in
  % Assumption~\ref{ass:detection_after_exercution} can be considered
  % as
  % indirect assumptions on the switching frequency of the unknown
  % signal~$\sigma$.
  \oprocend
\end{remark}

\subsection{Stability analysis of the closed-loop
  system}\label{sec:stability}

The following result characterizes the stability properties of the
closed-loop system.

\begin{theorem}[Stability guarantee for the closed-loop
  system]\label{thm:stability_control}
  Consider initialization data $(U_-^i,X^i)$ with, for each
  $i\in\calP$, noise model of the form~\eqref{eq:noise model
    restricted}, $Q^i = q^2T_i I$, for some $q>0$, and satisfying
  Assumptions~\ref{ass:ass_on_data-I} and~\ref{ass:ass_on_data-II}.
  Let online measurements be collected sequentially, with
  $\norm{w(t)}\leq q$ at each time $t$.  Assume that the switching
  signal of the controller satisfies
  Assumption~\ref{ass:detection_after_exercution}.  Let
  \begin{equation}\label{def:mu}
    \mu:=\max_{i,j\in\calP}\Vert P_i^{\frac{1}{2}}P_j^{-\frac{1}{2}}\Vert^2,
  \end{equation}
  and $\lambda_u\geq 1$ be such that for any $i\in\calP$, there exists
  $k_i\geq0$ such that
  \begin{equation}\label{LMI_for_MD}
    \begin{bmatrix}
      \lambda_uP_i-k_i c^2 I_n&0&\hat{A}_i^\top\\
      0&k_iI_m&\hat{B}_i^\top\\
      \hat{A}_i&\hat{B}_i&P_i^{-1}
    \end{bmatrix}\geq 0.
  \end{equation}

  If the following holds
  \begin{equation}\label{ADT_AAT_condition}
    \left(1-\frac{\ln\lambda_u}{\ln\lambda}\right)\eta +
    \left(1-\frac{\ln\mu}{\ln\lambda}\right)\frac{1}{\tau}<1,  
  \end{equation}
  then, for all initial states $x(0)\in\R^n$ and each time $t\in\N$,
  the solution of the closed-loop system~\eqref{def:sys} with the
  data-driven switching feedback controller described by
  Algorithm~\ref{alg:controller_1} satisfies
  \begin{equation}\label{ISS-estimate}
    \norm{x(t)} \leq \frac{p_{\max}}{p_{\min}}a^tb\norm{x(0)} +
    \frac{p_{\max}}{p_{\min}}\frac{ab}{(1-a)\sqrt{\lambda}}q  ,
  \end{equation}
  where
  \begin{subequations}\label{eq:a-b}
    \begin{align}
      a&:=\sqrt{\lambda\left(\frac{\mu}{\lambda}\right)^{\frac{1}{\tau}}
         \left(\frac{\lambda_u}{\lambda}\right)^{\eta}}
         \in(\sqrt{\lambda},1),
         \label{def:a} 
      \\ 
      b&:=\sqrt{\left(\frac{\mu}{\lambda}\right)^{N_0}
         \left(\frac{\lambda_u}{\lambda}\right)^{T_0}} , \label{def:b} 
    \end{align}
  \end{subequations}
  and $p_{\max}=\max_{i\in\calP}\lambda_{\max}(P_i^{\frac{1}{2}})$,
  $ p_{\min}=\min_{i\in\calP}\lambda_{\min}(P_i^{\frac{1}{2}})$.
\end{theorem}

The proof of Theorem~\ref{thm:stability_control} is provided in the
Appendix. Note that, for each $i\in\calP$, the LMI~\eqref{LMI_for_MD}
holds for sufficiently large $\lambda_u$ and $k_i$.  Given
Assumption~\ref{ass:ass_on_data-I}, $\lambda < 1$ is an upper bound on
the decay rate during the stabilization phase. Instead,
$\lambda_u \ge 1$ is an upper bound on the growth rate during the mode
detection phase. The parameter $\mu$ corresponds to the destabilizing
effect introduced by each switching.  The interpretation of
condition~\eqref{ADT_AAT_condition} is as follows: the first term
quantifies the combined effect on the growth rate of the state of the
mode detection and stabilization phases. The second term quantifies
the destabilizing effect of mode switches, which happen on average
every $\tau$ time instances.  For a given switched system, the
constants $\mu$, $\lambda$, and $\lambda_u$ are fixed. Hence, the
condition~\eqref{ADT_AAT_condition} is always satisfied if $\tau$ is
sufficiently large and $\eta$ is sufficiently small. This means that
the ISS-like property~\eqref{ISS-estimate} holds as long as the system
switches sufficiently infrequently and the mode detection phases are
sufficiently short.


\begin{figure*}[ht!]
  \tikzset{every picture/.style={scale=0.66}}
  \centering
  \subfigure[]{\input{tex/switching_signal.tex}}
  % 
  \subfigure[]{
    \input{tex/phases.tex}}
  % 
  \subfigure[]{
    \input{tex/state_traj.tex}}
  \caption{Unknown switched linear system with $5$ states, $3$ inputs,
    and $ 5$ modes evolving under the data-driven online switched
    feedback controller of Algorithm~\ref{alg:controller_1}.
    Simulations correspond to the case with noiseless data and the
    controller knowing when the system switches between modes. Plot (a) shows the
    switching signals of the system ($\sigma$) and of the controller
    ($\sigma_d$). Meanwhile, (b) plots the active (mode detection or
    stabilization) phase of the controller across time. Lastly, (c) shows the
    semi-logarithmic plot of the norm of the state as a function of time.
  }\label{fig:example}
\end{figure*}

\begin{figure*}[ht!]
  \tikzset{every picture/.style={scale=0.66}}
  \centering
  \subfigure[]{\input{tex/switching_signal_1.tex}}
  % 
  \subfigure[]{
    \input{tex/phases_1.tex}}
  % 
  \subfigure[]{
    \input{tex/state_traj_1.tex}}
  \caption{Simulation results for the system considered in
    Figure~\ref{fig:example} with the same noiseless data, but with a
    switching signal completely unknown to the
    controller.}\label{fig:example1}
\end{figure*}

\begin{figure*}[ht!]
  \tikzset{every picture/.style={scale=0.66}}
  \centering
  \subfigure[]{\input{tex/switching_signal_2.tex}}
  % 
  \subfigure[]{
    \input{tex/phases_2.tex}}
  % 
  \subfigure[]{
    \input{tex/state_traj_2.tex}}
  \caption{Unknown switched linear system with $5$ states, $3$ inputs,
    and $ 5$ modes evolving under the data-driven online switched
    feedback controller in Algorithm~\ref{alg:controller_1}.
    Simulations correspond to the case with noisy data (with
    measurement noise bounded by $q=0.01$) and the controller knowing
    when the system switches modes. Plot (a) shows the switching signals of
    the system ($\sigma$) and of the controller ($\sigma_d$). In (b) we
    plot the active (mode detection or stabilization) phase of the
    controller across time. Lastly, (c) shows  the
    semi-logarithmic plot of the state norm  as a function of time.
    % (c) shows the resulting state trajectories.  
  }\label{fig:example2}
\end{figure*}

\begin{figure*}[ht!]
  \tikzset{every picture/.style={scale=0.66}}
  \centering
  \subfigure[]{\input{tex/switching_signal_3.tex}}
  % 
  \subfigure[]{
    \input{tex/phases_3.tex}}
  % 
  \subfigure[]{
    \input{tex/state_traj_3.tex}}
  \caption{Simulation results for the system considered in
    Figure~\ref{fig:example2} with the same noisy data, but with a
    switching signal completely unknown to the controller.
  }\label{fig:example3}
\end{figure*}

\section{Simulation results}\label{sec:simulation}

We illustrate the performance of the proposed data-driven switching
feedback controller through 4 simulation experiments of an unknown
switched linear system with $n=5$ states, $m=3$ inputs, and $p=5$
modes. The system matrices $\hat{A}_i, \hat{B}_i$ are randomly
selected and given by
%
\footnotesize\begin{align*}
\hat{A}_1&\!=\!\begin{bmatrix}
	-0.73   \hspace{-1em}&-0.68   \hspace{-1em}&-0.03   \hspace{-1em}&-1.34   \hspace{-1em}&-0.20\\
	-0.26    \hspace{-1em}&\hphantom{-}0.27    \hspace{-1em}&\hphantom{-}0.18   \hspace{-1em}&-0.02    \hspace{-1em}&\hphantom{-}0.79\\
	-0.00   \hspace{-1em}&-0.15   \hspace{-1em}&-0.09   \hspace{-1em}&-0.13    \hspace{-1em}&\hphantom{-}0.46\\
	\hphantom{-}0.55    \hspace{-1em}&\hphantom{-}0.01   \hspace{-1em}& \hphantom{-}0.47    \hspace{-1em}&\hphantom{-}0.85    \hspace{-1em}&\hphantom{-}0.42\\
	-0.24    \hspace{-1em}&\hphantom{-}0.38   \hspace{-1em}&-0.17    \hspace{-1em}&\hphantom{-}0.81    \hspace{-1em}&\hphantom{-}0.05
\end{bmatrix} \hspace{-1em}&\hspace{-1em}
\hat{B}_1&\!=\!\begin{bmatrix}
	-0.38    \hspace{-1em}&\hphantom{-}0.56    \hspace{-1em}&\hphantom{-}0.70\\
	-0.36   \hspace{-1em}&-0.91   \hspace{-1em}&-0.81\\
	\hphantom{-}0.42   \hspace{-1em}&-1.15    \hspace{-1em}&\hphantom{-}0.57\\
	\hphantom{-}0.54   \hspace{-1em}&-0.52    \hspace{-1em}&\hphantom{-}1.69\\
	\hphantom{-}0.38   \hspace{-1em}&-0.80   \hspace{-1em}&-0.88
\end{bmatrix} \hspace{-1em} \\
\hat{A}_2&\!=\!\begin{bmatrix}
	\hphantom{-}0.26   \hspace{-1em}&-0.03    \hspace{-1em}&\hphantom{-}0.67    \hspace{-1em}&\hphantom{-}0.77   \hspace{-1em}&-0.00\\
	-0.02    \hspace{-1em}&\hphantom{-}0.46    \hspace{-1em}&\hphantom{-}0.10    \hspace{-1em}&\hphantom{-}0.48    \hspace{-1em}&\hphantom{-}0.54\\
	-0.15   \hspace{-1em}&-0.07   \hspace{-1em}&-0.17    \hspace{-1em}&\hphantom{-}0.51   \hspace{-1em}&-0.15\\
	\hphantom{-}0.43   \hspace{-1em}&-0.37   \hspace{-1em}&-1.01   \hspace{-1em}&-0.36    \hspace{-1em}&\hphantom{-}0.32\\
	\hphantom{-}0.00    \hspace{-1em}&\hphantom{-}0.21    \hspace{-1em}&\hphantom{-}0.90    \hspace{-1em}&\hphantom{-}0.11    \hspace{-1em}&\hphantom{-}0.12
\end{bmatrix} \hspace{-1em}&\hspace{-1em}
\hat{B}_2&\!=\!\begin{bmatrix}
	\hphantom{-}1.59    \hspace{-1em}&\hphantom{-}1.26   \hspace{-1em}&-1.04\\
	\hphantom{-}0.73    \hspace{-1em}&\hphantom{-}1.62   \hspace{-1em}&-0.42\\
	\hphantom{-}0.96   \hspace{-1em}&-0.54    \hspace{-1em}&\hphantom{-}0.73\\
	\hphantom{-}0.85    \hspace{-1em}&\hphantom{-}0.90    \hspace{-1em}&\hphantom{-}1.51\\
	-0.12   \hspace{-1em}&-0.78    \hspace{-1em}&\hphantom{-}0.00
\end{bmatrix} \hspace{-1em}\\
\hat{A}_3&\!=\!\begin{bmatrix}
	-0.25    \hspace{-1em}&\hphantom{-}0.52    \hspace{-1em}&\hphantom{-}0.39    \hspace{-1em}&1.15   \hspace{-1em}&-0.29\\
	\hphantom{-}0.29    \hspace{-1em}&\hphantom{-}0.28   \hspace{-1em}&-0.21    \hspace{-1em}&\hphantom{-}0.18    \hspace{-1em}&\hphantom{-}0.36\\
	-0.19   \hspace{-1em}&-0.40   \hspace{-1em}&-0.16    \hspace{-1em}&1.19   \hspace{-1em}&-0.08\\
	-0.03    \hspace{-1em}&\hphantom{-}0.72   \hspace{-1em}&-0.80    \hspace{-1em}&\hphantom{-}0.21   \hspace{-1em}&-0.66\\
	\hphantom{-}0.19    \hspace{-1em}&\hphantom{-}0.09   \hspace{-1em}&-0.08    \hspace{-1em}&\hphantom{-}0.00    \hspace{-1em}&\hphantom{-}0.22
\end{bmatrix} \hspace{-1em}&\hspace{-1em}
\hat{B}_3&\!=\!\begin{bmatrix}
	\hphantom{-}2.04   \hspace{-1em}&-0.29    \hspace{-1em}&\hphantom{-}0.10\\
	\hphantom{-}0.20   \hspace{-1em}&-2.00   \hspace{-1em}&-0.19\\
	-0.12   \hspace{-1em}&-2.62    \hspace{-1em}&\hphantom{-}0.50\\
	\hphantom{-}0.76    \hspace{-1em}&\hphantom{-}0.71    \hspace{-1em}&\hphantom{-}0.34\\
	-2.52    \hspace{-1em}&\hphantom{-}0.01    \hspace{-1em}&\hphantom{-}0.94
\end{bmatrix} \hspace{-1em}\\
\hat{A}_4&\!=\!\begin{bmatrix}
	\hphantom{-}0.18    \hspace{-1em}&\hphantom{-}0.22    \hspace{-1em}&\hphantom{-}0.16   \hspace{-1em}&-0.20    \hspace{-1em}&\hphantom{-}0.64\\
	-0.07    \hspace{-1em}&\hphantom{-}0.58    \hspace{-1em}&\hphantom{-}0.99   \hspace{-1em}&-0.12    \hspace{-1em}&\hphantom{-}0.66\\
	\hphantom{-}0.41    \hspace{-1em}&\hphantom{-}0.27    \hspace{-1em}&\hphantom{-}0.24    \hspace{-1em}&\hphantom{-}0.40   \hspace{-1em}&-0.36\\
	\hphantom{-}0.36   \hspace{-1em}&-0.33    \hspace{-1em}&\hphantom{-}0.80   \hspace{-1em}&-0.05    \hspace{-1em}&\hphantom{-}0.35\\
	\hphantom{-}0.04    \hspace{-1em}&\hphantom{-}0.09   \hspace{-1em}&-0.83   \hspace{-1em}&-0.21    \hspace{-1em}&\hphantom{-}0.04
\end{bmatrix}\hspace{-1em}& \hspace{-1em}
\hat{B}_4&\!=\!\begin{bmatrix}
	\hphantom{-}0.47    \hspace{-1em}&\hphantom{-}0.95   \hspace{-1em}&-0.41\\
	-1.07    \hspace{-1em}&\hphantom{-}0.37    \hspace{-1em}&\hphantom{-}0.53\\
	-0.50    \hspace{-1em}&\hphantom{-}1.14    \hspace{-1em}&\hphantom{-}1.77\\
	-0.61    \hspace{-1em}&\hphantom{-}0.12   \hspace{-1em}&-1.93\\
	-0.99    \hspace{-1em}&\hphantom{-}1.88    \hspace{-1em}&\hphantom{-}2.02
\end{bmatrix} \hspace{-1em}\\
\hat{A}_5&\!=\!\begin{bmatrix}
	\hphantom{-}0.27    \hspace{-1em}&\hphantom{-}0.09    \hspace{-1em}&\hphantom{-}0.87    \hspace{-1em}&\hphantom{-}0.28   \hspace{-1em}&-0.10\\
	-0.54    \hspace{-1em}&\hphantom{-}0.44    \hspace{-1em}&\hphantom{-}0.25    \hspace{-1em}&\hphantom{-}0.35    \hspace{-1em}&\hphantom{-}0.04\\
	\hphantom{-}0.53   \hspace{-1em}&-0.37    \hspace{-1em}&\hphantom{-}0.00    \hspace{-1em}&\hphantom{-}0.36   \hspace{-1em}&-0.49\\
	\hphantom{-}0.16    \hspace{-1em}&\hphantom{-}0.20    \hspace{-1em}&\hphantom{-}0.00    \hspace{-1em}&\hphantom{-}0.67    \hspace{-1em}&\hphantom{-}0.26\\
	-0.10   \hspace{-1em}&-0.42   \hspace{-1em}&-0.08   \hspace{-1em}&-0.48   \hspace{-1em}&-0.14
\end{bmatrix}&\hspace{-1em}
\hat{B}_5&\!=\!\begin{bmatrix}
	-0.86    \hspace{-1em}&\hphantom{-}0.58   \hspace{-1em}&-1.38\\
	\hphantom{-}1.52   \hspace{-1em}&-0.54   \hspace{-1em}&-2.46\\
	-0.74   \hspace{-1em}&-1.00    \hspace{-1em}&\hphantom{-}0.16\\
	-2.31    \hspace{-1em}&\hphantom{-}1.47   \hspace{-1em}&-0.55\\
	\hphantom{-}0.44   \hspace{-1em}&-1.91    \hspace{-1em}&\hphantom{-}0.16
\end{bmatrix}
\end{align*}\normalsize

For all simulations, we select the same switching signal $\sigma$, shown as
the blue curve in Figure~\ref{fig:example}(a) through
Figure~\ref{fig:example3}(a). On average, this signal has 1 switch per 20 
units of time. Each of the 4 simulations has as initial condition
$x(0)=\begin{bmatrix} 1000 &0&0&0&0
\end{bmatrix}^\top$.

In the first two simulations, a noiseless data pair $(U^i_-,X^i)$ with
$T^i=7$ is collected in the initialization step for each mode
$i \in \calP = \{1,\dots,5\}$. Note that $n+m=8$, and hence it is 
impossible to uniquely determine the dynamics of the modes from these 7
measurements. We set $\lambda=0.8$ as the desired decay rate for each mode
and note that both Assumptions~\ref{ass:ass_on_data-I}
and~\ref{ass:ass_on_data-II} are satisfied on the initial
data. Moreover, with $c=0.1$, it can be computed that $\mu=1.26$,
(see \eqref{def:mu}), and the LMI~\eqref{LMI_for_MD} holds with
$\lambda_u=5.86$. We apply our proposed data-driven controller: in the
first simulation, shown in Figure~\ref{fig:example}, the controller is
aware of when the systems switches and in the second simulation,
shown in Figure~\ref{fig:example1}, the switching signal is unknown. In
both cases, we run the mode detection algorithm for noiseless data,
that is Algorithm~\ref{alg:mode_detection}.

Comparing Figure~\ref{fig:example}(a) and
Figure~\ref{fig:example1}(a), we observe that the switching signals
$\sigma_d$ of the controller generated in the two different scenarios
are almost the same, meaning that the condition \eqref{what_to_obey}
with $q=0$ is effective in detecting switches. When $\sigma_d(t)$ is
not equal to $\sigma(t)$, the controller is operating in the mode
detection phase, as seen in Figure~\ref{fig:example}(b) and
Figure~\ref{fig:example1}(b). One can see that for both simulations,
$\sigma_d$ switches at the same rate as $\sigma$; in particular, when
$\sigma$ is unknown in the second simulation, switches are always
immediately detected, implying that the controller changes to the mode
detection phase whenever $\sigma$ changes value. Moreover, each
instance of the mode detection phase takes 2 units of time.

This also implies that Assumption~\ref{ass:detection_after_exercution}
holds with parameters $\tau=20$ and $\eta=0.1$.  As a result,
\begin{equation*}
	    \left(1-\frac{\ln\lambda_u}{\ln\lambda}\right)\eta +
	\left(1-\frac{\ln\mu}{\ln\lambda}\right)\frac{1}{\tau}=0.9942<1.
\end{equation*}
Therefore, the condition~\eqref{ADT_AAT_condition} is met and hence,
by Theorem~\ref{thm:stability_control}, the closed-loop
system~\eqref{def:sys} satisfies~\eqref{ISS-estimate}. Since the data
is noiseless ($q=0$), the system is actually asymptotically
stable. This is indeed reflected by the plots of the norms of the
trajectories, as shown in Figures~\ref{fig:example}(c)
and~\ref{fig:example1}(c).

In the third and fourth simulations, we assume the measurements are
corrupted with noise of magnitude $q=0.01$. During the initialization
step, a noisy data pair $(U^i_-,X^i)$ with $T^i=9$ is collected for
each mode.
%The larger $T$ ensures the feasibility
%of~\eqref{eqn:common_K_LMI} in Theorem~\ref{thm:common_K}. Empirically
%speaking, due to the presence of the noise $w$, we need more
%measurements of the data to ``better'' know the system.
% and we need a less conservative LMI~\eqref{eqn:common_K_LMI} in
% order for Assumptions~\ref{ass:ass_on_data-I} and
% \ref{ass:ass_on_data-II} to hold.
The desired decay rate is again $\lambda=0.8$ and it can be verified
that both Assumptions~\ref{ass:ass_on_data-I}
and~\ref{ass:ass_on_data-II} are satisfied on the initial
data. Moreover, with $c=1$, it can be computed that $\mu=2.14$, 
and the LMI~\eqref{LMI_for_MD} holds with
$\lambda_u=264$. We remark that a value of $c$ larger than in the
noiseless simulations is needed in order to distinguish the inputs
from the noise. Similar to the previous two examples, we study the
performance of the data-driven controller in the scenarios with
knowledge of when the system mode switches,
shown in Figure~\ref{fig:example2}, and when the switching signal is
unknown, shown in Figure~\ref{fig:example3}. As suggested by
Figures~\ref{fig:example2}(b) and~\ref{fig:example3}(b), the presence
of noise increases the duration of the mode detection phase. In both
simulations, we obtain $\eta= 0.22$.

Comparing Figures~\ref{fig:example3}(a) and~\ref{fig:example3}(b), one
can see that the delay between $\sigma$ and $\sigma_d$ is not equal to
the length of the mode detection phase. This difference precisely
corresponds to the time required to detect the switch (note that
instantaneous convergence of the states is still guaranteed by
\eqref{what_to_obey}). In this case, we have
\begin{equation*}
  \left(1-\frac{\ln\lambda_u}{\ln\lambda}\right)\eta +
  \left(1-\frac{\ln\mu}{\ln\lambda}\right)\frac{1}{\tau}= 5.94>1,
\end{equation*}
i.e., the condition~\eqref{ADT_AAT_condition} is not met.
Nevertheless, the behavior displayed by the trajectories in
Figures~\ref{fig:example2}(c) and~\ref{fig:example3}(c), with
oscillations (that are bounded) in the stabilization phase due to the
noise, suggests ISS-like stability with respect to~$q$.

\section{Conclusions}\label{sec:conclusion}
We have considered the problem of stabilizing an unknown switched
linear system on the basis of measured data. Prior to the online
operation of the switched system, we have access to measurements of
each of the individual modes. We have derived conditions in terms of
linear matrix inequalities under which this pre-collected data is
informative enough for finding a uniformly stabilizing controller for
each mode. Once the system is running, we have access to online
measurements of the currently active mode. Our online switched
controller design alternates between a phase that performs mode
detection on the basis of the online measurements and a stabilization
phase that exploits this identification. Under average dwell- and
activation-time assumptions on the switching signal, the proposed
controller guarantees an input-to-state-like stability property of the
closed-loop switched system. Our technical exposition has dealt with
both noiseless and noisy measurements, and the cases when the
controller knows the switching times of the system or has complete
lack of knowledge about them. Future research will investigate
methods of input design in the presence of noise to accelerate mode
detection, develop measures of informativity of online measurements to
keep the most useful data stored and integrate it in the mode
detection phase, and exploit recently collected online measurements
with those collected before to detect switches even during the mode
detection phase.


\bibliography{../bib/alias,../bib/JC,../bib/Main,../bib/Main-add,../bib/New,../bib/FB}
\bibliographystyle{IEEEtran}

\appendix

\section*{Proof of Theorem~\ref{thm:common_K}}

We prove the result following the arguments in the proof of
\cite[Theorem~5.1.(a)]{HJVW-MKC-JE-HLT:22} with the necessary
adjustments. We are interested in characterizing when
\eqref{eqn:informativity for uniform stabilization} holds.
% that is,
% \[
%   (A+BK)^\top P (A+BK)\prec\lambda P \quad\forall
%   (A,B)\in\Sigma(U_-,X).
% \]
Applying the Schur complement, we see that
$(A+BK)^\top P (A+BK)\prec\lambda P$ is equivalent to
\[
  \begin{bmatrix}\lambda P &(A+BK)^\top\\(A+BK) &
    P^{-1}\end{bmatrix}\succ 0.
\]
Defining $Q= P^{-1}$ and using the Schur complement again this holds
if and only if
\[
  \lambda Q-(A+BK)Q(A+BK)^\top \succ 0.
\]
Define then the matrix
\[
  M:=\left[
    \begin{array}{c;{2pt/2pt}cc}
      \lambda
      Q&0&0
      \\
      \hdashline[2pt/2pt] 0
       &- Q&- QK^\top
      \\
      0&-K
      Q&-KQK^\top\end{array}\right],
\]
Given the above reasoning and the description of $\Sigma(U_-,X)$
in~\eqref{eq:Sigma as QMI}, one has that \eqref{eqn:informativity for
  uniform stabilization} is equivalent to
\[
  \begin{bmatrix} I_n \\ A^\top \\ B^\top \end{bmatrix}^\top
  N \begin{bmatrix} I_n \\ A^\top \\ B^\top \end{bmatrix} = 0
  \implies \begin{bmatrix} I_n \\ A^\top \\ B^\top \end{bmatrix}^\top
  M\begin{bmatrix} I_n \\ A^\top \\ B^\top \end{bmatrix} \succ 0,
\]
where $N$ is given
by~\eqref{def:N}. Using~\cite[Cor. 4.13]{HJVW-MKC-JE-HLT:22},
this holds if and only if there exists $\alpha\geq 0$ and $\beta>0$
such that
\begin{equation*}%\label{reduced_common_K_LMI}
  M-\alpha N\succeq
  \begin{bmatrix}
    \beta I_n &0 \\ 0&0
  \end{bmatrix}.
\end{equation*}
Let $K:=LQ^{-1}$.  Again using a Schur complement argument,  this is
equivalent to 
\[
  \begin{bmatrix} \!\lambda Q\!-\!\beta I_n\!\!\!& 0 & 0 &0\\0&0&0
    &Q\\0&0&0&L\\0&Q&L^\top &Q
\end{bmatrix}-\alpha \begin{bmatrix} N & 0 \\ 0& 0 \end{bmatrix}
\succeq 0.
\]
For this to hold, it must be that $\alpha\neq 0$.  As such, we can
scale $Q$ and $\beta$ to arrive at~\eqref{eqn:common_K_LMI}, and this
concludes the proof.

\section*{Proof of Theorem~\ref{thm:stability_control}}
To prove Theorem~\ref{thm:stability_control}, we construct two
discrete timers to deal with the ADT and AAT conditions.  Using timers
for handling these conditions is a common approach in the study of
switched systems and in fact similar timers can also be found
in~\cite{GY-DL:15,JIP-ART:17}.  For the ADT condition, the timer
$\tau_d$ provides a mechanism for keeping track of to what extent the
system behavior is in line with the assumption that we have $1/\tau$ switches
per unit time.  Similarly, for the AAT condition, the timer $\tau_a$
provides a mechanism for keeping track of to what extent the system
behavior is in line with the assumption spending a fraction $\eta$ of
the total time in the mode detection phase.
% Intuitively speaking, each switch will reduce the monotonically
% increasing value of a timer $\tau_d$ by a fixed number; switches are
% not allowed if this reduction causes $\tau_d$ to be negative.  By
% doing so, the ADT condition~\eqref{ADT_condition} on the switching
% signal is ensured. Similarly, each time the controller dwells in the
% mode detection phase will reduce the monotonically increasing value
% of a timer $\tau_a$ by a fixed number; further dwelling in the mode
% detection phase is not allowed if this reduction causes $\tau_a$ to
% be negative. By doing so, the AAT condition~\eqref{AAT_condition} on
% the switching signal is ensured.

\begin{lemma}[Discrete timers for ADT and AAT
  conditions]\label{lem:timers}
  Assume the system does not switch while the controller is in the
  mode detection phase.  Then,
  Assumption~\ref{ass:detection_after_exercution}\ref{itm:asump adt}
  implies that there exists a timer $\tau_d:\N\mapsto[0,N_0]$ such
  that
  \begin{subequations}\label{def:tau_d}
    \begin{align}
      \tau_d(t+1)&
                   =\tau_d(t)+\frac{1}{\tau}-1
      &&\mbox{ if } t\in
         \bT^m,\label{def:tau_d_jump}
      \\ 
      \tau_d(t+1)&\in\big[\tau_d(t),\tau_d(t)+\frac{1}{\tau}\big]
      &&\mbox{ otherwise}.\label{def:tau_d_flow}
    \end{align}
  \end{subequations}
  Similarly
  Assumption~\ref{ass:detection_after_exercution}\ref{itm:asump aat}
  implies that there is a timer $\tau_a:\N\mapsto[0,N_0]$ such that
  \begin{subequations}\label{def:tau_a}
    \begin{align}
      \tau_a(t+1)&=\tau_a(t)+\eta-1&&\mbox{ if
                                      }t\in\{t_i^m,\cdots,t_i^s-1\},i\in\N,\label{def:tau_a_unstable}
      \\ 
      \tau_a(t+1)&\in\big[\tau_a(t),\tau_a(t)+\eta]&&\mbox{
                                                      otherwise}.\label{def:tau_a_stable} 
    \end{align}
  \end{subequations}
\end{lemma}
\begin{proof}%[Proof of Lemma~\ref{lem:timers}]
  We study the ADT condition first. Let
  \begin{equation}
    n_d(t):=\min_{s=0,\ldots,t} \{N(0,s)-\frac{s}{\tau}\}.
  \end{equation}
  By definition $n_d(t)$ is non-increasing. We claim that
  \[\tau_d(t):=N_0+n_d(t)-(N(0,t)-\frac{t}{\tau})\]
  satisfies \eqref{def:tau_d}. Clearly, it follows from the definition
  of $n_d(t)$ that $\tau_d(t)\leq N_0$.  Also, for $s=0,\ldots,t$, we
  have
  \begin{multline*}
    N_0+(N(0,s)-\frac{s}{\tau})-(N(0,t)-\frac{t}{\tau})
    \\
    =N(0,s)+\big(\frac{t-s}{\tau}+N_0\big)-N(0,t)
    \\
    \geq N(0,s)+N(s,t)-N(0,t)=0.
  \end{multline*}
  Hence the range of $\tau_d$ is $[0,N_0]$.  To verify that
  \eqref{def:tau_d_jump} holds, let $t\in\bT^m$. In this case, we have
  $N(0,t+1)=N(0,t)+1$. Since $\tau\geq 1$,
  \[
    N(0,t+1)-\frac{t+1}{\tau}\geq N(0,t)-\frac{t}{\tau}\geq n_d(t).
  \]
  This implies that $n_d(t+1)=n_d(t)$, and hence 
  \begin{multline*}
    \tau_d(t+1)-\tau_d(t)
    \\
    =(n_d(t+1)-n_d(t))-(N(0,t+1)-N(0,t)-\frac{1}{\tau})=\frac{1}{\tau}-1,
  \end{multline*}
  concluding~\eqref{def:tau_d_jump}. We now consider the
  case where $t\not\in\bT^m$. Note that by definition
  $N(0,t+1)=N(0,t)$. Direct inspection yields
  \begin{equation}\label{adt_one_side}
    \tau_d(t+1)-\tau_d(t)=(n_d(t+1)-n_d(t))+\frac{1}{\tau}\leq\frac{1}{\tau}.
  \end{equation}
  Meanwhile, note that $n_d(t+1)<n_d(t)$ if and only if
  $N(0,t+1)-\frac{t+1}{\tau}< n_d(t)$, in which case
  \begin{multline*}
    n_d(t+1)-n_d(t)=N(0,t+1)-\frac{t+1}{\tau}- n_d(t)\\
    \geq
    (N(0,t+1)-\frac{t+1}{\tau})-(N(0,t)-\frac{t}{\tau})=-\frac{1}{\tau} ,
  \end{multline*}
  and consequently,
  \begin{equation}\label{adt_another_side}
    \tau_d(t+1)-\tau_d(t)\geq 0 .
  \end{equation}
  Therefore, \eqref{def:tau_d_flow} follows from~\eqref{adt_one_side}
  and~\eqref{adt_another_side}.
  
  To study the AAT condition, we define
  \begin{equation}
    n_a(t):=\min_{s=0,\ldots,t} \{ M(0,s)-\eta s \}.
  \end{equation}
  By definition $n_a(t)$ is non-increasing. We claim that
  \[
    \tau_a(t):=T_0+n_a(t)-(M(0,t)-\eta t)
  \]
  satisfies \eqref{def:tau_a}. Clearly it follows from the definition
  of $n_a(t)$ that $\tau_a(t)\leq T_0$. Moreover, for $s=0,\ldots,t$,
  \begin{multline*}
    T_0+(M(0,s)-\eta s)-(M(0,t)-\eta t)\\
    =M(0,s)+(\eta(t-s)+T_0)-M(0,t)\\
    \geq M(0,s)+M(s,t)-N(0,t)=0.
  \end{multline*}
  Hence the range of $\tau_a$ is indeed $[0,T_0]$. To verify
  \eqref{def:tau_a_unstable}, we first assume
  $t\in\{t_i^m,\cdots,t_i^s-1\}$ for some $i\in\N$. In this case we
  have $M(0,t+1)=M(0,t)+1$. Since $\eta\in[0,1]$, we have that
  $M(0,t+1)-\eta(t+1)\geq M(0,t)-\eta t$. In turn, this implies that
  $n_a(t+1)=n_a(t)$. Therefore we can conclude
  \begin{multline*}
    \tau_a(t+1)-\tau_a(t)
    \\
    =(n_a(t+1)-n_a(t))-(M(0,t+1))-M(0,t)-\eta)=\eta-1,
  \end{multline*}
  proving~\eqref{def:tau_a_unstable}. We move our
  attention to the case where $t\in\{t_i^s,\cdots,t_{i+1}^m-1\}$ for
  some $i\in\N$. We have $N(0,t+1)=N(0,t)$ and hence
  \begin{equation}\label{aat_one_side}
    \tau_a(t+1)-\tau_a(t)=(n_a(t+1)-n_a(t))+\eta\leq \eta.
  \end{equation}
  On the other hand, note that $n_a(t+1)<n_a(t)$ only if
  $M(0,t+1)-\eta(t+1)<n_a(t)$. Therefore, we can conclude
  \begin{multline*}
    n_a(t+1)-n_a(t)=M(0,t+1)-\eta(t+1)-n_a(t)\\
    \geq (M(0,t+1)-\eta(t+1))-(M(0,t)-\eta t)=-\eta.
  \end{multline*}
  In turn, this implies that
  \begin{equation}\label{aat_another_side}
    \tau_a(t+1)-\tau_a(t)\geq 0.
  \end{equation}
  We can now conclude \eqref{def:tau_a_stable} by combining
  \eqref{aat_one_side} and \eqref{aat_another_side}.
\end{proof}

We rely on Lemma~\ref{lem:timers} to prove 
Theorem~\ref{thm:stability_control} next.

\begin{proof}[Proof of Theorem~\ref{thm:stability_control}]
  Construct two timers $\tau_d:\N\mapsto[0,N_0]$,
  $\tau_a:\N\mapsto[0,T_0]$ as in Lemma~\ref{lem:timers}.  Denote the
  extended state at time~$t$,
  \begin{equation}
    \xi(t):=\begin{pmatrix}
      x(t)\\
      \sigma_d(t)\\
      \tau_d(t)\\
      \tau_a(t)
    \end{pmatrix}\in\R^n\times\calP\times[0,N_0]\times[0,T_0]=:\calX.
  \end{equation}
  Further define functions $U,V,W:\calX\mapsto \R_{\geq 0}$ by
  \begin{align*}
    U(\xi)&:=\sqrt{\Big(\frac{\mu}{\lambda}\Big)^{\tau_d}
            \Big(\frac{\lambda_u}{\lambda}\Big)^{\tau_a}},    
    \\
    V(\xi)&:=V_{\sigma_d}(x)=\norm{P_{\sigma_d}^{\frac{1}{2}}x},
    \\
    W(\xi)&:=U(\xi)V(\xi) .
  \end{align*}
  Note that since $\mu\geq 1$, $\lambda_u\geq 1$ and $0<\lambda<1$, we
  have that $U$ is increasing with respect to both $\tau_d$ and
  $\tau_a$, and $a\geq \sqrt{\lambda}$, where $a$ is defined in
  \eqref{def:a}. In addition, since
  $\tau_d\in[0,N_0],\tau_a\in[0,T_0]$, we see that
  \[
    U(\xi)\in\left[1,\sqrt{
        \Big(\frac{\mu}{\lambda}\Big)^{N_0}\Big(\frac{\lambda_u}{\lambda}\Big)^{T_0}}\right]
    = [1,b],
  \]
  where $b$ is defined in \eqref{def:b}.  It follows from
  \eqref{ADT_AAT_condition} that
  \begin{align*}
    \ln
    a &=
        \frac{1}{2}\left(\ln\lambda+(\ln\mu-\ln\lambda)\frac{1}{\tau}+(\ln\lambda_u-\ln\lambda)\eta\right) 
    \\
      &= \frac{\ln\lambda}{2}
        \left(1-\big(1-\frac{\ln\mu}{\ln\lambda}\big)\frac{1}{\tau}-\big(1-\frac{\ln\lambda_u}{\ln\lambda}\big)\eta\right)<0.  
  \end{align*}
  Therefore we have that $a<1$. We now investigate the one-step change
  of the function $t \mapsto W(\xi(t))$ in three separate cases.

  1) The case $t\in \bT^m$; that is, a switch is detected at
  time~$t$. In this case, the controller has switched to the mode
  detection phase.  We apply the Schur complement on
  \eqref{LMI_for_MD} to deduce that
  \begin{equation*}
    \begin{bmatrix}
      \lambda_u P_i&0\\0&0
    \end{bmatrix}-\begin{bmatrix}
      \hat{A}_i&\hat{B}_i
    \end{bmatrix}^\top P_i\begin{bmatrix}
      \hat{A}_i&\hat{B}_i
    \end{bmatrix}-k_i\begin{bmatrix}
      c^2I_n&0\\0&-I_n
    \end{bmatrix}\geq 0.
  \end{equation*}
  Since $k_i\geq 0$, for any $x\in\R^n,u\in\R^m$ such that
  \begin{equation}\label{S_procedure_condition}
    \begin{bmatrix}
      x\\u
    \end{bmatrix}^\top\begin{bmatrix}
      c^2I&0\\0&-I
    \end{bmatrix}\begin{bmatrix}
      x\\u
    \end{bmatrix}\geq 0,
  \end{equation}
  it must be that 
  \begin{equation}\label{S_procedure_result}
    \begin{bmatrix}
      x\\u
    \end{bmatrix}^\top\left(\begin{bmatrix}
        \lambda_u P_i&0\\0&0
      \end{bmatrix}-\begin{bmatrix}
	\hat{A}_i&\hat{B}_i
      \end{bmatrix}^\top P_i\begin{bmatrix}
        \hat{A}_i&\hat{B}_i
      \end{bmatrix}\right)\begin{bmatrix}
      x\\u
    \end{bmatrix}\geq 0.
  \end{equation}  
  Notice that \eqref{S_procedure_condition} is equivalent to
  $\norm{u}\leq c\norm{x}$, which is the condition on the control used
  during the mode detection phase. On the other hand,
  \eqref{S_procedure_result} is equivalent to
  \begin{equation}\label{decreasing_V}
    (\hat{A}_ix+\hat{B}_i u)^\top P_i(\hat{A}_ix+\hat{B}_iu)\leq \lambda_ux^\top P_i x.
  \end{equation}
  Denote $\sigma_d(t)=j,\sigma_d(t+1)=k$, which are different because
  of the phase switch at $t\in\bT^m$.  It follows from the triangle
  inequality that
  \begin{align*}
    V_{\sigma_d(t+1)}
    &(x(t+1))=V_k(x(t+1))
    \\
    &=\norm{P_k^{\frac{1}{2}}(\hat{A}_kx(t)+\hat{B}_ku(t)+w(t))}
    \\
    % &\leq \norm{P_k^{\frac{1}{2}}(A_kx(t)+B_ku(t))}+\norm{P_k^{\frac{1}{2}}w(t)}\\
    % &=\sqrt{(A_kx(t)+B_k u(t))^\top P_k(A_kx(t)+B_ku(t))}+\norm{P_k^{\frac{1}{2}}w(t)}\\
    % &\leq \sqrt{\lambda_ux(t)^\top P_k x(t)}+\norm{P_k^{\frac{1}{2}}}\norm{w(t)}\\
    &\leq \sqrt{\lambda_u}\norm{P_k^{\frac{1}{2}}x(t)}+p_{\max}q
    \\
    &\leq\sqrt{\lambda_u} \Vert
      P_k^{\frac{1}{2}}P_j^{-\frac{1}{2}}\Vert\norm{P_j^{\frac{1}{2}}x(t)}+p_{\max}q
    \\
    &\leq\sqrt{\lambda_u\mu} V_{\sigma(t)}(x(t))+p_{\max}q
  \end{align*}
  This can be equivalently written as
  $ V(\xi(t+1))\leq \sqrt{\lambda_u\mu}V(\xi(t))+p_{\max}q$.  On the
  other hand, it follows from \eqref{def:tau_d_jump} and
  \eqref{def:tau_a_unstable} that
  \begin{multline*}
    U(\xi(t+1)) =
    \sqrt{\Big(\frac{\mu}{\lambda}\Big)^{\tau_d(t)+\frac{1}{\tau}-1}
      \Big(\frac{\lambda_u}{\lambda}\Big)^{\tau_a(t)+\eta-1}}
    \\
    =\sqrt{\Big(\frac{\mu}{\lambda}\Big)^{\frac{1}{\tau}-1}
      \Big(\frac{\lambda_u}{\lambda}\Big)^{\eta-1}}U(\xi(t))=\sqrt{\frac{\lambda
      }{\lambda_u\mu}}aU(\xi(t)).
  \end{multline*}
  Therefore,
  \begin{align*}
    W(\xi(t+1))
    &=U(\xi(t+1))V(\xi(t+1))
    \\
    &
      \leq\sqrt{\lambda }aU(\xi(t))V(\xi(t))+\sqrt{\frac{\lambda }{
      \lambda_u\mu}}U(\xi(t))ap_{\max}q
    \\
    &\leq \sqrt{\lambda }
      aW(\xi(t))+\sqrt{\frac{\lambda }{
      \lambda_u\mu}}abp_{\max}q
  \end{align*}
  and we conclude
  \begin{equation}\label{uniform_one_step_inequality_W}
    W(\xi(t+1))\leq aW(\xi(t))+\tilde bq,
  \end{equation}    
  where $\tilde b:=\frac{ab}{\sqrt{\lambda}}p_{\max}$.
  
  2) The case where $t\in\{t_i^m+1,\cdots,t_i^s-1\}$ for some
  $i\in\N$. Since the controller is in the mode detection phase and
  $\sigma_d$ does not switch at $t+1$, we can similarly conclude from
  \eqref{decreasing_V} as in the previous case that
  \begin{equation*}
    V(\xi(t+1))\leq \sqrt{\lambda_u}V(\xi(t))+p_{\max}q.
  \end{equation*}
  Moreover, from \eqref{def:tau_d_flow} and \eqref{def:tau_a_unstable}
  we can conclude that
  \begin{align*}
    U(\xi(t+1))
    &\leq\sqrt{\Big(\frac{\mu}{\lambda}\Big)^{\tau_d(t)+\frac{1}{\tau}}
      \Big(\frac{\lambda_u}{\lambda}\Big)^{\tau_a(t)+\eta-1}}
    \\
    &=\sqrt{\Big(\frac{\mu}{\lambda}\Big)^{\frac{1}{\tau}}
      \Big(\frac{\lambda_u}{\lambda}\Big)^{\eta-1}}U(\xi(t)) =
      \frac{a}{\sqrt{\lambda_u}}U(\xi(t)).    
  \end{align*}
  Therefore
  \begin{align*}
    W(\xi(t+1))
    &=U(\xi(t+1))V(\xi(t+1))
    \\
    &\leq  a
      U(\xi(t))V(\xi(t))+\frac{a}{\sqrt{\lambda_u}}U(\xi(t))p_{\max}q
    \\
    &\leq a W(\xi(t))+\frac{ab }{\sqrt{\lambda_u}}p_{\max}q ,
  \end{align*}
  and again we conclude that \eqref{uniform_one_step_inequality_W}
  holds.

  3) The case where $t\in \{t_i^s,\cdots,t_{i+1}^m-1\}$ for some
  $i\in\N$; that is, when the controller is in the stabilization
  phase. In this case, it follows from \eqref{what_to_obey} that
  \begin{equation*}
    V(\xi(t+1))\leq \sqrt{\lambda} V(\xi(t))+p_{\max}q.
  \end{equation*}
  In turn, we can conclude from \eqref{def:tau_d_flow} and
  \eqref{def:tau_a_stable} that
  \begin{align*}
    U(\xi(t+1))
    &\leq
      \sqrt{\Big(\frac{\mu}{\lambda}\Big)^{\tau_d(t)+\frac{1}{\tau}}
      \Big(\frac{\lambda_u}{\lambda}\Big)^{\tau_a(t)+\eta}} 
    \\
    &=\sqrt{\Big(\frac{\mu}{\lambda}\Big)^{\frac{1}{\tau}}
      \Big(\frac{\lambda_u}{\lambda}\Big)^{\eta}}U(\xi(t)) =
      \frac{a}{\sqrt{\lambda}}U(\xi(t)).  
  \end{align*} 
  Therefore
  \begin{align*}
    W(\xi(t+1))
    &=U(\xi(t+1))V(\xi(t+1))
    \\
    &\leq a U(\xi(t))V(\xi(t))+\frac{a}{\sqrt
      \lambda}U(\xi(t))p_{\max}q
    \\
    &\leq a W(\xi(t))+\frac{ab}{\sqrt{\lambda}}p_{\max}q,
  \end{align*}
  and we can conclude the
  inequality~\eqref{uniform_one_step_inequality_W} again.
  
  As a result of the above reasoning, we conclude
  that~\eqref{uniform_one_step_inequality_W} holds for all $t\in\N$.
  % Since $a<1$, we conclude that $W$ is an input-to-state Lyapunov
  % function for the discrete system with respect to $r$. To be
  % precise,
  By the comparison principle~\cite[Lem. 3.4]{HK:02}, we conclude from
  \eqref{uniform_one_step_inequality_W} that
  \[
    W(\xi(t))\leq a^tW(\xi(0)) +\frac{1-a^t}{1-a}\tilde bq\leq
    a^tW(\xi(0))+\frac{\tilde b}{1-a}q. 
  \]
  Recall the definition of the extended state $\xi$ and the fact
  that $p_{\min}\norm{x}\leq V(\xi)\leq p_{\max}\norm{x}$ for any
  $\xi\in\calX$. We have
  \begin{align*}
    p_{\min} \norm{x(t)}\leq
    V(\xi)
    &=\frac{W(\xi(t))}{U(\xi(t))}\leq W(\xi(t))
    \\
    &\leq a^tW(\xi(0))+\frac{\tilde b}{1-a} q
    \\
    &=a^tU(\xi(0))V(\xi(0))+\frac{\tilde b}{1-a} q
    \\
    &\leq a^tbp_{\max}\norm{x_0}+\frac{\tilde b}{1-a} q.
  \end{align*}
  Dividing both sides by $p_{\min}$ yields~\eqref{ISS-estimate},
  proving the result.
  % so \eqref{ISS-estimate} is shown with
  % $c_1:=\big(\frac{\lambda_u}{\lambda}\big)^{\frac{T_0}{2}}\big(\frac{\mu}{\lambda}\big)^{\frac{N_0}{2}}\sqrt{\frac{\overline\lambda}{\underline\lambda}}$,
  % $c_2:=-\frac{\ln a}{2}$ and
  % $\gamma(r):=\sqrt{\frac{br}{\underline\lambda(1-a)}}$.
\end{proof}
\newpage
%\begin{IEEEbiography}[{\includegraphics[width=1in,height=1.25in,clip,keepaspectratio]{epsfiles/Jaap}}]{Jaap Eising} 
%  is a postdoctoral researcher at the Department of Mechanical and
%  Aerospace Engineering at the University of California, San Diego. He
%  attained the Ph.D. degree at the University of Groningen in 2021,
%  after obtaining the master degree in Mathematics at the same
%  university in 2017. His research interests include constrained
%  linear systems, systems described by difference/differential
%  inclusions, data-driven control and geometric systems theory.
%\end{IEEEbiography}
%
%\begin{IEEEbiography}[{\includegraphics[width=1in,height=1.25in,clip,keepaspectratio]{epsfiles/photo-SL}}]{Shenyu
%    Liu} (S'16-M'20) received his B. Eng. degree in Mechanical
%  Engineering and B.S. degree in Mathematics from the University of
%  Singapore, Singapore, in 2014. He received his M.S. degree in
%  Mechanical Engineering from the University of Illinois at
%  Urbana-Champaign, in 2015, where he also received his Ph.D. degree
%  in Electrical Engineering in 2020, under the supervision of
%  Prof. Daniel Liberzon and Prof. Mohamed-Ali Belabbas. He then spent
%  two years in the Department of Mechanical and Aerospace Engineering
%  at University of California, San Diego, as a postdoctoral researcher
%  under the supervision of Prof. Jorge Cort\'es and Prof. Sonia
%  Mart{\'\i}nez. He is now an assistant professor in the School of
%  Automation at Beijing Institute of Technology, Beijing, China. His
%  current research interest includes stability theory of
%  switched/hybrid systems, Lyapunov methods for nonlinear systems,
%  matrix perturbation theory, uncertain systems and data-driven
%  controller design.
%\end{IEEEbiography}
%
%\begin{IEEEbiography}[{\includegraphics[width=1in,height=1.25in,clip,keepaspectratio]{epsfiles/photo-SM}}]{Sonia
%    Mart{\'\i}nez} (M'02-SM'07-F'18) is a Professor of Mechanical and
%  Aerospace Engineering at the University of California, San Diego,
%  CA, USA. She received the Ph.D. degree in Engineering Mathematics
%  from the Universidad Carlos III de Madrid, Spain, in May 2002. She
%  was a Visiting Assistant Professor of Applied Mathematics at the
%  Technical University of Catalonia, Spain (2002-2003), a Postdoctoral
%  Fulbright Fellow at the Coordinated Science Laboratory of the
%  University of Illinois, Urbana-Champaign (2003-2004) and the Center
%  for Control, Dynamical systems and Computation of the University of
%  California, Santa Barbara (2004-2005).  Her research interests
%  include the control of networked systems, multi-agent systems,
%  nonlinear control theory, and planning algorithms in robotics. She
%  is a Fellow of IEEE. She is a co-author (together with F. Bullo and
%  J. Cort\'es) of ``Distributed Control of Robotic Networks''
%  (Princeton University Press, 2009). She is a co-author (together
%  with M. Zhu) of ``Distributed Optimization-based Control of
%  Multi-agent Networks in Complex Environments'' (Springer, 2015).
%  She is the Editor in Chief of the recently launched CSS IEEE Open
%  Journal of Control Systems.
%\end{IEEEbiography}
%
%\begin{IEEEbiography}[{\includegraphics[width=1in,height=1.25in,clip,keepaspectratio]{epsfiles/photo-JC}}]{Jorge
%    Cort\'{e}s}
%  (M'02, SM'06, F'14) received the Licenciatura degree in mathematics
%  from Universidad de Zaragoza, Zaragoza, Spain, in 1997, and the
%  Ph.D. degree in engineering mathematics from Universidad Carlos III
%  de Madrid, Madrid, Spain, in 2001. He held postdoctoral positions
%  with the University of Twente, Twente, The Netherlands, and the
%  University of Illinois at Urbana-Champaign, Urbana, IL, USA. He was
%  an Assistant Professor with the Department of Applied Mathematics
%  and Statistics, University of California, Santa Cruz, CA, USA, from
%  2004 to 2007. He is currently a Professor in the Department of
%  Mechanical and Aerospace Engineering, University of California, San
%  Diego, CA, USA. He is a Fellow of IEEE, SIAM, and IFAC.  He is the
%  author of Geometric, Control and Numerical Aspects of Nonholonomic
%  Systems (Springer-Verlag, 2002) and co-author (together with
%  F. Bullo and S.  Mart{\'\i}nez) of Distributed Control of Robotic
%  Networks (Princeton University Press, 2009).  At the IEEE Control
%  Systems Society, he has been a Distinguished Lecturer (2010-2014),
%  an elected member (2018-2020) of its Board of Governors, and its
%  Director of Operations (2019-2022) of the Executive Committee.
%\end{IEEEbiography}

\end{document}

% abstract
% diffs
