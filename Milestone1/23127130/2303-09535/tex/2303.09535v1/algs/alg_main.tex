
\algnewcommand{\ElseIIf}[1]{\algorithmicelse\ #1}
\begin{algorithm}[t]
\caption{ \texttt{FateZero} Algorithm}
\label{alg:real_image_editing}
\begin{algorithmic}

\State \textbf{Input:} 
\\ 
- $z_0$: \text{Latent code from source video}
\\
- $p_{src}$: \text{Source text prompt for input video}
\\
- $p_{edit}$: \text{Target text prompt for edition}
\\
\State {\bf Hyperparameters:} 
\\
 - ${t}_c$: Last timestep of the cross attention fusion
 \\
 - ${t}_s$: Last timestep of the self attention blending
 \\
 - $\tau$: Threshold for blending mask

\\
 \State {\bf Output:} 
 \\
 - $\hat{z}_0$: \text{Final edited latent code}

\\ \\
 $\triangleright$ DDIM for inversion latents and attention maps

% \xiaodong{check $p_{edit}$ or $p_{src}$}

\For{$t = 1,2,...,T$}
    \State $\epsilon_t, c_{t}^{\text{src}}, s_{t}^{\text{src}} \gets  \epsilon_\theta(z_t, t, p_{src})$
    % \State $z_{t+1}=\Call{Inversion\_step}{z_t, \hat{\epsilon}, t}$
    \State $z_{t} = \sqrt{\alpha_{t}} \; \frac{z_{t-1} - \sqrt{1-\alpha_{t-1}}\epsilon_t}{\sqrt{\alpha_{t-1}}}+ \sqrt{1-\alpha_{t}}\epsilon_t$
\EndFor

\\
\State $\triangleright$ Denoising the inverted latents with attention fusion  


\For{$t = T, (T-1),...,1$}
    % \State $\_\_, M_{t}^{\text{edit}} \gets \epsilon_\theta(z_t, t, p_{\text{edit}})$
    
    \State $\text{Edited\_index} = (p_{src} \text{ !=\ \ } \ p_{edit})$
    % \State $M_{\text{cross}} = (p_{src} \text{ !=\ \ } \ p_{edit})$
    \State $\triangleright$ Cross-attention mask is from the edited index~\cite{p2p}
    \State $M_{\text{cross}}[\text{Edited\_index}] = 1$
    \State $\triangleright$ Self-attention blending mask is from cross-attention.
    \State $M_{\text{self}} =  (c_{t}^{\text{src}}[\text{Edited\_index}] > \tau)$
    \State $\hat{\epsilon_t} \gets \Call{Att-Fusion}{\varepsilon_\theta, z_t, t, p_{\text{edit}}, M_{\text{edit}}, M_{\text{self}}, c_{t}^{\text{src}}, s_{t}^{\text{src}}}$
    % \State $z_{t-1}=\Call{Denoising\_step}{z_t, \hat{\epsilon}, t}$
    \State $z_{t-1} = \sqrt{\alpha_{t-1}} \; \frac{z_t - \sqrt{1-\alpha_t}\hat{\epsilon_t}}{\sqrt{\alpha_t}}+ \sqrt{1-\alpha_{t-1}}\hat{\epsilon_t}$
\EndFor



\State $\triangleright$ Fuse the inversion and editing attention of all $B$ blocks.
\State $\triangleright$ We only show the operation of attention and omit the feed-forward, residual convolution layer for simplicity.
% \Function{Att-Fusion}{$\theta, z_t, t, p_{\text{edit}}, c_{t}^{\text{src}}, s_{t}^{\text{src}}$}
\Function{Att-Fusion}{$\varepsilon_\theta, z_t, t, p_{\text{edit}}, M_{\text{cross}}, M_{\text{self}}, c_{t}^{\text{src}}, s_{t}^{\text{src}}$}
\For{$i = 1...B$}
    \State $s_{t}^{\text{edit}} = \text{Softmax}(W_i^Q(z_{t})W_i^K(z_{t})/\sqrt{d_i} )$
    \State $s_{t}^{\text{fused}} = \Call{Self-Blending}{s_{t}^{\text{edit}}, s_{t}^{\text{src}}, M_{\text{self}}, c_{t}^{\text{src}}, t}$
    \State $z_{t} \ \ \ \ = W_i^V(z_{t})\cdot s_{t}^{\text{fused}}$
    \State $c_{t}^{\text{edit}} = \text{Softmax}(W_i^Q(z_{t})W_i^K(p_{edit})/\sqrt{d_i} )$
    \State $c_{t}^{\text{fused}} = \Call{Cross-Fusion}{c_{t}^{\text{edit}}, c_{t}^{\text{src}}, M_{\text{edit}}, t}$
    \State $z_{t} \ \ \ \ = W_i^V(p_{\text{edit}})\cdot c_{t}^{\text{fused}}$
        
\EndFor
\State \Return $z_t$
\EndFunction

\end{algorithmic}
\end{algorithm}


\begin{algorithm}[t]
\caption{Attention Fusion and Blending Algorithm}
\label{alg:attention_fusion}
\begin{algorithmic}

\\
\State $\triangleright$ Cross-attention fusion using the difference mask between source and editing prompt following prompt-to-prompt.
\Function{Cross-Fusion}{$c_{t}^{\text{edit}}, c_{t}^{\text{src}}, M_{\text{edit}}, t$}
\If{$t > t_c $} 
\State \Return $ M_{\text{cross}} \cdot c_{t}^{\text{edit}}  + (1-M_{\text{cross}}) \cdot c_{t}^{\text{src}}$
% \\
\Else \State \Return $c_{t}^{\text{edit}}$
% \Else  1
% \ElseIf{$3$} $4$
\EndIf
\EndFunction
\\
\State $\triangleright$ Self-attention blending with cross attention.
\Function{Slef-Blending}{$s_{t}^{\text{edit}}, s_{t}^{\text{src}}, c_{t}^{\text{src}}, M_{\text{self}}, t$}
\If{$t > t_s $} 
\State \Return $ M_{\text{self}} \cdot s_{t}^{\text{edit}}  + (1-M_{\text{self}}) \cdot s_{t}^{\text{src}}$
% \\
\Else \State \Return $s_{t}^{\text{edit}}$
% \Else  1
% \ElseIf{$3$} $4$
\EndIf
\EndFunction




\end{algorithmic}
\end{algorithm}


