\begin{algorithm}[tb]%
    \caption{%
        Idealized NC protocol $\protocol$ with scheduling policy
        (helper functions: \cref{sec:algos-reference-helperfunctions},
        environment $\Env$: \appendixRef{\cref{sec:algos-reference-environment}},
        functionality $\FtreePoW$: \appendixRef{\cref{alg:hdrtree-pow}})%
    }%
    \label{alg:generic-lc-protocol}%
    \begin{algorithmic}[1]%
        \scriptsize%
        %
        
        \LineComment{Global counter of \timeslots $t \gets 1,2,...$ of duration $\tau$ ($\tau \to 0$ for PoW)}
        
        \On{$\Call{init}{\genesisHeaderChain, \mathsf{genesisTxs}}$}
                \label{loc:generic-lc-protocol-init}
            \LineComment{Initialize header tree $\hT$, longest processed chain $\dC$, and mappings from block header to content $\TxsMap$}
            %
            \State $\hT, \dC \gets \{\genesisHeaderChain\}, \genesisHeaderChain$
            \State $\TxsMap[\genesisHeaderChain] \gets \mathsf{genesisTxs}$
                \Comment{Unset entries of $\TxsMap$ are $\BLOCKUNKNOWN$}
            %
                %
        \EndOn
        
        \On{$\Call{receivedHeaderChain}{\Chain}$}
                \label{loc:generic-lc-protocol-receiveheader}
                \Comment{Called by $\Env$ or $\Adv$}
            \State \Assert{$\FtreePoW.\Call{verify}{\Chain}$}
                \Comment{Validate header chain}
            \State $\hT \gets \hT \cup \operatorname{prefixChainsOf}(\Chain)$
                \Comment{Add $\Chain$ and its prefixes to $\hT$}
            %
            %
            %
            %
            \State $\Env.\Call{broadcastHeaderChain}{\Chain}$
        \EndOn
        
        \On{$\Call{receivedContent}{\Chain, \txs}$}
                \label{loc:generic-lc-protocol-receivecontent}
                \Comment{Called by $\Env$ or $\Adv$}
            \LineComment{Defer processing the content until all prefixes' contents are processed}
            \State \textbf{defer until} $\forall \Chain' \prec \Chain\colon \TxsMap[\Chain'] \neq \BLOCKUNKNOWN$
            \State \Assert{$\Chain.\mathsf{txsHash} = \operatorname{Hash}(\txs)$}
            \State $\Call{receivedHeaderChain}{\Chain}$
                \Comment{Validate header chain}
            \State \Assert{$\operatorname{AreTxsValid}(\txs)$}
                \Comment{Validate content of chain}
            \State $\TxsMap[\Chain] \gets \txs$
            \State $\Env.\Call{uploadContent}{\Chain, \txs}$
            \LineComment{Update the longest processed chain}
            \State $\Tree' \gets \{ \Chain' \in \hT \mid \TxsMap[\Chain'] \neq \BLOCKUNKNOWN \}$
            \State $\dC \gets \argmax_{\Chain' \in \Tree'} \len{\Chain'}$
        \EndOn
        
        \At{\timeslot $t \gets 1,2,...$}
                \label{loc:generic-lc-protocol-mainloop}
                \Comment{NC protocol main loop}
            \State $\txs \gets \Env.\Call{receivePendingTxs}{\null}$
            \LineComment{Produce and disseminate a new block if eligible}
            \If{$\Chain' \neq \bot$ \textbf{with} $\Chain' \gets \FtreePoW.\Call{extend}{\dC, \txs}$}
                \State $\Env.\Call{broadcastHeaderChain}{\Chain'}$
                \State $\Env.\Call{uploadContent}{\Chain', \txs}$
            \EndIf
            %
                \LineComment{Confirm all but the last $\confDepth$ blocks on the longest processed chain}
            \State $\LOG{}{t} \gets \operatorname{txsLedger}(\TxsMap, \dC\trunc{\confDepth})$
                \label{loc:generic-lc-protocol-confirmation}
                \label{loc:generic-lc-protocol-ledger}
                \Comment{Ledger of node $p$ at $t$: $\LOG{p}{t}$}
        \EndAt

        \Throughout
            \State{Download content for some $\Chain$ chosen by scheduling policy (\eg \appendixRef{\cref{alg:longest-header-chain-rule}})}
        \EndThroughout
        \label{loc:generic-lc-protocol-downloadrule}
    \end{algorithmic}%
\end{algorithm}%