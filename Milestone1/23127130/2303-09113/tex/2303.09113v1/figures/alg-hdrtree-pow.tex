\begin{algorithm}[tb]%
    \caption{%
        Idealized functionality $\FtreePoW$:
        block production lottery and header chain structure
        for PoW
        (helper functions: \secref{algos-reference-helperfunctions})%
    }%
    \label{alg:hdrtree-pow}%
    \begin{algorithmic}[1]%
        \footnotesize%
        
        \On{$\Call{init}{\genesisHeaderChain, \mathsf{numNodes}}$}
            \State $N \gets \mathsf{numNodes}$
            \State $\Tree \gets \{\genesisHeaderChain\}$
                \Comment{Global set of valid header chains}
        \EndOn

        \On{$\Call{extend}{\Chain, \txs}$ \textbf{from} node $P$ (possibly adversarial) \textbf{at} \timeslot $t$}
                \label{loc:hdrtree-pow-binding}
            \LineComment{Abstraction of proof-of-work lottery: each node can call this once per slot and produces a block with probability $\blkrateslot/N$ independently of other nodes and slots}
            %
            %
            %
            %
            %
            \If{$\Lottery[P,t] \neq \bot$}
                \Return{$\bot$} \Comment{allow only one block per successful lottery}
            \EndIf
            \State $\Lottery[P,t] \overset{\$}{\gets} (\TRUE \text{ with probability $\blkrateslot/N$, else } \FALSE)$
            \label{loc:hdrtree-pow-blockproductionlottery}
            %
            \If{$\Chain\in\Tree \land \Lottery[P,t]$}
                    \Comment{New header chain valid if parent chain $\Chain$ is valid}
                \LineComment{Produce a new block header extending $\Chain$}
                \State $\Chain' \gets \Chain\|\operatorname{newBlock}(\mathsf{txsHash}\colon \operatorname{Hash}(\txs))$
                \State $\Tree \gets \Tree \cup \{\Chain'\}$
                    \Comment{Register new header chain in header tree}
                \State \Return{$\Chain'$}
            \EndIf
            \State \Return{$\bot$}
        \EndOn
        
        \On{$\Call{verify}{\Chain}$}
            \State \Return{$\Chain \in \Tree$}
                \Comment{Header chain is valid if previously added to header tree}
        \EndOn
    \end{algorithmic}%
\end{algorithm}%