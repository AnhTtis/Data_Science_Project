\begin{algorithm}[tb]%
    \caption{%
        \textcolor{jnSUDigitalGreen}{PoS LC consensus protocol $\protocolPoSEquivBlank$} with download logic
        \textcolor{jnSUDigitalGreen}{and \equivocationremoval}
        (helper functions: \secref{algos-reference-helperfunctions},
        environment $\Env$: \secref{algos-reference-environment},
        \textcolor{jnSUDigitalGreen}{functionality $\FtreePoSEquivBlank$: \algref{posequivblank-hdrtree}})%
    }%
    \label{alg:posequivblank-lc}%
    \begin{algorithmic}[1]%
        \footnotesize%
        
        \LineComment{Global counter of time slots $t \gets 1,2,...$ of duration $\tau$ (for PoW: $\tau \to 0$, \cf~\secref{pow})}
        
        %
        %
        %
        %
        
        
        \LineComment{Same as in \algref{generic-lc-protocol}: $\Call{init}{\genesisHeaderChain, \mathsf{genesisTxs}}$, $\Call{receivedHeaderChain}{\Chain}$, $\Call{receivedContent}{\Chain,\txs}$}
        
        
        \LineComment{\textcolor{jnSUDigitalGreen}{$(\Chain \eqEquivocation \Chain') \triangleq (\Chain \neq \Chain') \land (\Chain.\mathsf{node} = \Chain'.\mathsf{node}) \land (\Chain.\mathsf{time} = \Chain'.\mathsf{time})$}}
        
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        %
        
        \At{time slot $t \gets 1,2,...$}
                \label{loc:posequivblank-lc-mainloop}
                \Comment{LC protocol main loop}
            \State $\txs \gets \Env.\Call{receivePendingTxs}{\null}$
            \LineComment{\textcolor{jnSUDigitalGreen}{Construct equivocation proofs against headers in prefix not already proven}}
            \label{loc:posequivblank-lc-construct-eq-proof}
            \State \textcolor{jnSUDigitalGreen}{$\eqProofs \gets \{ (\Chain_1 \preceq \dC, \Chain_2 \in \hT) \mid (\Chain_1 \eqEquivocation \Chain_2) \land (\len{\Chain_1} > \len{\dC} - \keqproof) \land ((\Chain_1, \Chain_2) \not\in \bigcup_{\Chain \preceq \dC} \Chain.\eqProofs) \}$
            %
            }
            \LineComment{Produce and disseminate a new block if eligible}
            \If{$\Chain' \neq \bot$ \textbf{with} $\Chain' \gets \Ftree.\Call{extend}{\dC, \txs \textcolor{jnSUDigitalGreen}{, \eqProofs}}$}
                \State $\Env.\Call{uploadContent}{\Chain', \txs}$
                \State $\Env.\Call{broadcastHeaderChain}{\Chain'}$
            \EndIf
            \label{loc:posequivblank-lc-confirmation}
            \LineComment{\textcolor{jnSUDigitalGreen}{Blank the content of blocks against which there was an equivocation proof}}
            \label{loc:posequivblank-lc-confirmation-blanking}
            \State \textcolor{jnSUDigitalGreen}{$\TxsMap'[\Chain] \gets (\emptyset \text{ \textbf{if} } (\Chain,\_) \in \bigcup_{\Chain' \preceq \Chain^*} \Chain'.\eqProofs$,\text{ \textbf{else} }$\TxsMap[\Chain])$}
            \LineComment{Confirm all but the last $\confDepth$ blocks on the longest downloaded chain}
            \State $\LOG{}{t} \gets \operatorname{txsLedger}(\TxsMap, \Chain\trunc{\confDepth})$
                \label{loc:posequivblank-lc-ledger}
                \Comment{Ledger of node $p$ at time $t$: $\LOG{p}{t}$}
        \EndAt
        
        \Throughout
            \State{Choose $\Chain$ from download rule (\eg \algref{longest-header-chain-rule})}
            \If{\textcolor{jnSUDigitalGreen}{$\exists \Chain' \in \hT \colon \Chain' \eqEquivocation \Chain$}}
                \State{\textcolor{jnSUDigitalGreen}{$\TxsMap[\Chain] \gets \emptyset$}} 
                \Comment{\textcolor{jnSUDigitalGreen}{don't download $\Chain$, query download rule again}}
            \Else
                \State{\textcolor{jnSUDigitalGreen}{Download content for $\Chain$}}
            \EndIf
            %
        \EndThroughout
        \label{loc:posequivblank-lc-downloadrule}
    \end{algorithmic}%
\end{algorithm}%