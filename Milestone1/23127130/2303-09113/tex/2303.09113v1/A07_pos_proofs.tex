\section{Proof-of-Stake}
\label{sec:appendix-pos}





\subsection{Pseudocodes for Equivocation Removal}
\label{sec:appendix-pos-eqremoval-pseudocodes}

\import{./figures/}{alg-posequivblank-lc.tex}
\import{./figures/}{alg-posequivblank-hdrtree.tex}

\algref{posequivblank-lc,posequivblank-hdrtree}






\subsection{Security Proofs}
\label{sec:appendix-pos-proofs}


\begin{proposition}
    \label{prop:index-time-bridge-pos}
    For all $\delta \in (0,1)$, $k, K \in \IN$,
    \begin{IEEEeqnarray}{C}
        \Prob{ t_{k+K} - t_{k} \geq \frac{K/(1-e^{-\blkrateslot})}{1-\delta} } \leq 
        %
        e^{- 2K(1-e^{-\blkrateslot})\delta^2}, \IEEEeqnarraynumspace
        %
        %
        %
    \end{IEEEeqnarray}
\end{proposition}
\begin{proof}
    This results from a Hoeffding bound for the number of non-\sltempty \timeslots in $K/(1-e^{-\blkrateslot})$ \timeslots.
\end{proof}



\begin{lemma}
    \label{lem:safety-and-liveness-comb-pos}
    If for some $\Kcp > 0$,
    \begin{IEEEeqnarray}{C}
        \label{eq:condition-one-cp-m-pos-safety}
        \forall m \geq 0 \colon \exists k_m^* \in \intvl{m\Kcp}{(m+1)\Kcp} \colon \predCP{k_m^*},
        \IEEEeqnarraynumspace \\
        \label{eq:cond-index-time-bridge-pos}
        \forall k \in \IN, K \geq \Kcp \colon t_{k+K} - t_{k} < \frac{K/(1-e^{-\blkrateslot})}{1-\delta},
        \IEEEeqnarraynumspace
    \end{IEEEeqnarray}
    then \sapos
    with $\confDepth = 6\Kcp + 1$
    and $\keqproof = 4\Kcp$
    %
    satisfies safety and liveness with
    $\Tlive = \frac{14\Kcp+2}{(1-e^{-\blkrateslot})(1-\delta)}$.
    %
\end{lemma}

\begin{proof}
%
%
%
%
%
%

First, we prove safety.
Consider arbitrary \timeslots $t \leq t'$ and let $h$ be the largest \iindex such that $t_h \leq t$.
Consider a block $b_i \in \dC_p(t)\trunc{\confDepth}$ which was produced in \iindex $i \leq h - \confDepth$.
%
%
%
%
%
%
%
%
%
From \eqref{condition-one-cp-m-pos-safety}, every interval of $2\Kcp$ \iindices contains at least one \sltcp.
%
Therefore
for any $i$,
%
there exist \sltcps $j,k$ %
such that %
\begin{IEEEeqnarray}{C}
    \label{eq:cond-i-j-k-pos}
    %
    %
    %
    i < j < k \leq i + 4\Kcp.
\end{IEEEeqnarray}
Also, let $l$ be the last \sltcp before (excluding) \iindex $h$. Then
\begin{IEEEeqnarray}{C}
    \label{eq:cond-i-k-l-pos}
    l \geq h - 2\Kcp \geq i + \confDepth - 2\Kcp > i + 4\Kcp.
    \IEEEeqnarraynumspace
\end{IEEEeqnarray}
%
%
%
From \eqref{cond-i-j-k-pos} and \eqref{cond-i-k-l-pos}, we have
\begin{IEEEeqnarray}{C}
    \label{eq:cond-i-j-k-l-pos}
    i < j < k \leq i + \keqproof < l < h.
\end{IEEEeqnarray}
These are shown in \figref{pos-safety-proof}.
%
%
%
%
%
Let $b_j, b_k, b_l$ be the blocks corresponding to the respective \sltcps (see \figref{pos-safety-proof}).
Due to \lemref{cps-stabilize} and $t \geq t_h > t_l + \goodsep$,
\begin{IEEEeqnarray}{C}
    b_i \preceq b_j \preceq b_k \preceq b_l \preceq \dC_p(t) \cap \dC_q(t').
\end{IEEEeqnarray}
%
%
Since the above holds for all $b_i \in \dC_p(t)\trunc{\confDepth}$, we obtain that $\dC_p(t)\trunc{\confDepth} \preceq \dC_q(t')$.
We can thus conclude that
\begin{IEEEeqnarray}{rCl}
    %
    %
    %
    \label{eq:consistent-confDepth-chains-pos}
    \dC_p(t)\trunc{\confDepth} &\consistent& \dC_q(t')\trunc{\confDepth}
    %
\end{IEEEeqnarray}
%
%
where $\Chain_1 \consistent \Chain_2$ denotes $\Chain_1 \preceq \Chain_2$ or $\Chain_2 \preceq \Chain_1$.
%
Due to \eqref{consistent-confDepth-chains-pos},
the $\confDepth$-deep header chains of $p$ at $t$ and of $q$ at $t'$ are consistent. 
Without \equivocationremoval, this was enough to show safety of the corresponding ledgers.
Now to show that the two ledgers $\LOG{p}{t}$ and $\LOG{q}{t'}$ are consistent, we only need to show that if the content of a block is blanked in $\LOG{p}{t}$, it is also blanked in $\LOG{q}{t'}$, and conversely if it is not blanked in $\LOG{p}{t}$, it is not blanked in $\LOG{q}{t'}$.




Suppose that the content of $b_i$ is blanked in $\LOG{p}{t}$.
This means that either there was an equivocation for $b_i$ in node $p$'s view (hence node $p$ did not download the content), or there is an equivocation proof against $b_i$ in
a header 
%
in $\dC_p(t)$.
The header of $b_i$ must be seen by all honest nodes $p$ before the end of \timeslot $t_j+\goodsep$ (since $b_j \in \dC_p(t_j + \goodsep)$).
Then since block $b_k$ is honest, $t_k > t_j + \goodsep$, and $k \leq i + \keqproof$, either $b_k$ or another block in its prefix must include an equivocation proof against $b_i$.
%
%
We know that $b_k \in \dC_q(t')$,
so the content of block $b_i$ will be blanked in 
%
$\LOG{q}{t'}$ as well.

Suppose that the content of $b_i$ is not blanked in $\LOG{p}{t}$.
This means that there is no equivocation proof against $b_i$ in $\dC_p(t)$.
Since $l \geq h - 2\Kcp$, the block $b_l$ cannot be more than $2\Kcp$-deep in $\dC_p(t)$, \ie,
\begin{IEEEeqnarray}{C}
    \len{b_l} \geq \len{\dC_p(t)} - 2\Kcp.
    \IEEEeqnarraynumspace
\end{IEEEeqnarray}
But $b_i$ is $\confDepth$-deep in $\dC_p(t)$ (as assumed), so 
\begin{IEEEeqnarray}{C}
    \len{b_i} \leq \len{\dC_p(t)} - \confDepth.    
    \IEEEeqnarraynumspace
\end{IEEEeqnarray}
Together, we have 
\begin{IEEEeqnarray}{C}
    \len{b_l} \geq \len{b_i} + \confDepth - 2\Kcp > \len{b_i} + \keqproof.
    \IEEEeqnarraynumspace
\end{IEEEeqnarray}
%
%
%
Therefore $b_l$ or any block extending it cannot contain an equivocation proof against $b_i$.
Since $b_l \in \dC_p(t)$ and $b_l \in \dC_q(t')$, there cannot be any block in $\dC_q(t')$ before $b_l$, that is not in $\dC_p(t)$.
Therefore, there is no equivocation proof against $b_i$ in $\dC_q(t')$.
Also, node $q$ must have downloaded block $b_i$, otherwise there must have been an equivocation proof in $b_k$ or its prefix as discussed in the previous paragraph.
So, the content of $b_i$ is not blanked in $\LOG{q}{t'}$.
%
%
We can thus conclude that
either 
%
$\LOG{p}{t} \preceq \LOG{q}{t'}$ or $\LOG{q}{t'} \preceq \LOG{p}{t}$.
Therefore, safety holds.

%
%
%
%
%
%
%
%
%

We next prove liveness. Assume a transaction $\tx$ is received by all honest nodes before \timeslot $t$. Again let $h$ be the largest \iindex such that $t_h \leq t$.
We know that there exists $k^* \in (h,h+2\Kcp]$ such that $\predCP{k^*}$.
The honest block $b^*$ from \iindex $k^*$ or its prefix must contain $\tx$ since $\tx$ is seen by all honest nodes at time $t < t_{k^*}$.
Since $k^*$ is a \sltcp, for all $\intvl{i}{j} \ni k^*$, $\Din{i}{j} > \Nin{i}{j}$ (\defref{cp} and \eqref{random_walks_X_and_Y}), and hence $\Din{i}{j} > \frac{j-i}{2}$.
Particularly,
\begin{IEEEeqnarray}{rCl}
    \Din{k^*-1}{k^* + 2\confDepth-1} &>& \confDepth \\
    \implies \Din{k^*}{k^* + 2\confDepth - 1} &>& \confDepth - 1.
    \IEEEeqnarraynumspace
\end{IEEEeqnarray}
Then from \propref{chain-growth-interval},
\begin{IEEEeqnarray}{rCl}
    L_{\min}(t_{k^*+2\confDepth-1}+\goodsep) - L_{\min}(t_{k^*+1}-1) &\geq& \Din{k^*}{k^* + 2\confDepth - 1} \nonumber \\
    &\geq& \confDepth.
    \IEEEeqnarraynumspace
\end{IEEEeqnarray}
Due to \lemref{cps-stabilize},
$b^*\in\dC_p(t')$ for all honest nodes $p$ and $t'\geq t_{k^*} + \goodsep$, and $L_{\min}(t_{k^*+1}-1) \geq \len{b^*}$. This means that $b^*$ is $\confDepth$-deep in $\dC_p(t')$ for all honest nodes $p$ and all $t' \geq t_{k^*+2\confDepth-1}+\goodsep$.
Further, the content of an honest block will never be blanked out in any honest node's ledger.
Finally, with $k^* \leq h+2\Kcp$ and \eqref{cond-index-time-bridge-pow},
\begin{IEEEeqnarray}{rCl}
    t_{k^*+2\confDepth-1}+\goodsep - t &\leq& t_{h+2\Kcp+2\confDepth-1} + \goodsep - t_{h} \nonumber \\
    &\leq& t_{h+2\Kcp+2\confDepth} - t_{h} \nonumber \\
    &<& \frac{2\Kcp+2\confDepth}{(1-e^{-\blkrateslot})(1-\delta)}.
    \IEEEeqnarraynumspace
\end{IEEEeqnarray}
Therefore, $\mathsf{tx}\in\LOG{p}{t'}$ for all $t'\geq t+\Tlive$ with $\Tlive$ as in the lemma statement.
%
%
%
%
%
%
%
%
\end{proof}


\import{./figures/}{fig-pos-safety-proof.tex}



We also need another proposition to bound the number of \BPOs in a given number of slots, in order to bound $\Qin{i}{j}$.
\begin{proposition}
\label{prop:Q-bound-pos}
\begin{IEEEeqnarray}{C}
    \forall t, T \in \IN \colon
    \Prob{ \sum_{r=t}^{t+T} (H_t + A_t) \geq \blkrateslot T (1+\delta) } \leq 
    \exp\left( - \frac{\blkrateslot T \delta^2}{2(1+\delta)} \right). \IEEEeqnarraynumspace
\end{IEEEeqnarray}
\end{proposition}
\begin{proof}
This results from a Poisson tail bound since $\sum_{r=t}^{t+T} (H_t + A_t) \sim \operatorname{Poisson}(\blkrateslot T)$.
\end{proof}





\begin{proof}[Proof of \Thmref{safety-and-liveness-pos}]

First, we show that the conditions of \lemref{one-cp-induction-full} hold, and therefore \sltcps occur.
Suppose that the following three events occur.
\begin{IEEEeqnarray}{rCl}
    \Event_1 &=& \left\{\forall \intvl{i}{j} \intvlgeq \Kcp \colon \Pin{i}{j} > (1-2\delta)\probPP(j-i) \right\},
    \\
    \Event_2 &=& \left\{\forall t \in \IN, T \geq \frac{\Kcp}{1-e^{-\blkrateslot}} \colon \sum_{r=t}^{t+T} (H_t + A_t) < \blkrateslot T (1+\delta) \right\},
    \IEEEeqnarraynumspace
    \\
    \Event_3 &=& \left\{ \forall k \in \IN, K \geq \Kcp \colon t_{k+K} - t_{k} < \frac{K/(1-e^{-\blkrateslot})}{1-\delta} \right\}. \IEEEeqnarraynumspace
\end{IEEEeqnarray}

From $\Event_2$ and $\Event_3$, we get
\begin{IEEEeqnarray}{rCl}
    \forall \intvl{i}{j} \intvlgeq \Kcp \colon \quad 
    \Qin{i}{j} &\triangleq& \sum_{k=i+1}^{j} (H_{t_k} + A_{t_k}) \\
    \text{with } T = \frac{j-i}{(1-e^{-\blkrateslot})(1-\delta)}, \quad &\leq& \sum_{t=t_i}^{t_i + T} (H_{t} + A_{t}) \\
    &<& \frac{\blkrateslot (j-i) (1+\delta)}{(1-e^{-\blkrateslot})(1-\delta)} \\
    &\leq&  \frac{\blkrateslot (j-i)}{(1-e^{-\blkrateslot})(1-2\delta)}.
    \IEEEeqnarraynumspace
\end{IEEEeqnarray}
Then if $\frac{\goodsepbw}{16}\probPP (1-4\delta) > \frac{\blkrateslot}{(1-e^{-\blkrateslot})}$,
%
\begin{IEEEeqnarray}{rCl}
    \forall \intvl{i}{j} \intvlgeq \Kcp \colon \quad \frac{\goodsepbw}{4} \Pin{i}{j} &>& \frac{\goodsepbw}{4} (1-2\delta)\probPP(j-i)
    \IEEEeqnarraynumspace
    \\
    &>& \frac{4\blkrateslot(j-1)(1-2\delta)}{(1-e^{-\blkrateslot})(1-4\delta)}
    \\
    &>& \frac{4\blkrateslot(j-1)}{(1-e^{-\blkrateslot})(1-2\delta)}
    \\
    &>& \Qin{i-2\Kcp}{j+\Kcp}.
\end{IEEEeqnarray}
This satisfies \eqref{cp-induction-full-ppivots-condition} in \lemref{one-cp-induction-full}. Further,
\begin{IEEEeqnarray}{rCl}
    \frac{\goodsepbw}{2} \left( \Gin{i}{j} - \Bin{i}{j} \right)
    &\geq& \frac{\goodsepbw}{2} \Pin{i}{j} \\
    &>& \frac{3\blkrateslot(j-1)}{(1-e^{-\blkrateslot})(1-2\delta)}  \\
    &>& \Qin{i-2\Kcp}{j}
\end{IEEEeqnarray}
which satisfies condition \eqref{cp-induction-full-margin-condition} in \lemref{one-cp-induction-full}. 
%
Therefore there is one \sltcp in every interval of the form $\intvl{m\Kcp}{(m+1)\Kcp}$.
%
%
%
%
%
%
%
Then by \lemref{safety-and-liveness-comb-pos}, the protocol achieves safety and liveness with appropriately chosen $\confDepth, \keqproof, \Tlive$.
%
%
%
%

By using \lemref{many-pps}, $\Kcp = \Omega(\kappa^2)$, $\Khorizon = \poly(\kappa)$, \propref{index-time-bridge-pos, Q-bound-pos},
%
%
%
%
%
%
and union bounds, 
%
the probability of failure of either $\Event_1$, $\Event_2$ or $\Event_3$ is $\negl(\kappa)$.
%
%

The required security threshold is obtained from $\BWEquation$,
$\probGood = \probGoodFormula$,
$\frac{C}{16}\probPP > \frac{\blkrateslot}{1-e^{-\blkrateslot}}$,
and $\probPP = \probPPFormula$,.
As in the case of PoW, $\goodsepbw$ is a free parameter that can be optimized to find the best set of parameters.
%
%
%
%
%
%
%
%
%
%
\end{proof}