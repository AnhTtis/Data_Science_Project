\begin{algorithm}[tb]%
    \caption{%
        Idealized functionality $\FtreePoS$:
        block production lottery and header chain structure
        for PoS
        (helper functions: \fullVersionRef{\cref{sec:algos-reference-helperfunctions}})%
    }%
    \label{alg:hdrtree-pos}%
    \begin{algorithmic}[1]%
        \scriptsize%
        
        %
        %
        %
        %
        %
        \LineComment{$\Call{init}{\genesisHeaderChain, \mathsf{numNodes}}$ and $\Call{verify}{\Chain}$ same as in \cref{alg:hdrtree-pow}}
        
        \On{$\Call{isLeader}{P,t}$ \textbf{from} $\mathcal A$ (only for adversarial node $P$) or $\FtreePoS$}
                \label{loc:hdrtree-pos-leader}
            \LineComment{Abstraction of proof-of-stake lottery: each node is chosen leader in each slot with probability $\blkrateslot/N$ independently of other nodes and slots}
            \If{$\Lottery[P,t] = \bot$}
                    \label{loc:hdrtree-pos-rhodefn}
                \State $\Lottery[P,t] \overset{\$}{\gets} (\TRUE \text{ with probability $\blkrateslot/N$, else } \FALSE)$
                    \label{loc:hdrtree-pos-blockproductionlottery}
            \EndIf
            \State \Return{$\Lottery[P,t]$}
        \EndOn

        \On{$\Call{extend}{t', \Chain, \txs}$ \textbf{from} $\mathcal A$ (only for adversarial node $P$) or $\FtreePoS$}
                \label{loc:hdrtree-pos-binding}
            \LineComment{New header chain is valid if parent chain $\Chain$ is valid, $P$ is leader for slot $t'$, and $t'$ is later than the tip of $\Chain$ and is not in the future}
            \If{$(\Chain\in\Tree) \land \FtreePoS.\Call{isLeader}{P,t'} \land (\Chain.\mathsf{time} < t' \leq t)$} \label{loc:hdrtree-pos-check-lottery}
                \LineComment{Produce a new block header extending $\Chain$}
                \State $\Chain' \gets \Chain\|\operatorname{newBlock}(\mathsf{time}\colon t', \mathsf{node}\colon P, \mathsf{txsHash}\colon \operatorname{Hash}(\txs))$ 
                \State $\Tree \gets \Tree \cup \{\Chain'\}$
                    \Comment{Register new header chain in header tree}
                \State \Return{$\Chain'$}
            \EndIf
            \State \Return{$\bot$}
        \EndOn

        \On{$\Call{extend}{\Chain, \txs}$ \textbf{from} node $P$ (possibly adversarial) \textbf{at} \timeslot $t$}
            \State \Return{$\FtreePoS.\Call{extend}{t, \Chain, \txs}$}
        \EndOn
        
        %
        %
        %
        %
        %
    \end{algorithmic}%
\end{algorithm}%