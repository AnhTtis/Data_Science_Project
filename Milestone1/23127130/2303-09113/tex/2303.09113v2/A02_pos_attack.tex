\section{Congestion-Based Attacks}
\label{sec:general-attacks}


\subsection{\GreedyAttack}
\label{sec:greedy-attack}

The \teaserattack relied strongly on the fact that the attacker could entice nodes with a long header chain that is later discovered to be unavailable for download. It is natural in this case to consider adjusting the download rule to one that prefers the proverbial `bird in the hand over two birds in the bush', \ie, to extend the blocks we already downloaded over the illusive promise of a longer chain that the attacker may withhold from us. 

\smallskip\noindent\textbf{The \ruleGreedy policy.}\;\;
This policy prioritizes downloading blocks that extend the chain a node has already processed. If a header of a block at height $h$ is announced, and we already have $h_i$ blocks from that chain, then we set the priority of the block to be $(h_i,h)$ and compare between the two priorities lexicographically.

While the \rulegreedy policy performs well at high processing rates, we unfortunately find that it preforms poorly in the low processing rate regime. Specifically, if a fork in the chain occurs, and nodes are split evenly between the two alternatives, the fork may never resolve. This is because nodes extend their own chain, and prioritize download on their side of the split, while having insufficient processing power to catch up with the other alternative chain. A fork in the chain can result from a deliberate attack by an attacker that releases blocks selectively to different nodes, by a network split, or worse, by an unlucky timing of honest node mining events. In this case, the blockchain fails even for small attackers. 
Importantly, a fork that never resolves is either a safety or a liveness failure, as no transaction on either side of the split can be safely accepted.

\import{./figures/}{fig-experiment-greedy.tex}

To demonstrate this download rule in action, we simulate a network of 100 nodes that are split evenly between two partitions for only 15 seconds, \ie, for an expected time required to produce 15 blocks.%
\footnote{Such short splits are relatively easy to induce in reality (transient problems with Internet routing, denial-of-service on the network, etc.) and thus a practical scheduling rule must recover from such splits.}
Once the network split ends, the simulation continues for another 4000 seconds, allowing nodes the opportunity to 
converge on a chain.
%
We 
%
measure the height of the latest block all nodes agree upon. If nodes do not recover from the partition, 
this block will be the genesis and the liveness of the protocol has failed. Otherwise, nodes quickly agree on the main chain and the height of the latest agreed block is 
just a little behind the longest tip of the chain. 

%

We simulate the evolution after a brief partition for both the \rulelc policy as well as for the \rulegreedy policy. Our results (\cref{fig:experiment-greedy}) show that in settings where bandwidth is greater than $1/2$, nodes manage to catch up with the chain and the rate of growth matches for both scheduling policies. In lower bandwidth settings, however, nodes never catch up.
Note that this attack requires no adversarial mining,
yet the protocol is insecure (\cf \cref{fig:comparison-bddelay-bdbandwidth}(c)).
This is in stark contrast to the bounded-delay analysis
which suggests that the protocol retains security
against a non-mining adversary
%
at any bandwidth (\cf \cref{fig:comparison-bddelay-bdbandwidth}(a)),
and highlights again the need to study the security of blockchains at capacity.



%
%



\subsection{\PoSTeaserAttack}
\label{sec:pos-attack}

In this section, we present an attack to establish a bound (as a function of the security level) on the block production rate (and hence, throughput, or bandwidth requirement) of a single chain PoS NC protocol without an equivocation removal policy.
For concreteness, we demonstrate this attack on PoS NC using any one of three download rules: `download the longest header chain', `download towards the freshest block', and `equivocation avoidance'.
%
For the `download the longest header chain' rule, \cite[Figure~3]{bwlimitedposlc} showed one attack
%
and the attack in this section generalizes that.
%
On the other hand, \cite{bwlimitedposlc} proved PoS NC secure under the other two download rules by setting the duration of a \timeslot proportional to the security parameter $\kappa$, to achieve security with probability $1-\negl(\kappa)$.
Hence the block production rate (and throughput) decays as $O\left(\frac{1}{\kappa}\right)$.
In this section, we show an attack which succeeds if the block production rate is $\Omega\left(\frac{1}{\log(\kappa)}\right)$.




Furthermore, while the attack in \cite[Figure~3]{bwlimitedposlc} required that the PoS NC protocol rejects blocks with invalid transactions after downloading them, this attack does not require that. Therefore, this attack works even if the PoS NC protocol accepts blocks with invalid transactions into the output ledger (\eg, to subsequently clean them up deterministically across honest nodes).
This is because as noted in \cref{sec:throughputloss}, even if the protocol accepts blocks with invalid transactions, honest nodes must download the block content (to ensure data availability). 
This is why we require an equivocation removal policy so that honest nodes can unilaterally discard content for blocks that they do not download. This is what allows us to overcome the $\Omega\left(\frac{1}{\log(\kappa)}\right)$ throughput bound in this work.



Before describing the attack, we briefly recap the download rules analyzed in this section.
In the `download towards the freshest block' rule (\cf \cite[Alg.~2]{bwlimitedposlc}), a node chooses the block produced in the most recent time slot (`freshest'), and if it not yet downloaded, downloads the first unknown block in the chain containing that block.
One the node downloads the freshest block, it stops downloading any blocks until a block header from a more recent \timeslot shows up.
In the `equivocation avoidance' rule (\cite[Alg.~4]{bwlimitedposlc}), the node first filters the tree of its headers by keeping only one leaf per \BPO (ties broken by the adversary). From among the remaining headers, the node picks a block to download as per the `download longest header chain' rule.
The `download longest header chain' rule is as described in \cref{alg:longest-header-chain-rule}.



%
%
%
%
%
%
%
%

%
%
%
%
%

%
%

%

%

\subsection{Attack Strategy}
\label{sec:tp-attack-strategy}
%
The attack works in two phases. See \cref{fig:tp-log-kappa-attack} for reference.
$\bwtime$ is the bandwidth constraint (in blocks per second), $\slotduration$ is the slot duration, and $\kappa$ is the security parameter.

\paragraph{Setup phase} \label{item:tp-attack-setup} At time slot $t_0$, the adversary creates a chain $\Chain$ which forks off the honest chain $\Chain_0$ by at least $L = \log(\kappa)$ blocks, and is at least as long as $\Chain_0$.
%
The prefix length $L$ is chosen so that the setup succeeds with non-negligible probability.
The adversary initially keeps $\Chain$ private.
%

%

%
%
%
%

\paragraph{Execution phase} \label{item:tp-attack-exec}
The adversary creates different chains $\Chain_1, \Chain_2, ...$ which contain equivocations of the blocks in $\Chain$, and pushes one chain to each honest node.
\begin{enumerate}[(1)]
    \item \label{item:tp-attack-exec-start} Let $t_1 > t_0$ be the first time slot with a block production. For any block
    $b_1$ produced in slot $t_1$, if
    %
    $b_1$ is produced by an honest node, then, 
    %
    the adversary breaks ties such that $b_1$ extends one of the equivocating chains $\Chain_i$.
    If 
    %
    $b_1$ is produced by the adversary, the adversary produces $b_1$ at the tip of 
    another chain made of equivocations of the blocks in
    %
    $\Chain$.
    %
    Regardless, any block $b_1$ produced in $t_1$ extends 
    a chain that forks off the downloaded longest chain by $L$ new blocks that need to be downloaded, hence it will take a long time for an honest node to download up to
    the block $b_1$.
    %
    %
    %
    
    \item \label{item:tp-attack-exec-mid} The adversary repeats step~\ref{item:tp-attack-exec-start} in all time slots $t_2,t_3,...$ with a block production.
    %
    Assuming there are many honest nodes, each block extends a different equivocating chain and is too long to catch up with.
    The adversary continues this until the following condition occurs.
    
    \item \label{item:tp-attack-exec-end} Let $t^*$ be the first time slot since $t_0$ in which an honest block $b^*$ is produced, such that there are no other blocks produced in slots $[t^*,t^* + L/(\bwtime\slotduration))$. This condition ensures that there is enough time for $b^*$ to be downloaded by all honest nodes.
    
    If the adversary had at least one block production opportunity $t' \in [t_0, t^* + L/(\bwtime\slotduration))$, then the adversary attaches a block $b'$ produced in slot $t'$ to 
    %
    the chain $\Chain$.
    The adversary makes the following updates,
    \begin{itemize}
        \item $\Chain_0 \gets \text{ chain ending in } b^*$,
        \item $\Chain \gets \text{ chain ending in } b'$,
        \item $t_0 \gets t^*$,
        \item $L \gets L+1$,
    \end{itemize}
    and thereafter repeats steps~%
    %
    \ref{item:tp-attack-exec-start}--\ref{item:tp-attack-exec-end}.
    
    If the adversary failed to get one block production opportunity in $[t_0, t^* + L/(\bwtime\slotduration))$, then the adversary gives up.
    %
\end{enumerate}

%
%
%
%
%
%


\input{figures/fig-pos-attack.tex}

%

%

%
%


\subsection{Analysis Overview}
\label{sec:tp-attack-analysis-overview}
The analysis below reuses notation defined in \cref{sec:analysis-definitions}.
For the attack to succeed, we assume the following:
\begin{itemize}
    %
    \item The protocol parameters $\blkrateslot,\slotduration$ satisfy $\frac{\blkrateslot}{\slotduration} > \frac{\bwtime}{\log\kappa}\log\frac{1-\beta}{\beta}$, where $\beta$ is the fraction of adversarial nodes and $\bwtime$ is the bandwidth constraint of each honest node in blocks per second.
    \item The total number of nodes $N$ is large.
    \item The adversary is allowed to break ties among equally long chains in the fork choice rule.
    \item The adversary is allowed to break ties among equal priority chains in the download rule.
    %
\end{itemize}

The fork length $L=\log(\kappa)$ is chosen such that the adversary can succeed in the setup phase with probability at least $e^{-O(L)} = 1/\poly(\kappa)$ at any given time, even with a minority stake. Hence this setup can be achieved by the adversary with non-negligible probability eventually during an execution of length $\poly(\kappa)$.

Now consider the execution phase. The key vulnerability exploited in this attack is that if the highest priority chain according to the download rule is on a long fork of which honest nodes have not downloaded any blocks, it will take a long time for honest nodes to download up to the tip of this chain. If the next block arrival happens before this chain is downloaded, the adversary makes honest nodes shift their download priority to a different chain, which is also on an equally long fork. This keeps repeating and honest nodes never finish downloading a chain that would help grow their longest downloaded chain.

Honest nodes get some respite when there is an honest block produced in slot $t^*$ such that there are no other blocks produced in slots $[t^*, t^*+L/(\bwtime\slotduration))$. The three download rules `download longest header chain', `download towards the freshest block', and `equivocation avoidance'
%
ensure that the honest block $b^*$ produced in slot $t^*$ remains the highest priority chain to download during the slots $[t^*, t^*+L/(\bwtime\slotduration))$. Given a bandwidth constraint of $\bwtime$ blocks per second, \ie, $\bwtime\slotduration$ blocks per time slot, honest nodes can completely download a fork of length $L$ in $L/(\bwtime\slotduration)$ time slots.

However, this does not end the attack. While waiting for one honest block production opportunity with $L/(\bwtime\slotduration)$ empty slots following it, if the adversary gets one block production opportunity, this allows the adversary to create a new chain whose length matches the longest downloaded chain of honest nodes.
The situation now looks just like at the start of the execution phase, except that the adversary's chain now forks from the honest nodes' new downloaded longest chain by $L+1$ blocks (one more than before).
The adversary then and repeats the execution phase all over again with the new chain it has produced, and with $L \gets L+1$.
%
As the adversary's fork length $L$ increase, it takes more time for honest nodes to download up to the tip of a newly produced block extending that fork.
This means it takes even longer for honest nodes to produce a block after which there are $L/(\bwtime\slotduration)$ empty slots such that the block gets downloaded.
Thereby, it becomes more likely that the adversary produces one block before honest downloads download a new chain, and continue the attack for another iteration with a larger fork length $L$.
%
As a result of this vicious cycle, 
%
%
the adversary can continue this attack forever with non-negligible probability!
%

This attack breaks safety of the protocol because the downloaded longest chain of honest nodes switches to a different chain every time the condition in \cref{sec:tp-attack-strategy}~\ref{item:tp-attack-exec-end} occurs.
%




\subsection{Analysis Details}
\label{sec:tp-attack-analysis-details}
Building up on the definitions from \cref{sec:analysis-definitions}, define a time slot $t$ to be \emph{honest} if $H_t>0$, and \emph{attacking} if $A_t>0$. 
%
%
Also define $\Hint{r,s}$ and $\Aint{r,s}$ as the number of honest and attacking slots respectively in the interval $(r,s]$.
$\Bint{r,s}$ is the number of slots $t \in (r,s]$ such that $H_t + A_t > 0$. 

%
%
%

\begin{definition}
For all $t$, define the event  
\begin{IEEEeqnarray}{C}
    %
    F_t := \left\{ \exists r < t \colon (\Hat{r} > 0) \land (\Aint{r,t} \geq \Hint{r,t}) \land (\Aint{r,t} \geq L) \right\}. \nonumber\IEEEeqnarraynumspace
\end{IEEEeqnarray}
\end{definition}

\begin{lemma}
If $F_{t}$ occurs, then the setup phase of the attack succeeds at time slot $t$, \ie, there exists an adversarial strategy which creates a chain $\Chain$ that forks off the longest downloaded chain of all honest nodes at time $t$ by $L$ blocks and is at least as long as the longest downloaded chain.
\end{lemma}
\begin{proof}
Let $b$ be an honest block produced in slot $r<t$ where $r$ satisfies $(\Hat{r} > 0) \land (\Aint{r,t} \geq \Hint{r,t}) \land (\Aint{r,t} \geq L)$.
The adversary's strategy is as follows.
In time slot $r$, the adversary pushes the block $b$ to all nodes irrespective of bandwidth, so that $\len{\dC_p(r)} = \len{b}$ for all honest nodes $i$.
The adversary then creates a private chain using its own blocks, extending the block $b$ (all these blocks are kept hidden).
The adversary can add one block to this chain in every slot in which the adversary produces a block, therefore the length of the adversary's chain at time $t$ is $\len{b}+ \Aint{r,t}$.
On the other hand, in every time slot that an honest block is produced, at most one block is added to the longest chain of all honest nodes, therefore the length of the honest chain at time $t$ is at most $\len{b} + \Hint{r,t}$.
Since $\Aint{r,t} \geq \Hint{r,t}$, the adversary's chain has the same or greater length compared to the honest chain at time slot $t$.
Since the last block that is common between the honest and adversary's chain is $b$, and $\Aint{r,t} \geq L$, the adversary's chain forks off the honest chain by at least $L$ blocks.
Therefore, we have the required conditions for the attack setup.
Note that the adversary does not need to be able to predict when the event $F_t$ would occur. Since creating blocks in proof-of-stake does not require computation time, the adversary can create this chain after it observes that the event $F_t$ occurred.
\end{proof}

\begin{lemma}
\label{lem:no-download}
%
Let $t>t_0$ be a successful time slot (\ie, $\Hat{t}+\Aat{t} > 0$) such that there exists another successful time slot $t' \in (t, t+L/(\bwtime\slotduration)]$. 
Then none of the blocks produced in slot $t$ are ever downloaded by any honest node. Hence for all honest nodes $p$, $L_p(t'-1) = L_p(t)$.
\end{lemma}
\begin{proof}
For all blocks $b$ that are produced in slot $t$, the attack strategy in \cref{sec:tp-attack-strategy}
ensures that the number of blocks to be downloaded in the prefix of $b$ (including $b$) is $L+1$.
Since each honest node can download at most $\bwtime\slotduration$ blocks per time slots, no honest node can download the entire prefix within $L/(\bwtime\slotduration)$ time slots (the adversary does not push any blocks to honest nodes during this period). 
At time slot $t'$, either an adversarial block or an honest block (or both) are produced.
In either case, step \ref{item:tp-attack-exec-mid} of the execution phase ensures that at slot $t'$, this new block has the highest priority under all three download rules.
This is because i) it is clearly the freshest block at slot $t'$,
ii) it is one of the longest chains (and the adversary breaks ties), and
iii) it has a non-equivocating tip and has length $L+1$, which is one of the longest chains (and the adversary breaks ties), 
%
Therefore, at time slot $t'$, all honest nodes switch to download a different block, and therefore the block $b$ is not downloaded.
Since for all honest nodes $p$, no block is downloaded, it is clear that $L_p(t'-1) = L_p(t)$.
\end{proof}

%

\begin{lemma}
\label{lem:yes-download}
%
Let $t$ be a successful time slot such that for all time slots $t' \in (t, t+L/(\bwtime\slotduration)]$, there are no blocks produced in slot $t'$ (\ie, $\Hat{t'}+\Aat{t'} = 0$).
Then, each honest node downloads at least one block produced in slot $t$, and for all honest nodes $p$, $L_p(t+L/(\bwtime\slotduration)) = L_p(t)+1$.
\end{lemma}
\begin{proof}
Since $t$ is an honest time slot, let $b$ be one of the honestly produced blocks in this time slot. At time slot $t$, $b$ is one of the freshest blocks. It remains one of the freshest blocks until time slot $t+L/(\bwtime\slotduration)$ because there are no other blocks produced in this interval.
%
As per the attack strategy, for both honest and adversarial blocks $b$, the block $b$ is on the longest chain in every node's view, and is not an equivocation. 
%

In case of a tie in the download rules, we assume that all honest nodes break the tie in favour of the same block $b$ (as this is chosen by the adversary). Therefore, the block $b$ has the highest download priority for all honest nodes in slots $[t,t+L/(\bwtime\slotduration)]$. Since the number of blocks to be downloaded in the prefix of $b$ (including $b$) is $L+1$, these blocks can be downloaded before the end of slot $t+L/(\bwtime\slotduration)$. We know that $b$ is longer than all honest nodes' longest downloaded chains at slot $t$ because of the attack strategy and \cref{lem:no-download}. Therefore the length of the longest downloaded chain of every honest node grows by $1$.
\end{proof}

\begin{lemma}
\label{lem:tp-attack-safety-viol}
Let $t_{\mathrm a}$ be the first time slot such that $t_{\mathrm a} > t_0 + \Tconf$, $t_{\mathrm a}$ is a successful time slot, and there are no blocks produced in slots $(t_{\mathrm a},t_{\mathrm a}+L'/(\bwtime\slotduration)]$ where $L'$ is the value of the attacker's parameter $L$ at time slot $t_0+\Tconf$. If the attacker does not terminate before slot $t_{\mathrm a}$, then there is a safety violation.
\end{lemma}
\begin{proof}
At the end of time slot $t_0 + \Tconf$, let $\LOG{p}{t_0+\Tconf}$ denote the ledger output by an honest node $p$. Note that this ledger contains all blocks mined before slot $t_0$ in the longest downloaded chain of node $p$, $\dC_p(t_0+\Tconf)$. As per the attack strategy \cref{sec:tp-attack-strategy} steps~\ref{item:tp-attack-exec-start} and \ref{item:tp-attack-exec-mid}, the block produced in time slot $t_{\mathrm a}$ extends a different equivocating chain that forks off $\dC_p(t_0+\Tconf)$ by $L'$ blocks. Since there are no blocks produced in slots $(t_{\mathrm a},t_{\mathrm a}+L'/(\bwtime\slotduration)]$, all honest nodes download this new chain and hence update their longest downloaded chain. However, note that at least $L'$ blocks that were in $\LOG{p}{t_0+\Tconf}$ are replaced by different blocks in $\dC_p(t_{\mathrm a})$, and therefore $\LOG{p}{t_0+\Tconf}$ and $\LOG{p}{t_{\mathrm a}}$ are not prefixes of each other. This causes a safety violation. 
%
\end{proof}

\begin{lemma}
%
For all $t$,
\begin{IEEEeqnarray}{C}
    \Prob{ F_t } \geq \pu \left( 1 - 2e^{-L/9} \right) \frac{1}{\sqrt{8L}} e^{-4\constAttackSetup L},
\end{IEEEeqnarray}
where $\constAttackSetup = \frac{1}{4} \ln\left(\frac{p}{4\pu}\right) + \frac{3}{4} \ln \left(\frac{3p}{4\pu}\right)$
and 
%
$\pu \triangleq \Prob{\Hat{t} > 0} = 1 - e^{-(1-\beta)\blkrateslot}$.
%

\end{lemma}
\begin{proof}
Let $T = \frac{2L}{p}(1+\epsilon)$ for some $\epsilon>0$ and let $s=t-T$.
\begin{IEEEeqnarray}{rCl}
    && \Prob{ F_t} \nonumber \\
    &=& \Prob{ \exists r < t \colon (\Hat{r} > 0) \land (\Aint{r,t} \geq \Hint{r,t}) \land (\Aint{r,t} \geq L) } \nonumber \\
    &\geq& \Prob{ \Hat{s} > 0 \land \Aint{s,t} \geq \Hint{s,t} \land \Aint{s,t} \geq L } \nonumber \\
    &=& \Prob{ \Hat{s} > 0 } \Prob{ \Aint{s,t} \geq \Hint{s,t} \land \Aint{s,t} \geq L } \nonumber \\
    &\geq& \Prob{ \Hat{s} > 0 } \Prob{ \Hint{s,t} \leq L \land \Aint{s,t} \geq L } \nonumber \\
    &\geqA& \Prob{ \Hat{s} > 0 } \Prob{ \Hint{s,t} \leq L \land \Bint{s,t} \geq 2L } \nonumber \\
    &\geq& \pu \Prob{ \Hint{s,t} \leq L \land 2L \leq \Bint{s,t} \leq  2L (1+2\epsilon) } \nonumber \\
    %
    &\geq& \pu \Prob{ 2L \leq \Bint{s,t} \leq  2L (1+2\epsilon) } \nonumber \\
    && \> \Prob{ \Hint{s,t} \leq L \mid \Bint{s,t} = 2L (1+2\epsilon) } %
    %
\end{IEEEeqnarray}
where (a) is because $\Hint{s,t} + \Aint{s,t} \geq \Bint{s,t}$.
By Chernoff bounds for $\delta\in(0,1)$,
\begin{IEEEeqnarray}{rCl}
    \Prob{ \Bint{s,t} < p(t-s)(1-\delta) } &\leq& \exp\left( -\frac{p(t-s)\delta^2}{2} \right), \IEEEeqnarraynumspace \\
    \Prob{ \Bint{s,t} > p(t-s)(1+\delta) } &\leq& \exp\left( -\frac{p(t-s)\delta^2}{3} \right). \IEEEeqnarraynumspace
\end{IEEEeqnarray}
%
%
%
%
%
where $p \triangleq \Prob{\Hat{t} + \Aat{t} > 0} = 1 - e^{-\blkrateslot}$.
With $t-s = \frac{2L}{p}(1+\epsilon)$ and $\delta = \frac{\epsilon}{1+\epsilon}$,
\begin{IEEEeqnarray}{rCl}
    \Prob{ \Bint{s,t} < 2L } &\leq& \exp\left( \frac{-2L\epsilon^2}{2(1+\epsilon)} \right), \nonumber \\
    \Prob{ \Bint{s,t} > 2L(1+2\epsilon) } &\leq& \exp\left( \frac{-2L\epsilon^2}{3(1+\epsilon)} \right) \nonumber \\
    \Prob{ 2L \leq \Bint{s,t} \leq 2L(1+2\epsilon) } &\geq& 1 - 2\exp\left( \frac{-2L\epsilon^2}{3(1+\epsilon)} \right). \IEEEeqnarraynumspace
\end{IEEEeqnarray}
%
%
%
%
%
Each non-empty time slot ($\Hat{t}+\Aat{t}>0$) is an honest slot ($\Hat{t}>0$) independently with probability $\frac{\pu}{p}$. Therefore conditional on $\Bint{s,t}=2L(1+2\epsilon)$, $\Hint{s,t}$ has a binomial distribution. Then we can use tail bounds for the binomial distribution
%
to show that
\begin{IEEEeqnarray}{rCl}
    && \Prob{ \Hint{s,t} \leq L \mid \Bint{s,t} = 2L (1+\epsilon)} \nonumber \\
    &\geq& \frac{1}{\sqrt{4L(1+2\epsilon)}} \exp\left( -2\constAttackSetup L(1+2\epsilon) \right)
\end{IEEEeqnarray}
where $\constAttackSetup = D\left(\frac{1}{2(1+2\epsilon)} || \frac{\pu}{p} \right)$ and
\begin{IEEEeqnarray}{rCl}
    D(x || y) &=& x \ln\left(\frac{x}{y}\right) + (1-x)\ln\left(\frac{1-x}{1-y}\right).
\end{IEEEeqnarray}
%
%
Putting these together,
\begin{IEEEeqnarray}{rCl}
    \Prob{ F_t } \geq \pu \left(1 - 2e^{\frac{-2L\epsilon^2}{3(1+\epsilon)}} \right) \frac{1}{\sqrt{4L(1+2\epsilon)}} e^{-2\constAttackSetup L(1+2\epsilon)}.   \IEEEeqnarraynumspace
\end{IEEEeqnarray}
%
%
%
%
Since $\epsilon$ is arbitrary, we may choose $\epsilon = \frac{1}{2}$ to get a lower bound on the required probability.
\end{proof}

\begin{corollary}
\label{cor:attack_setup_prob}
    For large $\kappa$, if $L=\Theta(\log \kappa)$ and $\blkrateslot=\Omega\left(\frac{1}{n}\right)$, then $\Prob{F_t} \geq \frac{1}{\poly(\kappa)}$.
\end{corollary}

Recall that the attack goes on forever if the attacker gets one block production opportunity before the honest nodes download a longer chain. We have seen that honest nodes download a longer chain if and only if a non-empty slot is followed by at least $L/\bwtime$ empty time slots.

\begin{definition}
A successful time slot $t$ is called a $T$-loner if no blocks are produced in the $T$ slots following $t$, \ie, $\Bint{t+1,t+T}=0$.
The predicate $\TLoner{T}{t}$ is true iff slot $t$ is a $T$-loner.
\end{definition}
We observe that
\begin{IEEEeqnarray}{c}
    \Prob{\TLoner{T}{t} \mid \Hat{t} + \Aat{t} > 0} = (1-p)^{T} .
\end{IEEEeqnarray}
%

\begin{lemma}
%
\label{lem:tp-attack-t-loner-prob}
If $(1-\beta)e^{-\blkrateslot T} < \beta$, then the probability that the adversary gets one block production opportunity before a $T$-loner occurs is at least $1 - \frac{(1-\beta)
e^{-\blkrateslot T}}{\beta} > 0$.
\end{lemma}
\begin{proof}
We begin by calculating the probability there is at least one attacking slot before there is an $T$-loner. This ensures that the final step of the attack in \cref{sec:tp-attack-strategy} is successful and that the adversary can updates it state and continue the attack.
Let $t_1,t_2,...$ be the sequence of successful slots since the start of the attack. Let $t_N$ be the first $T$-loner in this sequence (note that $N$ is a random variable).
\begin{IEEEeqnarray}{rCl}
    &&\Prob{\exists i \leq N \colon \Aat{t_i} > 0} \nonumber \\
    &=& \sum_{k=1}^{\infty} \Prob{N=k} \Prob{\exists i \leq k \colon \Aat{t_i} > 0 \mid N=k}. \IEEEeqnarraynumspace
\end{IEEEeqnarray}
Here,
\begin{IEEEeqnarray}{rCl}
    \Prob{N=k} &=& \prod_{i=1}^{k-1} \Prob{ \lnot \TLoner{T}{t_i} \mid \Hat{t_i}+\Aat{t_i}>0} \nonumber \\
    && \> \Prob{ \lnot \TLoner{T}{t_k} \mid \Hat{t_k}+\Aat{t_k}>0} \nonumber \\
    &=& \left(1 - (1-p)^{T}\right)^{k-1} (1-p)^T.
\end{IEEEeqnarray}
Moreover, conditioned on $t$ being a successful slot, the events $\TLoner{T}{t}$ and $A_t>0$ are independent. Therefore,
\begin{IEEEeqnarray}{rCl}
    && \Prob{\exists i \leq k \colon \Aat{t_i} > 0 \mid N=k} \nonumber \\
    &=& 1 - \prod_{i=1}^{k} \Prob{\Aat{t_i} = 0 \mid \Aat{t_i}+\Hat{t_i}>0} \nonumber \\
    &=& 1 - \left( \frac{e^{-\beta\blkrateslot}(1-e^{-(1-\beta)\blkrateslot})}{(1-e^{-\blkrateslot})} \right)^k \nonumber \\
    &=& 1 - \left( 1 - \frac{1-e^{-\beta\blkrateslot}}{1-e^{-\blkrateslot}} \right)^k \nonumber \\
    %
    &\geq& 1 - (1-\beta)^k
\end{IEEEeqnarray}
Putting them together,
\begin{IEEEeqnarray}{rCl}
    && \Prob{\exists i \leq N \colon \Aat{t_i} > 0} \\
    &\geq& \sum_{k=1}^{\infty} \left(1 - (1-p)^{T}\right)^{k-1} (1-p)^T \left(1 - (1-\beta)^k \right) \nonumber \\
    &=& 1 - \frac{(1-p)^T(1-\beta)}{1-(1-(1-p)^T)(1-\beta)} \nonumber \\
    &\geq& 1 - \frac{(1-p)^T(1-\beta)}{\beta}.
\end{IEEEeqnarray}
Finally, we substitute $p = 1-e^{-\blkrateslot T}$.
\end{proof}

\begin{lemma}
\label{lem:tp-attack-never-terminates}
If the protocol parameters $\blkrateslot,\slotduration$ satisfy $\frac{\blkrateslot}{\slotduration} > \frac{\bwtime}{L}\log\frac{1-\beta}{\beta}$, then with probability non-negligible in $\kappa$, the attack never terminates.
\end{lemma}
\begin{proof}
From \cref{cor:attack_setup_prob}, for $L=\log(\kappa)$ and large enough $\blkrateslot$, the attack setup occurs with non-negligible probability.

If the adversary gets one block production opportunity before an $L/(\bwtime\slotduration)$-loner, then the adversary can continue the attack by upgrading $L$ to $L+1$. This means that in the next iteration of the attack, the adversary needs one block production opportunity before an $(L+1)/(\bwtime\slotduration)$-loner. Since an $(L+1)/(\bwtime\slotduration)$-loner is rarer than an $L/(\bwtime\slotduration)$-loner, the adversary has increased chances of getting one block production before an $(L+1)/(\bwtime\slotduration)$-loner, and therefore upgrading the attack to $L+2$. This process repeats whereby if the adversary upgrades the attack to the next phase, it increases the chance that the attacker can further upgrade the attack to the next phase, and so forth.

The probability that the attack continues forever is therefore
\begin{IEEEeqnarray}{rCl}
    \Prob{\text{attack continues forever}}
    &\geq& \prod_{l=L}^{\infty} \left( 1 - \frac{(1-\beta) e^{-\frac{\blkrateslot l}{\bwtime\slotduration}}}{\beta} \right) \nonumber \\
    &\geq& \prod_{l=L}^{\infty} \left( 1 - e^{-\frac{\blkrateslot (l-L)}{\bwtime\slotduration}} \right) \nonumber \\
    &=& \prod_{l=1}^{\infty} \left( 1 - e^{-\frac{\blkrateslot l}{\bwtime\slotduration}}\right) \nonumber \\
    &=& \left( e^{-\frac{\blkrateslot}{\bwtime\slotduration}} ; e^{-\frac{\blkrateslot}{\bwtime\slotduration}} \right)_\infty. \label{eq:tp-attack-prob-lb}
\end{IEEEeqnarray}
Here, $\left(x;x\right)_{\infty}$ is called the $q$-Pochhammer symbol and $\left(x;x\right)_{\infty} \in (0,1)$ for all $x\in(0,1)$ \cite{pochhammer}.
The condition $\frac{\blkrateslot}{\slotduration} > \frac{\bwtime}{L}\log\frac{1-\beta}{\beta}$ is derived from the condition in \cref{lem:tp-attack-t-loner-prob} with $T = \frac{L}{\bwtime\slotduration}$.
\end{proof}

%

\begin{corollary}
For the protocol $\protocol$ to satisfy safety and liveness, the throughput of the protocol must be $O\left(\frac{1}{\log\kappa}\right)$.
\end{corollary}
This is seen by noting that the throughput is $\frac{1-e^{-\blkrateslot}}{\slotduration} \leq \frac{\blkrateslot}{\slotduration} \leq \frac{\bwtime}{\log\kappa}\log\frac{1-\beta}{\beta}$. If this is not true, then the attacker never terminates, hence there is a safety violation as per \cref{lem:tp-attack-safety-viol}. The maximum block production rate $\lambda = \frac{\blkrateslot}{\slotduration}$ calculated from \cref{lem:tp-attack-never-terminates} is plotted in \cref{fig:comparison-bddelay-bdbandwidth}(b).