\subsection{Security of Proof-of-Work Nakamoto Consensus}
\label{sec:fullproof-pow}


%
In \cref{lem:pow-security-condition}, we showed that under the
\rulelc download rule, \sltcps occur in every $\Kcp$-interval.
This allows us, together with \cref{lem:cps-stabilize} (\sltcps stabilize), to prove safety and liveness of the protocol for a suitable confirmation depth $\confDepth$.
Subsequently, we take $\slotduration \to 0$ and $\blkratetime \triangleq \blkrateslot/\slotduration$ in order to model PoW accurately. We then identify the values of $\blkratetime$ for which given an adversary fraction $\beta$, the conditions required in \cref{lem:one-cp-induction-full} for \sltcps to occur hold with overwhelming probability. Finally, since $\goodsepbw$ was an analysis parameter chosen arbitrarily, we maximize over this parameter to find the best possible security--performance tradeoff (\cref{thm:safety-and-liveness-pow}).
The result is plotted for $\DeltaHeader \approx 0$ (reasonable approximation for large block sizes) in \cref{fig:comparison-bddelay-bdbandwidth}.


%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
\RestateThmSafetyAndLivenessPow*



For PoW, we take $\slotduration \to 0$, and we would like to express parameters such as mining rate, confirmation latency, and execution time horizon in terms of real-time rather than the fictitious \timeslots or \iindices.
We use \cref{prop:index-time-bridge-pow} to bridge from \iindices 
%
to units of real-time,
which uses a Poisson tail bound to show that the inter-arrival time between \BPOs cannot be too large or too small.

\begin{proposition}
    \label{prop:index-time-bridge-pow}
    \begin{IEEEeqnarray}{rl}
        \forall k, K \in \IN \colon &
        \Prob{ \slotduration(t_{k+K} - t_{k}) \geq \frac{K}{\blkratetime(1-\delta)} } \leq e^{ \frac{-K\delta^2}{2(1+\delta)}},
        \IEEEeqnarraynumspace\\
        &
        \Prob{ \slotduration(t_{k+K} - t_{k}) \leq \frac{K}{\blkratetime(1+\delta)} } \leq e^{ \frac{-K\delta^2}{2(1+\delta)}}.
        \IEEEeqnarraynumspace
    \end{IEEEeqnarray}
\end{proposition}
%
\begin{proof}
    This results from a Poisson tail bound~\cite{poisson_tail} for the number of \BPOs in real time $K/\blkratetime$, and noting that 
    non-\sltempty \timeslots have exactly one \BPO
    for $\slotduration \to 0$.
\end{proof}


To prove \cref{thm:safety-and-liveness-pow}, 
we 
%
%
recall that
there is at least one \sltcp in the interval $\intvl{k}{k+2\Kcp}$ (\cref{lem:pow-security-condition}).
Given this, we prove safety and liveness of PoW NC in \cref{lem:safety-and-liveness-comb-pow}.
%
Finally, in
\cref{thm:safety-and-liveness-pow}, we calculate for given $\beta, \bwtime, \DeltaHeader$, the protocol parameters $\blkrateslot, \slotduration$ for which PoW NC is secure.
In doing so, since $\goodsepbw$ is just an analysis parameter, we optimize over $\goodsepbw$ to find the maximum $\blkratetime$.



\begin{lemma}
    \label{lem:safety-and-liveness-comb-pow}
    If for some $\Kcp > 0$,
    \begin{IEEEeqnarray}{C}
        \label{eq:condition-one-cp-m-pow-safety}
        \forall k \colon \exists k^* \in \intvl{k}{k+2\Kcp} \colon \predCP{k^*},
        \IEEEeqnarraynumspace
    \end{IEEEeqnarray}
    then the PoW Nakamoto consensus protocol $\protocol$ with $\confDepth = 2\Kcp + 1$ satisfies safety.
    Further, if the environment is $(\tput, \Ttput)$-tx-limited with $\tput = (1+\delta)\left(\frac{1}{2} - \frac{1-e^{-\beta\blkrateslot}}{1-e^{-\blkrateslot}}(1+\delta)\right)\blkratetime\slotduration$ and $\Ttput = \frac{2\Kcp}{\blkratetime\slotduration(1+\delta)}$, and
    \begin{IEEEeqnarray}{C}
        \label{eq:cond-index-time-bridge-pow}
        \forall k \in \IN, K \geq \Kcp\colon
        \quad
        \frac{K}{\blkratetime\slotduration(1+\delta)} < t_{k+K} - t_{k} < \frac{K}{\blkratetime\slotduration(1-\delta)},
        \IEEEeqnarraynumspace
    \end{IEEEeqnarray}
    then it also satisfies liveness with $\Tlive = \max\left\{\Ttput,\frac{2\Kcp}{\blkratetime\slotduration(1-\delta)}\right\} + \frac{4\Kcp + 2}{\blkratetime\slotduration(1-\delta)}$.
\end{lemma}
\begin{proof}
    \emph{Safety:}
    For an arbitrary \timeslot $t$, let $k$ be the largest \iindex such that $t_k \leq t$.
    From \eqref{condition-one-cp-m-pow-safety}, every interval of $2\Kcp$ \iindices contains at least one \sltcp. Therefore, there exists $k^* \in \intvl{k-2\Kcp-1}{k-1}$ such that $\predCP{k^*}$.
    Let $b^*$ be the block from \iindex $k^*$.
    Due to \cref{lem:cps-stabilize}, for all honest nodes $p,q$ and $t' \geq t$,
    $b^* \in \dC_p(t)$ and $b^* \in \dC_q(t')$.
    But $k^* \geq k-\confDepth$, so the block $b^*$ cannot be $\confDepth$-deep in any chain at \timeslot $t$ Therefore, $\LOG{p}{t}$ is a prefix of $b^*$ which in turn is a prefix of $\dC_q(t')$.
    We can thus conclude that
    either 
    $\LOG{p}{t} \preceq \LOG{q}{t'}$ or $\LOG{q}{t'} \preceq \LOG{p}{t}$.
    Therefore, safety holds.


    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %
    %


    For an arbitrary \timeslot $t$, let $k$ be the largest \iindex such that $t_k \leq t$.
    We will first prove that all transactions received in \timeslots $t - \Ttput$ to $t$, which are of total size at most $\tput\Ttput$ as per the tx-limited environment, will be added to the longest downloaded chains of all nodes by the \timeslot corresponding to \iindex $k + 2\Kcp$.
    Let $\Ktput = \max\{2\Kcp, \blkratetime \slotduration (1+\delta) \Ttput\}$.
    We know that there exists $k^* \in (k,k+2\Ktput]$ such that $\predCP{k^*}$.
    %
    %
    %
    %
    %
    Since $k^*$ is a \sltcp, for all $\intvl{i}{j} \ni k^*$, $\Din{i}{j} > \Nin{i}{j}$ (\cref{def:cp} and \eqref{random_walks_X_and_Y}), and hence $\Din{i}{j} > \frac{j-i}{2}$.
    Particularly,
    \begin{IEEEeqnarray}{rCl}
        %
        \implies \Din{k}{k + \Ktput - 1} &>& \frac{\Ktput-1}{2}.
        \IEEEeqnarraynumspace
    \end{IEEEeqnarray}
    Then from \cref{prop:chain-growth-interval},
    \begin{IEEEeqnarray}{rCl}
        L_{\min}(t_{k+\Ktput-1}+\goodsep) - L_{\min}(t_{k+1}-1) &\geq& \Din{k}{k + \Ktput - 1} \nonumber \\
        &\geq& \frac{\Ktput}{2}.
        \IEEEeqnarraynumspace
    \end{IEEEeqnarray}
    This means that the $\Ktput/2$ last blocks in any node's longest downloaded chain at \timeslot $t_{k+\Ktput-1+\goodsep}$ are from the \iindices $\intvl{k}{k+\Ktput-1}$.
    Among these, the number of blocks produced by the adversary can be, by a concentration bound, at most $\frac{1-e^{-\beta\blkrateslot}}{1-e^{-\blkrateslot}}(1+\delta)\Ktput$.
    Therefore, at least $\left(\frac{1}{2} - \frac{1-e^{-\beta\blkrateslot}}{1-e^{-\blkrateslot}}(1+\delta)\right)\Ktput$ blocks are produced by honest nodes.
    The cumulative size of pending transactions is at most $\tput \Ttput$, which fits in these honest blocks.
    Finally, we use \cref{prop:chain-growth-interval} again to show:
    \begin{IEEEeqnarray}{rCl}
        L_{\min}(t_{k+\Ktput+2\confDepth-1}+\goodsep) - L_{\min}(t_{k+2\confDepth+1}-1) &\geq& \confDepth.
        \IEEEeqnarraynumspace
    \end{IEEEeqnarray}
    Thus, the newly added transactions are $\confDepth$-deep, hence confirmed, by all nodes by \iindex $k + 2\Kcp + 2\confDepth$.
    Finally, with \eqref{cond-index-time-bridge-pow},
    \begin{IEEEeqnarray}{rCl}
        t_{k+\Ktput + 2\confDepth-1}+\goodsep - t &\leq& t_{k + \Ktput + 4\Kcp + 1} + \goodsep - t_{k} \nonumber \\
        &\leq& t_{k + 6\Kcp + 2} - t_{k} \nonumber \\
        &<& \frac{\Ktput + 4\Kcp + 2}{\blkratetime\slotduration(1-\delta)}.
        \IEEEeqnarraynumspace
    \end{IEEEeqnarray}
    Therefore, $\mathsf{tx}\in\LOG{p}{t'}$ for all $t'\geq t+\Tlive$.
\end{proof}




\begin{proof}[Proof of \cref{thm:safety-and-liveness-pow}]
    From \cref{lem:pow-security-condition}, assuming
    \begin{IEEEeqnarray}{C}
        \label{eq:C-equation-pow}
        \frac{\goodsepbw}{16} \frac{(2\probGood-1)^2}{\probGood} (1-\delta) > 1,
    \end{IEEEeqnarray}
    and from a union bound over horizon $\Khorizon = \poly(\kappa)$
    on the result of \cref{prop:index-time-bridge-pow},
    the conditions required for \cref{lem:safety-and-liveness-comb-pow} are satisfied with overwhelming probability.
    Then \cref{lem:safety-and-liveness-comb-pow} guarantees safety and liveness with $\confDepth = 2\Kcp = \Theta(\kappa^2)$ and $\Tlive = \frac{6\Kcp+2}{\blkratetime\slotduration(1-\delta)} = \Theta(\kappa^2)$.
    
    
    \Iindices are mapped to real time as $\TliveReal \triangleq \Tlive \slotduration$.
    Further, the event $\{\slotduration t_{\Khorizon} > \frac{\Khorizon}{\blkratetime(1+\delta)} \}$ also occurs except with negligible probability (\cref{prop:index-time-bridge-pow}), and therefore the time horizon $\Khorizon$ \iindices corresponds to at least a time horizon of $\Thorizon \triangleq \frac{\Khorizon}{\blkratetime(1+\delta)}$ real-time units.
    
    
    Finally, we take the limit $\slotduration \to 0$.
    With the relations $\blkratetime = \blkrateslot/\slotduration$, $\BWEquation$, and 
    $\probPP = \probPPFormula$,
    \begin{IEEEeqnarray}{C}
        \label{eq:prob-good-equation-pow}
        \probGood = \probGoodFormula \to (1-\beta)e^{-\blkratetime\left(\DeltaHeader + \goodsepbw/\bwtime\right)}.
        \IEEEeqnarraynumspace
    \end{IEEEeqnarray}

    Moreover, the value of $\tput$ from \cref{lem:safety-and-liveness-comb-pow} converges to $(1+\delta)(\frac{1}{2}-\beta(1+\delta))\blkratetime$ in real-time units.
    
    Note that $\goodsepbw$ is an analysis parameter whose value is arbitrary.
    To find the maximum block production rate $\blkratetime$ that the protocol can achieve, we optimize over $\goodsepbw$.
    To find the maximum achievable $\blkratetime$,
    we can take $\delta \to 0$ as we can increase the latency through increasing $\Kcp$ to still satisfy the error bounds.
    Maximizing over $\goodsepbw$ from \eqref{C-equation-pow,prob-good-equation-pow} gives the resulting threshold.
\end{proof}



