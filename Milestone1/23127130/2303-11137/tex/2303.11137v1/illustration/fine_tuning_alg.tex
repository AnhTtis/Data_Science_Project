% \begin{algorithm}
% \label{alg:fine_tuning}
% \SetAlgoLined
% \KwData{\, $\epsilon_\theta$ pretrained noise prediction model, \\
% \qquad\quad $\widetilde{I}_{gt}(\ )$ ground truth estimation function, \\
% \qquad\quad $\mathcal{T}' = \{t'_{0}, \cdots T'\}$ sampled time sequence, \\
% \qquad\quad $\mathcal{I} = \{I_{gt, 0}, \cdots I_{gt, n}\}$ images for fine-tuning.
% }
% \KwResult{$\hat{\epsilon}_\theta$ fine-tuned noise prediction model}

% \texttt{\# Forward process}\;

% $\hat{\mathcal{I}} \leftarrow \{\ \}$ \;

% \For{$I_{gt}$ \texttt{in} $\mathcal{I}$}{
%     \For{$t'$ \texttt{in} $T'$}{
%         $\widetilde{\epsilon} \leftarrow \epsilon_\theta(I_l, I_r, I_{noise}^{t'}, t')$\;
        
%         $I_{noise}^{(t' + 1)} \leftarrow \sqrt{\bar{\alpha}_{t' + 1}}\cdot \widetilde{I}_{gt}(I_{noise}^{t'}) + \sqrt{1 - \bar{\alpha}_{t' + 1}}\cdot \widetilde{\epsilon} $ \;
%     }\;
%     $\hat{\mathcal{I}} \leftarrow \hat{\mathcal{I}} \cup \{I_{noise}^{T'}\}$\; 
% }

% \texttt{\# Reverse process for fine-tuning}\;

% $\hat{\epsilon}_\theta \leftarrow \epsilon_\theta$\;

% \For{$I_{noise}^{T'}$ \texttt{in} $\mathcal{\hat{I}}$}{
%     \For{$t'$ \texttt{in} \texttt{reverse}($\mathcal{T}'$)}{
%         $\widetilde{\epsilon} \leftarrow \epsilon_\theta(I_l, I_r, I_{noise}^{t'}, t')$\;

%         $I_{noise}^{(t' - 1)} \leftarrow \sqrt{\bar{\alpha}_{t' - 1}}\cdot \widetilde{I}_{gt}(I_{noise}^{t'}) + \sqrt{1 - \bar{\alpha}_{t' - 1}}\cdot \widetilde{\epsilon} $ \;
%     }
%     $I_{gen} \leftarrow I_{noise}^{(t'_{0})}$\;
    
%     $\mathcal{L} \leftarrow \mathbbm{E}_{{I}_{gt} \sim q({I}_{gt}), \epsilon \sim \mathcal{N}(\mathbf{0}, \mathbf{I})}\parallel I_{gen} - I_{gt} \parallel_p^p$\;
    
%     \texttt{Gradient step:} $\nabla_{\hat{\epsilon_\theta}} \mathcal{L}$
% }

% \caption{Anime Diffusion Fine-tuning}
% \end{algorithm}

\renewcommand{\algorithmicrequire}{\textbf{Input:}}
\renewcommand{\algorithmicensure}{\textbf{Output:}}

\begin{algorithm}
\caption{Anime Diffusion Fine-tuning}
\begin{algorithmic}[1]
\REQUIRE{\, $\epsilon_\theta$ pretrained noise prediction model, \\
\qquad $\mathcal{I}$ training anime face images, \\
\qquad $S$ number of sampling steps 
}
\ENSURE{$\hat{\epsilon}_\theta$ fine-tuned noise prediction model}
\STATE Initialize list of forward noisy images $\hat{\mathcal{I}}$;
\STATE Sampling a increasing sub-sequence $\mathcal{T}' = \{t'_{0}, \cdots T'\}$ of length $S$;
\FOR{$I_{gt}$ \textbf{in} $\mathcal{I}$}
    \FOR{$t'$ \textbf{in} $\mathcal{T}'$}
        \STATE Calculate $\widetilde{\epsilon} \leftarrow \epsilon_\theta(I_l, I_r, I_{noise}^{t'}, t')$;
        \STATE Predict the ground truth $\widetilde{I}_{gt}(I_{noise}^{t'}, t')$;
        \STATE Forward step $I_{noise}^{(t' + 1)} \leftarrow \sqrt{\bar{\alpha}_{t' + 1}} \widetilde{I}_{gt} + \sqrt{1 - \bar{\alpha}_{t' + 1}}\widetilde{\epsilon}$;
    \ENDFOR
    \STATE Update $\hat{\mathcal{I}}$;
\ENDFOR
\FOR{$I_{noise}^{T'}$ \textbf{in} $\mathcal{\hat{I}}$}
    \FOR{$t'$ \textbf{in} \texttt{reverse}($\mathcal{T}'$)}
        \STATE Calculate $\widetilde{\epsilon} \leftarrow \epsilon_\theta(I_l, I_r, I_{noise}^{t'}, t')$;
        \STATE Predict the ground truth $\widetilde{I}_{gt}(I_{noise}^{t'}, t')$;
        \STATE Reverse step $I_{noise}^{(t' - 1)} \leftarrow \sqrt{\bar{\alpha}_{t' - 1}}\widetilde{I}_{gt} + \sqrt{1 - \bar{\alpha}_{t' - 1}}\widetilde{\epsilon}$;
    \ENDFOR
    \STATE Update reconstruction loss $L_{rec}$;
    \STATE Gradient step $\nabla_{\hat{\epsilon}_\theta} L_{rec}$
\ENDFOR
\end{algorithmic}
\end{algorithm}