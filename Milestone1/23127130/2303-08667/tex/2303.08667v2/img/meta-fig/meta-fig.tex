%
%
%

%
\definecolor{barCol0}{HTML}{0f007d}
\definecolor{barCol1}{HTML}{36008f}
\definecolor{barCol2}{HTML}{6500a1}
\definecolor{barCol3}{HTML}{9e00b3}
\definecolor{barCol4}{HTML}{c500a9}
\definecolor{barCol5}{HTML}{d60082}
\definecolor{barCol6}{HTML}{e80051}
\definecolor{barCol7}{HTML}{fa0018}
\definecolor{barCol8}{HTML}{ff340d}
\definecolor{barCol9}{HTML}{ff7c1f}

%
\pgfplotstableread[col sep=comma]{img/meta-fig/meta-fig.csv}\data

%
\newcommand{\errplot}[3]{%
%
\begin{tikzpicture}[trim axis left, trim axis right]
\begin{axis}[
  y=-\baselineskip,
  scale only axis,
  width=32mm,
  enlarge y limits={abs=0.5},
  axis y line*=middle,
  ytick=\empty,
  axis x line*=bottom,
  xbar,
  xbar=0pt,
  bar shift=0pt,
  bar width=2.1ex,
  xmin=0,
  ymin=0,
  ymax=44,
  nodes near coords custom/.style={ %
    small value/.style={
      color=black,
      fill=white,
      inner xsep=0.8pt, %
      inner ysep=1.5pt, %
      outer sep=1.8pt, %
    },
    large value/.style={
      color=white,
      anchor=east,
    },
    every node near coord/.style={
      switch label style/.code={%
        \begingroup
        %
        \pgfkeys{/pgf/fpu}%
        \pgfmathparse{\pgfplotspointmeta<##1}%
        \global\let\result=\pgfmathresult
        \endgroup
        %
        %
        %
        %
        \pgfmathfloatcreate{1}{1.0}{0}%
        \let\ONE=\pgfmathresult
        \ifx\result\ONE
          %
          \pgfkeysalso{/pgfplots/small value}%
        \else
          %
          \pgfkeysalso{/pgfplots/large value}%
        \fi
      },
      switch label style,
      font=\scriptsize,
      text depth=0pt, %
    },
  },
  nodes near coords={\pgfmathprintnumber[fixed zerofill,precision=#3]{\pgfplotspointmeta}},
  nodes near coords custom=#2,
  xticklabel style={
    /pgf/number format/fixed,
    /pgf/number format/precision=5,
  },
  scaled x ticks=false
]
%

\ifthenelse{\equal{#1}{missions}}{
\addplot [restrict x to domain=  0:7, fill=barCol0, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 7:14, fill=barCol1, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=14:21, fill=barCol2, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=21:28, fill=barCol3, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=28:35, fill=barCol4, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=35:42, fill=barCol5, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=42:49, fill=barCol6, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=49:56, fill=barCol7, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=56:63, fill=barCol8, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=63:70, fill=barCol9, draw=black] table [x=#1,y expr=\coordindex]{\data};
}{}

\ifthenelse{\equal{#1}{distance}}{
\addplot [restrict x to domain=    0: 1220, fill=barCol0, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 1220: 2440, fill=barCol1, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 2440: 3660, fill=barCol2, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 3660: 4880, fill=barCol3, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 4880: 6100, fill=barCol4, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 6100: 7320, fill=barCol5, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 7320: 8540, fill=barCol6, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 8540: 9760, fill=barCol7, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 9760:10980, fill=barCol8, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=10980:12200, fill=barCol9, draw=black] table [x=#1,y expr=\coordindex]{\data};
}{}

\ifthenelse{\equal{#1}{passengers}}{
\addplot [restrict x to domain= 6.0: 7.8, fill=barCol0, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 7.8: 9.6, fill=barCol1, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain= 9.6:11.4, fill=barCol2, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=11.4:13.2, fill=barCol3, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=13.2:15.0, fill=barCol4, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=15.0:16.8, fill=barCol5, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=16.8:18.6, fill=barCol6, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=18.6:20.4, fill=barCol7, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=20.4:22.2, fill=barCol8, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=22.2:24.0, fill=barCol9, draw=black] table [x=#1,y expr=\coordindex]{\data};
}{}

\ifthenelse{\equal{#1}{energyCons}}{
\addplot [restrict x to domain=1.30:1.39, fill=barCol0, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=1.39:1.48, fill=barCol1, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=1.48:1.57, fill=barCol2, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=1.57:1.66, fill=barCol3, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=1.66:1.75, fill=barCol4, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=1.75:1.84, fill=barCol5, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=1.84:1.93, fill=barCol6, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=1.93:2.02, fill=barCol7, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=2.02:2.11, fill=barCol8, draw=black] table [x=#1,y expr=\coordindex]{\data};
\addplot [restrict x to domain=2.11:2.20, fill=barCol9, draw=black] table [x=#1,y expr=\coordindex]{\data};
}{}


\end{axis}
\end{tikzpicture}%
%
}

%
\pgfplotstablegetrowsof{\data}
\let\numberofrows=\pgfplotsretval

%
\pgfplotstabletypeset[columns={date, missions, distance, passengers, energyCons},
  %
  every head row/.style={before row=\toprule,after row=\midrule},
  every last row/.style={after row=[3ex]\bottomrule},
  %
  columns/date/.style={
    column type=l,
    column name={Year, Month},
    string type,
    assign cell content/.code={%
      \pgfkeyssetvalue{/pgfplots/table/@cell content}{\raisebox{-1pt}{\DTMsetdatestyle{year-comma-short-month}\DTMdate{##1-01}}}%
    },
  },
  columns/missions/.style={
    column type=l,
    column name={\parbox[l]{32mm}{\raggedright Number of\\driving missions}},
    assign cell content/.code={%
      \ifnum\pgfplotstablerow=0
        \pgfkeyssetvalue{/pgfplots/table/@cell content}{\multirow{\numberofrows}{32mm}{\errplot{missions}{40}{0}}}%
      \else
        \pgfkeyssetvalue{/pgfplots/table/@cell content}{}%
      \fi
    },
  },
  columns/distance/.style={
    column type=l,
    column name={\parbox[l]{32mm}{\raggedright Total distance\\driven \mbox{(in \si{\kilo\meter})}}},
    assign cell content/.code={%
      \ifnum\pgfplotstablerow=0
        \pgfkeyssetvalue{/pgfplots/table/@cell content}{\multirow{\numberofrows}{32mm}{\errplot{distance}{7000}{0}}}%
      \else
        \pgfkeyssetvalue{/pgfplots/table/@cell content}{}%
      \fi
    },
  },
  columns/passengers/.style={
    column type=l,
    column name={\parbox[l]{32mm}{\raggedright Average number\\of passengers}},
    assign cell content/.code={%
      \ifnum\pgfplotstablerow=0
        \pgfkeyssetvalue{/pgfplots/table/@cell content}{\multirow{\numberofrows}{32mm}{\errplot{passengers}{15}{1}}}%
      \else
        \pgfkeyssetvalue{/pgfplots/table/@cell content}{}%
      \fi
    },
  },
  columns/energyCons/.style={
    column type=l,
    column name={\parbox[l]{32mm}{\raggedright Mean energy con-\\sump\-tion \mbox{(in \si{\kilo\watt\hour\per\kilo\meter})}}},
    assign cell content/.code={%
      \ifnum\pgfplotstablerow=0
        \pgfkeyssetvalue{/pgfplots/table/@cell content}{\multirow{\numberofrows}{32mm}{\errplot{energyCons}{1.5}{2}}}%
      \else
        \pgfkeyssetvalue{/pgfplots/table/@cell content}{}%
      \fi
    },
  },
]{\data}