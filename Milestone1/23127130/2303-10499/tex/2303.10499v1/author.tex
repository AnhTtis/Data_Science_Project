%%%%%%%%%%%%%%%%%%%% author.tex %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% sample root file for your "contribution" to a proceedings volume
%
% Use this file as a template for your own input.
%
%%%%%%%%%%%%%%%% Springer %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\documentclass{svproc}
%
% RECOMMENDED %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%

% to typeset URLs, URIs, and DOIs
\usepackage{url}
\usepackage{mathtools}
\usepackage{overpic}
\newcommand{\bb}{\mathbf b}
\newcommand{\bu}{\mathbf u}
\newcommand{\bk}{\mathbf k}
\newcommand{\bK}{\mathbf K}
\newcommand{\bm}[1]{\mbox{\boldmath{$#1$}}}
\newtheorem{rem}{Remark}%[section]
\def\cl {\nonumber \\}
\def\el {\nonumber }

\def\a{{\bm a}}
\def\b{{\bm b}}
\def\d{{\bm d}}
\def\f{{\bm f}}
\def\g{{\bm g}}
\def\n{{\bm n}}
\def\u{{\bm u}}
\def\v{{\bm v}}
\def\w{{\bm w}}
\def\x{{\bm x}}
\def\P{{\bm P}}
\def\U{{\bm U}}
\def\X{{\bm X}}
\def\0{\boldsymbol{0}}
\def\ss{\boldsymbol{\sigma}}
\def\SS{\boldsymbol{\Sigma}}
\def\ee{\boldsymbol{\eta}}
\def\mubar{\overline{\mu}}
\def\ubar{\overline{\u}}
\def\vbar{\overline{\v}}
\def\vtilde{\tilde{\v}}
\def\wbar{\overline{\w}}
\def\qbar{\overline{q}}
\def\dt{\partial_t}
\def\bbf{\mathbf{b}}
\def\ebf{\mathbf{e}}
\def\fbf{\mathbf{f}}
\def\qbf{\mathbf{q}}
\def\pbf{\mathbf{p}}
\def\vbf{\mathbf{v}}
\def\ubf{\mathbf{u}}
\def\xbf{\mathbf{x}}
\def\ybf{\mathbf{y}}
\def\vbarbf{\overline{\vbf}}
\def\qbarbf{\overline{\qbf}}
\def\xbarbf{\overline{\xbf}}
\def\bbarbf{\overline{\bbf}}

\def\uh{\u_h}
\def\vh{\v_h}
\def\fh{\f_h}
\def\bh{\b_h}
\def\ph{p_h}
\def\qh{q_h}
\def\vbarh{\vbar_h}
\def\qbarh{\qbar_h}
\def\mubarh{\mubar_h}




\def\Jcp{J. Comp. Phys}
\def\Cmame{Comput. Methods Appl. Mech. Engrg.}
\def\Jmpa{J. Math. Pures Appl.}
\def\Mmmas{Math. Model Meth. Appl. Sci.}
\def\Siamsc{SIAM J. Sci. Comp.}

\def\div{\nabla\cdot}
\def\grad{\nabla}
\def\grads{\grad^s}

%\topmargin      10mm 
%\evensidemargin 5mm \oddsidemargin  5mm
%\textwidth      150mm \textheight 200mm \frenchspacing \sloppy

%\def\baselinestretch{2} 

\newcommand{\anna}[2][cyan]{\textcolor{#1}{#2}}
\newcommand{\rev}[2][red]{{\textcolor{#1}{#2}}}


\def\UrlFont{\rmfamily}


\begin{document}
\include{commands.tex}

\mainmatter              % start of a contribution
%
\title{GEA: a new finite volume-based open source code for the numerical simulation of atmospheric and ocean flows}
%
\titlerunning{GEA}  % abbreviated title (for running head)
%                                     also used for the TOC unless
%                                     \toctitle is used
%
\author{Michele Girfoglio\inst{1}, Annalisa Quaini\inst{2} \and Gianluigi Rozza\inst{1}}
%
\authorrunning{Michele Girfoglio et al.} % abbreviated author list (for running head)
%
%%%% list of authors for the TOC (use if author list has to be modified)
\tocauthor{Michele Girfoglio, Annalisa Quaini and Gianluigi Rozza}
%
\institute{mathLab, Mathematics Area, SISSA, via Bonomea 265, I-34136 Trieste, Italy, \\
\email{michele.girfoglio@sissa.it}, \email{gianluigi.rozza@sissa.it}%\\ WWW home page:
%\texttt{http://users/\homedir iekeland/web/welcome.html}
\and
Department of Mathematics, University of Houston, Houston TX 77204, USA, \email{quaini@math.uh.edu}}

\maketitle              % typeset the title of the contribution

\begin{abstract}
We introduce GEA (Geophysical and Environmental Applications), a new open-source atmosphere and ocean modeling framework within the finite volume C++ library OpenFOAM\textsuperscript{\textregistered}. %GEA uses a
%common framework both for coarser-resolution global simulations and for high-resolution, limited-area large-eddy simulations
%(LES). 
Here, we present the development of a non-hydrostatic atmospheric model consisting of a pressure-based solver for the Euler equations written in conservative form using density, momentum, and total energy as variables. We validate the solver for two idealized test cases involving buoyancy driven flows: smooth and non-smooth rising thermal bubble. 
%against numerical data available in the literature for two classical benchmarks: the rising thermal
%bubble and the density current. 
Through qualitative and quantitative comparisons against numerical data available in the literature, we show that our approach is accurate. %.demonstrate the LES configuration of the atmosphere model in canonical benchmark cases and atmospheric
%5 flows, using an energy-conserving nodal discontinuous-Galerkin (DG) discretization of the governing equations. Resolution
%dependence, conservation characteristics and scaling metrics are examined in comparison with existing LES codes. They
%demonstrate the utility of ClimateMachine as a modelling tool for limited-area LES flow configurations.
%We develop a pressure-based solver for the Euler equations written in conservative form using density, momentum, and total energy as variables. Under simpli-
%fying assumptions, these equations are used to describe non-hydrostatic atmospheric flow. For
%the stabilization of the Euler equations and to capture sub-grid processes, we consider two Large
%Eddy Simulation models: the classical Smagorinsky model and the one equation eddy-viscosity
%model. To achieve high computational efficiency, our solver uses a splitting scheme that decouples
%the computation of each variable. The numerical results obtained with our solver are validated
%against numerical data available in the literature for two classical benchmarks: the rising thermal
%bubble and the density current. 
%Through qualitative and quantitative comparisons, we show that our approach is accurate. This work is meant to lay the foundation for a new open source package
%specifically created for quick assessment of new computational approaches for the simulation of
%atmospheric flows at the mesoscale level.
% We would like to encourage you to list your keywords within
% the abstract section using the \keywords{...} command.
\keywords{Compressible flow, Low Mach number, Stratified flow, Non-hydrostatic atmospheric
flows, Finite volume approximation, Large eddy simulation}
\end{abstract}
%
\section{Introduction}
Fast and accurate weather/climate forecasts need state-of-the-art numerical and computational methodologies. Open
source software packages for weather and climate simulations, i.e. the Climate Machine \cite{clima} and WRF \cite{WRF}, are very useful tools for realistic simulations, but testing and assessing new numerical approaches within them is non-trivial. %In fact, the very complexity that allows for realistic simulations requires a considerable amount of time to familiarize with, making such software impractical as testbed. 
This paper is a follow-up of our work presented in \cite{Girfoglio2023} and it is meant to further lay the foundation for a new open source package, called GEA (Geophysical and Environmental Applications) \cite{GEA}. GEA is specifically created for the assessment of new computational approaches for the simulation of mesoscale atmospheric flows and ocean flows \cite{GIRFOGLIO2023114656,GQR_ROM_QGE22,Girfoglio2023}. 
%REFERENCES:
%http://congress2.cimne.com/eccomas/proceedings/cfd2010/papers/01106.pdf
%That idea is that if a new approach fails to meet desired accuracy or efficiency standards in our simplified software, it would not be considered for implementation in more
%advanced software. 
To maximize the reach and the impact, as well as to facilitate sharing it with the scientific community, we choose to build our software package
on OpenFOAM\textsuperscript{\textregistered} \cite{Weller1998}, an open source, freely available C++ finite volume library that has become
widely used in Computational Fluid Dynamics (CFD).

As the core of our open source package, we present a solver for the Euler
equations for non-hydrostatic mesoscale atmospheric
modeling, and assess it through two well-known test cases involving a smooth and non-smooth rising thermal bubble. We consider the Euler equations written
in conservative form using density, momentum, and total energy as variables.

The rest of the paper is organized as follows. In Sec. 2, we briefly describe the formulation of
the Euler equations under consideration. Sec. 3 presents our pressure-based
approach and provides the details of space and time discretization. Numerical results for the two
benchmark tests are discussed in Sec. 4. Conclusions are drawn in Sec. 5.

\section{Problem definition}
\subsection{The compressible Euler equations}
\label{sec:NS Equations}

We consider the dynamics of the dry atmosphere (i.e., no moisture) in a spatial domain of interest $\Omega$ by neglecting the effects of solar radiation and heat flux from the ground.
We assume that dry air behaves like an ideal gas.
%Before stating the equations that govern dry air motion, we need
%to introduce some notation. We denote by $c_{\alpha}$ the specific heat capacities at constant $\alpha = p, v$ (pressure, volume). The 
%specific gas constants of dry air is denoted by $R$.


Let $\rho$ be the air density, $\bu$ = $(u, v, w)$  
the wind velocity, and $e$ the total energy density. Note that 
%\textcolor{red}{(qui avevamo fatto un errore, è $c_v T$ e non $c_p T$ perchè il primo addendo in $e$ è l'energia interna. L'entalpia invece può essere espressa come $c_p T$ come riporto nel Remark 2.1. Ho corretto comunque :))} 
$e = c_v T + |\bu|^2/2 + g z$, where $c_{v}$ the specific heat capacity at constant volume, $T$ is the absolute temperature, $g$ is the gravitational constant, and $z$ is the vertical coordinate.
The equations stating conservation of mass, momentum, and energy for the dry atmosphere written in terms of $\rho$, $\bu$, and $e$ over a time interval of interest $(0,t_f]$ read: 
\begin{align}
&\frac{\partial \rho}{\partial t} + \nabla \cdot (\rho \bu) = 0 &&\text{in } \Omega \times (0,t_f], \label{eq:mass}  \\
&\frac{\partial (\rho \bu)}{\partial t} +  \nabla \cdot (\rho \bu \otimes \bu) + \nabla p   + \rho g \widehat{\bk} = \boldsymbol{0} &&\text{in } \Omega \times (0,t_f],  \label{eq:mom} \\
&\frac{\partial (\rho e)}{\partial t} +  \nabla \cdot (\rho \bu e) + \nabla \cdot (p \bu) = 0 &&\text{in } \Omega \times (0,t_f],
\label{eq:ent}
\end{align}
%\sm{[SM] The gravity term in the energy equation must be removed.}\\
%\sm{[SM] I thought Michele changed the code to solve the theta equation, not the total energy equation. As I mentioned before, we will have major problems in including moisture if we use this equation. That's why nobody uses total energy. Not even ClimaMachine does anymore.}
where $\widehat{\bk}$ is the unit vector aligned with the vertical axis $z$ and $p$ is pressure. To close system \eqref{eq:mass}-\eqref{eq:ent}, we need a 
thermodynamics equation of state for $p$. Following the assumption that dry air behaves like an ideal gas, we have: %\textcolor{red}{(in realtà l'ipotesi di gas ideale la facciamo fin da quando assumiamo che l'energia interna possa scriversi come $C_v T$, vogliamo spostare questo commento prima?)}:
\begin{align}
p = \rho R T, %p_0 \left( \frac{\rho R \theta}{p_0} \right)^\frac{c_p}{c_v}. 
\label{eq:p}
\end{align}
where $R$ is the specific gas constant of dry air.

Let us write the pressure as the sum of a fluctuation $p'$ with respect to a background state
\begin{align}
p = p' + \rho g z. \label{eq:p_split}
\end{align}
%\anna{Dove scriviamo come cambiare lo splitting di $p$, qui o in Sec.~\ref{sec:HB}?
%Se non vogliamo che un reviewer di problemi atmosferici si arrabbi subito, possiamo dire che presentiamo l'approccio per \eqref{eq:p_split} anche se su terreni non pianeggianti e' problematico e poi in Sec.~\ref{sec:HB} proponiamo come cambiarla se ci sono montagne.} \textcolor{red}{mmm bella domanda. Forse meglio presentarla direttamente in Sec. 4.3? Se gli diciamo fin da qui che sulla montagna cambiamo, usando l'approccio piu' famoso e riconosciuto, non vorrei che si incattivisse chiedendoci: ma perchè non lo avete fatto subito? Non so, ci pensiamo un altro po'}
By plugging \eqref{eq:p_split} into \eqref{eq:mom}, we obtain:
\begin{align}
\frac{\partial (\rho \bu)}{\partial t} +  \nabla \cdot (\rho \bu \otimes \bu) + \nabla p' + gz \nabla \rho = \boldsymbol{0} \quad \text{in } \Omega \times (0,t_f].  \label{eq:mom_split}
\end{align}
%while by plugging \eqref{eq:p_split} into \eqref{eq:p}, we get
%\begin{align}
%p' = \rho (R T - g z).  \label{eq:state_split}
%\end{align}

%The pressure gradient and gravity force terms are rearranged in the following form:
%\begin{align}
%\nabla p + \rho g \widehat{\bk}  = \nabla p' + gz %\nabla \rho, %p_0 \left( \frac{\rho R \theta}{p_0} %\right)^\frac{c_p}{c_v}.
%\label{eq:pPrime}
%\end{align}
%where $p' = p - \rho g z$.
%\textcolor{red}{Possiamo riscrivere il sistema con la posizione (5)}


%\textcolor{red}{forse questo remark è da commentare perchè non ci consente di definire bene lo splitting che applichiamo. Qui potremmo ad esempio scrivere l'equazione in termini di entalpia}

%Let $h = c_p T + |\bu|^2/2$. Notice that, using eq.~\eqref{eq:mass}, eq.~\eqref{eq:ent} can be rewritten as:
%\begin{align}
%\frac{\partial (\rho h)}{\partial t} +  \nabla \cdot (\rho h \bu) + \rho g \bu \cdot \widehat{\bk} + \nabla \cdot (p \bu) = 0.
%\label{eq:over_ent}
%\end{align}

Let $c_{p}$ be the specific heat capacity at constant pressure for dry air and let
\begin{equation}\label{eq:K_h}
K = |\bu|^2/2, \quad h = c_v T + p/\rho = c_p T,    
\end{equation}
be the kinetic energy density and the specific enthalpy, respectively. The total energy density can be written as $e = h - p/\rho + K + gz$. Then, eq.~\eqref{eq:ent} can be rewritten as:
\begin{align}
\frac{\partial (\rho h)}{\partial t} +  \nabla \cdot (\rho \bu h) + 
\frac{\partial (\rho K)}{\partial t} +  \nabla \cdot (\rho \bu K) - \dfrac{\partial p}{\partial t}  +  
\rho g \bu \cdot \widehat{\bk} = 0,
\label{eq:over_ent}
\end{align}
where we have used eq.~\eqref{eq:mass} for further simplification.  

\begin{rem}
To preserve the numerical stability, we add an artificial diffusion term to eq.~\eqref{eq:mom_split} and \eqref{eq:over_ent}:
\begin{align}
&\frac{\partial (\rho \bu)}{\partial t} +  \nabla \cdot (\rho \bu \otimes \bu) + \nabla p' + gz \nabla \rho -  \mu \Delta \bu = \boldsymbol{0} \label{eq:mom_LES}  \\
&\frac{\partial (\rho h)}{\partial t} +  \nabla \cdot (\rho \bu h) + 
\frac{\partial (\rho K)}{\partial t} +  \nabla \cdot (\rho \bu K) - \dfrac{\partial p}{\partial t}  +  
\rho g \bu \cdot \widehat{\bk}  -  \frac{\mu_a}{Pr} \Delta h = 0,
%&\frac{\partial (\rho h)}{\partial t} +  \nabla \cdot (\rho h \bu) + \nabla \cdot (p \bu) + \rho g \bu \cdot \widehat{\bk}  - \nabla \cdot \left(\frac{\mu_a c_p}{Pr} \nabla T \right) = 0 &&\text{in } \Omega \times (0,t_f],
\label{eq:ent_LES}
\end{align}
where $\mu$ is a constant diffusivity coefficient and $Pr$ is the Prandtl number.
\end{rem}\label{rem:1}

\begin{rem}
A quantity of interest for atmospheric problems is the potential temperature $\theta$ defined as
\begin{align}
\theta = \frac{T}{\pi}, \quad \pi = \left( \frac{p}{p_0} \right)^{\frac{R}{c_{p}}}, \label{eq:theta}
\end{align}
where $p_0 = 10^5$ Pa is the atmospheric pressure at the ground. Additionally, 
we define the potential temperature fluctuation $\theta'$:
\begin{align}
\theta'(x,y,z,t) = 
\theta(x,y,z,t) - \theta_0(z), \label{eq:theta_split} 
\end{align}
where $\theta_0$ is the mean hydrostatic value, which is a  function
of the vertical coordinate $z$ only. %See, e.g., \cite{kellyGiraldo2012} for more details. 
\end{rem}

 We will devise a splitting approach for problem \eqref{eq:p}-\eqref{eq:p_split},\eqref{eq:K_h},\eqref{eq:mom_LES}-\eqref{eq:ent_LES}, because this formulation of the Euler equation facilitates the decoupling of all variables and it allows for an explicit treatment of the kinetic and potential energies.

\section{Time and space discretization}
This section briefly presents a space and time discretization for the model
\eqref{eq:mass},\eqref{eq:p}-\eqref{eq:p_split},\eqref{eq:K_h},\eqref{eq:mom_LES}-\eqref{eq:ent_LES}.
For the space discretization,
we adopt a finite volume method. This requires to partition the computational domain $\Omega$ into cells or control volumes $\Omega_i$, with $i = 1, \dots, N_{c}$, where $N_{c}$ is the total number of cells in the mesh. Let  \textbf{A}$_j$ be the surface vector of each face of the control volume, 
with $j = 1, \dots, M$. With the subindex $i$ we will denote a variable average in control volume $\Omega_i$.
Let $\Delta t \in R$, 
$t^n = n \Delta t$, with $n = 0, ..., N_f$ and $t_f = N_f \Delta t$. Moreover, we denote by $y^n$ the approximation of a generic quantity $y$ at the time $t^n$. For time discretization, we adopt a Backward Differentiation Formula of order 1 (BDF1). A monolithic approach for coupled problem \eqref{eq:p}-\eqref{eq:p_split},\eqref{eq:K_h},\eqref{eq:mom_LES}-\eqref{eq:ent_LES} would lead to high computational costs. 
Thus, to save computational time we adopt a splitting approach consisting of three steps detailed below.

Problem \eqref{eq:p}-\eqref{eq:p_split},\eqref{eq:K_h},\eqref{eq:mom_LES}-\eqref{eq:ent_LES}
discretized in time and space reads: given $\rho^0$, $\bu^0$, $h^0$,  $p^0$, and $T^0$, set $K^0 = |\bu^0|^2/2$ and for $n \geq 0$ find solution $(\rho^{n+1}_i, \bu^{n+1}_i,h^{n+1}_i,K^{n+1}_i, \\p^{n+1}_i, p'^{,n+1}_i, T^{n+1}_i)$ of system: %\textcolor{red}{forse cam

\begin{itemize}
\item[-] \emph{Step 1}: find first intermediate density ${\rho}_i^{n+\frac{1}{3}}$, intermediate velocity ${\bu}_i^{n+\frac{1}{3}}$ and associated kinetic energy density $K_i^{n+\frac{1}{3}}$ such that
\begin{align}
&\frac{1}{\Delta t} {\rho}^{n+\frac{1}{3}}_i + \sum_j  \varphi^n_j = b_{\rho,i}^{n+1}, \quad \varphi^n_j =(\rho^n\bu^{n})_{i,j}  \cdot  \textbf{A}_j,\label{eq:e1_d} \\
& \frac{1}{\Delta t} {\rho}^{n+\frac{1}{3}}_i \bu^{n+\frac{1}{3}}_i +\sum_j^{} \varphi^n_j \bu^{n+\frac{1}{3}}_{i,j} + \nabla p^{n}_{i} - \sum_j^{} \mu \nabla (\bu^{n+\frac{1}{3}}_i)_j \cdot \textbf{A}_j = {\bm b}^{n+1}_{\bu, i}, \label{eq:step2_sd} \\
& K^{n+\frac{1}{3}}_i = \frac{|\bu_i^{n+\frac{1}{3}}|^2}{2}, \label{eq:step1_3sd}
\end{align}
where $ \varphi^n_j$ denotes 
the convective
flux through face $j$ of $\Omega_i$, $b^{n+1}_{\rho,i} = \rho^n_i/\Delta t$ and $\bb^{n+1}_{\bu,i} = \rho^{n}_i\bu^n_i/\Delta t$.
\item[-] \emph{Step 2}: find average specific enthalpy $h^{n+1}_i$, temperature $T^{n+1}_i$, and second intermediate density ${\rho}^{n+\frac{2}{3}}_i$ in control volume $\Omega_i$ such that
\begin{align}
&\frac{1}{\Delta t} {\rho}^{n+\frac{1}{3}}_i h^{n+1}_i + \sum_j^{} \varphi^n_j h^{n+1}_{i,j} - \sum_j^{} \frac{\mu}{Pr} (\nabla h^{n+1}_i)_j \cdot \textbf{A}_j  = \tilde{b}_{e,i}^{n} \cl
&\quad - 
\frac{1}{\Delta t} {\rho}^{n+\frac{1}{3}}_i K^{n+\frac{1}{3}}_i - \sum_j^{} \varphi^n_j K^{n+\frac{1}{3}}_{i,j} + \frac{1}{\Delta t} p_i^n - {\rho}^{n+\frac{1}{3}}_i g \bu^{n+\frac{1}{3}}_i \cdot \widehat{\bk}, \label{eq:step3_sd}\\
& h^{n+1}_i - c_p T^{n+1}_i =  h^{n}_i - c_p T^{n}_i,
%h^{n+1}_i = c_v T^{n+1}_i + \frac{p_i^n}{\tilde{\rho}_i^{n+1}},  %\frac{1}{2} |\tilde{\bu}^{n+1}_i|^2.
\label{eq:step3_2sd} \\
&{\rho}^{n+\frac{2}{3}}_i R T^{n+1}_i = p^{n}_i, \label{eq:step3_3sd}
\end{align}
where $\tilde{b}_e^{n} = (\rho^n h^n + \rho^n K^{n-1} - p^{n-1}) / \Delta t$. 

\item[-] \emph{Step 3}: find end-of-step velocity $\bu^{n+1}$ and associated kinetic energy density $K^{n+1}$, pressure $p^{n+1}$ and pressure fluctuation $p'^{,n+1}$, and end-of-step density $\rho^{n+1}$ 
such that 
\begin{align}
&\frac{1}{\Delta t} {\rho}^{n+\frac{1}{3}}_i \bu^{n+1}_i +\sum_j^{} \varphi^n_j \bu^{n+1}_{i,j} + \nabla p'^{,n+1}_{i}  + g z_i \grad{{\rho}_i^{n+\frac{2}{3}}} \cl
&\quad - 
\sum_j^{} \mu (\nabla \bu^{n+1}_i)_j \cdot \textbf{A}_j = {\bm b}^{n+1}_{\bu, i}, \label{eq:step2_sd}
\end{align}
\begin{align}
& \sum_j {\rho}_j^{n+\frac{2}{3}}(\nabla p'^{,n+1}_i)_j \cdot \textbf{A}_j =  \sum_j  \frac{ {\rho}_j^{n+\frac{2}{3}} \Delta t}{{\rho}_j^{n+\frac{1}{3}}} \left(\mathbf{H}(\bu_i^{n+1})_j  - gz_j (\nabla {\rho}_i^{n+\frac{2}{3}})_j \right) \cdot \textbf{A}_j \cl 
& \quad - 
b_{\rho, i}^{n+1} + \dfrac{1}{\Delta t} {\rho}_i^{n+\frac{2}{3}} %\frac{9}{4\Delta t^2} {\rho}^{n+\frac{1}{3}}_i + \frac{3}{2\Delta t} b^{n+1}_{\rho,i}
, \label{eq:p_prime_sd} \\
& p^{n+1}_i = p'^{,n+1}_i + {\rho}^{n+\frac{2}{3}}_i g z_i, \quad
K^{n+1}_i = \frac{|\bu_i^{n+1}|^2}{2}, \quad 
\rho^{n+1}_i = 
\frac{p_i^{n+1}}{R T^{n+1}_i},\label{eq:step4_4sd}
\end{align}
where $\mathbf{H}(\bu_i^{n+1}) = - \sum_j^{} \varphi^n_j \bu^{n+1}_{i,j}
+ \sum_j^{} \mu (\nabla \bu^{n+1}_i)_j \cdot \textbf{A}_j + {\bm b}^{n+1}_{\bu, i}$.
\end{itemize}

In order to decouple the computation of the pressure from the computation of the velocity, we use the PISO algorithm \cite{Weller1998}. We choose a second-order accurate scheme for the Laplacian and gradient terms and a fourth-order accurate scheme for the divergence term.
For
more details, we refer the reader to \cite{Girfoglio2023}.
\section{Numerical results}
We validate our solver with respect to two classic benchmarks, the smooth and non-smooth rising thermal bubble. Both test cases involve a perturbation of a neutrally stratified atmosphere with
uniform background potential temperature over a flat terrain. In both tests,
the computational domain in the $xz$-plane is $\Omega=[0, 1000]^2$ m$^2$ and the time interval of interest is $(0, 600]$ s. Impenetrable, free-slip boundary conditions are imposed on all walls.
%In Sec. \ref{sec:nonsmooth} we present our results for the rising thermal bubble benchmark. %There exist several variations of this benchmark, featuring different geometries and/or initial conditions. We use the
%settings from [10]. See also [15] for a recent work using this variation. Our results for the classical
%density current test [14, 34] are shown in Sec. 4.3. 

Since these benchmarks do not have an exact solution, one can only have a
comparison with other numerical data available in the literature. 

%The reader is referred to [] for te validation against other benchmarks.

%The computational domain is the square
%[0, 1000]$^2$ with no flux boundary conditions. The initial condition is represented by a neutrally stratified
%atmosphere with surface temperature 300 K where a circular bubble with a uniform potential temperature
%0.5 K in excess of the basic–state atmosphere is introduced SCRIVERE LA FORMULA. The original test described in [Rob92] does not
%include diffusion. However, when a high–order method is adopted, due to the discontinuity in the initial condition,
%it is impossible to compute an approximate solution unless a minimum amount of viscosity is introduced CITARE RESTELLI.

\subsection{Smooth rising thermal bubble}
%The first test case is similar to the smooth bubble test proposed in [12, 40].

The initial density is given by \begin{align}
\rho^0 = \frac{p_g}{R \theta_0} \left(\frac{p}{p_g}\right)^{c_{v}/c_p}, \quad p = p_g \left( 1 - \frac{g z}{c_p \theta^0} \right)^{c_p/R}, \label{eq:rho_wb}
\end{align}
%Impenetrable, free-slip boundary conditions are imposed on all the walls. 
%The initial density is given by \eqref{eq:rho_wb} with 
with %$p_g = 10^5$ Pa, 
$c_p = R + c_v$, $c_v = 715.5$ J/(Kg K), $R = 287$ J/(Kg K).
In \eqref{eq:rho_wb}, $\theta^0$ is the initial potential temperature, which is defined as:
\begin{equation}
\theta^0 = 300  + \frac{0.5}{2}\left[  1 + \cos\left(\frac{\pi r}{r_c}\right)\right] ~ \textrm{if $r\leq r_c$},\quad\theta^0 = 300
~ \textrm{otherwise},
\label{dcEqn1}
\end{equation}
where $r = \sqrt[]{\left(x-x_{c}\right)^{2} + \left(z-z_{c}\right)^{2}}$, with $r_c = 250~\mathrm{m}$ and $(x_c,z_c) = (500, 350)~\mathrm{m}$.
%The initial potential temperature fluctuation \eqref{eq:theta_split} on part of the domain $\Omega$ is shown in Fig.~\ref{fig:IC_DC}.
%Notice that in this case the initial bubble is cold, while the bubble in \eqref{warmEqn1} is warm. 
The initial velocity field is zero everywhere and the initial specific enthalpy is given by \begin{align}
h^{0} = c_p \theta^0 \left( \frac{p}{p_g} \right)^{\frac{R}{c_{p}}}.
\label{eq:e0}
\end{align}
%The basic state atmosphere is characterized by neutral stratification, and the flow is
%driven by a smooth thermal anomaly of which the maximum amplitude is +0.5 K.
%Reflecting boundary conditions are applied and the flow is inviscid. The compu-
%tational domain is [0 m , 1000 m] × [0 m , 1000 m] and a grid composed of 20 × 20,
%16 M. RESTELLI AND F. X. GIRALDO
%10th-order elements is adopted, with equivalent resolution 5 m. The time step is
%0.08 s, %yielding Cmax = 19 and Cmax
%adv = 0.12. 
Following \cite{Restelli1}, we use a mesh with uniform resolution $h = \Delta x = \Delta z = 5$ m. The time step is set to $\Delta t = 0.1$ s. %The original test described in CITE does not include diffusion. However, %when a high–order method is adopted, due to the discontinuity in the initial condition,
Furthermore, we set $\mu = 0.15$ and $Pr = 1$.
%it is impossible to compute an approximate solution unless a minimum amount of viscosity is introduced  

Figure \ref{fig:RTB3} (left) shows the potential temperature perturbation computed at $t = 600$ s. This plot is in very good agreement with the corresponding figure in \cite{Restelli1}. Figure \ref{fig:RTB3} (right) depicts the profile of the potential temperature perturbation along $z = 700$ m together with the data from \cite{Restelli1}. We observe that the two curves are very close, except for the oscillations at $t \approx 200$ s and $t \approx 800s$ that in our solution are completely damped and the slightly lower maxima. %our The “converged” wmax overlaps with the reference value till about t = 500 s and it
%remains close to it till about t = 800 

For further comparison, in Table \ref{tab:1} we report the extrema for
the horizontal velocity $u$ and vertical velocity $w$, together with the values obtained in \cite{Restelli1}.
The results from \cite{Restelli1} are obtained by using density-based approach developed from a Godunov-type scheme. Moreover, the authors of \cite{Restelli1} use a Discontinuous Galerkin method for the space discretization. 
Other differences with our methodology include the orders of space and time discretizations and the different treatment of the hydrostatic term. Given all these differences, we believe that our results are in line with the reference ones.

%Minimum and maximum values for the com-
%puted solution are (−1.125 · 10−5 , 5.016 · 10−6) for π, (−2.161 m/s , 2.161 m/s) for
%u, (−1.967 m/s , 2.758 m/s) for w and (−7.303 · 10−2 K , 5.259 · 10−1 K) for θ. All
%these results are in good agreement with those reported in [29] for the explicit case.
%Concerning conservation, for this problem we expect mass and total energy to re-
%main constant. This is verified up to machine precision in the numerical simulation,
%where we observe for these quantities relative deviations equal to 8.755 · 10−11 and
%4.627 · 10−11, respectiv


\begin{figure}[htb]
\centering
 \begin{overpic}[width=0.525\textwidth]{Bubble1.png}  
%\put(22,90){\textcolor{white}{$h = 15.625$ m}}
     \end{overpic}~ \hspace{0.05cm}
       \begin{overpic}[width=0.51\textwidth]{theta_700m.png}  
%\put(23,90){\textcolor{white}{$h = 32.25$ m}}
      \end{overpic}
\caption{Smooth rising thermal bubble: perturbation of potential
temperature computed at $t = 600$ s (left) and its profile at $z = 700$ m compared with data from \cite{Restelli1} denoted as ``Reference'' (right).}
\label{fig:RTB3}
\end{figure}

\begin{table}[htb]
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|} \hline
Model & Res. [m] & $u_{min}$ (m/s) & $u_{max}$ (m/s) & $w_{min}$ (m/s) & $w_{max}$ (m/s) \\
 \hline
GEA & 5 & -1.898 & 1.898 & 1.682 & 2.495\\
Ref. \cite{Restelli1} & 5 & -2.161 & 2.161 & 1.967 & 2.758 \\
 \hline  
\end{tabular}
\caption{Smooth rising thermal bubble: minimum and maximum horizontal velocity $u$ and vertical velocity $w$ at $t = 600$ s compared
against results reported in \cite{Restelli1}.
}
\label{tab:1}
\end{center}
\end{table}

\subsection{Non-smooth rising thermal bubble} \label{sec:nonsmooth}
The second test case is analogous to the first one, except for a uniform thermal anomaly of $0.5$ K:
\begin{equation}
\theta^0 = 300.5  ~ \textrm{if $r\leq r_c$},\quad\theta^0 = 300
~ \textrm{otherwise},
\label{dcEqn2}
\end{equation}
and $(x_c,z_c) = (500, 260)~\mathrm{m}$.
The time step is set to $\Delta t = 0.1$. Furthermore, we set $\mu = 0.3$ and $Pr = 1$. %ith a uniform potential temperature
%0.5 K in excess of the basic–state atmosphere is introduce

%and the computational domain is larger. A very similar
%test case was also proposed in [40

%We consider in this section the first test case presented in [Rob92]. 
Figure \ref{fig:RTB4} shows the spatial distribution of the potential temperature perturbation
at $t = 420$ s and $t = 600$ s by using a mesh with uniform resolution $h = \Delta x = \Delta z = 5$ m. Qualitatively, these results are in very good agreement
with those reported in \cite{Restelli2}. For a more quantitative analysis, in Table \ref{tab:3} we report the extrema for $\theta'$ at $t = 420, 600$ s together with the values from \cite{Restelli2}. %for two meshes with uniform resolution 5 m e 10 m. 
We observe that the comparison is satisfactory considering that the method we use is very different from the approach in \cite{Restelli2}.

\begin{figure}[htb]
\centering
 \begin{overpic}[width=0.52\textwidth]{420s.png}  
%\put(22,90){\textcolor{white}{$h = 15.625$ m}}
      \end{overpic}~ \hspace{0.1cm}
       \begin{overpic}[width=0.52\textwidth]{600s.png}  
%\put(23,90){\textcolor{white}{$h = 32.25$ m}}
      \end{overpic}
\caption{Non-smooth rising thermal bubble: perturbation of potential temperature computed at $t = 420$ s (left) and $t = 600$ s (right).}
\label{fig:RTB4}
\end{figure}




\begin{table}[htb]
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|} \hline
Model & Res. [m] & $\theta'_{min}$ (K) at $420$ s & $\theta'_{min}$ (K) at $600$ s & $\theta'_{max}$ (K) at $420$ s & $\theta'_{max}$ (K) at $600$ s \\
 \hline
GEA & 5 & -0.018 & -0.023 & 0.521 & 0.522\\
Ref. \cite{Restelli2}  & 5 & -0.020 & -0.016 & 0.522 & 0.527\\
GEA & 10 & -0.047 & -0.062 & 0.577 & 0.563\\
Ref. \cite{Restelli2} & 10 & -0.057 & -0.053 & 0.550 & 0.561\\
 \hline  
\end{tabular}
\caption{Non-smooth rising thermal bubble: minimum and maximum potential temperature perturbation $\theta'$ at $t = 420$ s and $t = 600$ s compared against results reported in \cite{Restelli2}.
}\label{tab:3}
\end{center}
\end{table}

\section{Concluding remarks}
This paper discusses and further assessed GEA (Geophysical and Evinromental Applications), a new C++ language simulation framework
designed for the numerical simulation of atmospheric and ocean flows. We developed a pressure-based solver for the Euler equations written in conservative form using density, momentum, and total
energy as variables. 
We validated the solver against numerical data available in the literature for two well-known
benchmarks: the smooth and non-smooth thermal bubble. For both tests, we obtain good qualitative and quantitative comparisons. %when the classical
%Smagorinsky model and/or the one equation eddy-viscosity model are adopted for stabilization.
The code created for this paper is available on GitHub \cite{GEA}.

%
% ---- Bibliography ----
%
\begin{thebibliography}{6}
%

\bibitem {clima}
Climate Modeling Alliance.
\url{https://github.com/CliMA}

\bibitem {WRF}
Weather Research and Forecasting. 
\url{https://www.mmm.ucar.edu/models/wrf}

\bibitem {GEA}
GEA - Geophysical and Environmental Applications.
\url{https://github.com/GEA-Geophysical-and-Environmental-Apps/GEA}

\bibitem {GIRFOGLIO2023114656}
Girfoglio, M., Quaini, A., Rozza, G.: A novel Large Eddy Simulation model for the Quasi-Geostrophic equations in a Finite Volume setting, Journal of Computational and Applied Mathematics, vol. 418, pp. 114656, 2023.

\bibitem {GQR_ROM_QGE22}
Girfoglio, M., Quaini, A., Rozza, G.: A linear filter regularization for POD-based reduced order models of the quasi-geostrophic equations, accepted on Comptes Rendus Mècanique, \url{https://arxiv.org/abs/2211.16851}, 2023.


\bibitem {Girfoglio2023}
Girfoglio, M., Quaini, A., Rozza, G.: Validation of an OpenFOAM-based solver for the Euler equations with benchmarks for mesoscale atmospheric modeling, submitted, \url{https://arxiv.org/abs/2302.04836}.

\bibitem {Weller1998}
Weller, H. G., Tabor, G., Jasak, H., Fureby, C.: A tensorial approach to computational continuum mechanics using object-oriented techniques, Computers in Physics, vol. 12, pp. 620-631, 1998.

\bibitem {Restelli1}
Restelli, M., Giraldo, F. X.: A Conservative Discontinuous Galerkin Semi-Implicit Formulation for the Navier–Stokes Equations in Nonhydrostatic Mesoscale Modeling, SIAM Journal on Scientific Computing, vol. 31, 2009.

\bibitem {Restelli2}
Restelli, M.: Semi-Lagrangian and Semi-Implicit Discontinuous Galerkin Methods for Atmospheric Modeling Applications, PhD Thesis, Politecnico di Milano, 2007.

%volume = {418},
%pages = {114656},
%year = {2023},
%issn = {0377-0427},
%doi = {https://doi.org/10.1016/j.cam.2022.114656},
%url = %{https://www.sciencedirect.com/science/article/pii/S0377042722003326},
%author = {Michele Girfoglio and Annalisa Quaini and Gianluigi Rozza}
%}




\end{thebibliography}
\end{document}
