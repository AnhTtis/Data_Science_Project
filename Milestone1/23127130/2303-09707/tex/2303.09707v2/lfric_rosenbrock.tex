\documentclass[
	a4paper, % Paper size, use either a4paper or letterpaper
	10pt, % Default font size, can also use 11pt or 12pt, although this is not recommended
	unnumberedsections, % Comment to enable section numbering
	twoside, % Two side traditional mode where headers and footers change between odd and even pages, comment this option to make them fixed
	twocolumn,
]{article}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% LaTeX Templates Journal Article
% LaTeX Class
% Version 2.0 (February 7, 2023)
%
% This class originates from:
% https://www.LaTeXTemplates.com
%
% Author:
% Vel (vel@latextemplates.com)
%
% License:
% CC BY-NC-SA 4.0 (https://creativecommons.org/licenses/by-nc-sa/4.0/)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	CLASS CONFIGURATION
%----------------------------------------------------------------------------------------

\NeedsTeXFormat{LaTeX2e}
%\ProvidesClass{LTJournalArticle}[2023/02/07 LaTeX Templates Journal Article Class v2.0]

\usepackage{etoolbox} % Required for conditional logic and easily changing commands

\newtoggle{unnumberedsections} % Create toggle for a class option
\settoggle{unnumberedsections}{false} % Default value for the class option
\DeclareOption{unnumberedsections}{\settoggle{unnumberedsections}{true}} % Set the class option toggle if the class option was used in the template

\DeclareOption*{\PassOptionsToClass{\CurrentOption}{article}} % Pass through any extra options specified to the base class
\ProcessOptions\relax % Process class options

%\LoadClass[twocolumn]{article} % Load the base class

%----------------------------------------------------------------------------------------
%	REQUIRED PACKAGES AND MISC CONFIGURATIONS
%----------------------------------------------------------------------------------------

\usepackage{graphicx} % Required for including images
\graphicspath{{Figures/}{./}} % Specifies where to look for included images (trailing slash required)

\usepackage[bottom, hang]{footmisc} % Force footnotes to the bottom of the page and to the left margin
\setlength{\footnotemargin}{6pt} % Horizontal space between the footnote marker and text

%----------------------------------------------------------------------------------------
%	MARGINS
%----------------------------------------------------------------------------------------

\usepackage[
	top=2.5cm, % Top margin
	bottom=2.5cm, % Bottom margin
	left=2cm, % Left margin
	right=2cm, % Right margin
	footskip=1cm, % Space from the bottom margin to the baseline of the footer
	headsep=0.75cm, % Space from the top margin to the baseline of the header
	columnsep=20pt, % Space between text columns (in twocolumn mode)
	%showframe % Uncomment to show frames around the margins for debugging purposes
]{geometry}

%----------------------------------------------------------------------------------------
%	FONTS
%----------------------------------------------------------------------------------------

\usepackage[utf8]{inputenc} % Required for inputting international characters
\usepackage[T1]{fontenc} % Output font encoding for international characters

\usepackage[sc]{mathpazo} % Use the Palatino font

\linespread{1.05} % Increase line spacing slightly

\usepackage{microtype} % Slightly tweak font spacing for aesthetics

%----------------------------------------------------------------------------------------
%	HEADERS AND FOOTERS
%----------------------------------------------------------------------------------------

\usepackage{fancyhdr} % Required for customizing headers and footers
\pagestyle{fancy} % Enable custom headers and footers

\renewcommand{\headrulewidth}{0pt} % Top horizontal rule thickness

\fancyhf{} % Clear default headers/footers

\fancyhead[RO]{\small\textit{\runninghead}} % Right-odd page header
\fancyhead[LE]{\small\textit{\runninghead}} % Left-even page header

\fancyfoot[RO]{\small\textbf{\thepage}} % Right-odd page footer
\fancyfoot[LO]{\footnotesize\footertext} % Left-odd page footer
\fancyfoot[LE]{\small\textbf{\thepage}} % Left-even page footer
\fancyfoot[RE]{\footnotesize\footertext} % Left-even page footer

%----------------------------------------------------------------------------------------
%	SECTIONS
%----------------------------------------------------------------------------------------

\usepackage{titlesec} % Required for modifying sections

\iftoggle{unnumberedsections}{ % Conditional logic for the unnumbered sections class options
	\setcounter{secnumdepth}{0} % Don't number sections at any level
}{
	\setcounter{secnumdepth}{2} % Number sections down to subsections
}

\titleformat
	{\section} % Section type being modified
	[block] % Section layout type, can be: hang, block, display, runin, leftmargin, rightmargin, drop, wrap, frame
	{\Large\bfseries\centering} % Text formatting of the whole section, i.e. label and title
	{\thesection} % Section label (e.g. number) and its formatting
	{0.5em} % Horizontal space between the section label and title
	{} % Code before the section title
	[] % Code after the section title

%------------------------------------------------

\titleformat
	{\subsection} % Section type being modified
	[block] % Section layout type, can be: hang, block, display, runin, leftmargin, rightmargin, drop, wrap, frame
	{\raggedright\large\bfseries} % Text formatting of the whole section, i.e. label and title
	{\thesubsection} % Section label (e.g. number) and its formatting
	{0.5em} % Horizontal space between the section label and title
	{} % Code before the section title
	[] % Code after the section title

%------------------------------------------------

\titleformat
	{\subsubsection} % Section type being modified
	[runin] % Section layout type, can be: hang, block, display, runin, leftmargin, rightmargin, drop, wrap, frame
	{\bfseries} % Text formatting of the whole section, i.e. label and title
	{} % Section label (e.g. number) and its formatting
	{5pt} % Horizontal space between the section label and title
	{} % Code before the section title
	[] % Code after the section title

\titlespacing*{\subsubsection}{0pt}{0.5\baselineskip}{8pt} % Spacing around section titles, the order is: left, before and after

%----------------------------------------------------------------------------------------
%	TITLE SECTION CUSTOMIZATION
%----------------------------------------------------------------------------------------

\usepackage{titling} % Required for customizing the title section

\setlength{\droptitle}{-4\baselineskip} % Move the title up

\pretitle{\begin{center}\huge\bfseries} % Article title pre-formatting
\posttitle{\end{center}} % Article title post-formatting

\setlength{\thanksmarkwidth}{3pt} % Left margin for the first \thanks line
\setlength{\thanksmargin}{-3pt} % Left margin for the second and onwards \thanks line

\patchcmd{\maketitle}{plain}{empty}{}{} % Set the headers and footers style for the first page to empty

%----------------------------------------------------------------------------------------
%	ABSTRACT CUSTOMIZATION
%----------------------------------------------------------------------------------------

\usepackage{abstract} % Allows abstract customization

\renewcommand{\abstractnamefont}{\normalfont\bfseries\vspace{0.5\baselineskip}} % Set the "Abstract" text to bold
\renewcommand{\abstracttextfont}{\vspace{-0.5\baselineskip}\normalfont\small\itshape} % Set the abstract itself to small italic text

%----------------------------------------------------------------------------------------
%	BIBLIOGRAPHY
%----------------------------------------------------------------------------------------

\usepackage[
	backend=biber, % Use the biber backend for compiling the bibliography
	citestyle=numeric, % In-text citation style
	bibstyle=numeric, % Bibliography style
	sorting=none, % Order references in the order in which they are used in the document
]{biblatex}

%----------------------------------------------------------------------------------------
%	TABLES
%----------------------------------------------------------------------------------------

\usepackage{booktabs} % Required for better horizontal rules in tables

\usepackage{array} % Required for manipulating table columns

\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}} % Define a new right-aligned paragraph column type
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}} % Define a new left-aligned (no justification) paragraph column type
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}} % Define a new centered paragraph column type

%----------------------------------------------------------------------------------------
%	CAPTIONS
%----------------------------------------------------------------------------------------

\usepackage{caption} % Required for customizing captions

\captionsetup{skip=6pt} % Vertical whitespace between figures/tables and the caption (default is 10pt)
\captionsetup{labelfont={bf,small}, textfont={it,small}} % Define caption font style

%----------------------------------------------------------------------------------------
%	LISTS
%----------------------------------------------------------------------------------------

\usepackage{enumitem} % Required for list customization

\setlist{noitemsep} % Customize spacing around and inside lists

%----------------------------------------------------------------------------------------
%	LINKS
%----------------------------------------------------------------------------------------

\usepackage{hyperref} % Required for links

\hypersetup{
	colorlinks=true, % Whether to color the text of links
	urlcolor=black, % Color for \url and \href links
	linkcolor=black, % Color for \nameref links
	citecolor=black, % Color of reference citations
}

%----------------------------------------------------------------------------------------
%	CUSTOM COMMANDS
%----------------------------------------------------------------------------------------

\newcommand{\runninghead}[1]{\renewcommand{\runninghead}{#1}}

\newcommand{\footertext}[1]{\renewcommand{\footertext}{#1}}


%\documentclass[
%	a4paper, % Paper size, use either a4paper or letterpaper
%	10pt, % Default font size, can also use 11pt or 12pt, although this is not recommended
%	unnumberedsections, % Comment to enable section numbering
%	twoside, % Two side traditional mode where headers and footers change between odd and even pages, comment this option to make them fixed
%]{LTJournalArticle}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{placeins}

%\usepackage{natbib}
%\usepackage[colorlinks,bookmarksopen,bookmarksnumbered,citecolor=red,urlcolor=red]{hyperref}
%\newcommand\BibTeX{{\rmfamily B\kern-.05em \textsc{i\kern-.025em b}\kern-.08em
%T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
%\usepackage{moreverb}

\title{A Comparison of Rosenbrock-Wanner and Crank-Nicolson Time Integrators for Atmospheric Modelling}
\author{%
	David Lee\textsuperscript{1}\thanks{Corresponding author: \href{mailto:david.lee@bom.gov.au}{david.lee@bom.gov.au}}
}

\date{\footnotesize\textsuperscript{\textbf{1}}Bureau of Meteorology, Melbourne, Australia}

\renewcommand{\maketitlehookd}{%
\begin{abstract}
Non-hydrostatic atmospheric models often use semi-implicit temporal discretisations in order
to negate the time step limitation of explicitly resolving the fast acoustic and gravity 
waves. Solving the resulting system to convergence using Newton's method is considered 
prohibitively expensive, and so the non-linear solver is typically truncated to a fixed 
number of iterations, using an approximate Jacobian matrix that is reassembled only once 
per time step. Rather than simply using four iterations of a second order Crank-Nicolson 
time discretisation, the present article studies the impact of using various third-order, 
four stage Rosenbrock-Wanner schemes, where instead of a simple time centering, the 
integration weights are chosen to meet specific stability and order conditions. 
Rosenbrock-Wanner schemes present a promising alternative on account of their ability to 
preserve their temporal order with only an approximate Jacobian, and may be constructed to 
be stiffly-stable, a desirable property in the presence of fast wave dynamics across multiple 
scales. These schemes are compared to four iterations of a Crank-Nicolson scheme for the 
solution of the 2D rotating shallow water equations and the 3D compressible Euler equations at 
both planetary and non-hydrostatic scales and are shown to exhibit improved results in terms
of their energetic profiles and stability.
\end{abstract}
}

\begin{document}

\maketitle % Output the title section

Semi-implicit time discretisations are a popular choice for non-hydrostatic atmospheric models, 
since they negate the time step limitation associated with the explicit solution of acoustic 
and gravity waves \cite{Melvin et al. (2019),Maynard et al. (2020)}. This is particularly true for finite element spatial discretisations using
Gauss-Lobatto quadrature rules, since unlike spectral element or discontinuous Galerkin methods 
using inexact spatial integration, these finite element methods have non-diagonal mass matrices
which require the implicit solution of linear systems even for the case of explicit time 
integration schemes. These implicit non-linear systems are commonly solved using Newton's method,
for which the right hand side residual vector is discretised using a second order, time centered (or off-centered)
Crank-Nicolson scheme, or some similar iterative method. However due to computational performance
limitations, this non-linear solver is typically truncated to a fixed number of iterations, rather
than to the convergence of the residual below some specified tolerance. Moreover in order to further
improve computational performance, the Jacobian operator used to determine the descent direction 
at each iteration is often approximated by omitting non-stiff terms, 
the use of vertical reference profiles, and the re-use of the same Jacobian operator between 
non-linear iterations or even time steps. Consequently this approximate solution may be regarded as a 
quasi-Newton method, rather than a full Newton method for which the Jacobian would incorporate all 
derivatives of the residual vector with respect to all solution variables, and be re-assembled at 
each non-linear iteration.

As an alternative to such a scheme, this article considers the use of Rosenbrock-Wanner methods, 
where a finite number of non-linear iterations are replaced by a fixed number of implicit Runge-Kutta
stages, for which the weights are chosen so as to satisfy specific order and stability conditions \cite{Hairer and Wanner (1996),Rang and Angermann (2005)}.
In the current study we limit ourselves to four stage schemes, since previous experiments with 
finite iteration Crank-Nicolson schemes for planetary scale atmospheric modelling have shown that an even number of iterations is required,
which may potentially be a result of the skew-symmetric Coriolis operator used to simulate the 
earth's rotation, which yields a series of pairs of complex conjugate eigenvalues \cite{Golub and Vanderstraeten (2000)}. The four-stage, third 
order Rosenbrock-Wanner schemes considered here are for the most part stiffly-stable methods which 
are well suited to geophysical systems that involve fast acoustic and gravity waves.

Like the incompressible Navier-Stokes equations, the compressible Euler equations also include 
an algebraic equation, in this case an equation of state, not an incompressibility constraint. The 
presence of this algebraic equation leads to a non-singular Helmholtz equation for the pressure 
involving a temporal second derivative. Consequently the Rosenbrock-Wanner methods studied here 
must also support index-2 partial differential algebraic equations (PDAEs). This is of particular 
importance since the Helmholtz pressure equation is often used as a preconditioner for the full 
coupled system of equations, as is the case for the 3D compressible Euler equations solver of
the UK Met Office's \emph{LFRic} model used in the present study \cite{Maynard et al. (2020)}. 

Rosenbrock-Wanner methods (for which only an approximate Jacobian is required) have shown great 
promise for the solution of the incompressible Navier-Stokes equations in two \cite{John et al. (2006)} and 
three \cite{Deparis et al. (2019)} spatial dimensions, which also involve an index-2 PDAE elliptic equation, 
in the form of a Poisson equation for the pressure. Therefore it is reasonable to expect that they would 
also be beneficial for the solution of geophysical systems, such as the rotating shallow water 
equations and the 3D compressible Euler equations. Another advantage of Rosenbrock-Wanner schemes 
is that they posses an embedded low order solution, which may be used for adaptive time step control 
\cite{John and Rang (2010)}. They have also been applied to the simulation of compressible Navier-Stokes in two
\cite{Blom et al. (2016)} and three \cite{Liu et al. (2016)} dimensions, as well as to optimal control problems \cite{Lang (2013)}.
A second order, three stage Rosenbrock scheme has also been used in the ASAM atmospheric model \cite{Jahn et al. (2015)}.

The remainder of this article proceeds as follows: In Section 1 the formulation of Rosenbrock-Wanner 
methods will be briefly introduced. More detailed discussions can be found in the references therein.
Section 2 describes the geophysical systems studied in this article, namely the 2D rotating shallow
water equations and the 3D compressible Euler equations. Results comparing the application of four 
stage Rosenbrock-Wanner methods to four iterations of a Crank-Nicolson scheme for standard test 
cases for these systems will be presented in Section 3. Finally, conclusions based on these results
will be presented in Section 4.

\section{Introduction to Rosenbrock-Wanner methods}

We are concerned with systems of PDAEs with a temporal structure of the form
\begin{subequations}
\begin{align}
	\boldsymbol{\mathsf{M}}\frac{d\boldsymbol{x}}{dt} &= F(\boldsymbol{x},\boldsymbol{y}) \\
	\boldsymbol{0} &= G(\boldsymbol{x},\boldsymbol{y})
\end{align}
\end{subequations}
where $\boldsymbol{\mathsf{M}}$ is some mass matrix, $\boldsymbol{x}$, $\boldsymbol{y}$ are vectors
of prognostic and diagnostic state variables respectively, $F$ includes all forcing terms for the 
prognostic equations and $G$ is a set of time independent algebraic equations. If $F$ and $G$ are 
non-linear functions of $\boldsymbol{x}$ and $\boldsymbol{y}$ then we may apply a centered Crank-Nicolson 
temporal discretisation with respect to a time step $\Delta t$ and solve the resulting system for 
time step $n+1$ using Newton's method at each non-linear iteration $i\ge 1$ with an initial state for the
time step $\boldsymbol{y}^0=\boldsymbol{y}^n$ as
\begin{subequations}\label{eq::cn}
\begin{align}
	\boldsymbol{\mathsf{M}}\delta\boldsymbol{x}^i - \gamma\Delta t\boldsymbol{\mathsf{W}}_F^i
	\begin{bmatrix}
	\delta\boldsymbol{x}^i \\
	\delta\boldsymbol{y}^i 
	\end{bmatrix}
	&= 
	\boldsymbol{\mathsf{M}}(\boldsymbol{x}^n - \boldsymbol{x}^{i-1}) + \notag \\
	\frac{\Delta t}{2}\Bigg(F(\boldsymbol{x}^n,\boldsymbol{y}^n) + F(\boldsymbol{x}^{i-1},\boldsymbol{y}^{i-1})\Bigg) \label{eq::cn_1}\\
	-\boldsymbol{\mathsf{W}}_G^i
	\begin{bmatrix}
	\delta\boldsymbol{x}^i \\
	\delta\boldsymbol{y}^i 
	\end{bmatrix}
	&= G(\boldsymbol{x}^{i-1},\boldsymbol{y}^{i-1})
\end{align}
\end{subequations}
where $\gamma = 1/2$ for an optimal rate of convergence, and
\begin{equation}
	\boldsymbol{\mathsf{W}}^i=
	\begin{bmatrix}
	\boldsymbol{\mathsf{W}}_F^i \\
	\boldsymbol{\mathsf{W}}_G^i 
	\end{bmatrix}
	\approx
	\begin{bmatrix}
		\frac{\delta F(\boldsymbol{x}^i,\boldsymbol{y}^i)}{\delta\boldsymbol{x}^i} &
		\frac{\delta F(\boldsymbol{x}^i,\boldsymbol{y}^i)}{\delta\boldsymbol{y}^i} \\
		\frac{\delta G(\boldsymbol{x}^i,\boldsymbol{y}^i)}{\delta\boldsymbol{x}^i} &
		\frac{\delta G(\boldsymbol{x}^i,\boldsymbol{y}^i)}{\delta\boldsymbol{y}^i} 
	\end{bmatrix}
\end{equation}
is the (approximate) Jacobian matrix evaluated at iteration $i$ and
\begin{subequations}\label{eq::newton_recon}
	\begin{align}
		\boldsymbol{x}^{i+1} &= \boldsymbol{x}^{i} + \delta\boldsymbol{x}^{i} =
	\boldsymbol{x}^n + \sum_{j=1}^i\delta\boldsymbol{x}^j,\\
		\boldsymbol{y}^{i+1} &= \boldsymbol{y}^{i} + \delta\boldsymbol{y}^{i} =
	\boldsymbol{y}^n + \sum_{j=1}^i\delta\boldsymbol{y}^j.
	\end{align}
\end{subequations}
The iteration is terminated and the solution at time level $n+1$ is updated once 
$||\delta\boldsymbol{x}^{i}||$, $||\delta\boldsymbol{y}^{i}||$ are below some specified tolerance.

As discussed above, solving to convergence and re-assembling $\boldsymbol{\mathsf{W}}$ at each iteration 
$i$ is prohibitively expensive for many applications, and so typically this is assembled only once per 
time step as $\boldsymbol{\mathsf{W}}^1$. Also rather than terminate when the solution increments are 
below some tolerance, the stopping condition is set for a fixed number of iterations $s$ as $i > s$.

In contrast to the Newton iteration with the Crank-Nicolson time discretisation described above, the
Rosenbrock-Wanner method with $s$-stages is given for an autonomous system of PDAEs (where $F$ and $G$ do 
not depend directly on $t$) at iteration $1\le i\le s$ as \cite{Hairer and Wanner (1996),Rang and Angermann (2005),Rang (2013)}
\begin{subequations}\label{eq::ros}
\begin{align}
	\boldsymbol{\mathsf{M}}\boldsymbol{k}^i
	- \gamma_{ii}\Delta t\boldsymbol{\mathsf{W}}_F^1
	\begin{bmatrix}\boldsymbol{k}^i \\ \boldsymbol{l}^i\end{bmatrix} &= 
	\Delta tF(\boldsymbol{x}_*^i,\boldsymbol{y}_*^i) + \notag \\
	\Delta t\boldsymbol{\mathsf{W}}_F^1\sum_{j=1}^{i-1}\gamma_{ij}
	\begin{bmatrix}\boldsymbol{k}^j \\ \boldsymbol{l}^j\end{bmatrix} \\
	-\gamma_{ii}\boldsymbol{\mathsf{W}}_G^1
	\begin{bmatrix}\boldsymbol{k}^i \\ \boldsymbol{l}^i\end{bmatrix} &= 
	G(\boldsymbol{x}_*^i,\boldsymbol{y}_*^i) + 
	\boldsymbol{\mathsf{W}}_G^1\sum_{j=1}^{i-1}\gamma_{ij}
	\begin{bmatrix}\boldsymbol{k}^j \\ \boldsymbol{l}^j\end{bmatrix}
\end{align}
\end{subequations}
where
\begin{equation}
	\boldsymbol{x}_*^i = \boldsymbol{x}^n + \sum_{j=1}^{i-1}\alpha_{ij}\boldsymbol{k}^j,\qquad
	\boldsymbol{y}_*^i = \boldsymbol{y}^n + \sum_{j=1}^{i-1}\alpha_{ij}\boldsymbol{l}^j
\end{equation}
for the scalar weights $\alpha_{ij}$ and $\gamma_{ij}$. Unlike Newton's method, where
the solution at the end of the time step is just the previous solution plus a sum over all the
solution increments $\delta\boldsymbol{x}_j$, $\delta\boldsymbol{y}_j$ \eqref{eq::newton_recon}, 
the solution at time level $n+1$ for the Rosenbrock-Wanner method is reconstructed from the 
scalar weights $b_i$ as
\begin{equation}
	\boldsymbol{x}^{n+1} = \boldsymbol{x}^n + \sum_{i=1}^sb_i\boldsymbol{k}^i,\qquad
	\boldsymbol{y}^{n+1} = \boldsymbol{y}^n + \sum_{i=1}^sb_i\boldsymbol{l}^i.
\end{equation}
In order to ensure that the left hand side operator only needs to be assembled once per time
step, the weights are customarily chosen such that $\gamma = \gamma_{ii}$ is constant for all 
stages $i$.

Rosenbrock-Wanner methods are a sub-class of Rosenbrock methods for which the coefficients 
$\alpha_{i,j}$, $\gamma_{i,j}$ are chosen to satisfy the required order condition for only
an approximate representation of the Jacobian, $\boldsymbol{\mathsf{W}}$. For some classes
of Rosenbrock-Wanner methods, such as Krylov-ROW \cite{Schmitt and Weiner (1995),Weiner et al. (1997)} and Rosenbrock-Krylov 
methods \cite{Tranquilli and Sandu (2014)}, this approximate Jacobian is derived from a low-rank approximation to 
the Krylov subspace generated from the actual Jacobian (which is often constructed via a 
matrix-free differencing of the residual vector). In the present context, this approximate
Jacobian is constructed \cite{Melvin et al. (2019),Maynard et al. (2020)} via the omission of non-stiff terms from
the matrix, and the linearisation of mean thermodynamic profiles.

\subsection{Quasi-Newton Crank-Nicolson time discretisation as a Rosenbrock-Wanner scheme}

In order to further illustrate the comparison between a finite iteration quasi-Newton method and 
Rosenbrock-Wanner methods, we show that the two stage, second order ROS2 scheme \cite{Verwer et al. (1999)} 
is equivalent to two iterations of a Newton method with a Crank-Nicolson time discretisation. For 
the sake of brevity, we show this equivalence for a system of equations involving prognostic 
equations only, however this equivalence also holds with the inclusion of algebraic equations.

Two iterations of the Crank-Nicolson scheme \eqref{eq::cn} give a solution as
\begin{subequations}\label{eq::cn_2stage}
	\begin{align}
	(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)\delta\boldsymbol{x}^1 &= 
		\Delta tF(\boldsymbol{x}^n),\label{eq::cn_ros2_it1}\\
		\boldsymbol{x}^1 &= \boldsymbol{x}^n +\delta\boldsymbol{x}^1,\\
	(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)\delta\boldsymbol{x}^2 &= 
		-\boldsymbol{\mathsf{M}}\delta\boldsymbol{x}^1 + \frac{\Delta t}{2}(F(\boldsymbol{x}^n) + 
		F(\boldsymbol{x}^1)),\label{eq::cn_ros2_it2}\\
		\boldsymbol{x}^{n+1} &= \boldsymbol{x}^n +\delta\boldsymbol{x}^1 + \delta\boldsymbol{x}^2
	\end{align}
\end{subequations}
In order to show the equivalence of the second iteration of the two iteration Crank-Nicolson scheme 
\eqref{eq::cn_ros2_it2} to the second stage of the ROS2 scheme (where $\alpha_{21}=1$, $\gamma_{21}=-2$, 
$b_1=b_2=1/2$) we begin by multiplying \eqref{eq::cn_ros2_it2} by two and subtracting \eqref{eq::cn_ros2_it1}, 
to give
\begin{equation}
(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)(2\delta\boldsymbol{x}^2 - \delta\boldsymbol{x}^1) = 
	-2\boldsymbol{\mathsf{M}}\delta\boldsymbol{x}^1 + \Delta tF(\boldsymbol{x}^1).
\end{equation}
Adding $(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)(2\delta\boldsymbol{x}^1)$
to both sides of the above expression gives
\begin{equation}
(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)(2\delta\boldsymbol{x}^2 + \delta\boldsymbol{x}^1) = 
	\Delta tF(\boldsymbol{x}^1)
	-2\gamma\Delta t\boldsymbol{\mathsf{W}}^1\delta\boldsymbol{x}^1.
\end{equation}
The above expression is equivalent to the second stage of the ROS2 scheme. Applying the substitution
$\boldsymbol{k}^1 = \delta\boldsymbol{x}^1$, $\boldsymbol{k}^2 = 2\delta\boldsymbol{x}^2 + \delta\boldsymbol{x}^1$ 
and constructing the solution using the ROS2 integration weights as
$\boldsymbol{x}^{n+1} = \boldsymbol{x}^n + \boldsymbol{k}^1/2 + \boldsymbol{k}^2/2$
we have that 
$\boldsymbol{x}^{n+1} = \boldsymbol{x}^n + \delta\boldsymbol{x}^1 + \delta{\boldsymbol{x}^2}$,
which is the correct solution for the two iteration Crank-Nicolson scheme. While the above scheme is 
typically run with $\gamma=1/2$, which is neutrally stable, an L-stable variant is given as 
$\gamma=1\pm\sqrt{2}/2$ \cite{Verwer et al. (1999)}.

We can extend this comparison to a quasi-Newton method with any number of stages, for which we have
at iteration $i>1$ that $\delta\boldsymbol{x}^i = \boldsymbol{k}^i/2 - \boldsymbol{k}^{i-1}/2$. For 
the four iteration Crank-Nicolson scheme (CN4), this is given as an equivalent Rosenbrock-Wanner 
scheme for the matrices $\mathsf{\Gamma}$, $\mathsf{A}$ as
\begin{subequations}
	\begin{align}
	\mathsf{\Gamma} &= (\gamma_{i,j})_{i,j=1}^4 =
	\gamma\begin{bmatrix}
		1 & 0 & 0 & 0 \\
		-2 & 1 & 0 & 0 \\
		-1 & -1 & 1 & 0 \\
		-1 & 0 & -1 & 1 
	\end{bmatrix},\\
	\mathsf{A} &= \begin{bmatrix}(\alpha_{i,j})_{i,j=1}^{3,4}\end{bmatrix} = 
	\begin{bmatrix}
		0 & 0 & 0 & 0 \\
		1 & 0 & 0 & 0 \\
		\frac{1}{2} & \frac{1}{2} & 0 & 0 \\
		\frac{1}{2} & 0 & \frac{1}{2} & 0
	\end{bmatrix},\\
	\boldsymbol{b} &= \begin{bmatrix}\frac{1}{2} & 0 & 0 & \frac{1}{2}\end{bmatrix}.
	\end{align}
\end{subequations}

For the prototypical case where $d\boldsymbol{x}/dt = \lambda\boldsymbol{x}$, 
$\boldsymbol{\mathsf{W}} = \delta F(\boldsymbol{x})/\delta\boldsymbol{x}=\lambda$
we have that $\boldsymbol{x}^{n+1} = R(\Delta t\lambda)\boldsymbol{x}^n$ where
$R(\Delta t\lambda) = 1 + \Delta t\lambda\boldsymbol{b}^{\top}(\mathsf{I} - \Delta t\lambda\mathsf{B})^{-1}\boldsymbol{1}$ 
is the amplification factor (see \cite{Hairer and Wanner (1996)}, ch. IV.7), $\mathsf{I}$ is the identity matrix and 
$\mathsf{B} = \mathsf{\Gamma} + \mathsf{A}$. For $\gamma = 1/2$ we have that 
$R(\Delta t\lambda) = (1+\Delta t\lambda/2)/(1-\Delta t\lambda/2)$, such that the solution is 
neutrally stable with eigenvalues on the unit circle, as is the case for the two stage 
Crank-Nicolson/ROS2 scheme \eqref{eq::cn_2stage} \cite{Verwer et al. (1999)}.
More generally we have the amplification factor for the four stage Crank-Nicolson Newton method, using
$z=\Delta t\lambda$ for brevity, as

\begin{multline}
%R(z) = \frac{1}{2}\Bigg(\frac{-2z}{\gamma z-1} + \frac{z^2(0.5-\gamma)}{(\gamma z-1)^2} + \frac{z^3(-\gamma^2 +\gamma -0.25)}{(\gamma z-1)^3} + \\
%       \frac{z^2(-4\gamma^3z^2+4.5\gamma ^2z^2+3\gamma^2z-1.75gz^2-2\gamma z-\gamma +0.25z^2+0.25z+0.5)}{(\gamma z-1)^4}\Bigg) + 1.
R(z) = \frac{-z}{\gamma z-1} + \frac{z^2(0.5-\gamma)}{2(\gamma z-1)^2} + \frac{z^3(-\gamma^2 +\gamma -0.25)}{2(\gamma z-1)^3} + \\
	\Bigg(z^2(-4\gamma^3z^2+4.5\gamma ^2z^2+3\gamma^2z-1.75gz^2-2\gamma z-\gamma + \\ 0.25z^2+0.25z+0.5)\Bigg)\Bigg/2(\gamma z-1)^4 + 1.
\end{multline}
The coefficient of the $z^4$ term in the numerator, 
$\gamma^4 - 4\gamma^3 + 3\gamma^2 - \gamma + 0.125$,
has real roots leading to L-stability as $\gamma=0.2716068084314726$ and $\gamma=3.1426067539416227$.

For the case of an off-centered Crank-Nicolson time integration scheme, for which the right hand side
in \eqref{eq::cn_1} is replaced with
\begin{multline}\label{eq::cn_rhs_alpha}
	\boldsymbol{\mathsf{M}}(\boldsymbol{x}^n - \boldsymbol{x}^{i-1}) + \\
	\Delta t\Bigg((1-\alpha)F(\boldsymbol{x}^n,\boldsymbol{y}^n) + \alpha F(\boldsymbol{x}^{i-1},\boldsymbol{y}^{i-1})\Bigg)
\end{multline}
for constant $\alpha$, we have a recurrence relation of 
$\delta\boldsymbol{x}^i = \alpha (\boldsymbol{k}^i - \boldsymbol{k}^{i-1})$,
$\boldsymbol{x}^i = \alpha\boldsymbol{k}^i + (1-\alpha)\boldsymbol{k}^{1})$. The corresponding 
matrix expressions are given as

\begin{subequations}
	\begin{align}
		\mathsf{\Gamma} &= (\gamma_{i,j})_{i,j=1}^4 =
	\gamma\begin{bmatrix}
		1 & 0 & 0 & 0 \\
		\frac{-1}{\alpha} & 1 & 0 & 0 \\
		\frac{\alpha-1}{\alpha} & -1 & 1 & 0 \\
		\frac{\alpha-1}{\alpha} & 0 & -1 & 1 
	\end{bmatrix},\\
		\mathsf{A} &= \begin{bmatrix}(\alpha_{i,j})_{i,j=1}^{3,4}\end{bmatrix} = 
	\begin{bmatrix}
		0 & 0 & 0 & 0 \\
		1 & 0 & 0 & 0 \\
		1-\alpha & \alpha & 0 & 0 \\
		1-\alpha & 0 & \alpha & 0
	\end{bmatrix},\\
		\boldsymbol{b} &= \begin{bmatrix}1-\alpha & 0 & 0 & \alpha\end{bmatrix}.
	\end{align}
\end{subequations}
For this general case the coefficient of the $z^4$ term are
$\gamma^4 - 4\gamma^3 + 6\alpha\gamma^2 - 4\alpha^2\gamma + \alpha^3$. As observed in Fig. \ref{fig::L-stable_gamma},
the real roots of this expression vary only weakly for the range of $\alpha$ values for which the left hand side
is approximately second order in time.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{gamma_v_alpha.png}
\caption{L-stable $\gamma$ values for the off-centered Crank-Nicolson scheme.}
\label{fig::L-stable_gamma}
\end{center}
\end{figure}

\section{Geophysical systems}

This article considers two different geophysical systems, the two dimensional rotating shallow
water equations on the sphere, and the three dimensional compressible Euler equations on both 
spherical and planar geometry. The rotating shallow water equations are a widely used prototypical
model of geophysical phenomena on account of their capacity to represent many of the dynamical
features of the full atmosphere, such are turbulence, waves and large scale force balances, within
an idealised setting. In the present case, comparing Crank-Nicolson and Rosenbrock-Wanner schemes
for the rotating shallow water equations allows us to benchmark the allowable time step and 
conservation properties of these methods for the case of a very simple approximate Jacobian at 
low mach-number.

\subsection{The rotating shallow water equations}

The two dimensional rotating shallow water equations are given for the velocity $\boldsymbol{u}$ 
and the fluid depth $h$ as
\begin{subequations}
	\begin{align}
	\frac{\partial\boldsymbol{u}}{\partial t} &= 
	-(\nabla\times\boldsymbol{u} + f)\times\boldsymbol{u} - \nabla\Bigg(\frac{\boldsymbol{u}\cdot\boldsymbol{u}}{2} + gh\Bigg) 
		= F_u(\boldsymbol{u},h)\\
	\frac{\partial h}{\partial t} &= 
		-\nabla\cdot(h\boldsymbol{u}) = F_h(\boldsymbol{u},h)
\end{align}
\end{subequations}
where $f$ is the Coriolis term due to the earth's rotation, and $g$ is gravity. For a mean fluid
depth $H$ much greater than the variations in $h$ and for spatial and temporal scales consistent
with the earth's rotation, the above system may be solved to convergence using a constant in time approximate
Jacobian of the form \cite{Bauer(2018),Wimmer et al. (2020),Lee et al. (2022)}
\begin{equation}
	\boldsymbol{\mathsf{W}}_{rsw} = 
	\begin{bmatrix}\boldsymbol{\mathsf{C}} & -g\boldsymbol{\mathsf{G}} \\
		H\boldsymbol{\mathsf{G}}^{\top} & \boldsymbol{\mathsf{0}}
	\end{bmatrix}
	\approx
	\begin{bmatrix}
		\frac{\partial F_u}{\partial\boldsymbol{u}} & 
		\frac{\partial F_u}{\partial h} \\ 
		\frac{\partial F_h}{\partial\boldsymbol{u}} & 
		\frac{\partial F_h}{\partial h} 
	\end{bmatrix},
\end{equation}
where $\boldsymbol{\mathsf{C}}$ is the Coriolis operator and $\boldsymbol{\mathsf{G}}$ is the gradient 
operator (for which the divergence operator is assumed to be its adjoint assuming periodic boundary conditions). 
The approximate Jacobian above omits non-linear terms associated with both mass and momentum transport, and
instead assumes a linearisation around a state of constant mean fluid depth, planetary rotation and 
gravitational potential. The shallow water equations consist of only prognostic equations for which 
$\boldsymbol{x}=(\boldsymbol{u},h)$ is the full state vector and there is no $\boldsymbol{y}$ vector of
algebraic constraints. See the above references for the specific definition of these operators using a 
$H(div)$ conforming finite element discretisation of the rotating shallow water equations. 

\subsection{The 3D compressible Euler equations}

While the rotating shallow water equations are a good model of many geophysical processes, to fully
capture the dynamics of a dry atmosphere at both planetary and non-hydrostatic scales, we also study
Rosenbrock-Wanner time integration for the 3D compressible Euler equations under the shallow 
atmosphere approximation, given for the velocity $\boldsymbol{u}$, density $\rho$, potential temperature
$\theta$ and Exner pressure $\Pi$ as \cite{Melvin et al. (2019),Maynard et al. (2020),Lee (2021),Lee and Palha (2021)} as
\begin{subequations}
	\begin{alignat}{3}
	\frac{\partial\boldsymbol{u}}{\partial t} &= 
		-(\nabla\times\boldsymbol{u} + f)\times\boldsymbol{u}\notag\\ &- \nabla\Bigg(\frac{\boldsymbol{u}\cdot\boldsymbol{u}}{2} + gz\Bigg)
		-c_p\theta\nabla\Pi &&= 
	F_u(\boldsymbol{u},\rho,\theta,\Pi)\label{eq::mom}\\
	\frac{\partial\rho}{\partial t} &= 
		-\nabla\cdot(\rho\boldsymbol{u}) &&= F_{\rho}(\boldsymbol{u},\rho)\label{eq::mass}\\
	\frac{\partial\theta}{\partial t} &= 
		-\boldsymbol{u}\cdot\nabla\theta &&= F_{\theta}(\boldsymbol{u},\theta)\label{eq::temp}\\
		0 &= \Pi - \Bigg(\frac{R\rho\theta}{p_0}\Bigg)^{\frac{R}{c_v}} &&= G_{\Pi}(\rho,\theta,\Pi),\label{eq::eos}
\end{alignat}
\end{subequations}
where $z$ is the vertical coordinate, $c_p$ and $c_v$ are the specific heats at constant pressure and volume respectively, 
$p_0$ is the reference surface pressure and $R = c_p - c_v$ is the ideal gas constant. The velocity transport term is 
expressed in \eqref{eq::mom} in \emph{vector invariant} form as 
$(\nabla\times\boldsymbol{u})\times\boldsymbol{u} + \nabla(\boldsymbol{u}\cdot\boldsymbol{u})/2$. This form has the desirable
property that the rotational and potential components of the flow are treated as separate terms. For the appropriate choice 
of finite element spaces for these terms, we can ensure that there is no spurious projections between rotational and divergence
components of the flow in the discrete form \cite{Cotter and Shipton (2012)}.
As an alternative we may also express this term in \emph{advective} form as $\boldsymbol{u}\cdot\nabla\boldsymbol{u}$. We will 
investigate both forms in the proceeding section.

Unlike the shallow water system,
the compressible Euler equations contain an algebraic equation in the form of the ideal gas law \eqref{eq::eos}, such that 
the prognostic variables are given as $\boldsymbol{x}=(\boldsymbol{u},\rho,\theta)$ and the diagnostic variable as 
$\boldsymbol{y}=\Pi$. Via repeated Schur complement decomposition of the coupled system, one may derive a non-singular 
Helmholtz equation for the solution of $\Pi$ \cite{Maynard et al. (2020)} or alternatively the density weighted potential temperature
$\rho\theta$ \cite{Lee (2021)}. Consequently any Rosenbrock-Wanner method used to solve the above system as a Helmholtz 
problem, either directly or as a preconditioner, should also be applicable to index-2 PDAEs. 

One possible approximate Jacobian for the above system, which results in a Helmholtz problem for the Exner pressure
via repeated Schur complement decomposition \cite{Melvin et al. (2019),Maynard et al. (2020)} is given as
\begin{align}\label{eq::ce_W}
	\boldsymbol{\mathsf{W}}_{ce} &=
	\begin{bmatrix}\boldsymbol{\mathsf{C}} & \boldsymbol{\mathsf{0}} &
		\boldsymbol{\mathsf{P}}^{\Pi *}_{u\theta} & -\boldsymbol{\mathsf{G}}^{\theta *} \\
		\boldsymbol{\mathsf{D}}^{\rho *} & \boldsymbol{\mathsf{0}} &
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} \\
		\boldsymbol{\mathsf{P}}^{\theta *}_{\theta u} &
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} \\
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{N}}_{\Pi}^{\rho *} & 
		\boldsymbol{\mathsf{P}}_{\Pi\theta}^{\theta *} & \boldsymbol{\mathsf{N}}_{\Pi}^{\Pi *} \\
	\end{bmatrix}\notag\\
	&\approx
	\begin{bmatrix}\frac{\partial F_{u}}{\partial\boldsymbol{u}} & \boldsymbol{\mathsf{0}} &
		\frac{\partial F_{u}}{\partial\theta} & \frac{\partial F_{u}}{\partial\Pi} \\
		\frac{\partial F_{\rho}}{\partial\boldsymbol{u}} & \boldsymbol{\mathsf{0}} &
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} \\
		\frac{\partial F_{\theta}}{\partial\boldsymbol{u}} &
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} \\
		\boldsymbol{\mathsf{0}} & \frac{\partial G_{\Pi}}{\partial\rho} & 
		\frac{\partial G_{\Pi}}{\partial\theta} & \frac{\partial G_{\Pi}}{\partial\Pi} \\
	\end{bmatrix},
\end{align}
where $\rho*$, $\theta*$ and $\Pi*$ are reference profiles for the density, potential temperature and Exner
pressure respectively, derived from the prognostic variables at the time of the Jacobian assembly. For a full 
description of these operators in the context of a $H(div)$ conforming finite element discretisation with 
$\boldsymbol{u}\in\mathbb{W}_2\subset H(div)$, $\rho,\Pi\in\mathbb{W}_3\subset L^2$,
$\theta\in\mathbb{W}_{cp}\subset H(div)$ (where $\mathbb{W}_{cp}$ is the set of bases in the subspace of 
$H(div)$ consisting of scalar functions that are $C^0$ continuous in the vertical dimension only) see 
\cite{Melvin et al. (2019)}.

\subsubsection{Implementation details}

While the Rosenbrock-Wanner method is straight forward to implement in an existing implicit solver 
with access to the approximate Jacobian operator, there are several particulars of the LFRic model 
\cite{Melvin et al. (2019),Maynard et al. (2020)} that require particular care.

As previously discussed, the LFRic model uses a Schur complement preconditioner that reduces the full 
mixed system to a Helmholtz equation for the Exner pressure, via an approximate mass lumping of the 
velocity mass matrix. Since this Helmholtz operator and its associated right hand side are derived 
algebraically from the existing coupled system, any Rosenbrock-Wanner method applied to solve this 
should ideally support index 2 PDAEs. Both the preconditioned Helmholtz operator and the full coupled 
outer solver are applied using matrix free methods, such that the approximate Jacobian operators in
\eqref{eq::ce_W} are only ever evaluated at the element level, and not as a global matrix.

Also, in order to allow for longer time steps with a fixed number of iterations, the mass and 
temperature transport terms in the right hand sides of equations \eqref{eq::mass} and \eqref{eq::temp} 
are evaluated explicitly in LFRic over a series of $M$ smaller CFL dependent sub-steps using a
transport velocity $\boldsymbol{u}^t$ as
\begin{subequations}\label{eq::explicit_adv}
\begin{align}
	\Delta tF_{\rho} &= \sum_{m=1}^M\rho^m - \rho^{m-1},\notag\\
	\rho^m - \rho^{m-1} &= \frac{\Delta t}{M}\sum_p^Pb_pk_p,\notag\\ k_p&=\nabla\cdot(\boldsymbol{u}^t\hat\rho_{m}^p),
	\notag\\\hat{\rho}_{m}^p &= \rho_{m-1} + \sum_{q=1}^{p-1}a_{pq}k_q \\
	\Delta tF_{\theta} &= \sum_{m=1}^M\theta^m - \theta^{m-1},
	\notag\\\theta^m - \theta^{m-1} &= \frac{\Delta t}{M}\sum_p^Pb_pk_p,\notag\\ k_p&=\boldsymbol{u}^t\cdot\nabla\hat\theta_{m}^p,
	\notag\\\hat{\theta}_{m}^p &= \theta_{m-1} + \sum_{q=1}^{p-1}a_{pq}k_q,
\end{align}
\end{subequations}
where for the Rosenbrock scheme $\boldsymbol{u}^t = \boldsymbol{u}^{i-1}$, whereas for the Crank-Nicolson
scheme a time centered velocity is used as $\boldsymbol{u}^t = (\boldsymbol{u}^n + \boldsymbol{u}^{i-1})/2$.

In addition to the explicit transport of density and potential temperature, there is also the option
in LFRic to explicitly integrate the momentum transport term (in advective form), $\boldsymbol{u}\cdot\nabla\boldsymbol{u}$ 
in a similar fashion as an alternative to the vector invariant form \eqref{eq::mom}. Both options will be 
studied below.

For the Crank-Nicolson scheme and the vector invariant Rosenbrock-Wanner scheme the initial state for the 
transport is given as $\rho^{n}$, $\theta^{n}$ (the state at the beginning of the time step). However for 
the Rosenbrock-Wanner scheme in advective form this was found to be unstable, and so the initial state was 
given as $\rho^{i-1}$,$\theta^{i-1}$ (the state and the current stage). While LFRic supports several different
Runge-Kutta schemes for the explicit sub-stepping of the transport terms, in each case below we have limited
ourselves to the simple case of a forward Euler time stepping. In each case just one or two such sub-steps 
were applied at each nonlinear iteration of the full solver.

\section{Results}

\subsection{Rotating shallow water: shear flow instability on the sphere}

We compare the results of four iterations of the Crank-Nicolson discretisation (CN4) to a variety of four stage
Rosenbrock-Wanner schemes in terms of both stable time step and energetic profiles for a standard shear flow
instability test case on the sphere \cite{Galewsky(2004)}, run for 12 days so as to ensure that the schemes remain
stable with the specified time step for a mature turbulent state. The various Rosenbrock-Wanner schemes are 
detailed in Table I.
\begin{table*}[t]
\begin{center}
\begin{tabular}{|c|c|c|c|}
	\hline
	Scheme & Reference & Index & Stability \\
	\hline
	ROS34PW2  & \cite{Rang and Angermann (2005)}   & 1 & $R(\infty)=0$ \\
	ROS34PW3  & \cite{Rang and Angermann (2005)}   & 1 & $R(\infty)\approx 0.63$ \\
	ROSI2w    & \cite{Rang and Angermann (2007)}   & 2 & $R(\infty)=0$, $\boldsymbol{\mathsf{W}}=\frac{\delta F}{\delta\boldsymbol{x}} + \mathcal{O}(\Delta t)$ \\
	ROSI2W    & \cite{Rang and Angermann (2007)}   & 2 & $R(\infty)=0$ \\
	ROS34PRW  & \cite{Rang (2013)}   & 2 & $R(\infty)=0$ \\
	ROS3PRL2  & \cite{Rang (2015),Lang and Teleaga (2007)} &   & $R(\infty)=0$ \\
	ROWDAIND2 & \cite{Lubich and Roche (1990)} & 2 & $R(\infty)=0$ \\
	\hline
\end{tabular}
\end{center}
	\caption{Rosenbrock-Wanner schemes used in this study}
\end{table*}

Figure \ref{fig::sw_1} shows the normalised energy and potential enstrophy conservation errors for the 
different four-stage Rosenbrock-Wanner and the CN4 scheme for the shear flow instability test case on 
the sphere. These are computed by globally integrating the total energy $E_{sw}$ and potential enstrophy 
$Z_{sw}$ over the domain $\Omega$ as
\begin{subequations}
	\begin{align}
		E_{sw} &= \int\frac{1}{2}h\boldsymbol{u}\cdot\boldsymbol{u} + \frac{g}{2}h^2\mathrm{d}\Omega\\
		Z_{sw} &= \int\frac{1}{2}hq^2\mathrm{d}\Omega,
	\end{align}
\end{subequations}
where $q = (\nabla\times\boldsymbol{u} + f)/h$ is the potential vorticity.
In each case the same $H(div)$ conforming finite element method is applied for the spatial 
discretisation \cite{Lee and Palha (2018),Lee et al. (2022)}, using $32\times 32$ third order finite elements on each panel 
of the cubed sphere. The non-linear potential enstrophy cascade to grid scales is stabilised via the 
anticipated potential vorticity method \cite{Sadourny and Basdevant (1985)} with an upwinding parameter of $\Delta t/2$. No 
damping is applied to the energy.

For the energy conservation error plot, solid lines indicate a long time energy growth, so
that the solution will ultimately become unstable, while dashed lines
indicate long time energy decay and hence stability. Of all the schemes, one in particular
allows for stable simulation using significantly longer time steps, ROS34PRW 
\cite{Rang (2013)}. Some care must be taken however, as while this scheme is stable for time steps
of up to 600 seconds, at these long times, the fast gravity waves are not properly resolved
over four non-linear stages, and so the shear flow instability occurs at the incorrect wave-number.
This is also observed in the potential enstrophy conservation error, which exhibits an anomalous
bump as the dynamics transition to the incorrect wave number. This problem is not observed and 
the dynamics evolve correctly for a time step of 540 seconds for the ROS34PRW scheme, 
which is still $20\%$ longer than the maximum stable time step of the CN4 scheme at 450 seconds.
The potential enstrophy conservation error is broadly representative of the richness of the turbulence
present in the solution. These errors broadly correlate with the length of the time steps for the 
different schemes, with the schemes with smaller stable time steps, such as ROS3PRL2 exhibiting the
smallest potential enstrophy conservation error and the ROS34PRW the greatest.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{rsw_conservation_energy.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{rsw_conservation_enstrophy.png}
\caption{Normalised Energy (top) and potential enstrophy (bottom) conservation errors for the 
different integrators for the shear flow instability test case on the sphere over 12 days at the
maximum observable stable time step for each scheme. Dashed lines for the energy conservation error 
indicate energy decay and solid lines for the energy conservation error indicate growth.}
\label{fig::sw_1}
\end{center}
\end{figure}

The maximum stable time steps are more clearly observed in the bar chart in Fig. \ref{fig::sw_2}. 
Here the schemes that exhibit positive energy error growth are given in blue, while the schemes 
that are long time stable are in green. The CN4 scheme is given as a reference in orange. The CN4
scheme is somewhere in the middle in terms of maximum stable time step, with several 
Rosenbrock-Wanner schemes allowing for longer time steps. The ROS34PRW scheme is once
again presented twice, once for its maximum stable time step of 600 seconds, and once for its
maximum physically correct time step of 540 seconds.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{rsw_timesteps.png}
\caption{Maximum stable time steps for the different Rosenbrock-Wanner and Crank-Nicolson
	schemes over 12 days of the shear flow instability test case on the sphere.}
\label{fig::sw_2}
\end{center}
\end{figure}

\subsection{3D compressible Euler: baroclinic instability on the sphere}\label{sec::bw}

The Rosenbrock-Wanner integrators are compared against CN4 for the 3D compressible Euler equations
at planetary scales using a standard test case for a baroclinic wave triggered by a velocity
perturbation in an otherwise geostrophically and hydrostatically balanced atmosphere on z-levels 
\cite{Ullrich et al. (2014)}. These are compared at two different spatial/temporal resolutions C48;
$6\times48\times 48$ lowest order elements ($\Delta x\approx 192km$, $\Delta t=1800s$) and C96;
$6\times96\times 96$ lowest order elements ($\Delta x\approx 96km$, $\Delta t=900s$), both using 
30 vertical levels. No dissipation
of any kind was used in these simulations, so in all cases the solution ultimately becomes unstable.
In order to maintain the stability of the CN4 scheme, this was run with the potential temperature 
transport term in the Jacobian, $\boldsymbol{\mathsf{P}}^{\theta *}_{\theta u}$ in \eqref{eq::ce_W}, 
fully off-centered in favor of the future time level, such that the factor of $\gamma=1$ in \eqref{eq::cn_1}
for this term only (and is kept as $\gamma=1/2$ for all other terms). No such off-centering was required for the Rosenbrock-Wanner schemes.
The globally integrated kinetic (horizontal and vertical), potential and internal energies are computed respectively over the 
full domain $\Omega$ at each time step as 
\begin{subequations}
\begin{align}
	K_h &= \int\frac{\rho\boldsymbol{u}_h\cdot\boldsymbol{u}_h}{2}\mathrm{d}\Omega \\
	K_v &= \int\frac{\rho w^2}{2}\mathrm{d}\Omega \\
	P &= \int\rho gz\mathrm{d}\Omega \\
	I &= \int c_v\rho\theta\Pi\mathrm{d}\Omega,
\end{align}
\end{subequations}
where $\boldsymbol{u}_h$ and $w$ are the horizontal and vertical velocities respectively.

As observed in the internal and potential energy evolution as shown in Fig. \ref{fig::ce_bw_1} the CN4
schemes exhibit a buoyancy oscillation on a time scale of $2\Delta t$, that is not present for the 
ROS34PRW scheme, which show a much smaller oscillation on a time scale of approximately 12 hours
independent of time step size. This oscillation is consistent with the temporal oscillation observed
in the horizontal kinetic energy in Fig. \ref{fig::ce_bw_2}. The growth of the baroclinic instability
is observed in the evolution of the vertical kinetic energy for the ROS34PRW scheme also in 
Fig. \ref{fig::ce_bw_2}. This result is consistent with previous observations using a high order mixed
finite element model with horizontally explicit/vertically implicit time stepping and exact energy 
conservation for the implicit vertical solve \cite{Lee (2021)}. However for the CN4 scheme, this signal is 
insignificant with respect to the vertical kinetic energy signal associated with the internal-potential 
buoyancy oscillation, which at $\mathcal{O}(10^{15})$ Joules is approximately $100$ times greater than 
the vertical kinetic energy associated with the baroclinic instability. 

This oscillation is perhaps a consequence of the neutral stability of the CN4 temporal scheme with 
$\gamma=1/2$. Using the L-stable $\gamma$ values described for the four iteration Crank-Nicolson 
scheme in Section 1.1, this oscillation is suppressed, however the simulation is rapidly observed 
to be unstable (and so is not presented here). An alternative, stable method for suppressing this 
oscillation is to off-center the Crank-Nicholson scheme in favor of the new time level (by a factor 
of $0.55$), however this leads to a degradation of accuracy, resulting in a scheme that is formally 
only first order accurate. Results using this off-centering for the CN4 scheme will be presented below.

In terms of the internal and potential energy evolution, only the ROS34PRW scheme at the C96 resolution
gives observably consistent results with respect to those previously published using an exact energy conserving vertical integrator 
\cite{Lee (2021)}, where both the internal and potential energy trend downward with time in order to balance the
growth in kinetic energy due to the baroclinic instability.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{internal_bw.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{potential_bw.png}
	\caption{Internal (top) and potential (bottom) energy evolution for the baroclinic
	wave test case for the CN4 (advective and vector invariant) and ROS34PRW (vector invariant) 
	schemes at the C48 and C96 resolutions. Note the different scales on the vertical axes for
	the Crank-Nicolson and Rosenbrock schemes.}
\label{fig::ce_bw_1}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{horiz_kinetic_bw.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{vert_kinetic_bw.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{conservation_error_bw.png}
	\caption{Horizontal (top) and vertical (center) kinetic energy evolution 
	and normalised total energy conservation error (bottom)
	for the baroclinic
	wave test case for the CN4 (advective and vector invariant) and ROS34PRW (vector invariant) 
	schemes at the C48 and C96 resolutions. Note the 
	different scales on the vertical axes for the Crank-Nicolson and Rosenbrock schemes for the 
	vertical kinetic energy.}
\label{fig::ce_bw_2}
\end{center}
\end{figure}

The total energy conservation error is also given in Fig. \ref{fig::ce_bw_2}, where it is observed 
that the CN4 scheme has significantly greater total energy growth than the ROS34PRW scheme at the
same resolution. In particular, the advective form of the CN4 integrator at C96 resolution exhibits 
a rapid growth of the energy conservation error that suggests the onset of numerical instability.
This is reflected in the fact that this configuration requires two forward Euler sub-steps for the 
transport terms at each nonlinear iteration, whereas each of the other configurations requires
just a single forward Euler sub-step for the transport.

The lowest level potential temperature and Exner pressure are shown at day 7 for the C96 
resolution in Figs \ref{fig::ce_bw_4_1}, \ref{fig::ce_bw_4_2} and \ref{fig::ce_bw_5_1}, \ref{fig::ce_bw_5_2} 
respectively for the CN4 and ROS34PRW schemes. While the results are in broad agreement 
for the potential temperature, there is a spurious meridional variation in surface 
pressure observed for the vector invariant CN4 and advective form ROS34PRW schemes. Additionally, 
spurious small scale oscillations are observed for the CN4 vector invariant scheme. 

Meridional biases are also observed for the CN4 scheme in both advective and vector invariant forms 
for the lowest level divergence as presented in Fig. \ref{fig::ce_bw_6_1}. These biases are an order
of magnitude greater than the divergence associated with the baroclinic instability, which is
clearly observed without such biases for the ROS34PRW formulations in Fig. \ref{fig::ce_bw_6_2}.
%where the meridional variation in divergence observed 
%for the CN4 scheme in both advective and vector invariant form is shown 
%to be an order of magnitude greater than that associated with the physical baroclinic instability, 
%which is observed clearly for the ROS34PRW scheme.
%This meridional divergence is perhaps due to 
%a loss of geostrophic balance, which is not strictly preserved for the discrete system in advective 
%form \cite{Cotter and Shipton (2012)}.
%While the vector invariant form does preserve geostrophic balance, there is also a considerable 
%divergence error for the CN4 scheme in this form as well which is not observed for the ROS34PRW
%scheme in vector invariant form.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{theta_cn4_advU.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{theta_cn4.png}
	\caption{Surface potential temperature for the CN4 advective form (top) and CN4 vector invariant form (bottom) 
	at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_4_1}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{theta_ros_adv_form.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{theta_ros.png}
	\caption{Surface potential temperature for the ROS34PRW advective form (top) and ROS34PRW vector invariant form (bottom) 
	at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_4_2}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{exner_cn4_advU.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{exner_cn4.png}
	\caption{Surface level Exner pressure the CN4 advective form (top) and CN4 vector invariant form (bottom) 
	at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_5_1}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{exner_ros_adv_form.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{exner_ros.png}
	\caption{Surface level Exner pressure for the ROS34PRW advective form (top) and ROS34PRW vector invariant form (bottom) 
	at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_5_2}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{divergence_cn4_advU.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{divergence_cn4.png}
	\caption{Surface level divergence the CN4 advective form (top) and CN4 vector invariant form (bottom) 
	at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_6_1}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{divergence_ros_adv_form.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{divergence_ros.png}
	\caption{Surface level divergence for the ROS34PRW advective form (top) and ROS34PRW vector invariant form (bottom) 
	at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_6_2}
\end{center}
\end{figure}

We also compare the energetic profiles for the various Rosenbrock-Wanner schemes studied for 
the shallow water equations in Section 3.1. for the C96 resolution in Fig. \ref{fig::ce_bw_7}. 
These are presented in vector invariant form for the largest time steps for which the different 
schemes were observed to be stable and convergent using the default settings for the coupled 
nonlinear solver and the Helmholtz preconditioner.
We exclude results for the ROWDAIND2 and ROS34PW3 schemes, as these were observed to be rapidly 
unstable, which is consistent with the shallow water results, where these schemes produced a 
positive growth in energy as seen in Figs. \ref{fig::sw_1}, \ref{fig::sw_2}.
In the case of the ROS34PW3 scheme, this is perhaps a consequence of the fact that it is not 
stiffly-stable. 

In all cases the Rosenbrock-Wanner schemes exhibit lower energy conservation error than the CN4 
scheme (in advective form). When comparing the vertical kinetic energy profiles, we see that 
in all cases the Rosenbrock-Wanner schemes exhibit a growth associated with the baroclinic 
instability that is consistent with previous results \cite{Lee (2021)}, and that is two orders of 
magnitude smaller that that associated with the buoyancy oscillation of the CN4 scheme. The 
ROS34PRW scheme is observed to be stable and convergent at a time step of $\Delta t=2400s$, 
which is approximately 30\% longer than the maximum observed stable time step for the CN4 scheme
at $\Delta t=1800s$. In all cases the configurations at the maximum observably stable time step 
required two forward Euler transport sub-steps for the majority of the simulation time. 

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{vert_kinetic_bw_2.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{internal_bw_2.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{conservation_error_bw_2.png}
	\caption{Comparison of the CN4 and Rosenbrock-Wanner schemes at their largest observed 
	stable time step for the C96 resolution
	with respect to the vertical kinetic energy (top), internal (center), and total 
	energy conservation error (bottom). Note the 
	different scales on the vertical axes for the Crank-Nicolson and Rosenbrock schemes 
	in the vertical kinetic energy plot.}
\label{fig::ce_bw_7}
\end{center}
\end{figure}

One method of suppressing the fast buoyancy oscillation observed for the CN4 scheme is to
off-center the time discretisation in favor of the future time level $n+1$, as given in
\eqref{eq::cn_rhs_alpha} as this ensures that the time discretisation is no longer neutrally 
stable. The downside of this approach is that the time discretisation is now
formally only first order accurate. In Fig. \ref{fig::ce_bw_8} we compare the internal and
potential energy and energy conservation error profiles for the CN4 scheme using centered 
($\alpha=0.5$) and off-centered ($\alpha=0.55$) time discretisations with respect to the
ROS34PRW Rosenbrock-Wanner scheme for the C96 resolution.

As observed, the off-centering does ultimately suppress the buoyancy oscillation, such that
it is of smaller amplitude that the long time signal after approximately 1-2 days.
However the energy conservation errors are still greater than for the 
ROS34PRW scheme, which exhibits no such oscillation even at short times. Even with the 
off-centered time discretisation, the CN4 schemes still exhibit spurious growth in the
potential and internal energies, which should actually be decreasing to balance the
growth in kinetic energy of the baroclinic instability as is the case for the ROS34PRW
scheme, and also for previous results using an integrator that exactly conserves energy
for the vertical dynamics \cite{Lee (2021)}.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{internal_bw_3.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{potential_bw_3.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{conservation_error_bw_3.png}
	\caption{Comparison of the CN4 (center and off-centered) and ROS34PRW for the C96 resolution
	with respect to the internal energy (top), potential energy (center) differences from their
	initial values, and total energy conservation error (bottom). Note the difference in scales
	on the vertical axes for the internal and potential energy plots.}
\label{fig::ce_bw_8}
\end{center}
\end{figure}

We also compare the lowest level divergence for the off-centered advective and vector invariant 
CN4 schemes in Fig. \ref{fig::ce_bw_9}. While the meridional biases are
reduced somewhat compared to those observed for the centered formulations in Fig. \ref{fig::ce_bw_6_1}, 
they are still present and greater than the physical divergence of the baroclinic instability,
which is observed without such bias for the ROS34PRW scheme in Fig. \ref{fig::ce_bw_6_2}.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{divergence_cn4_advU_alpha0p55.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{divergence_cn4_alpha0p55.png}
	\caption{Surface divergence for the off-centered CN4 advective (top) and vector invariant (bottom) form
	at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_9}
\end{center}
\end{figure}

\subsection{3D compressible Euler: warm bubble on the plane}\label{sec::wb}

While the baroclinic instability test case in the previous section is a good measure of the 
dynamics and planetary scales, the non-hydrostatic and compressible dynamics are negligible 
at these scales. Consequently we also compare the different schemes for a high resolution
3D warm bubble test case \cite{Giraldo et al. (2013),Melvin et al. (2019),Lee (2021),Lee and Palha (2021)} for which these effects
are significant. The model is configured with an initial state of constant density in hydrostatic 
balance in a three dimensional horizontally periodic box using $100\times 100\times 150$ lowest
order elements with a uniform resolution of $10m$ and a time step of $\Delta t=0.625s$. 
The balanced state is overlaid with a small potential temperature perturbation, which rises and 
distorts over several minutes. In each case just a single forward Euler sub-step is used for the 
transport terms.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{theta_xz_T000640_cn4_advU.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{theta_xz_T000640_cn4.png}
	\caption{Potential temperature cross section at $y=0$ for the 3D warm bubble test case
	at time $400s$ for the advective (top) and vector invariant (bottom) form of the CN4 scheme.}
\label{fig::ce_wb_1_1}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{theta_xz_T000640_ros_adv_form.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{theta_xz_T000640.png}
	\caption{Potential temperature cross section at $y=0$ for the 3D warm bubble test case
	at time $400s$ for the advective (top) and vector invariant (bottom) form of the ROS34PRW scheme.}
\label{fig::ce_wb_1_2}
\end{center}
\end{figure}

As can be in Figs. \ref{fig::ce_wb_1_1} and \ref{fig::ce_wb_1_2}, the potential temperature perturbation rises with a 
comparable velocity and profile for both CN4 schemes and the vector invariant ROS34PRW scheme, suggesting that the
spurious oscillations and meridional balance issues observed for the CN4 scheme at planetary
scales are not present in a non-rotating frame with a constant mean vertical profile. The advective form
ROS34PRW scheme is slightly more diffused however, suggesting that using $\rho^{i-1}$ and $\theta^{i-1}$
for the transport terms is less accurate than using $\rho^n$ and $\theta^n$, even with a single forward 
Euler transport step. 

The results of the vector invariant CN4 and ROS34PRW schemes are also very similar in terms of their
energetics, as observed in Fig. \ref{fig::ce_wb_2}, with the ROS23PRW scheme being marginally more accurate. 
However the advective forms exhibit greater errors in terms of both internal energy profile and conservation,
with the ROS34PRW advective form yielded superior energetic profiles to the CN4 advective form. 
Previous results \cite{Lee (2021)} using an exact energy conserving vertical integrator suggest
that while the potential energy should exhibit a negative trend as the bubble ascends, the 
mean internal energy (aside from the fast oscillation) should stay relatively constant, so
from this we infer that the vector invariant forms are more correct.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{vert_kinetic_wb.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{internal_wb.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{conservation_error_wb.png}
	\caption{Vertical kinetic (top) and internal (center) energy evolution and total
	energy conservation error (bottom) for the 
	CN4 (advective and vector invariant forms) and ROS34PRW (vector invariant) schemes for the warm bubble test case.}
\label{fig::ce_wb_2}
\end{center}
\end{figure}

\section{Conclusions}

This article compares the results for collection of four stage Rosenbrock-Wanner time 
integrators with an approximate Jacobian as a substitute for four iterations of a Newton 
method with a Crank-Nicolson time discretisation for the solution of geophysical systems 
at planetary and non-hydrostatic scales. While the advective form of the momentum equation 
was observed to give the most stable results for the CN4 scheme, the Rosenbrock-Wanner 
schemes were most accurate for in vector invariant form, and the Rosenbrock-Wanner schemes 
negated the biases observed for the CN4 scheme in terms of both energetics (buoyancy 
oscillations and long time drifts in potential and internal energy) and meridional 
profiles at planetary scales. For both the rotating shallow water and 3D compressible 
Euler equations at planetary scales, the vector invariant ROS34PRW scheme allowed for 
stable and convergent time steps that were 20\%-30\% longer than those permitted for the
CN4 scheme. At high resolution for an advection dominated test case with near-constant 
vertical temperature and density profiles, the energetics for the two schemes are similar 
when run in vector invariant form.

\section{Acknowledgments}

David Lee would like to thank Drs. Gary Dietachmayer and Nigel Wood for their helpful 
comments and insights on an early version of this manuscript, and Drs. Thomas Melvin 
and Ben Shipway for their constructive comments and advice.

The author acknowledges no conflict of interest.

\begin{thebibliography}{32}
\providecommand{\natexlab}[1]{#1}
\providecommand{\url}[1]{\texttt{#1}}
\expandafter\ifx\csname urlstyle\endcsname\relax
  \providecommand{\doi}[1]{doi: #1}\else
  \providecommand{\doi}{doi: \begingroup \urlstyle{rm}\Url}\fi

\bibitem{Bauer(2018)}
W~Bauer and C~J Cotter.
\newblock Energy-enstrophy conserving compatible finite element schemes for the
  rotating shallow water equations with slip boundary conditions.
\newblock \emph{J. Comp. Phys.}, 373:\penalty0 171--187, 2018.

\bibitem{Blom et al. (2016)}
D~S Blom, P~Birken, H~Bijl, F~Kessels, A~Meister, and A~H van Zuijlen.
\newblock A comparison of {R}osenbrock and {ESDIRK} methods combined with
  iterative solvers for unsteady compressible flows.
\newblock \emph{Adv. Comput. Math.}, 42:\penalty0 1401--1426, 2016.

\bibitem{Cotter and Shipton (2012)}
C~J Cotter and J~Shipton.
\newblock Mixed finite elements for numerical weather prediction.
\newblock \emph{J. Comp. Phys.}, 231:\penalty0 7076--7091, 2012.

\bibitem{Deparis et al. (2019)}
S~Deparis, M~O Deville, F~Menghini, L~Pegolotti, and A~Quarteroni.
\newblock Application of the {R}osenbrock methods to the solution of unsteady
  3{D} incompressible {N}avier-{S}tokes equations.
\newblock \emph{Computers \& Fluids}, 179:\penalty0 112--122, 2019.

\bibitem{Galewsky(2004)}
J~Galewsky, R~K Scott, and L~M Polvani.
\newblock An initial-value problem for testing numerical models of the global
  shallow water equations.
\newblock \emph{Tellus}, 56A:\penalty0 429--440, 2004.

\bibitem{Giraldo et al. (2013)}
F~X Giraldo, J~F Kelly, and E~M Constantinescu.
\newblock Implicit-explicit formulations of a three-dimensional nonhydrostatic
  unified model of the atmosphere ({NUMA}).
\newblock \emph{{SIAM} J. Sci. Comput.}, 35:\penalty0 B1162--B1194, 2013.

\bibitem{Golub and Vanderstraeten (2000)}
G~H Golub and D~Vanderstraeten.
\newblock On the preconditioning of matrices with skew-symmetric splittings.
\newblock \emph{Numer. Algorithms}, 25:\penalty0 223--239, 2000.

\bibitem{Hairer and Wanner (1996)}
E~Hairer and G~Wanner.
\newblock \emph{Solving ordinary differential equations. {II}: {S}tiff and
  differential-algebraic problems, Springer Series in Computational
  Mathematics, second ed., vol. 14}.
\newblock Springer-Verlag, Berlin, 1996.

\bibitem{Jahn et al. (2015)}
M~J\"ahn, O~Knoth, M~K\"onig, and U~Vogelsberg.
\newblock {ASAM v2.7}: a compressible atmospheric model with a {C}artesian cut
  cell approach.
\newblock \emph{Geosci. Model Dev.}, 8:\penalty0 317--340, 2015.

\bibitem{John and Rang (2010)}
V~John and J~Rang.
\newblock Adaptive time step control for the incompressible {N}avier{S}tokes
  equations.
\newblock \emph{Comput. Methods Appl. Mech. Engrg.}, 199:\penalty0 514--524,
  2010.

\bibitem{John et al. (2006)}
V~John, G~Matthies, and J~Rang.
\newblock A comparison of time-discretization/linearization approaches for the
  incompressible {N}avier{S}tokes equations.
\newblock \emph{Comput. Methods Appl. Mech. Engrg.}, 195:\penalty0 5995--6010,
  2006.

\bibitem{Lang and Teleaga (2007)}
J~Lang and D~Teleaga.
\newblock Towards a fully space-time adaptive {FEM} for magnetoquasistatics.
\newblock \emph{IEEE Trans. Magn.}, 44:\penalty0 1238--1241, 2008.

\bibitem{Lang (2013)}
J~Lang and J~G Verwer.
\newblock W-methods in optimal control.
\newblock \emph{Numer. Math.}, 124:\penalty0 337--360, 2013.

\bibitem{Lee (2021)}
D~Lee.
\newblock An energetically balanced, quasi-{N}ewton integrator for
  non-hydrostatic vertical atmospheric dynamics.
\newblock \emph{J. Comp. Phys.}, 429:\penalty0 109988, 2021.

\bibitem{Lee and Palha (2018)}
D~Lee and A~Palha.
\newblock A mixed mimetic spectral element model of the rotating shallow water
  equations on the cubed sphere.
\newblock \emph{J. Comp. Phys.}, 375:\penalty0 240--262, 2018.

\bibitem{Lee and Palha (2021)}
D~Lee and A~Palha.
\newblock Exact spatial and temporal balance of energy exchanges within a
  horizontally explicit/vertically implicit non-hydrostatic atmosphere.
\newblock \emph{J. Comp. Phys.}, 440:\penalty0 110432, 2021.

\bibitem{Lee et al. (2022)}
D~Lee, A~Martin, C~Bladwell, and S~Badia.
\newblock A comparison of variational upwinding schemes for geophysical fluids,
  and their application to potential enstrophy conserving discretisations in
  space and time.
\newblock \emph{arXiv:2203.04629}, 2022.

\bibitem{Liu et al. (2016)}
X~Liu, Y~Xia, H~Luo, and L~Xuan.
\newblock A comparative study of {R}osenbrock-type and implicit {R}unge-{K}utta
  time integration for discontinuous {G}alerkin method for unsteady 3{D}
  compressible {N}avier{S}tokes equations.
\newblock \emph{Commun. Comput. Phys.}, 20:\penalty0 1016--1044, 2016.

\bibitem{Lubich and Roche (1990)}
C~Lubich and M~Roche.
\newblock Rosenbrock methods for differential-algebraic systems with
  solution-dependent singular matrix multiplying the derivative.
\newblock \emph{Computing}, 43:\penalty0 325--342, 1990.

\bibitem{Maynard et al. (2020)}
C~Maynard, T~Melvin, and E~H M\"uller.
\newblock Multigrid preconditioners for the mixed finite element dynamical core
  of the {LFR}ic atmospheric model.
\newblock \emph{Q. J. R. Meteorol. Soc.}, 146:\penalty0 3917--3936, 2020.

\bibitem{Melvin et al. (2019)}
T~Melvin, T~Benacchio, B~Shipway, N~Wood, J~Thuburn, and C~Cotter.
\newblock A mixed finite-element, finite-volume, semi-implicit discretisation
  for atmospheric dynamics: {C}artesian geometry.
\newblock \emph{Q. J. R. Meteorol. Soc.}, 145:\penalty0 1--19, 2019.

\bibitem{Rang (2013)}
J~Rang.
\newblock A new stiffly accurate {R}osenbrock{W}anner method for solving the
  incompressible {N}avier-{S}tokes equations.
\newblock In Ansorge R, Bijl H, Meister A, and Sonar T, editors, \emph{Recent
  Developments in the Numerics of Nonlinear Hyperbolic Conservation Laws, 120},
  pages 301--315. Springer Verlag, Heidelberg, Berlin, 2012.

\bibitem{Rang (2015)}
J~Rang.
\newblock Improved traditional {R}osenbrock{W}anner methods for stiff {ODE}s
  and {DAE}s.
\newblock \emph{J. Comput. Appl. Math.}, 286:\penalty0 128--144, 2015.

\bibitem{Rang and Angermann (2005)}
J~Rang and L~Angermann.
\newblock New {R}osenbrock {W}-methods of order 3 for partial differential
  algebraic equations of index 1.
\newblock \emph{BIT Numer. Math.}, 45:\penalty0 761--787, 2005.

\bibitem{Rang and Angermann (2007)}
J~Rang and L~Angermann.
\newblock New {R}osenbrock methods of order 3 for {PDAE}s of index 2.
\newblock \emph{Adv. Differ. Eq. Control. Process.}, 1:\penalty0 193--217,
  2008.

\bibitem{Sadourny and Basdevant (1985)}
R~Sadourny and C~Basdevant.
\newblock Parameterization of {S}ubgrid {S}cale {B}arotropic and {B}aroclinic
  {E}ddies in {Q}uasi-geostrophic {M}odels: {A}nticipated {P}otential
  {V}orticity {M}ethod.
\newblock \emph{J. Atmos. Sci.}, 42:\penalty0 1353--1363, 1985.

\bibitem{Schmitt and Weiner (1995)}
B~A Schmitt and R~Weiner.
\newblock Matrix-free {W}-methods using a multiple {A}rnoldi iteration.
\newblock \emph{Appl. Numer. Math.}, 18:\penalty0 307--320, 1995.

\bibitem{Tranquilli and Sandu (2014)}
P~Tranquilli and A~Sandu.
\newblock Rosenbrock-{K}rylov methods for large systems of differential
  equations.
\newblock \emph{SIAM J. Sci. Comput.}, 36:\penalty0 A1313--A1338, 2014.

\bibitem{Ullrich et al. (2014)}
P~A Ullrich, T~Melvin, C~Jablonowski, and A~Staniforth.
\newblock A proposed baroclinic wave test case for deep and
  shallowatmosphere dynamical cores.
\newblock \emph{Q. J. R. Meteorol. Soc.}, 140:\penalty0 1590--1602, 2014.

\bibitem{Verwer et al. (1999)}
J~G Verwer, E~J Spee, J~G Blom, and W~Hundsdorfer.
\newblock A second-order {R}osenbrock method applied to photochemical
  dispersion problems.
\newblock \emph{SIAM J. Sci. Comput.}, 20:\penalty0 1456--1480, 1999.

\bibitem{Weiner et al. (1997)}
R~Weiner, B~A Schmitt, and H~Podhaisky.
\newblock {ROWMAP}a {ROW}-code with {K}rylov techniques for large stiff
  {ODE}s.
\newblock \emph{Appl. Numer. Math.}, 25:\penalty0 303--319, 1997.

\bibitem{Wimmer et al. (2020)}
G~A Wimmer, C~J Cotter, and W~Bauer.
\newblock Energy conserving upwinded compatible finite element schemes for the
  rotating shallow water equations.
\newblock \emph{J. Comp. Phys.}, 401:\penalty0 109016, 2020.

\end{thebibliography}

\end{document}
