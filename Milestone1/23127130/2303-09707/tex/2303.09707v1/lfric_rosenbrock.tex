\documentclass[preprint,3p,sort&compress,final,times]{elsarticle}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{placeins}
\usepackage[usenames,dvipsnames]{color}
\usepackage{cases}
\usepackage{array}

\usepackage[usenames,dvipsnames]{color}

%\journal{}
\begin{document}
\begin{frontmatter}

\title{Rosenbrock-Wanner Time Integration in Atmospheric Modelling}
\author[BOM]{David Lee\corref{cor}}
\ead{david.lee@bom.gov.au}

\address[BOM]{Bureau of Meteorology, Melbourne, Australia}

\begin{abstract}
Non-hydrostatic atmospheric models often use semi-implicit temporal discretisations in order
to negate the time step limitation of explicitly resolving the fast acoustic and gravity 
waves. Solving the resulting system to convergence using Newton's method is considered 
prohibitively expensive, and so the non-linear solver is typically truncated to a fixed 
number of iterations, using an approximate Jacobian matrix that is reassembled only once 
per time step. Rather than simply using four iterations of a second order Crank-Nicolson 
time discretisation as is customary, the present article studies the impact of using various third-order, 
four stage Rosenbrock-Wanner schemes, where instead of a simple time centering, the 
integration weights are chosen to meet specific stability and order conditions. 
Rosenbrock-Wanner schemes present a promising alternative on account of their ability to 
preserve their temporal order with only an approximate Jacobian, and may be constructed to 
be stiffly-stable, a desirable property in the presence of fast wave dynamics across multiple 
scales. These schemes are compared to four iterations of a Crank-Nicolson scheme for the 
solution of the 2D rotating shallow water equations at the 3D compressible Euler equations at 
both planetary and non-hydrostatic scales are are shown to exhibit improved results in terms
of their energetic profiles and stability.
\end{abstract}

\end{frontmatter}

Semi-implicit time discretisations are a popular choice for non-hydrostatic atmospheric models, 
since they negate the time step limitation associated with the explicit solution of acoustic 
and gravity waves \cite{Melvin19,Maynard20}. This is particularly true for finite element spatial discretisations using
Gauss-Lobatto quadrature rules, since unlike spectral element or discontinuous Galerkin methods 
using inexact spatial integration, these finite element methods have non-diagonal mass matrices
which require the implicit solution of linear systems even for the case of explicit time 
integration schemes. These implicit non-linear systems are commonly solved using Newton's method,
for which the right hand side residual vector is discretised using a second order, time centered (or off-centered)
Crank-Nicolson scheme, or some similar iterative method. However due to computational performance
limitations, this non-linear solver is typically truncated to a fixed number of iterations, rather
than to the convergence of the residual below some specified tolerance. Moreover in order to further
improve computational performance, the Jacobian operator used to determine the descent direction 
at each iteration is often approximated by omitting the less dynamically significant terms, 
the use of vertical reference profiles, and the re-use of the same Jacobian operator between 
non-linear iterations or even time steps. Consequently this approximate solution may only be considered as a 
quasi-Newton method, rather than a full Newton method for which the Jacobian would incorporate all 
derivatives of the residual vector with respect to all solution variables, and be re-assembled at 
each non-linear iteration.

As an alternative to such a scheme, this article considers the use of Rosenbrock-Wanner methods, 
where a finite number of non-linear iterations are replaced by a fixed number of implicit Runge-Kutta
stages, for which the weights are chosen so as to satisfy specific order and stability conditions \cite{HW96,Rang05}.
In the current study we limit ourselves to four stage schemes, since previous experiments with 
finite iteration Crank-Nicolson schemes for planetary scale atmospheric modelling have shown that an even number of iterations is required,
which may potentially be a result of the skew-symmetric Coriolis operator used to simulate the 
earth's rotation, which yields a series of pairs of complex conjugate eigenvalues \cite{GV00}. The four-stage, third 
order Rosenbrock-Wanner schemes considered here are for the most part stiffly-stable methods which 
are well suited to geophysical systems that involve fast acoustic and gravity waves.

Like the incompressible Navier-Stokes equations, the compressible Euler equations also include 
an algebraic equation, in this case an equation of state, not an incompressibility constraint. The 
presence of this algebraic equation leads to a non-singular Helmholtz equation for the pressure 
involving a temporal second derivative. Consequently the Rosenbrock-Wanner methods studied here 
must also support index-2 partial differential algebraic equations (PDAEs). This is of particular 
importance since the Helmholtz pressure equation is often used as a preconditioner for the full 
coupled system of equations, as is the case for the 3D compressible Euler equations solver of
the UK Met Office's \emph{LFRic} model used in the present study \cite{Maynard20}. 

Rosenbrock-Wanner methods (for which only an approximate Jacobian is required) have shown great 
promise for the solution of the incompressible Navier-Stokes equations in two \cite{John06} and 
three \cite{Deparis19} spatial dimensions, which also involve an index-2 PDAE elliptic equation, 
in the form of Poisson equations for the pressure. Therefore it is reasonable to expect that would 
also be beneficial for the solution of geophysical systems, such as the rotating shallow water 
equations and the 3D compressible Euler equations. Another advantage of Rosenbrock-Wanner schemes 
is that they posses an embedded low order solution, which may be used for adaptive time step control 
\cite{John10}. They have also been applied to the simulation of compressible Navier-Stokes in two
\cite{Blom16} and three \cite{Liu16} dimensions, as well as to optimal control problems \cite{Lang13}.

The remainder of this article proceeds as follows: In Section 1 the formulation of Rosenbrock-Wanner 
methods will be briefly introduced. More details discussion can be found in the references therein.
Section 2 describes the geophysical systems studied in this article, namely the 2D rotating shallow
water equations and the 3D compressible Euler equations. Results comparing the application of four 
stage Rosenbrock-Wanner methods to four iterations of a Crank-Nicolson scheme for standard test 
cases for these systems will be presented in Section 3. Finally, conclusions based on these results
will be presented in Section 4.

\section{Introduction to Rosenbrock-Wanner methods}

We are concerned with systems of PDAEs with a temporal structure of the form
\begin{subequations}
\begin{align}
	\boldsymbol{\mathsf{M}}\frac{d\boldsymbol{x}}{dt} &= F(\boldsymbol{x},\boldsymbol{y}) \\
	\boldsymbol{0} &= G(\boldsymbol{x},\boldsymbol{y})
\end{align}
\end{subequations}
where $\boldsymbol{\mathsf{M}}$ is some mass matrix, $\boldsymbol{x}$, $\boldsymbol{y}$ are vectors
of prognostic and diagnostic state variables respectively, $F$ includes all forcing terms for the 
prognostic equations and $G$ is a set of time independent algebraic equations. If $F$ and $G$ are 
non-linear functions of $\boldsymbol{x}$ and $\boldsymbol{y}$ then we may apply a centered Crank-Nicolson 
temporal discretisation with respect to a time step $\Delta t$ and solve the resulting system for 
time step $n+1$ using Newton's method at each non-linear iteration $i\ge 1$ with an initial state for the
time step $\boldsymbol{y}^0=\boldsymbol{y}^n$ as
\begin{subequations}\label{eq::cn}
\begin{align}
	\boldsymbol{\mathsf{M}}\delta\boldsymbol{x}^i - \frac{\Delta t}{2}\boldsymbol{\mathsf{W}}_F^i
	\begin{bmatrix}
	\delta\boldsymbol{x}^i \\
	\delta\boldsymbol{y}^i 
	\end{bmatrix}
	&= 
	\boldsymbol{\mathsf{M}}(\boldsymbol{x}^n - \boldsymbol{x}^{i-1}) + 
	\frac{\Delta t}{2}\Bigg(F(\boldsymbol{x}^n,\boldsymbol{y}^n) + F(\boldsymbol{x}^{i-1},\boldsymbol{y}^{i-1})\Bigg) \\
	-\boldsymbol{\mathsf{W}}_G^i
	\begin{bmatrix}
	\delta\boldsymbol{x}^i \\
	\delta\boldsymbol{y}^i 
	\end{bmatrix}
	&= G(\boldsymbol{x}^{i-1},\boldsymbol{y}^{i-1})
\end{align}
\end{subequations}
where
\begin{equation}
	\boldsymbol{\mathsf{W}}^i=
	\begin{bmatrix}
	\boldsymbol{\mathsf{W}}_F^i \\
	\boldsymbol{\mathsf{W}}_G^i 
	\end{bmatrix}
	\approx
	\begin{bmatrix}
		\frac{\delta F(\boldsymbol{x}^i,\boldsymbol{y}^i)}{\delta\boldsymbol{x}^i} &
		\frac{\delta F(\boldsymbol{x}^i,\boldsymbol{y}^i)}{\delta\boldsymbol{y}^i} \\
		\frac{\delta G(\boldsymbol{x}^i,\boldsymbol{y}^i)}{\delta\boldsymbol{x}^i} &
		\frac{\delta G(\boldsymbol{x}^i,\boldsymbol{y}^i)}{\delta\boldsymbol{y}^i} 
	\end{bmatrix}
\end{equation}
is the (approximate) Jacobian matrix evaluated at iteration $i$ and
\begin{equation}\label{eq::newton_recon}
	\boldsymbol{x}^{i+1} = \boldsymbol{x}^{i} + \delta\boldsymbol{x}^{i} =
	\boldsymbol{x}^n + \sum_{j=1}^i\delta\boldsymbol{x}^j,\qquad
	\boldsymbol{y}^{i+1} = \boldsymbol{y}^{i} + \delta\boldsymbol{y}^{i} =
	\boldsymbol{y}^n + \sum_{j=1}^i\delta\boldsymbol{y}^j.
\end{equation}
The iteration is terminated and the solution at time level $n+1$ is updated once 
$||\delta\boldsymbol{x}^{i}||$, $||\delta\boldsymbol{y}^{i}||$ are below some specified tolerance.

As discussed above, solving to convergence and re-assembling $\boldsymbol{\mathsf{W}}$ at each iteration 
$i$ is prohibitively expensive for many applications, and so typically this is assembled only once per 
time step as $\boldsymbol{\mathsf{W}}^1$. Also rather than terminate when the solution increments are 
below some tolerance, the stopping condition is set for a fixed number of iterations $s$ as $i > s$.

In contrast to the Newton iteration with the Crank-Nicolson time discretisation described above, the
Rosenbrock-Wanner method with $s$-stages is given for an autonomous system of PDAEs (where $F$ and $G$ do 
not depend directly on $t$) at iteration $1\le i\le s$ as \cite{HW96,Rang05,Rang13}
\begin{subequations}\label{eq::ros}
\begin{align}
	\boldsymbol{\mathsf{M}}\boldsymbol{k}^i
	- \gamma_{ii}\Delta t\boldsymbol{\mathsf{W}}_F^1
	\begin{bmatrix}\boldsymbol{k}^i \\ \boldsymbol{l}^i\end{bmatrix} &= 
	\Delta tF(\boldsymbol{x}_*^i,\boldsymbol{y}_*^i) + 
	\Delta t\boldsymbol{\mathsf{W}}_F^1\sum_{j=1}^{i-1}\gamma_{ij}
	\begin{bmatrix}\boldsymbol{k}^j \\ \boldsymbol{l}^j\end{bmatrix} \\
	-\gamma_{ii}\boldsymbol{\mathsf{W}}_G^1
	\begin{bmatrix}\boldsymbol{k}^i \\ \boldsymbol{l}^i\end{bmatrix} &= 
	G(\boldsymbol{x}_*^i,\boldsymbol{y}_*^i) + 
	\boldsymbol{\mathsf{W}}_G^1\sum_{j=1}^{i-1}\gamma_{ij}
	\begin{bmatrix}\boldsymbol{k}^j \\ \boldsymbol{l}^j\end{bmatrix}
\end{align}
\end{subequations}
where
\begin{equation}
	\boldsymbol{x}_*^i = \boldsymbol{x}^n + \sum_{j=1}^{i-1}\alpha_{ij}\boldsymbol{k}^j,\qquad
	\boldsymbol{y}_*^i = \boldsymbol{y}^n + \sum_{j=1}^{i-1}\alpha_{ij}\boldsymbol{l}^j
\end{equation}
for the scalar weights $\alpha_{ij}$ and $\gamma_{ij}$. Unlike Newton's method, where
the solution at the end of the time step is just the previous solution plus a sum over all the
solution increments $\delta\boldsymbol{x}_j$, $\delta\boldsymbol{y}_j$ \eqref{eq::newton_recon}, 
the solution at time level $n+1$ for the Rosenbrock-Wanner method is reconstructed from the 
scalar weights $b_i$ as
\begin{equation}
	\boldsymbol{x}^{n+1} = \boldsymbol{x}^n + \sum_{i=1}^sb_i\boldsymbol{k}^i,\qquad
	\boldsymbol{y}^{n+1} = \boldsymbol{y}^n + \sum_{i=1}^sb_i\boldsymbol{l}^i.
\end{equation}
In order to ensure that the left hand side operator only needs to be assembled once per time
step, the weights are customarily chosen such that $\gamma = \gamma_{ii}$ is constant for all 
stages $i$.

Rosenbrock-Wanner methods are a sub-class of Rosenbrock methods for which the coefficients 
$\alpha_{i,j}$, $\gamma_{i,j}$ are chosen to satisfy the required order condition for only
an approximate representation of the Jacobian, $\boldsymbol{\mathsf{W}}$. For some classes
of Rosenbrock-Wanner methods, such as Krylov-ROW \cite{SW95,WSP97} and Rosenbrock-Krylov 
methods \cite{TS14}, this approximate Jacobian is derived from a low-rank approximation to 
the Krylov subspace generated from the actual Jacobian (which is often constructed via a 
matrix-free differencing of the residual vector). In the present context, this approximate
Jacobian is constructed \cite{Melvin19,Maynard20} via the omission of non-stiff terms from
the matrix, and the linearisation of mean thermodynamic profiles.

\subsection{Quasi-Newton with Crank-Nicolson time discretisation as a Rosenbrock-Wanner scheme}

In order to further illustrate the comparison between a finite iteration quasi-Newton method and 
Rosenbrock-Wanner methods, we show that the two stage, second order ROS2 scheme \cite{Verwer99} 
is equivalent to two iterations of a Newton method with a Crank-Nicolson time discretisation. For 
the sake of brevity, we show this equivalence for a system of equations involving prognostic 
equations only, however this equivalence also holds with the inclusion of algebraic equations.

Two iterations of of the Crank-Nicolson scheme \eqref{eq::cn} give a solution as
\begin{subequations}\label{eq::cn_2stage}
	\begin{align}
	(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)\delta\boldsymbol{x}^1 &= 
		\Delta tF(\boldsymbol{x}^n),\label{eq::cn_ros2_it1}\\
		\boldsymbol{x}^1 &= \boldsymbol{x}^n +\delta\boldsymbol{x}^1,\\
	(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)\delta\boldsymbol{x}^2 &= 
		-\boldsymbol{\mathsf{M}}\delta\boldsymbol{x}^1 + \frac{\Delta t}{2}(F(\boldsymbol{x}^n) + 
		F(\boldsymbol{x}^1)),\label{eq::cn_ros2_it2}\\
		\boldsymbol{x}^{n+1} &= \boldsymbol{x}^n +\delta\boldsymbol{x}^1 + \delta\boldsymbol{x}^2
	\end{align}
\end{subequations}
In order to show the equivalence of the second iteration of the two iteration Crank-Nicolson scheme 
\eqref{eq::cn_ros2_it2} to the second stage of the ROS2 scheme (where $\alpha_{21}=1$, $\gamma_{21}=-2$, 
$b_1=b_2=1/2$) we begin by multiplying \eqref{eq::cn_ros2_it2} by two and subtracting \eqref{eq::cn_ros2_it1}, 
to give
\begin{equation}
(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)(2\delta\boldsymbol{x}^2 - \delta\boldsymbol{x}^1) = 
	-2\boldsymbol{\mathsf{M}}\delta\boldsymbol{x}^1 + \Delta tF(\boldsymbol{x}^1).
\end{equation}
Adding $(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)(2\delta\boldsymbol{x}^1)$
to both sides of the above expression gives
\begin{equation}
(\boldsymbol{\mathsf{M}} - \gamma\Delta t\boldsymbol{\mathsf{W}}^1)(2\delta\boldsymbol{x}^2 + \delta\boldsymbol{x}^1) = 
	\Delta tF(\boldsymbol{x}^1)
	-2\gamma\Delta t\boldsymbol{\mathsf{W}}^1\delta\boldsymbol{x}^1.
\end{equation}
The above expression is equivalent to the second stage of the ROS2 scheme. Applying the substitution
$\boldsymbol{k}^1 = \delta\boldsymbol{x}^1$, $\boldsymbol{k}^2 = 2\delta\boldsymbol{x}^2 + \delta\boldsymbol{x}^1$ 
and constructing the solution using the ROS2 integration weights as
$\boldsymbol{x}^{n+1} = \boldsymbol{x}^n + \boldsymbol{k}^1/2 + \boldsymbol{k}^2/2$
we have that 
$\boldsymbol{x}^{n+1} = \boldsymbol{x}^n + \delta\boldsymbol{x}^1 + \delta{\boldsymbol{x}^2}$,
which is the correct solution for the two iteration Crank-Nicolson scheme. While the above scheme is 
typically run with $\gamma=1/2$, which is neutrally stable, an L-stable variant is given as 
$\gamma=1\pm\sqrt{2}/2$ \cite{Verwer99}.

We can extend this comparison to a quasi-Newton method with any number of stages, for which we have
at iteration $i>1$ that $\delta\boldsymbol{x}^i = \boldsymbol{k}^i/2 - \boldsymbol{k}^{i-1}/2$. For 
the four iteration Crank-Nicolson scheme (CN4), this is given as an equivalent Rosenbrock-Wanner 
scheme for the matrices $\mathsf{\Gamma}$, $\mathsf{A}$ as
\begin{equation}
\mathsf{\Gamma} = (\gamma_{i,j})_{i,j=1}^4 =
	\gamma\begin{bmatrix}
		1 & 0 & 0 & 0 \\
		-2 & 1 & 0 & 0 \\
		-1 & -1 & 1 & 0 \\
		-1 & 0 & -1 & 1 
	\end{bmatrix},\qquad
	\mathsf{A} = \begin{bmatrix}(\alpha_{i,j})_{i,j=1}^{3,4}\end{bmatrix} = 
	\begin{bmatrix}
		0 & 0 & 0 & 0 \\
		1 & 0 & 0 & 0 \\
		\frac{1}{2} & \frac{1}{2} & 0 & 0 \\
		\frac{1}{2} & 0 & \frac{1}{2} & 0
	\end{bmatrix},\qquad
	\boldsymbol{b} = \begin{bmatrix}\frac{1}{2} & 0 & 0 & \frac{1}{2}\end{bmatrix}.
\end{equation}

For the prototypical case where $d\boldsymbol{x}/dt = \lambda\boldsymbol{x}$, 
$\boldsymbol{\mathsf{W}} = \delta F(\boldsymbol{x})/\delta\boldsymbol{x}=\lambda\boldsymbol{x}$
we have that $\boldsymbol{x}^{n+1} = R(\Delta t\lambda)\boldsymbol{x}^n$ where
$R(\Delta t\lambda) = 1 + \Delta t\lambda\boldsymbol{b}^{\top}(\mathsf{I} - \Delta t\lambda\mathsf{B})^{-1}\boldsymbol{1}$ 
is the amplification factor (see \cite{HW96}, ch. IV.7), $\mathsf{I}$ is the identity matrix and 
$\mathsf{B} = \mathsf{\Gamma} + \mathsf{A}$. For $\gamma = 1/2$ we have that 
$R(\Delta t\lambda) = (1+\Delta t\lambda/2)/(1-\Delta t\lambda/2)$, such that the solution is 
neutrally stable with eigenvalues on the unit circle, as is the case for the two stage 
Crank-Nicolson/ROS2 scheme \eqref{eq::cn_2stage} \cite{Verwer99}.
More generally we have the amplification factor for the four stage Crank-Nicolson Newton method, using
$z=\Delta t\lambda$ for brevity, as

\begin{multline}
R(z) = \frac{1}{2}\Bigg(\frac{-2z}{\gamma z-1} + \frac{z^2(0.5-\gamma)}{(\gamma z-1)^2} + \frac{z^3(-\gamma^2 +\gamma -0.25)}{(\gamma z-1)^3} + \\
       \frac{z^2(-4\gamma^3z^2+4.5\gamma ^2z^2+3\gamma^2z-1.75gz^2-2\gamma z-\gamma +0.25z^2+0.25z+0.5)}{(\gamma z-1)^4}\Bigg) + 1.
\end{multline}
The coefficient of the $z^4$ term in the numerator, $2\gamma^4 - 8\gamma^3 + 6\gamma^2 - 2\gamma + 0.25$,
has real roots leading to L-stability as $\gamma=0.2716068084314726$ and $\gamma=3.1426067539416227$.

\section{Geophysical systems}

This article considers two different geophysical systems, the two dimensional rotating shallow
water equations on the sphere, and the three dimensional compressible Euler equations on both 
spherical and planar geometry. The rotating shallow water equations are a widely used prototypical
model of geophysical phenomena on account of their capacity to represent many of the dynamical
features of the full atmosphere, such are turbulence, waves and large scale force balances, within
an idealised setting. In the present case, comparing Crank-Nicolson and Rosenbrock-Wanner schemes
for the rotating shallow water equations allows us to benchmark the allowable time step and 
conservation properties of these methods for the case of a very simple approximate Jacobian at 
low mach-number.

\subsection{The rotating shallow water equations}

The two dimensional rotating shallow water equations are given for the velocity $\boldsymbol{u}$ 
and the fluid depth $h$ as
\begin{subequations}
	\begin{alignat}{3}
	\frac{\partial\boldsymbol{u}}{\partial t} &= 
	-(\nabla\times\boldsymbol{u} + f)\times\boldsymbol{u} - \nabla\Bigg(\frac{\boldsymbol{u}\cdot\boldsymbol{u}}{2} + gh\Bigg) 
		&&= F_u(\boldsymbol{u},h)\\
	\frac{\partial h}{\partial t} &= 
		-\nabla\cdot(h\boldsymbol{u}) &&= F_h(\boldsymbol{u},h),
\end{alignat}
\end{subequations}
where $f$ is the Coriolis term due to the earth's rotation, and $g$ is gravity. For a mean fluid
depth $H$ much greater than the variations in $h$ and for spatial and temporal scales consistent
with the earth's rotation, the above system may be solved to convergence using a constant in time approximate
Jacobian of the form \cite{Bauer18,Wimmer20,Lee22}
\begin{equation}
	\boldsymbol{\mathsf{W}}_{rsw} = 
	\begin{bmatrix}\boldsymbol{\mathsf{C}} & -g\boldsymbol{\mathsf{G}} \\
		H\boldsymbol{\mathsf{G}}^{\top} & \boldsymbol{\mathsf{0}}
	\end{bmatrix}
	\approx
	\begin{bmatrix}
		\frac{\partial F_u}{\partial\boldsymbol{u}} & 
		\frac{\partial F_u}{\partial h} \\ 
		\frac{\partial F_h}{\partial\boldsymbol{u}} & 
		\frac{\partial F_h}{\partial h} 
	\end{bmatrix},
\end{equation}
where $\boldsymbol{\mathsf{C}}$ is the Coriolis operator and $\boldsymbol{\mathsf{G}}$ is the gradient 
operator (for which the divergence operator is assumed to be its adjoint assuming periodic boundary conditions). 
The approximate Jacobian above omits non-linear terms associated with both mass and momentum transport, and
instead assumes a linearisation around a state of constant mean fluid depth, planetary rotation and 
gravitational potential. The shallow water equations consist of only prognostic equations for which 
$\boldsymbol{x}=(\boldsymbol{u},h)$ is the full state vector and there is no $\boldsymbol{y}$ vector or 
algebraic constraints. See the above references for the specific definition of these operators using a 
$H(div)$ conforming finite element discretisation of the rotating shallow water equations. 

\subsection{The 3D compressible Euler equations}

While the rotating shallow water equations are a good model of many geophysical processes, to fully
capture the dynamics of a dry atmosphere at both planetary and non-hydrostatic scales, we also study
Rosenbrock-Wanner time integration for the 3D compressible Euler equations under the shallow 
atmosphere approximation, given for the velocity $\boldsymbol{u}$, density $\rho$, potential temperature
$\theta$ and Exner pressure $\Pi$ as \cite{Melvin19,Maynard20,Lee21,LeePalha21} as
\begin{subequations}
	\begin{alignat}{3}
	\frac{\partial\boldsymbol{u}}{\partial t} &= 
	-(\nabla\times\boldsymbol{u} + f)\times\boldsymbol{u} - \nabla\Bigg(\frac{\boldsymbol{u}\cdot\boldsymbol{u}}{2} + gz\Bigg) 
		-c_p\theta\nabla\Pi &&= 
	F_u(\boldsymbol{u},\rho,\theta,\Pi)\label{eq::mom}\\
	\frac{\partial\rho}{\partial t} &= 
		-\nabla\cdot(\rho\boldsymbol{u}) &&= F_{\rho}(\boldsymbol{u},\rho)\label{eq::mass}\\
	\frac{\partial\theta}{\partial t} &= 
		-\boldsymbol{u}\cdot\nabla\theta &&= F_{\theta}(\boldsymbol{u},\theta)\label{eq::temp}\\
		0 &= \Pi - \Bigg(\frac{R\rho\theta}{p_0}\Bigg)^{\frac{R}{c_v}} &&= G_{\Pi}(\rho,\theta,\Pi),\label{eq::eos}
\end{alignat}
\end{subequations}
where $z$ is the vertical coordinate, $c_p$ and $c_v$ are the specific heats at constant pressure and volume respectively, 
$p_0$ is the reference surface pressure and $R = c_p - c_v$ is the ideal gas constant. The velocity transport term is 
expressed in \eqref{eq::mom} in \emph{vector invariant} form as 
$(\nabla\times\boldsymbol{u})\times\boldsymbol{u} + \nabla(\boldsymbol{u}\cdot\boldsymbol{u})/2$. This form has the desirable
property that the rotational and potential components of the flow are treated as separate terms. For the appropriate choice 
of finite element spaces for these terms, exact linear geostrophic balance can be preserved in the discrete form \cite{CS12}.
As an alternative we may also express this term in \emph{advective} form as $\boldsymbol{u}\cdot\nabla\boldsymbol{u}$. We will 
investigate both forms in the proceeding section.

Unlike the shallow water system,
the compressible Euler equations contain an algebraic equation in the form of the ideal gas law \eqref{eq::eos}, such that 
the prognostic variables are given as $\boldsymbol{x}=(\boldsymbol{u},\rho,\theta)$ and the diagnostic variable as 
$\boldsymbol{y}=\Pi$. Via repeated Schur complement decomposition of the coupled system, one may derive a non-singular 
Helmholtz equation for the solution of $\Pi$ \cite{Maynard20} or alternatively the density weighted potential temperature
$\rho\theta$ \cite{Lee21}. Consequently any Rosenbrock-Wanner method used to solve the above system as a Helmholtz 
problem, either directly or as a preconditioner, must be applicable to index-2 PDAEs. 

One possible approximate Jacobian for the above system, which results in a Helmholtz problem for the Exner pressure
via repeated Schur complement decomposition \cite{Melvin19,Maynard20} is given as
\begin{equation}\label{eq::ce_W}
	\boldsymbol{\mathsf{W}}_{ce} =
	\begin{bmatrix}\boldsymbol{\mathsf{C}} & \boldsymbol{\mathsf{0}} &
		\boldsymbol{\mathsf{P}}^{\Pi *}_{u\theta} & -\boldsymbol{\mathsf{G}}^{\theta *} \\
		\boldsymbol{\mathsf{D}}^{\rho *} & \boldsymbol{\mathsf{0}} &
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} \\
		\boldsymbol{\mathsf{P}}^{\theta *}_{\theta u} &
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} \\
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{N}}_{\Pi}^{\rho *} & 
		\boldsymbol{\mathsf{P}}_{\Pi\theta}^{\theta *} & \boldsymbol{\mathsf{N}}_{\Pi}^{\Pi *} \\
	\end{bmatrix}
	\approx
	\begin{bmatrix}\frac{\partial F_{u}}{\partial\boldsymbol{u}} & \boldsymbol{\mathsf{0}} &
		\frac{\partial F_{u}}{\partial\theta} & \frac{\partial F_{u}}{\partial\Pi} \\
		\frac{\partial F_{\rho}}{\partial\boldsymbol{u}} & \boldsymbol{\mathsf{0}} &
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} \\
		\frac{\partial F_{\theta}}{\partial\boldsymbol{u}} &
		\boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} & \boldsymbol{\mathsf{0}} \\
		\boldsymbol{\mathsf{0}} & \frac{\partial G_{\Pi}}{\partial\rho} & 
		\frac{\partial G_{\Pi}}{\partial\theta} & \frac{\partial G_{\Pi}}{\partial\Pi} \\
	\end{bmatrix},
\end{equation}
where $\rho*$, $\theta*$ and $\Pi*$ are reference profiles for the density, potential temperature and Exner
pressure respectively, derived from the prognostic variables at the time of the Jacobian assembly. For a full 
description of these operators in the context of a $H(div)$ conforming finite element discretisation with 
$\boldsymbol{u}\in\mathbb{W}_2\subset H(div)$, $\rho,\Pi\in\mathbb{W}_3\subset L^2$,
$\theta\in\mathbb{W}_{cp}\subset H(div)$ (where $\mathbb{W}_{cp}$ is the set of bases in the subspace of 
$H(div)$ consisting of scalar functions that are $C^0$ continuous in the vertical dimension only) see 
\cite{Melvin19}.

\subsubsection{Implementation details}

While the Rosenbrock-Wanner method is straight forward to implement in an existing implicit solver 
with access to the approximate Jacobian operator, there are several particulars of the LFRic model 
\cite{Melvin19,Maynard20} that require particular care.

As previously discussed, the LFRic model uses a Schur complement preconditioner that reduces the full 
mixed system to a Helmholtz equation for the Exner pressure, via an approximate mass lumping of the 
velocity mass matrix. Since this Helmholtz operator and its associated right hand side are derived 
algebraically from the existing coupled system, any Rosenbrock-Wanner method applied to solve this 
should ideally support index 2 PDAEs. Both the preconditioned Helmholtz operator and the full coupled 
outer solver are applied using matrix free methods, such that the approximate Jacobian operators in
\eqref{eq::ce_W} are only ever evaluated at the element level, and not as a global matrix.

Also, in order to allow for longer time steps with a fixed number of iterations, the mass and 
temperature transport terms in the right hand sides of equations \eqref{eq::mass} and \eqref{eq::temp} 
are evaluated explicitly in LFRic over a series of $M$ smaller CFL dependent sub-steps using a
transport velocity $\boldsymbol{u}^t$ as
\begin{subequations}\label{eq::explicit_adv}
\begin{align}
	\Delta tF_{\rho} &= \sum_{m=1}^M\rho^m - \rho^{m-1},
	\qquad\rho^m - \rho^{m-1} = \frac{\Delta t}{M}\sum_p^Pb_pk_p,\qquad k_p=\nabla\cdot(\boldsymbol{u}^t\hat\rho_{m}^p),
	\qquad\hat{\rho}_{m}^p = \rho_{m-1} + \sum_{q=1}^{p-1}a_{pq}k_q \\
	\Delta tF_{\theta} &= \sum_{m=1}^M\theta^m - \theta^{m-1},
	\qquad\theta^m - \theta^{m-1} = \frac{\Delta t}{M}\sum_p^Pb_pk_p,\qquad k_p=\boldsymbol{u}^t\cdot\nabla\hat\theta_{m}^p,
	\qquad\hat{\theta}_{m}^p = \theta_{m-1} + \sum_{q=1}^{p-1}a_{pq}k_q,
\end{align}
\end{subequations}
where for the Rosenbrock scheme $\boldsymbol{u}^t = \boldsymbol{u}^{i-1}$, whereas for the Crank-Nicolson
scheme a time centered velocity is used as $\boldsymbol{u}^t = (\boldsymbol{u}^n + \boldsymbol{u}^{i-1})/2$.

In addition to the explicit transport of density and potential temperature, there is also the option
in LFRic to explicitly integrate the momentum transport term (in advective form), $\boldsymbol{u}\cdot\nabla\boldsymbol{u}$ 
in a similar fashion as an alternative to the vector invariant form \eqref{eq::mom}. Both options will be 
studied below for the Crank-Nicolson time discretisation below. Notably the Rosenbrock-Wanner method was only
observed to be stable for the momentum transport term in vector invariant form. This is perhaps due to
the use of an instantaneous transport velocity, $\boldsymbol{u}^t = \boldsymbol{u}^{i-1}$, rather than
a time averaged formulation as used for the Crank-Nicolson scheme.

\section{Results}

\subsection{Rotating shallow water: shear flow instability on the sphere}

We compare the results of four iterations of the Crank-Nicolson discretisation (CN4) to a variety of four stage
Rosenbrock-Wanner schemes in terms of both stable time step and energetic profiles for a standard shear flow
instability test case on the sphere \cite{Galewsky04}, run for 12 days so as to ensure that the schemes remain
stable with the specified time step for a mature turbulent state. The various Rosenbrock-Wanner schemes involve 
coefficients and properties as detailed in the table below
\begin{center}
\begin{tabular}{|c|c|c|c|}
	\hline
	Scheme & Reference & Index & Stability \\
	\hline
	ROS34PW2  & \cite{Rang05}   & 1 & Stiffly-accurate, $R(\infty)=0$ \\
	ROS34PW3  & \cite{Rang05}   & 1 & A-stable, $R(\infty)\approx 0.63$ \\
	ROSI2w    & \cite{Rang07}   & 2 & Stiffly-accurate, $R(\infty)=0$, $\boldsymbol{\mathsf{W}}=\delta F/\delta\boldsymbol{y} + \mathcal{O}(\Delta t)$ \\
	ROSI2W    & \cite{Rang07}   & 2 & Stiffly-accurate, $R(\infty)=0$ \\
	ROS34PRW  & \cite{Rang13}   & 2 & Stiffly-accurate, $R(\infty)=0$ \\
	ROS3PRL2  & \cite{Rang15}, \cite{Lang07} &   & Stiffly-accurate, $R(\infty)=0$ \\
	ROWDAIND2 & \cite{Lubich90} & 2 & Stiffly-accurate, $R(\infty)=0$ \\
	\hline
\end{tabular}
\end{center}

Figure \ref{fig::sw_1} shows the normalised energy and potential enstrophy conservation errors for the 
different four-stage Rosenbrock-Wanner and the CN4 scheme for the shear flow instability test case on 
the sphere. These are computed by globally integrating the total energy $E_{sw}$ and potential enstrophy 
$Z_{sw}$ over the domain $\Omega$ as
\begin{subequations}
	\begin{align}
		E_{sw} &= \int\frac{1}{2}h\boldsymbol{u}\cdot\boldsymbol{u} + \frac{g}{2}h^2\mathrm{d}\Omega\\
		Z_{sw} &= \int\frac{1}{2}hq^2\mathrm{d}\Omega,
	\end{align}
\end{subequations}
where $q = (\nabla\times\boldsymbol{u} + f)/h$ is the potential vorticity.
In each case the same $H(div)$ conforming finite element method is applied for the spatial 
discretisation \cite{LeePalha18,Lee22}, using $32\times 32$ third order finite elements on each panel 
of the cubed sphere. The non-linear potential enstrophy cascade to grid scales is stabilised via the 
anticipated potential vorticity method \cite{SB85} with an upwinding parameter of $\Delta t/2$. No 
damping is applied to the energy.

For the energy conservation error plot, solid lines indicate a long time energy growth, so
that the solution will ultimately become unstable, while dashed lines
indicate long time energy decay and hence stability. Of all the schemes, one in particular
allows for stable simulation using significantly longer time steps, ROS34PRW 
\cite{Rang13}. Some care must be taken however, as while this scheme is stable for time steps
of up to 600 seconds, at these long times, the fast gravity waves are not properly resolved
over four non-linear stages, and so the shear flow instability occurs at the incorrect wave-number.
This is also observed in the potential enstrophy conservation error, which exhibits an anomalous
bump as the dynamics transition to the incorrect wave number. This problem is not observed and 
the dynamics evolve correctly for a time step of 540 seconds for the ROS34PRW scheme, 
which is still $20\%$ longer than the maximum stable time step of the CN4 scheme at 450 seconds.
The potential enstrophy conservation error is broadly representative of the richness of the turbulence
present in the solution. These errors broadly correlate with the length of the time steps for the 
different schemes, with the schemes with smaller stable time steps, such as ROS3PRL2 exhibiting the
smallest potential enstrophy conservation error and the ROS34PRW the greatest.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{rsw_conservation_energy.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{rsw_conservation_enstrophy.png}
\caption{Normalised Energy (left) and potential enstrophy (right) conservation errors for the 
different integrators for the shear flow instability test case on the sphere over 12 days at the
maximum observable stable time step for each scheme. Dashed lines for the energy conservation error 
indicate energy decay and solid lines for the energy conservation error indicate growth.}
\label{fig::sw_1}
\end{center}
\end{figure}

The maximum stable time steps are more clearly observed in the bar chart in Fig. \ref{fig::sw_2}. 
Here the schemes that exhibit positive energy error growth are given in blue, while the schemes 
that are long time stable are in green. The CN4 scheme is given as a reference in orange. The CN4
scheme is somewhere in the middle in terms of maximum stable time step, with several 
Rosenbrock-Wanner schemes allowing for longer time steps. The ROS34PRW scheme is once
again presented twice, once for its maximum stable time step of 600 seconds, and once for its
maximum physically correct time step of 540 seconds.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{rsw_timesteps.png}
\caption{Maximum stable time steps for the different Rosenbrock-Wanner and Crank-Nicolson
	schemes over 12 days of the shear flow instability test case on the sphere.}
\label{fig::sw_2}
\end{center}
\end{figure}

\subsection{3D compressible Euler: baroclinic instability on the sphere}

The Rosenbrock-Wanner integrators are compared against CN4 for the 3D compressible Euler equations
at planetary scales using a standard test case for a baroclinic wave triggered by a velocity
perturbation in an otherwise geostrophically and hydrostatically balanced atmosphere on z-levels 
\cite{UMJS14}. These are compared at two different spatial/temporal resolutions C48;
$6\times48\times 48$ lowest order elements ($\Delta x\approx 192km$, $\Delta t=1800s$) and C96;
$6\times96\times 96$ lowest order elements ($\Delta x\approx 96km$, $\Delta t=900s$). No dissipation
of any kind was used in these simulations, so in all cases the solution ultimately becomes unstable.
In order to maintain the stability of the CN4 scheme, this was run with the potential temperature 
equation fully off-centered in time so as to use the future time level only, which degrades the 
temporal accuracy of the method. No such off-centering was required for the Rosenbrock-Wanner schemes.
The globally integrated kinetic (horizontal and vertical), potential and internal energies are computed respectively over the 
full domain $\Omega$ at each time step as 
\begin{subequations}
\begin{align}
	K_h &= \int\frac{\rho\boldsymbol{u}_h\cdot\boldsymbol{u}_h}{2}\mathrm{d}\Omega \\
	K_v &= \int\frac{\rho w^2}{2}\mathrm{d}\Omega \\
	P &= \int\rho gz\mathrm{d}\Omega \\
	I &= \int c_v\rho\theta\Pi\mathrm{d}\Omega,
\end{align}
\end{subequations}
where $\boldsymbol{u}_h$ and $w$ are the horizontal and vertical velocities respectively.

As observed in the internal and potential energy evolution as shown in Fig. \ref{fig::ce_bw_1} the CN4
schemes exhibit a buoyancy oscillation on a time scale of $2\Delta t$, that is not present for the 
ROS34PRW scheme, which show a much smaller oscillation on a time scale of approximately 12 hours
independent of time step size. This oscillation is consistent with the temporal oscillation observed
in the horizontal kinetic energy in Fig \ref{fig::ce_bw_2}. The growth of the baroclinic instability
is observed in the evolution of the vertical kinetic energy for the ROS34PRW scheme also in 
Fig. \ref{fig::ce_bw_2}. This result is consistent with previous observations using a high order mixed
finite element model with horizontally explicit/vertically implicit time stepping and exact energy 
conservation for the implicit vertical solve \cite{Lee21}. However for the CN4 scheme, this signal is 
insignificant with respect to the vertical kinetic energy signal associated with the internal-potential 
buoyancy oscillation, which at $\mathcal{O}(10^{15})$ Joules is approximately $100$ times greater than 
the vertical kinetic energy associated with the baroclinic instability. 

This oscillation is perhaps a consequence of the neutral stability of the CN4 temporal scheme with 
$\gamma=1/2$. Using the L-stable $\gamma$ values described for the four iteration Crank-Nicolson 
scheme in Section 1.1, this oscillation is suppressed, however the simulation is rapidly observed 
to be unstable. An alternative, stable method for suppressing this oscillation is to off-center the 
Crank-Nicholson scheme in favor of the new time level (by a factor of $0.55$), however this leads 
to a degradation of accuracy, resulting in a scheme that is formally only first order accurate.
Results using this off-centering for the CN4 scheme will be presented below.

In terms of the internal and potential energy evolution, only the ROS34PRW scheme at the C96 resolution
gives observably consistent results with respect to those previously published using an exact energy conserving vertical integrator 
\cite{Lee21}, where both the internal and potential energy trend downward with time in order to balance the
growth in kinetic energy due to the baroclinic instability.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{internal_bw.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{potential_bw.png}
	\caption{Internal (left) and potential (right) energy evolution for the baroclinic
	wave test case for the CN4 (advective and vector invariant) and ROS34PRW (vector invariant) 
	schemes at the C48 and C96 resolutions. Note the different scales on the vertical axes for
	the Crank-Nicolson and Rosenbrock schemes.}
\label{fig::ce_bw_1}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{horiz_kinetic_bw.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{vert_kinetic_bw.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{conservation_error_bw.png}
	\caption{Horizontal (left) and vertical (center) kinetic energy evolution 
	and normalised total energy conservation error (right)
	for the baroclinic
	wave test case for the CN4 (advective and vector invariant) and ROS34PRW (vector invariant) 
	schemes at the C48 and C96 resolutions. Note the 
	different scales on the vertical axes for the Crank-Nicolson and Rosenbrock schemes for the 
	vertical kinetic energy.}
\label{fig::ce_bw_2}
\end{center}
\end{figure}

The total energy conservation error is also given in Fig. \ref{fig::ce_bw_2}, where it is observed that 
the CN4 scheme has significantly greater total energy growth than the ROS34PRW scheme at the
same resolution. 
In particular, the advective form of the CN4 integrator at C96 resolution exhibits a rapid growth 
of the energy conservation error that suggests the onset of numerical instability.

The lowest level potential temperature and Exner pressure are shown at day 7 for the C96 
resolution in Figs \ref{fig::ce_bw_4} and \ref{fig::ce_bw_5} respectively for the CN4 (in advective 
and vector invariant form form) and the ROS34PRW schemes. While the results are in broad agreement 
for the potential temperature, there is somewhat more of a spurious meridional variation in surface 
pressure for the CN4 scheme, and this also has additional spurious oscillations for the CN4 vector 
invariant scheme. This result is underscored by the lowest level divergence plots presented in Fig. 
\ref{fig::ce_bw_6}, where the meridional variation in divergence observed for the CN4 scheme is shown 
to be an order of magnitude greater than that associated with the physical baroclinic instability, 
which is observed clearly for the ROS34PRW scheme. This meridional divergence is perhaps due to 
a loss of geostrophic balance, which is not strictly preserved for the discrete system in advective 
form \cite{CS12}.
While the vector invariant form does preserve geostrophic balance, there is also a considerable 
divergence error for the CN4 scheme in this form as well which is not observed for the ROS34PRW
scheme in vector invariant form.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{theta_cn4_advU.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{theta_cn4.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{theta_ros.png}
	\caption{Surface potential temperature for the CN4 advective form (left), CN4 vector invariant form (center) 
	and ROS34PRW vector invariant form (right)
	integrators at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_4}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{exner_cn4_advU.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{exner_cn4.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{exner_ros.png}
	\caption{Lowest level Exner pressure for the CN4 advective form (left), CN4 vector invariant form (center) 
	and ROS34PRW vector invariant form (right)
	integrators at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_5}
\end{center}
\end{figure}

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{divergence_cn4_advU.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{divergence_cn4.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{divergence_ros.png}
	\caption{Surface divergence for the CN4 advective form (left), CN4 vector invariant form (center) 
	and ROS34PRW vector invariant form (right)
	integrators at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_6}
\end{center}
\end{figure}

We also compare the energetic profiles for the various Rosenbrock-Wanner schemes studied for 
the shallow water equations in Section 3.1. for the C96 resolution in Fig. \ref{fig::ce_bw_7}. 
We exclude results for the ROWDAIND2 and ROS34PW3 schemes, as these were observed to be unstable,
which is consistent with the shallow water results, where these schemes produced a positive 
growth in energy as seen in Figs. \ref{fig::sw_1}, \ref{fig::sw_2}.
In the case of the ROS34PW3 scheme, this is perhaps a consequence of the fact that it is not 
stiffly-stable. In all cases the Rosenbrock-Wanner schemes exhibit lower energy conservation 
error than the CN4 scheme. 
When comparing the vertical kinetic energy profiles, we see that 
in all cases the Rosenbrock-Wanner schemes exhibit a growth associated with the baroclinic 
instability that is consistent with previous results \cite{Lee21}, and that is two orders of 
magnitude smaller that that associated with the buoyancy
oscillation of the CN4 scheme.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{vert_kinetic_bw_2.png}
\includegraphics[width=0.48\textwidth,height=0.36\textwidth]{conservation_error_bw_2.png}
	\caption{Comparison of the CN4 and Rosenbrock-Wanner schemes for the C96 resolution
	with respect to the vertical kinetic energy (left) and total energy conservation 
	error (right). Note the 
	different scales on the vertical axes for the Crank-Nicolson and Rosenbrock schemes 
	in the vertical kinetic energy plot.}
\label{fig::ce_bw_7}
\end{center}
\end{figure}

One method of suppressing the fast buoyancy oscillation observed for the CN4 scheme is to
off-center the time discretisation in favor of the future time level $n+1$, as this ensures
that the time discretisation is no longer neutrally stable.
The downside of this approach is that the time discretisation is now
formally only first order accurate. In Fig. \ref{fig::ce_bw_8} we compare the internal and
potential energy and energy conservation error profiles for the CN4 scheme using centered 
($\alpha=0.5$) and off-centered ($\alpha=0.55$) time discretisations with respect to the
ROS34PRW Rosenbrock-Wanner scheme for the C96 resolution. As observed, the off-centering 
does ultimately suppress the buoyancy oscillation after some initial oscillations, however 
the energy conservation errors are still greater than for the 
ROS34PRW scheme, which exhibits no such oscillation even at short times. Even with the 
off-centered time discretisation, the CN4 schemes still exhibit spurious growth in the
potential and internal energies, which should actually be decreasing to balance the
growth in kinetic energy of the baroclinic instability as is the case for the ROS34PRW
scheme, and also for previous results using an integrator that exactly conserves energy
for the vertical dynamics \cite{Lee21}.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{internal_bw_3.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{potential_bw_3.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{conservation_error_bw_3.png}
	\caption{Comparison of the CN4 (center and off-centered) and ROS34PRW for the C96 resolution
	with respect to the internal energy (left), potential energy (center) differences from their
	initial values, and total energy conservation error (right). Note the difference in scales
	on the vertical axes for the internal and potential energy plots.}
\label{fig::ce_bw_8}
\end{center}
\end{figure}

We also compare the lowest level divergence for the off-centered advective and vector invariant 
CN4 schemes to the ROS34PRW scheme in Fig. \ref{fig::ce_bw_9}. While the meridional biases are
reduced somewhat compared to those observed for the centered formulations in Fig. \ref{fig::ce_bw_6},
they are still present and greater than the physical divergence of the baroclinic instability.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{divergence_cn4_advU_alpha0p55.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{divergence_cn4_alpha0p55.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{divergence_ros.png}
	\caption{Surface divergence for the off-centered CN4 advective and vector invariant form (left and center) 
	ROS34PRW vector invariant form (right)
	integrators at day 7 for the baroclinic wave test case at the C96 resolution.}
\label{fig::ce_bw_9}
\end{center}
\end{figure}

\subsection{3D compressible Euler: warm bubble on the plane}

While the baroclinic instability test case in the previous section is a good measure of the 
dynamics and planetary scales, the non-hydrostatic and compressible dynamics are negligible 
at these scales. Consequently we also compare the different schemes for a high resolution
3D warm bubble test case \cite{Giraldo13,Melvin19,Lee21,LeePalha21} for which these effects
are significant. The model is configured with an initial state of constant density in hydrostatic 
balance in a three dimensional horizontally periodic box using $100\times 100\times 150$ lowest
order elements with a uniform resolution of $10m$ and a time step of $\Delta t=0.625s$. 
The balanced state is overlaid with a small potential temperature perturbation, which rises and 
distorts over several minutes. 

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{theta_xz_T000640_cn4_advU.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{theta_xz_T000640_cn4.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{theta_xz_T000640.png}
	\caption{Potential temperature cross section at $y=0$ for the 3D warm bubble test case
	at time $400s$ for the advective (left) and vector invariant (center) form CN4 and ROS34PRW (right) schemes.}
\label{fig::ce_wb_1}
\end{center}
\end{figure}

As can be in Fig. \ref{fig::ce_wb_1}, the potential temperature perturbation rises with a 
comparable velocity and profile for the vector invariant CN4 and ROS34PRW schemes, suggesting that the
spurious oscillations and meridional balance issues observed for the CN4 scheme at planetary
scales are not present in a non-rotating frame with a constant mean vertical profile. The advective form
CN4 scheme is slightly more diffused however. The
results of the vector invariant CN4 and ROS34PRW schemes are also very similar in terms of their
energetics, as observed in Fig. \ref{fig::ce_wb_2}. However the advective form of the CN4 scheme
does show some difference in terms of both internal energy profile and conservation error. 
Previous results \cite{Lee21} using an exact energy conserving vertical integrator suggest
that while the potential energy should exhibit a negative trend as the bubble ascends, the 
mean internal energy (aside from the fast oscillation) should stay relatively constant, so
from this we infer that the vector invariant forms are more correct.

\begin{figure}[!hbtp]
\begin{center}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{vert_kinetic_wb.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{internal_wb.png}
\includegraphics[width=0.32\textwidth,height=0.24\textwidth]{conservation_error_wb.png}
	\caption{Vertical kinetic (left) and internal (center) energy evolution and total
	energy conservation error (right) for the 
	CN4 (advective and vector invariant forms) and ROS34PRW (vector invariant) schemes for the warm bubble test case.}
\label{fig::ce_wb_2}
\end{center}
\end{figure}

\section{Conclusions}

This article compares the affects of using a four stage Rosenbrock-Wanner time integrator
with an approximate Jacobian as a substitute for four iterations of a Newton method with
a Crank-Nicolson time discretisation for the solution
of geophysical systems at planetary and non-hydrostatic scales. For the case of the 
planetary shallow water equations, the most efficient Rosenbrock-Wanner method, ROS34PRW,
is able to give correct solutions with a time step approximately $20\%$ greater than the
CN4 method. For the 3D compressible Euler equations at planetary scales the Rosenbrock 
schemes are free of spurious buoyancy oscillations and errors in the meriodional profile
(potentially due to a loss of geostrophic balance)
that are observed for the CN4 scheme in both vector invariant and advective form, and also
have lower energy conservation errors.
At high resolution for an advection dominated test case with near-constant vertical temperature
and density profiles, the energetics for the two schemes are similar when run in vector
invariant form, however the advective form of the CN4 scheme still exhibits biases in terms
of its energetics.

%\section{Acknowledgments}

\begin{thebibliography}{10}
\expandafter\ifx\csname url\endcsname\relax
  \def\url#1{\texttt{#1}}\fi
\expandafter\ifx\csname urlprefix\endcsname\relax\def\urlprefix{URL }\fi
\expandafter\ifx\csname href\endcsname\relax
  \def\href#1#2{#2} \def\path#1{#1}\fi

\bibitem{Melvin19}
T.~Melvin, T.~Benacchio, B.~Shipway, N.~Wood, J.~Thuburn, C.~Cotter, A mixed
  finite-element, finite-volume, semi-implicit discretisation for atmospheric
  dynamics: {C}artesian geometry, Q. J. R. Meteorol. Soc. 145 (2019) 1--19.

\bibitem{Maynard20}
C.~Maynard, T.~Melvin, E.~H.~M\"uller, Multigrid preconditioners for the mixed 
  finite element dynamical core of the {LFR}ic atmospheric model, Q. J. R. 
  Meteorol. Soc. 146 (2020) 3917--3936.

\bibitem{HW96}
E.~Hairer, G.~Wanner, Solving ordinary differential equations. {II}: {S}tiff and
  differential-algebraic problems, Springer Series in Computational Mathematics, 
  second ed., vol. 14, Springer-Verlag, Berlin, 1996.

\bibitem{Rang05}
J.~Rang, L.~Angermann, New {R}osenbrock {W}-methods of order 3 for partial 
  differential algebraic equations of index 1, BIT Numer. Math. 45 (2005) 761--787.

\bibitem{GV00}
G.~H.~Golub, D.~Vanderstraeten On the preconditioning of matrices with 
  skew-symmetric splittings, Numer. Algorithms 25 (2000) 223--239.

\bibitem{John06}
V.~John, G.~Matthies, J.~Rang, A comparison of time-discretization/linearization 
  approaches for the incompressible {N}avier{S}tokes equations, Comput. Methods 
  Appl. Mech. Engrg. 195 (2006) 5995--6010.

\bibitem{Deparis19}
S.~Deparis, M.~O.~Deville, F.~Menghini, L.~Pegolotti, A.~Quarteroni, Application 
  of the {R}osenbrock methods to the solution of unsteady 3{D} incompressible 
  {N}avier-{S}tokes equations, Computers \& Fluids 179 (2019) 112--122.

\bibitem{John10}
V.~John, J.~Rang, Adaptive time step control for the incompressible {N}avier{S}tokes 
  equations, Comput. Methods Appl. Mech. Engrg. 199 (2010) 514--524.

\bibitem{Blom16}
D.~S.~Blom, P.~Birken, H.~Bijl, F.~Kessels, A.~Meister, A.~H.~van Zuijlen,
  A comparison of {R}osenbrock and {ESDIRK} methods combined with iterative 
  solvers for unsteady compressible flows, Adv. Comput. Math. 42 (2016) 1401--1426.

\bibitem{Liu16}
X.~Liu, Y.~Xia, H.~Luo, L.~Xuan, A comparative study of {R}osenbrock-type and 
  implicit {R}unge-{K}utta time integration for discontinuous {G}alerkin method 
  for unsteady 3{D} compressible {N}avier{S}tokes equations, 
  Commun. Comput. Phys. 20 (2016) 1016--1044.

\bibitem{Lang13}
J.~Lang, J.~G.~Verwer, W-methods in optimal control, Numer. Math. 124 (2013) 337--360.

\bibitem{Rang13}
J.~Rang, A new stiffly accurate {R}osenbrock{W}anner method for solving the 
  incompressible {N}avier-{S}tokes equations, in: R.~Ansorge, H.~Bijl, A.~Meister,
  T.~Sonar (Eds.), Recent Developments in the Numerics of Nonlinear Hyperbolic 
  Conservation Laws, 120, Springer Verlag, Heidelberg, Berlin, (2012) 301--315.

\bibitem{SW95}
B.~A.~Schmitt, R.~Weiner, Matrix-free {W}-methods using a multiple {A}rnoldi 
  iteration, Appl. Numer. Math. 18 (1995) 307--320.

\bibitem{WSP97}
R.~Weiner, B.~A.~Schmitt, H.~Podhaisky, {ROWMAP}a {ROW}-code with {K}rylov 
  techniques for large stiff {ODE}s, Appl. Numer. Math. 25 (1997) 303--319.

\bibitem{TS14}
P.~Tranquilli, A.~Sandu, Rosenbrock-{K}rylov Methods for Large Systems of 
  Differential Equations, SIAM J. Sci. Comput. 36 (2014) A1313--A1338.

\bibitem{Verwer99}
J.~G.~Verwer, E.~J.~Spee, J.~G.~Blom, W.~Hundsdorfer, A Second-order {R}osenbrock 
  method applied to photochemical dispersion problems, SIAM J. Sci. Comput. 20
  (1999) 1456--1480.

\bibitem{Bauer18}
W.~Bauer, C.~J. Cotter, Energy-enstrophy conserving compatible finite element
  schemes for the rotating shallow water equations with slip boundary
  conditions, J. Comp. Phys. 373 (2018) 171--187.

\bibitem{Wimmer20}
G.~A.~Wimmer, C.J.~Cotter, W.~Bauer, Energy conserving upwinded compatible
  finite element schemes for the rotating shallow water equations, J. Comp. Phys.
  401 (2020) 109016

\bibitem{Lee22}
D.~Lee, A.~Martin, C.~Bladwell, S.~Badia, A comparison of variational upwinding 
  schemes for geophysical fluids, and their application to potential enstrophy 
  conserving discretisations in space and time (2022) arXiv:2203.04629.

\bibitem{Lee21}
D.~Lee, An energetically balanced, quasi-{N}ewton integrator for non-hydrostatic
  vertical atmospheric dynamics, J. Comp. Phys. 429 (2021) 109988.

\bibitem{LeePalha21}
D.~Lee, A.~Palha, Exact spatial and temporal balance of energy exchanges within a 
  horizontally explicit/vertically implicit non-hydrostatic atmosphere, J. Comp. Phys.
  440 (2021) 110432

\bibitem{CS12}
C.~J.~Cotter, J.~Shipton, Mixed finite elements for numerical weather prediction, 
  J. Comp. Phys. 231 (2012) 7076--7091

\bibitem{Galewsky04}
J.~Galewsky, R.~K.~Scott, L.~M.~Polvani, An initial-value problem for testing numerical models of the 
  global shallow water equations, Tellus 56A (2004) 429--440

\bibitem{Rang07}
J.~Rang, L.~Angermann, New {R}osenbrock methods of order 3 for {PDAE}s of index 2, 
  Adv. Differ. Eq. Control. Process. 1 (2008) 193--217.

\bibitem{Rang15}
J.~Rang, Improved traditional {R}osenbrock{W}anner methods for stiff {ODE}s and {DAE}s
  J. Comput. Appl. Math. 286 (2015) 128-144.

\bibitem{Lang07}
J.~Lang, D.~Teleaga, Towards a fully space-time adaptive {FEM} for magnetoquasistatics,
  IEEE Trans. Magn. 44 (2008) 1238--1241.

\bibitem{LeePalha18}
D.~Lee, A.~Palha, A mixed mimetic spectral element model of the rotating
  shallow water equations on the cubed sphere, J. Comp. Phys. 375 (2018)
  240--262.

\bibitem{Lubich90}
C.~Lubich, M.~Roche, Rosenbrock methods for differential-algebraic systems with 
  solution-dependent singular matrix multiplying the derivative, Computing 43 (1990) 325--342.

\bibitem{SB85}
R.~Sadourny, C.~Basdevant, Parameterization of {S}ubgrid {S}cale {B}arotropic and {B}aroclinic {E}ddies
  in {Q}uasi-geostrophic {M}odels: {A}nticipated {P}otential {V}orticity {M}ethod, J. Atmos. Sci. 42
  (1985) 1353--1363

\bibitem{UMJS14}
P.~A. Ullrich, T.~Melvin, C.~Jablonowski, A.~Staniforth, A proposed baroclinic
  wave test case for deep and shallowatmosphere dynamical cores, Q. J. R.
  Meteorol. Soc. 140 (2014) 1590--1602.

\bibitem{Giraldo13}
F.~X.~Giraldo, J.~F.~Kelly, E.~M.~Constantinescu, Implicit-explicit
  formulations of a three-dimensional nonhydrostatic unified model of the
  atmosphere ({NUMA}), {SIAM} J. Sci. Comput. 35 (2013) B1162--B1194.

\end{thebibliography}

\end{document}
